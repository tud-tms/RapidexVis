import{c as zA,r as V_,u as Vb,g as OA,o as jb,n as BA,a as FA,b as NA,w as j_,s as dv,d as UA,e as VA,f as ug,h as hg,i as Df,F as fv,j as jA,k as zf,l as ch,m as GA,v as WA,t as pv,p as ZA,q as $A,x as mv,y as qA,z as HA,A as XA}from"./index.ca90c83a.js";function YA(n,e){for(var i=0;i<e.length;i++){const l=e[i];if(typeof l!="string"&&!Array.isArray(l)){for(const u in l)if(u!=="default"&&!(u in n)){const f=Object.getOwnPropertyDescriptor(l,u);f&&Object.defineProperty(n,u,f.get?f:{enumerable:!0,get:()=>l[u]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}var gv;const Vh=typeof window<"u",_v=n=>typeof n=="function",KA=n=>typeof n=="string";Vh&&((gv=window?.navigator)==null?void 0:gv.userAgent)&&/iP(ad|hone|od)/.test(window.navigator.userAgent);function JA(n){return typeof n=="function"?n():Vb(n)}function QA(n){return n}function eS(n){return FA()?(NA(n),!0):!1}function tS(n){return typeof n=="function"?zA(n):V_(n)}function iS(n,e=!0){OA()?jb(n):e?n():BA(n)}function nS(n){var e;const i=JA(n);return(e=i?.$el)!=null?e:i}const rS=Vh?window:void 0,sS=Vh?window.document:void 0;Vh&&window.navigator;Vh&&window.location;function oS(n,e=!1){const i=V_(),l=()=>i.value=Boolean(n());return l(),iS(l,e),i}const e_=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t_="__vueuse_ssr_handlers__";e_[t_]=e_[t_]||{};e_[t_];var yv=Object.getOwnPropertySymbols,aS=Object.prototype.hasOwnProperty,lS=Object.prototype.propertyIsEnumerable,cS=(n,e)=>{var i={};for(var l in n)aS.call(n,l)&&e.indexOf(l)<0&&(i[l]=n[l]);if(n!=null&&yv)for(var l of yv(n))e.indexOf(l)<0&&lS.call(n,l)&&(i[l]=n[l]);return i};function uS(n,e,i={}){const l=i,{window:u=rS}=l,f=cS(l,["window"]);let y;const a=oS(()=>u&&"MutationObserver"in u),E=()=>{y&&(y.disconnect(),y=void 0)},I=j_(()=>nS(n),R=>{E(),a.value&&u&&R&&(y=new MutationObserver(e),y.observe(R,f))},{immediate:!0}),O=()=>{E(),I()};return eS(O),{isSupported:a,stop:O}}var xv;(function(n){n.UP="UP",n.RIGHT="RIGHT",n.DOWN="DOWN",n.LEFT="LEFT",n.NONE="NONE"})(xv||(xv={}));function hS(n=null,e={}){var i,l;const{document:u=sS}=e,f=tS((i=n??u?.title)!=null?i:null),y=n&&_v(n);function a(E){if(!("titleTemplate"in e))return E;const I=e.titleTemplate||"%s";return _v(I)?I(E):Vb(I).replace(/%s/g,E)}return j_(f,(E,I)=>{E!==I&&u&&(u.title=a(KA(E)?E:""))},{immediate:!0}),e.observe&&!e.titleTemplate&&u&&!y&&uS((l=u.head)==null?void 0:l.querySelector("title"),()=>{u&&u.title!==f.value&&(f.value=a(u.title))},{childList:!0}),f}var dS=Object.defineProperty,vv=Object.getOwnPropertySymbols,fS=Object.prototype.hasOwnProperty,pS=Object.prototype.propertyIsEnumerable,bv=(n,e,i)=>e in n?dS(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i,mS=(n,e)=>{for(var i in e||(e={}))fS.call(e,i)&&bv(n,i,e[i]);if(vv)for(var i of vv(e))pS.call(e,i)&&bv(n,i,e[i]);return n};const gS={easeInSine:[.12,0,.39,0],easeOutSine:[.61,1,.88,1],easeInOutSine:[.37,0,.63,1],easeInQuad:[.11,0,.5,0],easeOutQuad:[.5,1,.89,1],easeInOutQuad:[.45,0,.55,1],easeInCubic:[.32,0,.67,0],easeOutCubic:[.33,1,.68,1],easeInOutCubic:[.65,0,.35,1],easeInQuart:[.5,0,.75,0],easeOutQuart:[.25,1,.5,1],easeInOutQuart:[.76,0,.24,1],easeInQuint:[.64,0,.78,0],easeOutQuint:[.22,1,.36,1],easeInOutQuint:[.83,0,.17,1],easeInExpo:[.7,0,.84,0],easeOutExpo:[.16,1,.3,1],easeInOutExpo:[.87,0,.13,1],easeInCirc:[.55,0,1,.45],easeOutCirc:[0,.55,.45,1],easeInOutCirc:[.85,0,.15,1],easeInBack:[.36,0,.66,-.56],easeOutBack:[.34,1.56,.64,1],easeInOutBack:[.68,-.6,.32,1.6]};mS({linear:QA},gS);function G(n,e,i){return e in n?Object.defineProperty(n,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[e]=i,n}function fp(n,e){if(!n)throw new Error(e||"loader assertion failed.")}const G_=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser),wv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);wv&&parseFloat(wv[1]);const _S="3.2.12";function Co(n,e){if(!n)throw new Error(e||"loaders.gl assertion failed.")}const ip=typeof process!="object"||String(process)!=="[object process]"||process.browser,yS=typeof window<"u"&&typeof window.orientation<"u",Tv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Tv&&parseFloat(Tv[1]);class xS{constructor(e,i){G(this,"name",void 0),G(this,"workerThread",void 0),G(this,"isRunning",!0),G(this,"result",void 0),G(this,"_resolve",()=>{}),G(this,"_reject",()=>{}),this.name=e,this.workerThread=i,this.result=new Promise((l,u)=>{this._resolve=l,this._reject=u})}postMessage(e,i){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:i})}done(e){Co(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Co(this.isRunning),this.isRunning=!1,this._reject(e)}}class dg{}const fg=new Map;function vS(n){Co(n.source&&!n.url||!n.source&&n.url);let e=fg.get(n.source||n.url);return e||(n.url&&(e=bS(n.url),fg.set(n.url,e)),n.source&&(e=Gb(n.source),fg.set(n.source,e))),Co(e),e}function bS(n){if(!n.startsWith("http"))return n;const e=wS(n);return Gb(e)}function Gb(n){const e=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(e)}function wS(n){return`try {
  importScripts('`.concat(n,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function Wb(n,e=!0,i){const l=i||new Set;if(n){if(Ev(n))l.add(n);else if(Ev(n.buffer))l.add(n.buffer);else if(!ArrayBuffer.isView(n)){if(e&&typeof n=="object")for(const u in n)Wb(n[u],e,l)}}return i===void 0?Array.from(l):[]}function Ev(n){return n?n instanceof ArrayBuffer||typeof MessagePort<"u"&&n instanceof MessagePort||typeof ImageBitmap<"u"&&n instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas:!1}const pg=()=>{};class i_{static isSupported(){return typeof Worker<"u"&&ip||typeof dg<"u"&&!ip}constructor(e){G(this,"name",void 0),G(this,"source",void 0),G(this,"url",void 0),G(this,"terminated",!1),G(this,"worker",void 0),G(this,"onMessage",void 0),G(this,"onError",void 0),G(this,"_loadableURL","");const{name:i,source:l,url:u}=e;Co(l||u),this.name=i,this.source=l,this.url=u,this.onMessage=pg,this.onError=f=>console.log(f),this.worker=ip?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=pg,this.onError=pg,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,i){i=i||Wb(e),this.worker.postMessage(e,i)}_getErrorFromErrorEvent(e){let i="Failed to load ";return i+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(i+="".concat(e.message," in ")),e.lineno&&(i+=":".concat(e.lineno,":").concat(e.colno)),new Error(i)}_createBrowserWorker(){this._loadableURL=vS({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=i=>{i.data?this.onMessage(i.data):this.onError(new Error("No data received"))},e.onerror=i=>{this.onError(this._getErrorFromErrorEvent(i)),this.terminated=!0},e.onmessageerror=i=>console.error(i),e}_createNodeWorker(){let e;if(this.url){const l=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new dg(l,{eval:!1})}else if(this.source)e=new dg(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",i=>{this.onMessage(i)}),e.on("error",i=>{this.onError(i)}),e.on("exit",i=>{}),e}}class TS{static isSupported(){return i_.isSupported()}constructor(e){G(this,"name","unnamed"),G(this,"source",void 0),G(this,"url",void 0),G(this,"maxConcurrency",1),G(this,"maxMobileConcurrency",1),G(this,"onDebug",()=>{}),G(this,"reuseWorkers",!0),G(this,"props",{}),G(this,"jobQueue",[]),G(this,"idleQueue",[]),G(this,"count",0),G(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,i=(u,f,y)=>u.done(y),l=(u,f)=>u.error(f)){const u=new Promise(f=>(this.jobQueue.push({name:e,onMessage:i,onError:l,onStart:f}),this));return this._startQueuedJob(),await u}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const i=this.jobQueue.shift();if(i){this.onDebug({message:"Starting job",name:i.name,workerThread:e,backlog:this.jobQueue.length});const l=new xS(i.name,e);e.onMessage=u=>i.onMessage(l,u.type,u.payload),e.onError=u=>i.onError(l,u),i.onStart(l);try{await l.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new i_({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return yS?this.maxMobileConcurrency:this.maxConcurrency}}const ES={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class Io{static isSupported(){return i_.isSupported()}static getWorkerFarm(e={}){return Io._workerFarm=Io._workerFarm||new Io({}),Io._workerFarm.setProps(e),Io._workerFarm}constructor(e){G(this,"props",void 0),G(this,"workerPools",new Map),this.props={...ES},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const i of this.workerPools.values())i.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:i,source:l,url:u}=e;let f=this.workerPools.get(i);return f||(f=new TS({name:i,source:l,url:u}),f.setProps(this._getWorkerPoolProps()),this.workerPools.set(i,f)),f}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}G(Io,"_workerFarm",void 0);const AS="latest";function SS(n,e={}){const i=e[n.id]||{},l="".concat(n.id,"-worker.js");let u=i.workerUrl;if(!u&&n.id==="compression"&&(u=e.workerUrl),e._workerType==="test"&&(u="modules/".concat(n.module,"/dist/").concat(l)),!u){let f=n.version;f==="latest"&&(f=AS);const y=f?"@".concat(f):"";u="https://unpkg.com/@loaders.gl/".concat(n.module).concat(y,"/dist/").concat(l)}return Co(u),u}function MS(n,e=_S){Co(n,"no worker provided");const i=n.version;return!(!e||!i)}function PS(n,e){return!Io.isSupported()||!ip&&!(e!=null&&e._nodeWorkers)?!1:n.worker&&e?.worker}async function IS(n,e,i,l,u){const f=n.id,y=SS(n,i),E=Io.getWorkerFarm(i).getWorkerPool({name:f,url:y});i=JSON.parse(JSON.stringify(i)),l=JSON.parse(JSON.stringify(l||{}));const I=await E.startJob("process-on-worker",CS.bind(null,u));return I.postMessage("process",{input:e,options:i,context:l}),await(await I.result).result}async function CS(n,e,i,l){switch(i){case"done":e.done(l);break;case"error":e.error(new Error(l.error));break;case"process":const{id:u,input:f,options:y}=l;try{const a=await n(f,y);e.postMessage("done",{id:u,result:a})}catch(a){const E=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:u,error:E})}break;default:console.warn("parse-with-worker unknown message ".concat(i))}}function Zb(n){return n&&typeof n=="object"&&n.isBuffer}function LS(n){return Zb(n)?new Uint8Array(n.buffer,n.byteOffset,n.length).slice().buffer:n}function $b(n){if(Zb(n))return LS(n);if(n instanceof ArrayBuffer)return n;if(ArrayBuffer.isView(n))return n.byteOffset===0&&n.byteLength===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength);if(typeof n=="string"){const e=n;return new TextEncoder().encode(e).buffer}if(n&&typeof n=="object"&&n._toArrayBuffer)return n._toArrayBuffer();throw new Error("toArrayBuffer")}function kS(n,e,i){if(i=i||n.byteLength,n.byteLength<i||e.byteLength<i)return!1;const l=new Uint8Array(n),u=new Uint8Array(e);for(let f=0;f<l.length;++f)if(l[f]!==u[f])return!1;return!0}function RS(...n){const e=n.map(f=>f instanceof ArrayBuffer?new Uint8Array(f):f),i=e.reduce((f,y)=>f+y.byteLength,0),l=new Uint8Array(i);let u=0;for(const f of e)l.set(f,u),u+=f.byteLength;return l.buffer}async function DS(n){const e=[];for await(const i of n)e.push(i);return RS(...e)}function Av(){let n;if(typeof window<"u"&&window.performance)n=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();n=e[0]*1e3+e[1]/1e6}else n=Date.now();return n}class Sv{constructor(e,i){G(this,"name",void 0),G(this,"type",void 0),G(this,"sampleSize",1),G(this,"time",void 0),G(this,"count",void 0),G(this,"samples",void 0),G(this,"lastTiming",void 0),G(this,"lastSampleTime",void 0),G(this,"lastSampleCount",void 0),G(this,"_count",0),G(this,"_time",0),G(this,"_samples",0),G(this,"_startTime",0),G(this,"_timerPending",!1),this.name=e,this.type=i,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Av(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Av()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class W_{constructor(e){G(this,"id",void 0),G(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:i})}get size(){return Object.keys(this.stats).length}reset(){for(const e in this.stats)this.stats[e].reset();return this}forEach(e){for(const i in this.stats)e(this.stats[i])}getTable(){const e={};return this.forEach(i=>{e[i.name]={time:i.time||0,count:i.count||0,average:i.getAverageTime()||0,hz:i.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(i=>this._getOrCreate(i))}_getOrCreate(e){if(!e||!e.name)return null;const{name:i,type:l}=e;return this.stats[i]||(e instanceof Sv?this.stats[i]=e:this.stats[i]=new Sv(i,l)),this.stats[i]}}let zS="";const Mv={};function OS(n){for(const e in Mv)if(n.startsWith(e)){const i=Mv[e];n=n.replace(e,i)}return!n.startsWith("http://")&&!n.startsWith("https://")&&(n="".concat(zS).concat(n)),n}function BS(n){const e=n&&n.lastIndexOf("/");return e>=0?n.substr(e+1):""}const FS=n=>typeof n=="boolean",wh=n=>typeof n=="function",jh=n=>n!==null&&typeof n=="object",Pv=n=>jh(n)&&n.constructor==={}.constructor,NS=n=>n&&typeof n[Symbol.iterator]=="function",US=n=>n&&typeof n[Symbol.asyncIterator]=="function",Ic=n=>typeof Response<"u"&&n instanceof Response||n&&n.arrayBuffer&&n.text&&n.json,Cc=n=>typeof Blob<"u"&&n instanceof Blob,VS=n=>n&&typeof n=="object"&&n.isBuffer,jS=n=>typeof ReadableStream<"u"&&n instanceof ReadableStream||jh(n)&&wh(n.tee)&&wh(n.cancel)&&wh(n.getReader),GS=n=>jh(n)&&wh(n.read)&&wh(n.pipe)&&FS(n.readable),qb=n=>jS(n)||GS(n),WS=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,ZS=/^([-\w.]+\/[-\w.+]+)/;function $S(n){const e=ZS.exec(n);return e?e[1]:n}function Iv(n){const e=WS.exec(n);return e?e[1]:""}const qS=/\?.*/;function zp(n){if(Ic(n)){const e=mg(n.url||""),i=n.headers.get("content-type")||"";return{url:e,type:$S(i)||Iv(e)}}return Cc(n)?{url:mg(n.name||""),type:n.type||""}:typeof n=="string"?{url:mg(n),type:Iv(n)}:{url:"",type:""}}function HS(n){return Ic(n)?n.headers["content-length"]||-1:Cc(n)?n.size:typeof n=="string"?n.length:n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.byteLength:-1}function mg(n){return n.replace(qS,"")}async function Hb(n){if(Ic(n))return n;const e={},i=HS(n);i>=0&&(e["content-length"]=String(i));const{url:l,type:u}=zp(n);u&&(e["content-type"]=u);const f=await KS(n);f&&(e["x-first-bytes"]=f),typeof n=="string"&&(n=new TextEncoder().encode(n));const y=new Response(n,{headers:e});return Object.defineProperty(y,"url",{value:l}),y}async function XS(n){if(!n.ok){const e=await YS(n);throw new Error(e)}}async function YS(n){let e="Failed to fetch resource ".concat(n.url," (").concat(n.status,"): ");try{const i=n.headers.get("Content-Type");let l=n.statusText;i.includes("application/json")&&(l+=" ".concat(await n.text())),e+=l,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch{}return e}async function KS(n){if(typeof n=="string")return"data:,".concat(n.slice(0,5));if(n instanceof Blob){const i=n.slice(0,5);return await new Promise(l=>{const u=new FileReader;u.onload=f=>{var y;return l(f==null||(y=f.target)===null||y===void 0?void 0:y.result)},u.readAsDataURL(i)})}if(n instanceof ArrayBuffer){const i=n.slice(0,5),l=JS(i);return"data:base64,".concat(l)}return null}function JS(n){let e="";const i=new Uint8Array(n);for(let l=0;l<i.byteLength;l++)e+=String.fromCharCode(i[l]);return btoa(e)}async function Cv(n,e){if(typeof n=="string"){n=OS(n);let i=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(i=e.fetch),await fetch(n,i)}return await Hb(n)}function Xb(n){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;const e=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,i=n||e;return!!(i&&i.indexOf("Electron")>=0)}function Do(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||Xb()}const np={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},Of=np.window||np.self||np.global,uh=np.process||{},Yb=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";Do();const gg=globalThis;function Kb(n){if(!n&&!Do())return"Node";if(Xb(n))return"Electron";const i=n||(typeof navigator<"u"?navigator:{}).userAgent||"";if(i.indexOf("Edge")>-1)return"Edge";const l=i.indexOf("MSIE ")!==-1,u=i.indexOf("Trident/")!==-1;return l||u?"IE":gg.chrome?"Chrome":gg.safari?"Safari":gg.mozInnerScreenX?"Firefox":"Unknown"}function QS(n){try{const e=window[n],i="__storage_test__";return e.setItem(i,i),e.removeItem(i),e}catch{return null}}class eM{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";G(this,"storage",void 0),G(this,"id",void 0),G(this,"config",{}),this.storage=QS(l),this.id=e,this.config={},Object.assign(this.config,i),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const i=JSON.stringify(this.config);this.storage.setItem(this.id,i)}return this}_loadConfiguration(){let e={};if(this.storage){const i=this.storage.getItem(this.id);e=i?JSON.parse(i):{}}return Object.assign(this.config,e),this}}function tM(n){let e;return n<10?e="".concat(n.toFixed(2),"ms"):n<100?e="".concat(n.toFixed(1),"ms"):n<1e3?e="".concat(n.toFixed(0),"ms"):e="".concat((n/1e3).toFixed(2),"s"),e}function iM(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;const i=Math.max(e-n.length,0);return"".concat(" ".repeat(i)).concat(n)}function _g(n,e,i){let l=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600;const u=n.src.replace(/\(/g,"%28").replace(/\)/g,"%29");n.width>l&&(i=Math.min(i,l/n.width));const f=n.width*i,y=n.height*i,a=["font-size:1px;","padding:".concat(Math.floor(y/2),"px ").concat(Math.floor(f/2),"px;"),"line-height:".concat(y,"px;"),"background:url(".concat(u,");"),"background-size:".concat(f,"px ").concat(y,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),a]}let pp;(function(n){n[n.BLACK=30]="BLACK",n[n.RED=31]="RED",n[n.GREEN=32]="GREEN",n[n.YELLOW=33]="YELLOW",n[n.BLUE=34]="BLUE",n[n.MAGENTA=35]="MAGENTA",n[n.CYAN=36]="CYAN",n[n.WHITE=37]="WHITE",n[n.BRIGHT_BLACK=90]="BRIGHT_BLACK",n[n.BRIGHT_RED=91]="BRIGHT_RED",n[n.BRIGHT_GREEN=92]="BRIGHT_GREEN",n[n.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",n[n.BRIGHT_BLUE=94]="BRIGHT_BLUE",n[n.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",n[n.BRIGHT_CYAN=96]="BRIGHT_CYAN",n[n.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(pp||(pp={}));function Lv(n){return typeof n=="string"?pp[n.toUpperCase()]||pp.WHITE:n}function nM(n,e,i){return!Do&&typeof n=="string"&&(e&&(e=Lv(e),n="\x1B[".concat(e,"m").concat(n,"\x1B[39m")),i&&(e=Lv(i),n="\x1B[".concat(i+10,"m").concat(n,"\x1B[49m"))),n}function rM(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"];const i=Object.getPrototypeOf(n),l=Object.getOwnPropertyNames(i);for(const u of l)typeof n[u]=="function"&&(e.find(f=>u===f)||(n[u]=n[u].bind(n)))}function mp(n,e){if(!n)throw new Error(e||"Assertion failed")}function ic(){let n;if(Do&&"performance"in Of){var e,i;n=Of==null||(e=Of.performance)===null||e===void 0||(i=e.now)===null||i===void 0?void 0:i.call(e)}else if("hrtime"in uh){var l;const u=uh==null||(l=uh.hrtime)===null||l===void 0?void 0:l.call(uh);n=u[0]*1e3+u[1]/1e6}else n=Date.now();return n}const nc={debug:Do&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},sM={enabled:!0,level:0};function ms(){}const kv={},Rv={once:!0};class Gh{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};G(this,"id",void 0),G(this,"VERSION",Yb),G(this,"_startTs",ic()),G(this,"_deltaTs",ic()),G(this,"_storage",void 0),G(this,"userData",{}),G(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new eM("__probe-".concat(this.id,"__"),sM),this.userData={},this.timeStamp("".concat(this.id," started")),rM(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((ic()-this._startTs).toPrecision(10))}getDelta(){return Number((ic()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,i){this._storage.updateConfiguration({[e]:i})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,i){mp(e,i)}warn(e){return this._getLogFunction(0,e,nc.warn,arguments,Rv)}error(e){return this._getLogFunction(0,e,nc.error,arguments)}deprecated(e,i){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(i,"` instead"))}removed(e,i){return this.error("`".concat(e,"` has been removed. Use `").concat(i,"` instead"))}probe(e,i){return this._getLogFunction(e,i,nc.log,arguments,{time:!0,once:!0})}log(e,i){return this._getLogFunction(e,i,nc.debug,arguments)}info(e,i){return this._getLogFunction(e,i,console.info,arguments)}once(e,i){for(var l=arguments.length,u=new Array(l>2?l-2:0),f=2;f<l;f++)u[f-2]=arguments[f];return this._getLogFunction(e,i,nc.debug||nc.info,arguments,Rv)}table(e,i,l){return i?this._getLogFunction(e,i,console.table||ms,l&&[l],{tag:cM(i)}):ms}image(e){let{logLevel:i,priority:l,image:u,message:f="",scale:y=1}=e;return this._shouldLog(i||l)?Do?lM({image:u,message:f,scale:y}):aM({image:u,message:f,scale:y}):ms}time(e,i){return this._getLogFunction(e,i,console.time?console.time:console.info)}timeEnd(e,i){return this._getLogFunction(e,i,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,i){return this._getLogFunction(e,i,console.timeStamp||ms)}group(e,i){let l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1};const u=Dv({logLevel:e,message:i,opts:l}),{collapsed:f}=l;return u.method=(f?console.groupCollapsed:console.group)||console.info,this._getLogFunction(u)}groupCollapsed(e,i){let l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,i,Object.assign({},l,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||ms)}withGroup(e,i,l){this.group(e,i)();try{l()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Jb(e)}_getLogFunction(e,i,l,u,f){if(this._shouldLog(e)){f=Dv({logLevel:e,message:i,args:u,opts:f}),l=l||f.method,mp(l),f.total=this.getTotal(),f.delta=this.getDelta(),this._deltaTs=ic();const y=f.tag||f.message;if(f.once)if(!kv[y])kv[y]=ic();else return ms;return i=oM(this.id,f.message,f),l.bind(console,i,...f.args)}return ms}}G(Gh,"VERSION",Yb);function Jb(n){if(!n)return 0;let e;switch(typeof n){case"number":e=n;break;case"object":e=n.logLevel||n.priority||0;break;default:return 0}return mp(Number.isFinite(e)&&e>=0),e}function Dv(n){const{logLevel:e,message:i}=n;n.logLevel=Jb(e);const l=n.args?Array.from(n.args):[];for(;l.length&&l.shift()!==i;);switch(typeof e){case"string":case"function":i!==void 0&&l.unshift(i),n.message=e;break;case"object":Object.assign(n,e);break}typeof n.message=="function"&&(n.message=n.message());const u=typeof n.message;return mp(u==="string"||u==="object"),Object.assign(n,{args:l},n.opts)}function oM(n,e,i){if(typeof e=="string"){const l=i.time?iM(tM(i.total)):"";e=i.time?"".concat(n,": ").concat(l,"  ").concat(e):"".concat(n,": ").concat(e),e=nM(e,i.color,i.background)}return e}function aM(n){let{image:e,message:i="",scale:l=1}=n;return(void 0)({image:e,message:i,scale:l}),ms}function lM(n){let{image:e,message:i="",scale:l=1}=n;if(typeof e=="string"){const f=new Image;return f.onload=()=>{const y=_g(f,i,l);console.log(...y)},f.src=e,ms}const u=e.nodeName||"";if(u.toLowerCase()==="img")return console.log(..._g(e,i,l)),ms;if(u.toLowerCase()==="canvas"){const f=new Image;return f.onload=()=>console.log(..._g(f,i,l)),f.src=e.toDataURL(),ms}return ms}function cM(n){for(const e in n)for(const i in n[e])return i||"untitled";return"empty"}const zv=new Gh({id:"loaders.gl"});class uM{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class hM{constructor(){G(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const Qb={fetch:null,mimeType:void 0,nothrow:!1,log:new hM,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:G_,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},dM={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function ew(){globalThis.loaders=globalThis.loaders||{};const{loaders:n}=globalThis;return n._state=n._state||{},n._state}const tw=()=>{const n=ew();return n.globalOptions=n.globalOptions||{...Qb},n.globalOptions};function fM(n,e,i,l){return i=i||[],i=Array.isArray(i)?i:[i],pM(n,i),gM(e,n,l)}function iw(n,e){const i=tw(),l=n||i;return typeof l.fetch=="function"?l.fetch:jh(l.fetch)?u=>Cv(u,l):e!=null&&e.fetch?e?.fetch:Cv}function pM(n,e){Ov(n,null,Qb,dM,e);for(const i of e){const l=n&&n[i.id]||{},u=i.options&&i.options[i.id]||{},f=i.deprecatedOptions&&i.deprecatedOptions[i.id]||{};Ov(l,i.id,u,f,e)}}function Ov(n,e,i,l,u){const f=e||"Top level",y=e?"".concat(e,"."):"";for(const a in n){const E=!e&&jh(n[a]),I=a==="baseUri"&&!e,O=a==="workerUrl"&&e;if(!(a in i)&&!I&&!O){if(a in l)zv.warn("".concat(f," loader option '").concat(y).concat(a,"' no longer supported, use '").concat(l[a],"'"))();else if(!E){const R=mM(a,u);zv.warn("".concat(f," loader option '").concat(y).concat(a,"' not recognized. ").concat(R))()}}}}function mM(n,e){const i=n.toLowerCase();let l="";for(const u of e)for(const f in u.options){if(n===f)return"Did you mean '".concat(u.id,".").concat(f,"'?");const y=f.toLowerCase();(i.startsWith(y)||y.startsWith(i))&&(l=l||"Did you mean '".concat(u.id,".").concat(f,"'?"))}return l}function gM(n,e,i){const u={...n.options||{}};return _M(u,i),u.log===null&&(u.log=new uM),Bv(u,tw()),Bv(u,e),u}function Bv(n,e){for(const i in e)if(i in e){const l=e[i];Pv(l)&&Pv(n[i])?n[i]={...n[i],...e[i]}:n[i]=e[i]}}function _M(n,e){e&&!("baseUri"in n)&&(n.baseUri=e)}function Z_(n){var e;return n?(Array.isArray(n)&&(n=n[0]),Array.isArray((e=n)===null||e===void 0?void 0:e.extensions)):!1}function $_(n){var e,i;fp(n,"null loader"),fp(Z_(n),"invalid loader");let l;return Array.isArray(n)&&(l=n[1],n=n[0],n={...n,options:{...n.options,...l}}),((e=n)!==null&&e!==void 0&&e.parseTextSync||(i=n)!==null&&i!==void 0&&i.parseText)&&(n.text=!0),n.text||(n.binary=!0),n}const nw=()=>{const n=ew();return n.loaderRegistry=n.loaderRegistry||[],n.loaderRegistry};function yM(n){const e=nw();n=Array.isArray(n)?n:[n];for(const i of n){const l=$_(i);e.find(u=>l===u)||e.unshift(l)}}function xM(){return nw()}const vM=new Gh({id:"loaders.gl"}),bM=/\.([^.]+)$/;async function wM(n,e=[],i,l){if(!rw(n))return null;let u=Fv(n,e,{...i,nothrow:!0},l);if(u)return u;if(Cc(n)&&(n=await n.slice(0,10).arrayBuffer(),u=Fv(n,e,i,l)),!u&&!(i!=null&&i.nothrow))throw new Error(sw(n));return u}function Fv(n,e=[],i,l){if(!rw(n))return null;if(e&&!Array.isArray(e))return $_(e);let u=[];e&&(u=u.concat(e)),i!=null&&i.ignoreRegisteredLoaders||u.push(...xM()),EM(u);const f=TM(n,u,i,l);if(!f&&!(i!=null&&i.nothrow))throw new Error(sw(n));return f}function TM(n,e,i,l){const{url:u,type:f}=zp(n),y=u||l?.url;let a=null,E="";if(i!=null&&i.mimeType&&(a=yg(e,i?.mimeType),E="match forced by supplied MIME type ".concat(i?.mimeType)),a=a||AM(e,y),E=E||(a?"matched url ".concat(y):""),a=a||yg(e,f),E=E||(a?"matched MIME type ".concat(f):""),a=a||MM(e,n),E=E||(a?"matched initial data ".concat(ow(n)):""),a=a||yg(e,i?.fallbackMimeType),E=E||(a?"matched fallback MIME type ".concat(f):""),E){var I;vM.log(1,"selectLoader selected ".concat((I=a)===null||I===void 0?void 0:I.name,": ").concat(E,"."))}return a}function rw(n){return!(n instanceof Response&&n.status===204)}function sw(n){const{url:e,type:i}=zp(n);let l="No valid loader found (";l+=e?"".concat(BS(e),", "):"no url provided, ",l+="MIME type: ".concat(i?'"'.concat(i,'"'):"not provided",", ");const u=n?ow(n):"";return l+=u?' first bytes: "'.concat(u,'"'):"first bytes: not available",l+=")",l}function EM(n){for(const e of n)$_(e)}function AM(n,e){const i=e&&bM.exec(e),l=i&&i[1];return l?SM(n,l):null}function SM(n,e){e=e.toLowerCase();for(const i of n)for(const l of i.extensions)if(l.toLowerCase()===e)return i;return null}function yg(n,e){for(const i of n)if(i.mimeTypes&&i.mimeTypes.includes(e)||e==="application/x.".concat(i.id))return i;return null}function MM(n,e){if(!e)return null;for(const i of n)if(typeof e=="string"){if(PM(e,i))return i}else if(ArrayBuffer.isView(e)){if(Nv(e.buffer,e.byteOffset,i))return i}else if(e instanceof ArrayBuffer&&Nv(e,0,i))return i;return null}function PM(n,e){return e.testText?e.testText(n):(Array.isArray(e.tests)?e.tests:[e.tests]).some(l=>n.startsWith(l))}function Nv(n,e,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some(u=>IM(n,e,i,u))}function IM(n,e,i,l){if(l instanceof ArrayBuffer)return kS(l,n,l.byteLength);switch(typeof l){case"function":return l(n,i);case"string":const u=n_(n,e,l.length);return l===u;default:return!1}}function ow(n,e=5){return typeof n=="string"?n.slice(0,e):ArrayBuffer.isView(n)?n_(n.buffer,n.byteOffset,e):n instanceof ArrayBuffer?n_(n,0,e):""}function n_(n,e,i){if(n.byteLength<e+i)return"";const l=new DataView(n);let u="";for(let f=0;f<i;f++)u+=String.fromCharCode(l.getUint8(e+f));return u}const CM=256*1024;function*LM(n,e){const i=e?.chunkSize||CM;let l=0;const u=new TextEncoder;for(;l<n.length;){const f=Math.min(n.length-l,i),y=n.slice(l,l+f);l+=f,yield u.encode(y)}}const kM=256*1024;function*RM(n,e={}){const{chunkSize:i=kM}=e;let l=0;for(;l<n.byteLength;){const u=Math.min(n.byteLength-l,i),f=new ArrayBuffer(u),y=new Uint8Array(n,l,u);new Uint8Array(f).set(y),l+=u,yield f}}const DM=1024*1024;async function*zM(n,e){const i=e?.chunkSize||DM;let l=0;for(;l<n.size;){const u=l+i,f=await n.slice(l,u).arrayBuffer();l=u,yield f}}function Uv(n,e){return G_?OM(n,e):BM(n)}async function*OM(n,e){const i=n.getReader();let l;try{for(;;){const u=l||i.read();e!=null&&e._streamReadAhead&&(l=i.read());const{done:f,value:y}=await u;if(f)return;yield $b(y)}}catch{i.releaseLock()}}async function*BM(n,e){for await(const i of n)yield $b(i)}function FM(n,e){if(typeof n=="string")return LM(n,e);if(n instanceof ArrayBuffer)return RM(n,e);if(Cc(n))return zM(n,e);if(qb(n))return Uv(n,e);if(Ic(n))return Uv(n.body,e);throw new Error("makeIterator")}const aw="Cannot convert supplied data type";function NM(n,e,i){if(e.text&&typeof n=="string")return n;if(VS(n)&&(n=n.buffer),n instanceof ArrayBuffer){const l=n;return e.text&&!e.binary?new TextDecoder("utf8").decode(l):l}if(ArrayBuffer.isView(n)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(n);let l=n.buffer;const u=n.byteLength||n.length;return(n.byteOffset!==0||u!==l.byteLength)&&(l=l.slice(n.byteOffset,n.byteOffset+u)),l}throw new Error(aw)}async function UM(n,e,i){const l=n instanceof ArrayBuffer||ArrayBuffer.isView(n);if(typeof n=="string"||l)return NM(n,e);if(Cc(n)&&(n=await Hb(n)),Ic(n)){const u=n;return await XS(u),e.binary?await u.arrayBuffer():await u.text()}if(qb(n)&&(n=FM(n,i)),NS(n)||US(n))return DS(n);throw new Error(aw)}function VM(n,e,i=null){if(i)return i;const l={fetch:iw(e,n),...n};return Array.isArray(l.loaders)||(l.loaders=null),l}function jM(n,e){if(!e&&n&&!Array.isArray(n))return n;let i;if(n&&(i=Array.isArray(n)?n:[n]),e&&e.loaders){const l=Array.isArray(e.loaders)?e.loaders:[e.loaders];i=i?[...i,...l]:l}return i&&i.length?i:null}async function q_(n,e,i,l){Co(!l||typeof l=="object"),e&&!Array.isArray(e)&&!Z_(e)&&(l=void 0,i=e,e=void 0),n=await n,i=i||{};const{url:u}=zp(n),y=jM(e,l),a=await wM(n,y,i);return a?(i=fM(i,a,y,u),l=VM({url:u,parse:q_,loaders:y},i,l),await GM(a,n,i,l)):null}async function GM(n,e,i,l){if(MS(n),Ic(e)){const u=e,{ok:f,redirected:y,status:a,statusText:E,type:I,url:O}=u,R=Object.fromEntries(u.headers.entries());l.response={headers:R,ok:f,redirected:y,status:a,statusText:E,type:I,url:O}}if(e=await UM(e,n,i),n.parseTextSync&&typeof e=="string")return i.dataType="text",n.parseTextSync(e,i,l,n);if(PS(n,i))return await IS(n,e,i,l,q_);if(n.parseText&&typeof e=="string")return await n.parseText(e,i,l,n);if(n.parse)return await n.parse(e,i,l,n);throw Co(!n.parseSync),new Error("".concat(n.id," loader - no parser found and worker is disabled"))}async function r_(n,e,i,l){!Array.isArray(e)&&!Z_(e)&&(i=e,e=void 0);const u=iw(i);let f=n;return typeof n=="string"&&(f=await u(n)),Cc(n)&&(f=await u(n)),await q_(f,e,i)}const WM="3.2.12",{_parseImageNode:ZM}=globalThis,s_=typeof Image<"u",o_=typeof ImageBitmap<"u",$M=Boolean(ZM),a_=G_?!0:$M;function qM(n){switch(n){case"auto":return o_||s_||a_;case"imagebitmap":return o_;case"image":return s_;case"data":return a_;default:throw new Error("@loaders.gl/images: image ".concat(n," not supported in this environment"))}}function HM(){if(o_)return"imagebitmap";if(s_)return"image";if(a_)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function XM(n){const e=KM(n);if(!e)throw new Error("Not an image");return e}function YM(n){switch(XM(n)){case"data":return n;case"image":case"imagebitmap":const e=document.createElement("canvas"),i=e.getContext("2d");if(!i)throw new Error("getImageData");return e.width=n.width,e.height=n.height,i.drawImage(n,0,0),i.getImageData(0,0,n.width,n.height);default:throw new Error("getImageData")}}function KM(n){return typeof ImageBitmap<"u"&&n instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&n instanceof Image?"image":n&&typeof n=="object"&&n.data&&n.width&&n.height?"data":null}const JM=/^data:image\/svg\+xml/,QM=/\.svg((\?|#).*)?$/;function H_(n){return n&&(JM.test(n)||QM.test(n))}function eP(n,e){if(H_(e)){let l=new TextDecoder().decode(n);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(l=unescape(encodeURIComponent(l)))}catch(f){throw new Error(f.message)}return"data:image/svg+xml;base64,".concat(btoa(l))}return lw(n,e)}function lw(n,e){if(H_(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(n)])}async function cw(n,e,i){const l=eP(n,i),u=self.URL||self.webkitURL,f=typeof l!="string"&&u.createObjectURL(l);try{return await tP(f||l,e)}finally{f&&u.revokeObjectURL(f)}}async function tP(n,e){const i=new Image;return i.src=n,e.image&&e.image.decode&&i.decode?(await i.decode(),i):await new Promise((l,u)=>{try{i.onload=()=>l(i),i.onerror=f=>u(new Error("Could not load image ".concat(n,": ").concat(f)))}catch(f){u(f)}})}const iP={};let Vv=!0;async function nP(n,e,i){let l;H_(i)?l=await cw(n,e,i):l=lw(n,i);const u=e&&e.imagebitmap;return await rP(l,u)}async function rP(n,e=null){if((sP(e)||!Vv)&&(e=null),e)try{return await createImageBitmap(n,e)}catch(i){console.warn(i),Vv=!1}return await createImageBitmap(n)}function sP(n){for(const e in n||iP)return!1;return!0}const so=!1,Th=!0;function uw(n){const e=Wh(n);return oP(e)||cP(e)||aP(e)||lP(e)}function oP(n){const e=Wh(n);return e.byteLength>=24&&e.getUint32(0,so)===2303741511?{mimeType:"image/png",width:e.getUint32(16,so),height:e.getUint32(20,so)}:null}function aP(n){const e=Wh(n);return e.byteLength>=10&&e.getUint32(0,so)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,Th),height:e.getUint16(8,Th)}:null}function lP(n){const e=Wh(n);return e.byteLength>=14&&e.getUint16(0,so)===16973&&e.getUint32(2,Th)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,Th),height:e.getUint32(22,Th)}:null}function cP(n){const e=Wh(n);if(!(e.byteLength>=3&&e.getUint16(0,so)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:l,sofMarkers:u}=uP();let f=2;for(;f+9<e.byteLength;){const y=e.getUint16(f,so);if(u.has(y))return{mimeType:"image/jpeg",height:e.getUint16(f+5,so),width:e.getUint16(f+7,so)};if(!l.has(y))return null;f+=2,f+=e.getUint16(f,so)}return null}function uP(){const n=new Set([65499,65476,65484,65501,65534]);for(let i=65504;i<65520;++i)n.add(i);return{tableMarkers:n,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Wh(n){if(n instanceof DataView)return n;if(ArrayBuffer.isView(n))return new DataView(n.buffer);if(n instanceof ArrayBuffer)return new DataView(n);throw new Error("toDataView")}async function hP(n,e){const{mimeType:i}=uw(n)||{},l=globalThis._parseImageNode;return fp(l),await l(n,i)}async function dP(n,e,i){e=e||{};const u=(e.image||{}).type||"auto",{url:f}=i||{},y=fP(u);let a;switch(y){case"imagebitmap":a=await nP(n,e,f);break;case"image":a=await cw(n,e,f);break;case"data":a=await hP(n);break;default:fp(!1)}return u==="data"&&(a=YM(a)),a}function fP(n){switch(n){case"auto":case"data":return HM();default:return qM(n),n}}const pP=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],mP=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],gP={image:{type:"auto",decode:!0}},_P={id:"image",module:"images",name:"Images",version:WM,mimeTypes:mP,extensions:pP,parse:dP,tests:[n=>Boolean(uw(new DataView(n)))],options:gP},Bi=new Gh({id:"deck"});let l_={};function yP(n){l_=n}function cr(n,e,i,l){Bi.level>0&&l_[n]&&l_[n].call(null,e,i,l)}function xP(n){const e=n[0],i=n[n.length-1];return e==="{"&&i==="}"||e==="["&&i==="]"}const vP={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:xP,parseTextSync:JSON.parse},Eh="8.8.20",rp=globalThis.deck&&globalThis.deck.VERSION;if(rp&&rp!==Eh)throw new Error("deck.gl - multiple versions detected: ".concat(rp," vs ").concat(Eh));rp||(Bi.log(1,"deck.gl ".concat(Eh))(),globalThis.deck={...globalThis.deck,VERSION:Eh,version:Eh,log:Bi,_registerLoggers:yP},yM([vP,[_P,{imagebitmap:{premultiplyAlpha:"none"}}]]));const bP=globalThis.deck,Bt=new Gh({id:"luma.gl"});function vr(n,e){if(!n)throw new Error(e||"luma.gl: assertion failed.")}const wP="Invalid WebGLRenderingContext",TP="Requires WebGL2";function Op(n){return typeof WebGLRenderingContext<"u"&&n instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&Number.isFinite(n._version))}function gi(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&n._version===2)}function EP(n){return gi(n)?n:null}function Bp(n){return vr(Op(n),wP),n}function br(n){return vr(gi(n),TP),n}const _h={};function AP(n){globalThis.console&&globalThis.console.error&&globalThis.console.error(n)}function SP(n){globalThis.console&&globalThis.console.log&&globalThis.console.log(n)}function MP(n,e){_h[n]=!0,e!==void 0&&AP(e)}function PP(n){const e=n.getError;n.getError=function(){let l;do l=e.apply(n),l!==0&&(_h[l]=!0);while(l!==0);for(l in _h)if(_h[l])return delete _h[l],parseInt(l,10);return 0}}const Zh=function n(e){const i=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let l=0;l<this.attribs.length;l++){const u=new n.VertexAttrib(i);this.attribs[l]=u}this.maxAttrib=0};Zh.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};Zh.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};const Ka=function(e){const i=this;this.gl=e,PP(e);const l=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(f){return f===i.VERTEX_ARRAY_BINDING_OES?i.currentVertexArrayObject===i.defaultVertexArrayObject?null:i.currentVertexArrayObject:l.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(f){const y=i.currentVertexArrayObject;y.maxAttrib=Math.max(y.maxAttrib,f);const a=y.attribs[f];return a.enabled=!0,l.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(f){const y=i.currentVertexArrayObject;y.maxAttrib=Math.max(y.maxAttrib,f);const a=y.attribs[f];return a.enabled=!1,l.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(f,y){switch(f){case 34962:i.currentArrayBuffer=y;break;case 34963:i.currentVertexArrayObject.elementArrayBuffer=y;break}return l.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(f,y){const E=i.currentVertexArrayObject.attribs[f];switch(y){case 34975:return E.buffer;case 34338:return E.enabled;case 34339:return E.size;case 34340:return E.stride;case 34341:return E.type;case 34922:return E.normalized;default:return l.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(f,y,a,E,I,O){const R=i.currentVertexArrayObject;R.maxAttrib=Math.max(R.maxAttrib,f);const N=R.attribs[f];return N.buffer=i.currentArrayBuffer,N.size=y,N.type=a,N.normalized=E,N.stride=I,N.offset=O,N.recache(),l.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{SP("OESVertexArrayObject emulation library context restored"),i.reset_()},!0),this.reset_()};Ka.prototype.VERTEX_ARRAY_BINDING_OES=34229;Ka.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let l=0;l<this.vertexArrayObjects.length;++l)this.vertexArrayObjects.isAlive=!1;const i=this.gl;this.maxVertexAttribs=i.getParameter(34921),this.defaultVertexArrayObject=new Zh(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};Ka.prototype.createVertexArrayOES=function(){const e=new Zh(this);return this.vertexArrayObjects.push(e),e};Ka.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};Ka.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof Zh&&e.hasBeenBound&&e.ext===this)};Ka.prototype.bindVertexArrayOES=function(e){const i=this.gl;if(e&&!e.isAlive){MP(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}const l=this.original,u=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;const f=this.currentVertexArrayObject;if(u===f)return;(!u||f.elementArrayBuffer!==u.elementArrayBuffer)&&l.bindBuffer.call(i,34963,f.elementArrayBuffer);let y=this.currentArrayBuffer;const a=Math.max(u?u.maxAttrib:0,f.maxAttrib);for(let E=0;E<=a;E++){const I=f.attribs[E],O=u?u.attribs[E]:null;if((!u||I.enabled!==O.enabled)&&(I.enabled?l.enableVertexAttribArray.call(i,E):l.disableVertexAttribArray.call(i,E)),I.enabled){let R=!1;(!u||I.buffer!==O.buffer)&&(y!==I.buffer&&(l.bindBuffer.call(i,34962,I.buffer),y=I.buffer),R=!0),(R||I.cached!==O.cached)&&l.vertexAttribPointer.call(i,E,I.size,I.type,I.normalized,I.stride,I.offset)}}this.currentArrayBuffer!==y&&l.bindBuffer.call(i,34962,this.currentArrayBuffer)};function IP(n){if(typeof n.createVertexArray=="function")return;const e=n.getSupportedExtensions;n.getSupportedExtensions=function(){const u=e.call(this)||[];return u.indexOf("OES_vertex_array_object")<0&&u.push("OES_vertex_array_object"),u};const i=n.getExtension;n.getExtension=function(u){const f=i.call(this,u);return f||(u!=="OES_vertex_array_object"?null:(n.__OESVertexArrayObject||(this.__OESVertexArrayObject=new Ka(this)),this.__OESVertexArrayObject))}}const jv="OES_element_index",Gv="WEBGL_draw_buffers",CP="EXT_disjoint_timer_query",LP="EXT_disjoint_timer_query_webgl2",kP="EXT_texture_filter_anisotropic",Wv="WEBGL_debug_renderer_info",RP=35723,DP=4352,zP=36795,OP=34047,BP=37445,FP=37446,Zi=n=>gi(n)?void 0:0,NP={[3074]:n=>gi(n)?void 0:36064,[RP]:n=>gi(n)?void 0:DP,[35977]:Zi,[32937]:Zi,[zP]:(n,e)=>{const i=gi(n)?n.getExtension(LP):n.getExtension(CP);return i&&i.GPU_DISJOINT_EXT?e(i.GPU_DISJOINT_EXT):0},[BP]:(n,e)=>{const i=n.getExtension(Wv);return e(i&&i.UNMASKED_VENDOR_WEBGL||7936)},[FP]:(n,e)=>{const i=n.getExtension(Wv);return e(i&&i.UNMASKED_RENDERER_WEBGL||7937)},[OP]:(n,e)=>{const i=n.luma.extensions[kP];return i?e(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:Zi,[35071]:Zi,[37447]:Zi,[36063]:(n,e)=>{if(!gi(n)){const i=n.getExtension(Gv);return i?e(i.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:Zi,[35374]:Zi,[35377]:Zi,[34852]:n=>{if(!gi(n)){const e=n.getExtension(Gv);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:n=>n.getExtension(jv)?2147483647:65535,[33001]:n=>n.getExtension(jv)?16777216:65535,[33e3]:n=>16777216,[37157]:Zi,[35373]:Zi,[35657]:Zi,[36183]:Zi,[37137]:Zi,[34045]:Zi,[35978]:Zi,[35979]:Zi,[35968]:Zi,[35376]:Zi,[35375]:Zi,[35659]:Zi,[37154]:Zi,[35371]:Zi,[35658]:Zi,[35076]:Zi,[35077]:Zi,[35380]:Zi};function UP(n,e,i){const l=NP[i],u=typeof l=="function"?l(n,e,i):l;return u!==void 0?u:e(i)}const VP="OES_vertex_array_object",hw="ANGLE_instanced_arrays",jP="WEBGL_draw_buffers",GP="EXT_disjoint_timer_query",WP="EXT_texture_filter_anisotropic",ZP="VertexArray requires WebGL2 or OES_vertex_array_object extension";function $P(n,e){return{webgl2:gi(n),ext:n.getExtension(e)}}const dw={[VP]:{meta:{suffix:"OES"},createVertexArray:()=>{vr(!1,ZP)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[hw]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(n,e){vr(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[jP]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{vr(!1)}},[GP]:{meta:{suffix:"EXT"},createQuery:()=>{vr(!1)},deleteQuery:()=>{vr(!1)},beginQuery:()=>{vr(!1)},endQuery:()=>{},getQuery(n,e){return this.getQueryObject(n,e)},getQueryParameter(n,e){return this.getQueryObject(n,e)},getQueryObject:()=>{}}},xg={readBuffer:(n,e,i)=>{gi(n)&&e(i)},getVertexAttrib:(n,e,i,l)=>{const{webgl2:u,ext:f}=$P(n,hw);let y;switch(l){case 35069:y=u?void 0:!1;break;case 35070:y=!u&&!f?0:void 0;break}return y!==void 0?y:e(i,l)},getProgramParameter:(n,e,i,l)=>{if(!gi(n))switch(l){case 35967:return 35981;case 35971:return 0;case 35382:return 0}return e(i,l)},getInternalformatParameter:(n,e,i,l,u)=>{if(!gi(n))switch(u){case 32937:return new Int32Array([0])}return n.getInternalformatParameter(i,l,u)},getTexParameter(n,e,i,l){switch(l){case 34046:const{extensions:u}=n.luma,f=u[WP];l=f&&f.TEXTURE_MAX_ANISOTROPY_EXT||34046;break}return e(i,l)},getParameter:UP,hint(n,e,i,l){return e(i,l)}};function qP(n){n.luma=n.luma||{};const{luma:e}=n;return e.polyfilled||(IP(n),HP(n),YP(n,dw),XP(n,{target:e,target2:n}),e.polyfilled=!0),n}globalThis.polyfillContext=qP;function HP(n){n.luma.extensions={};const e=n.getSupportedExtensions()||[];for(const i of e)n.luma[i]=n.getExtension(i)}function XP(n,e){let{target:i,target2:l}=e;Object.keys(xg).forEach(u=>{if(typeof xg[u]=="function"){const f=n[u]?n[u].bind(n):()=>{},y=xg[u].bind(null,n,f);i[u]=y,l[u]=y}})}function YP(n,e){for(const i of Object.getOwnPropertyNames(e))i!=="overrides"&&KP(n,{extension:i,target:n.luma,target2:n})}function KP(n,e){let{extension:i,target:l,target2:u}=e;const f=dw[i];vr(f);const{meta:y={}}=f,{suffix:a=""}=y,E=n.getExtension(i);for(const I of Object.keys(f)){const O="".concat(I).concat(a);let R=null;I==="meta"||typeof n[I]=="function"||(E&&typeof E[O]=="function"?R=function(){return E[O](...arguments)}:typeof f[I]=="function"&&(R=f[I].bind(l))),R&&(l[I]=R,u[I]=R)}}const X_={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},ta=(n,e,i)=>e?n.enable(i):n.disable(i),Zv=(n,e,i)=>n.hint(i,e),Ur=(n,e,i)=>n.pixelStorei(i,e),JP=(n,e)=>{const i=gi(n)?36009:36160;return n.bindFramebuffer(i,e)},QP=(n,e)=>n.bindFramebuffer(36008,e);function hh(n){return Array.isArray(n)||ArrayBuffer.isView(n)}const eI={[3042]:ta,[32773]:(n,e)=>n.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(n,e)=>n.clearColor(...e),[3107]:(n,e)=>n.colorMask(...e),[2884]:ta,[2885]:(n,e)=>n.cullFace(e),[2929]:ta,[2931]:(n,e)=>n.clearDepth(e),[2932]:(n,e)=>n.depthFunc(e),[2928]:(n,e)=>n.depthRange(...e),[2930]:(n,e)=>n.depthMask(e),[3024]:ta,[35723]:Zv,[36006]:JP,[2886]:(n,e)=>n.frontFace(e),[33170]:Zv,[2849]:(n,e)=>n.lineWidth(e),[32823]:ta,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:ta,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:ta,[3088]:(n,e)=>n.scissor(...e),[2960]:ta,[2961]:(n,e)=>n.clearStencil(e),[2968]:(n,e)=>n.stencilMaskSeparate(1028,e),[36005]:(n,e)=>n.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(n,e)=>n.viewport(...e),[3333]:Ur,[3317]:Ur,[37440]:Ur,[37441]:Ur,[37443]:Ur,[3330]:Ur,[3332]:Ur,[3331]:Ur,[36010]:QP,[3314]:Ur,[32878]:Ur,[3316]:Ur,[3315]:Ur,[32877]:Ur,framebuffer:(n,e)=>{const i=e&&"handle"in e?e.handle:e;return n.bindFramebuffer(36160,i)},blend:(n,e)=>e?n.enable(3042):n.disable(3042),blendColor:(n,e)=>n.blendColor(...e),blendEquation:(n,e)=>{e=hh(e)?e:[e,e],n.blendEquationSeparate(...e)},blendFunc:(n,e)=>{e=hh(e)&&e.length===2?[...e,...e]:e,n.blendFuncSeparate(...e)},clearColor:(n,e)=>n.clearColor(...e),clearDepth:(n,e)=>n.clearDepth(e),clearStencil:(n,e)=>n.clearStencil(e),colorMask:(n,e)=>n.colorMask(...e),cull:(n,e)=>e?n.enable(2884):n.disable(2884),cullFace:(n,e)=>n.cullFace(e),depthTest:(n,e)=>e?n.enable(2929):n.disable(2929),depthFunc:(n,e)=>n.depthFunc(e),depthMask:(n,e)=>n.depthMask(e),depthRange:(n,e)=>n.depthRange(...e),dither:(n,e)=>e?n.enable(3024):n.disable(3024),derivativeHint:(n,e)=>{n.hint(35723,e)},frontFace:(n,e)=>n.frontFace(e),mipmapHint:(n,e)=>n.hint(33170,e),lineWidth:(n,e)=>n.lineWidth(e),polygonOffsetFill:(n,e)=>e?n.enable(32823):n.disable(32823),polygonOffset:(n,e)=>n.polygonOffset(...e),sampleCoverage:(n,e)=>n.sampleCoverage(...e),scissorTest:(n,e)=>e?n.enable(3089):n.disable(3089),scissor:(n,e)=>n.scissor(...e),stencilTest:(n,e)=>e?n.enable(2960):n.disable(2960),stencilMask:(n,e)=>{e=hh(e)?e:[e,e];const[i,l]=e;n.stencilMaskSeparate(1028,i),n.stencilMaskSeparate(1029,l)},stencilFunc:(n,e)=>{e=hh(e)&&e.length===3?[...e,...e]:e;const[i,l,u,f,y,a]=e;n.stencilFuncSeparate(1028,i,l,u),n.stencilFuncSeparate(1029,f,y,a)},stencilOp:(n,e)=>{e=hh(e)&&e.length===3?[...e,...e]:e;const[i,l,u,f,y,a]=e;n.stencilOpSeparate(1028,i,l,u),n.stencilOpSeparate(1029,f,y,a)},viewport:(n,e)=>n.viewport(...e)};function dn(n,e,i){return e[n]!==void 0?e[n]:i[n]}const tI={blendEquation:(n,e,i)=>n.blendEquationSeparate(dn(32777,e,i),dn(34877,e,i)),blendFunc:(n,e,i)=>n.blendFuncSeparate(dn(32969,e,i),dn(32968,e,i),dn(32971,e,i),dn(32970,e,i)),polygonOffset:(n,e,i)=>n.polygonOffset(dn(32824,e,i),dn(10752,e,i)),sampleCoverage:(n,e,i)=>n.sampleCoverage(dn(32938,e,i),dn(32939,e,i)),stencilFuncFront:(n,e,i)=>n.stencilFuncSeparate(1028,dn(2962,e,i),dn(2967,e,i),dn(2963,e,i)),stencilFuncBack:(n,e,i)=>n.stencilFuncSeparate(1029,dn(34816,e,i),dn(36003,e,i),dn(36004,e,i)),stencilOpFront:(n,e,i)=>n.stencilOpSeparate(1028,dn(2964,e,i),dn(2965,e,i),dn(2966,e,i)),stencilOpBack:(n,e,i)=>n.stencilOpSeparate(1029,dn(34817,e,i),dn(34818,e,i),dn(34819,e,i))},$v={enable:(n,e)=>n({[e]:!0}),disable:(n,e)=>n({[e]:!1}),pixelStorei:(n,e,i)=>n({[e]:i}),hint:(n,e,i)=>n({[e]:i}),bindFramebuffer:(n,e,i)=>{switch(e){case 36160:return n({[36006]:i,[36010]:i});case 36009:return n({[36006]:i});case 36008:return n({[36010]:i});default:return null}},blendColor:(n,e,i,l,u)=>n({[32773]:new Float32Array([e,i,l,u])}),blendEquation:(n,e)=>n({[32777]:e,[34877]:e}),blendEquationSeparate:(n,e,i)=>n({[32777]:e,[34877]:i}),blendFunc:(n,e,i)=>n({[32969]:e,[32968]:i,[32971]:e,[32970]:i}),blendFuncSeparate:(n,e,i,l,u)=>n({[32969]:e,[32968]:i,[32971]:l,[32970]:u}),clearColor:(n,e,i,l,u)=>n({[3106]:new Float32Array([e,i,l,u])}),clearDepth:(n,e)=>n({[2931]:e}),clearStencil:(n,e)=>n({[2961]:e}),colorMask:(n,e,i,l,u)=>n({[3107]:[e,i,l,u]}),cullFace:(n,e)=>n({[2885]:e}),depthFunc:(n,e)=>n({[2932]:e}),depthRange:(n,e,i)=>n({[2928]:new Float32Array([e,i])}),depthMask:(n,e)=>n({[2930]:e}),frontFace:(n,e)=>n({[2886]:e}),lineWidth:(n,e)=>n({[2849]:e}),polygonOffset:(n,e,i)=>n({[32824]:e,[10752]:i}),sampleCoverage:(n,e,i)=>n({[32938]:e,[32939]:i}),scissor:(n,e,i,l,u)=>n({[3088]:new Int32Array([e,i,l,u])}),stencilMask:(n,e)=>n({[2968]:e,[36005]:e}),stencilMaskSeparate:(n,e,i)=>n({[e===1028?2968:36005]:i}),stencilFunc:(n,e,i,l)=>n({[2962]:e,[2967]:i,[2963]:l,[34816]:e,[36003]:i,[36004]:l}),stencilFuncSeparate:(n,e,i,l,u)=>n({[e===1028?2962:34816]:i,[e===1028?2967:36003]:l,[e===1028?2963:36004]:u}),stencilOp:(n,e,i,l)=>n({[2964]:e,[2965]:i,[2966]:l,[34817]:e,[34818]:i,[34819]:l}),stencilOpSeparate:(n,e,i,l,u)=>n({[e===1028?2964:34817]:i,[e===1028?2965:34818]:l,[e===1028?2966:34819]:u}),viewport:(n,e,i,l,u)=>n({[2978]:[e,i,l,u]})},io=(n,e)=>n.isEnabled(e),qv={[3042]:io,[2884]:io,[2929]:io,[3024]:io,[32823]:io,[32926]:io,[32928]:io,[3089]:io,[2960]:io,[35977]:io};function fw(n){for(const e in n)return!1;return!0}function iI(n,e){if(n===e)return!0;const i=Array.isArray(n)||ArrayBuffer.isView(n),l=Array.isArray(e)||ArrayBuffer.isView(e);if(i&&l&&n.length===e.length){for(let u=0;u<n.length;++u)if(n[u]!==e[u])return!1;return!0}return!1}function Hv(n,e){const i=n[e].bind(n);n[e]=function(){const u=arguments.length<=0?void 0:arguments[0];return u in n.state.cache?n.state.enable?n.state.cache[u]:i(...arguments):i(...arguments)},Object.defineProperty(n[e],"name",{value:"".concat(e,"-from-cache"),configurable:!1})}function nI(n,e,i){const l=n[e].bind(n);n[e]=function(){for(var f=arguments.length,y=new Array(f),a=0;a<f;a++)y[a]=arguments[a];const{valueChanged:E,oldValue:I}=i(n.state._updateCache,...y);return E&&l(...y),I},Object.defineProperty(n[e],"name",{value:"".concat(e,"-to-cache"),configurable:!1})}function rI(n){const e=n.useProgram.bind(n);n.useProgram=function(l){n.state.program!==l&&(e(l),n.state.program=l)}}class sI{constructor(e){let{copyState:i=!1,log:l=()=>{}}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=i?aI(e):Object.assign({},X_),this.log=l,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){this.stateStack.push({})}pop(){vr(this.stateStack.length>0);const e=this.stateStack[this.stateStack.length-1];Lo(this.gl,e),this.stateStack.pop()}_updateCache(e){let i=!1,l;const u=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(const f in e){vr(f!==void 0);const y=e[f],a=this.cache[f];iI(y,a)||(i=!0,l=a,u&&!(f in u)&&(u[f]=a),this.cache[f]=y)}return{valueChanged:i,oldValue:l}}}function pw(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{enable:i=!0,copyState:l}=e;if(vr(l!==void 0),!n.state){const{polyfillContext:u}=globalThis;u&&u(n),n.state=new sI(n,{copyState:l}),rI(n);for(const f in $v){const y=$v[f];nI(n,f,y)}Hv(n,"getParameter"),Hv(n,"isEnabled")}return n.state.enable=i,n}function oI(n){n.state||pw(n,{copyState:!1}),n.state.push()}function Xv(n){vr(n.state),n.state.pop()}function Lo(n,e){if(vr(Op(n),"setParameters requires a WebGL context"),fw(e))return;const i={};for(const u in e){const f=Number(u),y=eI[u];y&&(typeof y=="string"?i[y]=!0:y(n,e[u],f))}const l=n.state&&n.state.cache;if(l)for(const u in i){const f=tI[u];f(n,e,l)}}function aI(n,e){if(e=e||X_,typeof e=="number"){const u=e,f=qv[u];return f?f(n,u):n.getParameter(u)}const i=Array.isArray(e)?e:Object.keys(e),l={};for(const u of i){const f=qv[u];l[u]=f?f(n,Number(u)):n.getParameter(Number(u))}return l}function lI(n){Lo(n,X_)}function gs(n,e,i){if(fw(e))return i(n);const{nocatch:l=!0}=e;oI(n),Lo(n,e);let u;if(l)u=i(n),Xv(n);else try{u=i(n)}finally{Xv(n)}return u}function _c(n){const{luma:e}=n;if(n.canvas&&e){const{clientWidth:i}=e.canvasSizeInfo;return i?n.drawingBufferWidth/i:1}return 1}function vg(n,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;const l=_c(n),u=n.drawingBufferWidth,f=n.drawingBufferHeight;return uI(e,l,u,f,i)}function cI(n){const e=typeof window>"u"?1:window.devicePixelRatio||1;return Number.isFinite(n)?n<=0?1:n:n?e:1}function uI(n,e,i,l,u){const f=Yv(n[0],e,i);let y=Kv(n[1],e,l,u),a=Yv(n[0]+1,e,i);const E=a===i-1?a:a-1;a=Kv(n[1]+1,e,l,u);let I;return u?(a=a===0?a:a+1,I=y,y=a):I=a===l-1?a:a-1,{x:f,y,width:Math.max(E-f+1,1),height:Math.max(I-y+1,1)}}function Yv(n,e,i){return Math.min(Math.round(n*e),i-1)}function Kv(n,e,i,l){return l?Math.max(0,i-1-Math.round(n*e)):Math.min(Math.round(n*e),i-1)}const Y_=Do(),hI=Y_&&typeof document<"u",mw={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function gw(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};vr(Y_,`createGLContext only available in the browser.
Create your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils`),n=Object.assign({},mw,n);const{width:e,height:i}=n;function l(a){if(n.throwOnError)throw new Error(a);return console.error(a),null}n.onError=l;let u;const{canvas:f}=n,y=mI({canvas:f,width:e,height:i,onError:l});return u=pI(y,n),u?(u=K_(u,n),gI(u),u):null}function K_(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!n||n._instrumented)return n;n._version=n._version||_I(n),n.luma=n.luma||{},n.luma.canvasSizeInfo=n.luma.canvasSizeInfo||{},e=Object.assign({},mw,e);const{manageState:i,debug:l}=e;return i&&pw(n,{copyState:!1,log:function(){for(var u=arguments.length,f=new Array(u),y=0;y<u;y++)f[y]=arguments[y];return Bt.log(1,...f)()}}),Y_&&l&&(globalThis.makeDebugContext?(n=globalThis.makeDebugContext(n,e),Bt.level=Math.max(Bt.level,1)):Bt.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),n._instrumented=!0,n}function dI(n){const e=n.getParameter(7936),i=n.getParameter(7937),l=n.getExtension("WEBGL_debug_renderer_info"),u=l&&n.getParameter(l.UNMASKED_VENDOR_WEBGL||7936),f=l&&n.getParameter(l.UNMASKED_RENDERER_WEBGL||7937);return{vendor:u||e,renderer:f||i,vendorMasked:e,rendererMasked:i,version:n.getParameter(7938),shadingLanguageVersion:n.getParameter(35724)}}function fI(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(n.canvas){const l=cI(e.useDevicePixels);yI(n,l,e);return}const i=n.getExtension("STACKGL_resize_drawingbuffer");i&&"width"in e&&"height"in e&&i.resize(e.width,e.height)}function pI(n,e){const{onError:i}=e;let l=null;const u=E=>l=E.statusMessage||l;n.addEventListener("webglcontextcreationerror",u,!1);const{webgl1:f=!0,webgl2:y=!0}=e;let a=null;return y&&(a=a||n.getContext("webgl2",e),a=a||n.getContext("experimental-webgl2",e)),f&&(a=a||n.getContext("webgl",e),a=a||n.getContext("experimental-webgl",e)),n.removeEventListener("webglcontextcreationerror",u,!1),a?(e.onContextLost&&n.addEventListener("webglcontextlost",e.onContextLost,!1),e.onContextRestored&&n.addEventListener("webglcontextrestored",e.onContextRestored,!1),a):i("Failed to create ".concat(y&&!f?"WebGL2":"WebGL"," context: ").concat(l||"Unknown error"))}function mI(n){let{canvas:e,width:i=800,height:l=600,onError:u}=n,f;return typeof e=="string"?(hI&&document.readyState==="complete"||u("createGLContext called on canvas '".concat(e,"' before page was loaded")),f=document.getElementById(e)):e?f=e:(f=document.createElement("canvas"),f.id="lumagl-canvas",f.style.width=Number.isFinite(i)?"".concat(i,"px"):"100%",f.style.height=Number.isFinite(l)?"".concat(l,"px"):"100%",document.body.insertBefore(f,document.body.firstChild)),f}function gI(n){const e=gi(n)?"WebGL2":"WebGL1",i=dI(n),l=i?"(".concat(i.vendor,",").concat(i.renderer,")"):"",u=n.debug?" debug":"";Bt.info(1,"".concat(e).concat(u," context ").concat(l))()}function _I(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?2:1}function yI(n,e,i){let l="width"in i?i.width:n.canvas.clientWidth,u="height"in i?i.height:n.canvas.clientHeight;(!l||!u)&&(Bt.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,l=n.canvas.width||1,u=n.canvas.height||1),n.luma=n.luma||{},n.luma.canvasSizeInfo=n.luma.canvasSizeInfo||{};const f=n.luma.canvasSizeInfo;if(f.clientWidth!==l||f.clientHeight!==u||f.devicePixelRatio!==e){let y=e;const a=Math.floor(l*y),E=Math.floor(u*y);n.canvas.width=a,n.canvas.height=E,(n.drawingBufferWidth!==a||n.drawingBufferHeight!==E)&&(Bt.warn("Device pixel ratio clamped")(),y=Math.min(n.drawingBufferWidth/l,n.drawingBufferHeight/u),n.canvas.width=Math.floor(l*y),n.canvas.height=Math.floor(u*y)),Object.assign(n.luma.canvasSizeInfo,{clientWidth:l,clientHeight:u,devicePixelRatio:e})}}const Ah="8.5.17",xI="set luma.log.level=1 (or higher) to trace rendering";class vI{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new W_({id:e})),this.stats.get(e)}}const Za=new vI;if(globalThis.luma&&globalThis.luma.VERSION!==Ah)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(Ah));globalThis.luma||(Do()&&Bt.log(1,"luma.gl ".concat(Ah," - ").concat(xI))(),globalThis.luma=globalThis.luma||{VERSION:Ah,version:Ah,log:Bt,stats:Za,globals:{modules:{},nodeIO:{}}});function bI(n){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(n):setTimeout(n,1e3/60)}function wI(n){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(n):clearTimeout(n)}function St(n,e){if(!n)throw new Error(e||"luma.gl: assertion failed.")}function bg(n,e){if(typeof e!="string")return e;const i=Number(e);if(!isNaN(i))return i;e=e.replace(/^.*\./,"");const l=n[e];return St(l!==void 0,"Accessing undefined constant GL.".concat(e)),l}function la(n,e){e=Number(e);for(const i in n)if(n[i]===e)return"GL.".concat(i);return String(e)}const wg={};function ca(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"id";wg[n]=wg[n]||1;const e=wg[n]++;return"".concat(n,"-").concat(e)}function Jv(n){return St(typeof n=="number","Input must be a number"),n&&(n&n-1)===0}function yc(n){let e=!0;for(const i in n){e=!1;break}return e}function _w(n,e,i,l){const u="See luma.gl ".concat(i," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),f=Object.getPrototypeOf(n);l.forEach(y=>{f.methodName||(f[y]=()=>{throw Bt.removed("Calling removed method ".concat(e,".").concat(y,": "),u)(),new Error(y)})})}const rc="Resource subclass must define virtual methods";class zo{get[Symbol.toStringTag](){return"Resource"}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Bp(e);const{id:l,userData:u={}}=i;this.gl=e,this.gl2=e,this.id=l||ca(this[Symbol.toStringTag]),this.userData=u,this._bound=!1,this._handle=i.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const i=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,i&&e&&i.filter(Boolean).forEach(l=>l.delete()),this}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.handle;if(typeof e!="function")return this._bindHandle(e),this;let i;return this._bound?i=e():(this._bindHandle(this.handle),this._bound=!0,i=e(),this._bound=!1,this._bindHandle(null)),i}unbind(){this.bind(null)}getParameter(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};e=bg(this.gl,e),St(e);const u=(this.constructor.PARAMETERS||{})[e];if(u){const f=gi(this.gl);if(!((!("webgl2"in u)||f)&&(!("extension"in u)||this.gl.getExtension(u.extension)))){const a=u.webgl1,E="webgl2"in u?u.webgl2:u.webgl1;return f?E:a}}return this._getParameter(e,i)}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{parameters:i,keys:l}=e,u=this.constructor.PARAMETERS||{},f=gi(this.gl),y={},a=i||Object.keys(u);for(const E of a){const I=u[E];if(I&&(!("webgl2"in I)||f)&&(!("extension"in I)||this.gl.getExtension(I.extension))){const R=l?la(this.gl,E):E;y[R]=this.getParameter(E,e),l&&I.type==="GLenum"&&(y[R]=la(this.gl,y[R]))}}return y}setParameter(e,i){e=bg(this.gl,e),St(e);const u=(this.constructor.PARAMETERS||{})[e];if(u){const f=gi(this.gl);if(!((!("webgl2"in u)||f)&&(!("extension"in u)||this.gl.getExtension(u.extension))))throw new Error("Parameter not available on this platform");u.type==="GLenum"&&(i=bg(i))}return this._setParameter(e,i),this}setParameters(e){for(const i in e)this.setParameter(i,e[i]);return this}stubRemovedMethods(e,i,l){return _w(this,e,i,l)}initialize(e){}_createHandle(){throw new Error(rc)}_deleteHandle(){throw new Error(rc)}_bindHandle(e){throw new Error(rc)}_getOptsFromHandle(){throw new Error(rc)}_getParameter(e,i){throw new Error(rc)}_setParameter(e,i){throw new Error(rc)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){const e=this[Symbol.toStringTag],i=Za.get("Resource Counts");i.get("Resources Created").incrementCount(),i.get("".concat(e,"s Created")).incrementCount(),i.get("".concat(e,"s Active")).incrementCount()}_removeStats(){const e=this[Symbol.toStringTag];Za.get("Resource Counts").get("".concat(e,"s Active")).decrementCount()}_trackAllocatedMemory(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag];this._trackAllocatedMemoryForContext(e,i),this._trackAllocatedMemoryForContext(e,i,this.gl.canvas&&this.gl.canvas.id)}_trackAllocatedMemoryForContext(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag],l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"";const u=Za.get("Memory Usage".concat(l));u.get("GPU Memory").addCount(e),u.get("".concat(i," Memory")).addCount(e),this.byteLength=e}_trackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag];this._trackDeallocatedMemoryForContext(e),this._trackDeallocatedMemoryForContext(e,this.gl.canvas&&this.gl.canvas.id)}_trackDeallocatedMemoryForContext(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag],i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";const l=Za.get("Memory Usage".concat(i));l.get("GPU Memory").subtractCount(this.byteLength),l.get("".concat(e," Memory")).subtractCount(this.byteLength),this.byteLength=0}}const TI="Failed to deduce GL constant from typed array";function c_(n){switch(ArrayBuffer.isView(n)?n.constructor:n){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(TI)}}function Sh(n){let{clamped:e=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};switch(n){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function EI(n){let{data:e,width:i,height:l,bytesPerPixel:u=4,temp:f}=n;const y=i*u;f=f||new Uint8Array(y);for(let a=0;a<l/2;++a){const E=a*y,I=(l-a-1)*y;f.set(e.subarray(E,E+y)),e.copyWithin(E,I,I+y),e.set(f,I)}}function AI(n){let{data:e,width:i,height:l}=n;const u=Math.round(i/2),f=Math.round(l/2),y=new Uint8Array(u*f*4);for(let a=0;a<f;a++)for(let E=0;E<u;E++)for(let I=0;I<4;I++)y[(a*u+E)*4+I]=e[(a*2*i+E*2)*4+I];return{data:y,width:u,height:f}}function u_(n,e,i){const{removedProps:l={},deprecatedProps:u={},replacedProps:f={}}=i;for(const a in l)if(a in e){const I=l[a]?"".concat(n,".").concat(l[a]):"N/A";Bt.removed("".concat(n,".").concat(a),I)()}for(const a in u)if(a in e){const E=u[a];Bt.deprecated("".concat(n,".").concat(a),"".concat(n,".").concat(E))()}let y=null;for(const a in f)if(a in e){const E=f[a];Bt.deprecated("".concat(n,".").concat(a),"".concat(n,".").concat(E))(),y=y||Object.assign({},e),y[E]=e[a],delete y[a]}return y||e}const SI={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},MI={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class Wr{static getBytesPerElement(e){return Sh(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return St(e.size),Sh(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(){for(var e=arguments.length,i=new Array(e),l=0;l<e;l++)i[l]=arguments[l];return new Wr(SI,...i)}constructor(){for(var e=arguments.length,i=new Array(e),l=0;l<e;l++)i[l]=arguments[l];i.forEach(u=>this._assign(u)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return Wr.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return Wr.getBytesPerVertex(this)}_assign(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e=u_("Accessor",e,MI),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}}const Qv=10,yw={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},PI={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:yw},II={removedProps:yw};class Ui extends zo{get[Symbol.toStringTag](){return"Buffer"}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,i),this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=i.target||(this.gl.webgl2?36662:34962),this.initialize(i),Object.seal(this)}getElementCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/Wr.getBytesPerElement(e))}getVertexCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/Wr.getBytesPerVertex(e))}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=u_("Buffer",e,PI),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=u_("Buffer",e,II),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new Wr(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});const{data:i,offset:l=0,srcOffset:u=0}=e,f=e.byteLength||e.length;St(i);const y=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(y,this.handle),u!==0||f!==void 0?(br(this.gl),this.gl.bufferSubData(this.target,l,i,u,f)):this.gl.bufferSubData(y,l,i),this.gl.bindBuffer(y,null),this.debugData=null,this._inferType(i),this}copyData(e){let{sourceBuffer:i,readOffset:l=0,writeOffset:u=0,size:f}=e;const{gl:y}=this;return br(y),y.bindBuffer(36662,i.handle),y.bindBuffer(36663,this.handle),y.copyBufferSubData(36662,36663,l,u,f),y.bindBuffer(36662,null),y.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:e=null,srcByteOffset:i=0,dstOffset:l=0,length:u=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};br(this.gl);const f=Sh(this.accessor.type||5126,{clamped:!1}),y=this._getAvailableElementCount(i),a=l;let E,I;e?(I=e.length,E=I-a):(E=Math.min(y,u||y),I=a+E);const O=Math.min(y,E);return u=u||O,St(u<=O),e=e||new f(I),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,i,e,l,u),this.gl.bindBuffer(36662,null),e}bind(){let{target:e=this.target,index:i=this.accessor&&this.accessor.index,offset:l=0,size:u}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?u!==void 0?this.gl.bindBufferRange(e,i,this.handle,l,u):(St(l===0),this.gl.bindBufferBase(e,i,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind(){let{target:e=this.target,index:i=this.accessor&&this.accessor.index}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?this.gl.bindBufferBase(e,i,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(Qv,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:e.byteLength+i;St(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();const u=this._getTarget();this.gl.bindBuffer(u,this.handle),this.gl.bufferData(u,l,this.usage),this.gl.bufferSubData(u,i,e),this.gl.bindBuffer(u,null),this.debugData=e.slice(0,Qv),this.bytesUsed=l,this._trackAllocatedMemory(l);const f=c_(e);return St(f),this.setAccessor(new Wr(this.accessor,{type:f})),this}_setByteLength(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.usage;St(e>=0),this._trackDeallocatedMemory();let l=e;e===0&&(l=new Float32Array(0));const u=this._getTarget();return this.gl.bindBuffer(u,this.handle),this.gl.bufferData(u,l,i),this.gl.bindBuffer(u,null),this.usage=i,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){const i=Sh(this.accessor.type||5126,{clamped:!1}),l=e/i.BYTES_PER_ELEMENT;return this.getElementCount()-l}_inferType(e){this.accessor.type||this.setAccessor(new Wr(this.accessor,{type:c_(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);const i=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),i}get type(){return Bt.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return Bt.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return Bt.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return Bt.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new Wr(this.accessor,e),this}}const J_={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},xw={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},vw={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function CI(n,e){const i=J_[e];if(!i)return!1;if(i.gl1===void 0&&i.gl2===void 0)return!0;const l=gi(n)&&i.gl2||i.gl1;return typeof l=="string"?n.getExtension(l):l}function LI(n,e){const i=J_[e];switch(i&&i.types[0]){case 5126:return n.getExtension("OES_texture_float_linear");case 5131:return n.getExtension("OES_texture_half_float_linear");default:return!0}}const kI=[9729,9728],e1=globalThis.WebGLBuffer||function(){};class xc extends zo{get[Symbol.toStringTag](){return"Texture"}static isSupported(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{format:l,linearFiltering:u}=i;let f=!0;return l&&(f=f&&CI(e,l),f=f&&(!u||LI(e,l))),f}constructor(e,i){const{id:l=ca("texture"),handle:u,target:f}=i;super(e,{id:l,handle:u}),this.target=f,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},i=e.data;if(i instanceof Promise)return i.then(Oe=>this.initialize(Object.assign({},e,{pixels:Oe,data:Oe}))),this;const l=typeof HTMLVideoElement<"u"&&i instanceof HTMLVideoElement;if(l&&i.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,i.addEventListener("loadeddata",()=>this.initialize(e)),this;const{pixels:u=null,format:f=6408,border:y=0,recreate:a=!1,parameters:E={},pixelStore:I={},textureUnit:O=void 0}=e;i||(i=u);let{width:R,height:N,dataFormat:H,type:re,compressed:ae=!1,mipmaps:be=!0}=e;const{depth:De=0}=e;return{width:R,height:N,compressed:ae,dataFormat:H,type:re}=this._deduceParameters({format:f,type:re,dataFormat:H,compressed:ae,data:i,width:R,height:N}),this.width=R,this.height=N,this.depth=De,this.format=f,this.type=re,this.dataFormat=H,this.border=y,this.textureUnit=O,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),be&&this._isNPOT()&&(Bt.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),be=!1,this._updateForNPOT(E)),this.mipmaps=be,this.setImageData({data:i,width:R,height:N,depth:De,format:f,type:re,dataFormat:H,border:y,mipmaps:be,parameters:I,compressed:ae}),be&&this.generateMipmap(),this.setParameters(E),a&&(this.data=i),l&&(this._video={video:i,parameters:E,lastTime:i.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?i.currentTime:-1}),this}update(){if(this._video){const{video:e,parameters:i,lastTime:l}=this._video;if(l===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:i}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize(e){let{height:i,width:l,mipmaps:u=!1}=e;return l!==this.width||i!==this.height?this.initialize({width:l,height:i,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:u}):this}generateMipmap(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isNPOT()?(Bt.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),gs(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");const{target:i=this.target,pixels:l=null,level:u=0,format:f=this.format,border:y=this.border,offset:a=0,parameters:E={}}=e;let{data:I=null,type:O=this.type,width:R=this.width,height:N=this.height,dataFormat:H=this.dataFormat,compressed:re=!1}=e;I||(I=l),{type:O,dataFormat:H,compressed:re,width:R,height:N}=this._deduceParameters({format:f,type:O,dataFormat:H,compressed:re,data:I,width:R,height:N});const{gl:ae}=this;ae.bindTexture(this.target,this.handle);let be=null;({data:I,dataType:be}=this._getDataType({data:I,compressed:re}));let De,Oe=0;if(gs(this.gl,E,()=>{switch(be){case"null":ae.texImage2D(i,u,f,R,N,y,H,O,I);break;case"typed-array":ae.texImage2D(i,u,f,R,N,y,H,O,I,a);break;case"buffer":De=br(ae),De.bindBuffer(35052,I.handle||I),De.texImage2D(i,u,f,R,N,y,H,O,a),De.bindBuffer(35052,null);break;case"browser-object":gi(ae)?ae.texImage2D(i,u,f,R,N,y,H,O,I):ae.texImage2D(i,u,f,H,O,I);break;case"compressed":for(const[Ce,Ve]of I.entries())ae.compressedTexImage2D(i,Ce,Ve.format,Ve.width,Ve.height,y,Ve.data),Oe+=Ve.levelSize;break;default:St(!1,"Unknown image data type")}}),be==="compressed")this._trackAllocatedMemory(Oe,"Texture");else if(I&&I.byteLength)this._trackAllocatedMemory(I.byteLength,"Texture");else{const Ce=xw[this.dataFormat]||4,Ve=vw[this.type]||1;this._trackAllocatedMemory(this.width*this.height*Ce*Ve,"Texture")}return this.loaded=!0,this}setSubImageData(e){let{target:i=this.target,pixels:l=null,data:u=null,x:f=0,y=0,width:a=this.width,height:E=this.height,level:I=0,format:O=this.format,type:R=this.type,dataFormat:N=this.dataFormat,compressed:H=!1,offset:re=0,border:ae=this.border,parameters:be={}}=e;if({type:R,dataFormat:N,compressed:H,width:a,height:E}=this._deduceParameters({format:O,type:R,dataFormat:N,compressed:H,data:u,width:a,height:E}),St(this.depth===0,"texSubImage not supported for 3D textures"),u||(u=l),u&&u.data){const De=u;u=De.data,a=De.shape[0],E=De.shape[1]}u instanceof Ui&&(u=u.handle),this.gl.bindTexture(this.target,this.handle),gs(this.gl,be,()=>{if(H)this.gl.compressedTexSubImage2D(i,I,f,y,a,E,O,u);else if(u===null)this.gl.texSubImage2D(i,I,f,y,a,E,N,R,null);else if(ArrayBuffer.isView(u))this.gl.texSubImage2D(i,I,f,y,a,E,N,R,u,re);else if(u instanceof e1){const De=br(this.gl);De.bindBuffer(35052,u),De.texSubImage2D(i,I,f,y,a,E,N,R,re),De.bindBuffer(35052,null)}else gi(this.gl)?br(this.gl).texSubImage2D(i,I,f,y,a,E,N,R,u):this.gl.texSubImage2D(i,I,f,y,N,R,u)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(){return Bt.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit;const{gl:i}=this;return e!==void 0&&(this.textureUnit=e,i.activeTexture(33984+e)),i.bindTexture(this.target,this.handle),e}unbind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit;const{gl:i}=this;return e!==void 0&&(this.textureUnit=e,i.activeTexture(33984+e)),i.bindTexture(this.target,null),e}_getDataType(e){let{data:i,compressed:l=!1}=e;return l?{data:i,dataType:"compressed"}:i===null?{data:i,dataType:"null"}:ArrayBuffer.isView(i)?{data:i,dataType:"typed-array"}:i instanceof Ui?{data:i.handle,dataType:"buffer"}:i instanceof e1?{data:i,dataType:"buffer"}:{data:i,dataType:"browser-object"}}_deduceParameters(e){const{format:i,data:l}=e;let{width:u,height:f,dataFormat:y,type:a,compressed:E}=e;const I=J_[i];return y=y||I&&I.dataFormat,a=a||I&&I.types[0],E=E||I&&I.compressed,{width:u,height:f}=this._deduceImageSize(l,u,f),{dataFormat:y,type:a,compressed:E,width:u,height:f,format:i,data:l}}_deduceImageSize(e,i,l){let u;return typeof ImageData<"u"&&e instanceof ImageData?u={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?u={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?u={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?u={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?u={width:e.videoWidth,height:e.videoHeight}:e?u={width:i,height:l}:u={width:i>=0?i:1,height:l>=0?l:1},St(u,"Could not deduced texture size"),St(i===void 0||u.width===i,"Deduced texture width does not match supplied width"),St(l===void 0||u.height===l,"Deduced texture height does not match supplied height"),u}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);const i=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),i}}_setParameter(e,i){switch(this.gl.bindTexture(this.target,this.handle),i=this._getNPOTParam(e,i),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,i);break;case 4096:case 4097:St(!1);break;default:this.gl.texParameteri(this.target,e,i);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return gi(this.gl)||!this.width||!this.height?!1:!Jv(this.width)||!Jv(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,i){if(this._isNPOT())switch(e){case 10241:kI.indexOf(i)===-1&&(i=9729);break;case 10242:case 10243:i!==33071&&(i=33071);break}return i}}let RI="";function DI(n,e){return St(typeof n=="string"),n=RI+n,new Promise((i,l)=>{try{const u=new Image;u.onload=()=>i(u),u.onerror=()=>l(new Error("Could not load image ".concat(n,"."))),u.crossOrigin=e&&e.crossOrigin||"anonymous",u.src=n}catch(u){l(u)}})}class qr extends xc{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(e,i){return xc.isSupported(e,i)}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Bp(e),(i instanceof Promise||typeof i=="string")&&(i={data:i}),typeof i.data=="string"&&(i=Object.assign({},i,{data:DI(i.data)})),super(e,Object.assign({},i,{target:3553})),this.initialize(i),Object.seal(this)}}const h_=[34069,34070,34071,34072,34073,34074];class bw extends xc{get[Symbol.toStringTag](){return"TextureCube"}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Bp(e),super(e,Object.assign({},i,{target:34067})),this.initialize(i),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{mipmaps:i=!0,parameters:l={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,i&&this.generateMipmap(e),this.setParameters(l)}),this}subImage(e){let{face:i,data:l,x:u=0,y:f=0,mipmapLevel:y=0}=e;return this._subImage({target:i,data:l,x:u,y:f,mipmapLevel:y})}async setCubeMapImageData(e){let{width:i,height:l,pixels:u,data:f,border:y=0,format:a=6408,type:E=5121}=e;const{gl:I}=this,O=u||f,R=await Promise.all(h_.map(N=>{const H=O[N];return Promise.all(Array.isArray(H)?H:[H])}));this.bind(),h_.forEach((N,H)=>{R[H].length>1&&this.opts.mipmaps!==!1&&Bt.warn("".concat(this.id," has mipmap and multiple LODs."))(),R[H].forEach((re,ae)=>{i&&l?I.texImage2D(N,ae,a,i,l,y,a,E,re):I.texImage2D(N,ae,a,a,E,re)})}),this.unbind()}setImageDataForFace(e){const{face:i,width:l,height:u,pixels:f,data:y,border:a=0,format:E=6408,type:I=5121}=e,{gl:O}=this,R=f||y;return this.bind(),R instanceof Promise?R.then(N=>this.setImageDataForFace(Object.assign({},e,{face:i,data:N,pixels:N}))):this.width||this.height?O.texImage2D(i,0,E,l,u,a,E,I,R):O.texImage2D(i,0,E,E,I,R),this}}bw.FACES=h_;class zI extends xc{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(e){return gi(e)}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};br(e),i=Object.assign({depth:1},i,{target:32879,unpackFlipY:!1}),super(e,i),this.initialize(i),Object.seal(this)}setImageData(e){let{level:i=0,dataFormat:l=6408,width:u,height:f,depth:y=1,border:a=0,format:E,type:I=5121,offset:O=0,data:R,parameters:N={}}=e;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),gs(this.gl,N,()=>{ArrayBuffer.isView(R)&&this.gl.texImage3D(this.target,i,l,u,f,y,a,E,I,R),R instanceof Ui&&(this.gl.bindBuffer(35052,R.handle),this.gl.texImage3D(this.target,i,l,u,f,y,a,E,I,O))}),R&&R.byteLength)this._trackAllocatedMemory(R.byteLength,"Texture");else{const H=xw[this.dataFormat]||4,re=vw[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*H*re,"Texture")}return this.loaded=!0,this}}const Ua="EXT_color_buffer_float",t1={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:Ua,bpp:2},[33327]:{gl2:Ua,bpp:4},[34842]:{gl2:Ua,bpp:8},[33326]:{gl2:Ua,bpp:4},[33328]:{gl2:Ua,bpp:8},[34836]:{gl2:Ua,bpp:16},[35898]:{gl2:Ua,bpp:4}};function OI(n,e,i){const l=i[e];if(!l)return!1;const u=gi(n)&&l.gl2||l.gl1;return typeof u=="string"?n.getExtension(u):u}class uc extends zo{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(e){let{format:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{format:null};return!i||OI(e,i,t1)}static getSamplesForFormat(e,i){let{format:l}=i;return e.getInternalformatParameter(36161,l,32937)}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,i),this.initialize(i),Object.seal(this)}initialize(e){let{format:i,width:l=1,height:u=1,samples:f=0}=e;return St(i,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),f!==0&&gi(this.gl)?this.gl.renderbufferStorageMultisample(36161,f,i,l,u):this.gl.renderbufferStorage(36161,i,l,u),this.format=i,this.width=l,this.height=u,this.samples=f,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*t1[this.format].bpp),this}resize(e){let{width:i,height:l}=e;return i!==this.width||l!==this.height?this.initialize({width:i,height:l,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}}const BI=256,FI=1024,NI=16384,i1=6144,n1=6145,r1=6146,s1=34041,ww="clear: bad arguments";function Q_(n){let{framebuffer:e=null,color:i=null,depth:l=null,stencil:u=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const f={};e&&(f.framebuffer=e);let y=0;i&&(y|=NI,i!==!0&&(f.clearColor=i)),l&&(y|=BI,l!==!0&&(f.clearDepth=l)),u&&(y|=FI,l!==!0&&(f.clearStencil=l)),St(y!==0,ww),gs(n,f,()=>{n.clear(y)})}function UI(n){let{framebuffer:e=null,buffer:i=i1,drawBuffer:l=0,value:u=[0,0,0,0]}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};br(n),gs(n,{framebuffer:e},()=>{switch(i){case i1:switch(u.constructor){case Int32Array:n.clearBufferiv(i,l,u);break;case Uint32Array:n.clearBufferuiv(i,l,u);break;case Float32Array:default:n.clearBufferfv(i,l,u)}break;case n1:n.clearBufferfv(n1,0,[u]);break;case r1:n.clearBufferiv(r1,0,[u]);break;case s1:const[f,y]=u;n.clearBufferfi(s1,0,f,y);break;default:St(!1,ww)}})}function VI(n){switch(n){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return St(!1),0}}function Fp(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{sourceX:i=0,sourceY:l=0,sourceFormat:u=6408}=e;let{sourceAttachment:f=36064,target:y=null,sourceWidth:a,sourceHeight:E,sourceType:I}=e;const{framebuffer:O,deleteFramebuffer:R}=jI(n);St(O);const{gl:N,handle:H,attachments:re}=O;a=a||O.width,E=E||O.height,f===36064&&H===null&&(f=1028),St(re[f]),I=I||re[f].type,y=GI(y,I,u,a,E),I=I||c_(y);const ae=N.bindFramebuffer(36160,H);return N.readPixels(i,l,a,E,u,I,y),N.bindFramebuffer(36160,ae||null),R&&O.delete(),y}function o1(n){let{sourceAttachment:e=36064,targetMaxHeight:i=Number.MAX_SAFE_INTEGER}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=Fp(n,{sourceAttachment:e}),{width:u,height:f}=n;for(;f>i;)({data:l,width:u,height:f}=AI({data:l,width:u,height:f}));EI({data:l,width:u,height:f});const y=document.createElement("canvas");y.width=u,y.height=f;const a=y.getContext("2d"),E=a.createImageData(u,f);return E.data.set(l),a.putImageData(E,0,0),y.toDataURL()}function jI(n){return n instanceof En?{framebuffer:n,deleteFramebuffer:!1}:{framebuffer:QI(n),deleteFramebuffer:!0}}function GI(n,e,i,l,u){if(n)return n;e=e||5121;const f=Sh(e,{clamped:!1}),y=VI(i);return new f(l*u*y)}const Yi={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function WI(n){const e=new qr(n,{format:6408,type:5126,dataFormat:6408}),i=new En(n,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),l=i.getStatus();return e.delete(),i.delete(),l===36053}const Tw={[Yi.WEBGL2]:[!1,!0],[Yi.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[Yi.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[Yi.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[Yi.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[Yi.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[Yi.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[Yi.FLOAT_BLEND]:["EXT_float_blend"],[Yi.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[Yi.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[Yi.TEXTURE_FLOAT]:["OES_texture_float",!0],[Yi.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[Yi.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[Yi.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[Yi.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[Yi.COLOR_ATTACHMENT_RGBA32F]:[WI,"EXT_color_buffer_float"],[Yi.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[Yi.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[Yi.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[Yi.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[Yi.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[Yi.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]},ZI=2;function $I(n,e){return ey(n,e)}function ey(n,e){return e=Array.isArray(e)?e:[e],e.every(i=>Ew(n,i))}function qI(n){n.luma=n.luma||{},n.luma.caps=n.luma.caps||{};for(const e in Tw)n.luma.caps[e]===void 0&&(n.luma.caps[e]=Ew(n,e));return n.luma.caps}function Ew(n,e){return n.luma=n.luma||{},n.luma.caps=n.luma.caps||{},n.luma.caps[e]===void 0&&(n.luma.caps[e]=HI(n,e)),n.luma.caps[e]||Bt.log(ZI,"Feature: ".concat(e," not supported"))(),n.luma.caps[e]}function HI(n,e){const i=Tw[e];St(i,e);let l;const u=gi(n)&&i[1]||i[0];if(typeof u=="function")l=u(n);else if(Array.isArray(u)){l=!0;for(const f of u)l=l&&Boolean(n.getExtension(f))}else typeof u=="string"?l=Boolean(n.getExtension(u)):typeof u=="boolean"?l=u:St(!1);return l}const a1="Multiple render targets not supported";class En extends zo{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{colorBufferFloat:l,colorBufferHalfFloat:u}=i;let f=!0;return l&&(f=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),u&&(f=f&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),f}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new En(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){const e=br(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){const e=br(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,i),this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(i),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(e){let{width:i=1,height:l=1,attachments:u=null,color:f=!0,depth:y=!0,stencil:a=!1,check:E=!0,readBuffer:I=void 0,drawBuffers:O=void 0}=e;if(St(i>=0&&l>=0,"Width and height need to be integers"),this.width=i,this.height=l,u)for(const R in u){const N=u[R];(Array.isArray(N)?N[0]:N).resize({width:i,height:l})}else u=this._createDefaultAttachments(f,y,a,i,l);this.update({clearAttachments:!0,attachments:u,readBuffer:I,drawBuffers:O}),u&&E&&this.checkStatus()}delete(){for(const e of this.ownResources)e.delete();return super.delete(),this}update(e){let{attachments:i={},readBuffer:l,drawBuffers:u,clearAttachments:f=!1,resizeAttachments:y=!0}=e;this.attach(i,{clearAttachments:f,resizeAttachments:y});const{gl:a}=this,E=a.bindFramebuffer(36160,this.handle);return l&&this._setReadBuffer(l),u&&this._setDrawBuffers(u),a.bindFramebuffer(36160,E||null),this}resize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{width:i,height:l}=e;if(this.handle===null)return St(i===void 0&&l===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;i===void 0&&(i=this.gl.drawingBufferWidth),l===void 0&&(l=this.gl.drawingBufferHeight),i!==this.width&&l!==this.height&&Bt.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(i,"x").concat(l))();for(const u in this.attachments)this.attachments[u].resize({width:i,height:l});return this.width=i,this.height=l,this}attach(e){let{clearAttachments:i=!1,resizeAttachments:l=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const u={};i&&Object.keys(this.attachments).forEach(y=>{u[y]=null}),Object.assign(u,e);const f=this.gl.bindFramebuffer(36160,this.handle);for(const y in u){St(y!==void 0,"Misspelled framebuffer binding point?");const a=Number(y),E=u[a];let I=E;if(!I)this._unattach(a);else if(I instanceof uc)this._attachRenderbuffer({attachment:a,renderbuffer:I});else if(Array.isArray(E)){const[O,R=0,N=0]=E;I=O,this._attachTexture({attachment:a,texture:O,layer:R,level:N})}else this._attachTexture({attachment:a,texture:I,layer:0,level:0});l&&I&&I.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,f||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(y=>!this.attachments[y]).forEach(y=>{delete this.attachments[y]})}checkStatus(){const e=this.getStatus();if(e!==36053)throw new Error(YI(e));return this}getStatus(){const{gl:e}=this,i=e.bindFramebuffer(36160,this.handle),l=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,i||null),l}clear(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{color:i,depth:l,stencil:u,drawBuffers:f=[]}=e,y=this.gl.bindFramebuffer(36160,this.handle);return(i||l||u)&&Q_(this.gl,{color:i,depth:l,stencil:u}),f.forEach((a,E)=>{UI(this.gl,{drawBuffer:E,value:a})}),this.gl.bindFramebuffer(36160,y||null),this}readPixels(){return Bt.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(){return Bt.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(){return Bt.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(){return Bt.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(){return Bt.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(){return Bt.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate(e){let{attachments:i=[],x:l=0,y:u=0,width:f,height:y}=e;const a=br(this.gl),E=a.bindFramebuffer(36008,this.handle);return l===0&&u===0&&f===void 0&&y===void 0?a.invalidateFramebuffer(36008,i):a.invalidateFramebuffer(36008,i,l,u,f,y),a.bindFramebuffer(36008,E),this}getAttachmentParameter(e,i,l){let u=this._getAttachmentParameterFallback(i);return u===null&&(this.gl.bindFramebuffer(36160,this.handle),u=this.gl.getFramebufferAttachmentParameter(36160,e,i),this.gl.bindFramebuffer(36160,null)),l&&u>1e3&&(u=la(this.gl,u)),u}getAttachmentParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:36064,i=arguments.length>1?arguments[1]:void 0,l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[];const u={};for(const f of l){const y=i?la(this.gl,f):f;u[y]=this.getAttachmentParameter(e,f,i)}return u}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;const i=Object.keys(this.attachments),l={};for(const u of i){const f=Number(u),y=e?la(this.gl,f):f;l[y]=this.getAttachmentParameters(f,e)}return l}show(){return typeof window<"u"&&window.open(o1(this),"luma-debug-texture"),this}log(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";if(e>Bt.level||typeof window>"u")return this;i=i||"Framebuffer ".concat(this.id);const l=o1(this,{targetMaxHeight:100});return Bt.image({logLevel:e,message:i,image:l},i)(),this}bind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,this.handle),this}unbind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,i,l,u,f){let y=null;return e&&(y=y||{},y[36064]=new qr(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:u,height:f,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(y[36064])),i&&l?(y=y||{},y[33306]=new uc(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:u,height:111}),this.ownResources.push(y[33306])):i?(y=y||{},y[36096]=new uc(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:u,height:f}),this.ownResources.push(y[36096])):l&&St(!1),y}_unattach(e){const i=this.attachments[e];!i||(i instanceof uc?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer(e){let{attachment:i=36064,renderbuffer:l}=e;const{gl:u}=this;u.framebufferRenderbuffer(36160,i,36161,l.handle),this.attachments[i]=l}_attachTexture(e){let{attachment:i=36064,texture:l,layer:u,level:f}=e;const{gl:y}=this;switch(y.bindTexture(l.target,l.handle),l.target){case 35866:case 32879:br(y).framebufferTextureLayer(36160,i,l.target,f,u);break;case 34067:const E=XI(u);y.framebufferTexture2D(36160,i,E,l.handle,f);break;case 3553:y.framebufferTexture2D(36160,i,3553,l.handle,f);break;default:St(!1,"Illegal texture type")}y.bindTexture(l.target,null),this.attachments[i]=l}_setReadBuffer(e){const i=EP(this.gl);i?i.readBuffer(e):St(e===36064||e===1029,a1),this.readBuffer=e}_setDrawBuffers(e){const{gl:i}=this,l=br(i);if(l)l.drawBuffers(e);else{const u=i.getExtension("WEBGL_draw_buffers");u?u.drawBuffersWEBGL(e):St(e.length===1&&(e[0]===36064||e[0]===1029),a1)}this.drawBuffers=e}_getAttachmentParameterFallback(e){const i=qI(this.gl);switch(e){case 36052:return i.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return i.WEBGL2?null:8;case 33297:return i.WEBGL2?null:5125;case 33296:return!i.WEBGL2&&!i.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}}function XI(n){return n<34069?n+34069:n}function YI(n){return(En.STATUS||{})[n]||"Framebuffer error ".concat(n)}const KI=[36049,36048,33296,33298,33299,33300,33301,33302,33303];En.ATTACHMENT_PARAMETERS=KI;function JI(n,e){St(n instanceof qr||n instanceof bw||n instanceof zI);const i=n.constructor,{gl:l,width:u,height:f,format:y,type:a,dataFormat:E,border:I,mipmaps:O}=n,R=Object.assign({width:u,height:f,format:y,type:a,dataFormat:E,border:I,mipmaps:O},e);return new i(l,R)}function QI(n,e){const{gl:i,width:l,height:u,id:f}=n;return new En(i,Object.assign({},e,{id:"framebuffer-for-".concat(f),width:l,height:u,attachments:{[36064]:n}}))}function sp(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"unnamed";const i=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,l=n.match(i);return l?l[1]:e}const eC=35632,tC=35633;function iC(n){switch(n){case eC:return"fragment";case tC:return"vertex";default:return"unknown type"}}function nC(n,e,i,l){const u=n.split(/\r?\n/),f={},y={},a=l||sp(e)||"(unnamed)",E="".concat(iC(i)," shader ").concat(a);for(let O=0;O<u.length;O++){const R=u[O];if(R.length<=1)continue;const N=R.split(":"),H=N[0],re=parseInt(N[2],10);if(isNaN(re))throw new Error("GLSL compilation error in ".concat(E,": ").concat(n));H!=="WARNING"?f[re]=R:y[re]=R}const I=rC(e);return{shaderName:E,errors:l1(f,I),warnings:l1(y,I)}}function l1(n,e){let i="";for(let l=0;l<e.length;l++){const u=e[l];if(!(!n[l+3]&&!n[l+2]&&!n[l+1])&&(i+="".concat(u,`
`),n[l+1])){const f=n[l+1],y=f.split(":",3),a=y[0],E=parseInt(y[1],10)||0,I=f.substring(y.join(":").length+1).trim();i+=Aw("^^^ ".concat(a,": ").concat(I,`

`),E)}}return i}function rC(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:": ";const l=n.split(/\r?\n/),u=String(l.length+e-1).length;return l.map((f,y)=>{const a=String(y+e),E=a.length;return Aw(a,u-E)+i+f})}function Aw(n,e){let i="";for(let l=0;l<e;++l)i+=" ";return"".concat(i).concat(n)}function Sw(n){let e=100;const i=n.match(/[^\s]+/g);if(i.length>=2&&i[0]==="#version"){const l=parseInt(i[1],10);Number.isFinite(l)&&(e=l)}return e}const sC="Shader: GLSL source code must be a JavaScript string";class Mh extends zo{get[Symbol.toStringTag](){return"Shader"}static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return St(!1),"unknown"}}constructor(e,i){Bp(e),St(typeof i.source=="string",sC);const l=sp(i.source,null)||i.id||ca("unnamed ".concat(Mh.getTypeName(i.shaderType)));super(e,{id:l}),this.shaderType=i.shaderType,this.source=i.source,this.initialize(i)}initialize(e){let{source:i}=e;const l=sp(i,null);l&&(this.id=ca(l)),this._compile(i)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return"".concat(Mh.getTypeName(this.shaderType),":").concat(this.id)}getName(){return sp(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){const e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.source;if(e.startsWith("#version ")||(e=`#version 100
`.concat(e)),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){const l=this.gl.getShaderInfoLog(this.handle),{shaderName:u,errors:f,warnings:y}=nC(l,this.source,this.shaderType,this.id);throw Bt.error("GLSL compilation errors in ".concat(u,`
`).concat(f))(),Bt.warn("GLSL compilation warnings in ".concat(u,`
`).concat(y))(),new Error("GLSL compilation errors in ".concat(u))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}}class Tg extends Mh{get[Symbol.toStringTag](){return"VertexShader"}constructor(e,i){typeof i=="string"&&(i={source:i}),super(e,Object.assign({},i,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}}class Eg extends Mh{get[Symbol.toStringTag](){return"FragmentShader"}constructor(e,i){typeof i=="string"&&(i={source:i}),super(e,Object.assign({},i,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}}const oC={[5126]:Xi.bind(null,"uniform1fv",Vr,1,lr),[35664]:Xi.bind(null,"uniform2fv",Vr,2,lr),[35665]:Xi.bind(null,"uniform3fv",Vr,3,lr),[35666]:Xi.bind(null,"uniform4fv",Vr,4,lr),[5124]:Xi.bind(null,"uniform1iv",ia,1,lr),[35667]:Xi.bind(null,"uniform2iv",ia,2,lr),[35668]:Xi.bind(null,"uniform3iv",ia,3,lr),[35669]:Xi.bind(null,"uniform4iv",ia,4,lr),[35670]:Xi.bind(null,"uniform1iv",ia,1,lr),[35671]:Xi.bind(null,"uniform2iv",ia,2,lr),[35672]:Xi.bind(null,"uniform3iv",ia,3,lr),[35673]:Xi.bind(null,"uniform4iv",ia,4,lr),[35674]:Xi.bind(null,"uniformMatrix2fv",Vr,4,Mo),[35675]:Xi.bind(null,"uniformMatrix3fv",Vr,9,Mo),[35676]:Xi.bind(null,"uniformMatrix4fv",Vr,16,Mo),[35678]:Yn,[35680]:Yn,[5125]:Xi.bind(null,"uniform1uiv",Bf,1,lr),[36294]:Xi.bind(null,"uniform2uiv",Bf,2,lr),[36295]:Xi.bind(null,"uniform3uiv",Bf,3,lr),[36296]:Xi.bind(null,"uniform4uiv",Bf,4,lr),[35685]:Xi.bind(null,"uniformMatrix2x3fv",Vr,6,Mo),[35686]:Xi.bind(null,"uniformMatrix2x4fv",Vr,8,Mo),[35687]:Xi.bind(null,"uniformMatrix3x2fv",Vr,6,Mo),[35688]:Xi.bind(null,"uniformMatrix3x4fv",Vr,12,Mo),[35689]:Xi.bind(null,"uniformMatrix4x2fv",Vr,8,Mo),[35690]:Xi.bind(null,"uniformMatrix4x3fv",Vr,12,Mo),[35678]:Yn,[35680]:Yn,[35679]:Yn,[35682]:Yn,[36289]:Yn,[36292]:Yn,[36293]:Yn,[36298]:Yn,[36299]:Yn,[36300]:Yn,[36303]:Yn,[36306]:Yn,[36307]:Yn,[36308]:Yn,[36311]:Yn},aC={},lC={},cC={},c1=[0];function ty(n,e,i,l){e===1&&typeof n=="boolean"&&(n=n?1:0),Number.isFinite(n)&&(c1[0]=n,n=c1);const u=n.length;if(u%e&&Bt.warn("Uniform size should be multiples of ".concat(e),n)(),n instanceof i)return n;let f=l[u];f||(f=new i(u),l[u]=f);for(let y=0;y<u;y++)f[y]=n[y];return f}function Vr(n,e){return ty(n,e,Float32Array,aC)}function ia(n,e){return ty(n,e,Int32Array,lC)}function Bf(n,e){return ty(n,e,Uint32Array,cC)}function u1(n,e,i){const l=oC[i.type];if(!l)throw new Error("Unknown GLSL uniform type ".concat(i.type));return l().bind(null,n,e)}function uC(n){if(n[n.length-1]!=="]")return{name:n,length:1,isArray:!1};const e=/([^[]*)(\[[0-9]+\])?/,i=n.match(e);if(!i||i.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(n));return{name:i[1],length:i[2]||1,isArray:Boolean(i[2])}}function hC(n,e,i){for(const l in n){const u=n[l];if((!i||Boolean(i[l]))&&!dC(u))throw e=e?"".concat(e," "):"",console.error("".concat(e," Bad uniform ").concat(l),u),new Error("".concat(e," Bad uniform ").concat(l))}return!0}function dC(n){return Array.isArray(n)||ArrayBuffer.isView(n)?pC(n):isFinite(n)||n===!0||n===!1||n instanceof xc||n instanceof uc?!0:n instanceof En?Boolean(n.texture):!1}function fC(n,e,i){if(Array.isArray(i)||ArrayBuffer.isView(i))if(n[e]){const l=n[e];for(let u=0,f=i.length;u<f;++u)l[u]=i[u]}else n[e]=i.slice();else n[e]=i}function pC(n){if(n.length===0)return!1;const e=Math.min(n.length,16);for(let i=0;i<e;++i)if(!Number.isFinite(n[i]))return!1;return!0}function Yn(){let n=null;return(e,i,l)=>{const u=n!==l;return u&&(e.uniform1i(i,l),n=l),u}}function Xi(n,e,i,l){let u=null,f=null;return(y,a,E)=>{const I=e(E,i),O=I.length;let R=!1;if(u===null)u=new Float32Array(O),f=O,R=!0;else{St(f===O,"Uniform length cannot change.");for(let N=0;N<O;++N)if(I[N]!==u[N]){R=!0;break}}return R&&(l(y,n,a,I),u.set(I)),R}}function lr(n,e,i,l){n[e](i,l)}function Mo(n,e,i,l){n[e](i,!1,l)}const mC=5120,gC=5121,_C=5122,yC=5123,h1=0,Ff=1,xC=2,vC=3,Nf=4,bC=5,wC=6,On=5126,TC=35664,EC=35665,AC=35666,dh=5124,SC=35667,MC=35668,PC=35669,fh=5125,IC=36294,CC=36295,LC=36296,kC=35670,RC=35671,DC=35672,zC=35673,OC=35674,BC=35675,FC=35676,NC=35685,UC=35686,VC=35687,jC=35688,GC=35689,WC=35690,d_={[On]:[On,1,"float"],[TC]:[On,2,"vec2"],[EC]:[On,3,"vec3"],[AC]:[On,4,"vec4"],[dh]:[dh,1,"int"],[SC]:[dh,2,"ivec2"],[MC]:[dh,3,"ivec3"],[PC]:[dh,4,"ivec4"],[fh]:[fh,1,"uint"],[IC]:[fh,2,"uvec2"],[CC]:[fh,3,"uvec3"],[LC]:[fh,4,"uvec4"],[kC]:[On,1,"bool"],[RC]:[On,2,"bvec2"],[DC]:[On,3,"bvec3"],[zC]:[On,4,"bvec4"],[OC]:[On,8,"mat2"],[NC]:[On,8,"mat2x3"],[UC]:[On,8,"mat2x4"],[BC]:[On,12,"mat3"],[VC]:[On,12,"mat3x2"],[jC]:[On,12,"mat3x4"],[FC]:[On,16,"mat4"],[GC]:[On,16,"mat4x2"],[WC]:[On,16,"mat4x3"]};function ZC(n){switch(n){case h1:return h1;case Ff:return Ff;case vC:return Ff;case xC:return Ff;case Nf:return Nf;case bC:return Nf;case wC:return Nf;default:return St(!1),0}}function d1(n){const e=d_[n];if(!e)return null;const[i,l]=e;return{type:i,components:l}}function Mw(n,e){switch(n){case mC:case gC:case _C:case yC:n=On;break}for(const i in d_){const[l,u,f]=d_[i];if(l===n&&u===e)return{glType:i,name:f}}return null}class $C{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){const i=Number(e);return Number.isFinite(i)?this.attributeInfosByLocation[i]:this.attributeInfosByName[e]||null}getAttributeLocation(e){const i=this.getAttributeInfo(e);return i?i.location:-1}getAttributeAccessor(e){const i=this.getAttributeInfo(e);return i?i.accessor:null}getVaryingInfo(e){const i=Number(e);return Number.isFinite(i)?this.varyingInfos[i]:this.varyingInfosByName[e]||null}getVaryingIndex(e){const i=this.getVaryingInfo();return i?i.location:-1}getVaryingAccessor(e){const i=this.getVaryingInfo();return i?i.accessor:null}_readAttributesFromProgram(e){const{gl:i}=e,l=i.getProgramParameter(e.handle,35721);for(let u=0;u<l;u++){const{name:f,type:y,size:a}=i.getActiveAttrib(e.handle,u),E=i.getAttribLocation(e.handle,f);E>=0&&this._addAttribute(E,f,y,a)}this.attributeInfos.sort((u,f)=>u.location-f.location)}_readVaryingsFromProgram(e){const{gl:i}=e;if(!gi(i))return;const l=i.getProgramParameter(e.handle,35971);for(let u=0;u<l;u++){const{name:f,type:y,size:a}=i.getTransformFeedbackVarying(e.handle,u);this._addVarying(u,f,y,a)}this.varyingInfos.sort((u,f)=>u.location-f.location)}_addAttribute(e,i,l,u){const{type:f,components:y}=d1(l),a={type:f,size:u*y};this._inferProperties(e,i,a);const E={location:e,name:i,accessor:new Wr(a)};this.attributeInfos.push(E),this.attributeInfosByLocation[e]=E,this.attributeInfosByName[E.name]=E}_inferProperties(e,i,l){/instance/i.test(i)&&(l.divisor=1)}_addVarying(e,i,l,u){const{type:f,components:y}=d1(l),a=new Wr({type:f,size:u*y}),E={location:e,name:i,accessor:a};this.varyingInfos.push(E),this.varyingInfosByName[E.name]=E}}const f1=4,qC=35981,HC=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"];class Pw extends zo{get[Symbol.toStringTag](){return"Program"}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,i),this.stubRemovedMethods("Program","v6.0",HC),this._isCached=!1,this.initialize(i),Object.seal(this),this._setId(i.id)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{hash:i,vs:l,fs:u,varyings:f,bufferMode:y=qC}=e;return this.hash=i||"",this.vs=typeof l=="string"?new Tg(this.gl,{id:"".concat(e.id,"-vs"),source:l}):l,this.fs=typeof u=="string"?new Eg(this.gl,{id:"".concat(e.id,"-fs"),source:u}):u,St(this.vs instanceof Tg),St(this.fs instanceof Eg),this.uniforms={},this._textureUniforms={},f&&f.length>0&&(br(this.gl),this.varyings=f,this.gl2.transformFeedbackVaryings(this.handle,f,y)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new $C(this),this.setProps(e)}delete(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw(e){let{logPriority:i,drawMode:l=4,vertexCount:u,offset:f=0,start:y,end:a,isIndexed:E=!1,indexType:I=5123,instanceCount:O=0,isInstanced:R=O>0,vertexArray:N=null,transformFeedback:H,framebuffer:re,parameters:ae={},uniforms:be,samplers:De}=e;if((be||De)&&(Bt.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(be||{})),Bt.priority>=i){const Oe=re?re.id:"default",Ce="mode=".concat(la(this.gl,l)," verts=").concat(u," ")+"instances=".concat(O," indexType=").concat(la(this.gl,I)," ")+"isInstanced=".concat(R," isIndexed=").concat(E," ")+"Framebuffer=".concat(Oe);Bt.log(i,Ce)()}return St(N),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||u===0||R&&O===0?!1:(N.bindForDraw(u,O,()=>{if(re!==void 0&&(ae=Object.assign({},ae,{framebuffer:re})),H){const Oe=ZC(l);H.begin(Oe)}this._bindTextures(),gs(this.gl,ae,()=>{E&&R?this.gl2.drawElementsInstanced(l,u,I,f,O):E&&gi(this.gl)&&!isNaN(y)&&!isNaN(a)?this.gl2.drawRangeElements(l,y,a,u,I,f):E?this.gl.drawElements(l,u,I,f):R?this.gl2.drawArraysInstanced(l,f,u,O):this.gl.drawArrays(l,f,u)}),H&&H.end()}),!0)}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Bt.priority>=2&&hC(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(const i in e){const l=e[i],u=this._uniformSetters[i];if(u){let f=l,y=!1;if(f instanceof En&&(f=f.texture),f instanceof xc)if(y=this.uniforms[i]!==l,y){u.textureIndex===void 0&&(u.textureIndex=this._textureIndexCounter++);const a=f,{textureIndex:E}=u;a.bind(E),f=E,this._textureUniforms[i]=a}else f=u.textureIndex;else this._textureUniforms[i]&&delete this._textureUniforms[i];(u(f)||y)&&fC(this.uniforms,i,l)}}return this}_areTexturesRenderable(){let e=!0;for(const i in this._textureUniforms){const l=this._textureUniforms[i];l.update(),e=e&&l.loaded}return e}_bindTextures(){for(const e in this._textureUniforms){const i=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(i)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){const i=this.gl.getAttachedShaders(e),l={};for(const u of i)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:l.vs=new Tg({handle:u});break;case 35632:l.fs=new Eg({handle:u});break}return l}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){const i=this._getName();this.id=ca(i)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?"".concat(e,"-program"):"program",e}_compileAndLink(){const{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),Bt.time(f1,"linkProgram for ".concat(this._getName()))(),e.linkProgram(this.handle),Bt.timeEnd(f1,"linkProgram for ".concat(this._getName()))(),e.debug||Bt.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(e.getProgramInfoLog(this.handle)));if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(e.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){const{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let i=0;i<this._uniformCount;i++){const l=this.gl.getActiveUniform(this.handle,i),{name:u}=uC(l.name);let f=e.getUniformLocation(this.handle,u);if(this._uniformSetters[u]=u1(e,f,l),l.size>1)for(let y=0;y<l.size;y++)f=e.getUniformLocation(this.handle,"".concat(u,"[").concat(y,"]")),this._uniformSetters["".concat(u,"[").concat(y,"]")]=u1(e,f,l)}this._textureIndexCounter=0}getActiveUniforms(e,i){return this.gl2.getActiveUniforms(this.handle,e,i)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,i){return this.gl2.getActiveUniformBlockParameter(this.handle,e,i)}uniformBlockBinding(e,i){this.gl2.uniformBlockBinding(this.handle,e,i)}}const XC=34918,YC=34919,KC=35007,JC=36795,QC=35976,e3=35887,t3=36202;class gp extends zo{get[Symbol.toStringTag](){return"Query"}static isSupported(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];const l=gi(e),u=ey(e,Yi.TIMER_QUERY);let f=l||u;for(const y of i)switch(y){case"queries":f=f&&l;break;case"timers":f=f&&u;break;default:St(!1)}return f}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,i),this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(KC)}beginOcclusionQuery(){let{conservative:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.begin(e?t3:e3)}beginTransformFeedbackQuery(){return this.begin(QC)}begin(e){return this._queryPending?this:(this.target=e,this.gl2.beginQuery(this.target,this.handle),this)}end(){return this._queryPending?this:(this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this)}isResultAvailable(){if(!this._queryPending)return!1;const e=this.gl2.getQueryParameter(this.handle,YC);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.gl2.getParameter(JC)}getResult(){return this.gl2.getQueryParameter(this.handle,XC)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Number.POSITIVE_INFINITY;if(this._pollingPromise)return this._pollingPromise;let i=0;return this._pollingPromise=new Promise((l,u)=>{const f=()=>{this.isResultAvailable()?(l(this.getResult()),this._pollingPromise=null):i++>e?(u("Timed out"),this._pollingPromise=null):requestAnimationFrame(f)};requestAnimationFrame(f)}),this._pollingPromise}_createHandle(){return gp.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}}class Iw extends zo{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(e){return gi(e)}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};br(e),super(e,i),this.initialize(i),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,yc(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.bind(()=>{for(const i in e)this.setBuffer(i,e[i])}),this}setBuffer(e,i){const l=this._getVaryingIndex(e),{buffer:u,byteSize:f,byteOffset:y}=this._getBufferParams(i);return l<0?(this.unused[e]=u,Bt.warn("".concat(this.id," unused varying buffer ").concat(e))(),this):(this.buffers[l]=i,this.bindOnUse||this._bindBuffer(l,u,y,f),this)}begin(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let i,l,u;return e instanceof Ui?u=e:(u=e.buffer,l=e.byteSize,i=e.byteOffset),(i!==void 0||l!==void 0)&&(i=i||0,l=l||u.byteLength-i),{buffer:u,byteOffset:i,byteSize:l}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;const i=Number(e);return Number.isFinite(i)?i:-1}_bindBuffers(){if(this.bindOnUse)for(const e in this.buffers){const{buffer:i,byteSize:l,byteOffset:u}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,i,u,l)}}_unbindBuffers(){if(this.bindOnUse)for(const e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,i){let l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,u=arguments.length>3?arguments[3]:void 0;const f=i&&i.handle;return!f||u===void 0?this.gl.bindBufferBase(35982,e,f):this.gl.bindBufferRange(35982,e,f,l,u),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}}let Uf=null;function i3(n){return(!Uf||Uf.byteLength<n)&&(Uf=new ArrayBuffer(n)),Uf}function n3(n,e){const i=i3(n.BYTES_PER_ELEMENT*e);return new n(i,0,e)}function r3(n){let{target:e,source:i,start:l=0,count:u=1}=n;const f=i.length,y=u*f;let a=0;for(let E=l;a<f;a++)e[E++]=i[a];for(;a<y;)a<y-a?(e.copyWithin(l+a,l,l+a),a*=2):(e.copyWithin(l+a,l,l+y-a),a=y);return e}const s3="elements must be GL.ELEMENT_ARRAY_BUFFER";class jr extends zo{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(e){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).constantAttributeZero?gi(e)||Kb()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new jr(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return jr.MAX_ATTRIBUTES=jr.MAX_ATTRIBUTES||e.getParameter(34921),jr.MAX_ATTRIBUTES}static setConstant(e,i,l){switch(l.constructor){case Float32Array:jr._setConstantFloatArray(e,i,l);break;case Int32Array:jr._setConstantIntArray(e,i,l);break;case Uint32Array:jr._setConstantUintArray(e,i,l);break;default:St(!1)}}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const l=i.id||i.program&&i.program.id;super(e,Object.assign({},i,{id:l})),this.buffer=null,this.bufferValue=null,this.isDefaultArray=i.isDefaultArray||!1,this.gl2=e,this.initialize(i),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return jr.getMaxAttributes(this.gl)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.setProps(e)}setProps(e){return this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return St(!e||e.target===34963,s3),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,i,l){if(i.target===34963)return this.setElementBuffer(i,l);const{size:u,type:f,stride:y,offset:a,normalized:E,integer:I,divisor:O}=l,{gl:R,gl2:N}=this;return e=Number(e),this.bind(()=>{R.bindBuffer(34962,i.handle),I?(St(gi(R)),N.vertexAttribIPointer(e,u,f,y,a)):R.vertexAttribPointer(e,u,f,E,y,a),R.enableVertexAttribArray(e),N.vertexAttribDivisor(e,O||0)}),this}enable(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return!i&&e===0&&!jr.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>i?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,i){const l=this._normalizeConstantArrayValue(i),u=l.byteLength*e,f=l.length*e;let y=!this.buffer;if(this.buffer=this.buffer||new Ui(this.gl,u),y=y||this.buffer.reallocate(u),y=y||!this._compareConstantArrayValues(l,this.bufferValue),y){const a=n3(i.constructor,f);r3({target:a,source:l,start:0,count:f}),this.buffer.subData(a),this.bufferValue=i}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,i){if(!e||!i||e.length!==i.length||e.constructor!==i.constructor)return!1;for(let l=0;l<e.length;++l)if(e[l]!==i[l])return!1;return!0}static _setConstantFloatArray(e,i,l){switch(l.length){case 1:e.vertexAttrib1fv(i,l);break;case 2:e.vertexAttrib2fv(i,l);break;case 3:e.vertexAttrib3fv(i,l);break;case 4:e.vertexAttrib4fv(i,l);break;default:St(!1)}}static _setConstantIntArray(e,i,l){switch(St(gi(e)),l.length){case 1:e.vertexAttribI1iv(i,l);break;case 2:e.vertexAttribI2iv(i,l);break;case 3:e.vertexAttribI3iv(i,l);break;case 4:e.vertexAttribI4iv(i,l);break;default:St(!1)}}static _setConstantUintArray(e,i,l){switch(St(gi(e)),l.length){case 1:e.vertexAttribI1uiv(i,l);break;case 2:e.vertexAttribI2uiv(i,l);break;case 3:e.vertexAttribI3uiv(i,l);break;case 4:e.vertexAttribI4uiv(i,l);break;default:St(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,i){let{location:l}=i;return St(Number.isFinite(l)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(l,e);default:return this.gl.getVertexAttrib(l,e)}})}}const o3="VertexArray: attributes must be Buffers or constants (i.e. typed array)",a3=/^(.+)__LOCATION_([0-9]+)$/,l3=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"];class c3{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const l=i.id||i.program&&i.program.id;this.id=l,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new jr(e),_w(this,"VertexArray","v6.0",l3),this.initialize(i),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;const{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(const i in e){const l=e[i];this._setAttribute(i,l)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return this.elements=e,this.elementsAccessor=i,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,i),this}setBuffer(e,i){let l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(i.target===34963)return this.setElementBuffer(i,l);const{location:u,accessor:f}=this._resolveLocationAndAccessor(e,i,i.accessor,l);return u>=0&&(this.values[u]=i,this.accessors[u]=f,this.clearDrawParams(),this.vertexArrayObject.setBuffer(u,i,f)),this}setConstant(e,i){let l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const{location:u,accessor:f}=this._resolveLocationAndAccessor(e,i,Object.assign({size:i.length},l));return u>=0&&(i=this.vertexArrayObject._normalizeConstantArrayValue(i),this.values[u]=i,this.accessors[u]=f,this.clearDrawParams(),this.vertexArrayObject.enable(u,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new Ui(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof Ui&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){const i=this.values[e];i instanceof Ui&&this.setBuffer(e,i)}}),this}bindForDraw(e,i,l){let u;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,i),u=l()}),u}_resolveLocationAndAccessor(e,i,l,u){const f={location:-1,accessor:null},{location:y,name:a}=this._getAttributeIndex(e);if(!Number.isFinite(y)||y<0)return this.unused[e]=i,Bt.once(3,()=>"unused value ".concat(e," in ").concat(this.id))(),f;const E=this._getAttributeInfo(a||y);if(!E)return f;const I=this.accessors[y]||{},O=Wr.resolve(E.accessor,I,l,u),{size:R,type:N}=O;return St(Number.isFinite(R)&&Number.isFinite(N)),{location:y,accessor:O}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){const i=Number(e);if(Number.isFinite(i))return{location:i};const l=a3.exec(e),u=l?l[1]:e,f=l?Number(l[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(u)+f,name:u}:{location:-1}}_setAttribute(e,i){if(i instanceof Ui)this.setBuffer(e,i);else if(Array.isArray(i)&&i.length&&i[0]instanceof Ui){const l=i[0],u=i[1];this.setBuffer(e,l,u)}else if(ArrayBuffer.isView(i)||Array.isArray(i)){const l=i;this.setConstant(e,l)}else if(i.buffer instanceof Ui){const l=i;this.setBuffer(e,l.buffer,l)}else throw new Error(o3)}_setConstantAttributes(e,i){const l=Math.max(e|0,i|0);let u=this.values[0];ArrayBuffer.isView(u)&&this._setConstantAttributeZero(u,l);for(let f=1;f<this.vertexArrayObject.MAX_ATTRIBUTES;f++)u=this.values[f],ArrayBuffer.isView(u)&&this._setConstantAttribute(f,u)}_setConstantAttributeZero(e,i){if(jr.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}const l=this.vertexArrayObject.getConstantBuffer(i,e);this.vertexArrayObject.setBuffer(0,l,this.accessors[0])}_setConstantAttribute(e,i){jr.setConstant(this.gl,e,i)}_updateDrawParams(){const e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let i=0;i<this.vertexArrayObject.MAX_ATTRIBUTES;i++)this._updateDrawParamsForLocation(e,i);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,i){const l=this.values[i],u=this.accessors[i];if(!l)return;const{divisor:f}=u,y=f>0;if(e.isInstanced=e.isInstanced||y,l instanceof Ui){const a=l;if(y){const E=a.getVertexCount(u);e.instanceCount=Math.min(e.instanceCount,E)}else{const E=a.getVertexCount(u);e.vertexCount=Math.min(e.vertexCount,E)}}}setElements(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return Bt.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,i)}}function u3(n,e){const{maxElts:i=16,size:l=1}=e;let u="[";for(let y=0;y<n.length&&y<i;++y)y>0&&(u+=",".concat(y%l===0?" ":"")),u+=Ph(n[y],e);const f=n.length>i?"...":"]";return"".concat(u).concat(f)}function Ph(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=1e-16,{isInteger:l=!1}=e;if(Array.isArray(n)||ArrayBuffer.isView(n))return u3(n,e);if(!Number.isFinite(n))return String(n);if(Math.abs(n)<i)return l?"0":"0.";if(l||Math.abs(n)>100&&Math.abs(n)<1e4)return n.toFixed(0);const u=n.toPrecision(2);return u.indexOf(".0")===u.length-2?u.slice(0,-1):u}function p1(n){let{header:e="Uniforms",program:i,uniforms:l,undefinedOnly:u=!1}=n;St(i);const f=".*_.*",y=".*Matrix",a=i._uniformSetters,E={},I=Object.keys(a).sort();let O=0;for(const H of I)!H.match(f)&&!H.match(y)&&Ag({table:E,header:e,uniforms:l,uniformName:H,undefinedOnly:u})&&O++;for(const H of I)H.match(y)&&Ag({table:E,header:e,uniforms:l,uniformName:H,undefinedOnly:u})&&O++;for(const H of I)E[H]||Ag({table:E,header:e,uniforms:l,uniformName:H,undefinedOnly:u})&&O++;let R=0;const N={};if(!u)for(const H in l){const re=l[H];E[H]||(R++,N[H]={Type:"NOT USED: ".concat(re),[e]:Ph(re)})}return{table:E,count:O,unusedTable:N,unusedCount:R}}function Ag(n){let{table:e,header:i,uniforms:l,uniformName:u,undefinedOnly:f}=n;const y=l[u],a=h3(y);return!f||!a?(e[u]={[i]:a?Ph(y):"N/A","Uniform Type":a?y:"NOT PROVIDED"},!0):!1}function h3(n){return n!=null}function d3(n){let{vertexArray:e,header:i="Attributes"}=n;if(!e.configuration)return{};const l={};e.elements&&(l.ELEMENT_ARRAY_BUFFER=m1(e,e.elements,null,i));const u=e.values;for(const f in u){const y=e._getAttributeInfo(f);if(y){let a="".concat(f,": ").concat(y.name);const E=e.accessors[y.location];E&&(a="".concat(f,": ").concat(f3(y.name,E))),l[a]=m1(e,u[f],E,i)}}return l}function m1(n,e,i,l){const{gl:u}=n;if(!e)return{[l]:"null","Format ":"N/A"};let f="NOT PROVIDED",y=1,a=0,E=0,I,O,R;if(i&&(f=i.type,y=i.size,f=String(f).replace("Array",""),I=f.indexOf("nt")!==-1),e instanceof Ui){const N=e,{data:H,changed:re}=N.getDebugData();O=re?"*":"",R=H,E=N.byteLength,a=E/H.BYTES_PER_ELEMENT/y;let ae;if(i){const be=i.divisor>0;ae="".concat(be?"I ":"P "," ").concat(a," (x").concat(y,"=").concat(E," bytes ").concat(la(u,f),")")}else I=!0,ae="".concat(E," bytes");return{[l]:"".concat(O).concat(Ph(R,{size:y,isInteger:I})),"Format ":ae}}return R=e,y=e.length,f=String(e.constructor.name).replace("Array",""),I=f.indexOf("nt")!==-1,{[l]:"".concat(Ph(R,{size:y,isInteger:I})," (constant)"),"Format ":"".concat(y,"x").concat(f," (constant)")}}function f3(n,e){const{type:i,size:l}=e,u=Mw(i,l);return u?"".concat(n," (").concat(u.name,")"):n}function p3(n){const e={},i="Accessors for ".concat(n.id);for(const l of n.attributeInfos)if(l){const u=g1(l);e["in ".concat(u)]={[i]:JSON.stringify(l.accessor)}}for(const l of n.varyingInfos)if(l){const u=g1(l);e["out ".concat(u)]={[i]:JSON.stringify(l.accessor)}}return e}function g1(n){const{type:e,size:i}=n.accessor,l=Mw(e,i);return l?"".concat(l.name," ").concat(n.name):n.name}const _1=Do()&&typeof document<"u";let m3=0;class g3{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{onCreateContext:i=be=>gw(be),onAddHTML:l=null,onInitialize:u=()=>{},onRender:f=()=>{},onFinalize:y=()=>{},onError:a,gl:E=null,glOptions:I={},debug:O=!1,createFramebuffer:R=!1,autoResizeViewport:N=!0,autoResizeDrawingBuffer:H=!0,stats:re=Za.get("animation-loop-".concat(m3++))}=e;let{useDevicePixels:ae=!0}=e;"useDevicePixelRatio"in e&&(Bt.deprecated("useDevicePixelRatio","useDevicePixels")(),ae=e.useDevicePixelRatio),this.props={onCreateContext:i,onAddHTML:l,onInitialize:u,onRender:f,onFinalize:y,onError:a,gl:E,glOptions:I,debug:O,createFramebuffer:R},this.gl=E,this.needsRedraw=null,this.timeline=null,this.stats=re,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:N,autoResizeDrawingBuffer:H,useDevicePixels:ae}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(e){return St(typeof e=="string"),this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.autoResizeViewport=e.autoResizeViewport),"autoResizeDrawingBuffer"in e&&(this.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer),"useDevicePixels"in e&&(this.useDevicePixels=e.useDevicePixels),this}start(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this._running)return this;this._running=!0;const i=this._getPageLoadPromise().then(()=>!this._running||this._initialized?null:(this._createWebGLContext(e),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=gp.isSupported(this.gl,["timers"])?new gp(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps))).then(l=>{this._running&&(this._addCallbackData(l||{}),l!==!1&&this._startLoop())});return this.props.onError&&i.catch(this.props.onError),this}redraw(){return this.isContextLost()?this:(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers(),this)}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(){return this.props.onCreateContext(...arguments)}onInitialize(){return this.props.onInitialize(...arguments)}onRender(){return this.props.onRender(...arguments)}onFinalize(){return this.props.onFinalize(...arguments)}getHTMLControlValue(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const l=document.getElementById(e);return l?Number(l.value):i}setViewParameters(){return Bt.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){const e=()=>{!this._running||(this.redraw(),this._animationFrameId=this._requestAnimationFrame(e))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(e)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=_1?new Promise((e,i)=>{if(_1&&document.readyState==="complete"){e(document);return}window.addEventListener("load",()=>{e(document)})}):Promise.resolve({})),this._pageLoadPromise}_setDisplay(e){this.display&&(this.display.delete(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_cancelAnimationFrame(e){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(e):wI(e)}_requestAnimationFrame(e){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(e):bI(e)}_renderFrame(){if(this.display){this.display._renderFrame(...arguments);return}this.onRender(...arguments)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){const{width:e,height:i,aspect:l}=this._getSizeAndAspect();(e!==this.animationProps.width||i!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),l!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=i,this.animationProps.aspect=l,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(e){typeof e=="object"&&e!==null&&(this.animationProps=Object.assign({},this.animationProps,e))}_createWebGLContext(e){if(this.offScreen=e.canvas&&typeof OffscreenCanvas<"u"&&e.canvas instanceof OffscreenCanvas,e=Object.assign({},e,this.props.glOptions),this.gl=this.props.gl?K_(this.props.gl,e):this.onCreateContext(e),!Op(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");lI(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const i=document.createElement("div");i.style.position="absolute",i.style.left="10px",i.style.bottom="10px",i.style.width="300px",i.style.background="white",e.appendChild(this.gl.canvas),e.appendChild(i);const l=this.props.onAddHTML(i);l&&(i.innerHTML=l)}}_getSizeAndAspect(){const e=this.gl.drawingBufferWidth,i=this.gl.drawingBufferHeight;let l=1;const{canvas:u}=this.gl;return u&&u.clientHeight?l=u.clientWidth/u.clientHeight:e>0&&i>0&&(l=e/i),{width:e,height:i,aspect:l}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&fI(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new En(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){const{canvas:e}=this.gl;e&&(e.addEventListener("mousemove",this._onMousemove),e.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(e){this.animationProps._mousePosition=[e.offsetX,e.offsetY]}_onMouseleave(e){this.animationProps._mousePosition=null}}const $h="vs",iy="fs";function $r(n,e){if(!n)throw new Error(e||"shadertools: assertion failed.")}const Sg={number:{validate(n,e){return Number.isFinite(n)&&(!("max"in e)||n<=e.max)&&(!("min"in e)||n>=e.min)}},array:{validate(n,e){return Array.isArray(n)||ArrayBuffer.isView(n)}}};function _3(n){const e={};for(const i in n){const l=n[i],u=y3(l);e[i]=u}return e}function y3(n){let e=y1(n);return e==="object"?n?"type"in n?Object.assign({},n,Sg[n.type]):"value"in n?(e=y1(n.value),Object.assign({type:e},n,Sg[e])):{type:"object",value:n}:{type:"object",value:null}:Object.assign({type:e,value:n},Sg[e])}function y1(n){return Array.isArray(n)||ArrayBuffer.isView(n)?"array":typeof n}const x3="vs",v3="fs";class x1{constructor(e){let{name:i,vs:l,fs:u,dependencies:f=[],uniforms:y,getUniforms:a,deprecations:E=[],defines:I={},inject:O={},vertexShader:R,fragmentShader:N}=e;$r(typeof i=="string"),this.name=i,this.vs=l||R,this.fs=u||N,this.getModuleUniforms=a,this.dependencies=f,this.deprecations=this._parseDeprecationDefinitions(E),this.defines=I,this.injections=b3(O),y&&(this.uniforms=_3(y))}getModuleSource(e){let i;switch(e){case x3:i=this.vs||"";break;case v3:i=this.fs||"";break;default:$r(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),`
`).concat(i,"// END MODULE_").concat(this.name,`

`)}getUniforms(e,i){return this.getModuleUniforms?this.getModuleUniforms(e,i):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,i){this.deprecations.forEach(l=>{l.regex.test(e)&&(l.deprecated?i.deprecated(l.old,l.new)():i.removed(l.old,l.new)())})}_parseDeprecationDefinitions(e){return e.forEach(i=>{switch(i.type){case"function":i.regex=new RegExp("\\b".concat(i.old,"\\("));break;default:i.regex=new RegExp("".concat(i.type," ").concat(i.old,";"))}}),e}_defaultGetUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const i={},l=this.uniforms;for(const u in l){const f=l[u];u in e&&!f.private?(f.validate&&$r(f.validate(e[u],f),"".concat(this.name,": invalid ").concat(u)),i[u]=e[u]):i[u]=f.value}return i}}function b3(n){const e={vs:{},fs:{}};for(const i in n){let l=n[i];const u=i.slice(0,2);typeof l=="string"&&(l={order:0,injection:l}),e[u][i]=l}return e}function w3(n){return T3(Lw(n))}function T3(n){const e={},i={};return Cw({modules:n,level:0,moduleMap:e,moduleDepth:i}),Object.keys(i).sort((l,u)=>i[u]-i[l]).map(l=>e[l])}function Cw(n){let{modules:e,level:i,moduleMap:l,moduleDepth:u}=n;if(i>=5)throw new Error("Possible loop in shader dependency graph");for(const f of e)l[f.name]=f,(u[f.name]===void 0||u[f.name]<i)&&(u[f.name]=i);for(const f of e)f.dependencies&&Cw({modules:f.dependencies,level:i+1,moduleMap:l,moduleDepth:u})}function Lw(n,e){return n.map(i=>(i instanceof x1||($r(typeof i!="string","Shader module use by name is deprecated. Import shader module '".concat(i,"' and use it directly.")),$r(i.name,"shader module has no name"),i=new x1(i),i.dependencies=Lw(i.dependencies)),i))}function E3(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=typeof window<"u"?window.navigator||{}:{},i=n.userAgent||e.userAgent||"",l=i.indexOf("MSIE ")!==-1,u=i.indexOf("Trident/")!==-1;return l||u}const A3=7936,S3=7937,M3=7938,P3=35724,ny={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},Wa={};Object.keys(ny).forEach(n=>{Wa[n]=n});function I3(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&n._version===2)}function C3(n){const e=n.getExtension("WEBGL_debug_renderer_info"),i=n.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||A3),l=n.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||S3);return{gpuVendor:L3(i,l),vendor:i,renderer:l,version:n.getParameter(M3),shadingLanguageVersion:n.getParameter(P3)}}function L3(n,e){return n.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":n.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":n.match(/AMD/i)||e.match(/AMD/i)||n.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}const Mg={};function v1(n,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const l=ny[e];if($r(l,e),!E3(i))return!0;if(e in Mg)return Mg[e];const u=l[0],f=i.behavior||"enable",y="#extension GL_".concat(u," : ").concat(f,`
void main(void) {}`),a=n.createShader(35633);n.shaderSource(a,y),n.compileShader(a);const E=n.getShaderParameter(a,35713);return n.deleteShader(a),Mg[e]=E,E}function k3(n,e){const i=ny[e];$r(i,e);const l=I3(n)&&i[1]||i[0],u=typeof l=="string"?Boolean(n.getExtension(l)):l;return $r(u===!1||u===!0),u}function Vf(n,e){return e=Array.isArray(e)?e:[e],e.every(i=>k3(n,i))}function R3(n){switch(C3(n).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function D3(n,e,i){let l=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return Vf(n,Wa.GLSL_FRAG_DEPTH)&&(l+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),Vf(n,Wa.GLSL_DERIVATIVES)&&v1(n,Wa.GLSL_DERIVATIVES)&&(l+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),Vf(n,Wa.GLSL_FRAG_DATA)&&v1(n,Wa.GLSL_FRAG_DATA,{behavior:"require"})&&(l+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),Vf(n,Wa.GLSL_TEXTURE_LOD)&&(l+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),l}const z3=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,O3=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,B3={[$h]:z3,[iy]:O3},op="__LUMA_INJECT_DECLARATIONS__",b1=/void\s+main\s*\([^)]*\)\s*\{\n?/,w1=/}\n?[^{}]*$/,Pg=[];function T1(n,e,i){let l=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const u=e===$h;for(const f in i){const y=i[f];y.sort((E,I)=>E.order-I.order),Pg.length=y.length;for(let E=0,I=y.length;E<I;++E)Pg[E]=y[E].injection;const a="".concat(Pg.join(`
`),`
`);switch(f){case"vs:#decl":u&&(n=n.replace(op,a));break;case"vs:#main-start":u&&(n=n.replace(b1,E=>E+a));break;case"vs:#main-end":u&&(n=n.replace(w1,E=>a+E));break;case"fs:#decl":u||(n=n.replace(op,a));break;case"fs:#main-start":u||(n=n.replace(b1,E=>E+a));break;case"fs:#main-end":u||(n=n.replace(w1,E=>a+E));break;default:n=n.replace(f,E=>E+a)}}return n=n.replace(op,""),l&&(n=n.replace(/\}\s*$/,f=>f+B3[e])),n}function f_(n){const e={};return $r(Array.isArray(n)&&n.length>1),n.forEach(i=>{for(const l in i)e[l]=e[l]?"".concat(e[l],`
`).concat(i[l]):i[l]}),e}function vc(n){return new RegExp("\\b".concat(n,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}const kw=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],F3=[...kw,[vc("attribute"),"in $1"],[vc("varying"),"out $1"]],N3=[...kw,[vc("varying"),"in $1"]],Rw=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],U3=[...Rw,[vc("in"),"attribute $1"],[vc("out"),"varying $1"]],V3=[...Rw,[vc("in"),"varying $1"]],p_="gl_FragColor",m_=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,j3=/void\s+main\s*\([^)]*\)\s*\{\n?/;function G3(n,e,i){switch(e){case 300:return i?_p(n,F3):W3(n);case 100:return i?_p(n,U3):Z3(n);default:throw new Error("unknown GLSL version ".concat(e))}}function _p(n,e){for(const[i,l]of e)n=n.replace(i,l);return n}function W3(n){n=_p(n,N3);const e=n.match(m_);if(e){const i=e[1];n=n.replace(new RegExp("\\b".concat(p_,"\\b"),"g"),i)}else{const i="fragmentColor";n=n.replace(j3,l=>"out vec4 ".concat(i,`;
`).concat(l)).replace(new RegExp("\\b".concat(p_,"\\b"),"g"),i)}return n}function Z3(n){n=_p(n,V3);const e=n.match(m_);if(e){const i=e[1];n=n.replace(m_,"").replace(new RegExp("\\b".concat(i,"\\b"),"g"),p_)}return n}const $3=`

`.concat(op,`

`),Dw={[$h]:"vertex",[iy]:"fragment"},q3=`precision highp float;

`;function H3(n,e){const{vs:i,fs:l}=e,u=w3(e.modules||[]);return{gl:n,vs:E1(n,Object.assign({},e,{source:i,type:$h,modules:u})),fs:E1(n,Object.assign({},e,{source:l,type:iy,modules:u})),getUniforms:X3(u)}}function E1(n,e){let{id:i,source:l,type:u,modules:f,defines:y={},hookFunctions:a=[],inject:E={},transpileToGLSL100:I=!1,prologue:O=!0,log:R}=e;$r(typeof l=="string","shader source must be a string");const N=u===$h,H=l.split(`
`);let re=100,ae="",be=l;H[0].indexOf("#version ")===0?(re=300,ae=H[0],be=H.slice(1).join(`
`)):ae="#version ".concat(re);const De={};f.forEach(wt=>{Object.assign(De,wt.getDefines())}),Object.assign(De,y);let Oe=O?"".concat(ae,`
`).concat(K3({id:i,source:l,type:u}),`
`).concat(Y3({type:u}),`
`).concat(R3(n),`
`).concat(D3(n),`
`).concat(J3(De),`
`).concat(N?"":q3,`
`):"".concat(ae,`
`);const Ce=eL(a),Ve={},Ee={},dt={};for(const wt in E){const kt=typeof E[wt]=="string"?{injection:E[wt],order:0}:E[wt],et=wt.match(/^(v|f)s:(#)?([\w-]+)$/);if(et){const Tt=et[2],ut=et[3];Tt?ut==="decl"?Ee[wt]=[kt]:dt[wt]=[kt]:Ve[wt]=[kt]}else dt[wt]=[kt]}for(const wt of f){R&&wt.checkDeprecations(be,R);const kt=wt.getModuleSource(u,re);Oe+=kt;const et=wt.injections[u];for(const Tt in et){const ut=Tt.match(/^(v|f)s:#([\w-]+)$/);if(ut){const ti=ut[2]==="decl"?Ee:dt;ti[Tt]=ti[Tt]||[],ti[Tt].push(et[Tt])}else Ve[Tt]=Ve[Tt]||[],Ve[Tt].push(et[Tt])}}return Oe+=$3,Oe=T1(Oe,u,Ee),Oe+=Q3(Ce[u],Ve),Oe+=be,Oe=T1(Oe,u,dt),Oe=G3(Oe,I?100:re,N),Oe}function X3(n){return function(i){const l={};for(const u of n){const f=u.getUniforms(i,l);Object.assign(l,f)}return l}}function Y3(n){let{type:e}=n;return`
#define SHADER_TYPE_`.concat(Dw[e].toUpperCase(),`
`)}function K3(n){let{id:e,source:i,type:l}=n;return e&&typeof e=="string"&&i.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME `.concat(e,"_").concat(Dw[l],`

`):""}function J3(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=0,i="";for(const l in n){e===0&&(i+=`
// APPLICATION DEFINES
`),e++;const u=n[l];(u||Number.isFinite(u))&&(i+="#define ".concat(l.toUpperCase()," ").concat(n[l],`
`))}return e===0&&(i+=`
`),i}function Q3(n,e){let i="";for(const l in n){const u=n[l];if(i+="void ".concat(u.signature,` {
`),u.header&&(i+="  ".concat(u.header)),e[l]){const f=e[l];f.sort((y,a)=>y.order-a.order);for(const y of f)i+="  ".concat(y.injection,`
`)}u.footer&&(i+="  ".concat(u.footer)),i+=`}
`}return i}function eL(n){const e={vs:{},fs:{}};return n.forEach(i=>{let l;typeof i!="string"?(l=i,i=l.hook):l={},i=i.trim();const[u,f]=i.split(":"),y=i.replace(/\(.+/,"");e[u][y]=Object.assign(l,{signature:f})}),e}const tL="void main() {gl_FragColor = vec4(0);}",zw=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,iL=`#version 300 es
`.concat(zw);function Ow(n,e){e=Array.isArray(e)?e:[e];const i=n.replace(/^\s+/,"").split(/\s+/),[l,u,f]=i;if(!e.includes(l)||!u||!f)return null;const y=f.split(";")[0];return{qualifier:l,type:u,name:y}}function Bw(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{version:e=100,input:i,inputType:l,output:u}=n;if(!i)return e===300?iL:e>300?"#version ".concat(e,`
`).concat(zw):tL;const f=sL(i,l);return e>=300?"#version ".concat(e," ").concat(e===300?"es":"",`
in `).concat(l," ").concat(i,`;
out vec4 `).concat(u,`;
void main() {
  `).concat(u," = ").concat(f,`;
}`):"varying ".concat(l," ").concat(i,`;
void main() {
  gl_FragColor = `).concat(f,`;
}`)}function nL(n){switch(n){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return $r(!1),null}}function rL(n){switch(n){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return $r(!1),null}}function sL(n,e){switch(e){case"float":return"vec4(".concat(n,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(n,", 0.0, 1.0)");case"vec3":return"vec4(".concat(n,", 1.0)");case"vec4":return n;default:return $r(!1),null}}const oL=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,aL={name:"fp32",vs:oL,fs:null};function A1(n,e){if(!n)throw new Error("math.gl assertion ".concat(e))}const Zr={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function lL(n,{precision:e=Zr.precision}={}){return n=cL(n),"".concat(parseFloat(n.toPrecision(e)))}function bc(n){return Array.isArray(n)||ArrayBuffer.isView(n)&&!(n instanceof DataView)}function Kn(n,e,i){return hL(n,l=>Math.max(e,Math.min(i,l)))}function yp(n,e,i){return bc(n)?n.map((l,u)=>yp(l,e[u],i)):i*e+(1-i)*n}function wc(n,e,i){const l=Zr.EPSILON;i&&(Zr.EPSILON=i);try{if(n===e)return!0;if(bc(n)&&bc(e)){if(n.length!==e.length)return!1;for(let u=0;u<n.length;++u)if(!wc(n[u],e[u]))return!1;return!0}return n&&n.equals?n.equals(e):e&&e.equals?e.equals(n):typeof n=="number"&&typeof e=="number"?Math.abs(n-e)<=Zr.EPSILON*Math.max(1,Math.abs(n),Math.abs(e)):!1}finally{Zr.EPSILON=l}}function cL(n){return Math.round(n/Zr.EPSILON)*Zr.EPSILON}function uL(n){return n.clone?n.clone():new Array(n.length)}function hL(n,e,i){if(bc(n)){const l=n;i=i||uL(l);for(let u=0;u<i.length&&u<l.length;++u)i[u]=e(n[u],u,i);return i}return e(n)}function dL(n){function e(){var i=Reflect.construct(n,Array.from(arguments));return Object.setPrototypeOf(i,Object.getPrototypeOf(this)),i}return e.prototype=Object.create(n.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n,e}class Fw extends dL(Array){clone(){return new this.constructor().copy(this)}fromArray(e,i=0){for(let l=0;l<this.ELEMENTS;++l)this[l]=e[l+i];return this.check()}toArray(e=[],i=0){for(let l=0;l<this.ELEMENTS;++l)e[i+l]=this[l];return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:bc(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Zr)}formatString(e){let i="";for(let l=0;l<this.ELEMENTS;++l)i+=(l>0?", ":"")+lL(this[l],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(i,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let i=0;i<this.ELEMENTS;++i)if(!wc(this[i],e[i]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let i=0;i<this.ELEMENTS;++i)if(this[i]!==e[i])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,i,l){if(l===void 0)return this.lerp(this,e,i);for(let u=0;u<this.ELEMENTS;++u){const f=e[u];this[u]=f+l*(i[u]-f)}return this.check()}min(e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(e[i],this[i]);return this.check()}max(e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.max(e[i],this[i]);return this.check()}clamp(e,i){for(let l=0;l<this.ELEMENTS;++l)this[l]=Math.min(Math.max(this[l],e[l]),i[l]);return this.check()}add(...e){for(const i of e)for(let l=0;l<this.ELEMENTS;++l)this[l]+=i[l];return this.check()}subtract(...e){for(const i of e)for(let l=0;l<this.ELEMENTS;++l)this[l]-=i[l];return this.check()}scale(e){if(typeof e=="number")for(let i=0;i<this.ELEMENTS;++i)this[i]*=e;else for(let i=0;i<this.ELEMENTS&&i<e.length;++i)this[i]*=e[i];return this.check()}multiplyByScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]*=e;return this.check()}check(){if(Zr.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let i=0;i<this.ELEMENTS;++i)e=e&&Number.isFinite(this[i]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]=e;return this.check()}addScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,i){for(let l=0;l<this.ELEMENTS;++l)this[l]=Math.min(Math.max(this[l],e),i);return this.check()}get elements(){return this}}function fL(n,e){if(n.length!==e)return!1;for(let i=0;i<n.length;++i)if(!Number.isFinite(n[i]))return!1;return!0}function Gr(n){if(!Number.isFinite(n))throw new Error("Invalid number ".concat(n));return n}function Ig(n,e,i=""){if(Zr.debug&&!fL(n,e))throw new Error("math.gl: ".concat(i," some fields set to invalid numbers'"));return n}class pL extends Fw{get x(){return this[0]}set x(e){this[0]=Gr(e)}get y(){return this[1]}set y(e){this[1]=Gr(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let i=0;i<this.ELEMENTS;++i)e+=this[i]*this[i];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let i=0;for(let l=0;l<this.ELEMENTS;++l){const u=this[l]-e[l];i+=u*u}return Gr(i)}dot(e){let i=0;for(let l=0;l<this.ELEMENTS;++l)i+=this[l]*e[l];return Gr(i)}normalize(){const e=this.magnitude();if(e!==0)for(let i=0;i<this.ELEMENTS;++i)this[i]/=e;return this.check()}multiply(...e){for(const i of e)for(let l=0;l<this.ELEMENTS;++l)this[l]*=i[l];return this.check()}divide(...e){for(const i of e)for(let l=0;l<this.ELEMENTS;++l)this[l]/=i[l];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return A1(e>=0&&e<this.ELEMENTS,"index is out of range"),Gr(this[e])}setComponent(e,i){return A1(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=i,this.check()}addVectors(e,i){return this.copy(e).add(i)}subVectors(e,i){return this.copy(e).subtract(i)}multiplyVectors(e,i){return this.copy(e).multiply(i)}addScaledVector(e,i){return this.add(new this.constructor(e).multiplyScalar(i))}}var ap=1e-6,Tc=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});function mL(){var n=new Tc(2);return Tc!=Float32Array&&(n[0]=0,n[1]=0),n}function xp(n,e,i){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n}function Nw(n,e){return n[0]=-e[0],n[1]=-e[1],n}function Uw(n,e,i,l){var u=e[0],f=e[1];return n[0]=u+l*(i[0]-u),n[1]=f+l*(i[1]-f),n}function gL(n,e,i){var l=e[0],u=e[1];return n[0]=i[0]*l+i[4]*u+i[12],n[1]=i[1]*l+i[5]*u+i[13],n}(function(){var n=mL();return function(e,i,l,u,f,y){var a,E;for(i||(i=2),l||(l=0),u?E=Math.min(u*i+l,e.length):E=e.length,a=l;a<E;a+=i)n[0]=e[a],n[1]=e[a+1],f(n,n,y),e[a]=n[0],e[a+1]=n[1];return e}})();function _L(n,e,i){const l=e[0],u=e[1],f=i[3]*l+i[7]*u||1;return n[0]=(i[0]*l+i[4]*u)/f,n[1]=(i[1]*l+i[5]*u)/f,n}function Vw(n,e,i){const l=e[0],u=e[1],f=e[2],y=i[3]*l+i[7]*u+i[11]*f||1;return n[0]=(i[0]*l+i[4]*u+i[8]*f)/y,n[1]=(i[1]*l+i[5]*u+i[9]*f)/y,n[2]=(i[2]*l+i[6]*u+i[10]*f)/y,n}function yL(n,e,i){const l=e[0],u=e[1];return n[0]=i[0]*l+i[2]*u,n[1]=i[1]*l+i[3]*u,n[2]=e[2],n}function xL(){var n=new Tc(3);return Tc!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function vL(n,e,i){return n[0]=e[0]-i[0],n[1]=e[1]-i[1],n[2]=e[2]-i[2],n}function bL(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function wL(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function TL(n,e,i){var l=e[0],u=e[1],f=e[2],y=i[0],a=i[1],E=i[2];return n[0]=u*E-f*a,n[1]=f*y-l*E,n[2]=l*a-u*y,n}function jw(n,e,i){var l=e[0],u=e[1],f=e[2],y=i[3]*l+i[7]*u+i[11]*f+i[15];return y=y||1,n[0]=(i[0]*l+i[4]*u+i[8]*f+i[12])/y,n[1]=(i[1]*l+i[5]*u+i[9]*f+i[13])/y,n[2]=(i[2]*l+i[6]*u+i[10]*f+i[14])/y,n}function EL(n,e,i){var l=e[0],u=e[1],f=e[2];return n[0]=l*i[0]+u*i[3]+f*i[6],n[1]=l*i[1]+u*i[4]+f*i[7],n[2]=l*i[2]+u*i[5]+f*i[8],n}function AL(n,e,i){var l=i[0],u=i[1],f=i[2],y=i[3],a=e[0],E=e[1],I=e[2],O=u*I-f*E,R=f*a-l*I,N=l*E-u*a,H=u*N-f*R,re=f*O-l*N,ae=l*R-u*O,be=y*2;return O*=be,R*=be,N*=be,H*=2,re*=2,ae*=2,n[0]=a+O+H,n[1]=E+R+re,n[2]=I+N+ae,n}function SL(n,e,i,l){var u=[],f=[];return u[0]=e[0]-i[0],u[1]=e[1]-i[1],u[2]=e[2]-i[2],f[0]=u[0],f[1]=u[1]*Math.cos(l)-u[2]*Math.sin(l),f[2]=u[1]*Math.sin(l)+u[2]*Math.cos(l),n[0]=f[0]+i[0],n[1]=f[1]+i[1],n[2]=f[2]+i[2],n}function ML(n,e,i,l){var u=[],f=[];return u[0]=e[0]-i[0],u[1]=e[1]-i[1],u[2]=e[2]-i[2],f[0]=u[2]*Math.sin(l)+u[0]*Math.cos(l),f[1]=u[1],f[2]=u[2]*Math.cos(l)-u[0]*Math.sin(l),n[0]=f[0]+i[0],n[1]=f[1]+i[1],n[2]=f[2]+i[2],n}function PL(n,e,i,l){var u=[],f=[];return u[0]=e[0]-i[0],u[1]=e[1]-i[1],u[2]=e[2]-i[2],f[0]=u[0]*Math.cos(l)-u[1]*Math.sin(l),f[1]=u[0]*Math.sin(l)+u[1]*Math.cos(l),f[2]=u[2],n[0]=f[0]+i[0],n[1]=f[1]+i[1],n[2]=f[2]+i[2],n}function IL(n,e){var i=n[0],l=n[1],u=n[2],f=e[0],y=e[1],a=e[2],E=Math.sqrt(i*i+l*l+u*u),I=Math.sqrt(f*f+y*y+a*a),O=E*I,R=O&&wL(n,e)/O;return Math.acos(Math.min(Math.max(R,-1),1))}var CL=vL;(function(){var n=xL();return function(e,i,l,u,f,y){var a,E;for(i||(i=3),l||(l=0),u?E=Math.min(u*i+l,e.length):E=e.length,a=l;a<E;a+=i)n[0]=e[a],n[1]=e[a+1],n[2]=e[a+2],f(n,n,y),e[a]=n[0],e[a+1]=n[1],e[a+2]=n[2];return e}})();const Cg=[0,0,0];let jf;class co extends pL{static get ZERO(){return jf||(jf=new co(0,0,0),Object.freeze(jf)),jf}constructor(e=0,i=0,l=0){super(-0,-0,-0),arguments.length===1&&bc(e)?this.copy(e):(Zr.debug&&(Gr(e),Gr(i),Gr(l)),this[0]=e,this[1]=i,this[2]=l)}set(e,i,l){return this[0]=e,this[1]=i,this[2]=l,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Zr.debug&&(Gr(e.x),Gr(e.y),Gr(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Gr(e)}angle(e){return IL(this,e)}cross(e){return TL(this,this,e),this.check()}rotateX({radians:e,origin:i=Cg}){return SL(this,this,i,e),this.check()}rotateY({radians:e,origin:i=Cg}){return ML(this,this,i,e),this.check()}rotateZ({radians:e,origin:i=Cg}){return PL(this,this,i,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return jw(this,this,e),this.check()}transformAsVector(e){return Vw(this,this,e),this.check()}transformByMatrix3(e){return EL(this,this,e),this.check()}transformByMatrix2(e){return yL(this,this,e),this.check()}transformByQuaternion(e){return AL(this,this,e),this.check()}}class LL extends Fw{toString(){let e="[";if(Zr.printRowMajor){e+="row-major:";for(let i=0;i<this.RANK;++i)for(let l=0;l<this.RANK;++l)e+=" ".concat(this[l*this.RANK+i])}else{e+="column-major:";for(let i=0;i<this.ELEMENTS;++i)e+=" ".concat(this[i])}return e+="]",e}getElementIndex(e,i){return i*this.RANK+e}getElement(e,i){return this[i*this.RANK+e]}setElement(e,i,l){return this[i*this.RANK+e]=Gr(l),this}getColumn(e,i=new Array(this.RANK).fill(-0)){const l=e*this.RANK;for(let u=0;u<this.RANK;++u)i[u]=this[l+u];return i}setColumn(e,i){const l=e*this.RANK;for(let u=0;u<this.RANK;++u)this[l+u]=i[u];return this}}function kL(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function RL(n,e){if(n===e){var i=e[1],l=e[2],u=e[3],f=e[6],y=e[7],a=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=i,n[6]=e[9],n[7]=e[13],n[8]=l,n[9]=f,n[11]=e[14],n[12]=u,n[13]=y,n[14]=a}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function g_(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],y=e[4],a=e[5],E=e[6],I=e[7],O=e[8],R=e[9],N=e[10],H=e[11],re=e[12],ae=e[13],be=e[14],De=e[15],Oe=i*a-l*y,Ce=i*E-u*y,Ve=i*I-f*y,Ee=l*E-u*a,dt=l*I-f*a,wt=u*I-f*E,kt=O*ae-R*re,et=O*be-N*re,Tt=O*De-H*re,ut=R*be-N*ae,si=R*De-H*ae,ti=N*De-H*be,Zt=Oe*ti-Ce*si+Ve*ut+Ee*Tt-dt*et+wt*kt;return Zt?(Zt=1/Zt,n[0]=(a*ti-E*si+I*ut)*Zt,n[1]=(u*si-l*ti-f*ut)*Zt,n[2]=(ae*wt-be*dt+De*Ee)*Zt,n[3]=(N*dt-R*wt-H*Ee)*Zt,n[4]=(E*Tt-y*ti-I*et)*Zt,n[5]=(i*ti-u*Tt+f*et)*Zt,n[6]=(be*Ve-re*wt-De*Ce)*Zt,n[7]=(O*wt-N*Ve+H*Ce)*Zt,n[8]=(y*si-a*Tt+I*kt)*Zt,n[9]=(l*Tt-i*si-f*kt)*Zt,n[10]=(re*dt-ae*Ve+De*Oe)*Zt,n[11]=(R*Ve-O*dt-H*Oe)*Zt,n[12]=(a*et-y*ut-E*kt)*Zt,n[13]=(i*ut-l*et+u*kt)*Zt,n[14]=(ae*Ce-re*Ee-be*Oe)*Zt,n[15]=(O*Ee-R*Ce+N*Oe)*Zt,n):null}function DL(n){var e=n[0],i=n[1],l=n[2],u=n[3],f=n[4],y=n[5],a=n[6],E=n[7],I=n[8],O=n[9],R=n[10],N=n[11],H=n[12],re=n[13],ae=n[14],be=n[15],De=e*y-i*f,Oe=e*a-l*f,Ce=e*E-u*f,Ve=i*a-l*y,Ee=i*E-u*y,dt=l*E-u*a,wt=I*re-O*H,kt=I*ae-R*H,et=I*be-N*H,Tt=O*ae-R*re,ut=O*be-N*re,si=R*be-N*ae;return De*si-Oe*ut+Ce*Tt+Ve*et-Ee*kt+dt*wt}function qa(n,e,i){var l=e[0],u=e[1],f=e[2],y=e[3],a=e[4],E=e[5],I=e[6],O=e[7],R=e[8],N=e[9],H=e[10],re=e[11],ae=e[12],be=e[13],De=e[14],Oe=e[15],Ce=i[0],Ve=i[1],Ee=i[2],dt=i[3];return n[0]=Ce*l+Ve*a+Ee*R+dt*ae,n[1]=Ce*u+Ve*E+Ee*N+dt*be,n[2]=Ce*f+Ve*I+Ee*H+dt*De,n[3]=Ce*y+Ve*O+Ee*re+dt*Oe,Ce=i[4],Ve=i[5],Ee=i[6],dt=i[7],n[4]=Ce*l+Ve*a+Ee*R+dt*ae,n[5]=Ce*u+Ve*E+Ee*N+dt*be,n[6]=Ce*f+Ve*I+Ee*H+dt*De,n[7]=Ce*y+Ve*O+Ee*re+dt*Oe,Ce=i[8],Ve=i[9],Ee=i[10],dt=i[11],n[8]=Ce*l+Ve*a+Ee*R+dt*ae,n[9]=Ce*u+Ve*E+Ee*N+dt*be,n[10]=Ce*f+Ve*I+Ee*H+dt*De,n[11]=Ce*y+Ve*O+Ee*re+dt*Oe,Ce=i[12],Ve=i[13],Ee=i[14],dt=i[15],n[12]=Ce*l+Ve*a+Ee*R+dt*ae,n[13]=Ce*u+Ve*E+Ee*N+dt*be,n[14]=Ce*f+Ve*I+Ee*H+dt*De,n[15]=Ce*y+Ve*O+Ee*re+dt*Oe,n}function vp(n,e,i){var l=i[0],u=i[1],f=i[2],y,a,E,I,O,R,N,H,re,ae,be,De;return e===n?(n[12]=e[0]*l+e[4]*u+e[8]*f+e[12],n[13]=e[1]*l+e[5]*u+e[9]*f+e[13],n[14]=e[2]*l+e[6]*u+e[10]*f+e[14],n[15]=e[3]*l+e[7]*u+e[11]*f+e[15]):(y=e[0],a=e[1],E=e[2],I=e[3],O=e[4],R=e[5],N=e[6],H=e[7],re=e[8],ae=e[9],be=e[10],De=e[11],n[0]=y,n[1]=a,n[2]=E,n[3]=I,n[4]=O,n[5]=R,n[6]=N,n[7]=H,n[8]=re,n[9]=ae,n[10]=be,n[11]=De,n[12]=y*l+O*u+re*f+e[12],n[13]=a*l+R*u+ae*f+e[13],n[14]=E*l+N*u+be*f+e[14],n[15]=I*l+H*u+De*f+e[15]),n}function ry(n,e,i){var l=i[0],u=i[1],f=i[2];return n[0]=e[0]*l,n[1]=e[1]*l,n[2]=e[2]*l,n[3]=e[3]*l,n[4]=e[4]*u,n[5]=e[5]*u,n[6]=e[6]*u,n[7]=e[7]*u,n[8]=e[8]*f,n[9]=e[9]*f,n[10]=e[10]*f,n[11]=e[11]*f,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function zL(n,e,i,l){var u=l[0],f=l[1],y=l[2],a=Math.hypot(u,f,y),E,I,O,R,N,H,re,ae,be,De,Oe,Ce,Ve,Ee,dt,wt,kt,et,Tt,ut,si,ti,Zt,Lt;return a<ap?null:(a=1/a,u*=a,f*=a,y*=a,E=Math.sin(i),I=Math.cos(i),O=1-I,R=e[0],N=e[1],H=e[2],re=e[3],ae=e[4],be=e[5],De=e[6],Oe=e[7],Ce=e[8],Ve=e[9],Ee=e[10],dt=e[11],wt=u*u*O+I,kt=f*u*O+y*E,et=y*u*O-f*E,Tt=u*f*O-y*E,ut=f*f*O+I,si=y*f*O+u*E,ti=u*y*O+f*E,Zt=f*y*O-u*E,Lt=y*y*O+I,n[0]=R*wt+ae*kt+Ce*et,n[1]=N*wt+be*kt+Ve*et,n[2]=H*wt+De*kt+Ee*et,n[3]=re*wt+Oe*kt+dt*et,n[4]=R*Tt+ae*ut+Ce*si,n[5]=N*Tt+be*ut+Ve*si,n[6]=H*Tt+De*ut+Ee*si,n[7]=re*Tt+Oe*ut+dt*si,n[8]=R*ti+ae*Zt+Ce*Lt,n[9]=N*ti+be*Zt+Ve*Lt,n[10]=H*ti+De*Zt+Ee*Lt,n[11]=re*ti+Oe*Zt+dt*Lt,e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n)}function Gw(n,e,i){var l=Math.sin(i),u=Math.cos(i),f=e[4],y=e[5],a=e[6],E=e[7],I=e[8],O=e[9],R=e[10],N=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=f*u+I*l,n[5]=y*u+O*l,n[6]=a*u+R*l,n[7]=E*u+N*l,n[8]=I*u-f*l,n[9]=O*u-y*l,n[10]=R*u-a*l,n[11]=N*u-E*l,n}function OL(n,e,i){var l=Math.sin(i),u=Math.cos(i),f=e[0],y=e[1],a=e[2],E=e[3],I=e[8],O=e[9],R=e[10],N=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=f*u-I*l,n[1]=y*u-O*l,n[2]=a*u-R*l,n[3]=E*u-N*l,n[8]=f*l+I*u,n[9]=y*l+O*u,n[10]=a*l+R*u,n[11]=E*l+N*u,n}function Ww(n,e,i){var l=Math.sin(i),u=Math.cos(i),f=e[0],y=e[1],a=e[2],E=e[3],I=e[4],O=e[5],R=e[6],N=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=f*u+I*l,n[1]=y*u+O*l,n[2]=a*u+R*l,n[3]=E*u+N*l,n[4]=I*u-f*l,n[5]=O*u-y*l,n[6]=R*u-a*l,n[7]=N*u-E*l,n}function BL(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],y=i+i,a=l+l,E=u+u,I=i*y,O=l*y,R=l*a,N=u*y,H=u*a,re=u*E,ae=f*y,be=f*a,De=f*E;return n[0]=1-R-re,n[1]=O+De,n[2]=N-be,n[3]=0,n[4]=O-De,n[5]=1-I-re,n[6]=H+ae,n[7]=0,n[8]=N+be,n[9]=H-ae,n[10]=1-I-R,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function FL(n,e,i,l,u,f,y){var a=1/(i-e),E=1/(u-l),I=1/(f-y);return n[0]=f*2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=f*2*E,n[6]=0,n[7]=0,n[8]=(i+e)*a,n[9]=(u+l)*E,n[10]=(y+f)*I,n[11]=-1,n[12]=0,n[13]=0,n[14]=y*f*2*I,n[15]=0,n}function NL(n,e,i,l,u){var f=1/Math.tan(e/2),y;return n[0]=f/i,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=f,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,u!=null&&u!==1/0?(y=1/(l-u),n[10]=(u+l)*y,n[14]=2*u*l*y):(n[10]=-1,n[14]=-2*l),n}var UL=NL;function VL(n,e,i,l,u,f,y){var a=1/(e-i),E=1/(l-u),I=1/(f-y);return n[0]=-2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*E,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*I,n[11]=0,n[12]=(e+i)*a,n[13]=(u+l)*E,n[14]=(y+f)*I,n[15]=1,n}var jL=VL;function GL(n,e,i,l){var u,f,y,a,E,I,O,R,N,H,re=e[0],ae=e[1],be=e[2],De=l[0],Oe=l[1],Ce=l[2],Ve=i[0],Ee=i[1],dt=i[2];return Math.abs(re-Ve)<ap&&Math.abs(ae-Ee)<ap&&Math.abs(be-dt)<ap?kL(n):(O=re-Ve,R=ae-Ee,N=be-dt,H=1/Math.hypot(O,R,N),O*=H,R*=H,N*=H,u=Oe*N-Ce*R,f=Ce*O-De*N,y=De*R-Oe*O,H=Math.hypot(u,f,y),H?(H=1/H,u*=H,f*=H,y*=H):(u=0,f=0,y=0),a=R*y-N*f,E=N*u-O*y,I=O*f-R*u,H=Math.hypot(a,E,I),H?(H=1/H,a*=H,E*=H,I*=H):(a=0,E=0,I=0),n[0]=u,n[1]=a,n[2]=O,n[3]=0,n[4]=f,n[5]=E,n[6]=R,n[7]=0,n[8]=y,n[9]=I,n[10]=N,n[11]=0,n[12]=-(u*re+f*ae+y*be),n[13]=-(a*re+E*ae+I*be),n[14]=-(O*re+R*ae+N*be),n[15]=1,n)}function WL(){var n=new Tc(4);return Tc!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function ZL(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n[3]=e[3]*i,n}function qh(n,e,i){var l=e[0],u=e[1],f=e[2],y=e[3];return n[0]=i[0]*l+i[4]*u+i[8]*f+i[12]*y,n[1]=i[1]*l+i[5]*u+i[9]*f+i[13]*y,n[2]=i[2]*l+i[6]*u+i[10]*f+i[14]*y,n[3]=i[3]*l+i[7]*u+i[11]*f+i[15]*y,n}(function(){var n=WL();return function(e,i,l,u,f,y){var a,E;for(i||(i=4),l||(l=0),u?E=Math.min(u*i+l,e.length):E=e.length,a=l;a<E;a+=i)n[0]=e[a],n[1]=e[a+1],n[2]=e[a+2],n[3]=e[a+3],f(n,n,y),e[a]=n[0],e[a+1]=n[1],e[a+2]=n[2],e[a+3]=n[3];return e}})();var __;(function(n){n[n.COL0ROW0=0]="COL0ROW0",n[n.COL0ROW1=1]="COL0ROW1",n[n.COL0ROW2=2]="COL0ROW2",n[n.COL0ROW3=3]="COL0ROW3",n[n.COL1ROW0=4]="COL1ROW0",n[n.COL1ROW1=5]="COL1ROW1",n[n.COL1ROW2=6]="COL1ROW2",n[n.COL1ROW3=7]="COL1ROW3",n[n.COL2ROW0=8]="COL2ROW0",n[n.COL2ROW1=9]="COL2ROW1",n[n.COL2ROW2=10]="COL2ROW2",n[n.COL2ROW3=11]="COL2ROW3",n[n.COL3ROW0=12]="COL3ROW0",n[n.COL3ROW1=13]="COL3ROW1",n[n.COL3ROW2=14]="COL3ROW2",n[n.COL3ROW3=15]="COL3ROW3"})(__||(__={}));const $L=45*Math.PI/180,qL=1,Lg=.1,kg=500,HL=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class _s extends LL{static get IDENTITY(){return YL()}static get ZERO(){return XL()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return __}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,i,l,u,f,y,a,E,I,O,R,N,H,re,ae,be){return this[0]=e,this[1]=i,this[2]=l,this[3]=u,this[4]=f,this[5]=y,this[6]=a,this[7]=E,this[8]=I,this[9]=O,this[10]=R,this[11]=N,this[12]=H,this[13]=re,this[14]=ae,this[15]=be,this.check()}setRowMajor(e,i,l,u,f,y,a,E,I,O,R,N,H,re,ae,be){return this[0]=e,this[1]=f,this[2]=I,this[3]=H,this[4]=i,this[5]=y,this[6]=O,this[7]=re,this[8]=l,this[9]=a,this[10]=R,this[11]=ae,this[12]=u,this[13]=E,this[14]=N,this[15]=be,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(HL)}fromObject(e){return this.check()}fromQuaternion(e){return BL(this,e),this.check()}frustum(e){const{left:i,right:l,bottom:u,top:f,near:y=Lg,far:a=kg}=e;return a===1/0?KL(this,i,l,u,f,y):FL(this,i,l,u,f,y,a),this.check()}lookAt(e){const{eye:i,center:l=[0,0,0],up:u=[0,1,0]}=e;return GL(this,i,l,u),this.check()}ortho(e){const{left:i,right:l,bottom:u,top:f,near:y=Lg,far:a=kg}=e;return jL(this,i,l,u,f,y,a),this.check()}orthographic(e){const{fovy:i=$L,aspect:l=qL,focalDistance:u=1,near:f=Lg,far:y=kg}=e;S1(i);const a=i/2,E=u*Math.tan(a),I=E*l;return this.ortho({left:-I,right:I,bottom:-E,top:E,near:f,far:y})}perspective(e){const{fovy:i=45*Math.PI/180,aspect:l=1,near:u=.1,far:f=500}=e;return S1(i),UL(this,i,l,u,f),this.check()}determinant(){return DL(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,i){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],i=i||[-0,-0,-0];const l=this.getScale(i),u=1/l[0],f=1/l[1],y=1/l[2];return e[0]=this[0]*u,e[1]=this[1]*f,e[2]=this[2]*y,e[3]=0,e[4]=this[4]*u,e[5]=this[5]*f,e[6]=this[6]*y,e[7]=0,e[8]=this[8]*u,e[9]=this[9]*f,e[10]=this[10]*y,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,i){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],i=i||[-0,-0,-0];const l=this.getScale(i),u=1/l[0],f=1/l[1],y=1/l[2];return e[0]=this[0]*u,e[1]=this[1]*f,e[2]=this[2]*y,e[3]=this[4]*u,e[4]=this[5]*f,e[5]=this[6]*y,e[6]=this[8]*u,e[7]=this[9]*f,e[8]=this[10]*y,e}transpose(){return RL(this,this),this.check()}invert(){return g_(this,this),this.check()}multiplyLeft(e){return qa(this,e,this),this.check()}multiplyRight(e){return qa(this,this,e),this.check()}rotateX(e){return Gw(this,this,e),this.check()}rotateY(e){return OL(this,this,e),this.check()}rotateZ(e){return Ww(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,i){return zL(this,this,e,i),this.check()}scale(e){return ry(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return vp(this,this,e),this.check()}transform(e,i){return e.length===4?(i=qh(i||[-0,-0,-0,-0],e,this),Ig(i,4),i):this.transformAsPoint(e,i)}transformAsPoint(e,i){const{length:l}=e;let u;switch(l){case 2:u=gL(i||[-0,-0],e,this);break;case 3:u=jw(i||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ig(u,e.length),u}transformAsVector(e,i){let l;switch(e.length){case 2:l=_L(i||[-0,-0],e,this);break;case 3:l=Vw(i||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ig(l,e.length),l}transformPoint(e,i){return this.transformAsPoint(e,i)}transformVector(e,i){return this.transformAsPoint(e,i)}transformDirection(e,i){return this.transformAsVector(e,i)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,i,l){return this.identity().translate([e,i,l])}}let Gf,Wf;function XL(){return Gf||(Gf=new _s([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(Gf)),Gf}function YL(){return Wf||(Wf=new _s,Object.freeze(Wf)),Wf}function S1(n){if(n>Math.PI*2)throw Error("expected radians")}function KL(n,e,i,l,u,f){const y=2*f/(i-e),a=2*f/(u-l),E=(i+e)/(i-e),I=(u+l)/(u-l),O=-1,R=-1,N=-2*f;return n[0]=y,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=E,n[9]=I,n[10]=O,n[11]=R,n[12]=0,n[13]=0,n[14]=N,n[15]=0,n}const M1=`#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))

struct AmbientLight {
 vec3 color;
};

struct PointLight {
 vec3 color;
 vec3 position;
 vec3 attenuation;
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform AmbientLight lighting_uAmbientLight;
uniform PointLight lighting_uPointLight[MAX_LIGHTS];
uniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];
uniform int lighting_uPointLightCount;
uniform int lighting_uDirectionalLightCount;

uniform bool lighting_uEnabled;

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

#endif
`,JL={lightSources:{}};function Rg(){let{color:n=[0,0,0],intensity:e=1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return n.map(i=>i*e/255)}function QL(n){let{ambientLight:e,pointLights:i=[],directionalLights:l=[]}=n;const u={};return e?u["lighting_uAmbientLight.color"]=Rg(e):u["lighting_uAmbientLight.color"]=[0,0,0],i.forEach((f,y)=>{u["lighting_uPointLight[".concat(y,"].color")]=Rg(f),u["lighting_uPointLight[".concat(y,"].position")]=f.position,u["lighting_uPointLight[".concat(y,"].attenuation")]=f.attenuation||[1,0,0]}),u.lighting_uPointLightCount=i.length,l.forEach((f,y)=>{u["lighting_uDirectionalLight[".concat(y,"].color")]=Rg(f),u["lighting_uDirectionalLight[".concat(y,"].direction")]=f.direction}),u.lighting_uDirectionalLightCount=l.length,u}function Zw(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:JL;if("lightSources"in n){const{ambientLight:e,pointLights:i,directionalLights:l}=n.lightSources||{};return e||i&&i.length>0||l&&l.length>0?Object.assign({},QL({ambientLight:e,pointLights:i,directionalLights:l}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in n){const e={pointLights:[],directionalLights:[]};for(const i of n.lights||[])switch(i.type){case"ambient":e.ambientLight=i;break;case"directional":e.directionalLights.push(i);break;case"point":e.pointLights.push(i);break}return Zw({lightSources:e})}return{}}const ek={name:"lights",vs:M1,fs:M1,getUniforms:Zw,defines:{MAX_LIGHTS:3}},tk=new Uint8Array([0,255,255,255]),ik={pickingSelectedColor:null,pickingHighlightColor:tk,pickingActive:!1,pickingAttribute:!1};function nk(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ik;const e={};if(n.pickingSelectedColor!==void 0)if(!n.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{const i=n.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=i}if(n.pickingHighlightColor){const i=Array.from(n.pickingHighlightColor,l=>l/255);Number.isFinite(i[3])||(i[3]=1),e.picking_uHighlightColor=i}return n.pickingActive!==void 0&&(e.picking_uActive=Boolean(n.pickingActive),e.picking_uAttribute=Boolean(n.pickingAttribute)),e}const rk=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,sk=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,ok={name:"picking",vs:rk,fs:sk,getUniforms:nk},ak=`
uniform float lighting_uAmbient;
uniform float lighting_uDiffuse;
uniform float lighting_uShininess;
uniform vec3  lighting_uSpecularColor;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
    vec3 halfway_direction = normalize(light_direction + view_direction);
    float lambertian = dot(light_direction, normal_worldspace);
    float specular = 0.0;
    if (lambertian > 0.0) {
      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
      specular = pow(specular_angle, lighting_uShininess);
    }
    lambertian = max(lambertian, 0.0);
    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);
    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}

vec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = vec3(0, 0, 0);
  vec3 surfaceColor = vec3(0, 0, 0);

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}
`,lk={};function ck(n){const{ambient:e=.35,diffuse:i=.6,shininess:l=32,specularColor:u=[30,30,30]}=n;return{lighting_uAmbient:e,lighting_uDiffuse:i,lighting_uShininess:l,lighting_uSpecularColor:u.map(f=>f/255)}}function uk(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:lk;if(!("material"in n))return{};const{material:e}=n;return e?ck(e):{lighting_uEnabled:!1}}const hk={name:"gouraud-lighting",dependencies:[ek],vs:ak,defines:{LIGHTING_VERTEX:1},getUniforms:uk},dk=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,fk={name:"transform",vs:dk,fs:null};class Hh{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new Hh(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(i=>i.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){const i=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(l=>l.name!==i),this.stateHash++}addShaderHook(e,i){i&&(e=Object.assign(i,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{vs:i="",fs:l="",defines:u={},inject:f={},varyings:y=[],bufferMode:a=35981,transpileToGLSL100:E=!1}=e,I=this._getModuleList(e.modules),O=this._getHash(i),R=this._getHash(l),N=I.map(Ce=>this._getHash(Ce.name)).sort(),H=y.map(Ce=>this._getHash(Ce)),re=Object.keys(u).sort(),ae=Object.keys(f).sort(),be=[],De=[];for(const Ce of re)be.push(this._getHash(Ce)),be.push(this._getHash(u[Ce]));for(const Ce of ae)De.push(this._getHash(Ce)),De.push(this._getHash(f[Ce]));const Oe="".concat(O,"/").concat(R,"D").concat(be.join("/"),"M").concat(N.join("/"),"I").concat(De.join("/"),"V").concat(H.join("/"),"H").concat(this.stateHash,"B").concat(a).concat(E?"T":"");if(!this._programCache[Oe]){const Ce=H3(this.gl,{vs:i,fs:l,modules:I,inject:f,defines:u,hookFunctions:this._hookFunctions,transpileToGLSL100:E});this._programCache[Oe]=new Pw(this.gl,{hash:Oe,vs:Ce.vs,fs:Ce.fs,varyings:y,bufferMode:a}),this._getUniforms[Oe]=Ce.getUniforms||(Ve=>{}),this._useCounts[Oe]=0}return this._useCounts[Oe]++,this._programCache[Oe]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){const i=e.hash;this._useCounts[i]--,this._useCounts[i]===0&&(this._programCache[i].delete(),delete this._programCache[i],delete this._getUniforms[i],delete this._useCounts[i])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const i=new Array(this._defaultModules.length+e.length),l={};let u=0;for(let f=0,y=this._defaultModules.length;f<y;++f){const a=this._defaultModules[f],E=a.name;i[u++]=a,l[E]=!0}for(let f=0,y=e.length;f<y;++f){const a=e[f],E=a.name;l[E]||(i[u++]=a,l[E]=!0)}return i.length=u,i}}const pk={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function mk(n,e,i){const l={};let u=e.indices;for(const f in e.attributes){const y=e.attributes[f],a=gk(f,i);if(f==="indices")u=y;else if(y.constant)l[a]=y.value;else{const E=y.value,I={...y};delete I.value,l[a]=[new Ui(n,E),I],_k(f,I)}}if(u){const f=u.value||u;St(f instanceof Uint16Array||f instanceof Uint32Array,'attribute array for "indices" must be of integer type');const y={size:1,isIndexed:u.isIndexed===void 0?!0:u.isIndexed};l.indices=[new Ui(n,{data:f,target:34963}),y]}return l}function gk(n,e){const{attributeMap:i=pk}=e||{};return i&&i[n]||n}function _k(n,e){let i;switch(n){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":i="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":i="vectors";break}switch(i){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break}St(Number.isFinite(e.size),"attribute ".concat(n," needs size"))}const sc=2,yk=1e4,xk="Model needs drawMode and vertexCount",P1=()=>{},vk={};class Ih{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{id:l=ca("model")}=i;St(Op(e)),this.id=l,this.gl=e,this.id=i.id||ca("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(i)}initialize(e){this.props={},this.programManager=e.programManager||Hh.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;const{program:i=null,vs:l,fs:u,modules:f,defines:y,inject:a,varyings:E,bufferMode:I,transpileToGLSL100:O}=e;this.programProps={program:i,vs:l,fs:u,modules:f,defines:y,inject:a,varyings:E,bufferMode:I,transpileToGLSL100:O},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},St(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),xk)}setProps(e){this._setModelProps(e)}delete(){for(const e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){const{program:i,vs:l,fs:u,modules:f,defines:y,inject:a,varyings:E,bufferMode:I,transpileToGLSL100:O}=e;this.programProps={program:i,vs:l,fs:u,modules:f,defines:y,inject:a,varyings:E,bufferMode:I,transpileToGLSL100:O},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return St(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return St(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=mk(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(yc(e))return this;const i={};for(const l in e){const u=e[l];i[l]=u.getValue?u.getValue():u}return this.vertexArray.setAttributes(i),this}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();const i=this.programManager.getUniforms(this.program);return i?i(e):{}}updateModuleSettings(e){const i=this.getModuleUniforms(e||{});return this.setUniforms(i)}clear(e){return Q_(this.program.gl,e),this}draw(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._checkProgram();const{moduleSettings:i=null,framebuffer:l,uniforms:u={},attributes:f={},transformFeedback:y=this.transformFeedback,parameters:a={},vertexArray:E=this.vertexArray}=e;this.setAttributes(f),this.updateModuleSettings(i),this.setUniforms(u);let I;Bt.priority>=sc&&(I=this._logDrawCallStart(sc));const O=this.vertexArray.getDrawParams(),{isIndexed:R=O.isIndexed,indexType:N=O.indexType,indexOffset:H=O.indexOffset,vertexArrayInstanced:re=O.isInstanced}=this.props;re&&!this.isInstanced&&Bt.warn("Found instanced attributes on non-instanced model",this.id)();const{isInstanced:ae,instanceCount:be}=this,{onBeforeRender:De=P1,onAfterRender:Oe=P1}=this.props;De(),this.program.setUniforms(this.uniforms);const Ce=this.program.draw(Object.assign(vk,e,{logPriority:I,uniforms:null,framebuffer:l,parameters:a,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:E,transformFeedback:y,isIndexed:R,indexType:N,isInstanced:ae,instanceCount:be,offset:R?H:0}));return Oe(),Bt.priority>=sc&&this._logDrawCallEnd(I,E,l),Ce}transform(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{discard:i=!0,feedbackBuffers:l,unbindModels:u=[]}=e;let{parameters:f}=e;l&&this._setFeedbackBuffers(l),i&&(f=Object.assign({},f,{[35977]:i})),u.forEach(y=>y.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:f}))}finally{u.forEach(y=>y.vertexArray.bindBuffers())}return this}render(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Bt.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:i}=this.programProps;if(i)this._managedProgram=!1;else{const{vs:l,fs:u,modules:f,inject:y,defines:a,varyings:E,bufferMode:I,transpileToGLSL100:O}=this.programProps;i=this.programManager.get({vs:l,fs:u,modules:f,inject:y,defines:a,varyings:E,bufferMode:I,transpileToGLSL100:O}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}St(i instanceof Pw,"Model needs a program"),this._programDirty=!1,i!==this.program&&(this.program=i,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new c3(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(const e in this.geometryBuffers){const i=this.geometryBuffers[e][0]||this.geometryBuffers[e];i instanceof Ui&&i.delete()}}_setAnimationProps(e){this.animated&&St(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(yc(e))return this;const{gl:i}=this.program;return this.transformFeedback=this.transformFeedback||new Iw(i,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){const i=e>3?0:yk;if(!(Date.now()-this.lastLogTime<i))return this.lastLogTime=Date.now(),Bt.group(sc,">>> DRAWING MODEL ".concat(this.id),{collapsed:Bt.level<=2})(),e}_logDrawCallEnd(e,i,l,u){if(e===void 0)return;const f=d3({vertexArray:i,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:y,unusedTable:a,unusedCount:E}=p1({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,l)}),{table:I,count:O}=p1({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,l),undefinedOnly:!0});O>0&&Bt.log("MISSING UNIFORMS",Object.keys(I))(),E>0&&Bt.log("UNUSED UNIFORMS",Object.keys(a))();const R=p3(this.vertexArray.configuration);Bt.table(e,f)(),Bt.table(e,y)(),Bt.table(e+1,R)(),u&&u.log({logLevel:sc,message:"Rendered to ".concat(u.id)}),Bt.groupEnd(sc)()}}class bk{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(i),Object.seal(this)}setupResources(e){for(const i of this.bindings)this._setupTransformFeedback(i,e)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{varyings:i}=this;return i.length>0&&(e=Object.assign({},e,{varyings:i})),e}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const i=this.bindings[this.currentIndex],{sourceBuffers:l,transformFeedback:u}=i;return{attributes:Object.assign({},l,e.attributes),transformFeedback:u}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e)}getBuffer(e){const{feedbackBuffers:i}=this.bindings[this.currentIndex],l=e?i[e]:null;return l?l instanceof Ui?l:l.buffer:null}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{varyingName:i}=e,l=this.getBuffer(i);return l?l.getData():null}delete(){for(const e in this.resources)this.resources[e].delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&St(gi(this.gl))}_getFeedbackBuffers(e){const{sourceBuffers:i={}}=e,l={};if(this.bindings[this.currentIndex]&&Object.assign(l,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(const u in this.feedbackMap){const f=this.feedbackMap[u];u in i&&(l[f]=u)}Object.assign(l,e.feedbackBuffers);for(const u in l){const f=l[u];if(typeof f=="string"){const y=i[f],{byteLength:a,usage:E,accessor:I}=y;l[u]=this._createNewBuffer(u,{byteLength:a,usage:E,accessor:I})}}return l}_setupBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceBuffers:i=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);const l=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:i,feedbackBuffers:l})}_setupTransformFeedback(e,i){let{model:l}=i;const{program:u}=l;e.transformFeedback=new Iw(this.gl,{program:u,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){const{sourceBuffers:i,feedbackBuffers:l}=this._swapBuffers(this.bindings[this.currentIndex]),u=this._getNextIndex();this.bindings[u]=this._updateBinding(this.bindings[u],{sourceBuffers:i,feedbackBuffers:l})}}_updateBinding(e,i){return e?(Object.assign(e.sourceBuffers,i.sourceBuffers),Object.assign(e.feedbackBuffers,i.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},i.sourceBuffers),feedbackBuffers:Object.assign({},i.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;const i=Object.assign({},e.sourceBuffers),l=Object.assign({},e.feedbackBuffers);for(const u in this.feedbackMap){const f=this.feedbackMap[u];i[u]=e.feedbackBuffers[f],l[f]=e.sourceBuffers[u],St(l[f]instanceof Ui)}return{sourceBuffers:i,feedbackBuffers:l}}_createNewBuffer(e,i){const l=new Ui(this.gl,i);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=l,l}_getNextIndex(){return(this.currentIndex+1)%2}}const wk="transform_uSampler_",bp="transform_uSize_",I1="transform_position";function Tk(n){let{vs:e,sourceTextureMap:i,targetTextureVarying:l,targetTexture:u}=n,y=Object.keys(i).length,a=null;const E={};let I=e,O={};if(y>0||l){const R=I.split(`
`),N=R.slice();if(R.forEach((H,re,ae)=>{if(y>0){const be=Pk(H,i);if(be){const{updatedLine:De,inject:Oe}=be;N[re]=De,O=f_([O,Oe]),Object.assign(E,be.samplerTextureMap),y--}}l&&!a&&(a=Mk(H,l))}),l){St(u);const H="".concat(bp).concat(l),re="uniform vec2 ".concat(H,`;
`),ae="     vec2 ".concat(I1," = transform_getPos(").concat(H,`);
     gl_Position = vec4(`).concat(I1,`, 0, 1.);
`);O=f_([O,{"vs:#decl":re,"vs:#main-start":ae}])}I=N.join(`
`)}return{vs:I,targetTextureType:a,inject:O,samplerTextureMap:E}}function Ek(n){let{sourceTextureMap:e,targetTextureVarying:i,targetTexture:l}=n;const u={};let f,y;i&&({width:f,height:y}=l,u["".concat(bp).concat(i)]=[f,y]);for(const a in e)({width:f,height:y}=e[a]),u["".concat(bp).concat(a)]=[f,y];return u}function Ak(n){return Ow(n,["attribute","in"])}function Sk(n){const e="".concat(wk).concat(n),i="".concat(bp).concat(n),l="  uniform sampler2D ".concat(e,`;
  uniform vec2 `).concat(i,";");return{samplerName:e,sizeName:i,uniformDeclerations:l}}function Mk(n,e){const i=Ow(n,["varying","out"]);return i&&i.name===e?i.type:null}function Pk(n,e){const i={},l=Ak(n);if(!l)return null;const{type:u,name:f}=l;if(f&&e[f]){const y="// ".concat(n," => Replaced by Transform with a sampler"),{samplerName:a,sizeName:E,uniformDeclerations:I}=Sk(f),O=nL(u),R="  ".concat(u," ").concat(f," = transform_getInput(").concat(a,", ").concat(E,").").concat(O,`;
`);return i[a]=f,{updatedLine:y,inject:{"vs:#decl":I,"vs:#main-start":R},samplerTextureMap:i}}return null}const Ik={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},Ck="transform_output";class Lk{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(i),Object.seal(this)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const i=this._processVertexShader(e);return Object.assign({},e,i)}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceBuffers:i,sourceTextures:l,framebuffer:u,targetTexture:f}=this.bindings[this.currentIndex],y=Object.assign({},i,e.attributes),a=Object.assign({},e.uniforms),E=Object.assign({},e.parameters);let I=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){y.transform_elementID=this.elementIDBuffer;for(const R in this.samplerTextureMap){const N=this.samplerTextureMap[R];a[R]=l[N]}this._setSourceTextureParameters();const O=Ek({sourceTextureMap:l,targetTextureVarying:this.targetTextureVarying,targetTexture:f});Object.assign(a,O)}return this.hasTargetTexture&&(I=!1,E.viewport=[0,0,u.width,u.height]),{attributes:y,framebuffer:u,uniforms:a,discard:I,parameters:E}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupTextures(e)}getTargetTexture(){const{targetTexture:e}=this.bindings[this.currentIndex];return e}getData(){let{packed:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{framebuffer:i}=this.bindings[this.currentIndex],l=Fp(i);if(!e)return l;const u=l.constructor,f=rL(this.targetTextureType),y=new u(l.length*f/4);let a=0;for(let E=0;E<l.length;E+=4)for(let I=0;I<f;I++)y[a++]=l[E+I];return y}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{_targetTextureVarying:i,_swapTexture:l}=e;this._swapTexture=l,this.targetTextureVarying=i,this.hasTargetTexture=i,this._setupTextures(e)}_createTargetTexture(e){const{sourceTextures:i,textureOrReference:l}=e;if(l instanceof qr)return l;const u=i[l];return u?(this._targetRefTexName=l,this._createNewTexture(u)):null}_setupTextures(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceBuffers:i,_sourceTextures:l={},_targetTexture:u}=e,f=this._createTargetTexture({sourceTextures:l,textureOrReference:u});this.hasSourceTextures=this.hasSourceTextures||l&&Object.keys(l).length>0,this._updateBindings({sourceBuffers:i,sourceTextures:l,targetTexture:f}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;const i=new Float32Array(e);i.forEach((l,u,f)=>{f[u]=u}),this.elementIDBuffer?this.elementIDBuffer.setData({data:i}):this.elementIDBuffer=new Ui(this.gl,{data:i,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){const{sourceTextures:i,targetTexture:l}=this._swapTextures(this.bindings[this.currentIndex]),u=this._getNextIndex();this.bindings[u]=this._updateBinding(this.bindings[u],{sourceTextures:i,targetTexture:l})}}_updateBinding(e,i){const{sourceBuffers:l,sourceTextures:u,targetTexture:f}=i;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,u),Object.assign(e.sourceBuffers,l),f){e.targetTexture=f;const{width:y,height:a}=f,{framebuffer:E}=e;E?(E.update({attachments:{[36064]:f},resizeAttachments:!1}),E.resize({width:y,height:a})):e.framebuffer=new En(this.gl,{id:"transform-framebuffer",width:y,height:a,attachments:{[36064]:f}})}return e}_setSourceTextureParameters(){const e=this.currentIndex,{sourceTextures:i}=this.bindings[e];for(const l in i)i[l].setParameters(Ik)}_swapTextures(e){if(!this._swapTexture)return null;const i=Object.assign({},e.sourceTextures);i[this._swapTexture]=e.targetTexture;const l=e.sourceTextures[this._swapTexture];return{sourceTextures:i,targetTexture:l}}_createNewTexture(e){const i=JI(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=i,i}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceTextures:i,targetTexture:l}=this.bindings[this.currentIndex],{vs:u,uniforms:f,targetTextureType:y,inject:a,samplerTextureMap:E}=Tk({vs:e.vs,sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:l}),I=f_([e.inject||{},a]);this.targetTextureType=y,this.samplerTextureMap=E;const O=e._fs||Bw({version:Sw(u),input:this.targetTextureVarying,inputType:y,output:Ck}),R=this.hasSourceTextures||this.targetTextureVarying?[fk].concat(e.modules||[]):e.modules;return{vs:u,fs:O,modules:R,uniforms:f,inject:I}}}class sy{static isSupported(e){return gi(e)}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(i),Object.seal(this)}delete(){const{model:e,bufferTransform:i,textureTransform:l}=this;e&&e.delete(),i&&i.delete(),l&&l.delete()}run(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{clearRenderTarget:i=!0}=e,l=this._updateDrawOptions(e);i&&l.framebuffer&&l.framebuffer.clear({color:!0}),this.model.transform(l)}swap(){let e=!1;const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const l of i)e=e||l.swap();St(e,"Nothing to swap")}getBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const l of i){const u=l.getData(e);if(u)return u}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};"elementCount"in e&&this.model.setVertexCount(e.elementCount);const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const l of i)l.update(e)}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{gl:i}=this;this._buildResourceTransforms(i,e),e=this._updateModelProps(e),this.model=new Ih(i,Object.assign({},e,{fs:e.fs||Bw({version:Sw(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let i=Object.assign({},e);const l=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const u of l)i=u.updateModelProps(i);return i}_buildResourceTransforms(e,i){kk(i)&&(this.bufferTransform=new bk(e,i)),Rk(i)&&(this.textureTransform=new Lk(e,i)),St(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let i=Object.assign({},e);const l=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const u of l)i=Object.assign(i,u.getDrawOptions(i));return i}}function kk(n){return!!(!yc(n.feedbackBuffers)||!yc(n.feedbackMap)||n.varyings&&n.varyings.length>0)}function Rk(n){return!!(!yc(n._sourceTextures)||n._targetTexture||n._targetTextureVarying)}const C1={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class oy{static get DRAW_MODE(){return C1}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{id:i=ca("geometry"),drawMode:l=C1.TRIANGLES,attributes:u={},indices:f=null,vertexCount:y=null}=e;this.id=i,this.drawMode=l|0,this.attributes={},this.userData={},this._setAttributes(u,f),this.vertexCount=y||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return"Geometry ".concat(this.id," attribute ").concat(e)}_setAttributes(e,i){i&&(this.indices=ArrayBuffer.isView(i)?{value:i,size:1}:i);for(const l in e){let u=e[l];u=ArrayBuffer.isView(u)?{value:u}:u,St(ArrayBuffer.isView(u.value),"".concat(this._print(l),": must be typed array or object with value as typed array")),(l==="POSITION"||l==="positions")&&!u.size&&(u.size=3),l==="indices"?(St(!this.indices),this.indices=u):this.attributes[l]=u}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,i){if(i)return i.value.length;let l=1/0;for(const u in e){const f=e[u],{value:y,size:a,constant:E}=f;!E&&y&&a>=1&&(l=Math.min(l,y.length/a))}return St(Number.isFinite(l)),l}}let Dk=1,zk=1;class $w{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(e){const{delay:i=0,duration:l=Number.POSITIVE_INFINITY,rate:u=1,repeat:f=1}=e,y=Dk++,a={time:0,delay:i,duration:l,rate:u,repeat:f};return this._setChannelTime(a,this.time),this.channels.set(y,a),y}removeChannel(e){this.channels.delete(e);for(const[i,l]of this.animations)l.channel===e&&this.detachAnimation(i)}isFinished(e){const i=this.channels.get(e);return i===void 0?!1:this.time>=i.delay+i.duration*i.repeat}getTime(e){if(e===void 0)return this.time;const i=this.channels.get(e);return i===void 0?-1:i.time}setTime(e){this.time=Math.max(0,e);const i=this.channels.values();for(const u of i)this._setChannelTime(u,this.time);const l=this.animations.values();for(const u of l){const{animation:f,channel:y}=u;f.setTime(this.getTime(y))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,i){const l=zk++;return this.animations.set(l,{animation:e,channel:i}),e.setTime(this.getTime(i)),l}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,i){const l=i-e.delay,u=e.duration*e.repeat;l>=u?e.time=e.duration*e.rate:(e.time=Math.max(0,l)%e.duration,e.time*=e.rate)}}const qw="#define SMOOTH_EDGE_RADIUS 0.5",Ok=`
`.concat(qw,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),Bk=`
`.concat(qw,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),Fk={name:"geometry",vs:Ok,fs:Bk},Pi={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Pi,"IDENTITY",{get:()=>(Bi.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const oo={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Ch={common:0,meters:1,pixels:2},L1={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},Xh={DRAW:"draw",MASK:"mask"},Nk=Object.keys(Pi).map(n=>"const int COORDINATE_SYSTEM_".concat(n," = ").concat(Pi[n],";")).join(""),Uk=Object.keys(oo).map(n=>"const int PROJECTION_MODE_".concat(n," = ").concat(oo[n],";")).join(""),Vk=Object.keys(Ch).map(n=>"const int UNIT_".concat(n.toUpperCase()," = ").concat(Ch[n],";")).join(""),jk="".concat(Nk,`
`).concat(Uk,`
`).concat(Vk,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size_at_latitude(float lat) {
  float y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      return project_size_at_latitude(geometry.worldPosition.y);
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

float project_size_at_latitude(float meters, float lat) {
  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);
}

//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project_uCoordinateSystem) to common space (defined by project_uProjectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size_at_latitude(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project_uCoordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project_uViewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);function Gk(n,e){if(n===e)return!0;if(Array.isArray(n)){const i=n.length;if(!e||e.length!==i)return!1;for(let l=0;l<i;l++)if(n[l]!==e[l])return!1;return!0}return!1}function Np(n){let e={},i;return l=>{for(const u in l)if(!Gk(l[u],e[u])){i=n(l),e=l;break}return i}}const k1=[0,0,0,0],Wk=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],Hw=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Zk=[0,0,0],Xw=[0,0,0],$k=Np(Xk);function Yw(n,e,i=Xw){i.length<3&&(i=[i[0],i[1],0]);let l=i,u,f=!0;switch(e===Pi.LNGLAT_OFFSETS||e===Pi.METER_OFFSETS?u=i:u=n.isGeospatial?[Math.fround(n.longitude),Math.fround(n.latitude),0]:null,n.projectionMode){case oo.WEB_MERCATOR:(e===Pi.LNGLAT||e===Pi.CARTESIAN)&&(u=[0,0,0],f=!1);break;case oo.WEB_MERCATOR_AUTO_OFFSET:e===Pi.LNGLAT?l=u:e===Pi.CARTESIAN&&(l=[Math.fround(n.center[0]),Math.fround(n.center[1]),0],u=n.unprojectPosition(l),l[0]-=i[0],l[1]-=i[1],l[2]-=i[2]);break;case oo.IDENTITY:l=n.position.map(Math.fround),l[2]=l[2]||0;break;case oo.GLOBE:f=!1,u=null;break;default:f=!1}return{geospatialOrigin:u,shaderCoordinateOrigin:l,offsetMode:f}}function qk(n,e,i){const{viewMatrixUncentered:l,projectionMatrix:u}=n;let{viewMatrix:f,viewProjectionMatrix:y}=n,a=k1,E=k1,I=n.cameraPosition;const{geospatialOrigin:O,shaderCoordinateOrigin:R,offsetMode:N}=Yw(n,e,i);return N&&(E=n.projectPosition(O||R),I=[I[0]-E[0],I[1]-E[1],I[2]-E[2]],E[3]=1,a=qh([],E,y),f=l||f,y=qa([],u,f),y=qa([],y,Wk)),{viewMatrix:f,viewProjectionMatrix:y,projectionCenter:a,originCommon:E,cameraPosCommon:I,shaderCoordinateOrigin:R,geospatialOrigin:O}}function Hk({viewport:n,devicePixelRatio:e=1,modelMatrix:i=null,coordinateSystem:l=Pi.DEFAULT,coordinateOrigin:u=Xw,autoWrapLongitude:f=!1}){l===Pi.DEFAULT&&(l=n.isGeospatial?Pi.LNGLAT:Pi.CARTESIAN);const y=$k({viewport:n,devicePixelRatio:e,coordinateSystem:l,coordinateOrigin:u});return y.project_uWrapLongitude=f,y.project_uModelMatrix=i||Hw,y}function Xk({viewport:n,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:l}){const{projectionCenter:u,viewProjectionMatrix:f,originCommon:y,cameraPosCommon:a,shaderCoordinateOrigin:E,geospatialOrigin:I}=qk(n,i,l),O=n.getDistanceScales(),R=[n.width*e,n.height*e],N=qh([],[0,0,-n.focalDistance,1],n.projectionMatrix)[3]||1,H={project_uCoordinateSystem:i,project_uProjectionMode:n.projectionMode,project_uCoordinateOrigin:E,project_uCommonOrigin:y.slice(0,3),project_uCenter:u,project_uPseudoMeters:Boolean(n._pseudoMeters),project_uViewportSize:R,project_uDevicePixelRatio:e,project_uFocalDistance:N,project_uCommonUnitsPerMeter:O.unitsPerMeter,project_uCommonUnitsPerWorldUnit:O.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:Zk,project_uScale:n.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:f,project_uModelMatrix:Hw,project_uCameraPosition:a};if(I){const re=n.getDistanceScales(I);switch(i){case Pi.METER_OFFSETS:H.project_uCommonUnitsPerWorldUnit=re.unitsPerMeter,H.project_uCommonUnitsPerWorldUnit2=re.unitsPerMeter2;break;case Pi.LNGLAT:case Pi.LNGLAT_OFFSETS:n._pseudoMeters||(H.project_uCommonUnitsPerMeter=re.unitsPerMeter),H.project_uCommonUnitsPerWorldUnit=re.unitsPerDegree,H.project_uCommonUnitsPerWorldUnit2=re.unitsPerDegree2;break;case Pi.CARTESIAN:H.project_uCommonUnitsPerWorldUnit=[1,1,re.unitsPerMeter[2]],H.project_uCommonUnitsPerWorldUnit2=[0,0,re.unitsPerMeter2[2]];break}}return H}const Yk={};function Kk(n=Yk){return"viewport"in n?Hk(n):{}}const ay={name:"project",dependencies:[aL,Fk],vs:jk,getUniforms:Kk},Jk=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,ly={name:"project32",dependencies:[ay],vs:Jk};function Qk(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function pc(n,e){const i=qh([],e,n);return ZL(i,i,1/i[3]),i}function R1(n,e){const i=n%e;return i<0?e+i:i}function y_(n,e,i){return n<e?e:n>i?i:n}function eR(n){return Math.log(n)*Math.LOG2E}const cy=Math.log2||eR;function ko(n,e){if(!n)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const zs=Math.PI,Kw=zs/4,Bs=zs/180,x_=180/zs,Lh=512,v_=4003e4,Zf=85.051129,tR=1.5;function iR(n){return cy(n)}function wp(n){const[e,i]=n;ko(Number.isFinite(e)),ko(Number.isFinite(i)&&i>=-90&&i<=90,"invalid latitude");const l=e*Bs,u=i*Bs,f=Lh*(l+zs)/(2*zs),y=Lh*(zs+Math.log(Math.tan(Kw+u*.5)))/(2*zs);return[f,y]}function Ec(n){const[e,i]=n,l=e/Lh*(2*zs)-zs,u=2*(Math.atan(Math.exp(i/Lh*(2*zs)-zs))-Kw);return[l*x_,u*x_]}function nR(n){const{latitude:e}=n;ko(Number.isFinite(e));const i=Math.cos(e*Bs);return iR(v_*i)-9}function b_(n){const{latitude:e,longitude:i,highPrecision:l=!1}=n;ko(Number.isFinite(e)&&Number.isFinite(i));const u=Lh,f=Math.cos(e*Bs),y=u/360,a=y/f,E=u/v_/f,I={unitsPerMeter:[E,E,E],metersPerUnit:[1/E,1/E,1/E],unitsPerDegree:[y,a,E],degreesPerUnit:[1/y,1/a,1/E]};if(l){const O=Bs*Math.tan(e*Bs)/f,R=y*O/2,N=u/v_*O,H=N/a*E;I.unitsPerDegree2=[0,R,N],I.unitsPerMeter2=[H,0,H]}return I}function Jw(n,e){const[i,l,u]=n,[f,y,a]=e,{unitsPerMeter:E,unitsPerMeter2:I}=b_({longitude:i,latitude:l,highPrecision:!0}),O=wp(n);O[0]+=f*(E[0]+I[0]*y),O[1]+=y*(E[1]+I[1]*y);const R=Ec(O),N=(u||0)+(a||0);return Number.isFinite(u)||Number.isFinite(a)?[R[0],R[1],N]:R}function rR(n){const{height:e,pitch:i,bearing:l,altitude:u,scale:f,center:y}=n,a=Qk();vp(a,a,[0,0,-u]),Gw(a,a,-i*Bs),Ww(a,a,l*Bs);const E=f/e;return ry(a,a,[E,E,E]),y&&vp(a,a,bL([],y)),a}function sR(n){const{width:e,height:i,altitude:l,pitch:u=0,offset:f,center:y,scale:a,nearZMultiplier:E=1,farZMultiplier:I=1}=n;let{fovy:O=Tp(tR)}=n;l!==void 0&&(O=Tp(l));const R=O*Bs,N=u*Bs,H=Qw(O);let re=H;y&&(re+=y[2]*a/Math.cos(N)/i);const ae=R*(.5+(f?f[1]:0)/i),be=Math.sin(ae)*re/Math.sin(y_(Math.PI/2-N-ae,.01,Math.PI-.01)),De=Math.sin(N)*be+re,Oe=re*10,Ce=Math.min(De*I,Oe);return{fov:R,aspect:e/i,focalDistance:H,near:E,far:Ce}}function Tp(n){return 2*Math.atan(.5/n)*x_}function Qw(n){return .5/Math.tan(.5*n*Bs)}function eT(n,e){const[i,l,u=0]=n;return ko(Number.isFinite(i)&&Number.isFinite(l)&&Number.isFinite(u)),pc(e,[i,l,u,1])}function Up(n,e,i=0){const[l,u,f]=n;if(ko(Number.isFinite(l)&&Number.isFinite(u),"invalid pixel coordinate"),Number.isFinite(f))return pc(e,[l,u,f,1]);const y=pc(e,[l,u,0,1]),a=pc(e,[l,u,1,1]),E=y[2],I=a[2],O=E===I?0:((i||0)-E)/(I-E);return Uw([],y,a,O)}function tT(n){const{width:e,height:i,bounds:l,minExtent:u=0,maxZoom:f=24,offset:y=[0,0]}=n,[[a,E],[I,O]]=l,R=oR(n.padding),N=wp([a,y_(O,-Zf,Zf)]),H=wp([I,y_(E,-Zf,Zf)]),re=[Math.max(Math.abs(H[0]-N[0]),u),Math.max(Math.abs(H[1]-N[1]),u)],ae=[e-R.left-R.right-Math.abs(y[0])*2,i-R.top-R.bottom-Math.abs(y[1])*2];ko(ae[0]>0&&ae[1]>0);const be=ae[0]/re[0],De=ae[1]/re[1],Oe=(R.right-R.left)/2/be,Ce=(R.top-R.bottom)/2/De,Ve=[(H[0]+N[0])/2+Oe,(H[1]+N[1])/2+Ce],Ee=Ec(Ve),dt=Math.min(f,cy(Math.abs(Math.min(be,De))));return ko(Number.isFinite(dt)),{longitude:Ee[0],latitude:Ee[1],zoom:dt}}function oR(n=0){return typeof n=="number"?{top:n,bottom:n,left:n,right:n}:(ko(Number.isFinite(n.top)&&Number.isFinite(n.bottom)&&Number.isFinite(n.left)&&Number.isFinite(n.right)),n)}const D1=Math.PI/180;function aR(n,e=0){const{width:i,height:l,unproject:u}=n,f={targetZ:e},y=u([0,l],f),a=u([i,l],f);let E,I;const O=n.fovy?.5*n.fovy*D1:Math.atan(.5/n.altitude),R=(90-n.pitch)*D1;return O>R-.01?(E=z1(n,0,e),I=z1(n,i,e)):(E=u([0,0],f),I=u([i,0],f)),[y,a,I,E]}function z1(n,e,i){const{pixelUnprojectionMatrix:l}=n,u=pc(l,[e,0,1,1]),f=pc(l,[e,n.height,1,1]),a=(i*n.distanceScales.unitsPerMeter[2]-u[2])/(f[2]-u[2]),E=Uw([],u,f,a),I=Ec(E);return I.push(i),I}const O1=512;function lR(n){const{width:e,height:i,pitch:l=0}=n;let{longitude:u,latitude:f,zoom:y,bearing:a=0}=n;(u<-180||u>180)&&(u=R1(u+180,360)-180),(a<-180||a>180)&&(a=R1(a+180,360)-180);const E=cy(i/O1);if(y<=E)y=E,f=0;else{const I=i/2/Math.pow(2,y),O=Ec([0,I])[1];if(f<O)f=O;else{const R=Ec([0,O1-I])[1];f>R&&(f=R)}}return{width:e,height:i,longitude:u,latitude:f,zoom:y,pitch:l,bearing:a}}const cR=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,uR=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture2D(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,hR=Np(gR),dR=Np(_R),fR=[0,0,0,1],pR=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function mR(n,e){const[i,l,u]=n,f=Up([i,l,u],e);return Number.isFinite(u)?f:[f[0],f[1],0]}function gR({viewport:n,center:e}){return new _s(n.viewProjectionMatrix).invert().transform(e)}function _R({viewport:n,shadowMatrices:e}){const i=[],l=n.pixelUnprojectionMatrix,u=n.isGeospatial?void 0:1,f=[[0,0,u],[n.width,0,u],[0,n.height,u],[n.width,n.height,u],[0,0,-1],[n.width,0,-1],[0,n.height,-1],[n.width,n.height,-1]].map(y=>mR(y,l));for(const y of e){const a=y.clone().translate(new co(n.center).negate()),E=f.map(O=>a.transform(O)),I=new _s().ortho({left:Math.min(...E.map(O=>O[0])),right:Math.max(...E.map(O=>O[0])),bottom:Math.min(...E.map(O=>O[1])),top:Math.max(...E.map(O=>O[1])),near:Math.min(...E.map(O=>-O[2])),far:Math.max(...E.map(O=>-O[2]))});i.push(I.multiplyRight(y))}return i}function yR(n,e){const{shadowEnabled:i=!0}=n;if(!i||!n.shadowMatrices||!n.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};const l={shadow_uDrawShadowMap:Boolean(n.drawToShadowMap),shadow_uUseShadowMap:n.shadowMaps?n.shadowMaps.length>0:!1,shadow_uColor:n.shadowColor||fR,shadow_uLightId:n.shadowLightId||0,shadow_uLightCount:n.shadowMatrices.length},u=hR({viewport:n.viewport,center:e.project_uCenter}),f=[],y=dR({shadowMatrices:n.shadowMatrices,viewport:n.viewport}).slice();for(let a=0;a<n.shadowMatrices.length;a++){const E=y[a],I=E.clone().translate(new co(n.viewport.center).negate());e.project_uCoordinateSystem===Pi.LNGLAT&&e.project_uProjectionMode===oo.WEB_MERCATOR?(y[a]=I,f[a]=u):(y[a]=E.clone().multiplyRight(pR),f[a]=I.transform(u))}for(let a=0;a<y.length;a++)l["shadow_uViewProjectionMatrices[".concat(a,"]")]=y[a],l["shadow_uProjectCenters[".concat(a,"]")]=f[a],n.shadowMaps&&n.shadowMaps.length>0?l["shadow_uShadowMap".concat(a)]=n.shadowMaps[a]:l["shadow_uShadowMap".concat(a)]=n.dummyShadowMap;return l}const Dg={name:"shadow",dependencies:[ay],vs:cR,fs:uR,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(n={},e={})=>"viewport"in n&&(n.drawToShadowMap||n.shadowMaps&&n.shadowMaps.length>0)?yR(n,e):{}},uy={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...ok},xR=[ay],vR=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function bR(n){const e=Hh.getDefaultProgramManager(n);for(const i of xR)e.addDefaultModule(i);for(const i of vR)e.addShaderHook(i);return e}const wR=[255,255,255],TR=1;let ER=0;class AR{constructor(e={}){G(this,"id",void 0),G(this,"color",void 0),G(this,"intensity",void 0),G(this,"type","ambient");const{color:i=wR}=e,{intensity:l=TR}=e;this.id=e.id||"ambient-".concat(ER++),this.color=i,this.intensity=l}}const SR=[255,255,255],MR=1,PR=[0,0,-1];let IR=0;class B1{constructor(e={}){G(this,"id",void 0),G(this,"color",void 0),G(this,"intensity",void 0),G(this,"type","directional"),G(this,"direction",void 0),G(this,"shadow",void 0);const{color:i=SR}=e,{intensity:l=MR}=e,{direction:u=PR}=e,{_shadow:f=!1}=e;this.id=e.id||"directional-".concat(IR++),this.color=i,this.intensity=l,this.type="directional",this.direction=new co(u).normalize().toArray(),this.shadow=f}getProjectedLight(e){return this}}class CR{constructor(e,i={id:"pass"}){G(this,"id",void 0),G(this,"gl",void 0),G(this,"props",void 0);const{id:l}=i;this.id=l,this.gl=e,this.props={...i}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Vp extends CR{constructor(...e){super(...e),G(this,"_lastRenderIndex",-1)}render(e){const i=this.gl;return Lo(i,{framebuffer:e.target}),this._drawLayers(e)}_drawLayers(e){const{target:i,moduleParameters:l,viewports:u,views:f,onViewportActive:y,clearStack:a=!0,clearCanvas:E=!0}=e;e.pass=e.pass||"unknown";const I=this.gl;E&&kR(I),a&&(this._lastRenderIndex=-1);const O=[];for(const R of u){const N=f&&f[R.id];y(R);const H=this._getDrawLayerParams(R,e),re=R.subViewports||[R];for(const ae of re){const be=this._drawLayersInViewport(I,{target:i,moduleParameters:l,viewport:ae,view:N,pass:e.pass,layers:e.layers},H);O.push(be)}}return O}_getDrawLayerParams(e,{layers:i,pass:l,layerFilter:u,cullRect:f,effects:y,moduleParameters:a}){const E=[],I=iT(this._lastRenderIndex+1),O={layer:i[0],viewport:e,isPicking:l.startsWith("picking"),renderPass:l,cullRect:f},R={};for(let N=0;N<i.length;N++){const H=i[N],re=this._shouldDrawLayer(H,O,u,R),ae={shouldDrawLayer:re};re&&(ae.layerRenderIndex=I(H,re),ae.moduleParameters=this._getModuleParameters(H,y,l,a),ae.layerParameters=this.getLayerParameters(H,N,e)),E[N]=ae}return E}_drawLayersInViewport(e,{layers:i,moduleParameters:l,pass:u,target:f,viewport:y,view:a},E){const I=LR(e,{moduleParameters:l,target:f,viewport:y});if(a&&a.props.clear){const R=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;gs(e,{scissorTest:!0,scissor:I},()=>Q_(e,R))}const O={totalCount:i.length,visibleCount:0,compositeCount:0,pickableCount:0};Lo(e,{viewport:I});for(let R=0;R<i.length;R++){const N=i[R],{shouldDrawLayer:H,layerRenderIndex:re,moduleParameters:ae,layerParameters:be}=E[R];if(H&&N.props.pickable&&O.pickableCount++,N.isComposite)O.compositeCount++;else if(H){O.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,re),ae.viewport=y;try{N._drawLayer({moduleParameters:ae,uniforms:{layerIndex:re},parameters:be})}catch(De){N.raiseError(De,"drawing ".concat(N," to ").concat(u))}}}return O}shouldDrawLayer(e){return!0}getModuleParameters(e,i){return null}getLayerParameters(e,i,l){return e.props.parameters}_shouldDrawLayer(e,i,l,u){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;i.layer=e;let y=e.parent;for(;y;){if(!y.props.visible||!y.filterSubLayer(i))return!1;i.layer=y,y=y.parent}if(l){const a=i.layer.id;if(a in u||(u[a]=l(i)),!u[a])return!1}return e.activateViewport(i.viewport),!0}_getModuleParameters(e,i,l,u){var f;const y=Object.assign(Object.create(((f=e.internalState)===null||f===void 0?void 0:f.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,pickingActive:0,devicePixelRatio:_c(this.gl)});if(i)for(const E of i){var a;Object.assign(y,(a=E.getModuleParameters)===null||a===void 0?void 0:a.call(E,e))}return Object.assign(y,this.getModuleParameters(e,i),u)}}function iT(n=0,e={}){const i={},l=(u,f)=>{const y=u.props._offset,a=u.id,E=u.parent&&u.parent.id;let I;if(E&&!(E in e)&&l(u.parent,!1),E in i){const O=i[E]=i[E]||iT(e[E],e);I=O(u,f),i[a]=O}else Number.isFinite(y)?(I=y+(e[E]||0),i[a]=null):I=n;return f&&I>=n&&(n=I+1),e[a]=I,I};return l}function LR(n,{moduleParameters:e,target:i,viewport:l}){const u=i&&i.id!=="default-framebuffer",f=e&&e.devicePixelRatio||_c(n),y=u?i.height:n.drawingBufferHeight,a=l;return[a.x*f,y-(a.y+a.height)*f,a.width*f,a.height*f]}function kR(n){const e=n.drawingBufferWidth,i=n.drawingBufferHeight;Lo(n,{viewport:[0,0,e,i]}),n.clear(16640)}class RR extends Vp{constructor(e,i){super(e,i),G(this,"shadowMap",void 0),G(this,"depthBuffer",void 0),G(this,"fbo",void 0),this.shadowMap=new qr(e,{width:1,height:1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.depthBuffer=new uc(e,{format:33189,width:1,height:1}),this.fbo=new En(e,{id:"shadowmap",width:1,height:1,attachments:{[36064]:this.shadowMap,[36096]:this.depthBuffer}})}render(e){const i=this.fbo;gs(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},()=>{const l=e.viewports[0],u=_c(this.gl),f=l.width*u,y=l.height*u;(f!==i.width||y!==i.height)&&i.resize({width:f,height:y}),super.render({...e,target:i,pass:"shadow"})})}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}}const DR={color:[255,255,255],intensity:1},F1=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],zR=[0,0,0,200/255];class nT{constructor(e={}){G(this,"id","lighting-effect"),G(this,"props",null),G(this,"shadowColor",zR),G(this,"shadow",void 0),G(this,"ambientLight",null),G(this,"directionalLights",[]),G(this,"pointLights",[]),G(this,"shadowPasses",[]),G(this,"shadowMaps",[]),G(this,"dummyShadowMap",null),G(this,"programManager",void 0),G(this,"shadowMatrices",void 0);for(const i in e){const l=e[i];switch(l.type){case"ambient":this.ambientLight=l;break;case"directional":this.directionalLights.push(l);break;case"point":this.pointLights.push(l);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(i=>i.shadow)}preRender(e,{layers:i,layerFilter:l,viewports:u,onViewportActive:f,views:y}){if(!!this.shadow){this.shadowMatrices=this._calculateMatrices(),this.shadowPasses.length===0&&this._createShadowPasses(e),this.programManager||(this.programManager=Hh.getDefaultProgramManager(e),Dg&&this.programManager.addDefaultModule(Dg)),this.dummyShadowMap||(this.dummyShadowMap=new qr(e,{width:1,height:1}));for(let a=0;a<this.shadowPasses.length;a++)this.shadowPasses[a].render({layers:i,layerFilter:l,viewports:u,onViewportActive:f,views:y,moduleParameters:{shadowLightId:a,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){const i=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return i.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(l=>l.getProjectedLight({layer:e})),pointLights:this.pointLights.map(l=>l.getProjectedLight({layer:e}))},i}cleanup(){for(const e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(Dg),this.programManager=null)}_calculateMatrices(){const e=[];for(const i of this.directionalLights){const l=new _s().lookAt({eye:new co(i.direction).negate()});e.push(l)}return e}_createShadowPasses(e){for(let i=0;i<this.directionalLights.length;i++){const l=new RR(e);this.shadowPasses[i]=l,this.shadowMaps[i]=l.shadowMap}}_applyDefaultLights(){const{ambientLight:e,pointLights:i,directionalLights:l}=this;!e&&i.length===0&&l.length===0&&(this.ambientLight=new AR(DR),this.directionalLights.push(new B1(F1[0]),new B1(F1[1])))}}class OR{constructor(e={}){G(this,"_pool",[]),G(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,i,{size:l=1,type:u,padding:f=0,copy:y=!1,initialize:a=!1,maxCount:E}){const I=u||e&&e.constructor||Float32Array,O=i*l+f;if(ArrayBuffer.isView(e)){if(O<=e.length)return e;if(O*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new I(e.buffer,0,O)}let R=1/0;E&&(R=E*l+f);const N=this._allocate(I,O,a,R);return e&&y?N.set(e):a||N.fill(0,0,4),this._release(e),N}release(e){this._release(e)}_allocate(e,i,l,u){let f=Math.max(Math.ceil(i*this.opts.overAlloc),1);f>u&&(f=u);const y=this._pool,a=e.BYTES_PER_ELEMENT*f,E=y.findIndex(I=>I.byteLength>=a);if(E>=0){const I=new e(y.splice(E,1)[0],0,f);return l&&I.fill(0),I}return new e(f)}_release(e){if(!ArrayBuffer.isView(e))return;const i=this._pool,{buffer:l}=e,{byteLength:u}=l,f=i.findIndex(y=>y.byteLength>=u);f<0?i.push(l):(f>0||i.length<this.opts.poolSize)&&i.splice(f,0,l),i.length>this.opts.poolSize&&i.shift()}}const Ac=new OR;function yh(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function BR(n,e){const i=n%e;return i<0?e+i:i}function FR(n){return[n[12],n[13],n[14]]}function NR(n){return{left:oc(n[3]+n[0],n[7]+n[4],n[11]+n[8],n[15]+n[12]),right:oc(n[3]-n[0],n[7]-n[4],n[11]-n[8],n[15]-n[12]),bottom:oc(n[3]+n[1],n[7]+n[5],n[11]+n[9],n[15]+n[13]),top:oc(n[3]-n[1],n[7]-n[5],n[11]-n[9],n[15]-n[13]),near:oc(n[3]+n[2],n[7]+n[6],n[11]+n[10],n[15]+n[14]),far:oc(n[3]-n[2],n[7]-n[6],n[11]-n[10],n[15]-n[14])}}const N1=new co;function oc(n,e,i,l){N1.set(n,e,i);const u=N1.len();return{distance:l/u,normal:new co(-n/u,-e/u,-i/u)}}function UR(n){return n-Math.fround(n)}let ph;function zg(n,e){const{size:i=1,startIndex:l=0}=e,u=e.endIndex!==void 0?e.endIndex:n.length,f=(u-l)/i;ph=Ac.allocate(ph,f,{type:Float32Array,size:i*2});let y=l,a=0;for(;y<u;){for(let E=0;E<i;E++){const I=n[y++];ph[a+E]=I,ph[a+E+i]=UR(I)}a+=i*2}return ph.subarray(0,f*i*2)}const VR=Math.PI/180,jR=yh(),U1=[0,0,0],GR={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function WR({width:n,height:e,orthographic:i,fovyRadians:l,focalDistance:u,padding:f,near:y,far:a}){const E=n/e,I=i?new _s().orthographic({fovy:l,aspect:E,focalDistance:u,near:y,far:a}):new _s().perspective({fovy:l,aspect:E,near:y,far:a});if(f){const{left:O=0,right:R=0,top:N=0,bottom:H=0}=f,re=Kn((O+n-R)/2,0,n)-n/2,ae=Kn((N+e-H)/2,0,e)-e/2;I[8]-=re*2/n,I[9]+=ae*2/e}return I}class Ja{constructor(e={}){G(this,"id",void 0),G(this,"x",void 0),G(this,"y",void 0),G(this,"width",void 0),G(this,"height",void 0),G(this,"padding",void 0),G(this,"isGeospatial",void 0),G(this,"zoom",void 0),G(this,"focalDistance",void 0),G(this,"position",void 0),G(this,"modelMatrix",void 0),G(this,"distanceScales",void 0),G(this,"scale",void 0),G(this,"center",void 0),G(this,"cameraPosition",void 0),G(this,"projectionMatrix",void 0),G(this,"viewMatrix",void 0),G(this,"viewMatrixUncentered",void 0),G(this,"viewMatrixInverse",void 0),G(this,"viewProjectionMatrix",void 0),G(this,"pixelProjectionMatrix",void 0),G(this,"pixelUnprojectionMatrix",void 0),G(this,"resolution",void 0),G(this,"_frustumPlanes",{}),this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||GR,this.focalDistance=e.focalDistance||1,this.position=e.position||U1,this.modelMatrix=e.modelMatrix||null;const{longitude:i,latitude:l}=e;this.isGeospatial=Number.isFinite(l)&&Number.isFinite(i),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?oo.WEB_MERCATOR:oo.WEB_MERCATOR_AUTO_OFFSET:oo.IDENTITY}equals(e){return e instanceof Ja?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&wc(e.projectionMatrix,this.projectionMatrix)&&wc(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:i=!0}={}){const l=this.projectPosition(e),u=eT(l,this.pixelProjectionMatrix),[f,y]=u,a=i?y:this.height-y;return e.length===2?[f,a]:[f,a,u[2]]}unproject(e,{topLeft:i=!0,targetZ:l}={}){const[u,f,y]=e,a=i?f:this.height-f,E=l&&l*this.distanceScales.unitsPerMeter[2],I=Up([u,a,y],this.pixelUnprojectionMatrix,E),[O,R,N]=this.unprojectPosition(I);return Number.isFinite(y)?[O,R,N]:Number.isFinite(l)?[O,R,l]:[O,R]}projectPosition(e){const[i,l]=this.projectFlat(e),u=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[i,l,u]}unprojectPosition(e){const[i,l]=this.unprojectFlat(e),u=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[i,l,u]}projectFlat(e){if(this.isGeospatial){const i=wp(e);return i[1]=Kn(i[1],-318,830),i}return e}unprojectFlat(e){return this.isGeospatial?Ec(e):e}getBounds(e={}){const i={targetZ:e.z||0},l=this.unproject([0,0],i),u=this.unproject([this.width,0],i),f=this.unproject([0,this.height],i),y=this.unproject([this.width,this.height],i);return[Math.min(l[0],u[0],f[0],y[0]),Math.min(l[1],u[1],f[1],y[1]),Math.max(l[0],u[0],f[0],y[0]),Math.max(l[1],u[1],f[1],y[1])]}getDistanceScales(e){return e?b_({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:i,width:l=1,height:u=1}){return e<this.x+this.width&&this.x<e+l&&i<this.y+this.height&&this.y<i+u}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,NR(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,i){return null}_initProps(e){const i=e.longitude,l=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=nR({latitude:l})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||b_({latitude:l,longitude:i}));const u=Math.pow(2,this.zoom);this.scale=u;const{position:f,modelMatrix:y}=e;let a=U1;if(f&&(a=y?new _s(y).transformAsVector(f,[]):f),this.isGeospatial){const E=this.projectPosition([i,l,0]);this.center=new co(a).scale(this.distanceScales.unitsPerMeter).add(E)}else this.center=this.projectPosition(a)}_initMatrices(e){const{viewMatrix:i=jR,projectionMatrix:l=null,orthographic:u=!1,fovyRadians:f,fovy:y=75,near:a=.1,far:E=1e3,padding:I=null,focalDistance:O=1}=e;this.viewMatrixUncentered=i,this.viewMatrix=new _s().multiplyRight(i).translate(new co(this.center).negate()),this.projectionMatrix=l||WR({width:this.width,height:this.height,orthographic:u,fovyRadians:f||y*VR,focalDistance:O,padding:I,near:a,far:E});const R=yh();qa(R,R,this.projectionMatrix),qa(R,R,this.viewMatrix),this.viewProjectionMatrix=R,this.viewMatrixInverse=g_([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=FR(this.viewMatrixInverse);const N=yh(),H=yh();ry(N,N,[this.width/2,-this.height/2,1]),vp(N,N,[1,-1,0]),qa(H,N,this.viewProjectionMatrix),this.pixelProjectionMatrix=H,this.pixelUnprojectionMatrix=g_(yh(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||Bi.warn("Pixel project matrix not invertible")()}}G(Ja,"displayName","Viewport");const ZR=512,$R=4003e4,qR=Math.PI/180;function V1(n){const e=Math.cos(n*qR);return ZR/$R/e}class Ro extends Ja{constructor(e={}){const{latitude:i=0,longitude:l=0,zoom:u=0,pitch:f=0,bearing:y=0,nearZMultiplier:a=.1,farZMultiplier:E=1.01,orthographic:I=!1,projectionMatrix:O,repeat:R=!1,worldOffset:N=0,legacyMeterSizes:H=!1}=e;let{width:re,height:ae,altitude:be=1.5}=e;const De=Math.pow(2,u);re=re||1,ae=ae||1;let Oe,Ce=null;O?(be=O[5]/2,Oe=Tp(be)):(e.fovy?(Oe=e.fovy,be=Qw(Oe)):Oe=Tp(be),Ce=sR({width:re,height:ae,pitch:f,fovy:Oe,nearZMultiplier:a,farZMultiplier:E}));let Ve=rR({height:ae,pitch:f,bearing:y,scale:De,altitude:be});N&&(Ve=new _s().translate([512*N,0,0]).multiplyLeft(Ve)),super({...e,width:re,height:ae,viewMatrix:Ve,longitude:l,latitude:i,zoom:u,...Ce,fovy:Oe,focalDistance:be}),G(this,"longitude",void 0),G(this,"latitude",void 0),G(this,"pitch",void 0),G(this,"bearing",void 0),G(this,"altitude",void 0),G(this,"fovy",void 0),G(this,"orthographic",void 0),G(this,"_subViewports",void 0),G(this,"_pseudoMeters",void 0),this.latitude=i,this.longitude=l,this.zoom=u,this.pitch=f,this.bearing=y,this.altitude=be,this.fovy=Oe,this.orthographic=I,this._subViewports=R?[]:null,this._pseudoMeters=H,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),i=Math.floor((e[0]+180)/360),l=Math.ceil((e[2]-180)/360);for(let u=i;u<=l;u++){const f=u?new Ro({...this,worldOffset:u}):this;this._subViewports.push(f)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[i,l]=this.projectFlat(e),u=(e[2]||0)*V1(e[1]);return[i,l,u]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[i,l]=this.unprojectFlat(e),u=(e[2]||0)/V1(l);return[i,l,u]}addMetersToLngLat(e,i){return Jw(e,i)}panByPosition(e,i){const l=Up(i,this.pixelUnprojectionMatrix),u=this.projectFlat(e),f=xp([],u,Nw([],l)),y=xp([],this.center,f),[a,E]=this.unprojectFlat(y);return{longitude:a,latitude:E}}getBounds(e={}){const i=aR(this,e.z||0);return[Math.min(i[0][0],i[1][0],i[2][0],i[3][0]),Math.min(i[0][1],i[1][1],i[2][1],i[3][1]),Math.max(i[0][0],i[1][0],i[2][0],i[3][0]),Math.max(i[0][1],i[1][1],i[2][1],i[3][1])]}fitBounds(e,i={}){const{width:l,height:u}=this,{longitude:f,latitude:y,zoom:a}=tT({width:l,height:u,bounds:e,...i});return new Ro({width:l,height:u,longitude:f,latitude:y,zoom:a})}}G(Ro,"displayName","WebMercatorViewport");function Og(n,e,i=!1){const l=e.projectPosition(n);if(i&&e instanceof Ro){const[u,f,y=0]=n,a=e.getDistanceScales([u,f]);l[2]=y*a.unitsPerMeter[2]}return l}function HR(n){const{viewport:e,modelMatrix:i,coordinateOrigin:l}=n;let{coordinateSystem:u,fromCoordinateSystem:f,fromCoordinateOrigin:y}=n;return u===Pi.DEFAULT&&(u=e.isGeospatial?Pi.LNGLAT:Pi.CARTESIAN),f===void 0&&(f=u),y===void 0&&(y=l),{viewport:e,coordinateSystem:u,coordinateOrigin:l,modelMatrix:i,fromCoordinateSystem:f,fromCoordinateOrigin:y}}function rT(n,{viewport:e,modelMatrix:i,coordinateSystem:l,coordinateOrigin:u,offsetMode:f}){let[y,a,E=0]=n;switch(i&&([y,a,E]=qh([],[y,a,E,1],i)),l){case Pi.LNGLAT:return Og([y,a,E],e,f);case Pi.LNGLAT_OFFSETS:return Og([y+u[0],a+u[1],E+(u[2]||0)],e,f);case Pi.METER_OFFSETS:return Og(Jw(u,[y,a,E]),e,f);case Pi.CARTESIAN:default:return e.isGeospatial?[y+u[0],a+u[1],E+u[2]]:e.projectPosition([y,a,E])}}function XR(n,e){const{viewport:i,coordinateSystem:l,coordinateOrigin:u,modelMatrix:f,fromCoordinateSystem:y,fromCoordinateOrigin:a}=HR(e),{geospatialOrigin:E,shaderCoordinateOrigin:I,offsetMode:O}=Yw(i,l,u),R=rT(n,{viewport:i,modelMatrix:f,coordinateSystem:y,coordinateOrigin:a,offsetMode:O});if(O){const N=i.projectPosition(E||I);CL(R,R,N)}return R}const cc={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Ep=Symbol.for("component"),mc=Symbol.for("asyncPropDefaults"),Xa=Symbol.for("asyncPropOriginal"),oa=Symbol.for("asyncPropResolved");function Sc(n,e=()=>!0){return Array.isArray(n)?sT(n,e,[]):e(n)?[n]:[]}function sT(n,e,i){let l=-1;for(;++l<n.length;){const u=n[l];Array.isArray(u)?sT(u,e,i):e(u)&&i.push(u)}return i}function YR({target:n,source:e,start:i=0,count:l=1}){const u=e.length,f=l*u;let y=0;for(let a=i;y<u;y++)n[a++]=e[y];for(;y<f;)y<f-y?(n.copyWithin(i+y,i,i+y),y*=2):(n.copyWithin(i+y,i,i+f-y),y=f);return n}class KR{constructor(e,i,l){G(this,"id",void 0),G(this,"context",void 0),G(this,"isLoaded",void 0),G(this,"persistent",void 0),G(this,"_loadCount",0),G(this,"_subscribers",new Set),G(this,"_data",void 0),G(this,"_loader",void 0),G(this,"_error",void 0),G(this,"_content",void 0),this.id=e,this.context=l,this.setData(i)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,i){if(e===this._data&&!i)return;this._data=e;const l=++this._loadCount;let u=e;typeof e=="string"&&(u=r_(e)),u instanceof Promise?(this.isLoaded=!1,this._loader=u.then(f=>{this._loadCount===l&&(this.isLoaded=!0,this._error=void 0,this._content=f)}).catch(f=>{this._loadCount===l&&(this.isLoaded=!0,this._error=f||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const f of this._subscribers)f.onChange(this.getData())}}class JR{constructor({gl:e,protocol:i}){G(this,"protocol",void 0),G(this,"_context",void 0),G(this,"_resources",void 0),G(this,"_consumers",void 0),G(this,"_pruneRequest",void 0),this.protocol=i||"resource://",this._context={gl:e,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:i,forceUpdate:l=!1,persistent:u=!0}){let f=this._resources[e];f?f.setData(i,l):(f=new KR(e,i,this._context),this._resources[e]=f),f.persistent=u}remove(e){const i=this._resources[e];i&&(i.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const i=this._consumers[e];if(i){for(const l in i){const u=i[l],f=this._resources[u.resourceId];f&&f.unsubscribe(u)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:i,consumerId:l,requestId:u="default"}){const{_resources:f,protocol:y}=this;e.startsWith(y)&&(e=e.replace(y,""),f[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=f[e];if(this._track(l,u,a,i),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,i,l,u){const f=this._consumers,y=f[e]=f[e]||{},a=y[i]||{},E=a.resourceId&&this._resources[a.resourceId];E&&(E.unsubscribe(a),this.prune()),l&&(y[i]=a,a.onChange=u,a.resourceId=l.id,l.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const i=this._resources[e];!i.persistent&&!i.inUse()&&(i.delete(),delete this._resources[e])}}}const QR="layerManager.setLayers",eD="layerManager.activateViewport";class tD{constructor(e,{deck:i,stats:l,viewport:u,timeline:f}={}){G(this,"layers",void 0),G(this,"context",void 0),G(this,"resourceManager",void 0),G(this,"_lastRenderedLayers",[]),G(this,"_needsRedraw",!1),G(this,"_needsUpdate",!1),G(this,"_nextLayers",null),G(this,"_debug",!1),G(this,"activateViewport",y=>{cr(eD,this,y),y&&(this.context.viewport=y)}),this.layers=[],this.resourceManager=new JR({gl:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:e,deck:i,programManager:e&&bR(e),stats:l||new W_({id:"deck.gl"}),viewport:u||new Ja({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:f||new $w,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let i=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const l of this.layers){const u=l.getNeedsRedraw(e);i=i||u}return i}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(i=>e.find(l=>i.id.indexOf(l)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,i){cr(QR,this,i,e),this._lastRenderedLayers=e;const l=Sc(e,Boolean);for(const u of l)u.context=this.context;this._updateLayers(this.layers,l)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw("updating layers: ".concat(e)),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}_handleError(e,i,l){l.raiseError(i,"".concat(e," of ").concat(l))}_updateLayers(e,i){const l={};for(const y of e)l[y.id]?Bi.warn("Multiple old layers with same id ".concat(y.id))():l[y.id]=y;const u=[];this._updateSublayersRecursively(i,l,u),this._finalizeOldLayers(l);let f=!1;for(const y of u)if(y.hasUniformTransition()){f="Uniform transition in ".concat(y);break}this._needsUpdate=f,this.layers=u}_updateSublayersRecursively(e,i,l){for(const u of e){u.context=this.context;const f=i[u.id];f===null&&Bi.warn("Multiple new layers with same id ".concat(u.id))(),i[u.id]=null;let y=null;try{this._debug&&f!==u&&u.validateProps(),f?(this._transferLayerState(f,u),this._updateLayer(u)):this._initializeLayer(u),l.push(u),y=u.isComposite?u.getSubLayers():null}catch(a){this._handleError("matching",a,u)}y&&this._updateSublayersRecursively(y,i,l)}}_finalizeOldLayers(e){for(const i in e){const l=e[i];l&&this._finalizeLayer(l)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=cc.INITIALIZED}catch(i){this._handleError("initialization",i,e)}}_transferLayerState(e,i){i._transferState(e),i.lifecycle=cc.MATCHED,i!==e&&(e.lifecycle=cc.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(i){this._handleError("update",i,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||"finalized ".concat(e),e.lifecycle=cc.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=cc.FINALIZED}catch(i){this._handleError("finalization",i,e)}}}function Lc(n,e){if(n===e)return!0;if(!n||!e)return!1;for(const i in n){const l=n[i],u=e[i];if(!(l===u||Array.isArray(l)&&Array.isArray(u)&&Lc(l,u)))return!1}return!0}class iD{constructor(e){G(this,"width",void 0),G(this,"height",void 0),G(this,"views",void 0),G(this,"viewState",void 0),G(this,"controllers",void 0),G(this,"timeline",void 0),G(this,"_viewports",void 0),G(this,"_viewportMap",void 0),G(this,"_isUpdating",void 0),G(this,"_needsRedraw",void 0),G(this,"_needsUpdate",void 0),G(this,"_eventManager",void 0),G(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const i=this.controllers[e];i&&i.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const i=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),i}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const i=this.controllers[e];i&&i.updateTransition()}}getViewports(e){return e?this._viewports.filter(i=>i.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(i=>{e[i.id]=i}),e}getView(e){return this.views.find(i=>i.id===e)}getViewState(e){const i=typeof e=="string"?this.getView(e):e,l=i&&this.viewState[i.getViewStateId()]||this.viewState;return i?i.filterViewState(l):l}getViewport(e){return this._viewportMap[e]}unproject(e,i){const l=this.getViewports(),u={x:e[0],y:e[1]};for(let f=l.length-1;f>=0;--f){const y=l[f];if(y.containsPixel(u)){const a=e.slice();return a[0]-=y.x,a[1]-=y.y,y.unproject(a,i)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,i){(e!==this.width||i!==this.height)&&(this.width=e,this.height=i,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Sc(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!Lc(e,this.viewState)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):Bi.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(e,i){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...i,viewId:e})}_createController(e,i){const l=i.type;return new l({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,i.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:f=>{var y;return(y=this.getView(e.id))===null||y===void 0?void 0:y.makeViewport({viewState:f,width:this.width,height:this.height})}})}_updateController(e,i,l,u){const f=e.controller;if(f){const y={...i,...f,id:e.id,x:l.x,y:l.y,width:l.width,height:l.height};return u||(u=this._createController(e,y)),u&&u.setProps(y),u}return null}_rebuildViewports(){const{views:e}=this,i=this.controllers;this._viewports=[],this.controllers={};let l=!1;for(let u=e.length;u--;){const f=e[u],y=this.getViewState(f),a=f.makeViewport({viewState:y,width:this.width,height:this.height});let E=i[f.id];const I=Boolean(f.controller);I&&!E&&(l=!0),(l||!I)&&E&&(E.finalize(),E=null),this.controllers[f.id]=this._updateController(f,y,a,E),this._viewports.unshift(a)}for(const u in i){const f=i[u];f&&!this.controllers[u]&&f.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,i){return e.length!==i.length?!0:e.some((l,u)=>!e[u].equals(i[u]))}}const nD=/([0-9]+\.?[0-9]*)(%|px)/;function na(n){switch(typeof n){case"number":return{position:n,relative:!1};case"string":const e=nD.exec(n);if(e&&e.length>=3){const i=e[2]==="%",l=parseFloat(e[1]);return{position:i?l/100:l,relative:i}}default:throw new Error("Could not parse position string ".concat(n))}}function ra(n,e){return n.relative?Math.round(n.position*e):n.position}function wn(n,e){if(!n)throw new Error(e||"deck.gl: assertion failed.")}class oT{constructor(e){G(this,"id",void 0),G(this,"viewportInstance",void 0),G(this,"_x",void 0),G(this,"_y",void 0),G(this,"_width",void 0),G(this,"_height",void 0),G(this,"_padding",void 0),G(this,"props",void 0);const{id:i,x:l=0,y:u=0,width:f="100%",height:y="100%",padding:a=null,viewportInstance:E}=e||{};wn(!E||E instanceof Ja),this.viewportInstance=E,this.id=i||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=na(l),this._y=na(u),this._width=na(f),this._height=na(y),this._padding=a&&{left:na(a.left||0),right:na(a.right||0),top:na(a.top||0),bottom:na(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.viewportInstance?e.viewportInstance?this.viewportInstance.equals(e.viewportInstance):!1:this.ViewportType===e.ViewportType&&Lc(this.props,e.props)}makeViewport({width:e,height:i,viewState:l}){if(this.viewportInstance)return this.viewportInstance;l=this.filterViewState(l);const u=this.getDimensions({width:e,height:i});return new this.ViewportType({...l,...this.props,...u})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const i={...e};for(const l in this.props.viewState)l!=="id"&&(i[l]=this.props.viewState[l]);return i}return e}getDimensions({width:e,height:i}){const l={x:ra(this._x,e),y:ra(this._y,i),width:ra(this._width,e),height:ra(this._height,i)};return this._padding&&(l.padding={left:ra(this._padding.left,e),top:ra(this._padding.top,i),right:ra(this._padding.right,e),bottom:ra(this._padding.bottom,i)}),l}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class Yh{constructor(e){G(this,"_inProgress",void 0),G(this,"_handle",void 0),G(this,"_timeline",void 0),G(this,"time",void 0),G(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=e,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(e){var i,l;this.cancel(),this.settings=e,this._inProgress=!0,(i=(l=this.settings).onStart)===null||i===void 0||i.call(l,this)}end(){if(this._inProgress){var e,i;this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(e=(i=this.settings).onEnd)===null||e===void 0||e.call(i,this)}}cancel(){if(this._inProgress){var e,i;(e=(i=this.settings).onInterrupt)===null||e===void 0||e.call(i,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1}}update(){var e,i;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:l,settings:u}=this;this._handle=l.addChannel({delay:l.getTime(),duration:u.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(e=(i=this.settings).onUpdate)===null||e===void 0||e.call(i,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const j1=()=>{},w_={BREAK:1,SNAP_TO_END:2,IGNORE:3},rD=n=>n,sD=w_.BREAK;class oD{constructor(e){G(this,"getControllerState",void 0),G(this,"props",void 0),G(this,"propsInTransition",void 0),G(this,"transition",void 0),G(this,"onViewStateChange",void 0),G(this,"onStateChange",void 0),G(this,"_onTransitionUpdate",i=>{const{time:l,settings:{interpolator:u,startProps:f,endProps:y,duration:a,easing:E}}=i,I=E(l/a),O=u.interpolateProps(f,y,I);this.propsInTransition=this.getControllerState({...this.props,...O}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})}),this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new Yh(e.timeline),this.onViewStateChange=e.onViewStateChange||j1,this.onStateChange=e.onStateChange||j1}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let i=!1;const l=this.props;if(this.props=e,!l||this._shouldIgnoreViewportChange(l,e))return!1;if(this._isTransitionEnabled(e)){let u=l;if(this.transition.inProgress){const{interruption:f,endProps:y}=this.transition.settings;u={...l,...f===w_.SNAP_TO_END?y:this.propsInTransition||l}}this._triggerTransition(u,e),i=!0}else this.transition.cancel();return i}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:i,transitionInterpolator:l}=e;return(i>0||i==="auto")&&Boolean(l)}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,i){return this.transition.inProgress?this.transition.settings.interruption===w_.IGNORE||this._isUpdateDueToCurrentTransition(i):this._isTransitionEnabled(i)?i.transitionInterpolator.arePropsEqual(e,i):!0}_triggerTransition(e,i){const l=this.getControllerState(e),u=this.getControllerState(i).shortestPathFrom(l),f=i.transitionInterpolator,y=f.getDuration?f.getDuration(e,i):i.transitionDuration;if(y===0)return;const a=f.initializeProps(e,u);this.propsInTransition={};const E={duration:y,easing:i.transitionEasing||rD,interpolator:f,interruption:i.transitionInterruption||sD,startProps:a.start,endProps:a.end,onStart:i.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(i.onTransitionInterrupt),onEnd:this._onTransitionEnd(i.onTransitionEnd)};this.transition.start(E),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return i=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(i)}}}class aD{constructor(e){G(this,"_propsToCompare",void 0),G(this,"_propsToExtract",void 0),G(this,"_requiredProps",void 0);const{compare:i,extract:l,required:u}=e;this._propsToCompare=i,this._propsToExtract=l||i,this._requiredProps=u}arePropsEqual(e,i){for(const l of this._propsToCompare)if(!(l in e)||!(l in i)||!wc(e[l],i[l]))return!1;return!0}initializeProps(e,i){const l={},u={};for(const f of this._propsToExtract)(f in e||f in i)&&(l[f]=e[f],u[f]=i[f]);return this._checkRequiredProps(l),this._checkRequiredProps(u),{start:l,end:u}}getDuration(e,i){return i.transitionDuration}_checkRequiredProps(e){!this._requiredProps||this._requiredProps.forEach(i=>{const l=e[i];wn(Number.isFinite(l)||Array.isArray(l),"".concat(i," is required for transition"))})}}const lD=["longitude","latitude","zoom","bearing","pitch"],cD=["longitude","latitude","zoom"];class hy extends aD{constructor(e={}){const i=Array.isArray(e)?e:e.transitionProps,l=Array.isArray(e)?{}:e;l.transitionProps=Array.isArray(i)?{compare:i,required:i}:i||{compare:lD,required:cD},super(l.transitionProps),G(this,"opts",void 0),this.opts=l}initializeProps(e,i){const l=super.initializeProps(e,i),{makeViewport:u,around:f}=this.opts;if(u&&f){const y=u(e),a=u(i),E=y.unproject(f);l.start.around=f,Object.assign(l.end,{around:a.project(E),aroundPosition:E,width:i.width,height:i.height})}return l}interpolateProps(e,i,l){const u={};for(const f of this._propsToExtract)u[f]=yp(e[f]||0,i[f]||0,l);if(i.aroundPosition&&this.opts.makeViewport){const f=this.opts.makeViewport({...i,...u});Object.assign(u,f.panByPosition(i.aroundPosition,yp(e.around,i.around,l)))}return u}}const sa={transitionDuration:0},uD=300,$f=n=>1-(1-n)*(1-n),ac={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},Va={};class aT{constructor(e){G(this,"props",void 0),G(this,"state",{}),G(this,"transitionManager",void 0),G(this,"eventManager",void 0),G(this,"onViewStateChange",void 0),G(this,"onStateChange",void 0),G(this,"makeViewport",void 0),G(this,"_controllerState",void 0),G(this,"_events",{}),G(this,"_interactionState",{isDragging:!1}),G(this,"_customEvents",[]),G(this,"_eventStartBlocked",null),G(this,"_panMove",!1),G(this,"invertPan",!1),G(this,"dragMode","rotate"),G(this,"inertia",0),G(this,"scrollZoom",!0),G(this,"dragPan",!0),G(this,"dragRotate",!0),G(this,"doubleClickZoom",!0),G(this,"touchZoom",!0),G(this,"touchRotate",!1),G(this,"keyboard",!0),this.transitionManager=new oD({...e,getControllerState:i=>new this.ControllerState(i),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(const i in this._events)if(this._events[i]){var e;(e=this.eventManager)===null||e===void 0||e.off(i,this.handleEvent)}this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const i=this._eventStartBlocked;switch(e.type){case"panstart":return i?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return i?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return i?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:i,y:l}=this.props,{offsetCenter:u}=e;return[u.x-i,u.y-l]}isPointInBounds(e,i){const{width:l,height:u}=this.props;if(i&&i.handled)return!1;const f=e[0]>=0&&e[0]<=l&&e[1]>=0&&e[1]<=u;return f&&i&&i.stopPropagation(),f}isFunctionKeyPressed(e){const{srcEvent:i}=e;return Boolean(i.metaKey||i.altKey||i.ctrlKey||i.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const i=setTimeout(()=>{this._eventStartBlocked===i&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=i}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:i}=e;this.inertia=Number.isFinite(i)?i:i===!0?uD:0;const{scrollZoom:l=!0,dragPan:u=!0,dragRotate:f=!0,doubleClickZoom:y=!0,touchZoom:a=!0,touchRotate:E=!1,keyboard:I=!0}=e,O=Boolean(this.onViewStateChange);this.toggleEvents(ac.WHEEL,O&&l),this.toggleEvents(ac.PAN,O&&(u||f)),this.toggleEvents(ac.PINCH,O&&(a||E)),this.toggleEvents(ac.TRIPLE_PAN,O&&E),this.toggleEvents(ac.DOUBLE_TAP,O&&y),this.toggleEvents(ac.KEYBOARD,O&&I),this.scrollZoom=l,this.dragPan=u,this.dragRotate=f,this.doubleClickZoom=y,this.touchZoom=a,this.touchRotate=E,this.keyboard=I}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,i){this.eventManager&&e.forEach(l=>{this._events[l]!==i&&(this._events[l]=i,i?this.eventManager.on(l,this.handleEvent):this.eventManager.off(l,this.handleEvent))})}updateViewport(e,i=null,l={}){const u={...e.getViewportProps(),...i},f=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(l),f){const y=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:u,interactionState:this._interactionState,oldViewState:y})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;let l=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(l=!l);const u=this.controllerState[l?"panStart":"rotateStart"]({pos:i});return this._panMove=l,this.updateViewport(u,sa,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const i=this.getCenter(e),l=this.controllerState.pan({pos:i});return this.updateViewport(l,sa,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:i}=this;if(this.dragPan&&i&&e.velocity){const l=this.getCenter(e),u=[l[0]+e.velocityX*i/2,l[1]+e.velocityY*i/2],f=this.controllerState.pan({pos:u}).panEnd();this.updateViewport(f,{...this._getTransitionProps(),transitionDuration:i,transitionEasing:$f},{isDragging:!1,isPanning:!0})}else{const l=this.controllerState.panEnd();this.updateViewport(l,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const i=this.getCenter(e),l=this.controllerState.rotate({pos:i});return this.updateViewport(l,sa,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:i}=this;if(this.dragRotate&&i&&e.velocity){const l=this.getCenter(e),u=[l[0]+e.velocityX*i/2,l[1]+e.velocityY*i/2],f=this.controllerState.rotate({pos:u}).rotateEnd();this.updateViewport(f,{...this._getTransitionProps(),transitionDuration:i,transitionEasing:$f},{isDragging:!1,isRotating:!0})}else{const l=this.controllerState.rotateEnd();this.updateViewport(l,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;e.srcEvent.preventDefault();const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;const{speed:l=.01,smooth:u=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:f}=e;let y=2/(1+Math.exp(-Math.abs(f*l)));f<0&&y!==0&&(y=1/y);const a=this.controllerState.zoom({pos:i,scale:y});return this.updateViewport(a,{...this._getTransitionProps({around:i}),transitionDuration:u?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;const l=this.controllerState.rotateStart({pos:i});return this.updateViewport(l,sa,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;const i=this.getCenter(e);i[0]-=e.deltaX;const l=this.controllerState.rotate({pos:i});return this.updateViewport(l,sa,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;const{inertia:i}=this;if(this.touchRotate&&i&&e.velocityY){const l=this.getCenter(e),u=[l[0],l[1]+=e.velocityY*i/2],f=this.controllerState.rotate({pos:u});this.updateViewport(f,{...this._getTransitionProps(),transitionDuration:i,transitionEasing:$f},{isDragging:!1,isRotating:!0}),this.blockEvents(i)}else{const l=this.controllerState.rotateEnd();this.updateViewport(l,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;const l=this.controllerState.zoomStart({pos:i}).rotateStart({pos:i});return Va._startPinchRotation=e.rotation,Va._lastPinchEvent=e,this.updateViewport(l,sa,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let i=this.controllerState;if(this.touchZoom){const{scale:l}=e,u=this.getCenter(e);i=i.zoom({pos:u,scale:l})}if(this.touchRotate){const{rotation:l}=e;i=i.rotate({deltaAngleX:Va._startPinchRotation-l})}return this.updateViewport(i,sa,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Va._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:i}=this,{_lastPinchEvent:l}=Va;if(this.touchZoom&&i&&l&&e.scale!==l.scale){const u=this.getCenter(e);let f=this.controllerState.rotateEnd();const y=Math.log2(e.scale),a=(y-Math.log2(l.scale))/(e.deltaTime-l.deltaTime),E=Math.pow(2,y+a*i/2);f=f.zoom({pos:u,scale:E}).zoomEnd(),this.updateViewport(f,{...this._getTransitionProps({around:u}),transitionDuration:i,transitionEasing:$f},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(i)}else{const u=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(u,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Va._startPinchRotation=null,Va._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;const l=this.isFunctionKeyPressed(e),u=this.controllerState.zoom({pos:i,scale:l?.5:2});return this.updateViewport(u,this._getTransitionProps({around:i}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const i=this.isFunctionKeyPressed(e),{zoomSpeed:l,moveSpeed:u,rotateSpeedX:f,rotateSpeedY:y}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let E;const I={};switch(e.srcEvent.code){case"Minus":E=i?a.zoomOut(l).zoomOut(l):a.zoomOut(l),I.isZooming=!0;break;case"Equal":E=i?a.zoomIn(l).zoomIn(l):a.zoomIn(l),I.isZooming=!0;break;case"ArrowLeft":i?(E=a.rotateLeft(f),I.isRotating=!0):(E=a.moveLeft(u),I.isPanning=!0);break;case"ArrowRight":i?(E=a.rotateRight(f),I.isRotating=!0):(E=a.moveRight(u),I.isPanning=!0);break;case"ArrowUp":i?(E=a.rotateUp(y),I.isRotating=!0):(E=a.moveUp(u),I.isPanning=!0);break;case"ArrowDown":i?(E=a.rotateDown(y),I.isRotating=!0):(E=a.moveDown(u),I.isPanning=!0);break;default:return!1}return this.updateViewport(E,this._getTransitionProps(),I),!0}_getTransitionProps(e){const{transition:i}=this;return!i||!i.transitionInterpolator?sa:e?{...i,transitionInterpolator:new hy({...e,...i.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:i}}class lT{constructor(e,i){G(this,"_viewportProps",void 0),G(this,"_state",void 0),this._viewportProps=this.applyConstraints(e),this._state=i}getViewportProps(){return this._viewportProps}getState(){return this._state}}const G1=5,hD=1.2;class dD extends lT{constructor(e){const{width:i,height:l,latitude:u,longitude:f,zoom:y,bearing:a=0,pitch:E=0,altitude:I=1.5,position:O=[0,0,0],maxZoom:R=20,minZoom:N=0,maxPitch:H=60,minPitch:re=0,startPanLngLat:ae,startZoomLngLat:be,startRotatePos:De,startBearing:Oe,startPitch:Ce,startZoom:Ve,normalize:Ee=!0}=e;wn(Number.isFinite(f)),wn(Number.isFinite(u)),wn(Number.isFinite(y)),super({width:i,height:l,latitude:u,longitude:f,zoom:y,bearing:a,pitch:E,altitude:I,maxZoom:R,minZoom:N,maxPitch:H,minPitch:re,normalize:Ee,position:O},{startPanLngLat:ae,startZoomLngLat:be,startRotatePos:De,startBearing:Oe,startPitch:Ce,startZoom:Ve}),G(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:i}){const l=this.getState().startPanLngLat||this._unproject(i);if(!l)return this;const f=this.makeViewport(this.getViewportProps()).panByPosition(l,e);return this._getUpdatedState(f)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:i=0,deltaAngleY:l=0}){const{startRotatePos:u,startBearing:f,startPitch:y}=this.getState();if(!u||f===void 0||y===void 0)return this;let a;return e?a=this._getNewRotation(e,u,y,f):a={bearing:f+i,pitch:y+l},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:i,scale:l}){let{startZoom:u,startZoomLngLat:f}=this.getState();if(f||(u=this.getViewportProps().zoom,f=this._unproject(i)||this._unproject(e)),!f)return this;const{maxZoom:y,minZoom:a}=this.getViewportProps();let E=u+Math.log2(l);E=Kn(E,a,y);const I=this.makeViewport({...this.getViewportProps(),zoom:E});return this._getUpdatedState({zoom:E,...I.panByPosition(f,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const i=e.getViewportProps(),l={...this.getViewportProps()},{bearing:u,longitude:f}=l;return Math.abs(u-i.bearing)>180&&(l.bearing=u<0?u+360:u-360),Math.abs(f-i.longitude)>180&&(l.longitude=f<0?f+360:f-360),l}applyConstraints(e){const{maxZoom:i,minZoom:l,zoom:u}=e;e.zoom=Kn(u,l,i);const{maxPitch:f,minPitch:y,pitch:a}=e;e.pitch=Kn(a,y,f);const{normalize:E=!0}=e;return E&&Object.assign(e,lR(e)),e}_zoomFromCenter(e){const{width:i,height:l}=this.getViewportProps();return this.zoom({pos:[i/2,l/2],scale:e})}_panFromCenter(e){const{width:i,height:l}=this.getViewportProps();return this.pan({startPos:[i/2,l/2],pos:[i/2+e[0],l/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const i=this.makeViewport(this.getViewportProps());return e&&i.unproject(e)}_getNewRotation(e,i,l,u){const f=e[0]-i[0],y=e[1]-i[1],a=e[1],E=i[1],{width:I,height:O}=this.getViewportProps(),R=f/I;let N=0;y>0?Math.abs(O-E)>G1&&(N=y/(E-O)*hD):y<0&&E>G1&&(N=1-a/E),N=Kn(N,-1,1);const{minPitch:H,maxPitch:re}=this.getViewportProps(),ae=u+180*R;let be=l;return N>0?be=l+N*(re-l):N<0&&(be=l-N*(H-l)),{pitch:be,bearing:ae}}}class fD extends aT{constructor(...e){super(...e),G(this,"ControllerState",dD),G(this,"transition",{transitionDuration:300,transitionInterpolator:new hy({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),G(this,"dragMode","pan")}setProps(e){e.position=e.position||[0,0,0];const i=this.props;super.setProps(e),(!i||i.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class dy extends oT{get ViewportType(){return Ro}get ControllerType(){return fD}}G(dy,"displayName","MapView");class pD extends Vp{constructor(e,i){super(e,i),G(this,"maskMap",void 0),G(this,"fbo",void 0);const{mapSize:l=2048}=i;this.maskMap=new qr(e,{width:l,height:l,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.fbo=new En(e,{id:"maskmap",width:l,height:l,attachments:{[36064]:this.maskMap}})}render(e){const i=this.gl,l=[!1,!1,!1,!1];return l[e.channel]=!0,gs(i,{clearColor:[255,255,255,255],blend:!0,blendFunc:[0,1],blendEquation:32778,colorMask:l,depthTest:!1},()=>super.render({...e,target:this.fbo,pass:"mask"}))}shouldDrawLayer(e){return e.props.operation===Xh.MASK}delete(){this.fbo.delete(),this.maskMap.delete()}}const mD=new _s().lookAt({eye:[0,0,1]});function gD({width:n,height:e,near:i,far:l,padding:u}){let f=-n/2,y=n/2,a=-e/2,E=e/2;if(u){const{left:I=0,right:O=0,top:R=0,bottom:N=0}=u,H=Kn((I+n-O)/2,0,n)-n/2,re=Kn((R+e-N)/2,0,e)-e/2;f-=H,y-=H,a+=re,E+=re}return new _s().ortho({left:f,right:y,bottom:a,top:E,near:i,far:l})}class _D extends Ja{constructor(e){const{width:i,height:l,near:u=.1,far:f=1e3,zoom:y=0,target:a=[0,0,0],padding:E=null,flipY:I=!0}=e,O=Array.isArray(y)?y[0]:y,R=Array.isArray(y)?y[1]:y,N=Math.min(O,R),H=Math.pow(2,N);let re;if(O!==R){const ae=Math.pow(2,O),be=Math.pow(2,R);re={unitsPerMeter:[ae/H,be/H,1],metersPerUnit:[H/ae,H/be,1]}}super({...e,longitude:void 0,position:a,viewMatrix:mD.clone().scale([H,H*(I?-1:1),H]),projectionMatrix:gD({width:i||1,height:l||1,padding:E,near:u,far:f}),zoom:N,distanceScales:re})}projectFlat([e,i]){const{unitsPerMeter:l}=this.distanceScales;return[e*l[0],i*l[1]]}unprojectFlat([e,i]){const{metersPerUnit:l}=this.distanceScales;return[e*l[0],i*l[1]]}panByPosition(e,i){const l=Up(i,this.pixelUnprojectionMatrix),u=this.projectFlat(e),f=xp([],u,Nw([],l)),y=xp([],this.center,f);return{target:this.unprojectFlat(y)}}}class yD extends lT{constructor(e){const{width:i,height:l,rotationX:u=0,rotationOrbit:f=0,target:y=[0,0,0],zoom:a=0,minRotationX:E=-90,maxRotationX:I=90,minZoom:O=-1/0,maxZoom:R=1/0,startPanPosition:N,startRotatePos:H,startRotationX:re,startRotationOrbit:ae,startZoomPosition:be,startZoom:De}=e;super({width:i,height:l,rotationX:u,rotationOrbit:f,target:y,zoom:a,minRotationX:E,maxRotationX:I,minZoom:O,maxZoom:R},{startPanPosition:N,startRotatePos:H,startRotationX:re,startRotationOrbit:ae,startZoomPosition:be,startZoom:De}),G(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanPosition:this._unproject(e)})}pan({pos:e,startPosition:i}){const l=this.getState().startPanPosition||i;if(!l)return this;const f=this.makeViewport(this.getViewportProps()).panByPosition(l,e);return this._getUpdatedState(f)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:e,deltaAngleX:i=0,deltaAngleY:l=0}){const{startRotatePos:u,startRotationX:f,startRotationOrbit:y}=this.getState(),{width:a,height:E}=this.getViewportProps();if(!u||f===void 0||y===void 0)return this;let I;if(e){let O=(e[0]-u[0])/a;const R=(e[1]-u[1])/E;(f<-90||f>90)&&(O*=-1),I={rotationX:f+R*180,rotationOrbit:y+O*180}}else I={rotationX:f+l,rotationOrbit:y+i};return this._getUpdatedState(I)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(e){const i=e.getViewportProps(),l={...this.getViewportProps()},{rotationOrbit:u}=l;return Math.abs(u-i.rotationOrbit)>180&&(l.rotationOrbit=u<0?u+360:u-360),l}zoomStart({pos:e}){return this._getUpdatedState({startZoomPosition:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:i,scale:l}){let{startZoom:u,startZoomPosition:f}=this.getState();if(f||(u=this.getViewportProps().zoom,f=this._unproject(i)||this._unproject(e)),!f)return this;const y=this._calculateNewZoom({scale:l,startZoom:u}),a=this.makeViewport({...this.getViewportProps(),zoom:y});return this._getUpdatedState({zoom:y,...a.panByPosition(f,e)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:e})})}zoomOut(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/e})})}moveLeft(e=50){return this._panFromCenter([-e,0])}moveRight(e=50){return this._panFromCenter([e,0])}moveUp(e=50){return this._panFromCenter([0,-e])}moveDown(e=50){return this._panFromCenter([0,e])}rotateLeft(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-e})}rotateRight(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+e})}rotateUp(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-e})}rotateDown(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+e})}_unproject(e){const i=this.makeViewport(this.getViewportProps());return e&&i.unproject(e)}_calculateNewZoom({scale:e,startZoom:i}){const{maxZoom:l,minZoom:u}=this.getViewportProps();i===void 0&&(i=this.getViewportProps().zoom);const f=i+Math.log2(e);return Kn(f,u,l)}_panFromCenter(e){const{width:i,height:l,target:u}=this.getViewportProps();return this.pan({startPosition:u,pos:[i/2+e[0],l/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}applyConstraints(e){const{maxZoom:i,minZoom:l,zoom:u,maxRotationX:f,minRotationX:y,rotationOrbit:a}=e;return e.zoom=Array.isArray(u)?[Kn(u[0],l,i),Kn(u[1],l,i)]:Kn(u,l,i),e.rotationX=Kn(e.rotationX,y,f),(a<-180||a>180)&&(e.rotationOrbit=BR(a+180,360)-180),e}}class xD extends yD{constructor(e){super(e),G(this,"zoomAxis",void 0),this.zoomAxis=e.zoomAxis||"all"}_calculateNewZoom({scale:e,startZoom:i}){const{maxZoom:l,minZoom:u}=this.getViewportProps();i===void 0&&(i=this.getViewportProps().zoom);let f=Math.log2(e);if(Array.isArray(i)){let[y,a]=i;switch(this.zoomAxis){case"X":y=Kn(y+f,u,l);break;case"Y":a=Kn(a+f,u,l);break;default:let E=Math.min(y+f,a+f);E<u&&(f+=u-E),E=Math.max(y+f,a+f),E>l&&(f+=l-E),y+=f,a+=f}return[y,a]}return Kn(i+f,u,l)}}class vD extends aT{constructor(...e){super(...e),G(this,"ControllerState",xD),G(this,"transition",{transitionDuration:300,transitionInterpolator:new hy(["target","zoom"])}),G(this,"dragMode","pan")}_onPanRotate(){return!1}}class cT extends oT{get ViewportType(){return _D}get ControllerType(){return vD}}G(cT,"displayName","OrthographicView");function bD({layers:n,viewport:e}){let i=null;for(const f of n){const y=f.getBounds();y&&(i?(i[0]=Math.min(i[0],y[0][0]),i[1]=Math.min(i[1],y[0][1]),i[2]=Math.max(i[2],y[1][0]),i[3]=Math.max(i[3],y[1][1])):i=[y[0][0],y[0][1],y[1][0],y[1][1]])}const l=e.getBounds();if(!i)return l;const u=TD(l);return i[2]-i[0]<u[2]-u[0]||i[3]-i[1]<u[3]-u[1]||(i[0]=Math.max(i[0],u[0]),i[1]=Math.max(i[1],u[1]),i[2]=Math.min(i[2],u[2]),i[3]=Math.min(i[3],u[3])),i}function wD({bounds:n,viewport:e,width:i,height:l}){if(n[2]<=n[0]||n[3]<=n[1])return null;const u=1;if(i-=u*2,l-=u*2,e instanceof Ro){const{longitude:a,latitude:E,zoom:I}=tT({width:i,height:l,bounds:[[n[0],n[1]],[n[2],n[3]]],maxZoom:20});return new Ro({longitude:a,latitude:E,zoom:I,x:u,y:u,width:i,height:l})}const f=[(n[0]+n[2])/2,(n[1]+n[3])/2,0],y=Math.min(20,i/(n[2]-n[0]),l/(n[3]-n[1]));return new cT({x:u,y:u}).makeViewport({width:i,height:l,viewState:{target:f,zoom:Math.log2(y)}})}function TD(n){const e={x:n[2]-n[0],y:n[3]-n[1]},i={x:n[0]+.5*e.x,y:n[1]+.5*e.y};return[i.x-e.x,i.y-e.y,i.x+e.x,i.y+e.y]}class ED{constructor(){G(this,"id","mask-effect"),G(this,"props",null),G(this,"useInPicking",!0),G(this,"dummyMaskMap",void 0),G(this,"channels",[]),G(this,"masks",null),G(this,"maskPass",void 0),G(this,"maskMap",void 0),G(this,"lastViewport",void 0)}preRender(e,{layers:i,layerFilter:l,viewports:u,onViewportActive:f,views:y}){this.dummyMaskMap||(this.dummyMaskMap=new qr(e,{width:1,height:1}));const a=i.filter(R=>R.props.visible&&R.props.operation===Xh.MASK);if(a.length===0){this.masks=null,this.channels.length=0;return}this.masks={},this.maskPass||(this.maskPass=new pD(e,{id:"default-mask"}),this.maskMap=this.maskPass.maskMap);const E=this._sortMaskChannels(a),I=u[0],O=!this.lastViewport||!this.lastViewport.equals(I);for(const R in E)this._renderChannel(E[R],{layerFilter:l,onViewportActive:f,views:y,viewport:I,viewportChanged:O})}_renderChannel(e,{layerFilter:i,onViewportActive:l,views:u,viewport:f,viewportChanged:y}){const a=this.channels[e.index];if(!a)return;const E=e===a||a.layers.length!==e.layers.length||e.layerBounds.some((I,O)=>I!==a.layerBounds[O]);if(e.bounds=a.bounds,e.maskBounds=a.maskBounds,this.channels[e.index]=e,(E||y)&&(this.lastViewport=f,e.bounds=bD({layers:e.layers,viewport:f}),E||!wc(e.bounds,a.bounds))){const{maskPass:I,maskMap:O}=this,R=wD({bounds:e.bounds,viewport:f,width:O.width,height:O.height});e.maskBounds=R?R.getBounds():[0,0,1,1],I.render({pass:"mask",channel:e.index,layers:e.layers,layerFilter:i,viewports:R?[R]:[],onViewportActive:l,views:u,moduleParameters:{devicePixelRatio:1}})}this.masks[e.id]={index:e.index,bounds:e.maskBounds,coordinateOrigin:e.coordinateOrigin,coordinateSystem:e.coordinateSystem}}_sortMaskChannels(e){const i={};let l=0;for(const u of e){const{id:f}=u.root;let y=i[f];if(!y){if(++l>4){Bi.warn("Too many mask layers. The max supported is 4")();continue}y={id:f,index:this.channels.findIndex(a=>a?.id===f),layers:[],layerBounds:[],coordinateOrigin:u.root.props.coordinateOrigin,coordinateSystem:u.root.props.coordinateSystem},i[f]=y}y.layers.push(u),y.layerBounds.push(u.getBounds())}for(let u=0;u<4;u++){const f=this.channels[u];(!f||!(f.id in i))&&(this.channels[u]=null)}for(const u in i){const f=i[u];f.index<0&&(f.index=this.channels.findIndex(y=>!y),this.channels[f.index]=f)}return i}getModuleParameters(){return{maskMap:this.masks?this.maskMap:this.dummyMaskMap,maskChannels:this.masks}}cleanup(){this.dummyMaskMap&&(this.dummyMaskMap.delete(),this.dummyMaskMap=void 0),this.maskPass&&(this.maskPass.delete(),this.maskPass=void 0,this.maskMap=void 0),this.lastViewport=void 0,this.masks=null,this.channels.length=0}}const AD=new nT;class SD{constructor(){G(this,"effects",void 0),G(this,"_internalEffects",void 0),G(this,"_needsRedraw",void 0),this.effects=[],this._internalEffects=[],this._needsRedraw="Initial render",this.setEffects()}setProps(e){"effects"in e&&(e.effects.length!==this.effects.length||!Lc(e.effects,this.effects))&&(this.setEffects(e.effects),this._needsRedraw="effects changed")}needsRedraw(e={clearRedrawFlags:!1}){const i=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),i}getEffects(){return this._internalEffects}finalize(){this.cleanup()}setEffects(e=[]){this.cleanup(),this.effects=e,this._internalEffects=e.slice(),this._internalEffects.push(new ED),e.some(i=>i instanceof nT)||this._internalEffects.push(AD)}cleanup(){for(const e of this.effects)e.cleanup();for(const e of this._internalEffects)e.cleanup();this.effects.length=0,this._internalEffects.length=0}}class MD extends Vp{shouldDrawLayer(e){return e.props.operation===Xh.DRAW}}const W1={blendFunc:[1,0,32771,0],blendEquation:32774};class uT extends Vp{constructor(...e){super(...e),G(this,"pickZ",void 0),G(this,"_colors",null)}render(e){return e.pickingFBO?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:i,views:l,viewports:u,onViewportActive:f,pickingFBO:y,deviceRect:{x:a,y:E,width:I,height:O},cullRect:R,effects:N,pass:H="picking",pickZ:re}){const ae=this.gl;this.pickZ=re;const be=re?null:{byLayer:new Map,byAlpha:[]};this._colors=be;const De=gs(ae,{scissorTest:!0,scissor:[a,E,I,O],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...W1,blend:!re},()=>super.render({target:y,layers:e,layerFilter:i,views:l,viewports:u,onViewportActive:f,cullRect:R,effects:N?.filter(Ce=>Ce.useInPicking),pass:H}));return this._colors=null,{decodePickingColor:be&&ID.bind(null,be),stats:De}}shouldDrawLayer(e){return e.props.pickable&&e.props.operation===Xh.DRAW}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(e,i,l){const u={...e.props.parameters};return this._colors?(Object.assign(u,W1),u.blend=!0,u.blendColor=PD(this._colors,e,l)):u.blend=!1,u}}function PD(n,e,i){const{byLayer:l,byAlpha:u}=n;let f,y=l.get(e);return y?(y.viewports.push(i),f=y.a):(f=l.size+1,f<=255?(y={a:f,layer:e,viewports:[i]},l.set(e,y),u[f]=y):(Bi.warn("Too many pickable layers, only picking the first 255")(),f=0)),[0,0,0,f/255]}function ID(n,e){const i=n.byAlpha[e[3]];return i&&{pickedLayer:i.layer,pickedViewports:i.viewports,pickedObjectIndex:i.layer.decodePickingColor(e)}}const CD="deckRenderer.renderLayers";class LD{constructor(e){this.gl=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new MD(e),this.pickLayersPass=new uT(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){"layerFilter"in e&&this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),"drawPickingColors"in e&&this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){const i=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass;e.layerFilter=e.layerFilter||this.layerFilter,e.effects=e.effects||[],e.target=e.target||En.getDefaultFramebuffer(this.gl),this._preRender(e.effects,e);const l=this.lastPostProcessEffect?this.renderBuffers[0]:e.target,u=i.render({...e,target:l});this._postRender(e.effects,e),this.renderCount++,cr(CD,this,u,e)}needsRedraw(e={clearRedrawFlags:!1}){const i=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),i}finalize(){const{renderBuffers:e}=this;for(const i of e)i.delete();e.length=0}_preRender(e,i){let l=null;for(const u of e)u.preRender(this.gl,i),u.postRender&&(l=u);l&&this._resizeRenderBuffers(),this.lastPostProcessEffect=l}_resizeRenderBuffers(){const{renderBuffers:e}=this;e.length===0&&e.push(new En(this.gl),new En(this.gl));for(const i of e)i.resize()}_postRender(e,i){const{renderBuffers:l}=this,u={inputBuffer:l[0],swapBuffer:l[1],target:null};for(const f of e)if(f.postRender){if(f===this.lastPostProcessEffect){u.target=i.target,f.postRender(this.gl,u);break}const y=f.postRender(this.gl,u);u.inputBuffer=y,u.swapBuffer=y===l[0]?l[1]:l[0]}}}const kD={pickedColor:null,pickedObjectIndex:-1};function RD({pickedColors:n,decodePickingColor:e,deviceX:i,deviceY:l,deviceRadius:u,deviceRect:f}){const{x:y,y:a,width:E,height:I}=f;let O=u*u,R=-1,N=0;for(let H=0;H<I;H++){const re=H+a-l,ae=re*re;if(ae>O)N+=4*E;else for(let be=0;be<E;be++){if(n[N+3]-1>=0){const Oe=be+y-i,Ce=Oe*Oe+ae;Ce<=O&&(O=Ce,R=N)}N+=4}}if(R>=0){const H=n.slice(R,R+4),re=e(H);if(re){const ae=Math.floor(R/4/E),be=R/4-ae*E;return{...re,pickedColor:H,pickedX:y+be,pickedY:a+ae}}Bi.error("Picked non-existent layer. Is picking buffer corrupt?")()}return kD}function DD({pickedColors:n,decodePickingColor:e}){const i=new Map;if(n){for(let l=0;l<n.length;l+=4)if(n[l+3]-1>=0){const f=n.slice(l,l+4),y=f.join(",");if(!i.has(y)){const a=e(f);a?i.set(y,{...a,color:f}):Bi.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(i.values())}function hT({pickInfo:n,viewports:e,pixelRatio:i,x:l,y:u,z:f}){let y=e[0];e.length>1&&(y=OD(n?.pickedViewports||e,{x:l,y:u}));let a;if(y){const E=[l-y.x,u-y.y];f!==void 0&&(E[2]=f),a=y.unproject(E)}return{color:null,layer:null,viewport:y,index:-1,picked:!1,x:l,y:u,pixel:[l,u],coordinate:a,devicePixel:n&&"pickedX"in n?[n.pickedX,n.pickedY]:void 0,pixelRatio:i}}function zD(n){const{pickInfo:e,lastPickedInfo:i,mode:l,layers:u}=n,{pickedColor:f,pickedLayer:y,pickedObjectIndex:a}=e,E=y?[y]:[];if(l==="hover"){const R=i.index,N=i.layerId,H=y?y.props.id:null;if(H!==N||a!==R){if(H!==N){const re=u.find(ae=>ae.props.id===N);re&&E.unshift(re)}i.layerId=H,i.index=a,i.info=null}}const I=hT(n),O=new Map;return O.set(null,I),E.forEach(R=>{let N={...I};R===y&&(N.color=f,N.index=a,N.picked=!0),N=dT({layer:R,info:N,mode:l});const H=N.layer;R===y&&l==="hover"&&(i.info=N),O.set(H.id,N),l==="hover"&&H.updateAutoHighlight(N)}),O}function dT({layer:n,info:e,mode:i}){for(;n&&e;){const l=e.layer||null;e.sourceLayer=l,e.layer=n,e=n.getPickingInfo({info:e,mode:i,sourceLayer:l}),n=n.parent}return e}function OD(n,e){for(let i=n.length-1;i>=0;i--){const l=n[i];if(l.containsPixel(e))return l}return n[0]}class BD{constructor(e){G(this,"gl",void 0),G(this,"pickingFBO",void 0),G(this,"depthFBO",void 0),G(this,"pickLayersPass",void 0),G(this,"layerFilter",void 0),G(this,"lastPickedInfo",void 0),G(this,"_pickable",!0),this.gl=e,this.pickLayersPass=new uT(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:i,layers:l,viewports:u},f=this.lastPickedInfo.info){const y=f&&f.layer&&f.layer.id,a=f&&f.viewport&&f.viewport.id,E=y?l.find(N=>N.id===y):null,I=a&&u.find(N=>N.id===a)||u[0],O=I&&I.unproject([e-I.x,i-I.y]);return{...f,...{x:e,y:i,viewport:I,coordinate:O,layer:E}}}_resizeBuffer(){var e,i;const{gl:l}=this;if(!this.pickingFBO&&(this.pickingFBO=new En(l),En.isSupported(l,{colorBufferFloat:!0}))){const u=new En(l);u.attach({[36064]:new qr(l,{format:gi(l)?34836:6408,type:5126})}),this.depthFBO=u}(e=this.pickingFBO)===null||e===void 0||e.resize({width:l.canvas.width,height:l.canvas.height}),(i=this.depthFBO)===null||i===void 0||i.resize({width:l.canvas.width,height:l.canvas.height})}_getPickable(e){if(this._pickable===!1)return null;const i=e.filter(l=>l.isPickable()&&!l.isComposite);return i.length?i:null}_pickClosestObject({layers:e,views:i,viewports:l,x:u,y:f,radius:y=0,depth:a=1,mode:E="query",unproject3D:I,onViewportActive:O,effects:R}){const N=this._getPickable(e),H=_c(this.gl);if(!N)return{result:[],emptyInfo:hT({viewports:l,x:u,y:f,pixelRatio:H})};this._resizeBuffer();const re=vg(this.gl,[u,f],!0),ae=[re.x+Math.floor(re.width/2),re.y+Math.floor(re.height/2)],be=Math.round(y*H),{width:De,height:Oe}=this.pickingFBO,Ce=this._getPickingRect({deviceX:ae[0],deviceY:ae[1],deviceRadius:be,deviceWidth:De,deviceHeight:Oe}),Ve={x:u-y,y:f-y,width:y*2+1,height:y*2+1};let Ee;const dt=[],wt=new Set;for(let kt=0;kt<a;kt++){let et;if(Ce){const ut=this._drawAndSample({layers:N,views:i,viewports:l,onViewportActive:O,deviceRect:Ce,cullRect:Ve,effects:R,pass:"picking:".concat(E)});et=RD({...ut,deviceX:ae[0],deviceY:ae[1],deviceRadius:be,deviceRect:Ce})}else et={pickedColor:null,pickedObjectIndex:-1};let Tt;et.pickedLayer&&I&&this.depthFBO&&(Tt=this._drawAndSample({layers:[et.pickedLayer],views:i,viewports:l,onViewportActive:O,deviceRect:{x:et.pickedX,y:et.pickedY,width:1,height:1},cullRect:Ve,effects:R,pass:"picking:".concat(E,":z")},!0).pickedColors[0]),et.pickedLayer&&kt+1<a&&(wt.add(et.pickedLayer),et.pickedLayer.disablePickingIndex(et.pickedObjectIndex)),Ee=zD({pickInfo:et,lastPickedInfo:this.lastPickedInfo,mode:E,layers:N,viewports:l,x:u,y:f,z:Tt,pixelRatio:H});for(const ut of Ee.values())ut.layer&&dt.push(ut);if(!et.pickedColor)break}for(const kt of wt)kt.restorePickingColors();return{result:dt,emptyInfo:Ee.get(null)}}_pickVisibleObjects({layers:e,views:i,viewports:l,x:u,y:f,width:y=1,height:a=1,mode:E="query",maxObjects:I=null,onViewportActive:O,effects:R}){const N=this._getPickable(e);if(!N)return[];this._resizeBuffer();const H=_c(this.gl),re=vg(this.gl,[u,f],!0),ae=re.x,be=re.y+re.height,De=vg(this.gl,[u+y,f+a],!0),Oe=De.x+De.width,Ce=De.y,Ve={x:ae,y:Ce,width:Oe-ae,height:be-Ce},Ee=this._drawAndSample({layers:N,views:i,viewports:l,onViewportActive:O,deviceRect:Ve,cullRect:{x:u,y:f,width:y,height:a},effects:R,pass:"picking:".concat(E)}),dt=DD(Ee),wt=new Map,kt=Number.isFinite(I);for(let et=0;et<dt.length&&!(kt&&I&&wt.size>=I);et++){const Tt=dt[et];let ut={color:Tt.pickedColor,layer:null,index:Tt.pickedObjectIndex,picked:!0,x:u,y:f,pixelRatio:H};ut=dT({layer:Tt.pickedLayer,info:ut,mode:E}),wt.has(ut.object)||wt.set(ut.object,ut)}return Array.from(wt.values())}_drawAndSample({layers:e,views:i,viewports:l,onViewportActive:u,deviceRect:f,cullRect:y,effects:a,pass:E},I=!1){const O=I?this.depthFBO:this.pickingFBO,{decodePickingColor:R}=this.pickLayersPass.render({layers:e,layerFilter:this.layerFilter,views:i,viewports:l,onViewportActive:u,pickingFBO:O,deviceRect:f,cullRect:y,effects:a,pass:E,pickZ:I}),{x:N,y:H,width:re,height:ae}=f,be=new(I?Float32Array:Uint8Array)(re*ae*4);return Fp(O,{sourceX:N,sourceY:H,sourceWidth:re,sourceHeight:ae,target:be}),{pickedColors:be,decodePickingColor:R}}_getPickingRect({deviceX:e,deviceY:i,deviceRadius:l,deviceWidth:u,deviceHeight:f}){const y=Math.max(0,e-l),a=Math.max(0,i-l),E=Math.min(u,e+l+1)-y,I=Math.min(f,i+l+1)-a;return E<=0||I<=0?null:{x:y,y:a,width:E,height:I}}}const FD={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class ND{constructor(e){G(this,"el",null),G(this,"isVisible",!1);const i=e.parentElement;i&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,FD),i.appendChild(this.el))}setTooltip(e,i,l){const u=this.el;if(!!u){if(typeof e=="string")u.innerText=e;else if(e)e.text&&(u.innerText=e.text),e.html&&(u.innerHTML=e.html),e.className&&(u.className=e.className),Object.assign(u.style,e.style);else{this.isVisible=!1,u.style.display="none";return}this.isVisible=!0,u.style.display="block",u.style.transform="translate(".concat(i,"px, ").concat(l,"px)")}}remove(){this.el&&(this.el.remove(),this.el=null)}}var UD=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},kc={exports:{}};/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */(function(n){(function(e,i,l,u){var f=["","webkit","Moz","MS","ms","o"],y=i.createElement("div"),a="function",E=Math.round,I=Math.abs,O=Date.now;function R($,Q,_e){return setTimeout(Ce($,_e),Q)}function N($,Q,_e){return Array.isArray($)?(H($,_e[Q],_e),!0):!1}function H($,Q,_e){var Fe;if(!!$)if($.forEach)$.forEach(Q,_e);else if($.length!==u)for(Fe=0;Fe<$.length;)Q.call(_e,$[Fe],Fe,$),Fe++;else for(Fe in $)$.hasOwnProperty(Fe)&&Q.call(_e,$[Fe],Fe,$)}function re($,Q,_e){var Fe="DEPRECATED METHOD: "+Q+`
`+_e+` AT 
`;return function(){var it=new Error("get-stack-trace"),xt=it&&it.stack?it.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",Jt=e.console&&(e.console.warn||e.console.log);return Jt&&Jt.call(e.console,Fe,xt),$.apply(this,arguments)}}var ae;typeof Object.assign!="function"?ae=function(Q){if(Q===u||Q===null)throw new TypeError("Cannot convert undefined or null to object");for(var _e=Object(Q),Fe=1;Fe<arguments.length;Fe++){var it=arguments[Fe];if(it!==u&&it!==null)for(var xt in it)it.hasOwnProperty(xt)&&(_e[xt]=it[xt])}return _e}:ae=Object.assign;var be=re(function(Q,_e,Fe){for(var it=Object.keys(_e),xt=0;xt<it.length;)(!Fe||Fe&&Q[it[xt]]===u)&&(Q[it[xt]]=_e[it[xt]]),xt++;return Q},"extend","Use `assign`."),De=re(function(Q,_e){return be(Q,_e,!0)},"merge","Use `assign`.");function Oe($,Q,_e){var Fe=Q.prototype,it;it=$.prototype=Object.create(Fe),it.constructor=$,it._super=Fe,_e&&ae(it,_e)}function Ce($,Q){return function(){return $.apply(Q,arguments)}}function Ve($,Q){return typeof $==a?$.apply(Q&&Q[0]||u,Q):$}function Ee($,Q){return $===u?Q:$}function dt($,Q,_e){H(Tt(Q),function(Fe){$.addEventListener(Fe,_e,!1)})}function wt($,Q,_e){H(Tt(Q),function(Fe){$.removeEventListener(Fe,_e,!1)})}function kt($,Q){for(;$;){if($==Q)return!0;$=$.parentNode}return!1}function et($,Q){return $.indexOf(Q)>-1}function Tt($){return $.trim().split(/\s+/g)}function ut($,Q,_e){if($.indexOf&&!_e)return $.indexOf(Q);for(var Fe=0;Fe<$.length;){if(_e&&$[Fe][_e]==Q||!_e&&$[Fe]===Q)return Fe;Fe++}return-1}function si($){return Array.prototype.slice.call($,0)}function ti($,Q,_e){for(var Fe=[],it=[],xt=0;xt<$.length;){var Jt=Q?$[xt][Q]:$[xt];ut(it,Jt)<0&&Fe.push($[xt]),it[xt]=Jt,xt++}return _e&&(Q?Fe=Fe.sort(function(pi,ri){return pi[Q]>ri[Q]}):Fe=Fe.sort()),Fe}function Zt($,Q){for(var _e,Fe,it=Q[0].toUpperCase()+Q.slice(1),xt=0;xt<f.length;){if(_e=f[xt],Fe=_e?_e+it:Q,Fe in $)return Fe;xt++}return u}var Lt=1;function An(){return Lt++}function fn($){var Q=$.ownerDocument||$;return Q.defaultView||Q.parentWindow||e}var pn=/mobile|tablet|ip(ad|hone|od)|android/i,Gi="ontouchstart"in e,ni=Zt(e,"PointerEvent")!==u,Hr=Gi&&pn.test(navigator.userAgent),ur="touch",Ki="pen",$i="mouse",Xr="kinect",Jn=25,Ai=1,Si=2,oi=4,yi=8,hr=1,fi=2,mn=4,Kt=8,gn=16,_n=fi|mn,tn=Kt|gn,dr=_n|tn,wr=["x","y"],Gn=["clientX","clientY"];function Ji($,Q){var _e=this;this.manager=$,this.callback=Q,this.element=$.element,this.target=$.options.inputTarget,this.domHandler=function(Fe){Ve($.options.enable,[$])&&_e.handler(Fe)},this.init()}Ji.prototype={handler:function(){},init:function(){this.evEl&&dt(this.element,this.evEl,this.domHandler),this.evTarget&&dt(this.target,this.evTarget,this.domHandler),this.evWin&&dt(fn(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&wt(this.element,this.evEl,this.domHandler),this.evTarget&&wt(this.target,this.evTarget,this.domHandler),this.evWin&&wt(fn(this.element),this.evWin,this.domHandler)}};function Qi($){var Q,_e=$.options.inputClass;return _e?Q=_e:ni?Q=ts:Hr?Q=F:Gi?Q=ge:Q=Wn,new Q($,Qn)}function Qn($,Q,_e){var Fe=_e.pointers.length,it=_e.changedPointers.length,xt=Q&Ai&&Fe-it===0,Jt=Q&(oi|yi)&&Fe-it===0;_e.isFirst=!!xt,_e.isFinal=!!Jt,xt&&($.session={}),_e.eventType=Q,Sn($,_e),$.emit("hammer.input",_e),$.recognize(_e),$.session.prevInput=_e}function Sn($,Q){var _e=$.session,Fe=Q.pointers,it=Fe.length;_e.firstInput||(_e.firstInput=fr(Q)),it>1&&!_e.firstMultiple?_e.firstMultiple=fr(Q):it===1&&(_e.firstMultiple=!1);var xt=_e.firstInput,Jt=_e.firstMultiple,Ni=Jt?Jt.center:xt.center,pi=Q.center=Wi(Fe);Q.timeStamp=O(),Q.deltaTime=Q.timeStamp-xt.timeStamp,Q.angle=Pn(Ni,pi),Q.distance=Mn(Ni,pi),Yr(_e,Q),Q.offsetDirection=yn(Q.deltaX,Q.deltaY);var ri=Ir(Q.deltaTime,Q.deltaX,Q.deltaY);Q.overallVelocityX=ri.x,Q.overallVelocityY=ri.y,Q.overallVelocity=I(ri.x)>I(ri.y)?ri.x:ri.y,Q.scale=Jt?an(Jt.pointers,Fe):1,Q.rotation=Jt?er(Jt.pointers,Fe):0,Q.maxPointers=_e.prevInput?Q.pointers.length>_e.prevInput.maxPointers?Q.pointers.length:_e.prevInput.maxPointers:Q.pointers.length,Kr(_e,Q);var tr=$.element;kt(Q.srcEvent.target,tr)&&(tr=Q.srcEvent.target),Q.target=tr}function Yr($,Q){var _e=Q.center,Fe=$.offsetDelta||{},it=$.prevDelta||{},xt=$.prevInput||{};(Q.eventType===Ai||xt.eventType===oi)&&(it=$.prevDelta={x:xt.deltaX||0,y:xt.deltaY||0},Fe=$.offsetDelta={x:_e.x,y:_e.y}),Q.deltaX=it.x+(_e.x-Fe.x),Q.deltaY=it.y+(_e.y-Fe.y)}function Kr($,Q){var _e=$.lastInterval||Q,Fe=Q.timeStamp-_e.timeStamp,it,xt,Jt,Ni;if(Q.eventType!=yi&&(Fe>Jn||_e.velocity===u)){var pi=Q.deltaX-_e.deltaX,ri=Q.deltaY-_e.deltaY,tr=Ir(Fe,pi,ri);xt=tr.x,Jt=tr.y,it=I(tr.x)>I(tr.y)?tr.x:tr.y,Ni=yn(pi,ri),$.lastInterval=Q}else it=_e.velocity,xt=_e.velocityX,Jt=_e.velocityY,Ni=_e.direction;Q.velocity=it,Q.velocityX=xt,Q.velocityY=Jt,Q.direction=Ni}function fr($){for(var Q=[],_e=0;_e<$.pointers.length;)Q[_e]={clientX:E($.pointers[_e].clientX),clientY:E($.pointers[_e].clientY)},_e++;return{timeStamp:O(),pointers:Q,center:Wi(Q),deltaX:$.deltaX,deltaY:$.deltaY}}function Wi($){var Q=$.length;if(Q===1)return{x:E($[0].clientX),y:E($[0].clientY)};for(var _e=0,Fe=0,it=0;it<Q;)_e+=$[it].clientX,Fe+=$[it].clientY,it++;return{x:E(_e/Q),y:E(Fe/Q)}}function Ir($,Q,_e){return{x:Q/$||0,y:_e/$||0}}function yn($,Q){return $===Q?hr:I($)>=I(Q)?$<0?fi:mn:Q<0?Kt:gn}function Mn($,Q,_e){_e||(_e=wr);var Fe=Q[_e[0]]-$[_e[0]],it=Q[_e[1]]-$[_e[1]];return Math.sqrt(Fe*Fe+it*it)}function Pn($,Q,_e){_e||(_e=wr);var Fe=Q[_e[0]]-$[_e[0]],it=Q[_e[1]]-$[_e[1]];return Math.atan2(it,Fe)*180/Math.PI}function er($,Q){return Pn(Q[1],Q[0],Gn)+Pn($[1],$[0],Gn)}function an($,Q){return Mn(Q[0],Q[1],Gn)/Mn($[0],$[1],Gn)}var xs={mousedown:Ai,mousemove:Si,mouseup:oi},Fs="mousedown",Jr="mousemove mouseup";function Wn(){this.evEl=Fs,this.evWin=Jr,this.pressed=!1,Ji.apply(this,arguments)}Oe(Wn,Ji,{handler:function(Q){var _e=xs[Q.type];_e&Ai&&Q.button===0&&(this.pressed=!0),_e&Si&&Q.which!==1&&(_e=oi),this.pressed&&(_e&oi&&(this.pressed=!1),this.callback(this.manager,_e,{pointers:[Q],changedPointers:[Q],pointerType:$i,srcEvent:Q}))}});var Qr={pointerdown:Ai,pointermove:Si,pointerup:oi,pointercancel:yi,pointerout:yi},es={2:ur,3:Ki,4:$i,5:Xr},Bn="pointerdown",Cr="pointermove pointerup pointercancel";e.MSPointerEvent&&!e.PointerEvent&&(Bn="MSPointerDown",Cr="MSPointerMove MSPointerUp MSPointerCancel");function ts(){this.evEl=Bn,this.evWin=Cr,Ji.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}Oe(ts,Ji,{handler:function(Q){var _e=this.store,Fe=!1,it=Q.type.toLowerCase().replace("ms",""),xt=Qr[it],Jt=es[Q.pointerType]||Q.pointerType,Ni=Jt==ur,pi=ut(_e,Q.pointerId,"pointerId");xt&Ai&&(Q.button===0||Ni)?pi<0&&(_e.push(Q),pi=_e.length-1):xt&(oi|yi)&&(Fe=!0),!(pi<0)&&(_e[pi]=Q,this.callback(this.manager,xt,{pointers:_e,changedPointers:[Q],pointerType:Jt,srcEvent:Q}),Fe&&_e.splice(pi,1))}});var Lr={touchstart:Ai,touchmove:Si,touchend:oi,touchcancel:yi},kr="touchstart",Tn="touchstart touchmove touchend touchcancel";function pr(){this.evTarget=kr,this.evWin=Tn,this.started=!1,Ji.apply(this,arguments)}Oe(pr,Ji,{handler:function(Q){var _e=Lr[Q.type];if(_e===Ai&&(this.started=!0),!!this.started){var Fe=vs.call(this,Q,_e);_e&(oi|yi)&&Fe[0].length-Fe[1].length===0&&(this.started=!1),this.callback(this.manager,_e,{pointers:Fe[0],changedPointers:Fe[1],pointerType:ur,srcEvent:Q})}}});function vs($,Q){var _e=si($.touches),Fe=si($.changedTouches);return Q&(oi|yi)&&(_e=ti(_e.concat(Fe),"identifier",!0)),[_e,Fe]}var is={touchstart:Ai,touchmove:Si,touchend:oi,touchcancel:yi},ne="touchstart touchmove touchend touchcancel";function F(){this.evTarget=ne,this.targetIds={},Ji.apply(this,arguments)}Oe(F,Ji,{handler:function(Q){var _e=is[Q.type],Fe=j.call(this,Q,_e);!Fe||this.callback(this.manager,_e,{pointers:Fe[0],changedPointers:Fe[1],pointerType:ur,srcEvent:Q})}});function j($,Q){var _e=si($.touches),Fe=this.targetIds;if(Q&(Ai|Si)&&_e.length===1)return Fe[_e[0].identifier]=!0,[_e,_e];var it,xt,Jt=si($.changedTouches),Ni=[],pi=this.target;if(xt=_e.filter(function(ri){return kt(ri.target,pi)}),Q===Ai)for(it=0;it<xt.length;)Fe[xt[it].identifier]=!0,it++;for(it=0;it<Jt.length;)Fe[Jt[it].identifier]&&Ni.push(Jt[it]),Q&(oi|yi)&&delete Fe[Jt[it].identifier],it++;if(!!Ni.length)return[ti(xt.concat(Ni),"identifier",!0),Ni]}var te=2500,ce=25;function ge(){Ji.apply(this,arguments);var $=Ce(this.handler,this);this.touch=new F(this.manager,$),this.mouse=new Wn(this.manager,$),this.primaryTouch=null,this.lastTouches=[]}Oe(ge,Ji,{handler:function(Q,_e,Fe){var it=Fe.pointerType==ur,xt=Fe.pointerType==$i;if(!(xt&&Fe.sourceCapabilities&&Fe.sourceCapabilities.firesTouchEvents)){if(it)Ae.call(this,_e,Fe);else if(xt&&xe.call(this,Fe))return;this.callback(Q,_e,Fe)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function Ae($,Q){$&Ai?(this.primaryTouch=Q.changedPointers[0].identifier,Te.call(this,Q)):$&(oi|yi)&&Te.call(this,Q)}function Te($){var Q=$.changedPointers[0];if(Q.identifier===this.primaryTouch){var _e={x:Q.clientX,y:Q.clientY};this.lastTouches.push(_e);var Fe=this.lastTouches,it=function(){var xt=Fe.indexOf(_e);xt>-1&&Fe.splice(xt,1)};setTimeout(it,te)}}function xe($){for(var Q=$.srcEvent.clientX,_e=$.srcEvent.clientY,Fe=0;Fe<this.lastTouches.length;Fe++){var it=this.lastTouches[Fe],xt=Math.abs(Q-it.x),Jt=Math.abs(_e-it.y);if(xt<=ce&&Jt<=ce)return!0}return!1}var Se=Zt(y.style,"touchAction"),Ge=Se!==u,st="compute",Ze="auto",At="manipulation",gt="none",yt="pan-x",Mt="pan-y",Ut=We();function ii($,Q){this.manager=$,this.set(Q)}ii.prototype={set:function($){$==st&&($=this.compute()),Ge&&this.manager.element.style&&Ut[$]&&(this.manager.element.style[Se]=$),this.actions=$.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var $=[];return H(this.manager.recognizers,function(Q){Ve(Q.options.enable,[Q])&&($=$.concat(Q.getTouchAction()))}),Pt($.join(" "))},preventDefaults:function($){var Q=$.srcEvent,_e=$.offsetDirection;if(this.manager.session.prevented){Q.preventDefault();return}var Fe=this.actions,it=et(Fe,gt)&&!Ut[gt],xt=et(Fe,Mt)&&!Ut[Mt],Jt=et(Fe,yt)&&!Ut[yt];if(it){var Ni=$.pointers.length===1,pi=$.distance<2,ri=$.deltaTime<250;if(Ni&&pi&&ri)return}if(!(Jt&&xt)&&(it||xt&&_e&_n||Jt&&_e&tn))return this.preventSrc(Q)},preventSrc:function($){this.manager.session.prevented=!0,$.preventDefault()}};function Pt($){if(et($,gt))return gt;var Q=et($,yt),_e=et($,Mt);return Q&&_e?gt:Q||_e?Q?yt:Mt:et($,At)?At:Ze}function We(){if(!Ge)return!1;var $={},Q=e.CSS&&e.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(_e){$[_e]=Q?e.CSS.supports("touch-action",_e):!0}),$}var Xe=1,pt=2,It=4,Me=8,Qt=Me,$t=16,Yt=32;function Fi($){this.options=ae({},this.defaults,$||{}),this.id=An(),this.manager=null,this.options.enable=Ee(this.options.enable,!0),this.state=Xe,this.simultaneous={},this.requireFail=[]}Fi.prototype={defaults:{},set:function($){return ae(this.options,$),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function($){if(N($,"recognizeWith",this))return this;var Q=this.simultaneous;return $=Rr($,this),Q[$.id]||(Q[$.id]=$,$.recognizeWith(this)),this},dropRecognizeWith:function($){return N($,"dropRecognizeWith",this)?this:($=Rr($,this),delete this.simultaneous[$.id],this)},requireFailure:function($){if(N($,"requireFailure",this))return this;var Q=this.requireFail;return $=Rr($,this),ut(Q,$)===-1&&(Q.push($),$.requireFailure(this)),this},dropRequireFailure:function($){if(N($,"dropRequireFailure",this))return this;$=Rr($,this);var Q=ut(this.requireFail,$);return Q>-1&&this.requireFail.splice(Q,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function($){return!!this.simultaneous[$.id]},emit:function($){var Q=this,_e=this.state;function Fe(it){Q.manager.emit(it,$)}_e<Me&&Fe(Q.options.event+qi(_e)),Fe(Q.options.event),$.additionalEvent&&Fe($.additionalEvent),_e>=Me&&Fe(Q.options.event+qi(_e))},tryEmit:function($){if(this.canEmit())return this.emit($);this.state=Yt},canEmit:function(){for(var $=0;$<this.requireFail.length;){if(!(this.requireFail[$].state&(Yt|Xe)))return!1;$++}return!0},recognize:function($){var Q=ae({},$);if(!Ve(this.options.enable,[this,Q])){this.reset(),this.state=Yt;return}this.state&(Qt|$t|Yt)&&(this.state=Xe),this.state=this.process(Q),this.state&(pt|It|Me|$t)&&this.tryEmit(Q)},process:function($){},getTouchAction:function(){},reset:function(){}};function qi($){return $&$t?"cancel":$&Me?"end":$&It?"move":$&pt?"start":""}function mr($){return $==gn?"down":$==Kt?"up":$==fi?"left":$==mn?"right":""}function Rr($,Q){var _e=Q.manager;return _e?_e.get($):$}function vi(){Fi.apply(this,arguments)}Oe(vi,Fi,{defaults:{pointers:1},attrTest:function($){var Q=this.options.pointers;return Q===0||$.pointers.length===Q},process:function($){var Q=this.state,_e=$.eventType,Fe=Q&(pt|It),it=this.attrTest($);return Fe&&(_e&yi||!it)?Q|$t:Fe||it?_e&oi?Q|Me:Q&pt?Q|It:pt:Yt}});function ot(){vi.apply(this,arguments),this.pX=null,this.pY=null}Oe(ot,vi,{defaults:{event:"pan",threshold:10,pointers:1,direction:dr},getTouchAction:function(){var $=this.options.direction,Q=[];return $&_n&&Q.push(Mt),$&tn&&Q.push(yt),Q},directionTest:function($){var Q=this.options,_e=!0,Fe=$.distance,it=$.direction,xt=$.deltaX,Jt=$.deltaY;return it&Q.direction||(Q.direction&_n?(it=xt===0?hr:xt<0?fi:mn,_e=xt!=this.pX,Fe=Math.abs($.deltaX)):(it=Jt===0?hr:Jt<0?Kt:gn,_e=Jt!=this.pY,Fe=Math.abs($.deltaY))),$.direction=it,_e&&Fe>Q.threshold&&it&Q.direction},attrTest:function($){return vi.prototype.attrTest.call(this,$)&&(this.state&pt||!(this.state&pt)&&this.directionTest($))},emit:function($){this.pX=$.deltaX,this.pY=$.deltaY;var Q=mr($.direction);Q&&($.additionalEvent=this.options.event+Q),this._super.emit.call(this,$)}});function Vt(){vi.apply(this,arguments)}Oe(Vt,vi,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[gt]},attrTest:function($){return this._super.attrTest.call(this,$)&&(Math.abs($.scale-1)>this.options.threshold||this.state&pt)},emit:function($){if($.scale!==1){var Q=$.scale<1?"in":"out";$.additionalEvent=this.options.event+Q}this._super.emit.call(this,$)}});function jt(){Fi.apply(this,arguments),this._timer=null,this._input=null}Oe(jt,Fi,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[Ze]},process:function($){var Q=this.options,_e=$.pointers.length===Q.pointers,Fe=$.distance<Q.threshold,it=$.deltaTime>Q.time;if(this._input=$,!Fe||!_e||$.eventType&(oi|yi)&&!it)this.reset();else if($.eventType&Ai)this.reset(),this._timer=R(function(){this.state=Qt,this.tryEmit()},Q.time,this);else if($.eventType&oi)return Qt;return Yt},reset:function(){clearTimeout(this._timer)},emit:function($){this.state===Qt&&($&&$.eventType&oi?this.manager.emit(this.options.event+"up",$):(this._input.timeStamp=O(),this.manager.emit(this.options.event,this._input)))}});function Fn(){vi.apply(this,arguments)}Oe(Fn,vi,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[gt]},attrTest:function($){return this._super.attrTest.call(this,$)&&(Math.abs($.rotation)>this.options.threshold||this.state&pt)}});function ns(){vi.apply(this,arguments)}Oe(ns,vi,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:_n|tn,pointers:1},getTouchAction:function(){return ot.prototype.getTouchAction.call(this)},attrTest:function($){var Q=this.options.direction,_e;return Q&(_n|tn)?_e=$.overallVelocity:Q&_n?_e=$.overallVelocityX:Q&tn&&(_e=$.overallVelocityY),this._super.attrTest.call(this,$)&&Q&$.offsetDirection&&$.distance>this.options.threshold&&$.maxPointers==this.options.pointers&&I(_e)>this.options.velocity&&$.eventType&oi},emit:function($){var Q=mr($.offsetDirection);Q&&this.manager.emit(this.options.event+Q,$),this.manager.emit(this.options.event,$)}});function qt(){Fi.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}Oe(qt,Fi,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[At]},process:function($){var Q=this.options,_e=$.pointers.length===Q.pointers,Fe=$.distance<Q.threshold,it=$.deltaTime<Q.time;if(this.reset(),$.eventType&Ai&&this.count===0)return this.failTimeout();if(Fe&&it&&_e){if($.eventType!=oi)return this.failTimeout();var xt=this.pTime?$.timeStamp-this.pTime<Q.interval:!0,Jt=!this.pCenter||Mn(this.pCenter,$.center)<Q.posThreshold;this.pTime=$.timeStamp,this.pCenter=$.center,!Jt||!xt?this.count=1:this.count+=1,this._input=$;var Ni=this.count%Q.taps;if(Ni===0)return this.hasRequireFailures()?(this._timer=R(function(){this.state=Qt,this.tryEmit()},Q.interval,this),pt):Qt}return Yt},failTimeout:function(){return this._timer=R(function(){this.state=Yt},this.options.interval,this),Yt},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==Qt&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function Zn($,Q){return Q=Q||{},Q.recognizers=Ee(Q.recognizers,Zn.defaults.preset),new In($,Q)}Zn.VERSION="2.0.7",Zn.defaults={domEvents:!1,touchAction:st,enable:!0,inputTarget:null,inputClass:null,preset:[[Fn,{enable:!1}],[Vt,{enable:!1},["rotate"]],[ns,{direction:_n}],[ot,{direction:_n},["swipe"]],[qt],[qt,{event:"doubletap",taps:2},["tap"]],[jt]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var Ns=1,bs=2;function In($,Q){this.options=ae({},Zn.defaults,Q||{}),this.options.inputTarget=this.options.inputTarget||$,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=$,this.input=Qi(this),this.touchAction=new ii(this,this.options.touchAction),Mi(this,!0),H(this.options.recognizers,function(_e){var Fe=this.add(new _e[0](_e[1]));_e[2]&&Fe.recognizeWith(_e[2]),_e[3]&&Fe.requireFailure(_e[3])},this)}In.prototype={set:function($){return ae(this.options,$),$.touchAction&&this.touchAction.update(),$.inputTarget&&(this.input.destroy(),this.input.target=$.inputTarget,this.input.init()),this},stop:function($){this.session.stopped=$?bs:Ns},recognize:function($){var Q=this.session;if(!Q.stopped){this.touchAction.preventDefaults($);var _e,Fe=this.recognizers,it=Q.curRecognizer;(!it||it&&it.state&Qt)&&(it=Q.curRecognizer=null);for(var xt=0;xt<Fe.length;)_e=Fe[xt],Q.stopped!==bs&&(!it||_e==it||_e.canRecognizeWith(it))?_e.recognize($):_e.reset(),!it&&_e.state&(pt|It|Me)&&(it=Q.curRecognizer=_e),xt++}},get:function($){if($ instanceof Fi)return $;for(var Q=this.recognizers,_e=0;_e<Q.length;_e++)if(Q[_e].options.event==$)return Q[_e];return null},add:function($){if(N($,"add",this))return this;var Q=this.get($.options.event);return Q&&this.remove(Q),this.recognizers.push($),$.manager=this,this.touchAction.update(),$},remove:function($){if(N($,"remove",this))return this;if($=this.get($),$){var Q=this.recognizers,_e=ut(Q,$);_e!==-1&&(Q.splice(_e,1),this.touchAction.update())}return this},on:function($,Q){if($!==u&&Q!==u){var _e=this.handlers;return H(Tt($),function(Fe){_e[Fe]=_e[Fe]||[],_e[Fe].push(Q)}),this}},off:function($,Q){if($!==u){var _e=this.handlers;return H(Tt($),function(Fe){Q?_e[Fe]&&_e[Fe].splice(ut(_e[Fe],Q),1):delete _e[Fe]}),this}},emit:function($,Q){this.options.domEvents&&zc($,Q);var _e=this.handlers[$]&&this.handlers[$].slice();if(!(!_e||!_e.length)){Q.type=$,Q.preventDefault=function(){Q.srcEvent.preventDefault()};for(var Fe=0;Fe<_e.length;)_e[Fe](Q),Fe++}},destroy:function(){this.element&&Mi(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function Mi($,Q){var _e=$.element;if(!!_e.style){var Fe;H($.options.cssProps,function(it,xt){Fe=Zt(_e.style,xt),Q?($.oldCssProps[Fe]=_e.style[Fe],_e.style[Fe]=it):_e.style[Fe]=$.oldCssProps[Fe]||""}),Q||($.oldCssProps={})}}function zc($,Q){var _e=i.createEvent("Event");_e.initEvent($,!0,!0),_e.gesture=Q,Q.target.dispatchEvent(_e)}ae(Zn,{INPUT_START:Ai,INPUT_MOVE:Si,INPUT_END:oi,INPUT_CANCEL:yi,STATE_POSSIBLE:Xe,STATE_BEGAN:pt,STATE_CHANGED:It,STATE_ENDED:Me,STATE_RECOGNIZED:Qt,STATE_CANCELLED:$t,STATE_FAILED:Yt,DIRECTION_NONE:hr,DIRECTION_LEFT:fi,DIRECTION_RIGHT:mn,DIRECTION_UP:Kt,DIRECTION_DOWN:gn,DIRECTION_HORIZONTAL:_n,DIRECTION_VERTICAL:tn,DIRECTION_ALL:dr,Manager:In,Input:Ji,TouchAction:ii,TouchInput:F,MouseInput:Wn,PointerEventInput:ts,TouchMouseInput:ge,SingleTouchInput:pr,Recognizer:Fi,AttrRecognizer:vi,Tap:qt,Pan:ot,Swipe:ns,Pinch:Vt,Rotate:Fn,Press:jt,on:dt,off:wt,each:H,merge:De,extend:be,assign:ae,inherit:Oe,bindFn:Ce,prefixed:Zt});var gr=typeof e<"u"?e:typeof self<"u"?self:{};gr.Hammer=Zn,typeof u=="function"&&u.amd?u(function(){return Zn}):n.exports?n.exports=Zn:e[l]=Zn})(window,document,"Hammer")})(kc);const VD=kc.exports,no=YA({__proto__:null,default:VD},[kc.exports]),fT=1,pT=2,T_=4,jD={mousedown:fT,mousemove:pT,mouseup:T_};function GD(n,e){for(let i=0;i<n.length;i++)if(e(n[i]))return!0;return!1}function WD(n){const e=n.prototype.handler;n.prototype.handler=function(l){const u=this.store;l.button>0&&l.type==="pointerdown"&&(GD(u,f=>f.pointerId===l.pointerId)||u.push(l)),e.call(this,l)}}function ZD(n){n.prototype.handler=function(i){let l=jD[i.type];l&fT&&i.button>=0&&(this.pressed=!0),l&pT&&i.which===0&&(l=T_),this.pressed&&(l&T_&&(this.pressed=!1),this.callback(this.manager,l,{pointers:[i],changedPointers:[i],pointerType:"mouse",srcEvent:i}))}}WD(kc.exports.PointerEventInput);ZD(kc.exports.MouseInput);const $D=kc.exports.Manager;class jp{constructor(e,i,l){this.element=e,this.callback=i,this.options={enable:!0,...l}}}const qD=no?[[no.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[no.Rotate,{enable:!1}],[no.Pinch,{enable:!1}],[no.Swipe,{enable:!1}],[no.Pan,{threshold:0,enable:!1}],[no.Press,{enable:!1}],[no.Tap,{event:"doubletap",taps:2,enable:!1}],[no.Tap,{event:"anytap",enable:!1}],[no.Tap,{enable:!1}]]:null,Z1={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},HD={doubletap:["tap"]},XD={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},fy={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},YD={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},$1={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"},KD=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",hc=typeof window<"u"?window:global;let E_=!1;try{const n={get passive(){return E_=!0,!0}};hc.addEventListener("test",null,n),hc.removeEventListener("test",null)}catch{E_=!1}const JD=KD.indexOf("firefox")!==-1,{WHEEL_EVENTS:QD}=fy,q1="wheel",H1=4.000244140625,ez=40,tz=.25;class iz extends jp{constructor(e,i,l){super(e,i,l),this.handleEvent=u=>{if(!this.options.enable)return;let f=u.deltaY;hc.WheelEvent&&(JD&&u.deltaMode===hc.WheelEvent.DOM_DELTA_PIXEL&&(f/=hc.devicePixelRatio),u.deltaMode===hc.WheelEvent.DOM_DELTA_LINE&&(f*=ez)),f!==0&&f%H1===0&&(f=Math.floor(f/H1)),u.shiftKey&&f&&(f=f*tz),this.callback({type:q1,center:{x:u.clientX,y:u.clientY},delta:-f,srcEvent:u,pointerType:"mouse",target:u.target})},this.events=(this.options.events||[]).concat(QD),this.events.forEach(u=>e.addEventListener(u,this.handleEvent,E_?{passive:!1}:!1))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,i){e===q1&&(this.options.enable=i)}}const{MOUSE_EVENTS:nz}=fy,X1="pointermove",Y1="pointerover",K1="pointerout",J1="pointerenter",Q1="pointerleave";class rz extends jp{constructor(e,i,l){super(e,i,l),this.handleEvent=f=>{this.handleOverEvent(f),this.handleOutEvent(f),this.handleEnterEvent(f),this.handleLeaveEvent(f),this.handleMoveEvent(f)},this.pressed=!1;const{enable:u}=this.options;this.enableMoveEvent=u,this.enableLeaveEvent=u,this.enableEnterEvent=u,this.enableOutEvent=u,this.enableOverEvent=u,this.events=(this.options.events||[]).concat(nz),this.events.forEach(f=>e.addEventListener(f,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,i){e===X1&&(this.enableMoveEvent=i),e===Y1&&(this.enableOverEvent=i),e===K1&&(this.enableOutEvent=i),e===J1&&(this.enableEnterEvent=i),e===Q1&&(this.enableLeaveEvent=i)}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit(Y1,e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit(K1,e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit(J1,e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit(Q1,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.which===0&&(this.pressed=!1),this.pressed||this._emit(X1,e);break;case"mouseup":this.pressed=!1;break}}_emit(e,i){this.callback({type:e,center:{x:i.clientX,y:i.clientY},srcEvent:i,pointerType:"mouse",target:i.target})}}const{KEY_EVENTS:sz}=fy,eb="keydown",tb="keyup";class oz extends jp{constructor(e,i,l){super(e,i,l),this.handleEvent=u=>{const f=u.target||u.srcElement;f.tagName==="INPUT"&&f.type==="text"||f.tagName==="TEXTAREA"||(this.enableDownEvent&&u.type==="keydown"&&this.callback({type:eb,srcEvent:u,key:u.key,target:u.target}),this.enableUpEvent&&u.type==="keyup"&&this.callback({type:tb,srcEvent:u,key:u.key,target:u.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(sz),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach(u=>e.addEventListener(u,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,i){e===eb&&(this.enableDownEvent=i),e===tb&&(this.enableUpEvent=i)}}const ib="contextmenu";class az extends jp{constructor(e,i,l){super(e,i,l),this.handleEvent=u=>{!this.options.enable||this.callback({type:ib,center:{x:u.clientX,y:u.clientY},srcEvent:u,pointerType:"mouse",target:u.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,i){e===ib&&(this.options.enable=i)}}const A_=1,Ap=2,S_=4,lz={pointerdown:A_,pointermove:Ap,pointerup:S_,mousedown:A_,mousemove:Ap,mouseup:S_},cz=1,uz=2,hz=3,dz=0,fz=1,pz=2,mz=1,gz=2,_z=4;function yz(n){const e=lz[n.srcEvent.type];if(!e)return null;const{buttons:i,button:l,which:u}=n.srcEvent;let f=!1,y=!1,a=!1;return e===S_||e===Ap&&!Number.isFinite(i)?(f=u===cz,y=u===uz,a=u===hz):e===Ap?(f=Boolean(i&mz),y=Boolean(i&_z),a=Boolean(i&gz)):e===A_&&(f=l===dz,y=l===fz,a=l===pz),{leftButton:f,middleButton:y,rightButton:a}}function xz(n,e){const i=n.center;if(!i)return null;const l=e.getBoundingClientRect(),u=l.width/e.offsetWidth||1,f=l.height/e.offsetHeight||1,y={x:(i.x-l.left-e.clientLeft)/u,y:(i.y-l.top-e.clientTop)/f};return{center:i,offsetCenter:y}}const Bg={srcElement:"root",priority:0};class vz{constructor(e){this.handleEvent=i=>{if(this.isEmpty())return;const l=this._normalizeEvent(i);let u=i.srcEvent.target;for(;u&&u!==l.rootElement;){if(this._emit(l,u),l.handled)return;u=u.parentNode}this._emit(l,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,i,l,u=!1,f=!1){const{handlers:y,handlersByElement:a}=this;let E=Bg;typeof l=="string"||l&&l.addEventListener?E={...Bg,srcElement:l}:l&&(E={...Bg,...l});let I=a.get(E.srcElement);I||(I=[],a.set(E.srcElement,I));const O={type:e,handler:i,srcElement:E.srcElement,priority:E.priority};u&&(O.once=!0),f&&(O.passive=!0),y.push(O),this._active=this._active||!O.passive;let R=I.length-1;for(;R>=0&&!(I[R].priority>=O.priority);)R--;I.splice(R+1,0,O)}remove(e,i){const{handlers:l,handlersByElement:u}=this;for(let f=l.length-1;f>=0;f--){const y=l[f];if(y.type===e&&y.handler===i){l.splice(f,1);const a=u.get(y.srcElement);a.splice(a.indexOf(y),1),a.length===0&&u.delete(y.srcElement)}}this._active=l.some(f=>!f.passive)}_emit(e,i){const l=this.handlersByElement.get(i);if(l){let u=!1;const f=()=>{e.handled=!0},y=()=>{e.handled=!0,u=!0},a=[];for(let E=0;E<l.length;E++){const{type:I,handler:O,once:R}=l[E];if(O({...e,type:I,stopPropagation:f,stopImmediatePropagation:y}),R&&a.push(l[E]),u)break}for(let E=0;E<a.length;E++){const{type:I,handler:O}=a[E];this.remove(I,O)}}}_normalizeEvent(e){const i=this.eventManager.getElement();return{...e,...yz(e),...xz(e,i),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:i}}}const bz={events:null,recognizers:null,recognizerOptions:{},Manager:$D,touchAction:"none",tabIndex:0};class wz{constructor(e=null,i){this._onBasicInput=u=>{const{srcEvent:f}=u,y=XD[f.type];y&&this.manager.emit(y,u)},this._onOtherEvent=u=>{this.manager.emit(u.type,u)},this.options={...bz,...i},this.events=new Map,this.setElement(e);const{events:l}=this.options;l&&this.on(l)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;const{options:i}=this,l=i.Manager;this.manager=new l(e,{touchAction:i.touchAction,recognizers:i.recognizers||qD}).on("hammer.input",this._onBasicInput),i.recognizers||Object.keys(Z1).forEach(u=>{const f=this.manager.get(u);f&&Z1[u].forEach(y=>{f.recognizeWith(y)})});for(const u in i.recognizerOptions){const f=this.manager.get(u);if(f){const y=i.recognizerOptions[u];delete y.enable,f.set(y)}}this.wheelInput=new iz(e,this._onOtherEvent,{enable:!1}),this.moveInput=new rz(e,this._onOtherEvent,{enable:!1}),this.keyInput=new oz(e,this._onOtherEvent,{enable:!1,tabIndex:i.tabIndex}),this.contextmenuInput=new az(e,this._onOtherEvent,{enable:!1});for(const[u,f]of this.events)f.isEmpty()||(this._toggleRecognizer(f.recognizerName,!0),this.manager.on(u,f.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,i,l){this._addEventHandler(e,i,l,!1)}once(e,i,l){this._addEventHandler(e,i,l,!0)}watch(e,i,l){this._addEventHandler(e,i,l,!1,!0)}off(e,i){this._removeEventHandler(e,i)}_toggleRecognizer(e,i){const{manager:l}=this;if(!l)return;const u=l.get(e);if(u&&u.options.enable!==i){u.set({enable:i});const f=HD[e];f&&!this.options.recognizers&&f.forEach(y=>{const a=l.get(y);i?(a.requireFailure(e),u.dropRequireFailure(y)):a.dropRequireFailure(e)})}this.wheelInput.enableEventType(e,i),this.moveInput.enableEventType(e,i),this.keyInput.enableEventType(e,i),this.contextmenuInput.enableEventType(e,i)}_addEventHandler(e,i,l,u,f){if(typeof e!="string"){l=i;for(const O in e)this._addEventHandler(O,e[O],l,u,f);return}const{manager:y,events:a}=this,E=$1[e]||e;let I=a.get(E);I||(I=new vz(this),a.set(E,I),I.recognizerName=YD[E]||E,y&&y.on(E,I.handleEvent)),I.add(e,i,l,u,f),I.isEmpty()||this._toggleRecognizer(I.recognizerName,!0)}_removeEventHandler(e,i){if(typeof e!="string"){for(const y in e)this._removeEventHandler(y,e[y]);return}const{events:l}=this,u=$1[e]||e,f=l.get(u);if(!!f&&(f.remove(e,i),f.isEmpty())){const{recognizerName:y}=f;let a=!1;for(const E of l.values())if(E.recognizerName===y&&!E.isEmpty()){a=!0;break}a||this._toggleRecognizer(y,!1)}}}function ja(){}const Tz=({isDragging:n})=>n?"grabbing":"grab",mT={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:ja,onResize:ja,onViewStateChange:ja,onInteractionStateChange:ja,onBeforeRender:ja,onAfterRender:ja,onLoad:ja,onError:n=>Bi.error(n.message)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:Tz,getTooltip:null,debug:!1,drawPickingColors:!1};class kh{constructor(e){G(this,"props",void 0),G(this,"width",0),G(this,"height",0),G(this,"userData",{}),G(this,"canvas",null),G(this,"viewManager",null),G(this,"layerManager",null),G(this,"effectManager",null),G(this,"deckRenderer",null),G(this,"deckPicker",null),G(this,"eventManager",null),G(this,"tooltip",null),G(this,"metrics",void 0),G(this,"animationLoop",void 0),G(this,"stats",void 0),G(this,"viewState",void 0),G(this,"cursorState",void 0),G(this,"_needsRedraw",void 0),G(this,"_pickRequest",void 0),G(this,"_lastPointerDownInfo",null),G(this,"_metricsCounter",void 0),G(this,"_onPointerMove",i=>{const{_pickRequest:l}=this;if(i.type==="pointerleave")l.x=-1,l.y=-1,l.radius=0;else{if(i.leftButton||i.rightButton)return;{const u=i.offsetCenter;if(!u)return;l.x=u.x,l.y=u.y,l.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:l.x,y:l.y}),l.event=i}),G(this,"_onEvent",i=>{const l=L1[i.type],u=i.offsetCenter;if(!l||!u||!this.layerManager)return;const f=this.layerManager.getLayers(),y=this.deckPicker.getLastPickedObject({x:u.x,y:u.y,layers:f,viewports:this.getViewports(u)},this._lastPointerDownInfo),{layer:a}=y,E=a&&(a[l.handler]||a.props[l.handler]),I=this.props[l.handler];let O=!1;E&&(O=E.call(a,y,i)),!O&&I&&I(y,i)}),G(this,"_onPointerDown",i=>{const l=i.offsetCenter,u=this._pick("pickObject","pickObject Time",{x:l.x,y:l.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=u.result[0]||u.emptyInfo}),this.props={...mT,...e},e=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},e.viewState&&e.initialViewState&&Bi.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),Kb()==="IE"&&Bi.warn("IE 11 is not supported")(),this.viewState=e.initialViewState,e.gl||typeof document<"u"&&(this.canvas=this._createCanvas(e)),this.animationLoop=this._createAnimationLoop(e),this.stats=new W_({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(e),e._typedArrayManagerProps&&Ac.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,i,l,u,f,y,a;if(this.animationLoop.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,(e=this.layerManager)===null||e===void 0||e.finalize(),this.layerManager=null,(i=this.viewManager)===null||i===void 0||i.finalize(),this.viewManager=null,(l=this.effectManager)===null||l===void 0||l.finalize(),this.effectManager=null,(u=this.deckRenderer)===null||u===void 0||u.finalize(),this.deckRenderer=null,(f=this.deckPicker)===null||f===void 0||f.finalize(),this.deckPicker=null,(y=this.eventManager)===null||y===void 0||y.destroy(),this.eventManager=null,(a=this.tooltip)===null||a===void 0||a.remove(),this.tooltip=null,!this.props.canvas&&!this.props.gl&&this.canvas){var E;(E=this.canvas.parentElement)===null||E===void 0||E.removeChild(this.canvas),this.canvas=null}}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&Bi.removed("onLayerHover","onHover")(),"onLayerClick"in e&&Bi.removed("onLayerClick","onClick")(),e.initialViewState&&!Lc(this.props.initialViewState,e.initialViewState)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const i=Object.create(this.props);Object.assign(i,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(i),this.layerManager&&(this.viewManager.setProps(i),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(i),this.effectManager.setProps(i),this.deckRenderer.setProps(i),this.deckPicker.setProps(i)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let i=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const l=this.viewManager.needsRedraw(e),u=this.layerManager.needsRedraw(e),f=this.effectManager.needsRedraw(e),y=this.deckRenderer.needsRedraw(e);return i=i||l||u||f||y,i}redraw(e){if(!this.layerManager)return;let i=this.needsRedraw({clearRedrawFlags:!0});i=e||i,i&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(i):this._drawLayers(i))}get isInitialized(){return this.viewManager!==null}getViews(){return wn(this.viewManager),this.viewManager.views}getViewports(e){return wn(this.viewManager),this.viewManager.getViewports(e)}pickObject(e){const i=this._pick("pickObject","pickObject Time",e).result;return i.length?i[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,i=!1){for(const l in e)this.layerManager.resourceManager.add({resourceId:l,data:e[l],forceUpdate:i})}_removeResources(e){for(const i of e)this.layerManager.resourceManager.remove(i)}_pick(e,i,l){wn(this.deckPicker);const{stats:u}=this;u.get("Pick Count").incrementCount(),u.get(i).timeStart();const f=this.deckPicker[e]({layers:this.layerManager.getLayers(l),views:this.viewManager.getViews(),viewports:this.getViewports(l),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...l});return u.get(i).timeEnd(),f}_createCanvas(e){let i=e.canvas;return typeof i=="string"&&(i=document.getElementById(i),wn(i)),i||(i=document.createElement("canvas"),i.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(i)),Object.assign(i.style,e.style),i}_setCanvasSize(e){if(!this.canvas)return;const{width:i,height:l}=e;if(i||i===0){const f=Number.isFinite(i)?"".concat(i,"px"):i;this.canvas.style.width=f}if(l||l===0){var u;const f=Number.isFinite(l)?"".concat(l,"px"):l;this.canvas.style.position=((u=e.style)===null||u===void 0?void 0:u.position)||"absolute",this.canvas.style.height=f}}_updateCanvasSize(){const{canvas:e}=this;if(!e)return;const i=e.clientWidth||e.width,l=e.clientHeight||e.height;if(i!==this.width||l!==this.height){var u;this.width=i,this.height=l,(u=this.viewManager)===null||u===void 0||u.setProps({width:i,height:l}),this.props.onResize({width:i,height:l})}}_createAnimationLoop(e){const{width:i,height:l,gl:u,glOptions:f,debug:y,onError:a,onBeforeRender:E,onAfterRender:I,useDevicePixels:O}=e;return new g3({width:i,height:l,useDevicePixels:O,autoResizeViewport:!1,gl:u,onCreateContext:R=>gw({...f,...R,canvas:this.canvas,debug:y,onContextLost:()=>this._onContextLost()}),onInitialize:R=>this._setGLContext(R.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:E,onAfterRender:I,onError:a})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let e=this.props.views||[new dy({id:"default-view"})];return e=Array.isArray(e)?e:[e],e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){const{_pickRequest:e}=this;if(e.event){const{result:l,emptyInfo:u}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=l.length>0;let f=u,y=!1;for(const a of l){var i;f=a,y=((i=a.layer)===null||i===void 0?void 0:i.onHover(a,e.event))||y}if(!y&&this.props.onHover&&this.props.onHover(f,e.event),this.props.getTooltip&&this.tooltip){const a=this.props.getTooltip(f);this.tooltip.setTooltip(a,f.x,f.y)}e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(e){if(this.layerManager)return;this.canvas||(this.canvas=e.canvas,K_(e,{enable:!0,copyState:!0})),this.tooltip=new ND(this.canvas),Lo(e,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(e);const i=new $w;i.play(),this.animationLoop.attachTimeline(i),this.eventManager=new wz(this.props.parent||e.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const u in L1)this.eventManager.on(u,this._onEvent);this.viewManager=new iD({timeline:i,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const l=this.viewManager.getViewports()[0];this.layerManager=new tD(e,{deck:this,stats:this.stats,viewport:l,timeline:i}),this.effectManager=new SD,this.deckRenderer=new LD(e),this.deckPicker=new BD(e),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,i){const{gl:l}=this.layerManager.context;Lo(l,this.props.parameters),this.props.onBeforeRender({gl:l}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",redrawReason:e,effects:this.effectManager.getEffects(),...i}),this.props.onAfterRender({gl:l})}_onRenderFrame(e){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),Bi.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const i=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:i},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const i=this.animationLoop.stats;e.get("GPU Time").addTime(i.get("GPU Time").lastTiming),e.get("CPU Time").addTime(i.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:i}=this;e.fps=i.get("frameRate").getHz(),e.setPropsTime=i.get("setProps Time").time,e.updateAttributesTime=i.get("Update Attributes").time,e.framesRedrawn=i.get("Redraw Count").count,e.pickTime=i.get("pickObject Time").time+i.get("pickMultipleObjects Time").time+i.get("pickObjects Time").time,e.pickCount=i.get("Pick Count").count,e.gpuTime=i.get("GPU Time").time,e.cpuTime=i.get("CPU Time").time,e.gpuTimePerFrame=i.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=i.get("CPU Time").getAverageTime();const l=Za.get("Memory Usage");e.bufferMemory=l.get("Buffer Memory").count,e.textureMemory=l.get("Texture Memory").count,e.renderbufferMemory=l.get("Renderbuffer Memory").count,e.gpuMemory=l.get("GPU Memory").count}}G(kh,"defaultProps",mT);G(kh,"VERSION",bP.VERSION);class Fg{constructor(e,i){G(this,"opts",void 0),G(this,"source",void 0),this.opts=i,this.source=e}get value(){return this.source.value}getValue(){const e=this.source.getBuffer(),i=this.getAccessor();if(e)return[e,i];const{value:l}=this.source,{size:u}=i;let f=l;if(l&&l.length!==u){f=new Float32Array(u);const y=i.elementOffset||0;for(let a=0;a<u;++a)f[a]=l[y+a]}return f}getAccessor(){return{...this.source.getAccessor(),...this.opts}}}function Ez(n){switch(n){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function lp(n){return n.stride||n.size*n.bytesPerElement}function gT(n,e){e.offset&&Bi.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const i=lp(n),l=e.vertexOffset!==void 0?e.vertexOffset:n.vertexOffset||0,u=e.elementOffset||0,f=l*i+u*n.bytesPerElement+(n.offset||0);return{...e,offset:f,stride:i}}function Az(n,e){const i=gT(n,e);return{high:i,low:{...i,offset:i.offset+n.size*4}}}class Sz{constructor(e,i,l){G(this,"gl",void 0),G(this,"id",void 0),G(this,"size",void 0),G(this,"settings",void 0),G(this,"value",void 0),G(this,"doublePrecision",void 0),G(this,"_buffer",void 0),G(this,"state",void 0),this.gl=e,this.id=i.id||"",this.size=i.size||1;const u=i.logicalType||i.type,f=u===5130;let{defaultValue:y}=i;y=Number.isFinite(y)?[y]:y||new Array(this.size).fill(0);let a;f?a=5126:!u&&i.isIndexed?a=e&&$I(e,Yi.ELEMENT_INDEX_UINT32)?5125:5123:a=u||5126;let E=Ez(u||a||5126);this.doublePrecision=f,f&&i.fp64===!1&&(E=Float32Array),this.value=null,this.settings={...i,defaultType:E,defaultValue:y,logicalType:u,type:a,size:this.size,bytesPerElement:E.BYTES_PER_ELEMENT},this.state={...l,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){const{isIndexed:e,type:i}=this.settings;this._buffer=new Ui(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:i}})}return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*lp(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Ac.release(this.state.allocatedValue)}getShaderAttributes(e,i){if(this.doublePrecision){const l={},u=this.value instanceof Float64Array,f=Az(this.getAccessor(),i||{});return l[e]=new Fg(this,f.high),l["".concat(e,"64Low")]=u?new Fg(this,f.low):new Float32Array(this.size),l}if(i){const l=gT(this.getAccessor(),i);return{[e]:new Fg(this,l)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const i=Array.from(this.value);e=[i,i]}else{const{value:i,numInstances:l,size:u}=this,f=l*u;if(i&&f&&i.length>=f){const y=new Array(u).fill(1/0),a=new Array(u).fill(-1/0);for(let E=0;E<f;)for(let I=0;I<u;I++){const O=i[E++];O<y[I]&&(y[I]=O),O>a[I]&&(a[I]=O)}e=[y,a]}}return this.state.bounds=e,e}setData(e){const{state:i}=this;let l;ArrayBuffer.isView(e)?l={value:e}:e instanceof Ui?l={buffer:e}:l=e;const u={...this.settings,...l};if(i.bufferAccessor=u,i.bounds=null,l.constant){let f=l.value;if(f=this._normalizeValue(f,[],0),this.settings.normalized&&(f=this.normalizeConstant(f)),!(!i.constant||!this._areValuesEqual(f,this.value)))return!1;i.externalBuffer=null,i.constant=!0,this.value=f}else if(l.buffer){const f=l.buffer;i.externalBuffer=f,i.constant=!1,this.value=l.value||null;const y=l.value instanceof Float64Array;u.type=l.type||f.accessor.type,u.bytesPerElement=f.accessor.BYTES_PER_ELEMENT*(y?2:1),u.stride=lp(u)}else if(l.value){this._checkExternalBuffer(l);let f=l.value;i.externalBuffer=null,i.constant=!1,this.value=f,u.bytesPerElement=f.BYTES_PER_ELEMENT,u.stride=lp(u);const{buffer:y,byteOffset:a}=this;this.doublePrecision&&f instanceof Float64Array&&(f=zg(f,u));const E=f.byteLength+a+u.stride*2;y.byteLength<E&&y.reallocate(E),y.setAccessor(null),y.subData({data:f,offset:a}),u.type=l.type||y.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;const i=this.value,{startOffset:l=0,endOffset:u}=e;this.buffer.subData({data:this.doublePrecision&&i instanceof Float64Array?zg(i,{size:this.size,startIndex:l,endIndex:u}):i.subarray(l,u),offset:l*i.BYTES_PER_ELEMENT+this.byteOffset})}allocate(e,i=!1){const{state:l}=this,u=l.allocatedValue,f=Ac.allocate(u,e+1,{size:this.size,type:this.settings.defaultType,copy:i});this.value=f;const{buffer:y,byteOffset:a}=this;return y.byteLength<f.byteLength+a&&(y.reallocate(f.byteLength+a),i&&u&&y.subData({data:u instanceof Float64Array?zg(u,this):u,offset:a})),l.allocatedValue=f,l.constant=!1,l.externalBuffer=null,l.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){const{value:i}=e;if(!ArrayBuffer.isView(i))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));const l=this.settings.defaultType;let u=!1;if(this.doublePrecision&&(u=i.BYTES_PER_ELEMENT<4),u)throw new Error("Attribute ".concat(this.id," does not support ").concat(i.constructor.name));!(i instanceof l)&&this.settings.normalized&&!("normalized"in e)&&Bi.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(i=>(i+128)/255*2-1);case 5122:return new Float32Array(e).map(i=>(i+32768)/65535*2-1);case 5121:return new Float32Array(e).map(i=>i/255);case 5123:return new Float32Array(e).map(i=>i/65535);default:return e}}_normalizeValue(e,i,l){const{defaultValue:u,size:f}=this.settings;if(Number.isFinite(e))return i[l]=e,i;if(!e)return i[l]=u[0],i;switch(f){case 4:i[l+3]=Number.isFinite(e[3])?e[3]:u[3];case 3:i[l+2]=Number.isFinite(e[2])?e[2]:u[2];case 2:i[l+1]=Number.isFinite(e[1])?e[1]:u[1];case 1:i[l+0]=Number.isFinite(e[0])?e[0]:u[0];break;default:let y=f;for(;--y>=0;)i[l+y]=Number.isFinite(e[y])?e[y]:u[y]}return i}_areValuesEqual(e,i){if(!e||!i)return!1;const{size:l}=this;for(let u=0;u<l;u++)if(e[u]!==i[u])return!1;return!0}}const nb=[],rb=[];function py(n,e=0,i=1/0){let l=nb;const u={index:-1,data:n,target:[]};return n?typeof n[Symbol.iterator]=="function"?l=n:n.length>0&&(rb.length=n.length,l=rb):l=nb,(e>0||Number.isFinite(i))&&(l=(Array.isArray(l)?l:Array.from(l)).slice(e,i),u.index=e-1),{iterable:l,objectInfo:u}}function _T(n){return n&&n[Symbol.asyncIterator]}function yT(n,e){const{size:i,stride:l,offset:u,startIndices:f,nested:y}=e,a=n.BYTES_PER_ELEMENT,E=l?l/a:i,I=u?u/a:0,O=Math.floor((n.length-I)/E);return(R,{index:N,target:H})=>{if(!f){const De=N*E+I;for(let Oe=0;Oe<i;Oe++)H[Oe]=n[De+Oe];return H}const re=f[N],ae=f[N+1]||O;let be;if(y){be=new Array(ae-re);for(let De=re;De<ae;De++){const Oe=De*E+I;H=new Array(i);for(let Ce=0;Ce<i;Ce++)H[Ce]=n[Oe+Ce];be[De-re]=H}}else if(E===i)be=n.subarray(re*i+I,ae*i+I);else{be=new n.constructor((ae-re)*i);let De=0;for(let Oe=re;Oe<ae;Oe++){const Ce=Oe*E+I;for(let Ve=0;Ve<i;Ve++)be[De++]=n[Ce+Ve]}}return be}}const Mz=[],cp=[[0,1/0]];function Pz(n,e){if(n===cp||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return n;const i=[],l=n.length;let u=0;for(let f=0;f<l;f++){const y=n[f];y[1]<e[0]?(i.push(y),u=f+1):y[0]>e[1]?i.push(y):e=[Math.min(y[0],e[0]),Math.max(y[1],e[1])]}return i.splice(u,0,e),i}function Ng(n){const{source:e,target:i,start:l=0,size:u,getData:f}=n,y=n.end||i.length,a=e.length,E=y-l;if(a>E){i.set(e.subarray(0,E),l);return}if(i.set(e,l),!f)return;let I=a;for(;I<E;){const O=f(I,e);for(let R=0;R<u;R++)i[l+I]=O[R]||0,I++}}function Iz({source:n,target:e,size:i,getData:l,sourceStartIndices:u,targetStartIndices:f}){if(!Array.isArray(f))return Ng({source:n,target:e,size:i,getData:l}),e;let y=0,a=0;const E=l&&((O,R)=>l(O+a,R)),I=Math.min(u.length,f.length);for(let O=1;O<I;O++){const R=u[O]*i,N=f[O]*i;Ng({source:n.subarray(y,R),target:e,start:a,end:N,size:i,getData:E}),y=R,a=N}return a<e.length&&Ng({source:[],target:e,start:a,size:i,getData:E}),e}const Cz={interpolation:{duration:0,easing:n=>n},spring:{stiffness:.05,damping:.5}};function xT(n,e){if(!n)return null;Number.isFinite(n)&&(n={type:"interpolation",duration:n});const i=n.type||"interpolation";return{...Cz[i],...e,...n,type:i}}function vT(n,e){const i=e.getBuffer();return i?[i,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function bT(n){switch(n){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(n,'"'))}}function wT(n){n.push(n.shift())}function my(n,e){const{doublePrecision:i,settings:l,value:u,size:f}=n,y=i&&u instanceof Float64Array?2:1;return(l.noAlloc?u.length:e*f)*y}function TT({buffer:n,numInstances:e,attribute:i,fromLength:l,fromStartIndices:u,getData:f=y=>y}){const y=i.doublePrecision&&i.value instanceof Float64Array?2:1,a=i.size*y,E=i.byteOffset,I=i.startIndices,O=u&&I,R=my(i,e),N=i.isConstant;if(!O&&l>=R)return;const H=N?i.value:i.getBuffer().getData({srcByteOffset:E});if(i.settings.normalized&&!N){const De=f;f=(Oe,Ce)=>i.normalizeConstant(De(Oe,Ce))}const re=N?(De,Oe)=>f(H,Oe):(De,Oe)=>f(H.subarray(De,De+a),Oe),ae=n.getData({length:l}),be=new Float32Array(R);Iz({source:ae,target:be,sourceStartIndices:u,targetStartIndices:I,size:a,getData:re}),n.byteLength<be.byteLength+E&&n.reallocate(be.byteLength+E),n.subData({data:be,offset:E})}class gy extends Sz{constructor(e,i){super(e,i,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:cp}),G(this,"constant",!1),this.settings.update=i.update||(i.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const i=this.state.needsRedraw;return this.state.needsRedraw=i&&!e,i}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:i}=this.settings,l=this.settings.transition,u=Array.isArray(i)?e[i.find(f=>e[f])]:e[i];return xT(u,l)}setNeedsUpdate(e=this.id,i){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),i){const{startRow:l=0,endRow:u=1/0}=i;this.state.updateRanges=Pz(this.state.updateRanges,[l,u])}else this.state.updateRanges=cp}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=Mz}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:i,settings:l}=this;return l.noAlloc?!1:l.update?(super.allocate(e,i.updateRanges!==cp),!0):!1}updateBuffer({numInstances:e,data:i,props:l,context:u}){if(!this.needsUpdate())return!1;const{state:{updateRanges:f},settings:{update:y,noAlloc:a}}=this;let E=!0;if(y){for(const[I,O]of f)y.call(u,this,{data:i,startRow:I,endRow:O,props:l,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[I,O]of f){const R=Number.isFinite(I)?this.getVertexOffset(I):0,N=Number.isFinite(O)?this.getVertexOffset(O):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:R,endOffset:N})}this._checkAttributeArray()}else E=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),E}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:i}=this;return e?(this.clearNeedsUpdate(),i.lastExternalBuffer===e||(i.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(i.lastExternalBuffer=null,!1)}setBinaryValue(e,i=null){const{state:l,settings:u}=this;if(!e)return l.binaryValue=null,l.binaryAccessor=null,!1;if(u.noAlloc)return!1;if(l.binaryValue===e)return this.clearNeedsUpdate(),!0;if(l.binaryValue=e,this.setNeedsRedraw(),u.transform||i!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const y=e;wn(ArrayBuffer.isView(y.value),"invalid ".concat(u.accessor));const a=Boolean(y.size)&&y.size!==this.size;return l.binaryAccessor=yT(y.value,{size:y.size||this.size,stride:y.stride,offset:y.offset,startIndices:i,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:i}=this;return(i?i[e]:e)*this.size}getShaderAttributes(){const e=this.settings.shaderAttributes||{[this.id]:null},i={};for(const l in e)Object.assign(i,super.getShaderAttributes(l,e[l]));return i}_autoUpdater(e,{data:i,startRow:l,endRow:u,props:f,numInstances:y}){if(e.constant)return;const{settings:a,state:E,value:I,size:O,startIndices:R}=e,{accessor:N,transform:H}=a,re=E.binaryAccessor||(typeof N=="function"?N:f[N]);wn(typeof re=="function",'accessor "'.concat(N,'" is not a function'));let ae=e.getVertexOffset(l);const{iterable:be,objectInfo:De}=py(i,l,u);for(const Oe of be){De.index++;let Ce=re(Oe,De);if(H&&(Ce=H.call(this,Ce)),R){const Ve=(De.index<R.length-1?R[De.index+1]:y)-R[De.index];if(Ce&&Array.isArray(Ce[0])){let Ee=ae;for(const dt of Ce)e._normalizeValue(dt,I,Ee),Ee+=O}else Ce&&Ce.length>O?I.set(Ce,ae):(e._normalizeValue(Ce,De.target,0),YR({target:I,source:De.target,start:ae,count:Ve}));ae+=Ve*O}else e._normalizeValue(Ce,I,ae),ae+=O}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){const{value:e}=this,i=Math.min(4,this.size);if(e&&e.length>=i){let l=!0;switch(i){case 4:l=l&&Number.isFinite(e[3]);case 3:l=l&&Number.isFinite(e[2]);case 2:l=l&&Number.isFinite(e[1]);case 1:l=l&&Number.isFinite(e[0]);break;default:l=!1}if(!l)throw new Error("Illegal attribute generated for ".concat(this.id))}}}class Lz{constructor({gl:e,attribute:i,timeline:l}){G(this,"gl",void 0),G(this,"type","interpolation"),G(this,"attributeInTransition",void 0),G(this,"settings",void 0),G(this,"attribute",void 0),G(this,"transition",void 0),G(this,"currentStartIndices",void 0),G(this,"currentLength",void 0),G(this,"transform",void 0),G(this,"buffers",void 0),this.gl=e,this.transition=new Yh(l),this.attribute=i,this.attributeInTransition=new gy(e,i.settings),this.currentStartIndices=i.startIndices,this.currentLength=0,this.transform=Rz(e,i);const u={byteLength:0,usage:35050};this.buffers=[new Ui(e,u),new Ui(e,u)]}get inProgress(){return this.transition.inProgress}start(e,i){if(e.duration<=0){this.transition.cancel();return}this.settings=e;const{gl:l,buffers:u,attribute:f}=this;wT(u);const y={numInstances:i,attribute:f,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(const a of u)TT({buffer:a,...y});this.currentStartIndices=f.startIndices,this.currentLength=my(f,i),this.attributeInTransition.setData({buffer:u[1],value:f.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/f.size),sourceBuffers:{aFrom:u[0],aTo:vT(l,f)},feedbackBuffers:{vCurrent:u[1]}})}update(){const e=this.transition.update();if(e){const{duration:i,easing:l}=this.settings,{time:u}=this.transition;let f=u/i;l&&(f=l(f)),this.transform.run({uniforms:{time:f}})}return e}cancel(){this.transition.cancel(),this.transform.delete();for(const e of this.buffers)e.delete();this.buffers.length=0}}const kz=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function Rz(n,e){const i=bT(e.size);return new sy(n,{vs:kz,defines:{ATTRIBUTE_TYPE:i},varyings:["vCurrent"]})}class Dz{constructor({gl:e,attribute:i,timeline:l}){G(this,"gl",void 0),G(this,"type","spring"),G(this,"attributeInTransition",void 0),G(this,"settings",void 0),G(this,"attribute",void 0),G(this,"transition",void 0),G(this,"currentStartIndices",void 0),G(this,"currentLength",void 0),G(this,"texture",void 0),G(this,"framebuffer",void 0),G(this,"transform",void 0),G(this,"buffers",void 0),this.gl=e,this.type="spring",this.transition=new Yh(l),this.attribute=i,this.attributeInTransition=new gy(e,{...i.settings,normalized:!1}),this.currentStartIndices=i.startIndices,this.currentLength=0,this.texture=Oz(e),this.framebuffer=Bz(e,this.texture),this.transform=zz(e,i,this.framebuffer);const u={byteLength:0,usage:35050};this.buffers=[new Ui(e,u),new Ui(e,u),new Ui(e,u)]}get inProgress(){return this.transition.inProgress}start(e,i){const{gl:l,buffers:u,attribute:f}=this,y={numInstances:i,attribute:f,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(const a of u)TT({buffer:a,...y});this.settings=e,this.currentStartIndices=f.startIndices,this.currentLength=my(f,i),this.attributeInTransition.setData({buffer:u[1],value:f.value}),this.transition.start({...e,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/f.size),sourceBuffers:{aTo:vT(l,f)}})}update(){const{buffers:e,transform:i,framebuffer:l,transition:u}=this;if(!u.update())return!1;const y=this.settings;return i.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),i.run({framebuffer:l,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:y.stiffness,damping:y.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),wT(e),this.attributeInTransition.setData({buffer:e[1],value:this.attribute.value}),Fp(l)[0]>0||u.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(const e of this.buffers)e.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}}function zz(n,e,i){const l=bT(e.size);return new sy(n,{framebuffer:i,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:l},varyings:["vNext"]})}function Oz(n){return new qr(n,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function Bz(n,e){return new En(n,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}const Fz={interpolation:Lz,spring:Dz};class Nz{constructor(e,{id:i,timeline:l}){G(this,"id",void 0),G(this,"isSupported",void 0),G(this,"gl",void 0),G(this,"timeline",void 0),G(this,"transitions",void 0),G(this,"needsRedraw",void 0),G(this,"numInstances",void 0),this.id=i,this.gl=e,this.timeline=l,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=sy.isSupported(e)}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:i,numInstances:l}){this.numInstances=l||1;for(const u in e){const f=e[u],y=f.getTransitionSetting(i);!y||this._updateAttribute(u,f,y)}for(const u in this.transitions){const f=e[u];(!f||!f.getTransitionSetting(i))&&this._removeTransition(u)}}hasAttribute(e){const i=this.transitions[e];return i&&i.inProgress}getAttributes(){const e={};for(const i in this.transitions){const l=this.transitions[i];l.inProgress&&(e[i]=l.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(const i in this.transitions)this.transitions[i].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,i,l){const u=this.transitions[e];let f=!u||u.type!==l.type;if(f){if(!this.isSupported){Bi.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}u&&this._removeTransition(e);const y=Fz[l.type];y?this.transitions[e]=new y({attribute:i,timeline:this.timeline,gl:this.gl}):(Bi.error("unsupported transition type '".concat(l.type,"'"))(),f=!1)}(f||i.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(l,this.numInstances))}}const sb="attributeManager.invalidate",Uz="attributeManager.updateStart",Vz="attributeManager.updateEnd",jz="attribute.updateStart",Gz="attribute.allocate",Wz="attribute.updateEnd";class Zz{constructor(e,{id:i="attribute-manager",stats:l,timeline:u}={}){G(this,"id",void 0),G(this,"gl",void 0),G(this,"attributes",void 0),G(this,"updateTriggers",void 0),G(this,"needsRedraw",void 0),G(this,"userData",void 0),G(this,"stats",void 0),G(this,"attributeTransitionManager",void 0),this.id=i,this.gl=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=l,this.attributeTransitionManager=new Nz(e,{id:"".concat(i,"-transitions"),timeline:u}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const i=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,i&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(const i of e)this.attributes[i]!==void 0&&(this.attributes[i].delete(),delete this.attributes[i])}invalidate(e,i){const l=this._invalidateTrigger(e,i);cr(sb,this,e,l)}invalidateAll(e){for(const i in this.attributes)this.attributes[i].setNeedsUpdate(i,e);cr(sb,this,"all")}update({data:e,numInstances:i,startIndices:l=null,transitions:u,props:f={},buffers:y={},context:a={}}){let E=!1;cr(Uz,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const I in this.attributes){const O=this.attributes[I],R=O.settings.accessor;O.startIndices=l,O.numInstances=i,f[I]&&Bi.removed("props.".concat(I),"data.attributes.".concat(I))(),O.setExternalBuffer(y[I])||O.setBinaryValue(typeof R=="string"?y[R]:void 0,e.startIndices)||typeof R=="string"&&!y[R]&&O.setConstantValue(f[R])||O.needsUpdate()&&(E=!0,this._updateAttribute({attribute:O,numInstances:i,data:e,props:f,context:a})),this.needsRedraw=this.needsRedraw||O.needsRedraw()}E&&cr(Vz,this,i),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:i,transitions:u})}updateTransition(){const{attributeTransitionManager:e}=this,i=e.run();return this.needsRedraw=this.needsRedraw||i,i}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:i,attributeTransitionManager:l}=this,u={...l.getAttributes()};for(const f in i){const y=i[f];y.needsRedraw(e)&&!l.hasAttribute(f)&&(u[f]=y)}return u}getShaderAttributes(e,i={}){e||(e=this.getAttributes());const l={};for(const u in e)i[u]||Object.assign(l,e[u].getShaderAttributes());return l}_add(e,i={}){for(const l in e){const u=e[l];this.attributes[l]=this._createAttribute(l,u,i)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,i,l){const u={...i,id:e,size:i.isIndexed&&1||i.size||1,divisor:l.instanced?1:i.divisor||0};return new gy(this.gl,u)}_mapUpdateTriggersToAttributes(){const e={};for(const i in this.attributes)this.attributes[i].getUpdateTriggers().forEach(u=>{e[u]||(e[u]=[]),e[u].push(i)});this.updateTriggers=e}_invalidateTrigger(e,i){const{attributes:l,updateTriggers:u}=this,f=u[e];return f&&f.forEach(y=>{const a=l[y];a&&a.setNeedsUpdate(a.id,i)}),f}_updateAttribute(e){const{attribute:i,numInstances:l}=e;if(cr(jz,i),i.constant){i.setConstantValue(i.value);return}i.allocate(l)&&cr(Gz,i,l),i.updateBuffer(e)&&(this.needsRedraw=!0,cr(Wz,i,l))}}class $z extends Yh{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:i,toValue:l,duration:u,easing:f}}=this,y=f(e/u);this._value=yp(i,l,y)}}const ob=1e-5;function ab(n,e,i,l,u){const f=e-n,a=(i-e)*u,E=-f*l;return a+E+f+e}function qz(n,e,i,l,u){if(Array.isArray(i)){const f=[];for(let y=0;y<i.length;y++)f[y]=ab(n[y],e[y],i[y],l,u);return f}return ab(n,e,i,l,u)}function lb(n,e){if(Array.isArray(n)){let i=0;for(let l=0;l<n.length;l++){const u=n[l]-e[l];i+=u*u}return Math.sqrt(i)}return Math.abs(n-e)}class Hz extends Yh{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:i,damping:l,stiffness:u}=this.settings,{_prevValue:f=e,_currValue:y=e}=this;let a=qz(f,y,i,l,u);const E=lb(a,i),I=lb(a,y);E<ob&&I<ob&&(a=i,this.end()),this._prevValue=y,this._currValue=a}}const Xz={interpolation:$z,spring:Hz};class Yz{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,i,l,u){const{transitions:f}=this;if(f.has(e)){const E=f.get(e),{value:I=E.settings.fromValue}=E;i=I,this.remove(e)}if(u=xT(u),!u)return;const y=Xz[u.type];if(!y){Bi.error("unsupported transition type '".concat(u.type,"'"))();return}const a=new y(this.timeline);a.start({...u,fromValue:i,toValue:l}),f.set(e,a)}remove(e){const{transitions:i}=this;i.has(e)&&(i.get(e).cancel(),i.delete(e))}update(){const e={};for(const[i,l]of this.transitions)l.update(),e[i]=l.value,l.inProgress||this.remove(i);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function Kz(n){const e=_y(n);for(const i in e){const l=e[i],{validate:u}=l;if(u&&!u(n[i],l))throw new Error("Invalid prop ".concat(i,": ").concat(n[i]))}}function Jz(n,e){const i=ET({newProps:n,oldProps:e,propTypes:_y(n),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),l=eO(n,e);let u=!1;return l||(u=tO(n,e)),{dataChanged:l,propsChanged:i,updateTriggersChanged:u,extensionsChanged:iO(n,e),transitionsChanged:Qz(n,e)}}function Qz(n,e){if(!n.transitions)return!1;const i={},l=_y(n);let u=!1;for(const f in n.transitions){const y=l[f],a=y&&y.type;(a==="number"||a==="color"||a==="array")&&M_(n[f],e[f],y)&&(i[f]=!0,u=!0)}return u?i:!1}function ET({newProps:n,oldProps:e,ignoreProps:i={},propTypes:l={},triggerName:u="props"}){if(e===n)return!1;if(typeof n!="object"||n===null||typeof e!="object"||e===null)return"".concat(u," changed shallowly");for(const f of Object.keys(n))if(!(f in i)){if(!(f in e))return"".concat(u,".").concat(f," added");const y=M_(n[f],e[f],l[f]);if(y)return"".concat(u,".").concat(f," ").concat(y)}for(const f of Object.keys(e))if(!(f in i)){if(!(f in n))return"".concat(u,".").concat(f," dropped");if(!Object.hasOwnProperty.call(n,f)){const y=M_(n[f],e[f],l[f]);if(y)return"".concat(u,".").concat(f," ").concat(y)}}return!1}function M_(n,e,i){let l=i&&i.equal;return l&&!l(n,e,i)||!l&&(l=n&&e&&n.equals,l&&!l.call(n,e))?"changed deeply":!l&&e!==n?"changed shallowly":null}function eO(n,e){if(e===null)return"oldProps is null, initial diff";let i=!1;const{dataComparator:l,_dataDiff:u}=n;return l?l(n.data,e.data)||(i="Data comparator detected a change"):n.data!==e.data&&(i="A new data container was supplied"),i&&u&&(i=u(n.data,e.data)||i),i}function tO(n,e){if(e===null)return{all:!0};if("all"in n.updateTriggers&&cb(n,e,"all"))return{all:!0};const i={};let l=!1;for(const u in n.updateTriggers)u!=="all"&&cb(n,e,u)&&(i[u]=!0,l=!0);return l?i:!1}function iO(n,e){if(e===null)return!0;const i=e.extensions,{extensions:l}=n;if(l===i)return!1;if(!i||!l||l.length!==i.length)return!0;for(let u=0;u<l.length;u++)if(!l[u].equals(i[u]))return!0;return!1}function cb(n,e,i){let l=n.updateTriggers[i];l=l??{};let u=e.updateTriggers[i];return u=u??{},ET({oldProps:u,newProps:l,triggerName:i})}function _y(n){const e=n[Ep],i=e&&e.constructor;return i?i._propTypes:{}}const nO="count(): argument not an object",rO="count(): argument not a container";function sO(n){if(!aO(n))throw new Error(nO);if(typeof n.count=="function")return n.count();if(Number.isFinite(n.size))return n.size;if(Number.isFinite(n.length))return n.length;if(oO(n))return Object.keys(n).length;throw new Error(rO)}function oO(n){return n!==null&&typeof n=="object"&&n.constructor===Object}function aO(n){return n!==null&&typeof n=="object"}function lO(n,e){if(!e)return n;const i={...n,...e};if("defines"in e&&(i.defines={...n.defines,...e.defines}),"modules"in e&&(i.modules=(n.modules||[]).concat(e.modules),e.modules.some(l=>l.name==="project64"))){const l=i.modules.findIndex(u=>u.name==="project32");l>=0&&i.modules.splice(l,1)}if("inject"in e)if(!n.inject)i.inject=e.inject;else{const l={...n.inject};for(const u in e.inject)l[u]=(l[u]||"")+e.inject[u];i.inject=l}return i}const cO={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},P_={};function uO(n,e){const i=n.context&&n.context.gl;if(!i||!e)return null;if(e instanceof qr)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let l=null;e.compressed&&(l={[10241]:e.data.length>1?9985:9729});const u=new qr(i,{...e,parameters:{...cO,...l,...n.props.textureParameters}});return P_[u.id]=!0,u}function hO(n){!n||!(n instanceof qr)||P_[n.id]&&(n.delete(),delete P_[n.id])}const dO={boolean:{validate(n,e){return!0},equal(n,e,i){return Boolean(n)===Boolean(e)}},number:{validate(n,e){return Number.isFinite(n)&&(!("max"in e)||n<=e.max)&&(!("min"in e)||n>=e.min)}},color:{validate(n,e){return e.optional&&!n||Rh(n)&&(n.length===3||n.length===4)},equal(n,e,i){return Ug(n,e)}},accessor:{validate(n,e){const i=Sp(n);return i==="function"||i===Sp(e.value)},equal(n,e,i){return typeof e=="function"?!0:Ug(n,e)}},array:{validate(n,e){return e.optional&&!n||Rh(n)},equal(n,e,i){return i.compare?Ug(n,e):n===e}},object:{equal(n,e,i){return i.compare?Lc(n,e):n===e}},function:{validate(n,e){return e.optional&&!n||typeof n=="function"},equal(n,e,i){return!i.compare||n===e}},data:{transform:(n,e,i)=>{const{dataTransform:l}=i.props;return l&&n?l(n):n}},image:{transform:(n,e,i)=>uO(i,n),release:n=>{hO(n)}}};function Ug(n,e){if(n===e)return!0;if(!Rh(n)||!Rh(e))return!1;const i=n.length;if(i!==e.length)return!1;for(let l=0;l<i;l++)if(n[l]!==e[l])return!1;return!0}function fO(n){const e={},i={},l={};for(const[u,f]of Object.entries(n)){const y=f?.deprecatedFor;if(y)l[u]=Array.isArray(y)?y:[y];else{const a=pO(u,f);e[u]=a,i[u]=a.value}}return{propTypes:e,defaultProps:i,deprecatedProps:l}}function pO(n,e){switch(Sp(e)){case"object":return mh(n,e);case"array":return mh(n,{type:"array",value:e,compare:!1});case"boolean":return mh(n,{type:"boolean",value:e});case"number":return mh(n,{type:"number",value:e});case"function":return mh(n,{type:"function",value:e,compare:!0});default:return{name:n,type:"unknown",value:e}}}function mh(n,e){return"type"in e?{name:n,...dO[e.type],...e}:"value"in e?{name:n,type:Sp(e.value),...e}:{name:n,type:"object",value:e}}function Rh(n){return Array.isArray(n)||ArrayBuffer.isView(n)}function Sp(n){return Rh(n)?"array":n===null?"null":typeof n}function mO(n,e){const i=AT(n.constructor),l=Object.create(i);l[Ep]=n,l[Xa]={},l[oa]={};for(let u=0;u<e.length;++u){const f=e[u];for(const y in f)l[y]=f[y]}return Object.freeze(l),l}function AT(n){const e=Mp(n,"_mergedDefaultProps");return e||(gO(n),n._mergedDefaultProps)}function gO(n){if(!n.prototype)return;const i=Object.getPrototypeOf(n),l=AT(i),u=Mp(n,"defaultProps")||{},f=fO(u),y=_O(f.defaultProps,l,n),a={...i._propTypes,...f.propTypes};xO(y,a);const E={...i._deprecatedProps,...f.deprecatedProps};yO(y,E),n._mergedDefaultProps=y,n._propTypes=a,n._deprecatedProps=E}function _O(n,e,i){const l=Object.create(null);Object.assign(l,e,n);const u=bO(i);return delete n.id,Object.defineProperties(l,{id:{writable:!0,value:u}}),l}function yO(n,e){for(const i in e)Object.defineProperty(n,i,{enumerable:!1,set(l){const u="".concat(this.id,": ").concat(i);for(const f of e[i])ST(this,f)||(this[f]=l);Bi.deprecated(u,e[i].join("/"))()}})}function xO(n,e){const i={},l={};for(const u in e){const f=e[u],{name:y,value:a}=f;f.async&&(i[y]=a,l[y]=vO(y))}n[mc]=i,n[Xa]={},Object.defineProperties(n,l)}function vO(n){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||_T(e)?this[Xa][n]=e:this[oa][n]=e},get(){if(this[oa]){if(n in this[oa])return this[oa][n]||this[mc][n];if(n in this[Xa]){const e=this[Ep]&&this[Ep].internalState;if(e&&e.hasAsyncProp(n))return e.getAsyncProp(n)||this[mc][n]}}return this[mc][n]}}}function ST(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Mp(n,e){return ST(n,e)&&n[e]}function bO(n){const e=Mp(n,"layerName")||Mp(n,"componentName");return e||Bi.once(0,"".concat(n.name,".componentName not specified"))(),e||n.name}let wO=0;class yy{constructor(...e){G(this,"id",void 0),G(this,"props",void 0),G(this,"count",void 0),this.props=mO(this,e),this.id=this.props.id,this.count=wO++}clone(e){const{props:i}=this,l={};for(const u in i[mc])u in i[oa]?l[u]=i[oa][u]:u in i[Xa]&&(l[u]=i[Xa][u]);return new this.constructor({...i,...l,...e})}}G(yy,"componentName","Component");G(yy,"defaultProps",{});const TO=Object.freeze({});class EO{constructor(e){G(this,"component",void 0),G(this,"onAsyncPropUpdated",void 0),G(this,"asyncProps",void 0),G(this,"oldProps",void 0),G(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const i=this.asyncProps[e];i&&i.type&&i.type.release&&i.type.release(i.resolvedValue,i.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||TO}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const i=this.asyncProps[e];return i&&i.resolvedValue}isAsyncPropLoading(e){if(e){const i=this.asyncProps[e];return Boolean(i&&i.pendingLoadCount>0&&i.pendingLoadCount!==i.resolvedLoadCount)}for(const i in this.asyncProps)if(this.isAsyncPropLoading(i))return!0;return!1}reloadAsyncProp(e,i){this._watchPromise(e,Promise.resolve(i))}setAsyncProps(e){const i=e[oa]||{},l=e[Xa]||e,u=e[mc]||{};for(const f in i){const y=i[f];this._createAsyncPropData(f,u[f]),this._updateAsyncProp(f,y),i[f]=this.getAsyncProp(f)}for(const f in l){const y=l[f];this._createAsyncPropData(f,u[f]),this._updateAsyncProp(f,y)}}_fetch(e,i){return null}_onResolve(e,i){}_onError(e,i){}_updateAsyncProp(e,i){if(!!this._didAsyncInputValueChange(e,i)){if(typeof i=="string"&&(i=this._fetch(e,i)),i instanceof Promise){this._watchPromise(e,i);return}if(_T(i)){this._resolveAsyncIterable(e,i);return}this._setPropValue(e,i)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,i){const l=this.asyncProps[e];return i===l.resolvedValue||i===l.lastValue?!1:(l.lastValue=i,!0)}_setPropValue(e,i){this._freezeAsyncOldProps();const l=this.asyncProps[e];l&&(i=this._postProcessValue(l,i),l.resolvedValue=i,l.pendingLoadCount++,l.resolvedLoadCount=l.pendingLoadCount)}_setAsyncPropValue(e,i,l){const u=this.asyncProps[e];u&&l>=u.resolvedLoadCount&&i!==void 0&&(this._freezeAsyncOldProps(),u.resolvedValue=i,u.resolvedLoadCount=l,this.onAsyncPropUpdated(e,i))}_watchPromise(e,i){const l=this.asyncProps[e];if(l){l.pendingLoadCount++;const u=l.pendingLoadCount;i.then(f=>{f=this._postProcessValue(l,f),this._setAsyncPropValue(e,f,u),this._onResolve(e,f)}).catch(f=>{this._onError(e,f)})}}async _resolveAsyncIterable(e,i){if(e!=="data"){this._setPropValue(e,i);return}const l=this.asyncProps[e];if(!l)return;l.pendingLoadCount++;const u=l.pendingLoadCount;let f=[],y=0;for await(const a of i){const{dataTransform:E}=this.component.props;E?f=E(a,f):f=f.concat(a),Object.defineProperty(f,"__diff",{enumerable:!1,value:[{startRow:y,endRow:f.length}]}),y=f.length,this._setAsyncPropValue(e,f,u)}this._onResolve(e,f)}_postProcessValue(e,i){const l=e.type;return l&&(l.release&&l.release(e.resolvedValue,l,this.component),l.transform)?l.transform(i,l,this.component):i}_createAsyncPropData(e,i){if(!this.asyncProps[e]){const u=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:u&&u[e],lastValue:null,resolvedValue:i,pendingLoadCount:0,resolvedLoadCount:0}}}}class AO extends EO{constructor({attributeManager:e,layer:i}){super(i),G(this,"attributeManager",void 0),G(this,"needsRedraw",void 0),G(this,"needsUpdate",void 0),G(this,"subLayers",void 0),G(this,"usesPickingColorCache",void 0),G(this,"changeFlags",void 0),G(this,"viewport",void 0),G(this,"uniformTransitions",void 0),G(this,"propsInTransition",void 0),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,i){const l=this.component.props.fetch;return l?l(i,{propName:e,layer:this.layer}):super._fetch(e,i)}_onResolve(e,i){const l=this.component.props.onDataLoad;e==="data"&&l&&l(i,{propName:e,layer:this.layer})}_onError(e,i){this.layer.raiseError(i,"loading ".concat(e," of ").concat(this.layer))}}const SO="layer.changeFlag",MO="layer.initialize",PO="layer.update",IO="layer.finalize",CO="layer.matched",ub=2**24-1,LO=Object.freeze([]),kO=Np(({oldViewport:n,viewport:e})=>n.equals(e));let ro=new Uint8ClampedArray(0);const RO={data:{type:"data",value:LO,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:n=>n&&n.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(n,{propName:e,layer:i,loaders:l,loadOptions:u,signal:f})=>{const{resourceManager:y}=i.context;if(u=u||i.getLoadOptions(),l=l||i.props.loaders,f){var a;u={...u,fetch:{...(a=u)===null||a===void 0?void 0:a.fetch,signal:f}}}let E=y.contains(n);return!E&&!u&&(y.add({resourceId:n,data:r_(n,l),persistent:!1}),E=!0),E?y.subscribe({resourceId:n,onChange:I=>{var O;return(O=i.internalState)===null||O===void 0?void 0:O.reloadAsyncProp(e,I)},consumerId:i.id,requestId:e}):r_(n,l,u)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:Xh.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:Pi.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:n})=>[0,-n*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class Rc extends yy{constructor(...e){super(...e),G(this,"internalState",null),G(this,"lifecycle",cc.NO_STATE),G(this,"context",void 0),G(this,"state",void 0),G(this,"parent",null)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){const e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}project(e){wn(this.internalState);const i=this.internalState.viewport||this.context.viewport,l=rT(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[u,f,y]=eT(l,i.pixelProjectionMatrix);return e.length===2?[u,f]:[u,f,y]}unproject(e){return wn(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,i){wn(this.internalState);const l=this.internalState.viewport||this.context.viewport;return XR(e,{viewport:l,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...i})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(e){for(const i of this.getModels())i.updateModuleSettings(e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===Pi.DEFAULT||e===Pi.LNGLAT||e===Pi.CARTESIAN}onHover(e,i){return this.props.onHover&&this.props.onHover(e,i)||!1}onClick(e,i){return this.props.onClick&&this.props.onClick(e,i)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,i=[]){return i[0]=e+1&255,i[1]=e+1>>8&255,i[2]=e+1>>8>>8&255,i}decodePickingColor(e){wn(e instanceof Uint8Array);const[i,l,u]=e;return i+l*256+u*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:sO(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;const i=this.getAttributeManager();if(!i)return null;const{positions:l,instancePositions:u}=i.attributes;return(e=l||u)===null||e===void 0?void 0:e.getBounds()}getShaders(e){for(const i of this.props.extensions)e=lO(e,i.getShaders.call(this,i));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const i=this.getAttributeManager(),{dataChanged:l}=e.changeFlags;if(l&&i)if(Array.isArray(l))for(const E of l)i.invalidateAll(E);else i.invalidateAll();const{props:u,oldProps:f}=e,y=Number.isInteger(f.highlightedObjectIndex)||f.pickable,a=Number.isInteger(u.highlightedObjectIndex)||u.pickable;if(y!==a&&i){const{pickingColors:E,instancePickingColors:I}=i.attributes,O=E||I;O&&(a&&O.constant&&(O.constant=!1,i.invalidate(O.id)),!O.value&&!a&&(O.constant=!0,O.value=[0,0,0]))}}finalizeState(e){for(const l of this.getModels())l.delete();const i=this.getAttributeManager();i&&i.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const i of this.getModels())i.draw(e)}getPickingInfo({info:e,mode:i,sourceLayer:l}){const{index:u}=e;return u>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[u]),e}raiseError(e,i){var l,u;if(i&&(e.message="".concat(i,": ").concat(e.message)),!((l=(u=this.props).onError)!==null&&l!==void 0&&l.call(u,e))){var f,y;(f=this.context)===null||f===void 0||(y=f.onError)===null||y===void 0||y.call(f,e,this)}}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)===null||e===void 0?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const i=this.internalState.viewport;this.internalState.viewport=e,(!i||!kO({oldViewport:i,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const i=this.getAttributeManager();!i||(e==="all"?i.invalidateAll():i.invalidate(e))}updateAttributes(e){for(const i of this.getModels())this._setModelAttributes(i,e)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const i=this.props,l=this.getNumInstances(),u=this.getStartIndices();e.update({data:i.data,numInstances:l,startIndices:u,props:i,transitions:i.transitions,buffers:i.data.attributes,context:this});const f=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(f)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const i=e.update(),l=Object.create(this.props);for(const u in i)Object.defineProperty(l,u,{value:i[u]});return l}return this.props}calculateInstancePickingColors(e,{numInstances:i}){if(e.constant)return;const l=Math.floor(ro.length/3);if(this.internalState.usesPickingColorCache=!0,l<i){i>ub&&Bi.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),ro=Ac.allocate(ro,i,{size:3,copy:!0,maxCount:Math.max(i,ub)});const u=Math.floor(ro.length/3),f=[];for(let y=l;y<u;y++)this.encodePickingColor(y,f),ro[y*3+0]=f[0],ro[y*3+1]=f[1],ro[y*3+2]=f[2]}e.value=ro.subarray(0,i*3)}_setModelAttributes(e,i){const l=this.getAttributeManager(),u=e.userData.excludeAttributes||{},f=l.getShaderAttributes(i,u);e.setAttributes(f)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:i,instancePickingColors:l}=this.getAttributeManager().attributes,u=i||l;if(!u)return;const f=u.getVertexOffset(e),y=u.getVertexOffset(e+1);u.buffer.subData({data:new Uint8Array(y-f),offset:f})}restorePickingColors(){const{pickingColors:e,instancePickingColors:i}=this.getAttributeManager().attributes,l=e||i;!l||(this.internalState.usesPickingColorCache&&l.value.buffer!==ro.buffer&&(l.value=ro.subarray(0,l.value.length)),l.updateSubBuffer({startOffset:0}))}_initialize(){wn(!this.internalState),wn(Number.isFinite(this.props.coordinateSystem)),cr(MO,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new AO({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(Bi.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new Yz(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const i of this.props.extensions)i.initializeState.call(this,this.context,i);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){cr(CO,this,this===e);const{state:i,internalState:l}=e;this!==e&&(this.internalState=l,this.internalState.layer=this,this.state=i,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(cr(PO,this,e),!e)return;const i=this.props,l=this.context,u=this.internalState,f=l.viewport,y=this._updateUniformTransition();u.propsInTransition=y,l.viewport=u.viewport||f,this.props=y;try{const a=this._getUpdateParams(),E=this.getModels();if(l.gl)this.updateState(a);else try{this.updateState(a)}catch{}for(const O of this.props.extensions)O.updateState.call(this,a,O);const I=this.getModels()[0]!==E[0];this._postUpdate(a,I)}finally{l.viewport=f,this.props=i,this._clearChangeFlags(),u.needsUpdate=!1,u.resetOldProps()}}_finalize(){cr(IO,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,e)}_drawLayer({moduleParameters:e=null,uniforms:i={},parameters:l={}}){this._updateAttributeTransition();const u=this.props,f=this.context;this.props=this.internalState.propsInTransition||u;const y=this.props.opacity;i.opacity=Math.pow(y,1/2.2);try{e&&this.setModuleParameters(e);const{getPolygonOffset:a}=this.props,E=a&&a(i)||[0,0];Lo(f.gl,{polygonOffset:E}),gs(f.gl,l,()=>{const I={moduleParameters:e,uniforms:i,parameters:l,context:f};for(const O of this.props.extensions)O.draw.call(this,I,O);this.draw(I)})}finally{this.props=u}}getChangeFlags(){var e;return(e=this.internalState)===null||e===void 0?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:i}=this.internalState;for(const u in e)if(e[u]){let f=!1;switch(u){case"dataChanged":const y=e[u],a=i[u];y&&Array.isArray(a)&&(i.dataChanged=Array.isArray(y)?a.concat(y):y,f=!0);default:i[u]||(i[u]=e[u],f=!0)}f&&cr(SO,this,u,e)}const l=Boolean(i.dataChanged||i.updateTriggersChanged||i.propsChanged||i.extensionsChanged);i.propsOrDataChanged=l,i.somethingChanged=l||i.viewportChanged||i.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,i){const l=Jz(e,i);if(l.updateTriggersChanged)for(const f in l.updateTriggersChanged)l.updateTriggersChanged[f]&&this.invalidateAttribute(f);if(l.transitionsChanged)for(const f in l.transitionsChanged){var u;this.internalState.uniformTransitions.add(f,i[f],e[f],(u=e.transitions)===null||u===void 0?void 0:u[f])}return this.setChangeFlags(l)}validateProps(){Kz(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const i={pickingSelectedColor:e.picked?e.color:null},{highlightColor:l}=this.props;e.picked&&typeof l=="function"&&(i.pickingHighlightColor=l(e)),this.setModuleParameters(i),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new Zz(e.gl,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,i){const{props:l,oldProps:u}=e;this.setNeedsRedraw(),this._updateAttributes();const{model:f}=this.state;f?.setInstanceCount(this.getNumInstances());const{autoHighlight:y,highlightedObjectIndex:a,highlightColor:E}=l;if(i||u.autoHighlight!==y||u.highlightedObjectIndex!==a||u.highlightColor!==E){const I={};y||(I.pickingSelectedColor=null),Array.isArray(E)&&(I.pickingHighlightColor=E),Number.isInteger(a)&&(I.pickingSelectedColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setModuleParameters(I)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let i=!1;i=i||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;const l=this.getAttributeManager(),u=l?l.getNeedsRedraw(e):!1;return i=i||u,i}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}G(Rc,"defaultProps",RO);G(Rc,"layerName","Layer");const DO="compositeLayer.renderLayers";class MT extends Rc{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:i}=e;return i&&i.__source&&i.__source.parent&&i.__source.parent.id===this.id&&(e.object=i.__source.object,e.index=i.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,i){return i&&i.length}getSubLayerClass(e,i){const{_subLayerProps:l}=this.props;return l&&l[e]&&l[e].type||i}getSubLayerRow(e,i,l){return e.__source={parent:this,object:i,index:l},e}getSubLayerAccessor(e){if(typeof e=="function"){const i={index:-1,data:this.props.data,target:[]};return(l,u)=>l&&l.__source?(i.index=l.__source.index,e(l.__source.object,i)):e(l,u)}return e}getSubLayerProps(e={}){var i;const{opacity:l,pickable:u,visible:f,parameters:y,getPolygonOffset:a,highlightedObjectIndex:E,autoHighlight:I,highlightColor:O,coordinateSystem:R,coordinateOrigin:N,wrapLongitude:H,positionFormat:re,modelMatrix:ae,extensions:be,fetch:De,operation:Oe,_subLayerProps:Ce}=this.props,Ve={id:"",updateTriggers:{},opacity:l,pickable:u,visible:f,parameters:y,getPolygonOffset:a,highlightedObjectIndex:E,autoHighlight:I,highlightColor:O,coordinateSystem:R,coordinateOrigin:N,wrapLongitude:H,positionFormat:re,modelMatrix:ae,extensions:be,fetch:De,operation:Oe},Ee=Ce&&e.id&&Ce[e.id],dt=Ee&&Ee.updateTriggers,wt=e.id||"sublayer";if(Ee){const kt=this.constructor._propTypes,et=e.type?e.type._propTypes:{};for(const Tt in Ee){const ut=et[Tt]||kt[Tt];ut&&ut.type==="accessor"&&(Ee[Tt]=this.getSubLayerAccessor(Ee[Tt]))}}Object.assign(Ve,e,Ee),Ve.id="".concat(this.props.id,"-").concat(wt),Ve.updateTriggers={all:(i=this.props.updateTriggers)===null||i===void 0?void 0:i.all,...e.updateTriggers,...dt};for(const kt of be){const et=kt.getSubLayerProps.call(this,kt);et&&Object.assign(Ve,et,{updateTriggers:Object.assign(Ve.updateTriggers,et.updateTriggers)})}return Ve}_updateAutoHighlight(e){for(const i of this.getSubLayers())i.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,i){let l=this.internalState.subLayers;const u=!l||this.needsUpdate();if(u){const f=this.renderLayers();l=Sc(f,Boolean),this.internalState.subLayers=l}cr(DO,this,u,l);for(const f of l)f.parent=this}}G(MT,"layerName","CompositeLayer");class PT{constructor(e){G(this,"opts",void 0),G(this,"typedArrayManager",void 0),G(this,"indexStarts",[0]),G(this,"vertexStarts",[0]),G(this,"vertexCount",0),G(this,"instanceCount",0),G(this,"attributes",void 0),G(this,"_attributeDefs",void 0),G(this,"data",void 0),G(this,"getGeometry",void 0),G(this,"geometryBuffer",void 0),G(this,"buffers",void 0),G(this,"positionSize",void 0),G(this,"normalize",void 0);const{attributes:i={}}=e;this.typedArrayManager=Ac,this.attributes={},this._attributeDefs=i,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:i,buffers:l={},getGeometry:u,geometryBuffer:f,positionFormat:y,dataChanged:a,normalize:E=!0}=this.opts;if(this.data=i,this.getGeometry=u,this.positionSize=f&&f.size||(y==="XY"?2:3),this.buffers=l,this.normalize=E,f&&(wn(i.startIndices),this.getGeometry=this.getGeometryFromBuffer(f),E||(l.positions=f)),this.geometryBuffer=l.positions,Array.isArray(a))for(const I of a)this._rebuildGeometry(I);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:i}){this._rebuildGeometry({startRow:e,endRow:i})}getGeometryFromBuffer(e){const i=e.value||e;return ArrayBuffer.isView(i)?yT(i,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,i){const{attributes:l,buffers:u,_attributeDefs:f,typedArrayManager:y}=this;for(const a in f)if(a in u)y.release(l[a]),l[a]=null;else{const E=f[a];E.copy=i,l[a]=y.allocate(l[a],e,E)}}_forEachGeometry(e,i,l){const{data:u,getGeometry:f}=this,{iterable:y,objectInfo:a}=py(u,i,l);for(const E of y){a.index++;const I=f?f(E,a):null;e(I,a.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:i,vertexStarts:l,instanceCount:u}=this;const{data:f,geometryBuffer:y}=this,{startRow:a=0,endRow:E=1/0}=e||{},I={};if(e||(i=[0],l=[0]),this.normalize||!y)this._forEachGeometry((R,N)=>{const H=R&&this.normalizeGeometry(R);I[N]=H,l[N+1]=l[N]+(H?this.getGeometrySize(H):0)},a,E),u=l[l.length-1];else if(l=f.startIndices,u=l[f.length]||0,ArrayBuffer.isView(y))u=u||y.length/this.positionSize;else if(y instanceof Ui){const R=y.accessor.stride||this.positionSize*4;u=u||y.byteLength/R}else if(y.buffer){const R=y.stride||this.positionSize*4;u=u||y.buffer.byteLength/R}else if(y.value){const R=y.value,N=y.stride/R.BYTES_PER_ELEMENT||this.positionSize;u=u||R.length/N}this._allocate(u,Boolean(e)),this.indexStarts=i,this.vertexStarts=l,this.instanceCount=u;const O={};this._forEachGeometry((R,N)=>{const H=I[N]||R;O.vertexStart=l[N],O.indexStart=i[N];const re=N<l.length-1?l[N+1]:u;O.geometrySize=re-l[N],O.geometryIndex=N,this.updateGeometryAttributes(H,O)},a,E),this.vertexCount=i[i.length-1]}}function zO({map:n,gl:e,deck:i}){if(n.__deck)return n.__deck;const l=i?.props._customRender,u={useDevicePixels:!0,_customRender:()=>{n.triggerRepaint(),l?.("")},parameters:{depthMask:!0,depthTest:!0,blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthFunc:515,blendEquation:32774},views:i&&i.props.views||[new dy({id:"mapbox"})]};let f;return(!i||i.props.gl===e)&&(Object.assign(u,{gl:e,width:null,height:null,touchAction:"unset",viewState:Dh(n)}),n.on("move",()=>jO(f,n))),i?(f=i,i.setProps(u),i.userData.isExternal=!0):(f=new kh(u),n.on("remove",()=>{f.finalize(),n.__deck=null})),f.userData.mapboxLayers=new Set,f.userData.mapboxVersion=UO(n),n.__deck=f,n.on("render",()=>{f.isInitialized&&VO(f,n)}),f}function OO(n,e){n.userData.mapboxLayers.add(e),xy(n)}function BO(n,e){n.userData.mapboxLayers.delete(e),xy(n)}function FO(n,e){xy(n)}function NO(n,e,i){let{currentViewport:l}=n.userData,u=!1;l||(l=IT(n,e,!0),n.userData.currentViewport=l,u=!0),n.isInitialized&&n._drawLayers("mapbox-repaint",{viewports:[l],layerFilter:({layer:f})=>i.id===f.id,clearStack:u,clearCanvas:!1})}function Dh(n){const{lng:e,lat:i}=n.getCenter();return{longitude:(e+540)%360-180,latitude:i,zoom:n.getZoom(),bearing:n.getBearing(),pitch:n.getPitch(),padding:n.getPadding(),repeat:n.getRenderWorldCopies()}}function UO(n){let e=0,i=0;const l=n.version;return l&&([e,i]=l.split(".").slice(0,2).map(Number)),{major:e,minor:i}}function IT(n,e,i=!0){const{mapboxVersion:l}=n.userData;return new Ro(Object.assign({id:"mapbox",x:0,y:0,width:n.width,height:n.height},Dh(e),i?{nearZMultiplier:l.major===1&&l.minor>=3||l.major>=2?.02:1/(n.height||1)}:{nearZMultiplier:.1}))}function VO(n,e){const{mapboxLayers:i,isExternal:l}=n.userData;if(l){const u=Array.from(i,O=>O.id),y=Sc(n.props.layers,Boolean).some(O=>O&&!u.includes(O.id));let a=n.getViewports();const E=a.findIndex(O=>O.id==="mapbox"),I=a.length>1||E<0;(y||I)&&(E>=0&&(a=a.slice(),a[E]=IT(n,e,!1)),n._drawLayers("mapbox-repaint",{viewports:a,layerFilter:O=>(!n.props.layerFilter||n.props.layerFilter(O))&&(O.viewport.id!=="mapbox"||!u.includes(O.layer.id)),clearCanvas:!1}))}n.userData.currentViewport=null}function jO(n,e){n.setProps({viewState:Dh(e)}),n.needsRedraw({clearRedrawFlags:!0})}function xy(n){if(n.userData.isExternal)return;const e=[];n.userData.mapboxLayers.forEach(i=>{const l=i.props.type,u=new l(i.props);e.push(u)}),n.setProps({layers:e})}class GO{constructor(e){if(G(this,"id",void 0),G(this,"type",void 0),G(this,"renderingMode",void 0),G(this,"map",void 0),G(this,"deck",void 0),G(this,"props",void 0),!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.map=null,this.deck=null,this.props=e}onAdd(e,i){this.map=e,this.deck=zO({map:e,gl:i,deck:this.props.deck}),OO(this.deck,this)}onRemove(){this.deck&&BO(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&FO(this.deck)}render(){NO(this.deck,this.map,this)}}const Vg="__UNDEFINED__";function qf(n,e,i,l){if(!n||!e||!n.style||!n.style._loaded)return;const u=Sc(l,Boolean);if(i!==l){const a=Sc(i,Boolean),E=new Set(a.map(I=>I.id));for(const I of u)E.delete(I.id);for(const I of E)n.getLayer(I)&&n.removeLayer(I)}for(const a of u){const E=n.getLayer(a.id);E?E.implementation.setProps(a.props):n.addLayer(new GO({id:a.id,deck:e}),a.props.beforeId)}const f=n.style._order,y={};for(const a of u){let{beforeId:E}=a.props;(!E||!f.includes(E))&&(E=Vg),y[E]=y[E]||[],y[E].push(a.id)}for(const a in y){const E=y[a];let I=a===Vg?f.length:f.indexOf(a),O=a===Vg?void 0:a;for(let R=E.length-1;R>=0;R--){const N=E[R],H=f.indexOf(N);H!==I-1&&(n.moveLayer(N,O),H>I&&I++),I--,O=N}}}class WO{constructor(e){G(this,"_props",void 0),G(this,"_deck",void 0),G(this,"_map",void 0),G(this,"_container",void 0),G(this,"_interleaved",void 0),G(this,"_handleStyleChange",()=>{qf(this._map,this._deck,this._props.layers,this._props.layers)}),G(this,"_updateContainerSize",()=>{if(this._map&&this._container){const{clientWidth:u,clientHeight:f}=this._map.getContainer();Object.assign(this._container.style,{width:"".concat(u,"px"),height:"".concat(f,"px")})}}),G(this,"_updateViewState",()=>{const u=this._deck;u&&(u.setProps({viewState:Dh(this._map)}),u.redraw())}),G(this,"_handleMouseEvent",u=>{const f=this._deck;if(!f)return;const y={type:u.type,offsetCenter:u.point,srcEvent:u};switch(u.type){case"click":y.tapCount=1,f._onPointerDown(y),f._onEvent(y);break;case"dblclick":y.type="click",y.tapCount=2,f._onEvent(y);break;case"mousemove":y.type="pointermove",f._onPointerMove(y);break;case"mouseout":y.type="pointerleave",f._onPointerMove(y);break;default:return}});const{interleaved:i=!1,...l}=e;this._interleaved=i,this._props=l}setProps(e){this._interleaved&&e.layers&&qf(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,e),this._deck&&this._deck.setProps(this._props)}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const i=document.createElement("div");return Object.assign(i.style,{position:"absolute",left:0,top:0,pointerEvents:"none"}),this._container=i,this._deck=new kh({...this._props,parent:i,viewState:Dh(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),i}_onAddInterleaved(e){return this._deck=new kh({...this._props,gl:e.painter.context.gl}),e.on("styledata",this._handleStyleChange),qf(e,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){var e;const i=this._map;i&&(this._interleaved?this._onRemoveInterleaved(i):this._onRemoveOverlaid(i)),(e=this._deck)===null||e===void 0||e.finalize(),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent)}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),qf(e,this._deck,this._props.layers,[])}getDefaultPosition(){return"top-left"}pickObject(e){return wn(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return wn(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return wn(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}}const ZO=`#define SHADER_NAME scatterplot-layer-vertex-shader

attribute vec3 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceRadius;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform float radiusScale;
uniform float radiusMinPixels;
uniform float radiusMaxPixels;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform float stroked;
uniform bool filled;
uniform bool antialiasing;
uniform bool billboard;
uniform int radiusUnits;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;


void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  outerRadiusPixels = clamp(
    project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),
    radiusMinPixels, radiusMaxPixels
  );
  
  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  outerRadiusPixels += stroked * lineWidthPixels / 2.0;

  // Expand geometry to accomodate edge smoothing
  float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;

  // position on the containing square in [-1, 1] space
  unitPosition = edgePadding * positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;

  innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;
  
  if (billboard) {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = edgePadding * positions * outerRadiusPixels;
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
  }

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,$O=`#define SHADER_NAME scatterplot-layer-fragment-shader

precision highp float;

uniform bool filled;
uniform float stroked;
uniform bool antialiasing;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;

void main(void) {
  geometry.uv = unitPosition;

  float distToCenter = length(unitPosition) * outerRadiusPixels;
  float inCircle = antialiasing ? 
    smoothedge(distToCenter, outerRadiusPixels) : 
    step(distToCenter, outerRadiusPixels);

  if (inCircle == 0.0) {
    discard;
  }

  if (stroked > 0.5) {
    float isLine = antialiasing ? 
      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
      step(innerUnitRadius * outerRadiusPixels, distToCenter);

    if (filled) {
      gl_FragColor = mix(vFillColor, vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inCircle;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,hb=[0,0,0,255],qO={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:n=>n.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:hb},getLineColor:{type:"accessor",value:hb},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class vy extends Rc{getShaders(){return super.getShaders({vs:ZO,fs:$O,modules:[ly,uy]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){if(super.updateState(e),e.changeFlags.extensionsChanged){var i;const{gl:l}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(l),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{radiusUnits:i,radiusScale:l,radiusMinPixels:u,radiusMaxPixels:f,stroked:y,filled:a,billboard:E,antialiasing:I,lineWidthUnits:O,lineWidthScale:R,lineWidthMinPixels:N,lineWidthMaxPixels:H}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:y?1:0,filled:a,billboard:E,antialiasing:I,radiusUnits:Ch[i],radiusScale:l,radiusMinPixels:u,radiusMaxPixels:f,lineWidthUnits:Ch[O],lineWidthScale:R,lineWidthMinPixels:N,lineWidthMaxPixels:H}).draw()}_getModel(e){const i=[-1,-1,0,1,-1,0,1,1,0,-1,1,0];return new Ih(e,{...this.getShaders(),id:this.props.id,geometry:new oy({drawMode:6,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array(i)}}}),isInstanced:!0})}}G(vy,"defaultProps",qO);G(vy,"layerName","ScatterplotLayer");const CT={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function LT(n,e,i={}){return HO(n,i)!==e?(YO(n,i),!0):!1}function HO(n,e={}){return Math.sign(XO(n,e))}function XO(n,e={}){const{start:i=0,end:l=n.length}=e,u=e.size||2;let f=0;for(let y=i,a=l-u;y<l;y+=u)f+=(n[y]-n[a])*(n[y+1]+n[a+1]),a=y;return f/2}function YO(n,e){const{start:i=0,end:l=n.length,size:u=2}=e,f=(l-i)/u,y=Math.floor(f/2);for(let a=0;a<y;++a){const E=i+a*u,I=i+(f-1-a)*u;for(let O=0;O<u;++O){const R=n[E+O];n[E+O]=n[I+O],n[I+O]=R}}}function Os(n,e){const i=e.length,l=n.length;if(l>0){let u=!0;for(let f=0;f<i;f++)if(n[l-i+f]!==e[f]){u=!1;break}if(u)return!1}for(let u=0;u<i;u++)n[l+u]=e[u];return!0}function I_(n,e){const i=e.length;for(let l=0;l<i;l++)n[l]=e[l]}function zh(n,e,i,l,u=[]){const f=l+e*i;for(let y=0;y<i;y++)u[y]=n[f+y];return u}function C_(n,e,i,l,u=[]){let f,y;if(i&8)f=(l[3]-n[1])/(e[1]-n[1]),y=3;else if(i&4)f=(l[1]-n[1])/(e[1]-n[1]),y=1;else if(i&2)f=(l[2]-n[0])/(e[0]-n[0]),y=2;else if(i&1)f=(l[0]-n[0])/(e[0]-n[0]),y=0;else return null;for(let a=0;a<n.length;a++)u[a]=(y&1)===a?l[y]:f*(e[a]-n[a])+n[a];return u}function up(n,e){let i=0;return n[0]<e[0]?i|=1:n[0]>e[2]&&(i|=2),n[1]<e[1]?i|=4:n[1]>e[3]&&(i|=8),i}function kT(n,e){const{size:i=2,broken:l=!1,gridResolution:u=10,gridOffset:f=[0,0],startIndex:y=0,endIndex:a=n.length}=e||{},E=(a-y)/i;let I=[];const O=[I],R=zh(n,0,i,y);let N,H;const re=DT(R,u,f,[]),ae=[];Os(I,R);for(let be=1;be<E;be++){for(N=zh(n,be,i,y,N),H=up(N,re);H;){C_(R,N,H,re,ae);const De=up(ae,re);De&&(C_(R,ae,De,re,ae),H=De),Os(I,ae),I_(R,ae),JO(re,u,H),l&&I.length>i&&(I=[],O.push(I),Os(I,R)),H=up(N,re)}Os(I,N),I_(R,N)}return l?O:O[0]}const db=0,KO=1;function Hf(n,e){for(let i=0;i<e.length;i++)n.push(e[i]);return n}function RT(n,e=null,i){if(!n.length)return[];const{size:l=2,gridResolution:u=10,gridOffset:f=[0,0],edgeTypes:y=!1}=i||{},a=[],E=[{pos:n,types:y?new Array(n.length/l).fill(KO):null,holes:e||[]}],I=[[],[]];let O=[];for(;E.length;){const{pos:R,types:N,holes:H}=E.shift();QO(R,l,H[0]||R.length,I),O=DT(I[0],u,f,O);const re=up(I[1],O);if(re){let ae=fb(R,N,l,0,H[0]||R.length,O,re);const be={pos:ae[0].pos,types:ae[0].types,holes:[]},De={pos:ae[1].pos,types:ae[1].types,holes:[]};E.push(be,De);for(let Oe=0;Oe<H.length;Oe++)ae=fb(R,N,l,H[Oe],H[Oe+1]||R.length,O,re),ae[0]&&(be.holes.push(be.pos.length),be.pos=Hf(be.pos,ae[0].pos),y&&(be.types=Hf(be.types,ae[0].types))),ae[1]&&(De.holes.push(De.pos.length),De.pos=Hf(De.pos,ae[1].pos),y&&(De.types=Hf(De.types,ae[1].types)))}else{const ae={positions:R};y&&(ae.edgeTypes=N),H.length&&(ae.holeIndices=H),a.push(ae)}}return a}function fb(n,e,i,l,u,f,y){const a=(u-l)/i,E=[],I=[],O=[],R=[],N=[];let H,re,ae;const be=zh(n,a-1,i,l);let De=Math.sign(y&8?be[1]-f[3]:be[0]-f[2]),Oe=e&&e[a-1],Ce=0,Ve=0;for(let Ee=0;Ee<a;Ee++)H=zh(n,Ee,i,l,H),re=Math.sign(y&8?H[1]-f[3]:H[0]-f[2]),ae=e&&e[l/i+Ee],re&&De&&De!==re&&(C_(be,H,y,f,N),Os(E,N)&&O.push(Oe),Os(I,N)&&R.push(Oe)),re<=0?(Os(E,H)&&O.push(ae),Ce-=re):O.length&&(O[O.length-1]=db),re>=0?(Os(I,H)&&R.push(ae),Ve+=re):R.length&&(R[R.length-1]=db),I_(be,H),De=re,Oe=ae;return[Ce?{pos:E,types:e&&O}:null,Ve?{pos:I,types:e&&R}:null]}function DT(n,e,i,l){const u=Math.floor((n[0]-i[0])/e)*e+i[0],f=Math.floor((n[1]-i[1])/e)*e+i[1];return l[0]=u,l[1]=f,l[2]=u+e,l[3]=f+e,l}function JO(n,e,i){i&8?(n[1]+=e,n[3]+=e):i&4?(n[1]-=e,n[3]-=e):i&2?(n[0]+=e,n[2]+=e):i&1&&(n[0]-=e,n[2]-=e)}function QO(n,e,i,l){let u=1/0,f=-1/0,y=1/0,a=-1/0;for(let E=0;E<i;E+=e){const I=n[E],O=n[E+1];u=I<u?I:u,f=I>f?I:f,y=O<y?O:y,a=O>a?O:a}return l[0][0]=u,l[0][1]=y,l[1][0]=f,l[1][1]=a,l}const e4=85.051129;function t4(n,e){const{size:i=2,startIndex:l=0,endIndex:u=n.length,normalize:f=!0}=e||{},y=n.slice(l,u);zT(y,i,0,u-l);const a=kT(y,{size:i,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(f)for(const E of a)OT(E,i);return a}function i4(n,e=null,i){const{size:l=2,normalize:u=!0,edgeTypes:f=!1}=i||{};e=e||[];const y=[],a=[];let E=0,I=0;for(let R=0;R<=e.length;R++){const N=e[R]||n.length,H=I,re=n4(n,l,E,N);for(let ae=re;ae<N;ae++)y[I++]=n[ae];for(let ae=E;ae<re;ae++)y[I++]=n[ae];zT(y,l,H,I),r4(y,l,H,I,i?.maxLatitude),E=N,a[R]=I}a.pop();const O=RT(y,a,{size:l,gridResolution:360,gridOffset:[-180,-180],edgeTypes:f});if(u)for(const R of O)OT(R.positions,l);return O}function n4(n,e,i,l){let u=-1,f=-1;for(let y=i+1;y<l;y+=e){const a=Math.abs(n[y]);a>u&&(u=a,f=y-1)}return f}function r4(n,e,i,l,u=e4){const f=n[i],y=n[l-e];if(Math.abs(f-y)>180){const a=zh(n,0,e,i);a[0]+=Math.round((y-f)/360)*360,Os(n,a),a[1]=Math.sign(a[1])*u,Os(n,a),a[0]=f,Os(n,a)}}function zT(n,e,i,l){let u=n[0],f;for(let y=i;y<l;y+=e){f=n[y];const a=f-u;(a>180||a<-180)&&(f-=Math.round(a/360)*360),n[y]=u=f}}function OT(n,e){let i;const l=n.length/e;for(let f=0;f<l&&(i=n[f*e],(i+180)%360===0);f++);const u=-Math.round(i/360)*360;if(u!==0)for(let f=0;f<l;f++)n[f*e]+=u}function s4(n,e,i,l){let u;if(Array.isArray(n[0])){const f=n.length*e;u=new Array(f);for(let y=0;y<n.length;y++)for(let a=0;a<e;a++)u[y*e+a]=n[y][a]||0}else u=n;return i?kT(u,{size:e,gridResolution:i}):l?t4(u,{size:e}):u}const o4=1,a4=2,jg=4;class l4 extends PT{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?s4(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(pb(e)){let l=0;for(const u of e)l+=this.getGeometrySize(u);return l}const i=this.getPathLength(e);return i<2?0:this.isClosed(e)?i<3?0:i+2:i}updateGeometryAttributes(e,i){if(i.geometrySize!==0)if(e&&pb(e))for(const l of e){const u=this.getGeometrySize(l);i.geometrySize=u,this.updateGeometryAttributes(l,i),i.vertexStart+=u}else this._updateSegmentTypes(e,i),this._updatePositions(e,i)}_updateSegmentTypes(e,i){const l=this.attributes.segmentTypes,u=e?this.isClosed(e):!1,{vertexStart:f,geometrySize:y}=i;l.fill(0,f,f+y),u?(l[f]=jg,l[f+y-2]=jg):(l[f]+=o4,l[f+y-2]+=a4),l[f+y-1]=jg}_updatePositions(e,i){const{positions:l}=this.attributes;if(!l||!e)return;const{vertexStart:u,geometrySize:f}=i,y=new Array(3);for(let a=u,E=0;E<f;a++,E++)this.getPointOnPath(e,E,y),l[a*3]=y[0],l[a*3+1]=y[1],l[a*3+2]=y[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,i,l=[]){const{positionSize:u}=this;i*u>=e.length&&(i+=1-e.length/u);const f=i*u;return l[0]=e[f],l[1]=e[f+1],l[2]=u===3&&e[f+2]||0,l}isClosed(e){if(!this.normalize)return Boolean(this.opts.loop);const{positionSize:i}=this,l=e.length-i;return e[0]===e[l]&&e[1]===e[l+1]&&(i===2||e[2]===e[l+2])}}function pb(n){return Array.isArray(n[0])}const c4=`#define SHADER_NAME path-layer-vertex-shader

attribute vec2 positions;

attribute float instanceTypes;
attribute vec3 instanceStartPositions;
attribute vec3 instanceEndPositions;
attribute vec3 instanceLeftPositions;
attribute vec3 instanceRightPositions;
attribute vec3 instanceLeftPositions64Low;
attribute vec3 instanceStartPositions64Low;
attribute vec3 instanceEndPositions64Low;
attribute vec3 instanceRightPositions64Low;
attribute float instanceStrokeWidths;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;

uniform float opacity;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}

// calculate line join positions
vec3 lineJoin(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  // side of the segment - -1: left, 0: center, 1: right
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);

  // tangent of the corner
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  // direction of the corner
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  // direction of the segment
  vec2 dir = isEnd ? dirA : dirB;
  // direction of the extrusion
  vec2 perp = isEnd ? perpA : perpB;
  // length of the segment
  float L = isEnd ? lenA : lenB;

  // A = angle of the corner
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));

  // -1: right, 1: left
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);

  // relative position to the corner:
  // -1: inside (smaller side of the angle)
  // 0: center
  // 1: outside (bigger side of the angle)
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  // trim if inside corner extends further than the line segment
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);

  // special treatment for start cap and end cap
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;

  // extend out a triangle to envelope the round cap
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = capType;
  } else {
    vJointType = jointType;
  }

  // Generate variables for fragment shader
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return currPoint + offset;
}

// In clipspace extrusion, if a line extends behind the camera, clip it to avoid visual artifacts
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
    widthMinPixels, widthMaxPixels) / 2.0);
  vec3 width;

  if (billboard) {
    // Extrude in clipspace
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 pos = lineJoin(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    gl_Position = vec4(pos * currPositionScreen.w, currPositionScreen.w);
  } else {
    // Extrude in commonspace
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec4 pos = vec4(
      lineJoin(prevPosition, currPosition, nextPosition, width.xy),
      1.0);
    geometry.position = pos;
    gl_Position = project_common_position_to_clipspace(pos);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,u4=`#define SHADER_NAME path-layer-fragment-shader

precision highp float;

uniform float miterLimit;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
/*
 * vPathPosition represents the relative coordinates of the current fragment on the path segment.
 * vPathPosition.x - position along the width of the path, between [-1, 1]. 0 is the center line.
 * vPathPosition.y - position along the length of the path, between [0, L / width].
 */
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    // if joint is rounded, test distance from the corner
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    // trim miter
    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
      discard;
    }
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,BT=[0,0,0,255],h4={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:n=>n.path},getColor:{type:"accessor",value:BT},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},Gg={enter:(n,e)=>e.length?e.subarray(e.length-n.length):n};class Gp extends Rc{constructor(...e){super(...e),G(this,"state",void 0)}getShaders(){return super.getShaders({vs:c4,fs:u4,modules:[ly,uy]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:Gg,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:Gg,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:Gg,defaultValue:BT},instancePickingColors:{size:3,type:5121,accessor:(l,{index:u,target:f})=>this.encodePickingColor(l&&l.__source?l.__source.index:u,f)}}),this.setState({pathTesselator:new l4({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);const{props:i,changeFlags:l}=e,u=this.getAttributeManager();if(l.dataChanged||l.updateTriggersChanged&&(l.updateTriggersChanged.all||l.updateTriggersChanged.getPath)){const{pathTesselator:a}=this.state,E=i.data.attributes||{};a.updateGeometry({data:i.data,geometryBuffer:E.getPath,buffers:E,normalize:!i._pathType,loop:i._pathType==="loop",getGeometry:i.getPath,positionFormat:i.positionFormat,wrapLongitude:i.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:l.dataChanged}),this.setState({numInstances:a.instanceCount,startIndices:a.vertexStarts}),l.dataChanged||u.invalidateAll()}if(l.extensionsChanged){var y;const{gl:a}=this.context;(y=this.state.model)===null||y===void 0||y.delete(),this.state.model=this._getModel(a),u.invalidateAll()}}getPickingInfo(e){const i=super.getPickingInfo(e),{index:l}=i,{data:u}=this.props;return u[0]&&u[0].__source&&(i.object=u.find(f=>f.__source.index===l)),i}disablePickingIndex(e){const{data:i}=this.props;if(i[0]&&i[0].__source)for(let l=0;l<i.length;l++)i[l].__source.index===e&&this._disablePickingIndex(l);else this._disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:i,capRounded:l,billboard:u,miterLimit:f,widthUnits:y,widthScale:a,widthMinPixels:E,widthMaxPixels:I}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(i),capType:Number(l),billboard:u,widthUnits:Ch[y],widthScale:a,miterLimit:f,widthMinPixels:E,widthMaxPixels:I}).draw()}_getModel(e){const i=[0,1,2,1,4,2,1,3,4,3,5,4],l=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Ih(e,{...this.getShaders(),id:this.props.id,geometry:new oy({drawMode:4,attributes:{indices:new Uint16Array(i),positions:{value:new Float32Array(l),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:i}=this.state;e.startIndices=i.vertexStarts,e.value=i.get("positions")}calculateSegmentTypes(e){const{pathTesselator:i}=this.state;e.startIndices=i.vertexStarts,e.value=i.get("segmentTypes")}}G(Gp,"defaultProps",h4);G(Gp,"layerName","PathLayer");var by={exports:{}};by.exports=Wp;by.exports.default=Wp;function Wp(n,e,i){i=i||2;var l=e&&e.length,u=l?e[0]*i:n.length,f=FT(n,0,u,i,!0),y=[];if(!f||f.next===f.prev)return y;var a,E,I,O,R,N,H;if(l&&(f=g4(n,e,f,i)),n.length>80*i){a=I=n[0],E=O=n[1];for(var re=i;re<u;re+=i)R=n[re],N=n[re+1],R<a&&(a=R),N<E&&(E=N),R>I&&(I=R),N>O&&(O=N);H=Math.max(I-a,O-E),H=H!==0?32767/H:0}return Oh(f,y,i,a,E,H,0),y}function FT(n,e,i,l,u){var f,y;if(u===R_(n,e,i,l)>0)for(f=e;f<i;f+=l)y=mb(f,n[f],n[f+1],y);else for(f=i-l;f>=e;f-=l)y=mb(f,n[f],n[f+1],y);return y&&Zp(y,y.next)&&(Fh(y),y=y.next),y}function Ya(n,e){if(!n)return n;e||(e=n);var i=n,l;do if(l=!1,!i.steiner&&(Zp(i,i.next)||on(i.prev,i,i.next)===0)){if(Fh(i),i=e=i.prev,i===i.next)break;l=!0}else i=i.next;while(l||i!==e);return e}function Oh(n,e,i,l,u,f,y){if(!!n){!y&&f&&b4(n,l,u,f);for(var a=n,E,I;n.prev!==n.next;){if(E=n.prev,I=n.next,f?f4(n,l,u,f):d4(n)){e.push(E.i/i|0),e.push(n.i/i|0),e.push(I.i/i|0),Fh(n),n=I.next,a=I.next;continue}if(n=I,n===a){y?y===1?(n=p4(Ya(n),e,i),Oh(n,e,i,l,u,f,2)):y===2&&m4(n,e,i,l,u,f):Oh(Ya(n),e,i,l,u,f,1);break}}}}function d4(n){var e=n.prev,i=n,l=n.next;if(on(e,i,l)>=0)return!1;for(var u=e.x,f=i.x,y=l.x,a=e.y,E=i.y,I=l.y,O=u<f?u<y?u:y:f<y?f:y,R=a<E?a<I?a:I:E<I?E:I,N=u>f?u>y?u:y:f>y?f:y,H=a>E?a>I?a:I:E>I?E:I,re=l.next;re!==e;){if(re.x>=O&&re.x<=N&&re.y>=R&&re.y<=H&&dc(u,a,f,E,y,I,re.x,re.y)&&on(re.prev,re,re.next)>=0)return!1;re=re.next}return!0}function f4(n,e,i,l){var u=n.prev,f=n,y=n.next;if(on(u,f,y)>=0)return!1;for(var a=u.x,E=f.x,I=y.x,O=u.y,R=f.y,N=y.y,H=a<E?a<I?a:I:E<I?E:I,re=O<R?O<N?O:N:R<N?R:N,ae=a>E?a>I?a:I:E>I?E:I,be=O>R?O>N?O:N:R>N?R:N,De=L_(H,re,e,i,l),Oe=L_(ae,be,e,i,l),Ce=n.prevZ,Ve=n.nextZ;Ce&&Ce.z>=De&&Ve&&Ve.z<=Oe;){if(Ce.x>=H&&Ce.x<=ae&&Ce.y>=re&&Ce.y<=be&&Ce!==u&&Ce!==y&&dc(a,O,E,R,I,N,Ce.x,Ce.y)&&on(Ce.prev,Ce,Ce.next)>=0||(Ce=Ce.prevZ,Ve.x>=H&&Ve.x<=ae&&Ve.y>=re&&Ve.y<=be&&Ve!==u&&Ve!==y&&dc(a,O,E,R,I,N,Ve.x,Ve.y)&&on(Ve.prev,Ve,Ve.next)>=0))return!1;Ve=Ve.nextZ}for(;Ce&&Ce.z>=De;){if(Ce.x>=H&&Ce.x<=ae&&Ce.y>=re&&Ce.y<=be&&Ce!==u&&Ce!==y&&dc(a,O,E,R,I,N,Ce.x,Ce.y)&&on(Ce.prev,Ce,Ce.next)>=0)return!1;Ce=Ce.prevZ}for(;Ve&&Ve.z<=Oe;){if(Ve.x>=H&&Ve.x<=ae&&Ve.y>=re&&Ve.y<=be&&Ve!==u&&Ve!==y&&dc(a,O,E,R,I,N,Ve.x,Ve.y)&&on(Ve.prev,Ve,Ve.next)>=0)return!1;Ve=Ve.nextZ}return!0}function p4(n,e,i){var l=n;do{var u=l.prev,f=l.next.next;!Zp(u,f)&&NT(u,l,l.next,f)&&Bh(u,f)&&Bh(f,u)&&(e.push(u.i/i|0),e.push(l.i/i|0),e.push(f.i/i|0),Fh(l),Fh(l.next),l=n=f),l=l.next}while(l!==n);return Ya(l)}function m4(n,e,i,l,u,f){var y=n;do{for(var a=y.next.next;a!==y.prev;){if(y.i!==a.i&&E4(y,a)){var E=UT(y,a);y=Ya(y,y.next),E=Ya(E,E.next),Oh(y,e,i,l,u,f,0),Oh(E,e,i,l,u,f,0);return}a=a.next}y=y.next}while(y!==n)}function g4(n,e,i,l){var u=[],f,y,a,E,I;for(f=0,y=e.length;f<y;f++)a=e[f]*l,E=f<y-1?e[f+1]*l:n.length,I=FT(n,a,E,l,!1),I===I.next&&(I.steiner=!0),u.push(T4(I));for(u.sort(_4),f=0;f<u.length;f++)i=y4(u[f],i);return i}function _4(n,e){return n.x-e.x}function y4(n,e){var i=x4(n,e);if(!i)return e;var l=UT(i,n);return Ya(l,l.next),Ya(i,i.next)}function x4(n,e){var i=e,l=n.x,u=n.y,f=-1/0,y;do{if(u<=i.y&&u>=i.next.y&&i.next.y!==i.y){var a=i.x+(u-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=l&&a>f&&(f=a,y=i.x<i.next.x?i:i.next,a===l))return y}i=i.next}while(i!==e);if(!y)return null;var E=y,I=y.x,O=y.y,R=1/0,N;i=y;do l>=i.x&&i.x>=I&&l!==i.x&&dc(u<O?l:f,u,I,O,u<O?f:l,u,i.x,i.y)&&(N=Math.abs(u-i.y)/(l-i.x),Bh(i,n)&&(N<R||N===R&&(i.x>y.x||i.x===y.x&&v4(y,i)))&&(y=i,R=N)),i=i.next;while(i!==E);return y}function v4(n,e){return on(n.prev,n,e.prev)<0&&on(e.next,n,n.next)<0}function b4(n,e,i,l){var u=n;do u.z===0&&(u.z=L_(u.x,u.y,e,i,l)),u.prevZ=u.prev,u.nextZ=u.next,u=u.next;while(u!==n);u.prevZ.nextZ=null,u.prevZ=null,w4(u)}function w4(n){var e,i,l,u,f,y,a,E,I=1;do{for(i=n,n=null,f=null,y=0;i;){for(y++,l=i,a=0,e=0;e<I&&(a++,l=l.nextZ,!!l);e++);for(E=I;a>0||E>0&&l;)a!==0&&(E===0||!l||i.z<=l.z)?(u=i,i=i.nextZ,a--):(u=l,l=l.nextZ,E--),f?f.nextZ=u:n=u,u.prevZ=f,f=u;i=l}f.nextZ=null,I*=2}while(y>1);return n}function L_(n,e,i,l,u){return n=(n-i)*u|0,e=(e-l)*u|0,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n|e<<1}function T4(n){var e=n,i=n;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==n);return i}function dc(n,e,i,l,u,f,y,a){return(u-y)*(e-a)>=(n-y)*(f-a)&&(n-y)*(l-a)>=(i-y)*(e-a)&&(i-y)*(f-a)>=(u-y)*(l-a)}function E4(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!A4(n,e)&&(Bh(n,e)&&Bh(e,n)&&S4(n,e)&&(on(n.prev,n,e.prev)||on(n,e.prev,e))||Zp(n,e)&&on(n.prev,n,n.next)>0&&on(e.prev,e,e.next)>0)}function on(n,e,i){return(e.y-n.y)*(i.x-e.x)-(e.x-n.x)*(i.y-e.y)}function Zp(n,e){return n.x===e.x&&n.y===e.y}function NT(n,e,i,l){var u=Yf(on(n,e,i)),f=Yf(on(n,e,l)),y=Yf(on(i,l,n)),a=Yf(on(i,l,e));return!!(u!==f&&y!==a||u===0&&Xf(n,i,e)||f===0&&Xf(n,l,e)||y===0&&Xf(i,n,l)||a===0&&Xf(i,e,l))}function Xf(n,e,i){return e.x<=Math.max(n.x,i.x)&&e.x>=Math.min(n.x,i.x)&&e.y<=Math.max(n.y,i.y)&&e.y>=Math.min(n.y,i.y)}function Yf(n){return n>0?1:n<0?-1:0}function A4(n,e){var i=n;do{if(i.i!==n.i&&i.next.i!==n.i&&i.i!==e.i&&i.next.i!==e.i&&NT(i,i.next,n,e))return!0;i=i.next}while(i!==n);return!1}function Bh(n,e){return on(n.prev,n,n.next)<0?on(n,e,n.next)>=0&&on(n,n.prev,e)>=0:on(n,e,n.prev)<0||on(n,n.next,e)<0}function S4(n,e){var i=n,l=!1,u=(n.x+e.x)/2,f=(n.y+e.y)/2;do i.y>f!=i.next.y>f&&i.next.y!==i.y&&u<(i.next.x-i.x)*(f-i.y)/(i.next.y-i.y)+i.x&&(l=!l),i=i.next;while(i!==n);return l}function UT(n,e){var i=new k_(n.i,n.x,n.y),l=new k_(e.i,e.x,e.y),u=n.next,f=e.prev;return n.next=e,e.prev=n,i.next=u,u.prev=i,l.next=i,i.prev=l,f.next=l,l.prev=f,l}function mb(n,e,i,l){var u=new k_(n,e,i);return l?(u.next=l.next,u.prev=l,l.next.prev=u,l.next=u):(u.prev=u,u.next=u),u}function Fh(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function k_(n,e,i){this.i=n,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}Wp.deviation=function(n,e,i,l){var u=e&&e.length,f=u?e[0]*i:n.length,y=Math.abs(R_(n,0,f,i));if(u)for(var a=0,E=e.length;a<E;a++){var I=e[a]*i,O=a<E-1?e[a+1]*i:n.length;y-=Math.abs(R_(n,I,O,i))}var R=0;for(a=0;a<l.length;a+=3){var N=l[a]*i,H=l[a+1]*i,re=l[a+2]*i;R+=Math.abs((n[N]-n[re])*(n[H+1]-n[N+1])-(n[N]-n[H])*(n[re+1]-n[N+1]))}return y===0&&R===0?0:Math.abs((R-y)/y)};function R_(n,e,i,l){for(var u=0,f=e,y=i-l;f<i;f+=l)u+=(n[y]-n[f])*(n[f+1]+n[y+1]),y=f;return u}Wp.flatten=function(n){for(var e=n[0][0].length,i={vertices:[],holes:[],dimensions:e},l=0,u=0;u<n.length;u++){for(var f=0;f<n[u].length;f++)for(var y=0;y<e;y++)i.vertices.push(n[u][f][y]);u>0&&(l+=n[u-1].length,i.holes.push(l))}return i};const Kf=CT.CLOCKWISE,gb=CT.COUNTER_CLOCKWISE,aa={isClosed:!0};function M4(n){if(n=n&&n.positions||n,!Array.isArray(n)&&!ArrayBuffer.isView(n))throw new Error("invalid polygon")}function xh(n){return"positions"in n?n.positions:n}function hp(n){return"holeIndices"in n?n.holeIndices:null}function P4(n){return Array.isArray(n[0])}function I4(n){return n.length>=1&&n[0].length>=2&&Number.isFinite(n[0][0])}function C4(n){const e=n[0],i=n[n.length-1];return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]}function L4(n,e,i,l){for(let u=0;u<e;u++)if(n[i+u]!==n[l-e+u])return!1;return!0}function _b(n,e,i,l,u){let f=e;const y=i.length;for(let a=0;a<y;a++)for(let E=0;E<l;E++)n[f++]=i[a][E]||0;if(!C4(i))for(let a=0;a<l;a++)n[f++]=i[0][a]||0;return aa.start=e,aa.end=f,aa.size=l,LT(n,u,aa),f}function yb(n,e,i,l,u=0,f,y){f=f||i.length;const a=f-u;if(a<=0)return e;let E=e;for(let I=0;I<a;I++)n[E++]=i[u+I];if(!L4(i,l,u,f))for(let I=0;I<l;I++)n[E++]=i[u+I];return aa.start=e,aa.end=E,aa.size=l,LT(n,y,aa),E}function VT(n,e){M4(n);const i=[],l=[];if("positions"in n){const{positions:u,holeIndices:f}=n;if(f){let y=0;for(let a=0;a<=f.length;a++)y=yb(i,y,u,e,f[a-1],f[a],a===0?Kf:gb),l.push(y);return l.pop(),{positions:i,holeIndices:l}}n=u}if(!P4(n))return yb(i,0,n,e,0,i.length,Kf),i;if(!I4(n)){let u=0;for(const[f,y]of n.entries())u=_b(i,u,y,e,f===0?Kf:gb),l.push(u);return l.pop(),{positions:i,holeIndices:l}}return _b(i,0,n,e,Kf),i}function k4(n,e,i){let l=hp(n);l&&(l=l.map(f=>f/e));let u=xh(n);if(i){const f=u.length;u=u.slice();const y=[];for(let a=0;a<f;a+=e){y[0]=u[a],y[1]=u[a+1];const E=i(y);u[a]=E[0],u[a+1]=E[1]}}return by.exports(u,l,e)}class R4 extends PT{constructor(e){const{fp64:i,IndexType:l=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:i?Float64Array:Float32Array},vertexValid:{type:Uint8ClampedArray,size:1},indices:{type:l,size:1}}})}get(e){const{attributes:i}=this;return e==="indices"?i.indices&&i.indices.subarray(0,this.vertexCount):i[e]}updateGeometry(e){super.updateGeometry(e);const i=this.buffers.indices;if(i)this.vertexCount=(i.value||i).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const i=VT(e,this.positionSize);return this.opts.resolution?RT(xh(i),hp(i),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?i4(xh(i),hp(i),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):i}return e}getGeometrySize(e){if(xb(e)){let i=0;for(const l of e)i+=this.getGeometrySize(l);return i}return xh(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,i){if(e&&xb(e))for(const l of e){const u=this.getGeometrySize(l);i.geometrySize=u,this.updateGeometryAttributes(l,i),i.vertexStart+=u,i.indexStart=this.indexStarts[i.geometryIndex+1]}else this._updateIndices(e,i),this._updatePositions(e,i),this._updateVertexValid(e,i)}_updateIndices(e,{geometryIndex:i,vertexStart:l,indexStart:u}){const{attributes:f,indexStarts:y,typedArrayManager:a}=this;let E=f.indices;if(!E||!e)return;let I=u;const O=k4(e,this.positionSize,this.opts.preproject);E=a.allocate(E,u+O.length,{copy:!0});for(let R=0;R<O.length;R++)E[I++]=O[R]+l;y[i+1]=u+O.length,f.indices=E}_updatePositions(e,{vertexStart:i,geometrySize:l}){const{attributes:{positions:u},positionSize:f}=this;if(!u||!e)return;const y=xh(e);for(let a=i,E=0;E<l;a++,E++){const I=y[E*f],O=y[E*f+1],R=f>2?y[E*f+2]:0;u[a*3]=I,u[a*3+1]=O,u[a*3+2]=R}}_updateVertexValid(e,{vertexStart:i,geometrySize:l}){const{positionSize:u}=this,f=this.attributes.vertexValid,y=e&&hp(e);if(e&&e.edgeTypes?f.set(e.edgeTypes,i):f.fill(1,i,i+l),y)for(let a=0;a<y.length;a++)f[i+y[a]/u-1]=0;f[i+l-1]=0}}function xb(n){return Array.isArray(n)&&n.length>0&&!Number.isFinite(n[0])}const jT=`
attribute vec2 vertexPositions;
attribute float vertexValid;

uniform bool extruded;
uniform bool isWireframe;
uniform float elevationScale;
uniform float opacity;

varying vec4 vColor;

struct PolygonProps {
  vec4 fillColors;
  vec4 lineColors;
  vec3 positions;
  vec3 nextPositions;
  vec3 pickingColors;
  vec3 positions64Low;
  vec3 nextPositions64Low;
  float elevations;
};

vec3 project_offset_normal(vec3 vector) {
  if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
    // normals generated by the polygon tesselator are in lnglat offsets instead of meters
    return normalize(vector * project_uCommonUnitsPerWorldUnit);
  }
  return project_normal(vector);
}

void calculatePosition(PolygonProps props) {
#ifdef IS_SIDE_VERTEX
  if(vertexValid < 0.5){
    gl_Position = vec4(0.);
    return;
  }
#endif

  vec3 pos;
  vec3 pos64Low;
  vec3 normal;
  vec4 colors = isWireframe ? props.lineColors : props.fillColors;

  geometry.worldPosition = props.positions;
  geometry.worldPositionAlt = props.nextPositions;
  geometry.pickingColor = props.pickingColors;

#ifdef IS_SIDE_VERTEX
  pos = mix(props.positions, props.nextPositions, vertexPositions.x);
  pos64Low = mix(props.positions64Low, props.nextPositions64Low, vertexPositions.x);
#else
  pos = props.positions;
  pos64Low = props.positions64Low;
#endif

  if (extruded) {
    pos.z += props.elevations * vertexPositions.y * elevationScale;
  }
  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  if (extruded) {
  #ifdef IS_SIDE_VERTEX
    normal = vec3(
      props.positions.y - props.nextPositions.y + (props.positions64Low.y - props.nextPositions64Low.y),
      props.nextPositions.x - props.positions.x + (props.nextPositions64Low.x - props.positions64Low.x),
      0.0);
    normal = project_offset_normal(normal);
  #else
    normal = project_normal(vec3(0.0, 0.0, 1.0));
  #endif
    geometry.normal = normal;
    vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, normal);
    vColor = vec4(lightColor, colors.a * opacity);
  } else {
    vColor = vec4(colors.rgb, colors.a * opacity);
  }
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,D4=`#define SHADER_NAME solid-polygon-layer-vertex-shader

attribute vec3 positions;
attribute vec3 positions64Low;
attribute float elevations;
attribute vec4 fillColors;
attribute vec4 lineColors;
attribute vec3 pickingColors;

`.concat(jT,`

void main(void) {
  PolygonProps props;

  props.positions = positions;
  props.positions64Low = positions64Low;
  props.elevations = elevations;
  props.fillColors = fillColors;
  props.lineColors = lineColors;
  props.pickingColors = pickingColors;

  calculatePosition(props);
}
`),z4=`#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX


attribute vec3 instancePositions;
attribute vec3 nextPositions;
attribute vec3 instancePositions64Low;
attribute vec3 nextPositions64Low;
attribute float instanceElevations;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

`.concat(jT,`

void main(void) {
  PolygonProps props;

  #if RING_WINDING_ORDER_CW == 1
    props.positions = instancePositions;
    props.positions64Low = instancePositions64Low;
    props.nextPositions = nextPositions;
    props.nextPositions64Low = nextPositions64Low;
  #else
    props.positions = nextPositions;
    props.positions64Low = nextPositions64Low;
    props.nextPositions = instancePositions;
    props.nextPositions64Low = instancePositions64Low;
  #endif
  props.elevations = instanceElevations;
  props.fillColors = instanceFillColors;
  props.lineColors = instanceLineColors;
  props.pickingColors = instancePickingColors;

  calculatePosition(props);
}
`),O4=`#define SHADER_NAME solid-polygon-layer-fragment-shader

precision highp float;

varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Pp=[0,0,0,255],B4={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:n=>n.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:Pp},getLineColor:{type:"accessor",value:Pp},material:!0},Jf={enter:(n,e)=>e.length?e.subarray(e.length-n.length):n};class wy extends Rc{constructor(...e){super(...e),G(this,"state",void 0)}getShaders(e){return super.getShaders({vs:e==="top"?D4:z4,fs:O4,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[ly,hk,uy]})}get wrapLongitude(){return!1}initializeState(){const{gl:e,viewport:i}=this.context;let{coordinateSystem:l}=this.props;i.isGeospatial&&l===Pi.DEFAULT&&(l=Pi.LNGLAT),this.setState({numInstances:0,polygonTesselator:new R4({preproject:l===Pi.LNGLAT&&i.projectFlat.bind(i),fp64:this.use64bitPositions(),IndexType:!e||ey(e,Yi.ELEMENT_INDEX_UINT32)?Uint32Array:Uint16Array})});const u=this.getAttributeManager(),f=!0;u.remove(["instancePickingColors"]),u.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:f},positions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:Jf,accessor:"getPolygon",update:this.calculatePositions,noAlloc:f,shaderAttributes:{positions:{vertexOffset:0,divisor:0},instancePositions:{vertexOffset:0,divisor:1},nextPositions:{vertexOffset:1,divisor:1}}},vertexValid:{size:1,divisor:1,type:5121,update:this.calculateVertexValid,noAlloc:f},elevations:{size:1,transition:Jf,accessor:"getElevation",shaderAttributes:{elevations:{divisor:0},instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:Jf,accessor:"getFillColor",defaultValue:Pp,shaderAttributes:{fillColors:{divisor:0},instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:Jf,accessor:"getLineColor",defaultValue:Pp,shaderAttributes:{lineColors:{divisor:0},instanceLineColors:{divisor:1}}},pickingColors:{size:3,type:5121,accessor:(y,{index:a,target:E})=>this.encodePickingColor(y&&y.__source?y.__source.index:a,E),shaderAttributes:{pickingColors:{divisor:0},instancePickingColors:{divisor:1}}}})}getPickingInfo(e){const i=super.getPickingInfo(e),{index:l}=i,{data:u}=this.props;return u[0]&&u[0].__source&&(i.object=u.find(f=>f.__source.index===l)),i}disablePickingIndex(e){const{data:i}=this.props;if(i[0]&&i[0].__source)for(let l=0;l<i.length;l++)i[l].__source.index===e&&this._disablePickingIndex(l);else this._disablePickingIndex(e)}draw({uniforms:e}){const{extruded:i,filled:l,wireframe:u,elevationScale:f}=this.props,{topModel:y,sideModel:a,polygonTesselator:E}=this.state,I={...e,extruded:Boolean(i),elevationScale:f};a&&(a.setInstanceCount(E.instanceCount-1),a.setUniforms(I),u&&(a.setDrawMode(3),a.setUniforms({isWireframe:!0}).draw()),l&&(a.setDrawMode(6),a.setUniforms({isWireframe:!1}).draw())),y&&(y.setVertexCount(E.vertexCount),y.setUniforms(I).draw())}updateState(e){super.updateState(e),this.updateGeometry(e);const{props:i,oldProps:l,changeFlags:u}=e,f=this.getAttributeManager();if(u.extensionsChanged||i.filled!==l.filled||i.extruded!==l.extruded){var a;(a=this.state.models)===null||a===void 0||a.forEach(E=>E.delete()),this.setState(this._getModels(this.context.gl)),f.invalidateAll()}}updateGeometry({props:e,oldProps:i,changeFlags:l}){if(l.dataChanged||l.updateTriggersChanged&&(l.updateTriggersChanged.all||l.updateTriggersChanged.getPolygon)){const{polygonTesselator:f}=this.state,y=e.data.attributes||{};f.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:y.getPolygon,buffers:y,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:l.dataChanged}),this.setState({numInstances:f.instanceCount,startIndices:f.vertexStarts}),l.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(e){const{id:i,filled:l,extruded:u}=this.props;let f,y;if(l){const a=this.getShaders("top");a.defines.NON_INSTANCED_MODEL=1,f=new Ih(e,{...a,id:"".concat(i,"-top"),drawMode:4,attributes:{vertexPositions:new Float32Array([0,1])},uniforms:{isWireframe:!1,isSideVertex:!1},vertexCount:0,isIndexed:!0})}return u&&(y=new Ih(e,{...this.getShaders("side"),id:"".concat(i,"-side"),geometry:new oy({drawMode:1,vertexCount:4,attributes:{vertexPositions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),instanceCount:0,isInstanced:1}),y.userData.excludeAttributes={indices:!0}),{models:[y,f].filter(Boolean),topModel:f,sideModel:y}}calculateIndices(e){const{polygonTesselator:i}=this.state;e.startIndices=i.indexStarts,e.value=i.get("indices")}calculatePositions(e){const{polygonTesselator:i}=this.state;e.startIndices=i.vertexStarts,e.value=i.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}G(wy,"defaultProps",B4);G(wy,"layerName","SolidPolygonLayer");function F4({data:n,getIndex:e,dataRange:i,replace:l}){const{startRow:u=0,endRow:f=1/0}=i,y=n.length;let a=y,E=y;for(let N=0;N<y;N++){const H=e(n[N]);if(a>N&&H>=u&&(a=N),H>=f){E=N;break}}let I=a;const R=E-a!==l.length?n.slice(E):void 0;for(let N=0;N<l.length;N++)n[I++]=l[N];if(R){for(let N=0;N<R.length;N++)n[I++]=R[N];n.length=I}return{startRow:a,endRow:a+l.length}}const GT=[0,0,0,255],N4=[0,0,0,255],U4={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:n=>n.polygon},getFillColor:{type:"accessor",value:N4},getLineColor:{type:"accessor",value:GT},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class Ty extends MT{initializeState(){this.state={paths:[]},this.props.getLineDashArray&&Bi.removed("getLineDashArray","PathStyleExtension")()}updateState({changeFlags:e}){const i=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getPolygon);if(i&&Array.isArray(e.dataChanged)){const l=this.state.paths.slice(),u=e.dataChanged.map(f=>F4({data:l,getIndex:y=>y.__source.index,dataRange:f,replace:this._getPaths(f)}));this.setState({paths:l,pathsDiff:u})}else i&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(e={}){const{data:i,getPolygon:l,positionFormat:u,_normalize:f}=this.props,y=[],a=u==="XY"?2:3,{startRow:E,endRow:I}=e,{iterable:O,objectInfo:R}=py(i,E,I);for(const N of O){R.index++;let H=l(N,R);f&&(H=VT(H,a));const{holeIndices:re}=H,ae=H.positions||H;if(re)for(let be=0;be<=re.length;be++){const De=ae.slice(re[be-1]||0,re[be]||ae.length);y.push(this.getSubLayerRow({path:De},N,R.index))}else y.push(this.getSubLayerRow({path:ae},N,R.index))}return y}renderLayers(){const{data:e,_dataDiff:i,stroked:l,filled:u,extruded:f,wireframe:y,_normalize:a,_windingOrder:E,elevationScale:I,transitions:O,positionFormat:R}=this.props,{lineWidthUnits:N,lineWidthScale:H,lineWidthMinPixels:re,lineWidthMaxPixels:ae,lineJointRounded:be,lineMiterLimit:De,lineDashJustified:Oe}=this.props,{getFillColor:Ce,getLineColor:Ve,getLineWidth:Ee,getLineDashArray:dt,getElevation:wt,getPolygon:kt,updateTriggers:et,material:Tt}=this.props,{paths:ut,pathsDiff:si}=this.state,ti=this.getSubLayerClass("fill",wy),Zt=this.getSubLayerClass("stroke",Gp),Lt=this.shouldRenderSubLayer("fill",ut)&&new ti({_dataDiff:i,extruded:f,elevationScale:I,filled:u,wireframe:y,_normalize:a,_windingOrder:E,getElevation:wt,getFillColor:Ce,getLineColor:f&&y?Ve:GT,material:Tt,transitions:O},this.getSubLayerProps({id:"fill",updateTriggers:et&&{getPolygon:et.getPolygon,getElevation:et.getElevation,getFillColor:et.getFillColor,lineColors:f&&y,getLineColor:et.getLineColor}}),{data:e,positionFormat:R,getPolygon:kt}),An=!f&&l&&this.shouldRenderSubLayer("stroke",ut)&&new Zt({_dataDiff:si&&(()=>si),widthUnits:N,widthScale:H,widthMinPixels:re,widthMaxPixels:ae,jointRounded:be,miterLimit:De,dashJustified:Oe,_pathType:"loop",transitions:O&&{getWidth:O.getLineWidth,getColor:O.getLineColor,getPath:O.getPolygon},getColor:this.getSubLayerAccessor(Ve),getWidth:this.getSubLayerAccessor(Ee),getDashArray:this.getSubLayerAccessor(dt)},this.getSubLayerProps({id:"stroke",updateTriggers:et&&{getWidth:et.getLineWidth,getColor:et.getLineColor,getDashArray:et.getLineDashArray}}),{data:ut,positionFormat:R,getPath:fn=>fn.path});return[!f&&Lt,An,f&&Lt]}}G(Ty,"layerName","PolygonLayer");G(Ty,"defaultProps",U4);function dp(n,e){return n==null||e==null?NaN:n<e?-1:n>e?1:n>=e?0:NaN}function V4(n,e){return n==null||e==null?NaN:e<n?-1:e>n?1:e>=n?0:NaN}function WT(n){let e,i,l;n.length!==2?(e=dp,i=(a,E)=>dp(n(a),E),l=(a,E)=>n(a)-E):(e=n===dp||n===V4?n:j4,i=n,l=n);function u(a,E,I=0,O=a.length){if(I<O){if(e(E,E)!==0)return O;do{const R=I+O>>>1;i(a[R],E)<0?I=R+1:O=R}while(I<O)}return I}function f(a,E,I=0,O=a.length){if(I<O){if(e(E,E)!==0)return O;do{const R=I+O>>>1;i(a[R],E)<=0?I=R+1:O=R}while(I<O)}return I}function y(a,E,I=0,O=a.length){const R=u(a,E,I,O-1);return R>I&&l(a[R-1],E)>-l(a[R],E)?R-1:R}return{left:u,center:y,right:f}}function j4(){return 0}function G4(n){return n===null?NaN:+n}const W4=WT(dp),Z4=W4.right;WT(G4).center;const $4=Z4;function Ga(n,e){let i,l;if(e===void 0)for(const u of n)u!=null&&(i===void 0?u>=u&&(i=l=u):(i>u&&(i=u),l<u&&(l=u)));else{let u=-1;for(let f of n)(f=e(f,++u,n))!=null&&(i===void 0?f>=f&&(i=l=f):(i>f&&(i=f),l<f&&(l=f)))}return[i,l]}class vb extends Map{constructor(e,i=X4){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:i}}),e!=null)for(const[l,u]of e)this.set(l,u)}get(e){return super.get(bb(this,e))}has(e){return super.has(bb(this,e))}set(e,i){return super.set(q4(this,e),i)}delete(e){return super.delete(H4(this,e))}}function bb({_intern:n,_key:e},i){const l=e(i);return n.has(l)?n.get(l):i}function q4({_intern:n,_key:e},i){const l=e(i);return n.has(l)?n.get(l):(n.set(l,i),i)}function H4({_intern:n,_key:e},i){const l=e(i);return n.has(l)&&(i=n.get(l),n.delete(l)),i}function X4(n){return n!==null&&typeof n=="object"?n.valueOf():n}var D_=Math.sqrt(50),z_=Math.sqrt(10),O_=Math.sqrt(2);function Y4(n,e,i){var l,u=-1,f,y,a;if(e=+e,n=+n,i=+i,n===e&&i>0)return[n];if((l=e<n)&&(f=n,n=e,e=f),(a=ZT(n,e,i))===0||!isFinite(a))return[];if(a>0){let E=Math.round(n/a),I=Math.round(e/a);for(E*a<n&&++E,I*a>e&&--I,y=new Array(f=I-E+1);++u<f;)y[u]=(E+u)*a}else{a=-a;let E=Math.round(n*a),I=Math.round(e*a);for(E/a<n&&++E,I/a>e&&--I,y=new Array(f=I-E+1);++u<f;)y[u]=(E+u)/a}return l&&y.reverse(),y}function ZT(n,e,i){var l=(e-n)/Math.max(0,i),u=Math.floor(Math.log(l)/Math.LN10),f=l/Math.pow(10,u);return u>=0?(f>=D_?10:f>=z_?5:f>=O_?2:1)*Math.pow(10,u):-Math.pow(10,-u)/(f>=D_?10:f>=z_?5:f>=O_?2:1)}function K4(n,e,i){var l=Math.abs(e-n)/Math.max(0,i),u=Math.pow(10,Math.floor(Math.log(l)/Math.LN10)),f=l/u;return f>=D_?u*=10:f>=z_?u*=5:f>=O_&&(u*=2),e<n?-u:u}function Wg(n,e){let i;if(e===void 0)for(const l of n)l!=null&&(i<l||i===void 0&&l>=l)&&(i=l);else{let l=-1;for(let u of n)(u=e(u,++l,n))!=null&&(i<u||i===void 0&&u>=u)&&(i=u)}return i}function wb(n,e){let i;if(e===void 0)for(const l of n)l!=null&&(i>l||i===void 0&&l>=l)&&(i=l);else{let l=-1;for(let u of n)(u=e(u,++l,n))!=null&&(i>u||i===void 0&&u>=u)&&(i=u)}return i}function Ey(n,e,i){n.prototype=e.prototype=i,i.constructor=n}function $T(n,e){var i=Object.create(n.prototype);for(var l in e)i[l]=e[l];return i}function Kh(){}var Nh=.7,Ip=1/Nh,gc="\\s*([+-]?\\d+)\\s*",Uh="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",lo="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",J4=/^#([0-9a-f]{3,8})$/,Q4=new RegExp(`^rgb\\(${gc},${gc},${gc}\\)$`),eB=new RegExp(`^rgb\\(${lo},${lo},${lo}\\)$`),tB=new RegExp(`^rgba\\(${gc},${gc},${gc},${Uh}\\)$`),iB=new RegExp(`^rgba\\(${lo},${lo},${lo},${Uh}\\)$`),nB=new RegExp(`^hsl\\(${Uh},${lo},${lo}\\)$`),rB=new RegExp(`^hsla\\(${Uh},${lo},${lo},${Uh}\\)$`),Tb={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Ey(Kh,Mc,{copy(n){return Object.assign(new this.constructor,this,n)},displayable(){return this.rgb().displayable()},hex:Eb,formatHex:Eb,formatHex8:sB,formatHsl:oB,formatRgb:Ab,toString:Ab});function Eb(){return this.rgb().formatHex()}function sB(){return this.rgb().formatHex8()}function oB(){return qT(this).formatHsl()}function Ab(){return this.rgb().formatRgb()}function Mc(n){var e,i;return n=(n+"").trim().toLowerCase(),(e=J4.exec(n))?(i=e[1].length,e=parseInt(e[1],16),i===6?Sb(e):i===3?new Pr(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):i===8?Qf(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):i===4?Qf(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=Q4.exec(n))?new Pr(e[1],e[2],e[3],1):(e=eB.exec(n))?new Pr(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=tB.exec(n))?Qf(e[1],e[2],e[3],e[4]):(e=iB.exec(n))?Qf(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=nB.exec(n))?Ib(e[1],e[2]/100,e[3]/100,1):(e=rB.exec(n))?Ib(e[1],e[2]/100,e[3]/100,e[4]):Tb.hasOwnProperty(n)?Sb(Tb[n]):n==="transparent"?new Pr(NaN,NaN,NaN,0):null}function Sb(n){return new Pr(n>>16&255,n>>8&255,n&255,1)}function Qf(n,e,i,l){return l<=0&&(n=e=i=NaN),new Pr(n,e,i,l)}function aB(n){return n instanceof Kh||(n=Mc(n)),n?(n=n.rgb(),new Pr(n.r,n.g,n.b,n.opacity)):new Pr}function Cp(n,e,i,l){return arguments.length===1?aB(n):new Pr(n,e,i,l??1)}function Pr(n,e,i,l){this.r=+n,this.g=+e,this.b=+i,this.opacity=+l}Ey(Pr,Cp,$T(Kh,{brighter(n){return n=n==null?Ip:Math.pow(Ip,n),new Pr(this.r*n,this.g*n,this.b*n,this.opacity)},darker(n){return n=n==null?Nh:Math.pow(Nh,n),new Pr(this.r*n,this.g*n,this.b*n,this.opacity)},rgb(){return this},clamp(){return new Pr(Ha(this.r),Ha(this.g),Ha(this.b),Lp(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Mb,formatHex:Mb,formatHex8:lB,formatRgb:Pb,toString:Pb}));function Mb(){return`#${$a(this.r)}${$a(this.g)}${$a(this.b)}`}function lB(){return`#${$a(this.r)}${$a(this.g)}${$a(this.b)}${$a((isNaN(this.opacity)?1:this.opacity)*255)}`}function Pb(){const n=Lp(this.opacity);return`${n===1?"rgb(":"rgba("}${Ha(this.r)}, ${Ha(this.g)}, ${Ha(this.b)}${n===1?")":`, ${n})`}`}function Lp(n){return isNaN(n)?1:Math.max(0,Math.min(1,n))}function Ha(n){return Math.max(0,Math.min(255,Math.round(n)||0))}function $a(n){return n=Ha(n),(n<16?"0":"")+n.toString(16)}function Ib(n,e,i,l){return l<=0?n=e=i=NaN:i<=0||i>=1?n=e=NaN:e<=0&&(n=NaN),new Ds(n,e,i,l)}function qT(n){if(n instanceof Ds)return new Ds(n.h,n.s,n.l,n.opacity);if(n instanceof Kh||(n=Mc(n)),!n)return new Ds;if(n instanceof Ds)return n;n=n.rgb();var e=n.r/255,i=n.g/255,l=n.b/255,u=Math.min(e,i,l),f=Math.max(e,i,l),y=NaN,a=f-u,E=(f+u)/2;return a?(e===f?y=(i-l)/a+(i<l)*6:i===f?y=(l-e)/a+2:y=(e-i)/a+4,a/=E<.5?f+u:2-f-u,y*=60):a=E>0&&E<1?0:y,new Ds(y,a,E,n.opacity)}function cB(n,e,i,l){return arguments.length===1?qT(n):new Ds(n,e,i,l??1)}function Ds(n,e,i,l){this.h=+n,this.s=+e,this.l=+i,this.opacity=+l}Ey(Ds,cB,$T(Kh,{brighter(n){return n=n==null?Ip:Math.pow(Ip,n),new Ds(this.h,this.s,this.l*n,this.opacity)},darker(n){return n=n==null?Nh:Math.pow(Nh,n),new Ds(this.h,this.s,this.l*n,this.opacity)},rgb(){var n=this.h%360+(this.h<0)*360,e=isNaN(n)||isNaN(this.s)?0:this.s,i=this.l,l=i+(i<.5?i:1-i)*e,u=2*i-l;return new Pr(Zg(n>=240?n-240:n+120,u,l),Zg(n,u,l),Zg(n<120?n+240:n-120,u,l),this.opacity)},clamp(){return new Ds(Cb(this.h),ep(this.s),ep(this.l),Lp(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const n=Lp(this.opacity);return`${n===1?"hsl(":"hsla("}${Cb(this.h)}, ${ep(this.s)*100}%, ${ep(this.l)*100}%${n===1?")":`, ${n})`}`}}));function Cb(n){return n=(n||0)%360,n<0?n+360:n}function ep(n){return Math.max(0,Math.min(1,n||0))}function Zg(n,e,i){return(n<60?e+(i-e)*n/60:n<180?i:n<240?e+(i-e)*(240-n)/60:e)*255}function HT(n,e){switch(arguments.length){case 0:break;case 1:this.range(n);break;default:this.range(e).domain(n);break}return this}function XT(n,e){switch(arguments.length){case 0:break;case 1:{typeof n=="function"?this.interpolator(n):this.range(n);break}default:{this.domain(n),typeof e=="function"?this.interpolator(e):this.range(e);break}}return this}const Lb=Symbol("implicit");function vh(){var n=new vb,e=[],i=[],l=Lb;function u(f){let y=n.get(f);if(y===void 0){if(l!==Lb)return l;n.set(f,y=e.push(f)-1)}return i[y%i.length]}return u.domain=function(f){if(!arguments.length)return e.slice();e=[],n=new vb;for(const y of f)n.has(y)||n.set(y,e.push(y)-1);return u},u.range=function(f){return arguments.length?(i=Array.from(f),u):i.slice()},u.unknown=function(f){return arguments.length?(l=f,u):l},u.copy=function(){return vh(e,i).unknown(l)},HT.apply(u,arguments),u}function uB(n,e,i,l,u){var f=n*n,y=f*n;return((1-3*n+3*f-y)*e+(4-6*f+3*y)*i+(1+3*n+3*f-3*y)*l+y*u)/6}function hB(n){var e=n.length-1;return function(i){var l=i<=0?i=0:i>=1?(i=1,e-1):Math.floor(i*e),u=n[l],f=n[l+1],y=l>0?n[l-1]:2*u-f,a=l<e-1?n[l+2]:2*f-u;return uB((i-l/e)*e,y,u,f,a)}}const Ay=n=>()=>n;function dB(n,e){return function(i){return n+i*e}}function fB(n,e,i){return n=Math.pow(n,i),e=Math.pow(e,i)-n,i=1/i,function(l){return Math.pow(n+l*e,i)}}function pB(n){return(n=+n)==1?YT:function(e,i){return i-e?fB(e,i,n):Ay(isNaN(e)?i:e)}}function YT(n,e){var i=e-n;return i?dB(n,i):Ay(isNaN(n)?e:n)}const kb=function n(e){var i=pB(e);function l(u,f){var y=i((u=Cp(u)).r,(f=Cp(f)).r),a=i(u.g,f.g),E=i(u.b,f.b),I=YT(u.opacity,f.opacity);return function(O){return u.r=y(O),u.g=a(O),u.b=E(O),u.opacity=I(O),u+""}}return l.gamma=n,l}(1);function mB(n){return function(e){var i=e.length,l=new Array(i),u=new Array(i),f=new Array(i),y,a;for(y=0;y<i;++y)a=Cp(e[y]),l[y]=a.r||0,u[y]=a.g||0,f[y]=a.b||0;return l=n(l),u=n(u),f=n(f),a.opacity=1,function(E){return a.r=l(E),a.g=u(E),a.b=f(E),a+""}}}var gB=mB(hB);function _B(n,e){e||(e=[]);var i=n?Math.min(e.length,n.length):0,l=e.slice(),u;return function(f){for(u=0;u<i;++u)l[u]=n[u]*(1-f)+e[u]*f;return l}}function yB(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function xB(n,e){var i=e?e.length:0,l=n?Math.min(i,n.length):0,u=new Array(l),f=new Array(i),y;for(y=0;y<l;++y)u[y]=Dc(n[y],e[y]);for(;y<i;++y)f[y]=e[y];return function(a){for(y=0;y<l;++y)f[y]=u[y](a);return f}}function vB(n,e){var i=new Date;return n=+n,e=+e,function(l){return i.setTime(n*(1-l)+e*l),i}}function kp(n,e){return n=+n,e=+e,function(i){return n*(1-i)+e*i}}function bB(n,e){var i={},l={},u;(n===null||typeof n!="object")&&(n={}),(e===null||typeof e!="object")&&(e={});for(u in e)u in n?i[u]=Dc(n[u],e[u]):l[u]=e[u];return function(f){for(u in i)l[u]=i[u](f);return l}}var B_=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,$g=new RegExp(B_.source,"g");function wB(n){return function(){return n}}function TB(n){return function(e){return n(e)+""}}function EB(n,e){var i=B_.lastIndex=$g.lastIndex=0,l,u,f,y=-1,a=[],E=[];for(n=n+"",e=e+"";(l=B_.exec(n))&&(u=$g.exec(e));)(f=u.index)>i&&(f=e.slice(i,f),a[y]?a[y]+=f:a[++y]=f),(l=l[0])===(u=u[0])?a[y]?a[y]+=u:a[++y]=u:(a[++y]=null,E.push({i:y,x:kp(l,u)})),i=$g.lastIndex;return i<e.length&&(f=e.slice(i),a[y]?a[y]+=f:a[++y]=f),a.length<2?E[0]?TB(E[0].x):wB(e):(e=E.length,function(I){for(var O=0,R;O<e;++O)a[(R=E[O]).i]=R.x(I);return a.join("")})}function Dc(n,e){var i=typeof e,l;return e==null||i==="boolean"?Ay(e):(i==="number"?kp:i==="string"?(l=Mc(e))?(e=l,kb):EB:e instanceof Mc?kb:e instanceof Date?vB:yB(e)?_B:Array.isArray(e)?xB:typeof e.valueOf!="function"&&typeof e.toString!="function"||isNaN(e)?bB:kp)(n,e)}function Sy(n,e){return n=+n,e=+e,function(i){return Math.round(n*(1-i)+e*i)}}function AB(n,e){e===void 0&&(e=n,n=Dc);for(var i=0,l=e.length-1,u=e[0],f=new Array(l<0?0:l);i<l;)f[i]=n(u,u=e[++i]);return function(y){var a=Math.max(0,Math.min(l-1,Math.floor(y*=l)));return f[a](y-a)}}function SB(n){return function(){return n}}function F_(n){return+n}var Rb=[0,1];function ao(n){return n}function N_(n,e){return(e-=n=+n)?function(i){return(i-n)/e}:SB(isNaN(e)?NaN:.5)}function MB(n,e){var i;return n>e&&(i=n,n=e,e=i),function(l){return Math.max(n,Math.min(e,l))}}function PB(n,e,i){var l=n[0],u=n[1],f=e[0],y=e[1];return u<l?(l=N_(u,l),f=i(y,f)):(l=N_(l,u),f=i(f,y)),function(a){return f(l(a))}}function IB(n,e,i){var l=Math.min(n.length,e.length)-1,u=new Array(l),f=new Array(l),y=-1;for(n[l]<n[0]&&(n=n.slice().reverse(),e=e.slice().reverse());++y<l;)u[y]=N_(n[y],n[y+1]),f[y]=i(e[y],e[y+1]);return function(a){var E=$4(n,a,1,l)-1;return f[E](u[E](a))}}function CB(n,e){return e.domain(n.domain()).range(n.range()).interpolate(n.interpolate()).clamp(n.clamp()).unknown(n.unknown())}function LB(){var n=Rb,e=Rb,i=Dc,l,u,f,y=ao,a,E,I;function O(){var N=Math.min(n.length,e.length);return y!==ao&&(y=MB(n[0],n[N-1])),a=N>2?IB:PB,E=I=null,R}function R(N){return N==null||isNaN(N=+N)?f:(E||(E=a(n.map(l),e,i)))(l(y(N)))}return R.invert=function(N){return y(u((I||(I=a(e,n.map(l),kp)))(N)))},R.domain=function(N){return arguments.length?(n=Array.from(N,F_),O()):n.slice()},R.range=function(N){return arguments.length?(e=Array.from(N),O()):e.slice()},R.rangeRound=function(N){return e=Array.from(N),i=Sy,O()},R.clamp=function(N){return arguments.length?(y=N?!0:ao,O()):y!==ao},R.interpolate=function(N){return arguments.length?(i=N,O()):i},R.unknown=function(N){return arguments.length?(f=N,R):f},function(N,H){return l=N,u=H,O()}}function kB(){return LB()(ao,ao)}function RB(n){return Math.abs(n=Math.round(n))>=1e21?n.toLocaleString("en").replace(/,/g,""):n.toString(10)}function Rp(n,e){if((i=(n=e?n.toExponential(e-1):n.toExponential()).indexOf("e"))<0)return null;var i,l=n.slice(0,i);return[l.length>1?l[0]+l.slice(2):l,+n.slice(i+1)]}function Pc(n){return n=Rp(Math.abs(n)),n?n[1]:NaN}function DB(n,e){return function(i,l){for(var u=i.length,f=[],y=0,a=n[0],E=0;u>0&&a>0&&(E+a+1>l&&(a=Math.max(1,l-E)),f.push(i.substring(u-=a,u+a)),!((E+=a+1)>l));)a=n[y=(y+1)%n.length];return f.reverse().join(e)}}function zB(n){return function(e){return e.replace(/[0-9]/g,function(i){return n[+i]})}}var OB=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Dp(n){if(!(e=OB.exec(n)))throw new Error("invalid format: "+n);var e;return new My({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}Dp.prototype=My.prototype;function My(n){this.fill=n.fill===void 0?" ":n.fill+"",this.align=n.align===void 0?">":n.align+"",this.sign=n.sign===void 0?"-":n.sign+"",this.symbol=n.symbol===void 0?"":n.symbol+"",this.zero=!!n.zero,this.width=n.width===void 0?void 0:+n.width,this.comma=!!n.comma,this.precision=n.precision===void 0?void 0:+n.precision,this.trim=!!n.trim,this.type=n.type===void 0?"":n.type+""}My.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function BB(n){e:for(var e=n.length,i=1,l=-1,u;i<e;++i)switch(n[i]){case".":l=u=i;break;case"0":l===0&&(l=i),u=i;break;default:if(!+n[i])break e;l>0&&(l=0);break}return l>0?n.slice(0,l)+n.slice(u+1):n}var KT;function FB(n,e){var i=Rp(n,e);if(!i)return n+"";var l=i[0],u=i[1],f=u-(KT=Math.max(-8,Math.min(8,Math.floor(u/3)))*3)+1,y=l.length;return f===y?l:f>y?l+new Array(f-y+1).join("0"):f>0?l.slice(0,f)+"."+l.slice(f):"0."+new Array(1-f).join("0")+Rp(n,Math.max(0,e+f-1))[0]}function Db(n,e){var i=Rp(n,e);if(!i)return n+"";var l=i[0],u=i[1];return u<0?"0."+new Array(-u).join("0")+l:l.length>u+1?l.slice(0,u+1)+"."+l.slice(u+1):l+new Array(u-l.length+2).join("0")}const zb={"%":(n,e)=>(n*100).toFixed(e),b:n=>Math.round(n).toString(2),c:n=>n+"",d:RB,e:(n,e)=>n.toExponential(e),f:(n,e)=>n.toFixed(e),g:(n,e)=>n.toPrecision(e),o:n=>Math.round(n).toString(8),p:(n,e)=>Db(n*100,e),r:Db,s:FB,X:n=>Math.round(n).toString(16).toUpperCase(),x:n=>Math.round(n).toString(16)};function Ob(n){return n}var Bb=Array.prototype.map,Fb=["y","z","a","f","p","n","\xB5","m","","k","M","G","T","P","E","Z","Y"];function NB(n){var e=n.grouping===void 0||n.thousands===void 0?Ob:DB(Bb.call(n.grouping,Number),n.thousands+""),i=n.currency===void 0?"":n.currency[0]+"",l=n.currency===void 0?"":n.currency[1]+"",u=n.decimal===void 0?".":n.decimal+"",f=n.numerals===void 0?Ob:zB(Bb.call(n.numerals,String)),y=n.percent===void 0?"%":n.percent+"",a=n.minus===void 0?"\u2212":n.minus+"",E=n.nan===void 0?"NaN":n.nan+"";function I(R){R=Dp(R);var N=R.fill,H=R.align,re=R.sign,ae=R.symbol,be=R.zero,De=R.width,Oe=R.comma,Ce=R.precision,Ve=R.trim,Ee=R.type;Ee==="n"?(Oe=!0,Ee="g"):zb[Ee]||(Ce===void 0&&(Ce=12),Ve=!0,Ee="g"),(be||N==="0"&&H==="=")&&(be=!0,N="0",H="=");var dt=ae==="$"?i:ae==="#"&&/[boxX]/.test(Ee)?"0"+Ee.toLowerCase():"",wt=ae==="$"?l:/[%p]/.test(Ee)?y:"",kt=zb[Ee],et=/[defgprs%]/.test(Ee);Ce=Ce===void 0?6:/[gprs]/.test(Ee)?Math.max(1,Math.min(21,Ce)):Math.max(0,Math.min(20,Ce));function Tt(ut){var si=dt,ti=wt,Zt,Lt,An;if(Ee==="c")ti=kt(ut)+ti,ut="";else{ut=+ut;var fn=ut<0||1/ut<0;if(ut=isNaN(ut)?E:kt(Math.abs(ut),Ce),Ve&&(ut=BB(ut)),fn&&+ut==0&&re!=="+"&&(fn=!1),si=(fn?re==="("?re:a:re==="-"||re==="("?"":re)+si,ti=(Ee==="s"?Fb[8+KT/3]:"")+ti+(fn&&re==="("?")":""),et){for(Zt=-1,Lt=ut.length;++Zt<Lt;)if(An=ut.charCodeAt(Zt),48>An||An>57){ti=(An===46?u+ut.slice(Zt+1):ut.slice(Zt))+ti,ut=ut.slice(0,Zt);break}}}Oe&&!be&&(ut=e(ut,1/0));var pn=si.length+ut.length+ti.length,Gi=pn<De?new Array(De-pn+1).join(N):"";switch(Oe&&be&&(ut=e(Gi+ut,Gi.length?De-ti.length:1/0),Gi=""),H){case"<":ut=si+ut+ti+Gi;break;case"=":ut=si+Gi+ut+ti;break;case"^":ut=Gi.slice(0,pn=Gi.length>>1)+si+ut+ti+Gi.slice(pn);break;default:ut=Gi+si+ut+ti;break}return f(ut)}return Tt.toString=function(){return R+""},Tt}function O(R,N){var H=I((R=Dp(R),R.type="f",R)),re=Math.max(-8,Math.min(8,Math.floor(Pc(N)/3)))*3,ae=Math.pow(10,-re),be=Fb[8+re/3];return function(De){return H(ae*De)+be}}return{format:I,formatPrefix:O}}var tp,JT,QT;UB({thousands:",",grouping:[3],currency:["$",""]});function UB(n){return tp=NB(n),JT=tp.format,QT=tp.formatPrefix,tp}function VB(n){return Math.max(0,-Pc(Math.abs(n)))}function jB(n,e){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(Pc(e)/3)))*3-Pc(Math.abs(n)))}function GB(n,e){return n=Math.abs(n),e=Math.abs(e)-n,Math.max(0,Pc(e)-Pc(n))+1}function WB(n,e,i,l){var u=K4(n,e,i),f;switch(l=Dp(l??",f"),l.type){case"s":{var y=Math.max(Math.abs(n),Math.abs(e));return l.precision==null&&!isNaN(f=jB(u,y))&&(l.precision=f),QT(l,y)}case"":case"e":case"g":case"p":case"r":{l.precision==null&&!isNaN(f=GB(u,Math.max(Math.abs(n),Math.abs(e))))&&(l.precision=f-(l.type==="e"));break}case"f":case"%":{l.precision==null&&!isNaN(f=VB(u))&&(l.precision=f-(l.type==="%")*2);break}}return JT(l)}function $p(n){var e=n.domain;return n.ticks=function(i){var l=e();return Y4(l[0],l[l.length-1],i??10)},n.tickFormat=function(i,l){var u=e();return WB(u[0],u[u.length-1],i??10,l)},n.nice=function(i){i==null&&(i=10);var l=e(),u=0,f=l.length-1,y=l[u],a=l[f],E,I,O=10;for(a<y&&(I=y,y=a,a=I,I=u,u=f,f=I);O-- >0;){if(I=ZT(y,a,i),I===E)return l[u]=y,l[f]=a,e(l);if(I>0)y=Math.floor(y/I)*I,a=Math.ceil(a/I)*I;else if(I<0)y=Math.ceil(y*I)/I,a=Math.floor(a*I)/I;else break;E=I}return n},n}function xr(){var n=kB();return n.copy=function(){return CB(n,xr())},HT.apply(n,arguments),$p(n)}function bh(n){var e;function i(l){return l==null||isNaN(l=+l)?e:l}return i.invert=i,i.domain=i.range=function(l){return arguments.length?(n=Array.from(l,F_),i):n.slice()},i.unknown=function(l){return arguments.length?(e=l,i):e},i.copy=function(){return bh(n).unknown(e)},n=arguments.length?Array.from(n,F_):[0,1],$p(i)}function ZB(){var n=0,e=1,i,l,u,f,y=ao,a=!1,E;function I(R){return R==null||isNaN(R=+R)?E:y(u===0?.5:(R=(f(R)-i)*u,a?Math.max(0,Math.min(1,R)):R))}I.domain=function(R){return arguments.length?([n,e]=R,i=f(n=+n),l=f(e=+e),u=i===l?0:1/(l-i),I):[n,e]},I.clamp=function(R){return arguments.length?(a=!!R,I):a},I.interpolator=function(R){return arguments.length?(y=R,I):y};function O(R){return function(N){var H,re;return arguments.length?([H,re]=N,y=R(H,re),I):[y(0),y(1)]}}return I.range=O(Dc),I.rangeRound=O(Sy),I.unknown=function(R){return arguments.length?(E=R,I):E},function(R){return f=R,i=R(n),l=R(e),u=i===l?0:1/(l-i),I}}function e2(n,e){return e.domain(n.domain()).interpolator(n.interpolator()).clamp(n.clamp()).unknown(n.unknown())}function bn(){var n=$p(ZB()(ao));return n.copy=function(){return e2(n,bn())},XT.apply(n,arguments)}function $B(){var n=0,e=.5,i=1,l=1,u,f,y,a,E,I=ao,O,R=!1,N;function H(ae){return isNaN(ae=+ae)?N:(ae=.5+((ae=+O(ae))-f)*(l*ae<l*f?a:E),I(R?Math.max(0,Math.min(1,ae)):ae))}H.domain=function(ae){return arguments.length?([n,e,i]=ae,u=O(n=+n),f=O(e=+e),y=O(i=+i),a=u===f?0:.5/(f-u),E=f===y?0:.5/(y-f),l=f<u?-1:1,H):[n,e,i]},H.clamp=function(ae){return arguments.length?(R=!!ae,H):R},H.interpolator=function(ae){return arguments.length?(I=ae,H):I};function re(ae){return function(be){var De,Oe,Ce;return arguments.length?([De,Oe,Ce]=be,I=AB(ae,[De,Oe,Ce]),H):[I(0),I(.5),I(1)]}}return H.range=re(Dc),H.rangeRound=re(Sy),H.unknown=function(ae){return arguments.length?(N=ae,H):N},function(ae){return O=ae,u=ae(n),f=ae(e),y=ae(i),a=u===f?0:.5/(f-u),E=f===y?0:.5/(y-f),l=f<u?-1:1,H}}function U_(){var n=$p($B()(ao));return n.copy=function(){return e2(n,U_())},XT.apply(n,arguments)}const lc="https://basemaps.cartocdn.com/gl/{basemap}-gl-style/style.json",qB={VOYAGER:lc.replace("{basemap}","voyager"),POSITRON:lc.replace("{basemap}","positron"),DARK_MATTER:lc.replace("{basemap}","dark-matter"),VOYAGER_NOLABELS:lc.replace("{basemap}","voyager-nolabels"),POSITRON_NOLABELS:lc.replace("{basemap}","positron-nolabels"),DARK_MATTER_NOLABELS:lc.replace("{basemap}","dark-matter-nolabels")};var t2={exports:{}};(function(n,e){(function(i,l){n.exports=l()})(UD,function(){var i,l,u;function f(a,E){if(!i)i=E;else if(!l)l=E;else{var I="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+i+")(sharedChunk); ("+l+")(sharedChunk); self.onerror = null;",O={};i(O),u=E(O),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(u.workerUrl=window.URL.createObjectURL(new Blob([I],{type:"text/javascript"})))}}f(["exports"],function(a){var E=typeof self<"u"?self:{},I="2.11.0";let O;const R={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(O==null){const r=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{O={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):r}catch{O=r}}return O},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get EVENTS_URL(){return this.API_URL?this.API_URL.indexOf("https://api.mapbox.cn")===0?"https://events.mapbox.cn/events/v2":this.API_URL.indexOf("https://api.mapbox.com")===0?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},N={supported:!1,testSupport:function(r){!ae&&re&&(be?De(r):H=r)}};let H,re,ae=!1,be=!1;function De(r){const t=r.createTexture();r.bindTexture(r.TEXTURE_2D,t);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,re),r.isContextLost())return;N.supported=!0}catch{}r.deleteTexture(t),ae=!0}E.document&&(re=E.document.createElement("img"),re.onload=function(){H&&De(H),H=null,be=!0},re.onerror=function(){ae=!0,H=null},re.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Oe="01";var Ce=Ve;function Ve(r,t,s,c){this.cx=3*r,this.bx=3*(s-r)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(c-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=r,this.p1y=t,this.p2x=s,this.p2y=c}Ve.prototype={sampleCurveX:function(r){return((this.ax*r+this.bx)*r+this.cx)*r},sampleCurveY:function(r){return((this.ay*r+this.by)*r+this.cy)*r},sampleCurveDerivativeX:function(r){return(3*this.ax*r+2*this.bx)*r+this.cx},solveCurveX:function(r,t){if(t===void 0&&(t=1e-6),r<0)return 0;if(r>1)return 1;for(var s=r,c=0;c<8;c++){var d=this.sampleCurveX(s)-r;if(Math.abs(d)<t)return s;var m=this.sampleCurveDerivativeX(s);if(Math.abs(m)<1e-6)break;s-=d/m}var _=0,v=1;for(s=r,c=0;c<20&&(d=this.sampleCurveX(s),!(Math.abs(d-r)<t));c++)r>d?_=s:v=s,s=.5*(v-_)+_;return s},solve:function(r,t){return this.sampleCurveY(this.solveCurveX(r,t))}};var Ee=dt;function dt(r,t){this.x=r,this.y=t}dt.prototype={clone:function(){return new dt(this.x,this.y)},add:function(r){return this.clone()._add(r)},sub:function(r){return this.clone()._sub(r)},multByPoint:function(r){return this.clone()._multByPoint(r)},divByPoint:function(r){return this.clone()._divByPoint(r)},mult:function(r){return this.clone()._mult(r)},div:function(r){return this.clone()._div(r)},rotate:function(r){return this.clone()._rotate(r)},rotateAround:function(r,t){return this.clone()._rotateAround(r,t)},matMult:function(r){return this.clone()._matMult(r)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(r){return this.x===r.x&&this.y===r.y},dist:function(r){return Math.sqrt(this.distSqr(r))},distSqr:function(r){var t=r.x-this.x,s=r.y-this.y;return t*t+s*s},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith:function(r){return this.angleWithSep(r.x,r.y)},angleWithSep:function(r,t){return Math.atan2(this.x*t-this.y*r,this.x*r+this.y*t)},_matMult:function(r){var t=r[2]*this.x+r[3]*this.y;return this.x=r[0]*this.x+r[1]*this.y,this.y=t,this},_add:function(r){return this.x+=r.x,this.y+=r.y,this},_sub:function(r){return this.x-=r.x,this.y-=r.y,this},_mult:function(r){return this.x*=r,this.y*=r,this},_div:function(r){return this.x/=r,this.y/=r,this},_multByPoint:function(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint:function(r){return this.x/=r.x,this.y/=r.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var r=this.y;return this.y=this.x,this.x=-r,this},_rotate:function(r){var t=Math.cos(r),s=Math.sin(r),c=s*this.x+t*this.y;return this.x=t*this.x-s*this.y,this.y=c,this},_rotateAround:function(r,t){var s=Math.cos(r),c=Math.sin(r),d=t.y+c*(this.x-t.x)+s*(this.y-t.y);return this.x=t.x+s*(this.x-t.x)-c*(this.y-t.y),this.y=d,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},dt.convert=function(r){return r instanceof dt?r:Array.isArray(r)?new dt(r[0],r[1]):r};const wt=Math.PI/180,kt=180/Math.PI;function et(r){return r*wt}function Tt(r){return r*kt}const ut=[[0,0],[1,0],[1,1],[0,1]];function si(r){if(r<=0)return 0;if(r>=1)return 1;const t=r*r,s=t*r;return 4*(r<.5?s:3*(r-t)+s-.75)}function ti(r,t,s,c){const d=new Ce(r,t,s,c);return function(m){return d.solve(m)}}const Zt=ti(.25,.1,.25,1);function Lt(r,t,s){return Math.min(s,Math.max(t,r))}function An(r,t,s){return(s=Lt((s-r)/(t-r),0,1))*s*(3-2*s)}function fn(r,t,s){const c=s-t,d=((r-t)%c+c)%c+t;return d===t?s:d}function pn(r,t,s){if(!r.length)return s(null,[]);let c=r.length;const d=new Array(r.length);let m=null;r.forEach((_,v)=>{t(_,(w,T)=>{w&&(m=w),d[v]=T,--c==0&&s(m,d)})})}function Gi(r){const t=[];for(const s in r)t.push(r[s]);return t}function ni(r,...t){for(const s of t)for(const c in s)r[c]=s[c];return r}let Hr=1;function ur(){return Hr++}function Ki(){return function r(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)}()}function $i(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}function Xr(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)}function Jn(r,t){r.forEach(s=>{t[s]&&(t[s]=t[s].bind(t))})}function Ai(r,t){return r.indexOf(t,r.length-t.length)!==-1}function Si(r,t,s){const c={};for(const d in r)c[d]=t.call(s||this,r[d],d,r);return c}function oi(r,t,s){const c={};for(const d in r)t.call(s||this,r[d],d,r)&&(c[d]=r[d]);return c}function yi(r){return Array.isArray(r)?r.map(yi):typeof r=="object"&&r?Si(r,yi):r}const hr={};function fi(r){hr[r]||(typeof console<"u"&&console.warn(r),hr[r]=!0)}function mn(r,t,s){return(s.y-r.y)*(t.x-r.x)>(t.y-r.y)*(s.x-r.x)}function Kt(r){let t=0;for(let s,c,d=0,m=r.length,_=m-1;d<m;_=d++)s=r[d],c=r[_],t+=(c.x-s.x)*(s.y+c.y);return t}function gn(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function _n(r){const t={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(s,c,d,m)=>{const _=d||m;return t[c]=!_||_.toLowerCase(),""}),t["max-age"]){const s=parseInt(t["max-age"],10);isNaN(s)?delete t["max-age"]:t["max-age"]=s}return t}let tn=null;function dr(r){if(tn==null){const t=r.navigator?r.navigator.userAgent:null;tn=!!r.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return tn}function wr(r){try{const t=E[r];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}}function Gn(r,t){return[r[4*t],r[4*t+1],r[4*t+2],r[4*t+3]]}const Ji="mapbox-tiles";let Qi,Qn,Sn=500,Yr=50;function Kr(){try{return E.caches}catch{}}function fr(){Kr()&&!Qi&&(Qi=E.caches.open(Ji))}function Wi(r){const t=r.indexOf("?");if(t<0)return r;const s=function(d){const m=d.indexOf("?");return m>0?d.slice(m+1).split("&"):[]}(r),c=s.filter(d=>{const m=d.split("=");return m[0]==="language"||m[0]==="worldview"});return c.length?`${r.slice(0,t)}?${c.join("&")}`:r.slice(0,t)}let Ir=1/0;const yn={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(yn);class Mn extends Error{constructor(t,s,c){s===401&&Cr(c)&&(t+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(t),this.status=s,this.url=c}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Pn=gn()?()=>self.worker&&self.worker.referrer:()=>(E.location.protocol==="blob:"?E.parent:E).location.href,er=function(r,t){if(!(/^file:/.test(s=r.url)||/^file:/.test(Pn())&&!/^\w+:/.test(s))){if(E.fetch&&E.Request&&E.AbortController&&E.Request.prototype.hasOwnProperty("signal"))return function(c,d){const m=new E.AbortController,_=new E.Request(c.url,{method:c.method||"GET",body:c.body,credentials:c.credentials,headers:c.headers,referrer:Pn(),signal:m.signal});let v=!1,w=!1;const T=(S=_.url).indexOf("sku=")>0&&Cr(S);var S;c.type==="json"&&_.headers.set("Accept","application/json");const C=(z,B,V)=>{if(w)return;if(z&&z.message!=="SecurityError"&&fi(z),B&&V)return L(B);const Z=Date.now();E.fetch(_).then(oe=>{if(oe.ok){const de=T?oe.clone():null;return L(oe,de,Z)}return d(new Mn(oe.statusText,oe.status,c.url))}).catch(oe=>{oe.code!==20&&d(new Error(oe.message))})},L=(z,B,V)=>{(c.type==="arrayBuffer"?z.arrayBuffer():c.type==="json"?z.json():z.text()).then(Z=>{w||(B&&V&&function(oe,de,se){if(fr(),!Qi)return;const ue={status:de.status,statusText:de.statusText,headers:new E.Headers};de.headers.forEach((Re,Le)=>ue.headers.set(Le,Re));const ye=_n(de.headers.get("Cache-Control")||"");if(ye["no-store"])return;ye["max-age"]&&ue.headers.set("Expires",new Date(se+1e3*ye["max-age"]).toUTCString());const pe=ue.headers.get("Expires");pe&&(new Date(pe).getTime()-se<42e4||function(Re,Le){if(Qn===void 0)try{new Response(new ReadableStream),Qn=!0}catch{Qn=!1}Qn?Le(Re.body):Re.blob().then(Le)}(de,Re=>{const Le=new E.Response(Re,ue);fr(),Qi&&Qi.then(Ne=>Ne.put(Wi(oe.url),Le)).catch(Ne=>fi(Ne.message))}))}(_,B,V),v=!0,d(null,Z,z.headers.get("Cache-Control"),z.headers.get("Expires")))}).catch(Z=>{w||d(new Error(Z.message))})};return T?function(z,B){if(fr(),!Qi)return B(null);const V=Wi(z.url);Qi.then(Z=>{Z.match(V).then(oe=>{const de=function(se){if(!se)return!1;const ue=new Date(se.headers.get("Expires")||0),ye=_n(se.headers.get("Cache-Control")||"");return ue>Date.now()&&!ye["no-cache"]}(oe);Z.delete(V),de&&Z.put(V,oe.clone()),B(null,oe,de)}).catch(B)}).catch(B)}(_,C):C(null,null),{cancel:()=>{w=!0,v||m.abort()}}}(r,t);if(gn()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",r,t,void 0,!0)}var s;return function(c,d){const m=new E.XMLHttpRequest;m.open(c.method||"GET",c.url,!0),c.type==="arrayBuffer"&&(m.responseType="arraybuffer");for(const _ in c.headers)m.setRequestHeader(_,c.headers[_]);return c.type==="json"&&(m.responseType="text",m.setRequestHeader("Accept","application/json")),m.withCredentials=c.credentials==="include",m.onerror=()=>{d(new Error(m.statusText))},m.onload=()=>{if((m.status>=200&&m.status<300||m.status===0)&&m.response!==null){let _=m.response;if(c.type==="json")try{_=JSON.parse(m.response)}catch(v){return d(v)}d(null,_,m.getResponseHeader("Cache-Control"),m.getResponseHeader("Expires"))}else d(new Mn(m.statusText,m.status,c.url))},m.send(c.body),{cancel:()=>m.abort()}}(r,t)},an=function(r,t){return er(ni(r,{type:"arrayBuffer"}),t)};function xs(r){const t=E.document.createElement("a");return t.href=r,t.protocol===E.document.location.protocol&&t.host===E.document.location.host}const Fs="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Jr,Wn;Jr=[],Wn=0;const Qr=function(r,t){if(N.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),Wn>=R.MAX_PARALLEL_IMAGE_REQUESTS){const m={requestParameters:r,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return Jr.push(m),m}Wn++;let s=!1;const c=()=>{if(!s)for(s=!0,Wn--;Jr.length&&Wn<R.MAX_PARALLEL_IMAGE_REQUESTS;){const m=Jr.shift(),{requestParameters:_,callback:v,cancelled:w}=m;w||(m.cancel=Qr(_,v).cancel)}},d=an(r,(m,_,v,w)=>{c(),m?t(m):_&&(E.createImageBitmap?function(T,S){const C=new E.Blob([new Uint8Array(T)],{type:"image/png"});E.createImageBitmap(C).then(L=>{S(null,L)}).catch(L=>{S(new Error(`Could not load image because of ${L.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(_,(T,S)=>t(T,S,v,w)):function(T,S){const C=new E.Image,L=E.URL;C.onload=()=>{S(null,C),L.revokeObjectURL(C.src),C.onload=null,E.requestAnimationFrame(()=>{C.src=Fs})},C.onerror=()=>S(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const z=new E.Blob([new Uint8Array(T)],{type:"image/png"});C.src=T.byteLength?L.createObjectURL(z):Fs}(_,(T,S)=>t(T,S,v,w)))});return{cancel:()=>{d.cancel(),c()}}},es="NO_ACCESS_TOKEN";function Bn(r){return r.indexOf("mapbox:")===0}function Cr(r){return R.API_URL_REGEX.test(r)}function ts(r){return R.API_STYLE_REGEX.test(r)&&!Lr(r)}function Lr(r){return R.API_SPRITE_REGEX.test(r)}const kr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Tn(r){const t=r.match(kr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function pr(r){const t=r.params.length?`?${r.params.join("&")}`:"";return`${r.protocol}://${r.authority}${r.path}${t}`}function vs(r){if(!r)return null;const t=r.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(decodeURIComponent(E.atob(t[1]).split("").map(s=>"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class is{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const s=vs(R.ACCESS_TOKEN);let c="";return c=s&&s.u?E.btoa(encodeURIComponent(s.u).replace(/%([0-9A-F]{2})/g,(d,m)=>String.fromCharCode(Number("0x"+m)))):R.ACCESS_TOKEN||"",t?`mapbox.eventData.${t}:${c}`:`mapbox.eventData:${c}`}fetchEventData(){const t=wr("localStorage"),s=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{const d=E.localStorage.getItem(s);d&&(this.eventData=JSON.parse(d));const m=E.localStorage.getItem(c);m&&(this.anonId=m)}catch{fi("Unable to read from LocalStorage")}}saveEventData(){const t=wr("localStorage"),s=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{E.localStorage.setItem(c,this.anonId),Object.keys(this.eventData).length>=1&&E.localStorage.setItem(s,JSON.stringify(this.eventData))}catch{fi("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,s,c,d){if(!R.EVENTS_URL)return;const m=Tn(R.EVENTS_URL);m.params.push(`access_token=${d||R.ACCESS_TOKEN||""}`);const _={event:this.type,created:new Date(t).toISOString()},v=s?ni(_,s):_,w={url:pr(m),headers:{"Content-Type":"text/plain"},body:JSON.stringify([v])};this.pendingRequest=function(T,S){return er(ni(T,{method:"POST"}),S)}(w,T=>{this.pendingRequest=null,c(T),this.saveEventData(),this.processRequests(d)})}queueRequest(t,s){this.queue.push(t),this.processRequests(s)}}const ne=new class extends is{constructor(r){super("appUserTurnstile"),this._customAccessToken=r}postTurnstileEvent(r,t){R.EVENTS_URL&&R.ACCESS_TOKEN&&Array.isArray(r)&&r.some(s=>Bn(s)||Cr(s))&&this.queueRequest(Date.now(),t)}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=vs(R.ACCESS_TOKEN),s=t?t.u:R.ACCESS_TOKEN;let c=s!==this.eventData.tokenU;Xr(this.anonId)||(this.anonId=Ki(),c=!0);const d=this.queue.shift();if(this.eventData.lastSuccess){const m=new Date(this.eventData.lastSuccess),_=new Date(d),v=(d-this.eventData.lastSuccess)/864e5;c=c||v>=1||v<-1||m.getDate()!==_.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:I,skuId:Oe,"enabled.telemetry":!1,userId:this.anonId},m=>{m||(this.eventData.lastSuccess=d,this.eventData.tokenU=s)},r):this.processRequests()}},F=ne.postTurnstileEvent.bind(ne),j=new class extends is{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(r,t,s,c){this.skuToken=t,this.errorCb=c,R.EVENTS_URL&&(s||R.ACCESS_TOKEN?this.queueRequest({id:r,timestamp:Date.now()},s):this.errorCb(new Error(es)))}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:s}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),Xr(this.anonId)||(this.anonId=Ki()),this.postEvent(s,{sdkIdentifier:"mapbox-gl-js",sdkVersion:I,skuId:Oe,skuToken:this.skuToken,userId:this.anonId},c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},r))}},te=j.postMapLoadEvent.bind(j),ce=new class extends is{constructor(){super("gljs.performance")}postPerformanceEvent(r,t){R.EVENTS_URL&&(r||R.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},r)}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:s}=this.queue.shift(),c=function(d){const m=E.performance.getEntriesByType("resource"),_=E.performance.getEntriesByType("mark"),v=function(L){const z={};if(L){for(const B in L)if(B!=="other")for(const V of L[B]){const Z=`${B}RequestCount`,oe=`${B}ResolveRangeMin`,de=`${B}ResolveRangeMax`;z[oe]=Math.min(z[oe]||1/0,V.startTime),z[de]=Math.max(z[de]||-1/0,V.responseEnd),z[Z]===void 0&&(z[Z]=0),++z[Z]}}return z}(function(L,z){const B={};if(L)for(const V of L){const Z=z(V);B[Z]===void 0&&(B[Z]=[]),B[Z].push(V)}return B}(m,st)),w=E.devicePixelRatio,T=E.navigator.connection||E.navigator.mozConnection||E.navigator.webkitConnection,S={counters:[],metadata:[],attributes:[]},C=(L,z,B)=>{B!=null&&L.push({name:z,value:B.toString()})};for(const L in v)C(S.counters,L,v[L]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(C(S.counters,"interactionRangeMin",d.interactionRange[0]),C(S.counters,"interactionRangeMax",d.interactionRange[1])),_)for(const L of Object.keys(Se)){const z=Se[L],B=_.find(V=>V.name===z);B&&C(S.counters,z,B.startTime)}return C(S.attributes,"style",function(L){if(L)for(const z of L){const B=z.name.split("?")[0];if(ts(B)){const V=B.split("/").slice(-2);if(V.length===2)return`mapbox://styles/${V[0]}/${V[1]}`}}}(m)),C(S.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),C(S.attributes,"fogEnabled",d.fogEnabled?"true":"false"),C(S.attributes,"projection",d.projection.name),C(S.attributes,"zoom",d.zoom),C(S.metadata,"devicePixelRatio",w),C(S.metadata,"connectionEffectiveType",T?T.effectiveType:void 0),C(S.metadata,"navigatorUserAgent",E.navigator.userAgent),C(S.metadata,"screenWidth",E.screen.width),C(S.metadata,"screenHeight",E.screen.height),C(S.metadata,"windowWidth",E.innerWidth),C(S.metadata,"windowHeight",E.innerHeight),C(S.metadata,"mapWidth",d.width/w),C(S.metadata,"mapHeight",d.height/w),C(S.metadata,"webglRenderer",d.renderer),C(S.metadata,"webglVendor",d.vendor),C(S.metadata,"sdkVersion",I),C(S.metadata,"sdkIdentifier","mapbox-gl-js"),S}(s);for(const d of c.metadata);for(const d of c.counters);for(const d of c.attributes);this.postEvent(t,c,()=>{},r)}},ge=ce.postPerformanceEvent.bind(ce),Ae=new class extends is{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(r,t,s,c){if(!R.API_URL||!R.SESSION_PATH)return;const d=Tn(R.API_URL+R.SESSION_PATH);d.params.push(`sku=${t||""}`),d.params.push(`access_token=${c||R.ACCESS_TOKEN||""}`);const m={url:pr(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(_,v){return er(ni(_,{method:"GET"}),v)}(m,_=>{this.pendingRequest=null,s(_),this.saveEventData(),this.processRequests(c)})}getSessionAPI(r,t,s,c){this.skuToken=t,this.errorCb=c,R.SESSION_PATH&&R.API_URL&&(s||R.ACCESS_TOKEN?this.queueRequest({id:r,timestamp:Date.now()},s):this.errorCb(new Error(es)))}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:s}=this.queue.shift();t&&this.success[t]||this.getSession(s,this.skuToken,c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},r)}},Te=Ae.getSessionAPI.bind(Ae),xe=new Set,Se={create:"create",load:"load",fullLoad:"fullLoad"},Ge={mark(r){E.performance.mark(r)},measure(r,t,s){E.performance.measure(r,t,s)}};function st(r){const t=r.name.split("?")[0];return t.includes("mapbox-gl.js")?"javascript":t.includes("mapbox-gl.css")?"css":function(s){return R.API_FONTS_REGEX.test(s)}(t)?"fontRange":Lr(t)?"sprite":ts(t)?"style":function(s){return R.API_TILEJSON_REGEX.test(s)}(t)?"tilejson":"other"}const Ze=E.performance;function At(r){const t=r?r.url.toString():void 0;return Ze.getEntriesByName(t)}let gt,yt,Mt,Ut;const ii={now:()=>Mt!==void 0?Mt:E.performance.now(),setNow(r){Mt=r},restoreNow(){Mt=void 0},frame(r){const t=E.requestAnimationFrame(r);return{cancel:()=>E.cancelAnimationFrame(t)}},getImageData(r,t=0){const{width:s,height:c}=r;Ut||(Ut=E.document.createElement("canvas"));const d=Ut.getContext("2d");if(!d)throw new Error("failed to create canvas 2d context");return(s>Ut.width||c>Ut.height)&&(Ut.width=s,Ut.height=c),d.clearRect(-t,-t,s+2*t,c+2*t),d.drawImage(r,0,0,s,c),d.getImageData(-t,-t,s+2*t,c+2*t)},resolveURL:r=>(gt||(gt=E.document.createElement("a")),gt.href=r,gt.href),get devicePixelRatio(){return E.devicePixelRatio},get prefersReducedMotion(){return!!E.matchMedia&&(yt==null&&(yt=E.matchMedia("(prefers-reduced-motion: reduce)")),yt.matches)}};function Pt(r,t,s){s[r]&&s[r].indexOf(t)!==-1||(s[r]=s[r]||[],s[r].push(t))}function We(r,t,s){if(s&&s[r]){const c=s[r].indexOf(t);c!==-1&&s[r].splice(c,1)}}class Xe{constructor(t,s={}){ni(this,s),this.type=t}}class pt extends Xe{constructor(t,s={}){super("error",ni({error:t},s))}}class It{on(t,s){return this._listeners=this._listeners||{},Pt(t,s,this._listeners),this}off(t,s){return We(t,s,this._listeners),We(t,s,this._oneTimeListeners),this}once(t,s){return s?(this._oneTimeListeners=this._oneTimeListeners||{},Pt(t,s,this._oneTimeListeners),this):new Promise(c=>this.once(t,c))}fire(t,s){typeof t=="string"&&(t=new Xe(t,s||{}));const c=t.type;if(this.listens(c)){t.target=this;const d=this._listeners&&this._listeners[c]?this._listeners[c].slice():[];for(const v of d)v.call(this,t);const m=this._oneTimeListeners&&this._oneTimeListeners[c]?this._oneTimeListeners[c].slice():[];for(const v of m)We(c,v,this._oneTimeListeners),v.call(this,t);const _=this._eventedParent;_&&(ni(t,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),_.fire(t))}else t instanceof pt&&console.error(t.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,s){return this._eventedParent=t,this._eventedParentData=s,this}}var Me=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{},"globe":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["source"]}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["fill-extrusion-edge-radius"]}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"transition":false,"requires":[{"source":"geojson","has":{"lineMetrics":true}}],"property-type":"constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Qt(r,...t){for(const s of t)for(const c in s)r[c]=s[c];return r}function $t(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function Yt(r){if(Array.isArray(r))return r.map(Yt);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const t={};for(const s in r)t[s]=Yt(r[s]);return t}return $t(r)}class Fi extends Error{constructor(t,s){super(s),this.message=s,this.key=t}}var qi=Fi;class mr{constructor(t,s=[]){this.parent=t,this.bindings={};for(const[c,d]of s)this.bindings[c]=d}concat(t){return new mr(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var Rr=mr;const vi={kind:"null"},ot={kind:"number"},Vt={kind:"string"},jt={kind:"boolean"},Fn={kind:"color"},ns={kind:"object"},qt={kind:"value"},Zn={kind:"collator"},Ns={kind:"formatted"},bs={kind:"resolvedImage"};function In(r,t){return{kind:"array",itemType:r,N:t}}function Mi(r){if(r.kind==="array"){const t=Mi(r.itemType);return typeof r.N=="number"?`array<${t}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${t}>`}return r.kind}const zc=[vi,ot,Vt,jt,Fn,Ns,ns,In(qt),bs];function gr(r,t){if(t.kind==="error")return null;if(r.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!gr(r.itemType,t.itemType))&&(typeof r.N!="number"||r.N===t.N))return null}else{if(r.kind===t.kind)return null;if(r.kind==="value"){for(const s of zc)if(!gr(s,t))return null}}return`Expected ${Mi(r)} but found ${Mi(t)} instead.`}function $(r,t){return t.some(s=>s.kind===r.kind)}function Q(r,t){return t.some(s=>s==="null"?r===null:s==="array"?Array.isArray(r):s==="object"?r&&!Array.isArray(r)&&typeof r=="object":s===typeof r)}var _e,Fe={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function it(r){return(r=Math.round(r))<0?0:r>255?255:r}function xt(r){return it(r[r.length-1]==="%"?parseFloat(r)/100*255:parseInt(r))}function Jt(r){return(t=r[r.length-1]==="%"?parseFloat(r)/100:parseFloat(r))<0?0:t>1?1:t;var t}function Ni(r,t,s){return s<0?s+=1:s>1&&(s-=1),6*s<1?r+(t-r)*s*6:2*s<1?t:3*s<2?r+(t-r)*(2/3-s)*6:r}try{_e={}.parseCSSColor=function(r){var t,s=r.replace(/ /g,"").toLowerCase();if(s in Fe)return Fe[s].slice();if(s[0]==="#")return s.length===4?(t=parseInt(s.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:s.length===7&&(t=parseInt(s.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var c=s.indexOf("("),d=s.indexOf(")");if(c!==-1&&d+1===s.length){var m=s.substr(0,c),_=s.substr(c+1,d-(c+1)).split(","),v=1;switch(m){case"rgba":if(_.length!==4)return null;v=Jt(_.pop());case"rgb":return _.length!==3?null:[xt(_[0]),xt(_[1]),xt(_[2]),v];case"hsla":if(_.length!==4)return null;v=Jt(_.pop());case"hsl":if(_.length!==3)return null;var w=(parseFloat(_[0])%360+360)%360/360,T=Jt(_[1]),S=Jt(_[2]),C=S<=.5?S*(T+1):S+T-S*T,L=2*S-C;return[it(255*Ni(L,C,w+1/3)),it(255*Ni(L,C,w)),it(255*Ni(L,C,w-1/3)),v];default:return null}}return null}}catch{}class pi{constructor(t,s,c,d=1){this.r=t,this.g=s,this.b=c,this.a=d}static parse(t){if(!t)return;if(t instanceof pi)return t;if(typeof t!="string")return;const s=_e(t);return s?new pi(s[0]/255*s[3],s[1]/255*s[3],s[2]/255*s[3],s[3]):void 0}toString(){const[t,s,c,d]=this.toArray();return`rgba(${Math.round(t)},${Math.round(s)},${Math.round(c)},${d})`}toArray(){const{r:t,g:s,b:c,a:d}=this;return d===0?[0,0,0,0]:[255*t/d,255*s/d,255*c/d,d]}toArray01(){const{r:t,g:s,b:c,a:d}=this;return d===0?[0,0,0,0]:[t/d,s/d,c/d,d]}toArray01PremultipliedAlpha(){const{r:t,g:s,b:c,a:d}=this;return[t,s,c,d]}}pi.black=new pi(0,0,0,1),pi.white=new pi(1,1,1,1),pi.transparent=new pi(0,0,0,0),pi.red=new pi(1,0,0,1),pi.blue=new pi(0,0,1,1);var ri=pi;class tr{constructor(t,s,c){this.sensitivity=t?s?"variant":"case":s?"accent":"base",this.locale=c,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,s){return this.collator.compare(t,s)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Oc{constructor(t,s,c,d,m){this.text=t.normalize?t.normalize():t,this.image=s,this.scale=c,this.fontStack=d,this.textColor=m}}class $n{constructor(t){this.sections=t}static fromString(t){return new $n([new Oc(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.name.length!==0)}static factory(t){return t instanceof $n?t:$n.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const s of this.sections){if(s.image){t.push(["image",s.image.name]);continue}t.push(s.text);const c={};s.fontStack&&(c["text-font"]=["literal",s.fontStack.split(",")]),s.scale&&(c["font-scale"]=s.scale),s.textColor&&(c["text-color"]=["rgba"].concat(s.textColor.toArray())),t.push(c)}return t}}class ir{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new ir({name:t,available:!1}):null}serialize(){return["image",this.name]}}function Qh(r,t,s,c){return typeof r=="number"&&r>=0&&r<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof s=="number"&&s>=0&&s<=255?c===void 0||typeof c=="number"&&c>=0&&c<=1?null:`Invalid rgba value [${[r,t,s,c].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof c=="number"?[r,t,s,c]:[r,t,s]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function uo(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof ri||r instanceof tr||r instanceof $n||r instanceof ir)return!0;if(Array.isArray(r)){for(const t of r)if(!uo(t))return!1;return!0}if(typeof r=="object"){for(const t in r)if(!uo(r[t]))return!1;return!0}return!1}function ln(r){if(r===null)return vi;if(typeof r=="string")return Vt;if(typeof r=="boolean")return jt;if(typeof r=="number")return ot;if(r instanceof ri)return Fn;if(r instanceof tr)return Zn;if(r instanceof $n)return Ns;if(r instanceof ir)return bs;if(Array.isArray(r)){const t=r.length;let s;for(const c of r){const d=ln(c);if(s){if(s===d)continue;s=qt;break}s=d}return In(s||qt,t)}return ns}function ua(r){const t=typeof r;return r===null?"":t==="string"||t==="number"||t==="boolean"?String(r):r instanceof ri||r instanceof $n||r instanceof ir?r.toString():JSON.stringify(r)}class Bc{constructor(t,s){this.type=t,this.value=s}static parse(t,s){if(t.length!==2)return s.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!uo(t[1]))return s.error("invalid value");const c=t[1];let d=ln(c);const m=s.expectedType;return d.kind!=="array"||d.N!==0||!m||m.kind!=="array"||typeof m.N=="number"&&m.N!==0||(d=m),new Bc(d,c)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof ri?["rgba"].concat(this.value.toArray()):this.value instanceof $n?this.value.serialize():this.value}}var ha=Bc,Cn=class{constructor(r){this.name="ExpressionEvaluationError",this.message=r}toJSON(){return this.message}};const Fc={string:Vt,number:ot,boolean:jt,object:ns};class Nc{constructor(t,s){this.type=t,this.args=s}static parse(t,s){if(t.length<2)return s.error("Expected at least one argument.");let c,d=1;const m=t[0];if(m==="array"){let v,w;if(t.length>2){const T=t[1];if(typeof T!="string"||!(T in Fc)||T==="object")return s.error('The item type argument of "array" must be one of string, number, boolean',1);v=Fc[T],d++}else v=qt;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return s.error('The length argument to "array" must be a positive integer literal',2);w=t[2],d++}c=In(v,w)}else c=Fc[m];const _=[];for(;d<t.length;d++){const v=s.parse(t[d],d,qt);if(!v)return null;_.push(v)}return new Nc(c,_)}evaluate(t){for(let s=0;s<this.args.length;s++){const c=this.args[s].evaluate(t);if(!gr(this.type,ln(c)))return c;if(s===this.args.length-1)throw new Cn(`Expected value to be of type ${Mi(this.type)}, but found ${Mi(ln(c))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,s=[t.kind];if(t.kind==="array"){const c=t.itemType;if(c.kind==="string"||c.kind==="number"||c.kind==="boolean"){s.push(c.kind);const d=t.N;(typeof d=="number"||this.args.length>1)&&s.push(d)}}return s.concat(this.args.map(c=>c.serialize()))}}var rs=Nc;class Us{constructor(t){this.type=Ns,this.sections=t}static parse(t,s){if(t.length<2)return s.error("Expected at least one argument.");const c=t[1];if(!Array.isArray(c)&&typeof c=="object")return s.error("First argument must be an image or text section.");const d=[];let m=!1;for(let _=1;_<=t.length-1;++_){const v=t[_];if(m&&typeof v=="object"&&!Array.isArray(v)){m=!1;let w=null;if(v["font-scale"]&&(w=s.parse(v["font-scale"],1,ot),!w))return null;let T=null;if(v["text-font"]&&(T=s.parse(v["text-font"],1,In(Vt)),!T))return null;let S=null;if(v["text-color"]&&(S=s.parse(v["text-color"],1,Fn),!S))return null;const C=d[d.length-1];C.scale=w,C.font=T,C.textColor=S}else{const w=s.parse(t[_],1,qt);if(!w)return null;const T=w.type.kind;if(T!=="string"&&T!=="value"&&T!=="null"&&T!=="resolvedImage")return s.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");m=!0,d.push({content:w,scale:null,font:null,textColor:null})}}return new Us(d)}evaluate(t){return new $n(this.sections.map(s=>{const c=s.content.evaluate(t);return ln(c)===bs?new Oc("",c,null,null,null):new Oc(ua(c),null,s.scale?s.scale.evaluate(t):null,s.font?s.font.evaluate(t).join(","):null,s.textColor?s.textColor.evaluate(t):null)}))}eachChild(t){for(const s of this.sections)t(s.content),s.scale&&t(s.scale),s.font&&t(s.font),s.textColor&&t(s.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const s of this.sections){t.push(s.content.serialize());const c={};s.scale&&(c["font-scale"]=s.scale.serialize()),s.font&&(c["text-font"]=s.font.serialize()),s.textColor&&(c["text-color"]=s.textColor.serialize()),t.push(c)}return t}}class Qa{constructor(t){this.type=bs,this.input=t}static parse(t,s){if(t.length!==2)return s.error("Expected two arguments.");const c=s.parse(t[1],1,Vt);return c?new Qa(c):s.error("No image name provided.")}evaluate(t){const s=this.input.evaluate(t),c=ir.fromString(s);return c&&t.availableImages&&(c.available=t.availableImages.indexOf(s)>-1),c}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const Hp={"to-boolean":jt,"to-color":Fn,"to-number":ot,"to-string":Vt};class Uc{constructor(t,s){this.type=t,this.args=s}static parse(t,s){if(t.length<2)return s.error("Expected at least one argument.");const c=t[0];if((c==="to-boolean"||c==="to-string")&&t.length!==2)return s.error("Expected one argument.");const d=Hp[c],m=[];for(let _=1;_<t.length;_++){const v=s.parse(t[_],_,qt);if(!v)return null;m.push(v)}return new Uc(d,m)}evaluate(t){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(t));if(this.type.kind==="color"){let s,c;for(const d of this.args){if(s=d.evaluate(t),c=null,s instanceof ri)return s;if(typeof s=="string"){const m=t.parseColor(s);if(m)return m}else if(Array.isArray(s)&&(c=s.length<3||s.length>4?`Invalid rbga value ${JSON.stringify(s)}: expected an array containing either three or four numeric values.`:Qh(s[0],s[1],s[2],s[3]),!c))return new ri(s[0]/255,s[1]/255,s[2]/255,s[3])}throw new Cn(c||`Could not parse color from value '${typeof s=="string"?s:String(JSON.stringify(s))}'`)}if(this.type.kind==="number"){let s=null;for(const c of this.args){if(s=c.evaluate(t),s===null)return 0;const d=Number(s);if(!isNaN(d))return d}throw new Cn(`Could not convert ${JSON.stringify(s)} to number.`)}return this.type.kind==="formatted"?$n.fromString(ua(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?ir.fromString(ua(this.args[0].evaluate(t))):ua(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Us([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Qa(this.args[0]).serialize();const t=[`to-${this.type.kind}`];return this.eachChild(s=>{t.push(s.serialize())}),t}}var Oo=Uc;const Xp=["Unknown","Point","LineString","Polygon"];var ed=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Xp[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const r=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:s,y:c}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*t-r[0])+this.featureDistanceData.bearing[1]*(c*t-r[1])}return 0}parseColor(r){let t=this._parseColorCache[r];return t||(t=this._parseColorCache[r]=ri.parse(r)),t}};class ho{constructor(t,s,c,d){this.name=t,this.type=s,this._evaluate=c,this.args=d}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,s){const c=t[0],d=ho.definitions[c];if(!d)return s.error(`Unknown expression "${c}". If you wanted a literal array, use ["literal", [...]].`,0);const m=Array.isArray(d)?d[0]:d.type,_=Array.isArray(d)?[[d[1],d[2]]]:d.overloads,v=_.filter(([T])=>!Array.isArray(T)||T.length===t.length-1);let w=null;for(const[T,S]of v){w=new Hc(s.registry,s.path,null,s.scope);const C=[];let L=!1;for(let z=1;z<t.length;z++){const B=t[z],V=Array.isArray(T)?T[z-1]:T.type,Z=w.parse(B,1+C.length,V);if(!Z){L=!0;break}C.push(Z)}if(!L)if(Array.isArray(T)&&T.length!==C.length)w.error(`Expected ${T.length} arguments, but found ${C.length} instead.`);else{for(let z=0;z<C.length;z++){const B=Array.isArray(T)?T[z]:T.type,V=C[z];w.concat(z+1).checkSubtype(B,V.type)}if(w.errors.length===0)return new ho(c,m,S,C)}}if(v.length===1)s.errors.push(...w.errors);else{const T=(v.length?v:_).map(([C])=>{return L=C,Array.isArray(L)?`(${L.map(Mi).join(", ")})`:`(${Mi(L.type)}...)`;var L}).join(" | "),S=[];for(let C=1;C<t.length;C++){const L=s.parse(t[C],1+S.length);if(!L)return null;S.push(Mi(L.type))}s.error(`Expected arguments of type ${T}, but found (${S.join(", ")}) instead.`)}return null}static register(t,s){ho.definitions=s;for(const c in s)t[c]=ho}}var Dr=ho;class el{constructor(t,s,c){this.type=Zn,this.locale=c,this.caseSensitive=t,this.diacriticSensitive=s}static parse(t,s){if(t.length!==2)return s.error("Expected one argument.");const c=t[1];if(typeof c!="object"||Array.isArray(c))return s.error("Collator options argument must be an object.");const d=s.parse(c["case-sensitive"]!==void 0&&c["case-sensitive"],1,jt);if(!d)return null;const m=s.parse(c["diacritic-sensitive"]!==void 0&&c["diacritic-sensitive"],1,jt);if(!m)return null;let _=null;return c.locale&&(_=s.parse(c.locale,1,Vt),!_)?null:new el(d,m,_)}evaluate(t){return new tr(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}const Vs=8192;function Vc(r,t){r[0]=Math.min(r[0],t[0]),r[1]=Math.min(r[1],t[1]),r[2]=Math.max(r[2],t[0]),r[3]=Math.max(r[3],t[1])}function tl(r,t){return!(r[0]<=t[0]||r[2]>=t[2]||r[1]<=t[1]||r[3]>=t[3])}function ss(r,t){const s=(180+r[0])/360,c=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,d=Math.pow(2,t.z);return[Math.round(s*d*Vs),Math.round(c*d*Vs)]}function td(r,t,s){const c=r[0]-t[0],d=r[1]-t[1],m=r[0]-s[0],_=r[1]-s[1];return c*_-m*d==0&&c*m<=0&&d*_<=0}function il(r,t){let s=!1;for(let _=0,v=t.length;_<v;_++){const w=t[_];for(let T=0,S=w.length;T<S-1;T++){if(td(r,w[T],w[T+1]))return!1;(d=w[T])[1]>(c=r)[1]!=(m=w[T+1])[1]>c[1]&&c[0]<(m[0]-d[0])*(c[1]-d[1])/(m[1]-d[1])+d[0]&&(s=!s)}}var c,d,m;return s}function id(r,t){for(let s=0;s<t.length;s++)if(il(r,t[s]))return!0;return!1}function jc(r,t,s,c){const d=c[0]-s[0],m=c[1]-s[1],_=(r[0]-s[0])*m-d*(r[1]-s[1]),v=(t[0]-s[0])*m-d*(t[1]-s[1]);return _>0&&v<0||_<0&&v>0}function nd(r,t,s){for(const T of s)for(let S=0;S<T.length-1;++S)if((v=[(_=T[S+1])[0]-(m=T[S])[0],_[1]-m[1]])[0]*(w=[(d=t)[0]-(c=r)[0],d[1]-c[1]])[1]-v[1]*w[0]!=0&&jc(c,d,m,_)&&jc(m,_,c,d))return!0;var c,d,m,_,v,w;return!1}function Gc(r,t){for(let s=0;s<r.length;++s)if(!il(r[s],t))return!1;for(let s=0;s<r.length-1;++s)if(nd(r[s],r[s+1],t))return!1;return!0}function Wc(r,t){for(let s=0;s<t.length;s++)if(Gc(r,t[s]))return!0;return!1}function fo(r,t,s){const c=[];for(let d=0;d<r.length;d++){const m=[];for(let _=0;_<r[d].length;_++){const v=ss(r[d][_],s);Vc(t,v),m.push(v)}c.push(m)}return c}function Zc(r,t,s){const c=[];for(let d=0;d<r.length;d++){const m=fo(r[d],t,s);c.push(m)}return c}function $c(r,t,s,c){if(r[0]<s[0]||r[0]>s[2]){const d=.5*c;let m=r[0]-s[0]>d?-c:s[0]-r[0]>d?c:0;m===0&&(m=r[0]-s[2]>d?-c:s[2]-r[0]>d?c:0),r[0]+=m}Vc(t,r)}function nl(r,t,s,c){const d=Math.pow(2,c.z)*Vs,m=[c.x*Vs,c.y*Vs],_=[];if(!r)return _;for(const v of r)for(const w of v){const T=[w.x+m[0],w.y+m[1]];$c(T,t,s,d),_.push(T)}return _}function qc(r,t,s,c){const d=Math.pow(2,c.z)*Vs,m=[c.x*Vs,c.y*Vs],_=[];if(!r)return _;for(const w of r){const T=[];for(const S of w){const C=[S.x+m[0],S.y+m[1]];Vc(t,C),T.push(C)}_.push(T)}if(t[2]-t[0]<=d/2){(v=t)[0]=v[1]=1/0,v[2]=v[3]=-1/0;for(const w of _)for(const T of w)$c(T,t,s,d)}var v;return _}class os{constructor(t,s){this.type=jt,this.geojson=t,this.geometries=s}static parse(t,s){if(t.length!==2)return s.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(uo(t[1])){const c=t[1];if(c.type==="FeatureCollection")for(let d=0;d<c.features.length;++d){const m=c.features[d].geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new os(c,c.features[d].geometry)}else if(c.type==="Feature"){const d=c.geometry.type;if(d==="Polygon"||d==="MultiPolygon")return new os(c,c.geometry)}else if(c.type==="Polygon"||c.type==="MultiPolygon")return new os(c,c)}return s.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(s,c){const d=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=s.canonicalID();if(!_)return!1;if(c.type==="Polygon"){const v=fo(c.coordinates,m,_),w=nl(s.geometry(),d,m,_);if(!tl(d,m))return!1;for(const T of w)if(!il(T,v))return!1}if(c.type==="MultiPolygon"){const v=Zc(c.coordinates,m,_),w=nl(s.geometry(),d,m,_);if(!tl(d,m))return!1;for(const T of w)if(!id(T,v))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(s,c){const d=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=s.canonicalID();if(!_)return!1;if(c.type==="Polygon"){const v=fo(c.coordinates,m,_),w=qc(s.geometry(),d,m,_);if(!tl(d,m))return!1;for(const T of w)if(!Gc(T,v))return!1}if(c.type==="MultiPolygon"){const v=Zc(c.coordinates,m,_),w=qc(s.geometry(),d,m,_);if(!tl(d,m))return!1;for(const T of w)if(!Wc(T,v))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var ui=os;function da(r){if(r instanceof Dr&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof ui)return!1;let t=!0;return r.eachChild(s=>{t&&!da(s)&&(t=!1)}),t}function rl(r){if(r instanceof Dr&&r.name==="feature-state")return!1;let t=!0;return r.eachChild(s=>{t&&!rl(s)&&(t=!1)}),t}function sl(r,t){if(r instanceof Dr&&t.indexOf(r.name)>=0)return!1;let s=!0;return r.eachChild(c=>{s&&!sl(c,t)&&(s=!1)}),s}class ol{constructor(t,s){this.type=s.type,this.name=t,this.boundExpression=s}static parse(t,s){if(t.length!==2||typeof t[1]!="string")return s.error("'var' expression requires exactly one string literal argument.");const c=t[1];return s.scope.has(c)?new ol(c,s.scope.get(c)):s.error(`Unknown variable "${c}". Make sure "${c}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var rd=ol;class al{constructor(t,s=[],c,d=new Rr,m=[]){this.registry=t,this.path=s,this.key=s.map(_=>`[${_}]`).join(""),this.scope=d,this.errors=m,this.expectedType=c}parse(t,s,c,d,m={}){return s?this.concat(s,c,d)._parse(t,m):this._parse(t,m)}_parse(t,s){function c(d,m,_){return _==="assert"?new rs(m,[d]):_==="coerce"?new Oo(m,[d]):d}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const d=t[0];if(typeof d!="string")return this.error(`Expression name must be a string, but found ${typeof d} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const m=this.registry[d];if(m){let _=m.parse(t,this);if(!_)return null;if(this.expectedType){const v=this.expectedType,w=_.type;if(v.kind!=="string"&&v.kind!=="number"&&v.kind!=="boolean"&&v.kind!=="object"&&v.kind!=="array"||w.kind!=="value")if(v.kind!=="color"&&v.kind!=="formatted"&&v.kind!=="resolvedImage"||w.kind!=="value"&&w.kind!=="string"){if(this.checkSubtype(v,w))return null}else _=c(_,v,s.typeAnnotation||"coerce");else _=c(_,v,s.typeAnnotation||"assert")}if(!(_ instanceof ha)&&_.type.kind!=="resolvedImage"&&ll(_)){const v=new ed;try{_=new ha(_.type,_.evaluate(v))}catch(w){return this.error(w.message),null}}return _}return this.error(`Unknown expression "${d}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,s,c){const d=typeof t=="number"?this.path.concat(t):this.path,m=c?this.scope.concat(c):this.scope;return new al(this.registry,d,s||null,m,this.errors)}error(t,...s){const c=`${this.key}${s.map(d=>`[${d}]`).join("")}`;this.errors.push(new qi(c,t))}checkSubtype(t,s){const c=gr(t,s);return c&&this.error(c),c}}var Hc=al;function ll(r){if(r instanceof rd)return ll(r.boundExpression);if(r instanceof Dr&&r.name==="error"||r instanceof el||r instanceof ui)return!1;const t=r instanceof Oo||r instanceof rs;let s=!0;return r.eachChild(c=>{s=t?s&&ll(c):s&&c instanceof ha}),!!s&&da(r)&&sl(r,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function fa(r,t){const s=r.length-1;let c,d,m=0,_=s,v=0;for(;m<=_;)if(v=Math.floor((m+_)/2),c=r[v],d=r[v+1],c<=t){if(v===s||t<d)return v;m=v+1}else{if(!(c>t))throw new Cn("Input is not a number.");_=v-1}return 0}class js{constructor(t,s,c){this.type=t,this.input=s,this.labels=[],this.outputs=[];for(const[d,m]of c)this.labels.push(d),this.outputs.push(m)}static parse(t,s){if(t.length-1<4)return s.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return s.error("Expected an even number of arguments.");const c=s.parse(t[1],1,ot);if(!c)return null;const d=[];let m=null;s.expectedType&&s.expectedType.kind!=="value"&&(m=s.expectedType);for(let _=1;_<t.length;_+=2){const v=_===1?-1/0:t[_],w=t[_+1],T=_,S=_+1;if(typeof v!="number")return s.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(d.length&&d[d.length-1][0]>=v)return s.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',T);const C=s.parse(w,S,m);if(!C)return null;m=m||C.type,d.push([v,C])}return new js(m,c,d)}evaluate(t){const s=this.labels,c=this.outputs;if(s.length===1)return c[0].evaluate(t);const d=this.input.evaluate(t);if(d<=s[0])return c[0].evaluate(t);const m=s.length;return d>=s[m-1]?c[m-1].evaluate(t):c[fa(s,d)].evaluate(t)}eachChild(t){t(this.input);for(const s of this.outputs)t(s)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let s=0;s<this.labels.length;s++)s>0&&t.push(this.labels[s]),t.push(this.outputs[s].serialize());return t}}var Bo=js;function ai(r,t,s){return r*(1-s)+t*s}var Fo=Object.freeze({__proto__:null,number:ai,color:function(r,t,s){return new ri(ai(r.r,t.r,s),ai(r.g,t.g,s),ai(r.b,t.b,s),ai(r.a,t.a,s))},array:function(r,t,s){return r.map((c,d)=>ai(c,t[d],s))}});const Xc=.95047,sd=1.08883,od=4/29,cl=6/29,ad=3*cl*cl,ld=Math.PI/180,cd=180/Math.PI;function Yc(r){return r>.008856451679035631?Math.pow(r,1/3):r/ad+od}function ul(r){return r>cl?r*r*r:ad*(r-od)}function Kc(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function hl(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function Jc(r){const t=hl(r.r),s=hl(r.g),c=hl(r.b),d=Yc((.4124564*t+.3575761*s+.1804375*c)/Xc),m=Yc((.2126729*t+.7151522*s+.072175*c)/1);return{l:116*m-16,a:500*(d-m),b:200*(m-Yc((.0193339*t+.119192*s+.9503041*c)/sd)),alpha:r.a}}function ud(r){let t=(r.l+16)/116,s=isNaN(r.a)?t:t+r.a/500,c=isNaN(r.b)?t:t-r.b/200;return t=1*ul(t),s=Xc*ul(s),c=sd*ul(c),new ri(Kc(3.2404542*s-1.5371385*t-.4985314*c),Kc(-.969266*s+1.8760108*t+.041556*c),Kc(.0556434*s-.2040259*t+1.0572252*c),r.alpha)}function Yp(r,t,s){const c=t-r;return r+s*(c>180||c<-180?c-360*Math.round(c/360):c)}const pa={forward:Jc,reverse:ud,interpolate:function(r,t,s){return{l:ai(r.l,t.l,s),a:ai(r.a,t.a,s),b:ai(r.b,t.b,s),alpha:ai(r.alpha,t.alpha,s)}}},ma={forward:function(r){const{l:t,a:s,b:c}=Jc(r),d=Math.atan2(c,s)*cd;return{h:d<0?d+360:d,c:Math.sqrt(s*s+c*c),l:t,alpha:r.a}},reverse:function(r){const t=r.h*ld,s=r.c;return ud({l:r.l,a:Math.cos(t)*s,b:Math.sin(t)*s,alpha:r.alpha})},interpolate:function(r,t,s){return{h:Yp(r.h,t.h,s),c:ai(r.c,t.c,s),l:ai(r.l,t.l,s),alpha:ai(r.alpha,t.alpha,s)}}};var hd=Object.freeze({__proto__:null,lab:pa,hcl:ma});class dl{constructor(t,s,c,d,m){this.type=t,this.operator=s,this.interpolation=c,this.input=d,this.labels=[],this.outputs=[];for(const[_,v]of m)this.labels.push(_),this.outputs.push(v)}static interpolationFactor(t,s,c,d){let m=0;if(t.name==="exponential")m=fl(s,t.base,c,d);else if(t.name==="linear")m=fl(s,1,c,d);else if(t.name==="cubic-bezier"){const _=t.controlPoints;m=new Ce(_[0],_[1],_[2],_[3]).solve(fl(s,1,c,d))}return m}static parse(t,s){let[c,d,m,..._]=t;if(!Array.isArray(d)||d.length===0)return s.error("Expected an interpolation type expression.",1);if(d[0]==="linear")d={name:"linear"};else if(d[0]==="exponential"){const T=d[1];if(typeof T!="number")return s.error("Exponential interpolation requires a numeric base.",1,1);d={name:"exponential",base:T}}else{if(d[0]!=="cubic-bezier")return s.error(`Unknown interpolation type ${String(d[0])}`,1,0);{const T=d.slice(1);if(T.length!==4||T.some(S=>typeof S!="number"||S<0||S>1))return s.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);d={name:"cubic-bezier",controlPoints:T}}}if(t.length-1<4)return s.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return s.error("Expected an even number of arguments.");if(m=s.parse(m,2,ot),!m)return null;const v=[];let w=null;c==="interpolate-hcl"||c==="interpolate-lab"?w=Fn:s.expectedType&&s.expectedType.kind!=="value"&&(w=s.expectedType);for(let T=0;T<_.length;T+=2){const S=_[T],C=_[T+1],L=T+3,z=T+4;if(typeof S!="number")return s.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',L);if(v.length&&v[v.length-1][0]>=S)return s.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',L);const B=s.parse(C,z,w);if(!B)return null;w=w||B.type,v.push([S,B])}return w.kind==="number"||w.kind==="color"||w.kind==="array"&&w.itemType.kind==="number"&&typeof w.N=="number"?new dl(w,c,d,m,v):s.error(`Type ${Mi(w)} is not interpolatable.`)}evaluate(t){const s=this.labels,c=this.outputs;if(s.length===1)return c[0].evaluate(t);const d=this.input.evaluate(t);if(d<=s[0])return c[0].evaluate(t);const m=s.length;if(d>=s[m-1])return c[m-1].evaluate(t);const _=fa(s,d),v=dl.interpolationFactor(this.interpolation,d,s[_],s[_+1]),w=c[_].evaluate(t),T=c[_+1].evaluate(t);return this.operator==="interpolate"?Fo[this.type.kind.toLowerCase()](w,T,v):this.operator==="interpolate-hcl"?ma.reverse(ma.interpolate(ma.forward(w),ma.forward(T),v)):pa.reverse(pa.interpolate(pa.forward(w),pa.forward(T),v))}eachChild(t){t(this.input);for(const s of this.outputs)t(s)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const s=[this.operator,t,this.input.serialize()];for(let c=0;c<this.labels.length;c++)s.push(this.labels[c],this.outputs[c].serialize());return s}}function fl(r,t,s,c){const d=c-s,m=r-s;return d===0?0:t===1?m/d:(Math.pow(t,m)-1)/(Math.pow(t,d)-1)}var as=dl;class Qc{constructor(t,s){this.type=t,this.args=s}static parse(t,s){if(t.length<2)return s.error("Expectected at least one argument.");let c=null;const d=s.expectedType;d&&d.kind!=="value"&&(c=d);const m=[];for(const v of t.slice(1)){const w=s.parse(v,1+m.length,c,void 0,{typeAnnotation:"omit"});if(!w)return null;c=c||w.type,m.push(w)}const _=d&&m.some(v=>gr(d,v.type));return new Qc(_?qt:c,m)}evaluate(t){let s,c=null,d=0;for(const m of this.args){if(d++,c=m.evaluate(t),c&&c instanceof ir&&!c.available&&(s||(s=c),c=null,d===this.args.length))return s;if(c!==null)break}return c}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(s=>{t.push(s.serialize())}),t}}var dd=Qc;class eu{constructor(t,s){this.type=s.type,this.bindings=[].concat(t),this.result=s}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const s of this.bindings)t(s[1]);t(this.result)}static parse(t,s){if(t.length<4)return s.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const c=[];for(let m=1;m<t.length-1;m+=2){const _=t[m];if(typeof _!="string")return s.error(`Expected string, but found ${typeof _} instead.`,m);if(/[^a-zA-Z0-9_]/.test(_))return s.error("Variable names must contain only alphanumeric characters or '_'.",m);const v=s.parse(t[m+1],m+1);if(!v)return null;c.push([_,v])}const d=s.parse(t[t.length-1],t.length-1,s.expectedType,c);return d?new eu(c,d):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[s,c]of this.bindings)t.push(s,c.serialize());return t.push(this.result.serialize()),t}}var tu=eu;class pl{constructor(t,s,c){this.type=t,this.index=s,this.input=c}static parse(t,s){if(t.length!==3)return s.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const c=s.parse(t[1],1,ot),d=s.parse(t[2],2,In(s.expectedType||qt));return c&&d?new pl(d.type.itemType,c,d):null}evaluate(t){const s=this.index.evaluate(t),c=this.input.evaluate(t);if(s<0)throw new Cn(`Array index out of bounds: ${s} < 0.`);if(s>=c.length)throw new Cn(`Array index out of bounds: ${s} > ${c.length-1}.`);if(s!==Math.floor(s))throw new Cn(`Array index must be an integer, but found ${s} instead.`);return c[s]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var fd=pl;class iu{constructor(t,s){this.type=jt,this.needle=t,this.haystack=s}static parse(t,s){if(t.length!==3)return s.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const c=s.parse(t[1],1,qt),d=s.parse(t[2],2,qt);return c&&d?$(c.type,[jt,Vt,ot,vi,qt])?new iu(c,d):s.error(`Expected first argument to be of type boolean, string, number or null, but found ${Mi(c.type)} instead`):null}evaluate(t){const s=this.needle.evaluate(t),c=this.haystack.evaluate(t);if(c==null)return!1;if(!Q(s,["boolean","string","number","null"]))throw new Cn(`Expected first argument to be of type boolean, string, number or null, but found ${Mi(ln(s))} instead.`);if(!Q(c,["string","array"]))throw new Cn(`Expected second argument to be of type array or string, but found ${Mi(ln(c))} instead.`);return c.indexOf(s)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var Kp=iu;class ga{constructor(t,s,c){this.type=ot,this.needle=t,this.haystack=s,this.fromIndex=c}static parse(t,s){if(t.length<=2||t.length>=5)return s.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const c=s.parse(t[1],1,qt),d=s.parse(t[2],2,qt);if(!c||!d)return null;if(!$(c.type,[jt,Vt,ot,vi,qt]))return s.error(`Expected first argument to be of type boolean, string, number or null, but found ${Mi(c.type)} instead`);if(t.length===4){const m=s.parse(t[3],3,ot);return m?new ga(c,d,m):null}return new ga(c,d)}evaluate(t){const s=this.needle.evaluate(t),c=this.haystack.evaluate(t);if(!Q(s,["boolean","string","number","null"]))throw new Cn(`Expected first argument to be of type boolean, string, number or null, but found ${Mi(ln(s))} instead.`);if(!Q(c,["string","array"]))throw new Cn(`Expected second argument to be of type array or string, but found ${Mi(ln(c))} instead.`);if(this.fromIndex){const d=this.fromIndex.evaluate(t);return c.indexOf(s,d)}return c.indexOf(s)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var pd=ga;class ml{constructor(t,s,c,d,m,_){this.inputType=t,this.type=s,this.input=c,this.cases=d,this.outputs=m,this.otherwise=_}static parse(t,s){if(t.length<5)return s.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return s.error("Expected an even number of arguments.");let c,d;s.expectedType&&s.expectedType.kind!=="value"&&(d=s.expectedType);const m={},_=[];for(let T=2;T<t.length-1;T+=2){let S=t[T];const C=t[T+1];Array.isArray(S)||(S=[S]);const L=s.concat(T);if(S.length===0)return L.error("Expected at least one branch label.");for(const B of S){if(typeof B!="number"&&typeof B!="string")return L.error("Branch labels must be numbers or strings.");if(typeof B=="number"&&Math.abs(B)>Number.MAX_SAFE_INTEGER)return L.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof B=="number"&&Math.floor(B)!==B)return L.error("Numeric branch labels must be integer values.");if(c){if(L.checkSubtype(c,ln(B)))return null}else c=ln(B);if(m[String(B)]!==void 0)return L.error("Branch labels must be unique.");m[String(B)]=_.length}const z=s.parse(C,T,d);if(!z)return null;d=d||z.type,_.push(z)}const v=s.parse(t[1],1,qt);if(!v)return null;const w=s.parse(t[t.length-1],t.length-1,d);return w?v.type.kind!=="value"&&s.concat(1).checkSubtype(c,v.type)?null:new ml(c,d,v,m,_,w):null}evaluate(t){const s=this.input.evaluate(t);return(ln(s)===this.inputType&&this.outputs[this.cases[s]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],s=Object.keys(this.cases).sort(),c=[],d={};for(const _ of s){const v=d[this.cases[_]];v===void 0?(d[this.cases[_]]=c.length,c.push([this.cases[_],[_]])):c[v][1].push(_)}const m=_=>this.inputType.kind==="number"?Number(_):_;for(const[_,v]of c)t.push(v.length===1?m(v[0]):v.map(m)),t.push(this.outputs[_].serialize());return t.push(this.otherwise.serialize()),t}}var Jp=ml;class nu{constructor(t,s,c){this.type=t,this.branches=s,this.otherwise=c}static parse(t,s){if(t.length<4)return s.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return s.error("Expected an odd number of arguments.");let c;s.expectedType&&s.expectedType.kind!=="value"&&(c=s.expectedType);const d=[];for(let _=1;_<t.length-1;_+=2){const v=s.parse(t[_],_,jt);if(!v)return null;const w=s.parse(t[_+1],_+1,c);if(!w)return null;d.push([v,w]),c=c||w.type}const m=s.parse(t[t.length-1],t.length-1,c);return m?new nu(c,d,m):null}evaluate(t){for(const[s,c]of this.branches)if(s.evaluate(t))return c.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[s,c]of this.branches)t(s),t(c);t(this.otherwise)}outputDefined(){return this.branches.every(([t,s])=>s.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(s=>{t.push(s.serialize())}),t}}var Qp=nu;class gl{constructor(t,s,c,d){this.type=t,this.input=s,this.beginIndex=c,this.endIndex=d}static parse(t,s){if(t.length<=2||t.length>=5)return s.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const c=s.parse(t[1],1,qt),d=s.parse(t[2],2,ot);if(!c||!d)return null;if(!$(c.type,[In(qt),Vt,qt]))return s.error(`Expected first argument to be of type array or string, but found ${Mi(c.type)} instead`);if(t.length===4){const m=s.parse(t[3],3,ot);return m?new gl(c.type,c,d,m):null}return new gl(c.type,c,d)}evaluate(t){const s=this.input.evaluate(t),c=this.beginIndex.evaluate(t);if(!Q(s,["string","array"]))throw new Cn(`Expected first argument to be of type array or string, but found ${Mi(ln(s))} instead.`);if(this.endIndex){const d=this.endIndex.evaluate(t);return s.slice(c,d)}return s.slice(c)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var _l=gl;function ru(r,t){return r==="=="||r==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function su(r,t,s,c){return c.compare(t,s)===0}function No(r,t,s){const c=r!=="=="&&r!=="!=";return class i2{constructor(m,_,v){this.type=jt,this.lhs=m,this.rhs=_,this.collator=v,this.hasUntypedArgument=m.type.kind==="value"||_.type.kind==="value"}static parse(m,_){if(m.length!==3&&m.length!==4)return _.error("Expected two or three arguments.");const v=m[0];let w=_.parse(m[1],1,qt);if(!w)return null;if(!ru(v,w.type))return _.concat(1).error(`"${v}" comparisons are not supported for type '${Mi(w.type)}'.`);let T=_.parse(m[2],2,qt);if(!T)return null;if(!ru(v,T.type))return _.concat(2).error(`"${v}" comparisons are not supported for type '${Mi(T.type)}'.`);if(w.type.kind!==T.type.kind&&w.type.kind!=="value"&&T.type.kind!=="value")return _.error(`Cannot compare types '${Mi(w.type)}' and '${Mi(T.type)}'.`);c&&(w.type.kind==="value"&&T.type.kind!=="value"?w=new rs(T.type,[w]):w.type.kind!=="value"&&T.type.kind==="value"&&(T=new rs(w.type,[T])));let S=null;if(m.length===4){if(w.type.kind!=="string"&&T.type.kind!=="string"&&w.type.kind!=="value"&&T.type.kind!=="value")return _.error("Cannot use collator to compare non-string types.");if(S=_.parse(m[3],3,Zn),!S)return null}return new i2(w,T,S)}evaluate(m){const _=this.lhs.evaluate(m),v=this.rhs.evaluate(m);if(c&&this.hasUntypedArgument){const w=ln(_),T=ln(v);if(w.kind!==T.kind||w.kind!=="string"&&w.kind!=="number")throw new Cn(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${w.kind}, ${T.kind}) instead.`)}if(this.collator&&!c&&this.hasUntypedArgument){const w=ln(_),T=ln(v);if(w.kind!=="string"||T.kind!=="string")return t(m,_,v)}return this.collator?s(m,_,v,this.collator.evaluate(m)):t(m,_,v)}eachChild(m){m(this.lhs),m(this.rhs),this.collator&&m(this.collator)}outputDefined(){return!0}serialize(){const m=[r];return this.eachChild(_=>{m.push(_.serialize())}),m}}}const em=No("==",function(r,t,s){return t===s},su),tm=No("!=",function(r,t,s){return t!==s},function(r,t,s,c){return!su(0,t,s,c)}),md=No("<",function(r,t,s){return t<s},function(r,t,s,c){return c.compare(t,s)<0}),gd=No(">",function(r,t,s){return t>s},function(r,t,s,c){return c.compare(t,s)>0}),_d=No("<=",function(r,t,s){return t<=s},function(r,t,s,c){return c.compare(t,s)<=0}),ou=No(">=",function(r,t,s){return t>=s},function(r,t,s,c){return c.compare(t,s)>=0});class au{constructor(t,s,c,d,m,_){this.type=Vt,this.number=t,this.locale=s,this.currency=c,this.unit=d,this.minFractionDigits=m,this.maxFractionDigits=_}static parse(t,s){if(t.length!==3)return s.error("Expected two arguments.");const c=s.parse(t[1],1,ot);if(!c)return null;const d=t[2];if(typeof d!="object"||Array.isArray(d))return s.error("NumberFormat options argument must be an object.");let m=null;if(d.locale&&(m=s.parse(d.locale,1,Vt),!m))return null;let _=null;if(d.currency&&(_=s.parse(d.currency,1,Vt),!_))return null;let v=null;if(d.unit&&(v=s.parse(d.unit,1,Vt),!v))return null;let w=null;if(d["min-fraction-digits"]&&(w=s.parse(d["min-fraction-digits"],1,ot),!w))return null;let T=null;return d["max-fraction-digits"]&&(T=s.parse(d["max-fraction-digits"],1,ot),!T)?null:new au(c,m,_,v,w,T)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class lu{constructor(t){this.type=ot,this.input=t}static parse(t,s){if(t.length!==2)return s.error(`Expected 1 argument, but found ${t.length-1} instead.`);const c=s.parse(t[1],1);return c?c.type.kind!=="array"&&c.type.kind!=="string"&&c.type.kind!=="value"?s.error(`Expected argument of type string or array, but found ${Mi(c.type)} instead.`):new lu(c):null}evaluate(t){const s=this.input.evaluate(t);if(typeof s=="string"||Array.isArray(s))return s.length;throw new Cn(`Expected value to be of type string or array, but found ${Mi(ln(s))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(s=>{t.push(s.serialize())}),t}}const yd={"==":em,"!=":tm,">":gd,"<":md,">=":ou,"<=":_d,array:rs,at:fd,boolean:rs,case:Qp,coalesce:dd,collator:el,format:Us,image:Qa,in:Kp,"index-of":pd,interpolate:as,"interpolate-hcl":as,"interpolate-lab":as,length:lu,let:tu,literal:ha,match:Jp,number:rs,"number-format":au,object:rs,slice:_l,step:Bo,string:rs,"to-boolean":Oo,"to-color":Oo,"to-number":Oo,"to-string":Oo,var:rd,within:ui};function xd(r,[t,s,c,d]){t=t.evaluate(r),s=s.evaluate(r),c=c.evaluate(r);const m=d?d.evaluate(r):1,_=Qh(t,s,c,m);if(_)throw new Cn(_);return new ri(t/255*m,s/255*m,c/255*m,m)}function vd(r,t){return r in t}function cu(r,t){const s=t[r];return s===void 0?null:s}function po(r){return{type:r}}Dr.register(yd,{error:[{kind:"error"},[Vt],(r,[t])=>{throw new Cn(t.evaluate(r))}],typeof:[Vt,[qt],(r,[t])=>Mi(ln(t.evaluate(r)))],"to-rgba":[In(ot,4),[Fn],(r,[t])=>t.evaluate(r).toArray()],rgb:[Fn,[ot,ot,ot],xd],rgba:[Fn,[ot,ot,ot,ot],xd],has:{type:jt,overloads:[[[Vt],(r,[t])=>vd(t.evaluate(r),r.properties())],[[Vt,ns],(r,[t,s])=>vd(t.evaluate(r),s.evaluate(r))]]},get:{type:qt,overloads:[[[Vt],(r,[t])=>cu(t.evaluate(r),r.properties())],[[Vt,ns],(r,[t,s])=>cu(t.evaluate(r),s.evaluate(r))]]},"feature-state":[qt,[Vt],(r,[t])=>cu(t.evaluate(r),r.featureState||{})],properties:[ns,[],r=>r.properties()],"geometry-type":[Vt,[],r=>r.geometryType()],id:[qt,[],r=>r.id()],zoom:[ot,[],r=>r.globals.zoom],pitch:[ot,[],r=>r.globals.pitch||0],"distance-from-center":[ot,[],r=>r.distanceFromCenter()],"heatmap-density":[ot,[],r=>r.globals.heatmapDensity||0],"line-progress":[ot,[],r=>r.globals.lineProgress||0],"sky-radial-progress":[ot,[],r=>r.globals.skyRadialProgress||0],accumulated:[qt,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[ot,po(ot),(r,t)=>{let s=0;for(const c of t)s+=c.evaluate(r);return s}],"*":[ot,po(ot),(r,t)=>{let s=1;for(const c of t)s*=c.evaluate(r);return s}],"-":{type:ot,overloads:[[[ot,ot],(r,[t,s])=>t.evaluate(r)-s.evaluate(r)],[[ot],(r,[t])=>-t.evaluate(r)]]},"/":[ot,[ot,ot],(r,[t,s])=>t.evaluate(r)/s.evaluate(r)],"%":[ot,[ot,ot],(r,[t,s])=>t.evaluate(r)%s.evaluate(r)],ln2:[ot,[],()=>Math.LN2],pi:[ot,[],()=>Math.PI],e:[ot,[],()=>Math.E],"^":[ot,[ot,ot],(r,[t,s])=>Math.pow(t.evaluate(r),s.evaluate(r))],sqrt:[ot,[ot],(r,[t])=>Math.sqrt(t.evaluate(r))],log10:[ot,[ot],(r,[t])=>Math.log(t.evaluate(r))/Math.LN10],ln:[ot,[ot],(r,[t])=>Math.log(t.evaluate(r))],log2:[ot,[ot],(r,[t])=>Math.log(t.evaluate(r))/Math.LN2],sin:[ot,[ot],(r,[t])=>Math.sin(t.evaluate(r))],cos:[ot,[ot],(r,[t])=>Math.cos(t.evaluate(r))],tan:[ot,[ot],(r,[t])=>Math.tan(t.evaluate(r))],asin:[ot,[ot],(r,[t])=>Math.asin(t.evaluate(r))],acos:[ot,[ot],(r,[t])=>Math.acos(t.evaluate(r))],atan:[ot,[ot],(r,[t])=>Math.atan(t.evaluate(r))],min:[ot,po(ot),(r,t)=>Math.min(...t.map(s=>s.evaluate(r)))],max:[ot,po(ot),(r,t)=>Math.max(...t.map(s=>s.evaluate(r)))],abs:[ot,[ot],(r,[t])=>Math.abs(t.evaluate(r))],round:[ot,[ot],(r,[t])=>{const s=t.evaluate(r);return s<0?-Math.round(-s):Math.round(s)}],floor:[ot,[ot],(r,[t])=>Math.floor(t.evaluate(r))],ceil:[ot,[ot],(r,[t])=>Math.ceil(t.evaluate(r))],"filter-==":[jt,[Vt,qt],(r,[t,s])=>r.properties()[t.value]===s.value],"filter-id-==":[jt,[qt],(r,[t])=>r.id()===t.value],"filter-type-==":[jt,[Vt],(r,[t])=>r.geometryType()===t.value],"filter-<":[jt,[Vt,qt],(r,[t,s])=>{const c=r.properties()[t.value],d=s.value;return typeof c==typeof d&&c<d}],"filter-id-<":[jt,[qt],(r,[t])=>{const s=r.id(),c=t.value;return typeof s==typeof c&&s<c}],"filter->":[jt,[Vt,qt],(r,[t,s])=>{const c=r.properties()[t.value],d=s.value;return typeof c==typeof d&&c>d}],"filter-id->":[jt,[qt],(r,[t])=>{const s=r.id(),c=t.value;return typeof s==typeof c&&s>c}],"filter-<=":[jt,[Vt,qt],(r,[t,s])=>{const c=r.properties()[t.value],d=s.value;return typeof c==typeof d&&c<=d}],"filter-id-<=":[jt,[qt],(r,[t])=>{const s=r.id(),c=t.value;return typeof s==typeof c&&s<=c}],"filter->=":[jt,[Vt,qt],(r,[t,s])=>{const c=r.properties()[t.value],d=s.value;return typeof c==typeof d&&c>=d}],"filter-id->=":[jt,[qt],(r,[t])=>{const s=r.id(),c=t.value;return typeof s==typeof c&&s>=c}],"filter-has":[jt,[qt],(r,[t])=>t.value in r.properties()],"filter-has-id":[jt,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[jt,[In(Vt)],(r,[t])=>t.value.indexOf(r.geometryType())>=0],"filter-id-in":[jt,[In(qt)],(r,[t])=>t.value.indexOf(r.id())>=0],"filter-in-small":[jt,[Vt,In(qt)],(r,[t,s])=>s.value.indexOf(r.properties()[t.value])>=0],"filter-in-large":[jt,[Vt,In(qt)],(r,[t,s])=>function(c,d,m,_){for(;m<=_;){const v=m+_>>1;if(d[v]===c)return!0;d[v]>c?_=v-1:m=v+1}return!1}(r.properties()[t.value],s.value,0,s.value.length-1)],all:{type:jt,overloads:[[[jt,jt],(r,[t,s])=>t.evaluate(r)&&s.evaluate(r)],[po(jt),(r,t)=>{for(const s of t)if(!s.evaluate(r))return!1;return!0}]]},any:{type:jt,overloads:[[[jt,jt],(r,[t,s])=>t.evaluate(r)||s.evaluate(r)],[po(jt),(r,t)=>{for(const s of t)if(s.evaluate(r))return!0;return!1}]]},"!":[jt,[jt],(r,[t])=>!t.evaluate(r)],"is-supported-script":[jt,[Vt],(r,[t])=>{const s=r.globals&&r.globals.isSupportedScript;return!s||s(t.evaluate(r))}],upcase:[Vt,[Vt],(r,[t])=>t.evaluate(r).toUpperCase()],downcase:[Vt,[Vt],(r,[t])=>t.evaluate(r).toLowerCase()],concat:[Vt,po(qt),(r,t)=>t.map(s=>ua(s.evaluate(r))).join("")],"resolved-locale":[Vt,[Zn],(r,[t])=>t.evaluate(r).resolvedLocale()]});var Uo=yd;function uu(r){return{result:"success",value:r}}function ws(r){return{result:"error",value:r}}function Vo(r){return r["property-type"]==="data-driven"||r["property-type"]==="cross-faded-data-driven"}function bd(r){return!!r.expression&&r.expression.parameters.indexOf("zoom")>-1}function ls(r){return!!r.expression&&r.expression.interpolated}function hi(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}function Ts(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function im(r){return r}function wd(r,t){const s=t.type==="color",c=r.stops&&typeof r.stops[0][0]=="object",d=c||!(c||r.property!==void 0),m=r.type||(ls(t)?"exponential":"interval");if(s&&((r=Qt({},r)).stops&&(r.stops=r.stops.map(T=>[T[0],ri.parse(T[1])])),r.default=ri.parse(r.default?r.default:t.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!hd[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let _,v,w;if(m==="exponential")_=du;else if(m==="interval")_=hu;else if(m==="categorical"){_=nm,v=Object.create(null);for(const T of r.stops)v[T[0]]=T[1];w=typeof r.stops[0][0]}else{if(m!=="identity")throw new Error(`Unknown function type "${m}"`);_=fu}if(c){const T={},S=[];for(let z=0;z<r.stops.length;z++){const B=r.stops[z],V=B[0].zoom;T[V]===void 0&&(T[V]={zoom:V,type:r.type,property:r.property,default:r.default,stops:[]},S.push(V)),T[V].stops.push([B[0].value,B[1]])}const C=[];for(const z of S)C.push([T[z].zoom,wd(T[z],t)]);const L={name:"linear"};return{kind:"composite",interpolationType:L,interpolationFactor:as.interpolationFactor.bind(void 0,L),zoomStops:C.map(z=>z[0]),evaluate:({zoom:z},B)=>du({stops:C,base:r.base},t,z).evaluate(z,B)}}if(d){const T=m==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:T,interpolationFactor:as.interpolationFactor.bind(void 0,T),zoomStops:r.stops.map(S=>S[0]),evaluate:({zoom:S})=>_(r,t,S,v,w)}}return{kind:"source",evaluate(T,S){const C=S&&S.properties?S.properties[r.property]:void 0;return C===void 0?jo(r.default,t.default):_(r,t,C,v,w)}}}function jo(r,t,s){return r!==void 0?r:t!==void 0?t:s!==void 0?s:void 0}function nm(r,t,s,c,d){return jo(typeof s===d?c[s]:void 0,r.default,t.default)}function hu(r,t,s){if(hi(s)!=="number")return jo(r.default,t.default);const c=r.stops.length;if(c===1||s<=r.stops[0][0])return r.stops[0][1];if(s>=r.stops[c-1][0])return r.stops[c-1][1];const d=fa(r.stops.map(m=>m[0]),s);return r.stops[d][1]}function du(r,t,s){const c=r.base!==void 0?r.base:1;if(hi(s)!=="number")return jo(r.default,t.default);const d=r.stops.length;if(d===1||s<=r.stops[0][0])return r.stops[0][1];if(s>=r.stops[d-1][0])return r.stops[d-1][1];const m=fa(r.stops.map(S=>S[0]),s),_=function(S,C,L,z){const B=z-L,V=S-L;return B===0?0:C===1?V/B:(Math.pow(C,V)-1)/(Math.pow(C,B)-1)}(s,c,r.stops[m][0],r.stops[m+1][0]),v=r.stops[m][1],w=r.stops[m+1][1];let T=Fo[t.type]||im;if(r.colorSpace&&r.colorSpace!=="rgb"){const S=hd[r.colorSpace];T=(C,L)=>S.reverse(S.interpolate(S.forward(C),S.forward(L),_))}return typeof v.evaluate=="function"?{evaluate(...S){const C=v.evaluate.apply(void 0,S),L=w.evaluate.apply(void 0,S);if(C!==void 0&&L!==void 0)return T(C,L,_)}}:T(v,w,_)}function fu(r,t,s){return t.type==="color"?s=ri.parse(s):t.type==="formatted"?s=$n.fromString(s.toString()):t.type==="resolvedImage"?s=ir.fromString(s.toString()):hi(s)===t.type||t.type==="enum"&&t.values[s]||(s=void 0),jo(s,r.default,t.default)}class _a{constructor(t,s){this.expression=t,this._warningHistory={},this._evaluator=new ed,this._defaultValue=s?function(c){return c.type==="color"&&(Ts(c.default)||Array.isArray(c.default))?new ri(0,0,0,0):c.type==="color"?ri.parse(c.default)||null:c.default===void 0?null:c.default}(s):null,this._enumValues=s&&s.type==="enum"?s.values:null}evaluateWithoutErrorHandling(t,s,c,d,m,_,v,w){return this._evaluator.globals=t,this._evaluator.feature=s,this._evaluator.featureState=c,this._evaluator.canonical=d||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_,this._evaluator.featureTileCoord=v||null,this._evaluator.featureDistanceData=w||null,this.expression.evaluate(this._evaluator)}evaluate(t,s,c,d,m,_,v,w){this._evaluator.globals=t,this._evaluator.feature=s||null,this._evaluator.featureState=c||null,this._evaluator.canonical=d||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_||null,this._evaluator.featureTileCoord=v||null,this._evaluator.featureDistanceData=w||null;try{const T=this.expression.evaluate(this._evaluator);if(T==null||typeof T=="number"&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new Cn(`Expected value to be one of ${Object.keys(this._enumValues).map(S=>JSON.stringify(S)).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){return this._warningHistory[T.message]||(this._warningHistory[T.message]=!0,typeof console<"u"&&console.warn(T.message)),this._defaultValue}}}function ya(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in Uo}function mo(r,t){const s=new Hc(Uo,[],t?function(d){const m={color:Fn,string:Vt,number:ot,enum:Vt,boolean:jt,formatted:Ns,resolvedImage:bs};return d.type==="array"?In(m[d.value]||qt,d.length):m[d.type]}(t):void 0),c=s.parse(r,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return c?uu(new _a(c,t)):ws(s.errors)}class yl{constructor(t,s){this.kind=t,this._styleExpression=s,this.isStateDependent=t!=="constant"&&!rl(s.expression)}evaluateWithoutErrorHandling(t,s,c,d,m,_){return this._styleExpression.evaluateWithoutErrorHandling(t,s,c,d,m,_)}evaluate(t,s,c,d,m,_){return this._styleExpression.evaluate(t,s,c,d,m,_)}}class xl{constructor(t,s,c,d){this.kind=t,this.zoomStops=c,this._styleExpression=s,this.isStateDependent=t!=="camera"&&!rl(s.expression),this.interpolationType=d}evaluateWithoutErrorHandling(t,s,c,d,m,_){return this._styleExpression.evaluateWithoutErrorHandling(t,s,c,d,m,_)}evaluate(t,s,c,d,m,_){return this._styleExpression.evaluate(t,s,c,d,m,_)}interpolationFactor(t,s,c){return this.interpolationType?as.interpolationFactor(this.interpolationType,t,s,c):0}}function xa(r,t){if((r=mo(r,t)).result==="error")return r;const s=r.value.expression,c=da(s);if(!c&&!Vo(t))return ws([new qi("","data expressions not supported")]);const d=sl(s,["zoom","pitch","distance-from-center"]);if(!d&&!bd(t))return ws([new qi("","zoom expressions not supported")]);const m=va(s);return m||d?m instanceof qi?ws([m]):m instanceof as&&!ls(t)?ws([new qi("",'"interpolate" expressions cannot be used with this property')]):uu(m?new xl(c?"camera":"composite",r.value,m.labels,m instanceof as?m.interpolation:void 0):new yl(c?"constant":"source",r.value)):ws([new qi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Es{constructor(t,s){this._parameters=t,this._specification=s,Qt(this,wd(this._parameters,this._specification))}static deserialize(t){return new Es(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function va(r){let t=null;if(r instanceof tu)t=va(r.result);else if(r instanceof dd){for(const s of r.args)if(t=va(s),t)break}else(r instanceof Bo||r instanceof as)&&r.input instanceof Dr&&r.input.name==="zoom"&&(t=r);return t instanceof qi||r.eachChild(s=>{const c=va(s);c instanceof qi?t=c:!t&&c?t=new qi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&c&&t!==c&&(t=new qi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}class ht{constructor(t,s,c,d){this.message=(t?`${t}: `:"")+c,d&&(this.identifier=d),s!=null&&s.__line__&&(this.line=s.__line__)}}function _r(r){const t=r.key,s=r.value,c=r.valueSpec||{},d=r.objectElementValidators||{},m=r.style,_=r.styleSpec;let v=[];const w=hi(s);if(w!=="object")return[new ht(t,s,`object expected, ${w} found`)];for(const T in s){const S=T.split(".")[0],C=c[S]||c["*"];let L;d[S]?L=d[S]:c[S]?L=Nn:d["*"]?L=d["*"]:c["*"]&&(L=Nn),L?v=v.concat(L({key:(t&&`${t}.`)+T,value:s[T],valueSpec:C,style:m,styleSpec:_,object:s,objectKey:T},s)):v.push(new ht(t,s[T],`unknown property "${T}"`))}for(const T in c)d[T]||c[T].required&&c[T].default===void 0&&s[T]===void 0&&v.push(new ht(t,s,`missing required property "${T}"`));return v}function pu(r){const t=r.value,s=r.valueSpec,c=r.style,d=r.styleSpec,m=r.key,_=r.arrayElementValidator||Nn;if(hi(t)!=="array")return[new ht(m,t,`array expected, ${hi(t)} found`)];if(s.length&&t.length!==s.length)return[new ht(m,t,`array length ${s.length} expected, length ${t.length} found`)];if(s["min-length"]&&t.length<s["min-length"])return[new ht(m,t,`array length at least ${s["min-length"]} expected, length ${t.length} found`)];let v={type:s.value,values:s.values,minimum:s.minimum,maximum:s.maximum,function:void 0};d.$version<7&&(v.function=s.function),hi(s.value)==="object"&&(v=s.value);let w=[];for(let T=0;T<t.length;T++)w=w.concat(_({array:t,arrayIndex:T,value:t[T],valueSpec:v,style:c,styleSpec:d,key:`${m}[${T}]`}));return w}function Td(r){const t=r.key,s=r.value,c=r.valueSpec;let d=hi(s);if(d==="number"&&s!=s&&(d="NaN"),d!=="number")return[new ht(t,s,`number expected, ${d} found`)];if("minimum"in c){let m=c.minimum;if(hi(c.minimum)==="array"&&(m=c.minimum[r.arrayIndex]),s<m)return[new ht(t,s,`${s} is less than the minimum value ${m}`)]}if("maximum"in c){let m=c.maximum;if(hi(c.maximum)==="array"&&(m=c.maximum[r.arrayIndex]),s>m)return[new ht(t,s,`${s} is greater than the maximum value ${m}`)]}return[]}function mu(r){const t=r.valueSpec,s=$t(r.value.type);let c,d,m,_={};const v=s!=="categorical"&&r.value.property===void 0,w=!v,T=hi(r.value.stops)==="array"&&hi(r.value.stops[0])==="array"&&hi(r.value.stops[0][0])==="object",S=_r({key:r.key,value:r.value,valueSpec:r.styleSpec.function,style:r.style,styleSpec:r.styleSpec,objectElementValidators:{stops:function(z){if(s==="identity")return[new ht(z.key,z.value,'identity function may not have a "stops" property')];let B=[];const V=z.value;return B=B.concat(pu({key:z.key,value:V,valueSpec:z.valueSpec,style:z.style,styleSpec:z.styleSpec,arrayElementValidator:C})),hi(V)==="array"&&V.length===0&&B.push(new ht(z.key,V,"array must have at least one stop")),B},default:function(z){return Nn({key:z.key,value:z.value,valueSpec:t,style:z.style,styleSpec:z.styleSpec})}}});return s==="identity"&&v&&S.push(new ht(r.key,r.value,'missing required property "property"')),s==="identity"||r.value.stops||S.push(new ht(r.key,r.value,'missing required property "stops"')),s==="exponential"&&r.valueSpec.expression&&!ls(r.valueSpec)&&S.push(new ht(r.key,r.value,"exponential functions not supported")),r.styleSpec.$version>=8&&(w&&!Vo(r.valueSpec)?S.push(new ht(r.key,r.value,"property functions not supported")):v&&!bd(r.valueSpec)&&S.push(new ht(r.key,r.value,"zoom functions not supported"))),s!=="categorical"&&!T||r.value.property!==void 0||S.push(new ht(r.key,r.value,'"property" property is required')),S;function C(z){let B=[];const V=z.value,Z=z.key;if(hi(V)!=="array")return[new ht(Z,V,`array expected, ${hi(V)} found`)];if(V.length!==2)return[new ht(Z,V,`array length 2 expected, length ${V.length} found`)];if(T){if(hi(V[0])!=="object")return[new ht(Z,V,`object expected, ${hi(V[0])} found`)];if(V[0].zoom===void 0)return[new ht(Z,V,"object stop key must have zoom")];if(V[0].value===void 0)return[new ht(Z,V,"object stop key must have value")];const oe=$t(V[0].zoom);if(typeof oe!="number")return[new ht(Z,V[0].zoom,"stop zoom values must be numbers")];if(m&&m>oe)return[new ht(Z,V[0].zoom,"stop zoom values must appear in ascending order")];oe!==m&&(m=oe,d=void 0,_={}),B=B.concat(_r({key:`${Z}[0]`,value:V[0],valueSpec:{zoom:{}},style:z.style,styleSpec:z.styleSpec,objectElementValidators:{zoom:Td,value:L}}))}else B=B.concat(L({key:`${Z}[0]`,value:V[0],valueSpec:{},style:z.style,styleSpec:z.styleSpec},V));return ya(Yt(V[1]))?B.concat([new ht(`${Z}[1]`,V[1],"expressions are not allowed in function stops.")]):B.concat(Nn({key:`${Z}[1]`,value:V[1],valueSpec:t,style:z.style,styleSpec:z.styleSpec}))}function L(z,B){const V=hi(z.value),Z=$t(z.value),oe=z.value!==null?z.value:B;if(c){if(V!==c)return[new ht(z.key,oe,`${V} stop domain type must match previous stop domain type ${c}`)]}else c=V;if(V!=="number"&&V!=="string"&&V!=="boolean"&&typeof Z!="number"&&typeof Z!="string"&&typeof Z!="boolean")return[new ht(z.key,oe,"stop domain value must be a number, string, or boolean")];if(V!=="number"&&s!=="categorical"){let de=`number expected, ${V} found`;return Vo(t)&&s===void 0&&(de+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ht(z.key,oe,de)]}return s!=="categorical"||V!=="number"||typeof Z=="number"&&isFinite(Z)&&Math.floor(Z)===Z?s!=="categorical"&&V==="number"&&typeof Z=="number"&&typeof d=="number"&&d!==void 0&&Z<d?[new ht(z.key,oe,"stop domain values must appear in ascending order")]:(d=Z,s==="categorical"&&Z in _?[new ht(z.key,oe,"stop domain values must be unique")]:(_[Z]=!0,[])):[new ht(z.key,oe,`integer expected, found ${String(Z)}`)]}}function As(r){const t=(r.expressionContext==="property"?xa:mo)(Yt(r.value),r.valueSpec);if(t.result==="error")return t.value.map(c=>new ht(`${r.key}${c.key}`,r.value,c.message));const s=t.value.expression||t.value._styleExpression.expression;if(r.expressionContext==="property"&&r.propertyKey==="text-font"&&!s.outputDefined())return[new ht(r.key,r.value,`Invalid data expression for "${r.propertyKey}". Output values must be contained as literals within the expression.`)];if(r.expressionContext==="property"&&r.propertyType==="layout"&&!rl(s))return[new ht(r.key,r.value,'"feature-state" data expressions are not supported with layout properties.')];if(r.expressionContext==="filter")return Ed(s,r);if(r.expressionContext&&r.expressionContext.indexOf("cluster")===0){if(!sl(s,["zoom","feature-state"]))return[new ht(r.key,r.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(r.expressionContext==="cluster-initial"&&!da(s))return[new ht(r.key,r.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Ed(r,t){const s=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)s.delete(d);if(s.size===0)return[];const c=[];return r instanceof Dr&&s.has(r.name)?[new ht(t.key,t.value,`["${r.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(r.eachChild(d=>{c.push(...Ed(d,t))}),c)}function vl(r){const t=r.key,s=r.value,c=r.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf($t(s))===-1&&d.push(new ht(t,s,`expected one of [${c.values.join(", ")}], ${JSON.stringify(s)} found`)):Object.keys(c.values).indexOf($t(s))===-1&&d.push(new ht(t,s,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(s)} found`)),d}function gu(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const t of r.slice(1))if(!gu(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}function bl(r,t="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};gu(r)||(r=Tl(r));const s=r;let c=!0;try{c=function(T){if(!Ss(T))return T;let S=Yt(T);return ba(S),S=Ad(S),S}(s)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(s,null,2)}
        `)}const d=Me[`filter_${t}`],m=mo(c,d);let _=null;if(m.result==="error")throw new Error(m.value.map(T=>`${T.key}: ${T.message}`).join(", "));_=(T,S,C)=>m.value.evaluate(T,S,{},C);let v=null,w=null;if(c!==s){const T=mo(s,d);if(T.result==="error")throw new Error(T.value.map(S=>`${S.key}: ${S.message}`).join(", "));v=(S,C,L,z,B)=>T.value.evaluate(S,C,{},L,void 0,void 0,z,B),w=!da(T.value.expression)}return{filter:_,dynamicFilter:v||void 0,needGeometry:Sd(c),needFeature:!!w}}function Ad(r){if(!Array.isArray(r))return r;const t=function(s){if(yr.has(s[0])){for(let c=1;c<s.length;c++)if(Ss(s[c]))return!0}return s}(r);return t===!0?t:t.map(s=>Ad(s))}function ba(r){let t=!1;const s=[];if(r[0]==="case"){for(let c=1;c<r.length-1;c+=2)t=t||Ss(r[c]),s.push(r[c+1]);s.push(r[r.length-1])}else if(r[0]==="match"){t=t||Ss(r[1]);for(let c=2;c<r.length-1;c+=2)s.push(r[c+1]);s.push(r[r.length-1])}else if(r[0]==="step"){t=t||Ss(r[1]);for(let c=1;c<r.length-1;c+=2)s.push(r[c+1])}t&&(r.length=0,r.push("any",...s));for(let c=1;c<r.length;c++)ba(r[c])}function Ss(r){if(!Array.isArray(r))return!1;if((t=r[0])==="pitch"||t==="distance-from-center")return!0;var t;for(let s=1;s<r.length;s++)if(Ss(r[s]))return!0;return!1}const yr=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function wl(r,t){return r<t?-1:r>t?1:0}function Sd(r){if(!Array.isArray(r))return!1;if(r[0]==="within")return!0;for(let t=1;t<r.length;t++)if(Sd(r[t]))return!0;return!1}function Tl(r){if(!r)return!0;const t=r[0];return r.length<=1?t!=="any":t==="=="?_u(r[1],r[2],"=="):t==="!="?Al(_u(r[1],r[2],"==")):t==="<"||t===">"||t==="<="||t===">="?_u(r[1],r[2],t):t==="any"?(s=r.slice(1),["any"].concat(s.map(Tl))):t==="all"?["all"].concat(r.slice(1).map(Tl)):t==="none"?["all"].concat(r.slice(1).map(Tl).map(Al)):t==="in"?Md(r[1],r.slice(2)):t==="!in"?Al(Md(r[1],r.slice(2))):t==="has"?El(r[1]):t==="!has"?Al(El(r[1])):t!=="within"||r;var s}function _u(r,t,s){switch(r){case"$type":return[`filter-type-${s}`,t];case"$id":return[`filter-id-${s}`,t];default:return[`filter-${s}`,r,t]}}function Md(r,t){if(t.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(s=>typeof s!=typeof t[0])?["filter-in-large",r,["literal",t.sort(wl)]]:["filter-in-small",r,["literal",t]]}}function El(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function Al(r){return["!",r]}function wa(r){return gu(Yt(r.value))?As(Qt({},r,{expressionContext:"filter",valueSpec:r.styleSpec[`filter_${r.layerType||"fill"}`]})):Pd(r)}function Pd(r){const t=r.value,s=r.key;if(hi(t)!=="array")return[new ht(s,t,`array expected, ${hi(t)} found`)];const c=r.styleSpec;let d,m=[];if(t.length<1)return[new ht(s,t,"filter array must have at least 1 element")];switch(m=m.concat(vl({key:`${s}[0]`,value:t[0],valueSpec:c.filter_operator,style:r.style,styleSpec:r.styleSpec})),$t(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&$t(t[1])==="$type"&&m.push(new ht(s,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&m.push(new ht(s,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(d=hi(t[1]),d!=="string"&&m.push(new ht(`${s}[1]`,t[1],`string expected, ${d} found`)));for(let _=2;_<t.length;_++)d=hi(t[_]),$t(t[1])==="$type"?m=m.concat(vl({key:`${s}[${_}]`,value:t[_],valueSpec:c.geometry_type,style:r.style,styleSpec:r.styleSpec})):d!=="string"&&d!=="number"&&d!=="boolean"&&m.push(new ht(`${s}[${_}]`,t[_],`string, number, or boolean expected, ${d} found`));break;case"any":case"all":case"none":for(let _=1;_<t.length;_++)m=m.concat(Pd({key:`${s}[${_}]`,value:t[_],style:r.style,styleSpec:r.styleSpec}));break;case"has":case"!has":d=hi(t[1]),t.length!==2?m.push(new ht(s,t,`filter array for "${t[0]}" operator must have 2 elements`)):d!=="string"&&m.push(new ht(`${s}[1]`,t[1],`string expected, ${d} found`));break;case"within":d=hi(t[1]),t.length!==2?m.push(new ht(s,t,`filter array for "${t[0]}" operator must have 2 elements`)):d!=="object"&&m.push(new ht(`${s}[1]`,t[1],`object expected, ${d} found`))}return m}function Id(r,t){const s=r.key,c=r.style,d=r.styleSpec,m=r.value,_=r.objectKey,v=d[`${t}_${r.layerType}`];if(!v)return[];const w=_.match(/^(.*)-transition$/);if(t==="paint"&&w&&v[w[1]]&&v[w[1]].transition)return Nn({key:s,value:m,valueSpec:d.transition,style:c,styleSpec:d});const T=r.valueSpec||v[_];if(!T)return[new ht(s,m,`unknown property "${_}"`)];let S;if(hi(m)==="string"&&Vo(T)&&!T.tokens&&(S=/^{([^}]+)}$/.exec(m)))return[new ht(s,m,`"${_}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(S[1])} }\`.`)];const C=[];return r.layerType==="symbol"&&(_==="text-field"&&c&&!c.glyphs&&C.push(new ht(s,m,'use of "text-field" requires a style "glyphs" property')),_==="text-font"&&Ts(Yt(m))&&$t(m.type)==="identity"&&C.push(new ht(s,m,'"text-font" does not support identity functions'))),C.concat(Nn({key:r.key,value:m,valueSpec:T,style:c,styleSpec:d,expressionContext:"property",propertyType:t,propertyKey:_}))}function Sl(r){return Id(r,"paint")}function Cd(r){return Id(r,"layout")}function yu(r){let t=[];const s=r.value,c=r.key,d=r.style,m=r.styleSpec;s.type||s.ref||t.push(new ht(c,s,'either "type" or "ref" is required'));let _=$t(s.type);const v=$t(s.ref);if(s.id){const w=$t(s.id);for(let T=0;T<r.arrayIndex;T++){const S=d.layers[T];$t(S.id)===w&&t.push(new ht(c,s.id,`duplicate layer id "${s.id}", previously used at line ${S.id.__line__}`))}}if("ref"in s){let w;["type","source","source-layer","filter","layout"].forEach(T=>{T in s&&t.push(new ht(c,s[T],`"${T}" is prohibited for ref layers`))}),d.layers.forEach(T=>{$t(T.id)===v&&(w=T)}),w?w.ref?t.push(new ht(c,s.ref,"ref cannot reference another ref layer")):_=$t(w.type):typeof v=="string"&&t.push(new ht(c,s.ref,`ref layer "${v}" not found`))}else if(_!=="background"&&_!=="sky")if(s.source){const w=d.sources&&d.sources[s.source],T=w&&$t(w.type);w?T==="vector"&&_==="raster"?t.push(new ht(c,s.source,`layer "${s.id}" requires a raster source`)):T==="raster"&&_!=="raster"?t.push(new ht(c,s.source,`layer "${s.id}" requires a vector source`)):T!=="vector"||s["source-layer"]?T==="raster-dem"&&_!=="hillshade"?t.push(new ht(c,s.source,"raster-dem source can only be used with layer type 'hillshade'.")):_!=="line"||!s.paint||!s.paint["line-gradient"]&&!s.paint["line-trim-offset"]||T==="geojson"&&w.lineMetrics||t.push(new ht(c,s,`layer "${s.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new ht(c,s,`layer "${s.id}" must specify a "source-layer"`)):t.push(new ht(c,s.source,`source "${s.source}" not found`))}else t.push(new ht(c,s,'missing required property "source"'));return t=t.concat(_r({key:c,value:s,valueSpec:m.layer,style:r.style,styleSpec:r.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Nn({key:`${c}.type`,value:s.type,valueSpec:m.layer.type,style:r.style,styleSpec:r.styleSpec,object:s,objectKey:"type"}),filter:w=>wa(Qt({layerType:_},w)),layout:w=>_r({layer:s,key:w.key,value:w.value,valueSpec:{},style:w.style,styleSpec:w.styleSpec,objectElementValidators:{"*":T=>Cd(Qt({layerType:_},T))}}),paint:w=>_r({layer:s,key:w.key,value:w.value,valueSpec:{},style:w.style,styleSpec:w.styleSpec,objectElementValidators:{"*":T=>Sl(Qt({layerType:_},T))}})}})),t}function go(r){const t=r.value,s=r.key,c=hi(t);return c!=="string"?[new ht(s,t,`string expected, ${c} found`)]:[]}const Ld={promoteId:function({key:r,value:t}){if(hi(t)==="string")return go({key:r,value:t});{const s=[];for(const c in t)s.push(...go({key:`${r}.${c}`,value:t[c]}));return s}}};function Ml(r){const t=r.value,s=r.key,c=r.styleSpec,d=r.style;if(!t.type)return[new ht(s,t,'"type" is required')];const m=$t(t.type);let _;switch(m){case"vector":case"raster":case"raster-dem":return _=_r({key:s,value:t,valueSpec:c[`source_${m.replace("-","_")}`],style:r.style,styleSpec:c,objectElementValidators:Ld}),_;case"geojson":if(_=_r({key:s,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:Ld}),t.cluster)for(const v in t.clusterProperties){const[w,T]=t.clusterProperties[v],S=typeof w=="string"?[w,["accumulated"],["get",v]]:w;_.push(...As({key:`${s}.${v}.map`,value:T,expressionContext:"cluster-map"})),_.push(...As({key:`${s}.${v}.reduce`,value:S,expressionContext:"cluster-reduce"}))}return _;case"video":return _r({key:s,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return _r({key:s,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new ht(s,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return vl({key:`${s}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:d,styleSpec:c})}}function Ta(r){const t=r.value,s=r.styleSpec,c=s.light,d=r.style;let m=[];const _=hi(t);if(t===void 0)return m;if(_!=="object")return m=m.concat([new ht("light",t,`object expected, ${_} found`)]),m;for(const v in t){const w=v.match(/^(.*)-transition$/);m=m.concat(w&&c[w[1]]&&c[w[1]].transition?Nn({key:v,value:t[v],valueSpec:s.transition,style:d,styleSpec:s}):c[v]?Nn({key:v,value:t[v],valueSpec:c[v],style:d,styleSpec:s}):[new ht(v,t[v],`unknown property "${v}"`)])}return m}function xu(r){const t=r.value,s=r.key,c=r.style,d=r.styleSpec,m=d.terrain;let _=[];const v=hi(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new ht("terrain",t,`object expected, ${v} found`)]),_;for(const w in t){const T=w.match(/^(.*)-transition$/);_=_.concat(T&&m[T[1]]&&m[T[1]].transition?Nn({key:w,value:t[w],valueSpec:d.transition,style:c,styleSpec:d}):m[w]?Nn({key:w,value:t[w],valueSpec:m[w],style:c,styleSpec:d}):[new ht(w,t[w],`unknown property "${w}"`)])}if(t.source){const w=c.sources&&c.sources[t.source],T=w&&$t(w.type);w?T!=="raster-dem"&&_.push(new ht(s,t.source,`terrain cannot be used with a source of type ${String(T)}, it only be used with a "raster-dem" source type`)):_.push(new ht(s,t.source,`source "${t.source}" not found`))}else _.push(new ht(s,t,'terrain is missing required property "source"'));return _}function kd(r){const t=r.value,s=r.style,c=r.styleSpec,d=c.fog;let m=[];const _=hi(t);if(t===void 0)return m;if(_!=="object")return m=m.concat([new ht("fog",t,`object expected, ${_} found`)]),m;for(const v in t){const w=v.match(/^(.*)-transition$/);m=m.concat(w&&d[w[1]]&&d[w[1]].transition?Nn({key:v,value:t[v],valueSpec:c.transition,style:s,styleSpec:c}):d[v]?Nn({key:v,value:t[v],valueSpec:d[v],style:s,styleSpec:c}):[new ht(v,t[v],`unknown property "${v}"`)])}return m}const vu={"*":()=>[],array:pu,boolean:function(r){const t=r.value,s=r.key,c=hi(t);return c!=="boolean"?[new ht(s,t,`boolean expected, ${c} found`)]:[]},number:Td,color:function(r){const t=r.key,s=r.value,c=hi(s);return c!=="string"?[new ht(t,s,`color expected, ${c} found`)]:_e(s)===null?[new ht(t,s,`color expected, "${s}" found`)]:[]},enum:vl,filter:wa,function:mu,layer:yu,object:_r,source:Ml,light:Ta,terrain:xu,fog:kd,string:go,formatted:function(r){return go(r).length===0?[]:As(r)},resolvedImage:function(r){return go(r).length===0?[]:As(r)},projection:function(r){const t=r.value,s=r.styleSpec,c=s.projection,d=r.style;let m=[];const _=hi(t);if(_==="object")for(const v in t)m=m.concat(Nn({key:v,value:t[v],valueSpec:c[v],style:d,styleSpec:s}));else _!=="string"&&(m=m.concat([new ht("projection",t,`object or string expected, ${_} found`)]));return m}};function Nn(r){const t=r.value,s=r.valueSpec,c=r.styleSpec;return s.expression&&Ts($t(t))?mu(r):s.expression&&ya(Yt(t))?As(r):s.type&&vu[s.type]?vu[s.type](r):_r(Qt({},r,{valueSpec:s.type?c[s.type]:s}))}function bu(r){const t=r.value,s=r.key,c=go(r);return c.length||(t.indexOf("{fontstack}")===-1&&c.push(new ht(s,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&c.push(new ht(s,t,'"glyphs" url must include a "{range}" token'))),c}function Rd(r,t=Me){return Ms(Nn({key:"",value:r,valueSpec:t.$root,styleSpec:t,style:r,objectElementValidators:{glyphs:bu,"*":()=>[]}}))}const rm=r=>Ms(Sl(r)),sm=r=>Ms(Cd(r));function Ms(r){return r.slice().sort((t,s)=>t.line&&s.line?t.line-s.line:0)}function wu(r,t){let s=!1;if(t&&t.length)for(const c of t)r.fire(new pt(new Error(c.message))),s=!0;return s}var Go=cs;function cs(r,t,s){var c=this.cells=[];if(r instanceof ArrayBuffer){this.arrayBuffer=r;var d=new Int32Array(this.arrayBuffer);r=d[0],this.d=(t=d[1])+2*(s=d[2]);for(var m=0;m<this.d*this.d;m++){var _=d[3+m],v=d[3+m+1];c.push(_===v?null:d.subarray(_,v))}var w=d[3+c.length+1];this.keys=d.subarray(d[3+c.length],w),this.bboxes=d.subarray(w),this.insert=this._insertReadonly}else{this.d=t+2*s;for(var T=0;T<this.d*this.d;T++)c.push([]);this.keys=[],this.bboxes=[]}this.n=t,this.extent=r,this.padding=s,this.scale=t/r,this.uid=0;var S=s/t*r;this.min=-S,this.max=r+S}cs.prototype.insert=function(r,t,s,c,d){this._forEachCell(t,s,c,d,this._insertCell,this.uid++),this.keys.push(r),this.bboxes.push(t),this.bboxes.push(s),this.bboxes.push(c),this.bboxes.push(d)},cs.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},cs.prototype._insertCell=function(r,t,s,c,d,m){this.cells[d].push(m)},cs.prototype.query=function(r,t,s,c,d){var m=this.min,_=this.max;if(r<=m&&t<=m&&_<=s&&_<=c&&!d)return Array.prototype.slice.call(this.keys);var v=[];return this._forEachCell(r,t,s,c,this._queryCell,v,{},d),v},cs.prototype._queryCell=function(r,t,s,c,d,m,_,v){var w=this.cells[d];if(w!==null)for(var T=this.keys,S=this.bboxes,C=0;C<w.length;C++){var L=w[C];if(_[L]===void 0){var z=4*L;(v?v(S[z+0],S[z+1],S[z+2],S[z+3]):r<=S[z+2]&&t<=S[z+3]&&s>=S[z+0]&&c>=S[z+1])?(_[L]=!0,m.push(T[L])):_[L]=!1}}},cs.prototype._forEachCell=function(r,t,s,c,d,m,_,v){for(var w=this._convertToCellCoord(r),T=this._convertToCellCoord(t),S=this._convertToCellCoord(s),C=this._convertToCellCoord(c),L=w;L<=S;L++)for(var z=T;z<=C;z++){var B=this.d*z+L;if((!v||v(this._convertFromCellCoord(L),this._convertFromCellCoord(z),this._convertFromCellCoord(L+1),this._convertFromCellCoord(z+1)))&&d.call(this,r,t,s,c,B,m,_,v))return}},cs.prototype._convertFromCellCoord=function(r){return(r-this.padding)/this.scale},cs.prototype._convertToCellCoord=function(r){return Math.max(0,Math.min(this.d-1,Math.floor(r*this.scale)+this.padding))},cs.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var r=this.cells,t=3+this.cells.length+1+1,s=0,c=0;c<this.cells.length;c++)s+=this.cells[c].length;var d=new Int32Array(t+s+this.keys.length+this.bboxes.length);d[0]=this.extent,d[1]=this.n,d[2]=this.padding;for(var m=t,_=0;_<r.length;_++){var v=r[_];d[3+_]=m,d.set(v,m),m+=v.length}return d[3+r.length]=m,d.set(this.keys,m),d[3+r.length+1]=m+=this.keys.length,d.set(this.bboxes,m),m+=this.bboxes.length,d.buffer};const Pl={};function ft(r,t,s={}){Object.defineProperty(r,"_classRegistryKey",{value:t,writeable:!1}),Pl[t]={klass:r,omit:s.omit||[]}}ft(Object,"Object"),Go.serialize=function(r,t){const s=r.toArrayBuffer();return t&&t.push(s),{buffer:s}},Go.deserialize=function(r){return new Go(r.buffer)},Object.defineProperty(Go,"name",{value:"Grid"}),ft(Go,"Grid"),ft(ri,"Color"),ft(Error,"Error"),ft(Mn,"AJAXError"),ft(ir,"ResolvedImage"),ft(Es,"StylePropertyFunction"),ft(_a,"StyleExpression",{omit:["_evaluator"]}),ft(xl,"ZoomDependentExpression"),ft(yl,"ZoomConstantExpression"),ft(Dr,"CompoundExpression",{omit:["_evaluate"]});for(const r in Uo)Pl[Uo[r]._classRegistryKey]||ft(Uo[r],`Expression${r}`);function Dd(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function zd(r){return E.ImageBitmap&&r instanceof E.ImageBitmap}function Ea(r,t){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(Dd(r)||zd(r))return t&&t.push(r),r;if(ArrayBuffer.isView(r)){const s=r;return t&&t.push(s.buffer),s}if(r instanceof E.ImageData)return t&&t.push(r.data.buffer),r;if(Array.isArray(r)){const s=[];for(const c of r)s.push(Ea(c,t));return s}if(typeof r=="object"){const s=r.constructor,c=s._classRegistryKey;if(!c)throw new Error(`can't serialize object of unregistered class ${c}`);const d=s.serialize?s.serialize(r,t):{};if(!s.serialize){for(const m in r)r.hasOwnProperty(m)&&(Pl[c].omit.indexOf(m)>=0||(d[m]=Ea(r[m],t)));r instanceof Error&&(d.message=r.message)}if(d.$name)throw new Error("$name property is reserved for worker serialization logic.");return c!=="Object"&&(d.$name=c),d}throw new Error("can't serialize object of type "+typeof r)}function Gs(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||Dd(r)||zd(r)||ArrayBuffer.isView(r)||r instanceof E.ImageData)return r;if(Array.isArray(r))return r.map(Gs);if(typeof r=="object"){const t=r.$name||"Object",{klass:s}=Pl[t];if(!s)throw new Error(`can't deserialize unregistered class ${t}`);if(s.deserialize)return s.deserialize(r);const c=Object.create(s.prototype);for(const d of Object.keys(r))d!=="$name"&&(c[d]=Gs(r[d]));return c}throw new Error("can't deserialize object of type "+typeof r)}class Od{constructor(){this.first=!0}update(t,s){const c=Math.floor(t);return this.first?(this.first=!1,this.lastIntegerZoom=c,this.lastIntegerZoomTime=0,this.lastZoom=t,this.lastFloorZoom=c,!0):(this.lastFloorZoom>c?(this.lastIntegerZoom=c+1,this.lastIntegerZoomTime=s):this.lastFloorZoom<c&&(this.lastIntegerZoom=c,this.lastIntegerZoomTime=s),t!==this.lastZoom&&(this.lastZoom=t,this.lastFloorZoom=c,!0))}}const Bd=r=>r>=1536&&r<=1791,Aa=r=>r>=1872&&r<=1919,Fd=r=>r>=2208&&r<=2303,Tu=r=>r>=11904&&r<=12031,Nd=r=>r>=12032&&r<=12255,Eu=r=>r>=12272&&r<=12287,Sa=r=>r>=12288&&r<=12351,Il=r=>r>=12352&&r<=12447,Ma=r=>r>=12448&&r<=12543,Cl=r=>r>=12544&&r<=12591,Ll=r=>r>=12704&&r<=12735,Ud=r=>r>=12736&&r<=12783,Vd=r=>r>=12784&&r<=12799,Au=r=>r>=12800&&r<=13055,jd=r=>r>=13056&&r<=13311,Gd=r=>r>=13312&&r<=19903,Su=r=>r>=19968&&r<=40959,kl=r=>r>=40960&&r<=42127,Wd=r=>r>=42128&&r<=42191,Zd=r=>r>=44032&&r<=55215,$d=r=>r>=63744&&r<=64255,Mu=r=>r>=64336&&r<=65023,qd=r=>r>=65040&&r<=65055,Rl=r=>r>=65072&&r<=65103,Pa=r=>r>=65104&&r<=65135,p=r=>r>=65136&&r<=65279,o=r=>r>=65280&&r<=65519;function h(r){for(const t of r)if(b(t.charCodeAt(0)))return!0;return!1}function g(r){for(const t of r)if(!x(t.charCodeAt(0)))return!1;return!0}function x(r){return!(Bd(r)||Aa(r)||Fd(r)||Mu(r)||p(r))}function b(r){return!(r!==746&&r!==747&&(r<4352||!(Ll(r)||Cl(r)||Rl(r)&&!(r>=65097&&r<=65103)||$d(r)||jd(r)||Tu(r)||Ud(r)||!(!Sa(r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Gd(r)||Su(r)||Au(r)||(t=>t>=12592&&t<=12687)(r)||(t=>t>=43360&&t<=43391)(r)||(t=>t>=55216&&t<=55295)(r)||(t=>t>=4352&&t<=4607)(r)||Zd(r)||Il(r)||Eu(r)||(t=>t>=12688&&t<=12703)(r)||Nd(r)||Vd(r)||Ma(r)&&r!==12540||!(!o(r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Pa(r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||(t=>t>=5120&&t<=5759)(r)||(t=>t>=6320&&t<=6399)(r)||qd(r)||(t=>t>=19904&&t<=19967)(r)||kl(r)||Wd(r))))}function A(r){return!(b(r)||function(t){return!!((s=>s>=128&&s<=255)(t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||(s=>s>=8192&&s<=8303)(t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||(s=>s>=8448&&s<=8527)(t)||(s=>s>=8528&&s<=8591)(t)||(s=>s>=8960&&s<=9215)(t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||(s=>s>=9216&&s<=9279)(t)&&t!==9251||(s=>s>=9280&&s<=9311)(t)||(s=>s>=9312&&s<=9471)(t)||(s=>s>=9632&&s<=9727)(t)||(s=>s>=9728&&s<=9983)(t)&&!(t>=9754&&t<=9759)||(s=>s>=11008&&s<=11263)(t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Sa(t)||Ma(t)||(s=>s>=57344&&s<=63743)(t)||Rl(t)||Pa(t)||o(t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(r))}function M(r){return r>=1424&&r<=2303||Mu(r)||p(r)}function P(r,t){return!(!t&&M(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||(s=>s>=6016&&s<=6143)(r))}function k(r){for(const t of r)if(M(t.charCodeAt(0)))return!0;return!1}const D="deferred",U="loading",W="loaded";let J=null,X="unavailable",ee=null;const Y=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(X="error"),J&&J(r)};function q(){ie.fire(new Xe("pluginStateChange",{pluginStatus:X,pluginURL:ee}))}const ie=new It,K=function(){return X},he=function(){if(X!==D||!ee)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");X=U,q(),ee&&an({url:ee},r=>{r?Y(r):(X=W,q())})},fe={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>X===W||fe.applyArabicShaping!=null,isLoading:()=>X===U,setState(r){X=r.pluginStatus,ee=r.pluginURL},isParsed:()=>fe.applyArabicShaping!=null&&fe.processBidirectionalText!=null&&fe.processStyledBidirectionalText!=null,getPluginURL:()=>ee};class le{constructor(t,s){this.zoom=t,s?(this.now=s.now,this.fadeDuration=s.fadeDuration,this.zoomHistory=s.zoomHistory,this.transition=s.transition,this.pitch=s.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Od,this.transition={},this.pitch=0)}isSupportedScript(t){return function(s,c){for(const d of s)if(!P(d.charCodeAt(0),c))return!1;return!0}(t,fe.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const t=this.zoom,s=t-Math.floor(t),c=this.crossFadingFactor();return t>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:s+(1-s)*c}:{fromScale:.5,toScale:1,t:1-(1-c)*s}}}class me{constructor(t,s){this.property=t,this.value=s,this.expression=function(c,d){if(Ts(c))return new Es(c,d);if(ya(c)){const m=xa(c,d);if(m.result==="error")throw new Error(m.value.map(_=>`${_.key}: ${_.message}`).join(", "));return m.value}{let m=c;return typeof c=="string"&&d.type==="color"&&(m=ri.parse(c)),{kind:"constant",evaluate:()=>m}}}(s===void 0?t.specification.default:s,t.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,s,c){return this.property.possiblyEvaluate(this,t,s,c)}}class Pe{constructor(t){this.property=t,this.value=new me(t,void 0)}transitioned(t,s){return new ke(this.property,this.value,s,ni({},t.transition,this.transition),t.now)}untransitioned(){return new ke(this.property,this.value,null,{},0)}}class ze{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues)}getValue(t){return yi(this._values[t].value.value)}setValue(t,s){this._values.hasOwnProperty(t)||(this._values[t]=new Pe(this._values[t].property)),this._values[t].value=new me(this._values[t].property,s===null?void 0:yi(s))}getTransition(t){return yi(this._values[t].transition)}setTransition(t,s){this._values.hasOwnProperty(t)||(this._values[t]=new Pe(this._values[t].property)),this._values[t].transition=yi(s)||void 0}serialize(){const t={};for(const s of Object.keys(this._values)){const c=this.getValue(s);c!==void 0&&(t[s]=c);const d=this.getTransition(s);d!==void 0&&(t[`${s}-transition`]=d)}return t}transitioned(t,s){const c=new Ke(this._properties);for(const d of Object.keys(this._values))c._values[d]=this._values[d].transitioned(t,s._values[d]);return c}untransitioned(){const t=new Ke(this._properties);for(const s of Object.keys(this._values))t._values[s]=this._values[s].untransitioned();return t}}class ke{constructor(t,s,c,d,m){const _=d.delay||0,v=d.duration||0;m=m||0,this.property=t,this.value=s,this.begin=m+_,this.end=this.begin+v,t.specification.transition&&(d.delay||d.duration)&&(this.prior=c)}possiblyEvaluate(t,s,c){const d=t.now||0,m=this.value.possiblyEvaluate(t,s,c),_=this.prior;if(_){if(d>this.end)return this.prior=null,m;if(this.value.isDataDriven())return this.prior=null,m;if(d<this.begin)return _.possiblyEvaluate(t,s,c);{const v=(d-this.begin)/(this.end-this.begin);return this.property.interpolate(_.possiblyEvaluate(t,s,c),m,si(v))}}return m}}class Ke{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,s,c){const d=new je(this._properties);for(const m of Object.keys(this._values))d._values[m]=this._values[m].possiblyEvaluate(t,s,c);return d}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class we{constructor(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues)}getValue(t){return yi(this._values[t].value)}setValue(t,s){this._values[t]=new me(this._values[t].property,s===null?void 0:yi(s))}serialize(){const t={};for(const s of Object.keys(this._values)){const c=this.getValue(s);c!==void 0&&(t[s]=c)}return t}possiblyEvaluate(t,s,c){const d=new je(this._properties);for(const m of Object.keys(this._values))d._values[m]=this._values[m].possiblyEvaluate(t,s,c);return d}}class $e{constructor(t,s,c){this.property=t,this.value=s,this.parameters=c}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,s,c,d){return this.property.evaluate(this.value,this.parameters,t,s,c,d)}}class je{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class Ie{constructor(t){this.specification=t}possiblyEvaluate(t,s){return t.expression.evaluate(s)}interpolate(t,s,c){const d=Fo[this.specification.type];return d?d(t,s,c):t}}class ve{constructor(t,s){this.specification=t,this.overrides=s}possiblyEvaluate(t,s,c,d){return new $e(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(s,null,{},c,d)}:t.expression,s)}interpolate(t,s,c){if(t.value.kind!=="constant"||s.value.kind!=="constant")return t;if(t.value.value===void 0||s.value.value===void 0)return new $e(this,{kind:"constant",value:void 0},t.parameters);const d=Fo[this.specification.type];return d?new $e(this,{kind:"constant",value:d(t.value.value,s.value.value,c)},t.parameters):t}evaluate(t,s,c,d,m,_){return t.kind==="constant"?t.value:t.evaluate(s,c,d,m,_)}}class lt extends ve{possiblyEvaluate(t,s,c,d){if(t.value===void 0)return new $e(this,{kind:"constant",value:void 0},s);if(t.expression.kind==="constant"){const m=t.expression.evaluate(s,null,{},c,d),_=t.property.specification.type==="resolvedImage"&&typeof m!="string"?m.name:m,v=this._calculate(_,_,_,s);return new $e(this,{kind:"constant",value:v},s)}if(t.expression.kind==="camera"){const m=this._calculate(t.expression.evaluate({zoom:s.zoom-1}),t.expression.evaluate({zoom:s.zoom}),t.expression.evaluate({zoom:s.zoom+1}),s);return new $e(this,{kind:"constant",value:m},s)}return new $e(this,t.expression,s)}evaluate(t,s,c,d,m,_){if(t.kind==="source"){const v=t.evaluate(s,c,d,m,_);return this._calculate(v,v,v,s)}return t.kind==="composite"?this._calculate(t.evaluate({zoom:Math.floor(s.zoom)-1},c,d),t.evaluate({zoom:Math.floor(s.zoom)},c,d),t.evaluate({zoom:Math.floor(s.zoom)+1},c,d),s):t.value}_calculate(t,s,c,d){return d.zoom>d.zoomHistory.lastIntegerZoom?{from:t,to:s,other:c}:{from:c,to:s,other:t}}interpolate(t){return t}}class tt{constructor(t){this.specification=t}possiblyEvaluate(t,s,c,d){if(t.value!==void 0){if(t.expression.kind==="constant"){const m=t.expression.evaluate(s,null,{},c,d);return this._calculate(m,m,m,s)}return this._calculate(t.expression.evaluate(new le(Math.floor(s.zoom-1),s)),t.expression.evaluate(new le(Math.floor(s.zoom),s)),t.expression.evaluate(new le(Math.floor(s.zoom+1),s)),s)}}_calculate(t,s,c,d){return d.zoom>d.zoomHistory.lastIntegerZoom?{from:t,to:s}:{from:c,to:s}}interpolate(t){return t}}class at{constructor(t){this.specification=t}possiblyEvaluate(t,s,c,d){return!!t.expression.evaluate(s,null,{},c,d)}interpolate(){return!1}}class nt{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const s=new le(0,{});for(const c in t){const d=t[c];d.specification.overridable&&this.overridableProperties.push(c);const m=this.defaultPropertyValues[c]=new me(d,void 0),_=this.defaultTransitionablePropertyValues[c]=new Pe(d);this.defaultTransitioningPropertyValues[c]=_.untransitioned(),this.defaultPossiblyEvaluatedValues[c]=m.possiblyEvaluate(s)}}}function vt(r,t){return 256*(r=Lt(Math.floor(r),0,255))+Lt(Math.floor(t),0,255)}ft(ve,"DataDrivenProperty"),ft(Ie,"DataConstantProperty"),ft(lt,"CrossFadedDataDrivenProperty"),ft(tt,"CrossFadedProperty"),ft(at,"ColorRampProperty");const Rt={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ct{constructor(t,s){this._structArray=t,this._pos1=s*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Et{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,s){return t._trim(),s&&(t.isTransferred=!0,s.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const s=Object.create(this.prototype);return s.arrayBuffer=t.arrayBuffer,s.length=t.length,s.capacity=t.arrayBuffer.byteLength/s.bytesPerElement,s._refreshViews(),s}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const s=this.uint8;this._refreshViews(),s&&this.uint8.set(s)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function rt(r,t=1){let s=0,c=0;return{members:r.map(d=>{const m=Rt[d.type].BYTES_PER_ELEMENT,_=s=Ft(s,Math.max(t,m)),v=d.components||1;return c=Math.max(c,m),s+=m*v,{name:d.name,type:d.type,components:v,offset:_}}),size:Ft(s,Math.max(c,t)),alignment:t}}function Ft(r,t){return Math.ceil(r/t)*t}class Ht extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,s){const c=this.length;return this.resize(c+1),this.emplace(c,t,s)}emplace(t,s,c){const d=2*t;return this.int16[d+0]=s,this.int16[d+1]=c,t}}Ht.prototype.bytesPerElement=4,ft(Ht,"StructArrayLayout2i4");class bi extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,s,c){const d=this.length;return this.resize(d+1),this.emplace(d,t,s,c)}emplace(t,s,c,d){const m=3*t;return this.int16[m+0]=s,this.int16[m+1]=c,this.int16[m+2]=d,t}}bi.prototype.bytesPerElement=6,ft(bi,"StructArrayLayout3i6");class wi extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,s,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,t,s,c,d)}emplace(t,s,c,d,m){const _=4*t;return this.int16[_+0]=s,this.int16[_+1]=c,this.int16[_+2]=d,this.int16[_+3]=m,t}}wi.prototype.bytesPerElement=8,ft(wi,"StructArrayLayout4i8");class _i extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v){const w=this.length;return this.resize(w+1),this.emplace(w,t,s,c,d,m,_,v)}emplace(t,s,c,d,m,_,v,w){const T=6*t,S=12*t,C=3*t;return this.int16[T+0]=s,this.int16[T+1]=c,this.uint8[S+4]=d,this.uint8[S+5]=m,this.uint8[S+6]=_,this.uint8[S+7]=v,this.float32[C+2]=w,t}}_i.prototype.bytesPerElement=12,ft(_i,"StructArrayLayout2i4ub1f12");class xn extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,s,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,t,s,c,d)}emplace(t,s,c,d,m){const _=4*t;return this.float32[_+0]=s,this.float32[_+1]=c,this.float32[_+2]=d,this.float32[_+3]=m,t}}xn.prototype.bytesPerElement=16,ft(xn,"StructArrayLayout4f16");class qn extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v,w,T,S){const C=this.length;return this.resize(C+1),this.emplace(C,t,s,c,d,m,_,v,w,T,S)}emplace(t,s,c,d,m,_,v,w,T,S,C){const L=10*t;return this.uint16[L+0]=s,this.uint16[L+1]=c,this.uint16[L+2]=d,this.uint16[L+3]=m,this.uint16[L+4]=_,this.uint16[L+5]=v,this.uint16[L+6]=w,this.uint16[L+7]=T,this.uint16[L+8]=S,this.uint16[L+9]=C,t}}qn.prototype.bytesPerElement=20,ft(qn,"StructArrayLayout10ui20");class us extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v,w){const T=this.length;return this.resize(T+1),this.emplace(T,t,s,c,d,m,_,v,w)}emplace(t,s,c,d,m,_,v,w,T){const S=8*t;return this.uint16[S+0]=s,this.uint16[S+1]=c,this.uint16[S+2]=d,this.uint16[S+3]=m,this.uint16[S+4]=_,this.uint16[S+5]=v,this.uint16[S+6]=w,this.uint16[S+7]=T,t}}us.prototype.bytesPerElement=16,ft(us,"StructArrayLayout8ui16");class ki extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_){const v=this.length;return this.resize(v+1),this.emplace(v,t,s,c,d,m,_)}emplace(t,s,c,d,m,_,v){const w=6*t;return this.int16[w+0]=s,this.int16[w+1]=c,this.int16[w+2]=d,this.int16[w+3]=m,this.int16[w+4]=_,this.int16[w+5]=v,t}}ki.prototype.bytesPerElement=12,ft(ki,"StructArrayLayout6i12");class Vi extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v,w,T,S,C,L){const z=this.length;return this.resize(z+1),this.emplace(z,t,s,c,d,m,_,v,w,T,S,C,L)}emplace(t,s,c,d,m,_,v,w,T,S,C,L,z){const B=12*t;return this.int16[B+0]=s,this.int16[B+1]=c,this.int16[B+2]=d,this.int16[B+3]=m,this.uint16[B+4]=_,this.uint16[B+5]=v,this.uint16[B+6]=w,this.uint16[B+7]=T,this.int16[B+8]=S,this.int16[B+9]=C,this.int16[B+10]=L,this.int16[B+11]=z,t}}Vi.prototype.bytesPerElement=24,ft(Vi,"StructArrayLayout4i4ui4i24");class mi extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_){const v=this.length;return this.resize(v+1),this.emplace(v,t,s,c,d,m,_)}emplace(t,s,c,d,m,_,v){const w=10*t,T=5*t;return this.int16[w+0]=s,this.int16[w+1]=c,this.int16[w+2]=d,this.float32[T+2]=m,this.float32[T+3]=_,this.float32[T+4]=v,t}}mi.prototype.bytesPerElement=20,ft(mi,"StructArrayLayout3i3f20");class nn extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const s=this.length;return this.resize(s+1),this.emplace(s,t)}emplace(t,s){return this.uint32[1*t+0]=s,t}}nn.prototype.bytesPerElement=4,ft(nn,"StructArrayLayout1ul4");class Un extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v,w,T,S,C,L,z){const B=this.length;return this.resize(B+1),this.emplace(B,t,s,c,d,m,_,v,w,T,S,C,L,z)}emplace(t,s,c,d,m,_,v,w,T,S,C,L,z,B){const V=20*t,Z=10*t;return this.int16[V+0]=s,this.int16[V+1]=c,this.int16[V+2]=d,this.int16[V+3]=m,this.int16[V+4]=_,this.float32[Z+3]=v,this.float32[Z+4]=w,this.float32[Z+5]=T,this.float32[Z+6]=S,this.int16[V+14]=C,this.uint32[Z+8]=L,this.uint16[V+18]=z,this.uint16[V+19]=B,t}}Un.prototype.bytesPerElement=40,ft(Un,"StructArrayLayout5i4f1i1ul2ui40");class Ii extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v){const w=this.length;return this.resize(w+1),this.emplace(w,t,s,c,d,m,_,v)}emplace(t,s,c,d,m,_,v,w){const T=8*t;return this.int16[T+0]=s,this.int16[T+1]=c,this.int16[T+2]=d,this.int16[T+4]=m,this.int16[T+5]=_,this.int16[T+6]=v,this.int16[T+7]=w,t}}Ii.prototype.bytesPerElement=16,ft(Ii,"StructArrayLayout3i2i2i16");class nr extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,s,c,d,m)}emplace(t,s,c,d,m,_){const v=4*t,w=8*t;return this.float32[v+0]=s,this.float32[v+1]=c,this.float32[v+2]=d,this.int16[w+6]=m,this.int16[w+7]=_,t}}nr.prototype.bytesPerElement=16,ft(nr,"StructArrayLayout2f1f2i16");class _o extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,s,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,t,s,c,d)}emplace(t,s,c,d,m){const _=12*t,v=3*t;return this.uint8[_+0]=s,this.uint8[_+1]=c,this.float32[v+1]=d,this.float32[v+2]=m,t}}_o.prototype.bytesPerElement=12,ft(_o,"StructArrayLayout2ub2f12");class zr extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,s,c){const d=this.length;return this.resize(d+1),this.emplace(d,t,s,c)}emplace(t,s,c,d){const m=3*t;return this.float32[m+0]=s,this.float32[m+1]=c,this.float32[m+2]=d,t}}zr.prototype.bytesPerElement=12,ft(zr,"StructArrayLayout3f12");class Hn extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,s,c){const d=this.length;return this.resize(d+1),this.emplace(d,t,s,c)}emplace(t,s,c,d){const m=3*t;return this.uint16[m+0]=s,this.uint16[m+1]=c,this.uint16[m+2]=d,t}}Hn.prototype.bytesPerElement=6,ft(Hn,"StructArrayLayout3ui6");class Wo extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v,w,T,S,C,L,z,B,V,Z,oe,de,se,ue,ye){const pe=this.length;return this.resize(pe+1),this.emplace(pe,t,s,c,d,m,_,v,w,T,S,C,L,z,B,V,Z,oe,de,se,ue,ye)}emplace(t,s,c,d,m,_,v,w,T,S,C,L,z,B,V,Z,oe,de,se,ue,ye,pe){const Re=30*t,Le=15*t,Ne=60*t;return this.int16[Re+0]=s,this.int16[Re+1]=c,this.int16[Re+2]=d,this.float32[Le+2]=m,this.float32[Le+3]=_,this.uint16[Re+8]=v,this.uint16[Re+9]=w,this.uint32[Le+5]=T,this.uint32[Le+6]=S,this.uint32[Le+7]=C,this.uint16[Re+16]=L,this.uint16[Re+17]=z,this.uint16[Re+18]=B,this.float32[Le+10]=V,this.float32[Le+11]=Z,this.uint8[Ne+48]=oe,this.uint8[Ne+49]=de,this.uint8[Ne+50]=se,this.uint32[Le+13]=ue,this.int16[Re+28]=ye,this.uint8[Ne+58]=pe,t}}Wo.prototype.bytesPerElement=60,ft(Wo,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Ws extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m,_,v,w,T,S,C,L,z,B,V,Z,oe,de,se,ue,ye,pe,Re,Le,Ne,Je,Be,qe,He,Ye){const Qe=this.length;return this.resize(Qe+1),this.emplace(Qe,t,s,c,d,m,_,v,w,T,S,C,L,z,B,V,Z,oe,de,se,ue,ye,pe,Re,Le,Ne,Je,Be,qe,He,Ye)}emplace(t,s,c,d,m,_,v,w,T,S,C,L,z,B,V,Z,oe,de,se,ue,ye,pe,Re,Le,Ne,Je,Be,qe,He,Ye,Qe){const Ue=38*t,mt=19*t;return this.int16[Ue+0]=s,this.int16[Ue+1]=c,this.int16[Ue+2]=d,this.float32[mt+2]=m,this.float32[mt+3]=_,this.int16[Ue+8]=v,this.int16[Ue+9]=w,this.int16[Ue+10]=T,this.int16[Ue+11]=S,this.int16[Ue+12]=C,this.int16[Ue+13]=L,this.uint16[Ue+14]=z,this.uint16[Ue+15]=B,this.uint16[Ue+16]=V,this.uint16[Ue+17]=Z,this.uint16[Ue+18]=oe,this.uint16[Ue+19]=de,this.uint16[Ue+20]=se,this.uint16[Ue+21]=ue,this.uint16[Ue+22]=ye,this.uint16[Ue+23]=pe,this.uint16[Ue+24]=Re,this.uint16[Ue+25]=Le,this.uint16[Ue+26]=Ne,this.uint16[Ue+27]=Je,this.uint16[Ue+28]=Be,this.uint32[mt+15]=qe,this.float32[mt+16]=He,this.float32[mt+17]=Ye,this.float32[mt+18]=Qe,t}}Ws.prototype.bytesPerElement=76,ft(Ws,"StructArrayLayout3i2f6i15ui1ul3f76");class Ln extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const s=this.length;return this.resize(s+1),this.emplace(s,t)}emplace(t,s){return this.float32[1*t+0]=s,t}}Ln.prototype.bytesPerElement=4,ft(Ln,"StructArrayLayout1f4");class hs extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,s,c,d,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,s,c,d,m)}emplace(t,s,c,d,m,_){const v=5*t;return this.float32[v+0]=s,this.float32[v+1]=c,this.float32[v+2]=d,this.float32[v+3]=m,this.float32[v+4]=_,t}}hs.prototype.bytesPerElement=20,ft(hs,"StructArrayLayout5f20");class Zs extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,s,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,t,s,c,d)}emplace(t,s,c,d,m){const _=6*t;return this.uint32[3*t+0]=s,this.uint16[_+2]=c,this.uint16[_+3]=d,this.uint16[_+4]=m,t}}Zs.prototype.bytesPerElement=12,ft(Zs,"StructArrayLayout1ul3ui12");class Or extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,s){const c=this.length;return this.resize(c+1),this.emplace(c,t,s)}emplace(t,s,c){const d=2*t;return this.uint16[d+0]=s,this.uint16[d+1]=c,t}}Or.prototype.bytesPerElement=4,ft(Or,"StructArrayLayout2ui4");class Pu extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const s=this.length;return this.resize(s+1),this.emplace(s,t)}emplace(t,s){return this.uint16[1*t+0]=s,t}}Pu.prototype.bytesPerElement=2,ft(Pu,"StructArrayLayout1ui2");class Hd extends Et{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,s){const c=this.length;return this.resize(c+1),this.emplace(c,t,s)}emplace(t,s,c){const d=2*t;return this.float32[d+0]=s,this.float32[d+1]=c,t}}Hd.prototype.bytesPerElement=8,ft(Hd,"StructArrayLayout2f8");class Cy extends Ct{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}}Cy.prototype.size=12;class Ly extends ki{get(t){return new Cy(this,t)}}ft(Ly,"FillExtrusionExtArray");class ky extends Ct{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}ky.prototype.size=40;class om extends Un{get(t){return new ky(this,t)}}ft(om,"CollisionBoxArray");class Ry extends Ct{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}Ry.prototype.size=60;class Dy extends Wo{get(t){return new Ry(this,t)}}ft(Dy,"PlacedSymbolArray");class zy extends Ct{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(t){this._structArray.uint32[this._pos4+15]=t}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}zy.prototype.size=76;class Oy extends Ws{get(t){return new zy(this,t)}}ft(Oy,"SymbolInstanceArray");class By extends Ln{getoffsetX(t){return this.float32[1*t+0]}}ft(By,"GlyphOffsetArray");class Fy extends bi{getx(t){return this.int16[3*t+0]}gety(t){return this.int16[3*t+1]}gettileUnitDistanceFromAnchor(t){return this.int16[3*t+2]}}ft(Fy,"SymbolLineVertexArray");class Ny extends Ct{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Ny.prototype.size=12;class Uy extends Zs{get(t){return new Ny(this,t)}}ft(Uy,"FeatureIndexArray");class Vy extends Ct{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}Vy.prototype.size=4;class jy extends Or{get(t){return new Vy(this,t)}}ft(jy,"FillExtrusionCentroidArray");class Gy extends Ct{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}}Gy.prototype.size=12;class Wy extends ki{get(t){return new Gy(this,t)}}ft(Wy,"CircleGlobeExtArray");const l2=rt([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),c2=rt([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var Dl={exports:{}},Zy={exports:{}};Zy.exports=function(r,t){var s,c,d,m,_,v,w,T;for(c=r.length-(s=3&r.length),d=t,_=3432918353,v=461845907,T=0;T<c;)w=255&r.charCodeAt(T)|(255&r.charCodeAt(++T))<<8|(255&r.charCodeAt(++T))<<16|(255&r.charCodeAt(++T))<<24,++T,d=27492+(65535&(m=5*(65535&(d=(d^=w=(65535&(w=(w=(65535&w)*_+(((w>>>16)*_&65535)<<16)&4294967295)<<15|w>>>17))*v+(((w>>>16)*v&65535)<<16)&4294967295)<<13|d>>>19))+((5*(d>>>16)&65535)<<16)&4294967295))+((58964+(m>>>16)&65535)<<16);switch(w=0,s){case 3:w^=(255&r.charCodeAt(T+2))<<16;case 2:w^=(255&r.charCodeAt(T+1))<<8;case 1:d^=w=(65535&(w=(w=(65535&(w^=255&r.charCodeAt(T)))*_+(((w>>>16)*_&65535)<<16)&4294967295)<<15|w>>>17))*v+(((w>>>16)*v&65535)<<16)&4294967295}return d^=r.length,d=2246822507*(65535&(d^=d>>>16))+((2246822507*(d>>>16)&65535)<<16)&4294967295,d=3266489909*(65535&(d^=d>>>13))+((3266489909*(d>>>16)&65535)<<16)&4294967295,(d^=d>>>16)>>>0};var $y={exports:{}};$y.exports=function(r,t){for(var s,c=r.length,d=t^c,m=0;c>=4;)s=1540483477*(65535&(s=255&r.charCodeAt(m)|(255&r.charCodeAt(++m))<<8|(255&r.charCodeAt(++m))<<16|(255&r.charCodeAt(++m))<<24))+((1540483477*(s>>>16)&65535)<<16),d=1540483477*(65535&d)+((1540483477*(d>>>16)&65535)<<16)^(s=1540483477*(65535&(s^=s>>>24))+((1540483477*(s>>>16)&65535)<<16)),c-=4,++m;switch(c){case 3:d^=(255&r.charCodeAt(m+2))<<16;case 2:d^=(255&r.charCodeAt(m+1))<<8;case 1:d=1540483477*(65535&(d^=255&r.charCodeAt(m)))+((1540483477*(d>>>16)&65535)<<16)}return d=1540483477*(65535&(d^=d>>>13))+((1540483477*(d>>>16)&65535)<<16),(d^=d>>>15)>>>0};var qy=Zy.exports,u2=$y.exports;Dl.exports=qy,Dl.exports.murmur3=qy,Dl.exports.murmur2=u2;class Xd{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(t,s,c,d){this.ids.push(Hy(t)),this.positions.push(s,c,d)}getPositions(t){const s=Hy(t);let c=0,d=this.ids.length-1;for(;c<d;){const _=c+d>>1;this.ids[_]>=s?d=_:c=_+1}const m=[];for(;this.ids[c]===s;)m.push({index:this.positions[3*c],start:this.positions[3*c+1],end:this.positions[3*c+2]}),c++;return m}static serialize(t,s){const c=new Float64Array(t.ids),d=new Uint32Array(t.positions);return am(c,d,0,c.length-1),s&&s.push(c.buffer,d.buffer),{ids:c,positions:d}}static deserialize(t){const s=new Xd;return s.ids=t.ids,s.positions=t.positions,s.indexed=!0,s}}function Hy(r){const t=+r;return!isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:Dl.exports(String(r))}function am(r,t,s,c){for(;s<c;){const d=r[s+c>>1];let m=s-1,_=c+1;for(;;){do m++;while(r[m]<d);do _--;while(r[_]>d);if(m>=_)break;Yd(r,m,_),Yd(t,3*m,3*_),Yd(t,3*m+1,3*_+1),Yd(t,3*m+2,3*_+2)}_-s<c-_?(am(r,t,s,_),s=_+1):(am(r,t,_+1,c),c=_)}}function Yd(r,t,s){const c=r[t];r[t]=r[s],r[s]=c}ft(Xd,"FeaturePositionMap");class yo{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,s){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,s),this.initialized=!0),!!this.location}}class Kd extends yo{constructor(t){super(t),this.current=0}set(t,s,c){this.fetchUniformLocation(t,s)&&this.current!==c&&(this.current=c,this.gl.uniform1f(this.location,c))}}class Xy extends yo{constructor(t){super(t),this.current=[0,0,0,0]}set(t,s,c){this.fetchUniformLocation(t,s)&&(c[0]===this.current[0]&&c[1]===this.current[1]&&c[2]===this.current[2]&&c[3]===this.current[3]||(this.current=c,this.gl.uniform4f(this.location,c[0],c[1],c[2],c[3])))}}class Yy extends yo{constructor(t){super(t),this.current=ri.transparent}set(t,s,c){this.fetchUniformLocation(t,s)&&(c.r===this.current.r&&c.g===this.current.g&&c.b===this.current.b&&c.a===this.current.a||(this.current=c,this.gl.uniform4f(this.location,c.r,c.g,c.b,c.a)))}}const h2=new Float32Array(16),d2=new Float32Array(9),f2=new Float32Array(4);function lm(r){return[vt(255*r.r,255*r.g),vt(255*r.b,255*r.a)]}class Iu{constructor(t,s,c){this.value=t,this.uniformNames=s.map(d=>`u_${d}`),this.type=c}setUniform(t,s,c,d,m){s.set(t,m,d.constantOr(this.value))}getBinding(t,s){return this.type==="color"?new Yy(t):new Kd(t)}}class zl{constructor(t,s){this.uniformNames=s.map(c=>`u_${c}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(t,s){this.pixelRatioFrom=s.pixelRatio||1,this.pixelRatioTo=t.pixelRatio||1,this.patternFrom=s.tl.concat(s.br),this.patternTo=t.tl.concat(t.br)}setUniform(t,s,c,d,m){const _=m==="u_pattern_to"||m==="u_dash_to"?this.patternTo:m==="u_pattern_from"||m==="u_dash_from"?this.patternFrom:m==="u_pixel_ratio_to"?this.pixelRatioTo:m==="u_pixel_ratio_from"?this.pixelRatioFrom:null;_&&s.set(t,m,_)}getBinding(t,s){return s==="u_pattern_from"||s==="u_pattern_to"||s==="u_dash_from"||s==="u_dash_to"?new Xy(t):new Kd(t)}}class xo{constructor(t,s,c,d){this.expression=t,this.type=c,this.maxValue=0,this.paintVertexAttributes=s.map(m=>({name:`a_${m}`,type:"Float32",components:c==="color"?2:1,offset:0})),this.paintVertexArray=new d}populatePaintArray(t,s,c,d,m,_){const v=this.paintVertexArray.length,w=this.expression.evaluate(new le(0),s,{},m,d,_);this.paintVertexArray.resize(t),this._setPaintValue(v,t,w)}updatePaintArray(t,s,c,d,m){const _=this.expression.evaluate({zoom:0},c,d,void 0,m);this._setPaintValue(t,s,_)}_setPaintValue(t,s,c){if(this.type==="color"){const d=lm(c);for(let m=t;m<s;m++)this.paintVertexArray.emplace(m,d[0],d[1])}else{for(let d=t;d<s;d++)this.paintVertexArray.emplace(d,c);this.maxValue=Math.max(this.maxValue,Math.abs(c))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ps{constructor(t,s,c,d,m,_){this.expression=t,this.uniformNames=s.map(v=>`u_${v}_t`),this.type=c,this.useIntegerZoom=d,this.zoom=m,this.maxValue=0,this.paintVertexAttributes=s.map(v=>({name:`a_${v}`,type:"Float32",components:c==="color"?4:2,offset:0})),this.paintVertexArray=new _}populatePaintArray(t,s,c,d,m,_){const v=this.expression.evaluate(new le(this.zoom),s,{},m,d,_),w=this.expression.evaluate(new le(this.zoom+1),s,{},m,d,_),T=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(T,t,v,w)}updatePaintArray(t,s,c,d,m){const _=this.expression.evaluate({zoom:this.zoom},c,d,void 0,m),v=this.expression.evaluate({zoom:this.zoom+1},c,d,void 0,m);this._setPaintValue(t,s,_,v)}_setPaintValue(t,s,c,d){if(this.type==="color"){const m=lm(c),_=lm(d);for(let v=t;v<s;v++)this.paintVertexArray.emplace(v,m[0],m[1],_[0],_[1])}else{for(let m=t;m<s;m++)this.paintVertexArray.emplace(m,c,d);this.maxValue=Math.max(this.maxValue,Math.abs(c),Math.abs(d))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,s,c,d,m){const _=this.useIntegerZoom?Math.floor(c.zoom):c.zoom,v=Lt(this.expression.interpolationFactor(_,this.zoom,this.zoom+1),0,1);s.set(t,m,v)}getBinding(t,s){return new Kd(t)}}class Zo{constructor(t,s,c,d,m,_,v){this.expression=t,this.type=c,this.useIntegerZoom=d,this.zoom=m,this.layerId=v,this.paintVertexAttributes=(c==="array"?c2:l2).members;for(let w=0;w<s.length;++w);this.zoomInPaintVertexArray=new _,this.zoomOutPaintVertexArray=new _}populatePaintArray(t,s,c){const d=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(t),this.zoomOutPaintVertexArray.resize(t),this._setPaintValues(d,t,s.patterns&&s.patterns[this.layerId],c)}updatePaintArray(t,s,c,d,m,_){this._setPaintValues(t,s,c.patterns&&c.patterns[this.layerId],_)}_setPaintValues(t,s,c,d){if(!d||!c)return;const{min:m,mid:_,max:v}=c,w=d[m],T=d[_],S=d[v];if(w&&T&&S)for(let C=t;C<s;C++)this._setPaintValue(this.zoomInPaintVertexArray,C,T,w),this._setPaintValue(this.zoomOutPaintVertexArray,C,T,S)}_setPaintValue(t,s,c,d){t.emplace(s,c.tl[0],c.tl[1],c.br[0],c.br[1],d.tl[0],d.tl[1],d.br[0],d.br[1],c.pixelRatio,d.pixelRatio)}upload(t){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=t.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=t.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class $o{constructor(t,s,c=()=>!0){this.binders={},this._buffers=[];const d=[];for(const m in t.paint._values){if(!c(m))continue;const _=t.paint.get(m);if(!(_ instanceof $e&&Vo(_.property.specification)))continue;const v=m2(m,t.type),w=_.value,T=_.property.specification.type,S=_.property.useIntegerZoom,C=_.property.specification["property-type"],L=C==="cross-faded"||C==="cross-faded-data-driven",z=String(m)==="line-dasharray"&&t.layout.get("line-cap").value.kind!=="constant";if(w.kind!=="constant"||z)if(w.kind==="source"||z||L){const B=Ky(m,T,"source");this.binders[m]=L?new Zo(w,v,T,S,s,B,t.id):new xo(w,v,T,B),d.push(`/a_${m}`)}else{const B=Ky(m,T,"composite");this.binders[m]=new Ps(w,v,T,S,s,B),d.push(`/z_${m}`)}else this.binders[m]=L?new zl(w.value,v):new Iu(w.value,v,T),d.push(`/u_${m}`)}this.cacheKey=d.sort().join("")}getMaxValue(t){const s=this.binders[t];return s instanceof xo||s instanceof Ps?s.maxValue:0}populatePaintArrays(t,s,c,d,m,_){for(const v in this.binders){const w=this.binders[v];(w instanceof xo||w instanceof Ps||w instanceof Zo)&&w.populatePaintArray(t,s,c,d,m,_)}}setConstantPatternPositions(t,s){for(const c in this.binders){const d=this.binders[c];d instanceof zl&&d.setConstantPatternPositions(t,s)}}updatePaintArrays(t,s,c,d,m,_){let v=!1;for(const w in t){const T=s.getPositions(w);for(const S of T){const C=c.feature(S.index);for(const L in this.binders){const z=this.binders[L];if((z instanceof xo||z instanceof Ps||z instanceof Zo)&&z.expression.isStateDependent===!0){const B=d.paint.get(L);z.expression=B.value,z.updatePaintArray(S.start,S.end,C,t[w],m,_),v=!0}}}}return v}defines(){const t=[];for(const s in this.binders){const c=this.binders[s];(c instanceof Iu||c instanceof zl)&&t.push(...c.uniformNames.map(d=>`#define HAS_UNIFORM_${d}`))}return t}getBinderAttributes(){const t=[];for(const s in this.binders){const c=this.binders[s];if(c instanceof xo||c instanceof Ps||c instanceof Zo)for(let d=0;d<c.paintVertexAttributes.length;d++)t.push(c.paintVertexAttributes[d].name)}return t}getBinderUniforms(){const t=[];for(const s in this.binders){const c=this.binders[s];if(c instanceof Iu||c instanceof zl||c instanceof Ps)for(const d of c.uniformNames)t.push(d)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const s=[];for(const c in this.binders){const d=this.binders[c];if(d instanceof Iu||d instanceof zl||d instanceof Ps)for(const m of d.uniformNames)s.push({name:m,property:c,binding:d.getBinding(t,m)})}return s}setUniforms(t,s,c,d,m){for(const{name:_,property:v,binding:w}of c)this.binders[v].setUniform(t,w,m,d.get(v),_)}updatePaintBuffers(t){this._buffers=[];for(const s in this.binders){const c=this.binders[s];if(t&&c instanceof Zo){const d=t.fromScale===2?c.zoomInPaintVertexBuffer:c.zoomOutPaintVertexBuffer;d&&this._buffers.push(d)}else(c instanceof xo||c instanceof Ps)&&c.paintVertexBuffer&&this._buffers.push(c.paintVertexBuffer)}}upload(t){for(const s in this.binders){const c=this.binders[s];(c instanceof xo||c instanceof Ps||c instanceof Zo)&&c.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const s=this.binders[t];(s instanceof xo||s instanceof Ps||s instanceof Zo)&&s.destroy()}}}class Ia{constructor(t,s,c=()=>!0){this.programConfigurations={};for(const d of t)this.programConfigurations[d.id]=new $o(d,s,c);this.needsUpload=!1,this._featureMap=new Xd,this._bufferOffset=0}populatePaintArrays(t,s,c,d,m,_,v){for(const w in this.programConfigurations)this.programConfigurations[w].populatePaintArrays(t,s,d,m,_,v);s.id!==void 0&&this._featureMap.add(s.id,c,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,s,c,d,m){for(const _ of c)this.needsUpload=this.programConfigurations[_.id].updatePaintArrays(t,this._featureMap,s,_,d,m)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const s in this.programConfigurations)this.programConfigurations[s].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const p2={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function m2(r,t){return p2[r]||[r.replace(`${t}-`,"").replace(/-/g,"_")]}const g2={"line-pattern":{source:qn,composite:qn},"fill-pattern":{source:qn,composite:qn},"fill-extrusion-pattern":{source:qn,composite:qn},"line-dasharray":{source:us,composite:us}},_2={color:{source:Hd,composite:xn},number:{source:Ln,composite:Hd}};function Ky(r,t,s){const c=g2[r];return c&&c[s]||_2[t][s]}ft(Iu,"ConstantBinder"),ft(zl,"CrossFadedConstantBinder"),ft(xo,"SourceExpressionBinder"),ft(Zo,"CrossFadedCompositeBinder"),ft(Ps,"CompositeExpressionBinder"),ft($o,"ProgramConfiguration",{omit:["_buffers"]}),ft(Ia,"ProgramConfigurationSet");const Jd="-transition";class Is extends It{constructor(t,s){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&t.type!=="sky"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),s.layout&&(this._unevaluatedLayout=new we(s.layout)),s.paint)){this._transitionablePaint=new ze(s.paint);for(const c in t.paint)this.setPaintProperty(c,t.paint[c],{validate:!1});for(const c in t.layout)this.setLayoutProperty(c,t.layout[c],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new je(s.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,s,c={}){s!=null&&this._validate(sm,`layers.${this.id}.layout.${t}`,t,s,c)||(t!=="visibility"?this._unevaluatedLayout.setValue(t,s):this.visibility=s)}getPaintProperty(t){return Ai(t,Jd)?this._transitionablePaint.getTransition(t.slice(0,-Jd.length)):this._transitionablePaint.getValue(t)}setPaintProperty(t,s,c={}){if(s!=null&&this._validate(rm,`layers.${this.id}.paint.${t}`,t,s,c))return!1;if(Ai(t,Jd))return this._transitionablePaint.setTransition(t.slice(0,-Jd.length),s||void 0),!1;{const d=this._transitionablePaint._values[t],m=d.property.specification["property-type"]==="cross-faded-data-driven",_=d.value.isDataDriven(),v=d.value;this._transitionablePaint.setValue(t,s),this._handleSpecialPaintPropertyUpdate(t);const w=this._transitionablePaint._values[t].value;return w.isDataDriven()||_||m||this._handleOverridablePaintPropertyUpdate(t,v,w)}}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getProgramConfiguration(t){return null}_handleOverridablePaintPropertyUpdate(t,s,c){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,s){t.getCrossfadeParameters&&(this._crossfadeParameters=t.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,s)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,s)}serialize(){const t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(t.layout=t.layout||{},t.layout.visibility=this.visibility),oi(t,(s,c)=>!(s===void 0||c==="layout"&&!Object.keys(s).length||c==="paint"&&!Object.keys(s).length))}_validate(t,s,c,d,m={}){return(!m||m.validate!==!1)&&wu(this,t.call(Rd,{key:s,layerType:this.type,objectKey:c,value:d,styleSpec:Me,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const s=this.paint.get(t);if(s instanceof $e&&Vo(s.property.specification)&&(s.value.kind==="source"||s.value.kind==="composite")&&s.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=bl(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const y2=rt([{name:"a_pos",components:2,type:"Int16"}],4),x2=rt([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class cn{constructor(t=[]){this.segments=t}prepareSegment(t,s,c,d){let m=this.segments[this.segments.length-1];return t>cn.MAX_VERTEX_ARRAY_LENGTH&&fi(`Max vertices per segment is ${cn.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!m||m.vertexLength+t>cn.MAX_VERTEX_ARRAY_LENGTH||m.sortKey!==d)&&(m={vertexOffset:s.length,primitiveOffset:c.length,vertexLength:0,primitiveLength:0},d!==void 0&&(m.sortKey=d),this.segments.push(m)),m}get(){return this.segments}destroy(){for(const t of this.segments)for(const s in t.vaos)t.vaos[s].destroy()}static simpleSegment(t,s,c,d){return new cn([{vertexOffset:t,primitiveOffset:s,vertexLength:c,primitiveLength:d,vaos:{},sortKey:0}])}}cn.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,ft(cn,"SegmentVector");var zt=8192;class qo{constructor(t,s){t&&(s?this.setSouthWest(t).setNorthEast(s):t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof di?new di(t.lng,t.lat):di.convert(t),this}setSouthWest(t){return this._sw=t instanceof di?new di(t.lng,t.lat):di.convert(t),this}extend(t){const s=this._sw,c=this._ne;let d,m;if(t instanceof di)d=t,m=t;else{if(!(t instanceof qo))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(qo.convert(t)):this.extend(di.convert(t)):typeof t=="object"&&t!==null&&t.hasOwnProperty("lat")&&t.hasOwnProperty("lon")?this.extend(di.convert(t)):this;if(d=t._sw,m=t._ne,!d||!m)return this}return s||c?(s.lng=Math.min(d.lng,s.lng),s.lat=Math.min(d.lat,s.lat),c.lng=Math.max(m.lng,c.lng),c.lat=Math.max(m.lat,c.lat)):(this._sw=new di(d.lng,d.lat),this._ne=new di(m.lng,m.lat)),this}getCenter(){return new di((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new di(this.getWest(),this.getNorth())}getSouthEast(){return new di(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:s,lat:c}=di.convert(t);let d=this._sw.lng<=s&&s<=this._ne.lng;return this._sw.lng>this._ne.lng&&(d=this._sw.lng>=s&&s>=this._ne.lng),this._sw.lat<=c&&c<=this._ne.lat&&d}static convert(t){return!t||t instanceof qo?t:new qo(t)}}const Qd=63710088e-1;class di{constructor(t,s){if(isNaN(t)||isNaN(s))throw new Error(`Invalid LngLat object: (${t}, ${s})`);if(this.lng=+t,this.lat=+s,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new di(fn(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const s=Math.PI/180,c=this.lat*s,d=t.lat*s,m=Math.sin(c)*Math.sin(d)+Math.cos(c)*Math.cos(d)*Math.cos((t.lng-this.lng)*s);return Qd*Math.acos(Math.min(m,1))}toBounds(t=0){const s=360*t/40075017,c=s/Math.cos(Math.PI/180*this.lat);return new qo(new di(this.lng-c,this.lat-s),new di(this.lng+c,this.lat+s))}static convert(t){if(t instanceof di)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new di(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new di(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Jy=2*Math.PI*Qd;function cm(r){return Jy*Math.cos(r*Math.PI/180)}function $s(r){return(180+r)/360}function qs(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function ds(r,t){return r/cm(t)}function Br(r){return 360*r-180}function Vn(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Qy(r,t){return r*cm(Vn(t))}const Hs=85.051129;function e0(r){return 1/Math.cos(r*Math.PI/180)}class Ol{constructor(t,s,c=0){this.x=+t,this.y=+s,this.z=+c}static fromLngLat(t,s=0){const c=di.convert(t);return new Ol($s(c.lng),qs(c.lat),ds(s,c.lat))}toLngLat(){return new di(Br(this.x),Vn(this.y))}toAltitude(){return Qy(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Jy*e0(Vn(this.y))}}function um(r,t,s,c,d,m,_,v,w){const T=(t+c)/2,S=(s+d)/2,C=new Ee(T,S);v(C),function(L,z,B,V,Z,oe){const de=B-Z,se=V-oe;return Math.abs((V-z)*de-(B-L)*se)/Math.hypot(de,se)}(C.x,C.y,m.x,m.y,_.x,_.y)>=w?(um(r,t,s,T,S,m,C,v,w),um(r,T,S,c,d,C,_,v,w)):r.push(_)}function t0(r,t,s){let c=r[0],d=c.x,m=c.y;t(c);const _=[c];for(let v=1;v<r.length;v++){const w=r[v],{x:T,y:S}=w;t(w),um(_,d,m,T,S,c,w,t,s),d=T,m=S,c=w}return _}function hm(r,t,s,c){if(c(t,s)){const d=t.add(s)._mult(.5);hm(r,t,d,c),hm(r,d,s,c)}else r.push(s)}function v2(r,t){let s=r[0];const c=[s];for(let d=1;d<r.length;d++){const m=r[d];hm(c,s,m,t),s=m}return c}const dm=Math.pow(2,14)-1,i0=-dm-1;function b2(r,t){const s=Math.round(r.x*t),c=Math.round(r.y*t);return r.x=Lt(s,i0,dm),r.y=Lt(c,i0,dm),(s<r.x||s>r.x+1||c<r.y||c>r.y+1)&&fi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function vo(r,t,s){const c=r.loadGeometry(),d=r.extent,m=zt/d;if(t&&s&&s.projection.isReprojectedInTileSpace){const _=1<<t.z,{scale:v,x:w,y:T,projection:S}=s,C=L=>{const z=Br((t.x+L.x/d)/_),B=Vn((t.y+L.y/d)/_),V=S.project(z,B);L.x=(V.x*v-w)*d,L.y=(V.y*v-T)*d};for(let L=0;L<c.length;L++)if(r.type!==1)c[L]=t0(c[L],C,1);else{const z=[];for(const B of c[L])B.x<0||B.x>=d||B.y<0||B.y>=d||(C(B),z.push(B));c[L]=z}}for(const _ of c)for(const v of _)b2(v,m);return c}function Ca(r,t){return{type:r.type,id:r.id,properties:r.properties,geometry:t?vo(r):[]}}function ef(r,t,s,c,d){r.emplaceBack(2*t+(c+1)/2,2*s+(d+1)/2)}function tf(r,t,s){r.emplaceBack(t.x,t.y,t.z,s[0]*16384,s[1]*16384,s[2]*16384)}class fm{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(s=>s.id),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new Ht,this.indexArray=new Hn,this.segments=new cn,this.programConfigurations=new Ia(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(s=>s.isStateDependent()).map(s=>s.id)}populate(t,s,c,d){const m=this.layers[0],_=[];let v=null;m.type==="circle"&&(v=m.layout.get("circle-sort-key"));for(const{feature:T,id:S,index:C,sourceLayerIndex:L}of t){const z=this.layers[0]._featureFilter.needGeometry,B=Ca(T,z);if(!this.layers[0]._featureFilter.filter(new le(this.zoom),B,c))continue;const V=v?v.evaluate(B,{},c):void 0,Z={id:S,properties:T.properties,type:T.type,sourceLayerIndex:L,index:C,geometry:z?B.geometry:vo(T,c,d),patterns:{},sortKey:V};_.push(Z)}v&&_.sort((T,S)=>T.sortKey-S.sortKey);let w=null;d.projection.name==="globe"&&(this.globeExtVertexArray=new Wy,w=d.projection);for(const T of _){const{geometry:S,index:C,sourceLayerIndex:L}=T,z=t[C].feature;this.addFeature(T,S,C,s.availableImages,c,w),s.featureIndex.insert(z,S,C,L,this.index)}}update(t,s,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,s,this.stateDependentLayers,c,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,y2.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,x2.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,s,c,d,m,_){for(const v of s)for(const w of v){const T=w.x,S=w.y;if(T<0||T>=zt||S<0||S>=zt)continue;if(_){const z=_.projectTilePoint(T,S,m),B=_.upVector(m,T,S),V=this.globeExtVertexArray;tf(V,z,B),tf(V,z,B),tf(V,z,B),tf(V,z,B)}const C=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),L=C.vertexLength;ef(this.layoutVertexArray,T,S,-1,-1),ef(this.layoutVertexArray,T,S,1,-1),ef(this.layoutVertexArray,T,S,1,1),ef(this.layoutVertexArray,T,S,-1,1),this.indexArray.emplaceBack(L,L+1,L+2),this.indexArray.emplaceBack(L,L+2,L+3),C.vertexLength+=4,C.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,c,{},d,m)}}function n0(r,t){for(let s=0;s<r.length;s++)if(La(t,r[s]))return!0;for(let s=0;s<t.length;s++)if(La(r,t[s]))return!0;return!!pm(r,t)}function w2(r,t,s){return!!La(r,t)||!!mm(t,r,s)}function r0(r,t){if(r.length===1)return o0(t,r[0]);for(let s=0;s<t.length;s++){const c=t[s];for(let d=0;d<c.length;d++)if(La(r,c[d]))return!0}for(let s=0;s<r.length;s++)if(o0(t,r[s]))return!0;for(let s=0;s<t.length;s++)if(pm(r,t[s]))return!0;return!1}function T2(r,t,s){if(r.length>1){if(pm(r,t))return!0;for(let c=0;c<t.length;c++)if(mm(t[c],r,s))return!0}for(let c=0;c<r.length;c++)if(mm(r[c],t,s))return!0;return!1}function pm(r,t){if(r.length===0||t.length===0)return!1;for(let s=0;s<r.length-1;s++){const c=r[s],d=r[s+1];for(let m=0;m<t.length-1;m++)if(E2(c,d,t[m],t[m+1]))return!0}return!1}function E2(r,t,s,c){return mn(r,s,c)!==mn(t,s,c)&&mn(r,t,s)!==mn(r,t,c)}function mm(r,t,s){const c=s*s;if(t.length===1)return r.distSqr(t[0])<c;for(let d=1;d<t.length;d++)if(s0(r,t[d-1],t[d])<c)return!0;return!1}function s0(r,t,s){const c=t.distSqr(s);if(c===0)return r.distSqr(t);const d=((r.x-t.x)*(s.x-t.x)+(r.y-t.y)*(s.y-t.y))/c;return r.distSqr(d<0?t:d>1?s:s.sub(t)._mult(d)._add(t))}function o0(r,t){let s,c,d,m=!1;for(let _=0;_<r.length;_++){s=r[_];for(let v=0,w=s.length-1;v<s.length;w=v++)c=s[v],d=s[w],c.y>t.y!=d.y>t.y&&t.x<(d.x-c.x)*(t.y-c.y)/(d.y-c.y)+c.x&&(m=!m)}return m}function La(r,t){let s=!1;for(let c=0,d=r.length-1;c<r.length;d=c++){const m=r[c],_=r[d];m.y>t.y!=_.y>t.y&&t.x<(_.x-m.x)*(t.y-m.y)/(_.y-m.y)+m.x&&(s=!s)}return s}function a0(r,t,s,c,d){for(const _ of r)if(t<=_.x&&s<=_.y&&c>=_.x&&d>=_.y)return!0;const m=[new Ee(t,s),new Ee(t,d),new Ee(c,d),new Ee(c,s)];if(r.length>2){for(const _ of m)if(La(r,_))return!0}for(let _=0;_<r.length-1;_++)if(A2(r[_],r[_+1],m))return!0;return!1}function A2(r,t,s){const c=s[0],d=s[2];if(r.x<c.x&&t.x<c.x||r.x>d.x&&t.x>d.x||r.y<c.y&&t.y<c.y||r.y>d.y&&t.y>d.y)return!1;const m=mn(r,t,s[0]);return m!==mn(r,t,s[1])||m!==mn(r,t,s[2])||m!==mn(r,t,s[3])}function Bl(r,t,s){const c=t.paint.get(r).value;return c.kind==="constant"?c.value:s.programConfigurations.get(t.id).getMaxValue(r)}function nf(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function l0(r,t,s,c,d){if(!t[0]&&!t[1])return r;const m=Ee.convert(t)._mult(d);s==="viewport"&&m._rotate(-c);const _=[];for(let v=0;v<r.length;v++)_.push(r[v].sub(m));return _}function c0(r,t,s,c){const d=Ee.convert(r)._mult(c);return t==="viewport"&&d._rotate(-s),d}ft(fm,"CircleBucket",{omit:["layers"]});const S2=new nt({"circle-sort-key":new ve(Me.layout_circle["circle-sort-key"])});var M2={paint:new nt({"circle-radius":new ve(Me.paint_circle["circle-radius"]),"circle-color":new ve(Me.paint_circle["circle-color"]),"circle-blur":new ve(Me.paint_circle["circle-blur"]),"circle-opacity":new ve(Me.paint_circle["circle-opacity"]),"circle-translate":new Ie(Me.paint_circle["circle-translate"]),"circle-translate-anchor":new Ie(Me.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ie(Me.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ie(Me.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ve(Me.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ve(Me.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ve(Me.paint_circle["circle-stroke-opacity"])}),layout:S2},rf=1e-6,Tr=typeof Float32Array<"u"?Float32Array:Array;function u0(){var r=new Tr(9);return Tr!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function h0(r,t,s){var c=t[0],d=t[1],m=t[2],_=t[3],v=t[4],w=t[5],T=t[6],S=t[7],C=t[8],L=s[0],z=s[1],B=s[2],V=s[3],Z=s[4],oe=s[5],de=s[6],se=s[7],ue=s[8];return r[0]=L*c+z*_+B*T,r[1]=L*d+z*v+B*S,r[2]=L*m+z*w+B*C,r[3]=V*c+Z*_+oe*T,r[4]=V*d+Z*v+oe*S,r[5]=V*m+Z*w+oe*C,r[6]=de*c+se*_+ue*T,r[7]=de*d+se*v+ue*S,r[8]=de*m+se*w+ue*C,r}function Xs(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function gm(r,t){var s=t[0],c=t[1],d=t[2],m=t[3],_=t[4],v=t[5],w=t[6],T=t[7],S=t[8],C=t[9],L=t[10],z=t[11],B=t[12],V=t[13],Z=t[14],oe=t[15],de=s*v-c*_,se=s*w-d*_,ue=s*T-m*_,ye=c*w-d*v,pe=c*T-m*v,Re=d*T-m*w,Le=S*V-C*B,Ne=S*Z-L*B,Je=S*oe-z*B,Be=C*Z-L*V,qe=C*oe-z*V,He=L*oe-z*Z,Ye=de*He-se*qe+ue*Be+ye*Je-pe*Ne+Re*Le;return Ye?(r[0]=(v*He-w*qe+T*Be)*(Ye=1/Ye),r[1]=(d*qe-c*He-m*Be)*Ye,r[2]=(V*Re-Z*pe+oe*ye)*Ye,r[3]=(L*pe-C*Re-z*ye)*Ye,r[4]=(w*Je-_*He-T*Ne)*Ye,r[5]=(s*He-d*Je+m*Ne)*Ye,r[6]=(Z*ue-B*Re-oe*se)*Ye,r[7]=(S*Re-L*ue+z*se)*Ye,r[8]=(_*qe-v*Je+T*Le)*Ye,r[9]=(c*Je-s*qe-m*Le)*Ye,r[10]=(B*pe-V*ue+oe*de)*Ye,r[11]=(C*ue-S*pe-z*de)*Ye,r[12]=(v*Ne-_*Be-w*Le)*Ye,r[13]=(s*Be-c*Ne+d*Le)*Ye,r[14]=(V*se-B*ye-Z*de)*Ye,r[15]=(S*ye-C*se+L*de)*Ye,r):null}function Fl(r,t,s){var c=t[0],d=t[1],m=t[2],_=t[3],v=t[4],w=t[5],T=t[6],S=t[7],C=t[8],L=t[9],z=t[10],B=t[11],V=t[12],Z=t[13],oe=t[14],de=t[15],se=s[0],ue=s[1],ye=s[2],pe=s[3];return r[0]=se*c+ue*v+ye*C+pe*V,r[1]=se*d+ue*w+ye*L+pe*Z,r[2]=se*m+ue*T+ye*z+pe*oe,r[3]=se*_+ue*S+ye*B+pe*de,r[4]=(se=s[4])*c+(ue=s[5])*v+(ye=s[6])*C+(pe=s[7])*V,r[5]=se*d+ue*w+ye*L+pe*Z,r[6]=se*m+ue*T+ye*z+pe*oe,r[7]=se*_+ue*S+ye*B+pe*de,r[8]=(se=s[8])*c+(ue=s[9])*v+(ye=s[10])*C+(pe=s[11])*V,r[9]=se*d+ue*w+ye*L+pe*Z,r[10]=se*m+ue*T+ye*z+pe*oe,r[11]=se*_+ue*S+ye*B+pe*de,r[12]=(se=s[12])*c+(ue=s[13])*v+(ye=s[14])*C+(pe=s[15])*V,r[13]=se*d+ue*w+ye*L+pe*Z,r[14]=se*m+ue*T+ye*z+pe*oe,r[15]=se*_+ue*S+ye*B+pe*de,r}function Cu(r,t,s){var c,d,m,_,v,w,T,S,C,L,z,B,V=s[0],Z=s[1],oe=s[2];return t===r?(r[12]=t[0]*V+t[4]*Z+t[8]*oe+t[12],r[13]=t[1]*V+t[5]*Z+t[9]*oe+t[13],r[14]=t[2]*V+t[6]*Z+t[10]*oe+t[14],r[15]=t[3]*V+t[7]*Z+t[11]*oe+t[15]):(d=t[1],m=t[2],_=t[3],v=t[4],w=t[5],T=t[6],S=t[7],C=t[8],L=t[9],z=t[10],B=t[11],r[0]=c=t[0],r[1]=d,r[2]=m,r[3]=_,r[4]=v,r[5]=w,r[6]=T,r[7]=S,r[8]=C,r[9]=L,r[10]=z,r[11]=B,r[12]=c*V+v*Z+C*oe+t[12],r[13]=d*V+w*Z+L*oe+t[13],r[14]=m*V+T*Z+z*oe+t[14],r[15]=_*V+S*Z+B*oe+t[15]),r}function ka(r,t,s){var c=s[0],d=s[1],m=s[2];return r[0]=t[0]*c,r[1]=t[1]*c,r[2]=t[2]*c,r[3]=t[3]*c,r[4]=t[4]*d,r[5]=t[5]*d,r[6]=t[6]*d,r[7]=t[7]*d,r[8]=t[8]*m,r[9]=t[9]*m,r[10]=t[10]*m,r[11]=t[11]*m,r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function _m(r,t,s){var c=Math.sin(s),d=Math.cos(s),m=t[4],_=t[5],v=t[6],w=t[7],T=t[8],S=t[9],C=t[10],L=t[11];return t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[4]=m*d+T*c,r[5]=_*d+S*c,r[6]=v*d+C*c,r[7]=w*d+L*c,r[8]=T*d-m*c,r[9]=S*d-_*c,r[10]=C*d-v*c,r[11]=L*d-w*c,r}function sf(r,t,s){var c=Math.sin(s),d=Math.cos(s),m=t[0],_=t[1],v=t[2],w=t[3],T=t[8],S=t[9],C=t[10],L=t[11];return t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=m*d-T*c,r[1]=_*d-S*c,r[2]=v*d-C*c,r[3]=w*d-L*c,r[8]=m*c+T*d,r[9]=_*c+S*d,r[10]=v*c+C*d,r[11]=w*c+L*d,r}function d0(r,t){return r[0]=t[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function f0(r,t,s){var c,d,m,_=s[0],v=s[1],w=s[2],T=Math.hypot(_,v,w);return T<rf?null:(_*=T=1/T,v*=T,w*=T,c=Math.sin(t),d=Math.cos(t),r[0]=_*_*(m=1-d)+d,r[1]=v*_*m+w*c,r[2]=w*_*m-v*c,r[3]=0,r[4]=_*v*m-w*c,r[5]=v*v*m+d,r[6]=w*v*m+_*c,r[7]=0,r[8]=_*w*m+v*c,r[9]=v*w*m-_*c,r[10]=w*w*m+d,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}Math.hypot||(Math.hypot=function(){for(var r=0,t=arguments.length;t--;)r+=arguments[t]*arguments[t];return Math.sqrt(r)});var P2=Fl;function ym(){var r=new Tr(3);return Tr!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function p0(r){var t=new Tr(3);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t}function Lu(r){return Math.hypot(r[0],r[1],r[2])}function Nl(r,t,s){var c=new Tr(3);return c[0]=r,c[1]=t,c[2]=s,c}function bo(r,t,s){return r[0]=t[0]+s[0],r[1]=t[1]+s[1],r[2]=t[2]+s[2],r}function xm(r,t,s){return r[0]=t[0]-s[0],r[1]=t[1]-s[1],r[2]=t[2]-s[2],r}function m0(r,t,s){return r[0]=t[0]*s[0],r[1]=t[1]*s[1],r[2]=t[2]*s[2],r}function ku(r,t,s){return r[0]=Math.min(t[0],s[0]),r[1]=Math.min(t[1],s[1]),r[2]=Math.min(t[2],s[2]),r}function Ru(r,t,s){return r[0]=Math.max(t[0],s[0]),r[1]=Math.max(t[1],s[1]),r[2]=Math.max(t[2],s[2]),r}function Fr(r,t,s){return r[0]=t[0]*s,r[1]=t[1]*s,r[2]=t[2]*s,r}function Du(r,t,s,c){return r[0]=t[0]+s[0]*c,r[1]=t[1]+s[1]*c,r[2]=t[2]+s[2]*c,r}function rr(r,t){var s=t[0],c=t[1],d=t[2],m=s*s+c*c+d*d;return m>0&&(m=1/Math.sqrt(m)),r[0]=t[0]*m,r[1]=t[1]*m,r[2]=t[2]*m,r}function fs(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]}function vm(r,t,s){var c=t[0],d=t[1],m=t[2],_=s[0],v=s[1],w=s[2];return r[0]=d*w-m*v,r[1]=m*_-c*w,r[2]=c*v-d*_,r}function un(r,t,s){var c=t[0],d=t[1],m=t[2],_=s[3]*c+s[7]*d+s[11]*m+s[15];return r[0]=(s[0]*c+s[4]*d+s[8]*m+s[12])/(_=_||1),r[1]=(s[1]*c+s[5]*d+s[9]*m+s[13])/_,r[2]=(s[2]*c+s[6]*d+s[10]*m+s[14])/_,r}function g0(r,t,s){var c=s[0],d=s[1],m=s[2],_=t[0],v=t[1],w=t[2],T=d*w-m*v,S=m*_-c*w,C=c*v-d*_,L=d*C-m*S,z=m*T-c*C,B=c*S-d*T,V=2*s[3];return S*=V,C*=V,z*=2,B*=2,r[0]=_+(T*=V)+(L*=2),r[1]=v+S+z,r[2]=w+C+B,r}var zu,Cs=xm,I2=m0,C2=Lu;function _0(r,t,s){return r[0]=t[0]*s,r[1]=t[1]*s,r[2]=t[2]*s,r[3]=t[3]*s,r}function y0(r,t){var s=t[0],c=t[1],d=t[2],m=t[3],_=s*s+c*c+d*d+m*m;return _>0&&(_=1/Math.sqrt(_)),r[0]=s*_,r[1]=c*_,r[2]=d*_,r[3]=m*_,r}function Ra(r,t,s){var c=t[0],d=t[1],m=t[2],_=t[3];return r[0]=s[0]*c+s[4]*d+s[8]*m+s[12]*_,r[1]=s[1]*c+s[5]*d+s[9]*m+s[13]*_,r[2]=s[2]*c+s[6]*d+s[10]*m+s[14]*_,r[3]=s[3]*c+s[7]*d+s[11]*m+s[15]*_,r}function x0(){var r=new Tr(4);return Tr!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function v0(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function b0(r,t,s){s*=.5;var c=t[0],d=t[1],m=t[2],_=t[3],v=Math.sin(s),w=Math.cos(s);return r[0]=c*w+_*v,r[1]=d*w+m*v,r[2]=m*w-d*v,r[3]=_*w-c*v,r}function w0(r,t,s){s*=.5;var c=t[0],d=t[1],m=t[2],_=t[3],v=Math.sin(s),w=Math.cos(s);return r[0]=c*w-m*v,r[1]=d*w+_*v,r[2]=m*w+c*v,r[3]=_*w-d*v,r}ym(),zu=new Tr(4),Tr!=Float32Array&&(zu[0]=0,zu[1]=0,zu[2]=0,zu[3]=0);var L2=y0;ym(),Nl(1,0,0),Nl(0,1,0),x0(),x0(),u0();class bm{constructor(t,s){this.pos=t,this.dir=s}intersectsPlane(t,s,c){const d=fs(s,this.dir);if(Math.abs(d)<1e-6)return!1;const m=((t[0]-this.pos[0])*s[0]+(t[1]-this.pos[1])*s[1]+(t[2]-this.pos[2])*s[2])/d;return c[0]=this.pos[0]+this.dir[0]*m,c[1]=this.pos[1]+this.dir[1]*m,c[2]=this.pos[2]+this.dir[2]*m,!0}closestPointOnSphere(t,s,c){if(function(z,B){var V=z[0],Z=z[1],oe=z[2],de=B[0],se=B[1],ue=B[2];return Math.abs(V-de)<=rf*Math.max(1,Math.abs(V),Math.abs(de))&&Math.abs(Z-se)<=rf*Math.max(1,Math.abs(Z),Math.abs(se))&&Math.abs(oe-ue)<=rf*Math.max(1,Math.abs(oe),Math.abs(ue))}(this.pos,t)||s===0)return c[0]=c[1]=c[2]=0,!1;const[d,m,_]=this.dir,v=this.pos[0]-t[0],w=this.pos[1]-t[1],T=this.pos[2]-t[2],S=d*d+m*m+_*_,C=2*(v*d+w*m+T*_),L=C*C-4*S*(v*v+w*w+T*T-s*s);if(L<0){const z=Math.max(-C/2,0),B=v+d*z,V=w+m*z,Z=T+_*z,oe=Math.hypot(B,V,Z);return c[0]=B*s/oe,c[1]=V*s/oe,c[2]=Z*s/oe,!1}{const z=(-C-Math.sqrt(L))/(2*S);if(z<0){const B=Math.hypot(v,w,T);return c[0]=v*s/B,c[1]=w*s/B,c[2]=T*s/B,!1}return c[0]=v+d*z,c[1]=w+m*z,c[2]=T+_*z,!0}}}class wm{constructor(t,s,c,d,m){this.TL=t,this.TR=s,this.BR=c,this.BL=d,this.horizon=m}static fromInvProjectionMatrix(t,s,c){const d=[-1,1,1],m=[1,1,1],_=[1,-1,1],v=[-1,-1,1],w=un(d,d,t),T=un(m,m,t),S=un(_,_,t),C=un(v,v,t);return new wm(w,T,S,C,s/c)}}class Tm{constructor(t,s){this.points=t,this.planes=s}static fromInvProjectionMatrix(t,s,c,d){const m=Math.pow(2,c),_=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(w=>{const T=Ra([],w,t),S=1/T[3]/s*m;return function(C,L,z){return C[0]=L[0]*z[0],C[1]=L[1]*z[1],C[2]=L[2]*z[2],C[3]=L[3]*z[3],C}(T,T,[S,S,d?1/T[3]:S,S])}),v=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(w=>{const T=rr([],vm([],Cs([],_[w[0]],_[w[1]]),Cs([],_[w[2]],_[w[1]]))),S=-fs(T,_[w[1]]);return T.concat(S)});return new Tm(_,v)}}class sr{static fromPoints(t){const s=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(const d of t)ku(s,s,d),Ru(c,c,d);return new sr(s,c)}static applyTransform(t,s){const c=t.getCorners();for(let d=0;d<c.length;++d)un(c[d],c[d],s);return sr.fromPoints(c)}constructor(t,s){this.min=t,this.max=s,this.center=Fr([],bo([],this.min,this.max),.5)}quadrant(t){const s=[t%2==0,t<2],c=p0(this.min),d=p0(this.max);for(let m=0;m<s.length;m++)c[m]=s[m]?this.min[m]:this.center[m],d[m]=s[m]?this.center[m]:this.max[m];return d[2]=this.max[2],new sr(c,d)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,s=this.max;return[[t[0],t[1],t[2]],[s[0],t[1],t[2]],[s[0],s[1],t[2]],[t[0],s[1],t[2]],[t[0],t[1],s[2]],[s[0],t[1],s[2]],[s[0],s[1],s[2]],[t[0],s[1],s[2]]]}intersects(t){const s=this.getCorners();let c=!0;for(let d=0;d<t.planes.length;d++){const m=t.planes[d];let _=0;for(let v=0;v<s.length;v++)_+=fs(m,s[v])+m[3]>=0;if(_===0)return 0;_!==s.length&&(c=!1)}if(c)return 2;for(let d=0;d<3;d++){let m=Number.MAX_VALUE,_=-Number.MAX_VALUE;for(let v=0;v<t.points.length;v++){const w=t.points[v][d]-this.min[d];m=Math.min(m,w),_=Math.max(_,w)}if(_<0||m>this.max[d]-this.min[d])return 0}return 1}}function T0(r,t,s,c,d,m,_,v,w){if(m&&r.queryGeometry.isAboveHorizon)return!1;m&&(w*=r.pixelToTileUnitsFactor);const T=r.tileID.canonical,S=s.projection.upVectorScale(T,s.center.lat,s.worldSize).metersToTile;for(const C of t)for(const L of C){const z=L.add(v),B=d&&s.elevation?s.elevation.exaggeration()*d.getElevationAt(z.x,z.y,!0):0,V=s.projection.projectTilePoint(z.x,z.y,T);if(B>0){const se=s.projection.upVector(T,z.x,z.y);V.x+=se[0]*S*B,V.y+=se[1]*S*B,V.z+=se[2]*S*B}const Z=m?z:k2(V.x,V.y,V.z,c),oe=m?r.tilespaceRays.map(se=>D2(se,B)):r.queryGeometry.screenGeometry,de=Ra([],[V.x,V.y,V.z,1],c);if(!_&&m?w*=de[3]/s.cameraToCenterDistance:_&&!m&&(w*=s.cameraToCenterDistance/de[3]),m){const se=Vn((L.y/zt+T.y)/(1<<T.z));w/=s.projection.pixelsPerMeter(se,1)/ds(1,se)}if(w2(oe,Z,w))return!0}return!1}function k2(r,t,s,c){const d=Ra([],[r,t,s,1],c);return new Ee(d[0]/d[3],d[1]/d[3])}const E0=Nl(0,0,0),R2=Nl(0,0,1);function D2(r,t){const s=ym();return E0[2]=t,r.intersectsPlane(E0,R2,s),new Ee(s[0],s[1])}class A0 extends fm{}function S0(r,{width:t,height:s},c,d){if(d){if(d instanceof Uint8ClampedArray)d=new Uint8Array(d.buffer);else if(d.length!==t*s*c)throw new RangeError("mismatched image size")}else d=new Uint8Array(t*s*c);return r.width=t,r.height=s,r.data=d,r}function M0(r,t,s){const{width:c,height:d}=t;c===r.width&&d===r.height||(Em(r,t,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,c),height:Math.min(r.height,d)},s),r.width=c,r.height=d,r.data=t.data)}function Em(r,t,s,c,d,m){if(d.width===0||d.height===0)return t;if(d.width>r.width||d.height>r.height||s.x>r.width-d.width||s.y>r.height-d.height)throw new RangeError("out of range source coordinates for image copy");if(d.width>t.width||d.height>t.height||c.x>t.width-d.width||c.y>t.height-d.height)throw new RangeError("out of range destination coordinates for image copy");const _=r.data,v=t.data;for(let w=0;w<d.height;w++){const T=((s.y+w)*r.width+s.x)*m,S=((c.y+w)*t.width+c.x)*m;for(let C=0;C<d.width*m;C++)v[S+C]=_[T+C]}return t}ft(A0,"HeatmapBucket",{omit:["layers"]});class wo{constructor(t,s){S0(this,t,1,s)}resize(t){M0(this,new wo(t),1)}clone(){return new wo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,s,c,d,m){Em(t,s,c,d,m,1)}}class Er{constructor(t,s){S0(this,t,4,s)}resize(t){M0(this,new Er(t),4)}replace(t,s){s?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new Er({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,s,c,d,m){Em(t,s,c,d,m,4)}}ft(wo,"AlphaImage"),ft(Er,"RGBAImage");var z2={paint:new nt({"heatmap-radius":new ve(Me.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ve(Me.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ie(Me.paint_heatmap["heatmap-intensity"]),"heatmap-color":new at(Me.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ie(Me.paint_heatmap["heatmap-opacity"])})};function Am(r){const t={},s=r.resolution||256,c=r.clips?r.clips.length:1,d=r.image||new Er({width:s,height:c}),m=(_,v,w)=>{t[r.evaluationKey]=w;const T=r.expression.evaluate(t);d.data[_+v+0]=Math.floor(255*T.r/T.a),d.data[_+v+1]=Math.floor(255*T.g/T.a),d.data[_+v+2]=Math.floor(255*T.b/T.a),d.data[_+v+3]=Math.floor(255*T.a)};if(r.clips)for(let _=0,v=0;_<c;++_,v+=4*s)for(let w=0,T=0;w<s;w++,T+=4){const S=w/(s-1),{start:C,end:L}=r.clips[_];m(v,T,C*(1-S)+L*S)}else for(let _=0,v=0;_<s;_++,v+=4)m(0,v,_/(s-1));return d}var O2={paint:new nt({"hillshade-illumination-direction":new Ie(Me.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ie(Me.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ie(Me.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ie(Me.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ie(Me.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ie(Me.paint_hillshade["hillshade-accent-color"])})};const B2=rt([{name:"a_pos",components:2,type:"Int16"}],4),{members:F2}=B2;var Ou={exports:{}};function of(r,t,s){s=s||2;var c,d,m,_,v,w,T,S=t&&t.length,C=S?t[0]*s:r.length,L=P0(r,0,C,s,!0),z=[];if(!L||L.next===L.prev)return z;if(S&&(L=function(V,Z,oe,de){var se,ue,ye,pe=[];for(se=0,ue=Z.length;se<ue;se++)(ye=P0(V,Z[se]*de,se<ue-1?Z[se+1]*de:V.length,de,!1))===ye.next&&(ye.steiner=!0),pe.push($2(ye));for(pe.sort(G2),se=0;se<pe.length;se++)oe=W2(pe[se],oe);return oe}(r,t,L,s)),r.length>80*s){c=m=r[0],d=_=r[1];for(var B=s;B<C;B+=s)(v=r[B])<c&&(c=v),(w=r[B+1])<d&&(d=w),v>m&&(m=v),w>_&&(_=w);T=(T=Math.max(m-c,_-d))!==0?32767/T:0}return Bu(L,z,s,c,d,T,0),z}function P0(r,t,s,c,d){var m,_;if(d===Pm(r,t,s,c)>0)for(m=t;m<s;m+=c)_=L0(m,r[m],r[m+1],_);else for(m=s-c;m>=t;m-=c)_=L0(m,r[m],r[m+1],_);return _&&af(_,_.next)&&(Nu(_),_=_.next),_}function Da(r,t){if(!r)return r;t||(t=r);var s,c=r;do if(s=!1,c.steiner||!af(c,c.next)&&rn(c.prev,c,c.next)!==0)c=c.next;else{if(Nu(c),(c=t=c.prev)===c.next)break;s=!0}while(s||c!==t);return t}function Bu(r,t,s,c,d,m,_){if(r){!_&&m&&function(S,C,L,z){var B=S;do B.z===0&&(B.z=Sm(B.x,B.y,C,L,z)),B.prevZ=B.prev,B.nextZ=B.next,B=B.next;while(B!==S);B.prevZ.nextZ=null,B.prevZ=null,function(V){var Z,oe,de,se,ue,ye,pe,Re,Le=1;do{for(oe=V,V=null,ue=null,ye=0;oe;){for(ye++,de=oe,pe=0,Z=0;Z<Le&&(pe++,de=de.nextZ);Z++);for(Re=Le;pe>0||Re>0&&de;)pe!==0&&(Re===0||!de||oe.z<=de.z)?(se=oe,oe=oe.nextZ,pe--):(se=de,de=de.nextZ,Re--),ue?ue.nextZ=se:V=se,se.prevZ=ue,ue=se;oe=de}ue.nextZ=null,Le*=2}while(ye>1)}(B)}(r,c,d,m);for(var v,w,T=r;r.prev!==r.next;)if(v=r.prev,w=r.next,m?U2(r,c,d,m):N2(r))t.push(v.i/s|0),t.push(r.i/s|0),t.push(w.i/s|0),Nu(r),r=w.next,T=w.next;else if((r=w)===T){_?_===1?Bu(r=V2(Da(r),t,s),t,s,c,d,m,2):_===2&&j2(r,t,s,c,d,m):Bu(Da(r),t,s,c,d,m,1);break}}}function N2(r){var t=r.prev,s=r,c=r.next;if(rn(t,s,c)>=0)return!1;for(var d=t.x,m=s.x,_=c.x,v=t.y,w=s.y,T=c.y,S=d<m?d<_?d:_:m<_?m:_,C=v<w?v<T?v:T:w<T?w:T,L=d>m?d>_?d:_:m>_?m:_,z=v>w?v>T?v:T:w>T?w:T,B=c.next;B!==t;){if(B.x>=S&&B.x<=L&&B.y>=C&&B.y<=z&&Ul(d,v,m,w,_,T,B.x,B.y)&&rn(B.prev,B,B.next)>=0)return!1;B=B.next}return!0}function U2(r,t,s,c){var d=r.prev,m=r,_=r.next;if(rn(d,m,_)>=0)return!1;for(var v=d.x,w=m.x,T=_.x,S=d.y,C=m.y,L=_.y,z=v<w?v<T?v:T:w<T?w:T,B=S<C?S<L?S:L:C<L?C:L,V=v>w?v>T?v:T:w>T?w:T,Z=S>C?S>L?S:L:C>L?C:L,oe=Sm(z,B,t,s,c),de=Sm(V,Z,t,s,c),se=r.prevZ,ue=r.nextZ;se&&se.z>=oe&&ue&&ue.z<=de;){if(se.x>=z&&se.x<=V&&se.y>=B&&se.y<=Z&&se!==d&&se!==_&&Ul(v,S,w,C,T,L,se.x,se.y)&&rn(se.prev,se,se.next)>=0||(se=se.prevZ,ue.x>=z&&ue.x<=V&&ue.y>=B&&ue.y<=Z&&ue!==d&&ue!==_&&Ul(v,S,w,C,T,L,ue.x,ue.y)&&rn(ue.prev,ue,ue.next)>=0))return!1;ue=ue.nextZ}for(;se&&se.z>=oe;){if(se.x>=z&&se.x<=V&&se.y>=B&&se.y<=Z&&se!==d&&se!==_&&Ul(v,S,w,C,T,L,se.x,se.y)&&rn(se.prev,se,se.next)>=0)return!1;se=se.prevZ}for(;ue&&ue.z<=de;){if(ue.x>=z&&ue.x<=V&&ue.y>=B&&ue.y<=Z&&ue!==d&&ue!==_&&Ul(v,S,w,C,T,L,ue.x,ue.y)&&rn(ue.prev,ue,ue.next)>=0)return!1;ue=ue.nextZ}return!0}function V2(r,t,s){var c=r;do{var d=c.prev,m=c.next.next;!af(d,m)&&I0(d,c,c.next,m)&&Fu(d,m)&&Fu(m,d)&&(t.push(d.i/s|0),t.push(c.i/s|0),t.push(m.i/s|0),Nu(c),Nu(c.next),c=r=m),c=c.next}while(c!==r);return Da(c)}function j2(r,t,s,c,d,m){var _=r;do{for(var v=_.next.next;v!==_.prev;){if(_.i!==v.i&&q2(_,v)){var w=C0(_,v);return _=Da(_,_.next),w=Da(w,w.next),Bu(_,t,s,c,d,m,0),void Bu(w,t,s,c,d,m,0)}v=v.next}_=_.next}while(_!==r)}function G2(r,t){return r.x-t.x}function W2(r,t){var s=function(d,m){var _,v=m,w=d.x,T=d.y,S=-1/0;do{if(T<=v.y&&T>=v.next.y&&v.next.y!==v.y){var C=v.x+(T-v.y)*(v.next.x-v.x)/(v.next.y-v.y);if(C<=w&&C>S&&(S=C,_=v.x<v.next.x?v:v.next,C===w))return _}v=v.next}while(v!==m);if(!_)return null;var L,z=_,B=_.x,V=_.y,Z=1/0;v=_;do w>=v.x&&v.x>=B&&w!==v.x&&Ul(T<V?w:S,T,B,V,T<V?S:w,T,v.x,v.y)&&(L=Math.abs(T-v.y)/(w-v.x),Fu(v,d)&&(L<Z||L===Z&&(v.x>_.x||v.x===_.x&&Z2(_,v)))&&(_=v,Z=L)),v=v.next;while(v!==z);return _}(r,t);if(!s)return t;var c=C0(s,r);return Da(c,c.next),Da(s,s.next)}function Z2(r,t){return rn(r.prev,r,t.prev)<0&&rn(t.next,r,r.next)<0}function Sm(r,t,s,c,d){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-s)*d|0)|r<<8))|r<<4))|r<<2))|r<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-c)*d|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function $2(r){var t=r,s=r;do(t.x<s.x||t.x===s.x&&t.y<s.y)&&(s=t),t=t.next;while(t!==r);return s}function Ul(r,t,s,c,d,m,_,v){return(d-_)*(t-v)>=(r-_)*(m-v)&&(r-_)*(c-v)>=(s-_)*(t-v)&&(s-_)*(m-v)>=(d-_)*(c-v)}function q2(r,t){return r.next.i!==t.i&&r.prev.i!==t.i&&!function(s,c){var d=s;do{if(d.i!==s.i&&d.next.i!==s.i&&d.i!==c.i&&d.next.i!==c.i&&I0(d,d.next,s,c))return!0;d=d.next}while(d!==s);return!1}(r,t)&&(Fu(r,t)&&Fu(t,r)&&function(s,c){var d=s,m=!1,_=(s.x+c.x)/2,v=(s.y+c.y)/2;do d.y>v!=d.next.y>v&&d.next.y!==d.y&&_<(d.next.x-d.x)*(v-d.y)/(d.next.y-d.y)+d.x&&(m=!m),d=d.next;while(d!==s);return m}(r,t)&&(rn(r.prev,r,t.prev)||rn(r,t.prev,t))||af(r,t)&&rn(r.prev,r,r.next)>0&&rn(t.prev,t,t.next)>0)}function rn(r,t,s){return(t.y-r.y)*(s.x-t.x)-(t.x-r.x)*(s.y-t.y)}function af(r,t){return r.x===t.x&&r.y===t.y}function I0(r,t,s,c){var d=cf(rn(r,t,s)),m=cf(rn(r,t,c)),_=cf(rn(s,c,r)),v=cf(rn(s,c,t));return d!==m&&_!==v||!(d!==0||!lf(r,s,t))||!(m!==0||!lf(r,c,t))||!(_!==0||!lf(s,r,c))||!(v!==0||!lf(s,t,c))}function lf(r,t,s){return t.x<=Math.max(r.x,s.x)&&t.x>=Math.min(r.x,s.x)&&t.y<=Math.max(r.y,s.y)&&t.y>=Math.min(r.y,s.y)}function cf(r){return r>0?1:r<0?-1:0}function Fu(r,t){return rn(r.prev,r,r.next)<0?rn(r,t,r.next)>=0&&rn(r,r.prev,t)>=0:rn(r,t,r.prev)<0||rn(r,r.next,t)<0}function C0(r,t){var s=new Mm(r.i,r.x,r.y),c=new Mm(t.i,t.x,t.y),d=r.next,m=t.prev;return r.next=t,t.prev=r,s.next=d,d.prev=s,c.next=s,s.prev=c,m.next=c,c.prev=m,c}function L0(r,t,s,c){var d=new Mm(r,t,s);return c?(d.next=c.next,d.prev=c,c.next.prev=d,c.next=d):(d.prev=d,d.next=d),d}function Nu(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Mm(r,t,s){this.i=r,this.x=t,this.y=s,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Pm(r,t,s,c){for(var d=0,m=t,_=s-c;m<s;m+=c)d+=(r[_]-r[m])*(r[m+1]+r[_+1]),_=m;return d}function H2(r,t,s,c,d){k0(r,t,s||0,c||r.length-1,d||X2)}function k0(r,t,s,c,d){for(;c>s;){if(c-s>600){var m=c-s+1,_=t-s+1,v=Math.log(m),w=.5*Math.exp(2*v/3),T=.5*Math.sqrt(v*w*(m-w)/m)*(_-m/2<0?-1:1);k0(r,t,Math.max(s,Math.floor(t-_*w/m+T)),Math.min(c,Math.floor(t+(m-_)*w/m+T)),d)}var S=r[t],C=s,L=c;for(Uu(r,s,t),d(r[c],S)>0&&Uu(r,s,c);C<L;){for(Uu(r,C,L),C++,L--;d(r[C],S)<0;)C++;for(;d(r[L],S)>0;)L--}d(r[s],S)===0?Uu(r,s,L):Uu(r,++L,c),L<=t&&(s=L+1),t<=L&&(c=L-1)}}function Uu(r,t,s){var c=r[t];r[t]=r[s],r[s]=c}function X2(r,t){return r<t?-1:r>t?1:0}function Im(r,t){const s=r.length;if(s<=1)return[r];const c=[];let d,m;for(let _=0;_<s;_++){const v=Kt(r[_]);v!==0&&(r[_].area=Math.abs(v),m===void 0&&(m=v<0),m===v<0?(d&&c.push(d),d=[r[_]]):d.push(r[_]))}if(d&&c.push(d),t>1)for(let _=0;_<c.length;_++)c[_].length<=t||(H2(c[_],t,1,c[_].length-1,Y2),c[_]=c[_].slice(0,t));return c}function Y2(r,t){return t.area-r.area}function Cm(r,t,s){const c=s.patternDependencies;let d=!1;for(const m of t){const _=m.paint.get(`${r}-pattern`);_.isConstant()||(d=!0);const v=_.constantOr(null);v&&(d=!0,c[v.to]=!0,c[v.from]=!0)}return d}function Lm(r,t,s,c,d){const m=d.patternDependencies;for(const _ of t){const v=_.paint.get(`${r}-pattern`).value;if(v.kind!=="constant"){let w=v.evaluate({zoom:c-1},s,{},d.availableImages),T=v.evaluate({zoom:c},s,{},d.availableImages),S=v.evaluate({zoom:c+1},s,{},d.availableImages);w=w&&w.name?w.name:w,T=T&&T.name?T.name:T,S=S&&S.name?S.name:S,m[w]=!0,m[T]=!0,m[S]=!0,s.patterns[_.id]={min:w,mid:T,max:S}}}return s}Ou.exports=of,Ou.exports.default=of,of.deviation=function(r,t,s,c){var d=t&&t.length,m=Math.abs(Pm(r,0,d?t[0]*s:r.length,s));if(d)for(var _=0,v=t.length;_<v;_++)m-=Math.abs(Pm(r,t[_]*s,_<v-1?t[_+1]*s:r.length,s));var w=0;for(_=0;_<c.length;_+=3){var T=c[_]*s,S=c[_+1]*s,C=c[_+2]*s;w+=Math.abs((r[T]-r[C])*(r[S+1]-r[T+1])-(r[T]-r[S])*(r[C+1]-r[T+1]))}return m===0&&w===0?0:Math.abs((w-m)/m)},of.flatten=function(r){for(var t=r[0][0].length,s={vertices:[],holes:[],dimensions:t},c=0,d=0;d<r.length;d++){for(var m=0;m<r[d].length;m++)for(var _=0;_<t;_++)s.vertices.push(r[d][m][_]);d>0&&s.holes.push(c+=r[d-1].length)}return s};class uf{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(s=>s.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ht,this.indexArray=new Hn,this.indexArray2=new Or,this.programConfigurations=new Ia(t.layers,t.zoom),this.segments=new cn,this.segments2=new cn,this.stateDependentLayerIds=this.layers.filter(s=>s.isStateDependent()).map(s=>s.id),this.projection=t.projection}populate(t,s,c,d){this.hasPattern=Cm("fill",this.layers,s);const m=this.layers[0].layout.get("fill-sort-key"),_=[];for(const{feature:v,id:w,index:T,sourceLayerIndex:S}of t){const C=this.layers[0]._featureFilter.needGeometry,L=Ca(v,C);if(!this.layers[0]._featureFilter.filter(new le(this.zoom),L,c))continue;const z=m?m.evaluate(L,{},c,s.availableImages):void 0,B={id:w,properties:v.properties,type:v.type,sourceLayerIndex:S,index:T,geometry:C?L.geometry:vo(v,c,d),patterns:{},sortKey:z};_.push(B)}m&&_.sort((v,w)=>v.sortKey-w.sortKey);for(const v of _){const{geometry:w,index:T,sourceLayerIndex:S}=v;if(this.hasPattern){const C=Lm("fill",this.layers,v,this.zoom,s);this.patternFeatures.push(C)}else this.addFeature(v,w,T,c,{},s.availableImages);s.featureIndex.insert(t[T].feature,w,T,S,this.index)}}update(t,s,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,s,this.stateDependentLayers,c,d)}addFeatures(t,s,c,d,m){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,s,c,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,F2),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,s,c,d,m,_=[]){for(const v of Im(s,500)){let w=0;for(const B of v)w+=B.length;const T=this.segments.prepareSegment(w,this.layoutVertexArray,this.indexArray),S=T.vertexLength,C=[],L=[];for(const B of v){if(B.length===0)continue;B!==v[0]&&L.push(C.length/2);const V=this.segments2.prepareSegment(B.length,this.layoutVertexArray,this.indexArray2),Z=V.vertexLength;this.layoutVertexArray.emplaceBack(B[0].x,B[0].y),this.indexArray2.emplaceBack(Z+B.length-1,Z),C.push(B[0].x),C.push(B[0].y);for(let oe=1;oe<B.length;oe++)this.layoutVertexArray.emplaceBack(B[oe].x,B[oe].y),this.indexArray2.emplaceBack(Z+oe-1,Z+oe),C.push(B[oe].x),C.push(B[oe].y);V.vertexLength+=B.length,V.primitiveLength+=B.length}const z=Ou.exports(C,L);for(let B=0;B<z.length;B+=3)this.indexArray.emplaceBack(S+z[B],S+z[B+1],S+z[B+2]);T.vertexLength+=w,T.primitiveLength+=z.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,c,m,_,d)}}ft(uf,"FillBucket",{omit:["layers","patternFeatures"]});const K2=new nt({"fill-sort-key":new ve(Me.layout_fill["fill-sort-key"])});var J2={paint:new nt({"fill-antialias":new Ie(Me.paint_fill["fill-antialias"]),"fill-opacity":new ve(Me.paint_fill["fill-opacity"]),"fill-color":new ve(Me.paint_fill["fill-color"]),"fill-outline-color":new ve(Me.paint_fill["fill-outline-color"]),"fill-translate":new Ie(Me.paint_fill["fill-translate"]),"fill-translate-anchor":new Ie(Me.paint_fill["fill-translate-anchor"]),"fill-pattern":new lt(Me.paint_fill["fill-pattern"])}),layout:K2};const Q2=rt([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),eE=rt([{name:"a_centroid_pos",components:2,type:"Uint16"}]),tE=rt([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:iE}=Q2;var hf={},nE=Ee,R0=Vl;function Vl(r,t,s,c,d){this.properties={},this.extent=s,this.type=0,this._pbf=r,this._geometry=-1,this._keys=c,this._values=d,r.readFields(rE,this,t)}function rE(r,t,s){r==1?t.id=s.readVarint():r==2?function(c,d){for(var m=c.readVarint()+c.pos;c.pos<m;){var _=d._keys[c.readVarint()],v=d._values[c.readVarint()];d.properties[_]=v}}(s,t):r==3?t.type=s.readVarint():r==4&&(t._geometry=s.pos)}function sE(r){for(var t,s,c=0,d=0,m=r.length,_=m-1;d<m;_=d++)c+=((s=r[_]).x-(t=r[d]).x)*(t.y+s.y);return c}Vl.types=["Unknown","Point","LineString","Polygon"],Vl.prototype.loadGeometry=function(){var r=this._pbf;r.pos=this._geometry;for(var t,s=r.readVarint()+r.pos,c=1,d=0,m=0,_=0,v=[];r.pos<s;){if(d<=0){var w=r.readVarint();c=7&w,d=w>>3}if(d--,c===1||c===2)m+=r.readSVarint(),_+=r.readSVarint(),c===1&&(t&&v.push(t),t=[]),t.push(new nE(m,_));else{if(c!==7)throw new Error("unknown command "+c);t&&t.push(t[0].clone())}}return t&&v.push(t),v},Vl.prototype.bbox=function(){var r=this._pbf;r.pos=this._geometry;for(var t=r.readVarint()+r.pos,s=1,c=0,d=0,m=0,_=1/0,v=-1/0,w=1/0,T=-1/0;r.pos<t;){if(c<=0){var S=r.readVarint();s=7&S,c=S>>3}if(c--,s===1||s===2)(d+=r.readSVarint())<_&&(_=d),d>v&&(v=d),(m+=r.readSVarint())<w&&(w=m),m>T&&(T=m);else if(s!==7)throw new Error("unknown command "+s)}return[_,w,v,T]},Vl.prototype.toGeoJSON=function(r,t,s){var c,d,m=this.extent*Math.pow(2,s),_=this.extent*r,v=this.extent*t,w=this.loadGeometry(),T=Vl.types[this.type];function S(z){for(var B=0;B<z.length;B++){var V=z[B];z[B]=[360*(V.x+_)/m-180,360/Math.PI*Math.atan(Math.exp((180-360*(V.y+v)/m)*Math.PI/180))-90]}}switch(this.type){case 1:var C=[];for(c=0;c<w.length;c++)C[c]=w[c][0];S(w=C);break;case 2:for(c=0;c<w.length;c++)S(w[c]);break;case 3:for(w=function(z){var B=z.length;if(B<=1)return[z];for(var V,Z,oe=[],de=0;de<B;de++){var se=sE(z[de]);se!==0&&(Z===void 0&&(Z=se<0),Z===se<0?(V&&oe.push(V),V=[z[de]]):V.push(z[de]))}return V&&oe.push(V),oe}(w),c=0;c<w.length;c++)for(d=0;d<w[c].length;d++)S(w[c][d])}w.length===1?w=w[0]:T="Multi"+T;var L={type:"Feature",geometry:{type:T,coordinates:w},properties:this.properties};return"id"in this&&(L.id=this.id),L};var oE=R0,D0=z0;function z0(r,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=r,this._keys=[],this._values=[],this._features=[],r.readFields(aE,this,t),this.length=this._features.length}function aE(r,t,s){r===15?t.version=s.readVarint():r===1?t.name=s.readString():r===5?t.extent=s.readVarint():r===2?t._features.push(s.pos):r===3?t._keys.push(s.readString()):r===4&&t._values.push(function(c){for(var d=null,m=c.readVarint()+c.pos;c.pos<m;){var _=c.readVarint()>>3;d=_===1?c.readString():_===2?c.readFloat():_===3?c.readDouble():_===4?c.readVarint64():_===5?c.readVarint():_===6?c.readSVarint():_===7?c.readBoolean():null}return d}(s))}z0.prototype.feature=function(r){if(r<0||r>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[r];var t=this._pbf.readVarint()+this._pbf.pos;return new oE(this._pbf,t,this.extent,this._keys,this._values)};var lE=D0;function cE(r,t,s){if(r===3){var c=new lE(s,s.readVarint()+s.pos);c.length&&(t[c.name]=c)}}var km=hf.VectorTile=function(r,t){this.layers=r.readFields(cE,{},t)},df=hf.VectorTileFeature=R0;function ff(r,t,s,c){const d=[],m=c===0?(_,v,w,T,S,C)=>{_.push(new Ee(C,w+(C-v)/(T-v)*(S-w)))}:(_,v,w,T,S,C)=>{_.push(new Ee(v+(C-w)/(S-w)*(T-v),C))};for(const _ of r){const v=[];for(const w of _){if(w.length<=2)continue;const T=[];for(let L=0;L<w.length-1;L++){const z=w[L].x,B=w[L].y,V=w[L+1].x,Z=w[L+1].y,oe=c===0?z:B,de=c===0?V:Z;oe<t?de>t&&m(T,z,B,V,Z,t):oe>s?de<s&&m(T,z,B,V,Z,s):T.push(w[L]),de<t&&oe>=t&&m(T,z,B,V,Z,t),de>s&&oe<=s&&m(T,z,B,V,Z,s)}let S=w[w.length-1];const C=c===0?S.x:S.y;C>=t&&C<=s&&T.push(S),T.length&&(S=T[T.length-1],T[0].x===S.x&&T[0].y===S.y||T.push(T[0]),v.push(T))}v.length&&d.push(v)}return d}hf.VectorTileLayer=D0;const uE=df.types,hE=Math.pow(2,13);function Vu(r,t,s,c,d,m,_,v){r.emplaceBack((t<<1)+_,(s<<1)+m,(Math.floor(c*hE)<<1)+d,Math.round(v))}function ju(r,t,s){r.emplaceBack(t.x,t.y,t.z,s[0]*16384,s[1]*16384,s[2]*16384)}class O0{constructor(){this.acc=new Ee(0,0),this.polyCount=[]}startRing(t){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new Ee(t.x,t.y),this.max=new Ee(t.x,t.y))}append(t,s){this.currentPolyCount.edges++,this.acc._add(t);const c=this.min,d=this.max;t.x<c.x?c.x=t.x:t.x>d.x&&(d.x=t.x),t.y<c.y?c.y=t.y:t.y>d.y&&(d.y=t.y),((t.x===0||t.x===zt)&&t.x===s.x)!=((t.y===0||t.y===zt)&&t.y===s.y)&&this.processBorderOverlap(t,s),s.x<0!=t.x<0&&this.addBorderIntersection(0,ai(s.y,t.y,(0-s.x)/(t.x-s.x))),s.x>zt!=t.x>zt&&this.addBorderIntersection(1,ai(s.y,t.y,(zt-s.x)/(t.x-s.x))),s.y<0!=t.y<0&&this.addBorderIntersection(2,ai(s.x,t.x,(0-s.y)/(t.y-s.y))),s.y>zt!=t.y>zt&&this.addBorderIntersection(3,ai(s.x,t.x,(zt-s.y)/(t.y-s.y)))}addBorderIntersection(t,s){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const c=this.borders[t];s<c[0]&&(c[0]=s),s>c[1]&&(c[1]=s)}processBorderOverlap(t,s){if(t.x===s.x){if(t.y===s.y)return;const c=t.x===0?0:1;this.addBorderIntersection(c,s.y),this.addBorderIntersection(c,t.y)}else{const c=t.y===0?2:3;this.addBorderIntersection(c,s.x),this.addBorderIntersection(c,t.x)}}centroid(){const t=this.polyCount.reduce((s,c)=>s+c.edges,0);return t!==0?this.acc.div(t)._round():new Ee(0,0)}span(){return new Ee(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((t,s)=>t+ +(s[0]!==Number.MAX_VALUE),0)}}class Gu{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(s=>s.id),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.layoutVertexArray=new wi,this.centroidVertexArray=new jy,this.indexArray=new Hn,this.programConfigurations=new Ia(t.layers,t.zoom),this.segments=new cn,this.stateDependentLayerIds=this.layers.filter(s=>s.isStateDependent()).map(s=>s.id),this.enableTerrain=t.enableTerrain}populate(t,s,c,d){this.features=[],this.hasPattern=Cm("fill-extrusion",this.layers,s),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=function(m){const _=Math.exp(Math.PI*(1-m.y/(1<<m.z)*2));return 80150034*_/(_*_+1)/zt/(1<<m.z)}(c),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:m,id:_,index:v,sourceLayerIndex:w}of t){const T=this.layers[0]._featureFilter.needGeometry,S=Ca(m,T);if(!this.layers[0]._featureFilter.filter(new le(this.zoom),S,c))continue;const C={id:_,sourceLayerIndex:w,index:v,geometry:T?S.geometry:vo(m,c,d),properties:m.properties,type:m.type,patterns:{}},L=this.layoutVertexArray.length;this.hasPattern?this.features.push(Lm("fill-extrusion",this.layers,C,this.zoom,s)):this.addFeature(C,C.geometry,v,c,{},s.availableImages,d),s.featureIndex.insert(m,C.geometry,v,w,this.index,L)}this.sortBorders()}addFeatures(t,s,c,d,m){for(const _ of this.features){const{geometry:v}=_;this.addFeature(_,v,_.index,s,c,d,m)}this.sortBorders()}update(t,s,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,s,this.stateDependentLayers,c,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,iE),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,tE.members,!0))),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,eE.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,s,c,d,m,_,v){const w=[new Ee(0,0),new Ee(zt,zt)],T=v.projection,S=T.name==="globe",C=this.enableTerrain&&!S?new O0:null,L=uE[t.type]==="Polygon";S&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ly);const z=Im(s,500);for(let oe=z.length-1;oe>=0;oe--){const de=z[oe];(de.length===0||(B=de[0]).every(se=>se.x<=0)||B.every(se=>se.x>=zt)||B.every(se=>se.y<=0)||B.every(se=>se.y>=zt))&&z.splice(oe,1)}var B;let V;if(S)V=G0(z,w,d);else{V=[];for(const oe of z)V.push({polygon:oe,bounds:w})}const Z=L?this.edgeRadius:0;for(const{polygon:oe,bounds:de}of V){let se=0,ue=0;for(const pe of oe)L&&!pe[0].equals(pe[pe.length-1])&&pe.push(pe[0]),ue+=L?pe.length-1:pe.length;const ye=this.segments.prepareSegment((L?5:4)*ue,this.layoutVertexArray,this.indexArray);if(L){const pe=[],Re=[];se=ye.vertexLength;for(const Ne of oe){let Je,Be;Ne.length&&Ne!==oe[0]&&Re.push(pe.length/2),Je=Ne[1].sub(Ne[0])._perp()._unit();for(let qe=1;qe<Ne.length;qe++){const He=Ne[qe],Ye=Ne[qe===Ne.length-1?1:qe+1];let{x:Qe,y:Ue}=He;if(Z){Be=Ye.sub(He)._perp()._unit();const mt=Je.add(Be)._unit(),Ot=Z*Math.min(4,1/(Je.x*mt.x+Je.y*mt.y));Qe+=Ot*mt.x,Ue+=Ot*mt.y,Je=Be}Vu(this.layoutVertexArray,Qe,Ue,0,0,1,1,0),ye.vertexLength++,pe.push(He.x,He.y),S&&ju(this.layoutVertexExtArray,T.projectTilePoint(Qe,Ue,d),T.upVector(d,Qe,Ue))}}const Le=Ou.exports(pe,Re);for(let Ne=0;Ne<Le.length;Ne+=3)this.indexArray.emplaceBack(se+Le[Ne],se+Le[Ne+2],se+Le[Ne+1]),ye.primitiveLength++}for(const pe of oe){C&&pe.length&&C.startRing(pe[0]);let Re,Le,Ne,Je=pe.length>4&&U0(pe[pe.length-2],pe[0],pe[1]),Be=Z?dE(pe[pe.length-2],pe[0],pe[1],Z):0;Le=pe[1].sub(pe[0])._perp()._unit();let qe=!0;for(let He=1,Ye=0;He<pe.length;He++){let Qe=pe[He-1],Ue=pe[He];const mt=pe[He===pe.length-1?1:He+1];if(C&&L&&C.currentPolyCount.top++,N0(Ue,Qe,de)){Z&&(Le=mt.sub(Ue)._perp()._unit(),qe=!qe);continue}C&&C.append(Ue,Qe);const Ot=Ue.sub(Qe)._perp(),bt=Ot.x/(Math.abs(Ot.x)+Math.abs(Ot.y)),_t=Ot.y>0?1:0,ct=Qe.dist(Ue);if(Ye+ct>32768&&(Ye=0),Z){Ne=mt.sub(Ue)._perp()._unit();let li=F0(Qe,Ue,mt,B0(Le,Ne),Z);isNaN(li)&&(li=0);const Nt=Ue.sub(Qe)._unit();Qe=Qe.add(Nt.mult(Be))._round(),Ue=Ue.add(Nt.mult(-li))._round(),Be=li,Le=Ne}const Dt=ye.vertexLength,Gt=pe.length>4&&U0(Qe,Ue,mt);let Wt=V0(Ye,Je,qe);if(Vu(this.layoutVertexArray,Qe.x,Qe.y,bt,_t,0,0,Wt),Vu(this.layoutVertexArray,Qe.x,Qe.y,bt,_t,0,1,Wt),Ye+=ct,Wt=V0(Ye,Gt,!qe),Je=Gt,Vu(this.layoutVertexArray,Ue.x,Ue.y,bt,_t,0,0,Wt),Vu(this.layoutVertexArray,Ue.x,Ue.y,bt,_t,0,1,Wt),ye.vertexLength+=4,this.indexArray.emplaceBack(Dt+0,Dt+1,Dt+2),this.indexArray.emplaceBack(Dt+1,Dt+3,Dt+2),ye.primitiveLength+=2,Z){const li=se+(He===1?pe.length-2:He-2),Nt=He===1?se:li+1;if(this.indexArray.emplaceBack(Dt+1,li,Dt+3),this.indexArray.emplaceBack(li,Nt,Dt+3),ye.primitiveLength+=2,Re===void 0&&(Re=Dt),!N0(mt,pe[He],de)){const zi=He===pe.length-1?Re:ye.vertexLength;this.indexArray.emplaceBack(Dt+2,Dt+3,zi),this.indexArray.emplaceBack(Dt+3,zi+1,zi),this.indexArray.emplaceBack(Dt+3,Nt,zi+1),ye.primitiveLength+=3}qe=!qe}if(S){const li=this.layoutVertexExtArray,Nt=T.projectTilePoint(Qe.x,Qe.y,d),zi=T.projectTilePoint(Ue.x,Ue.y,d),Xt=T.upVector(d,Qe.x,Qe.y),ei=T.upVector(d,Ue.x,Ue.y);ju(li,Nt,Xt),ju(li,Nt,Xt),ju(li,zi,ei),ju(li,zi,ei)}}L&&(se+=pe.length-1)}}if(C&&C.polyCount.length>0){if(C.borders){C.vertexArrayOffset=this.centroidVertexArray.length;const oe=C.borders,de=this.featuresOnBorder.push(C)-1;for(let se=0;se<4;se++)oe[se][0]!==Number.MAX_VALUE&&this.borders[se].push(de)}this.encodeCentroid(C.borders?void 0:C.centroid(),C)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,c,m,_,d)}sortBorders(){for(let t=0;t<4;t++)this.borders[t].sort((s,c)=>this.featuresOnBorder[s].borders[t][0]-this.featuresOnBorder[c].borders[t][0])}encodeCentroid(t,s,c=!0){let d,m;if(t)if(t.y!==0){const v=s.span()._mult(this.tileToMeter);d=(Math.max(t.x,1)<<3)+Math.min(7,Math.round(v.x/10)),m=(Math.max(t.y,1)<<3)+Math.min(7,Math.round(v.y/10))}else d=Math.ceil(7*(t.x+450)),m=0;else d=0,m=+c;let _=c?this.centroidVertexArray.length:s.vertexArrayOffset;for(const v of s.polyCount){c&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*v.edges+v.top);for(let w=0;w<v.top;w++)this.centroidVertexArray.emplace(_++,d,m);for(let w=0;w<2*v.edges;w++)this.centroidVertexArray.emplace(_++,0,m),this.centroidVertexArray.emplace(_++,d,m)}}}function B0(r,t){const s=r.add(t)._unit();return r.x*s.x+r.y*s.y}function dE(r,t,s,c){const d=t.sub(r)._perp()._unit(),m=s.sub(t)._perp()._unit();return F0(r,t,s,B0(d,m),c)}function F0(r,t,s,c,d){const m=Math.sqrt(1-c*c);return Math.min(r.dist(t)/3,t.dist(s)/3,d*m/c)}function N0(r,t,s){return r.x<s[0].x&&t.x<s[0].x||r.x>s[1].x&&t.x>s[1].x||r.y<s[0].y&&t.y<s[0].y||r.y>s[1].y&&t.y>s[1].y}function U0(r,t,s){if(r.x<0||r.x>=zt||t.x<0||t.x>=zt||s.x<0||s.x>=zt)return!1;const c=s.sub(t),d=c.perp(),m=r.sub(t);return(c.x*m.x+c.y*m.y)/Math.sqrt((c.x*c.x+c.y*c.y)*(m.x*m.x+m.y*m.y))>-.866&&d.x*m.x+d.y*m.y<0}function V0(r,t,s){const c=t?2|r:-3&r;return s?1|c:-2&c}function j0(){const r=Math.PI/32,t=Math.tan(r),s=Qd;return s*Math.sqrt(1+2*t*t)-s}function G0(r,t,s){const c=1<<s.z,d=Br(s.x/c),m=Br((s.x+1)/c),_=Vn(s.y/c),v=Vn((s.y+1)/c);return function(w,T,S,C,L=0,z){const B=[];if(!w.length||!S||!C)return B;const V=(pe,Re)=>{for(const Le of pe)B.push({polygon:Le,bounds:Re})},Z=Math.ceil(Math.log2(S)),oe=Math.ceil(Math.log2(C)),de=Z-oe,se=[];for(let pe=0;pe<Math.abs(de);pe++)se.push(de>0?0:1);for(let pe=0;pe<Math.min(Z,oe);pe++)se.push(0),se.push(1);let ue=w;if(ue=ff(ue,T[0].y-L,T[1].y+L,1),ue=ff(ue,T[0].x-L,T[1].x+L,0),!ue.length)return B;const ye=[];for(se.length?ye.push({polygons:ue,bounds:T,depth:0}):V(ue,T);ye.length;){const pe=ye.pop(),Re=pe.depth,Le=se[Re],Ne=pe.bounds[0],Je=pe.bounds[1],Be=Le===0?Ne.x:Ne.y,qe=Le===0?Je.x:Je.y,He=z?z(Le,Be,qe):.5*(Be+qe),Ye=ff(pe.polygons,Be-L,He+L,Le),Qe=ff(pe.polygons,He-L,qe+L,Le);if(Ye.length){const Ue=[Ne,new Ee(Le===0?He:Je.x,Le===1?He:Je.y)];se.length>Re+1?ye.push({polygons:Ye,bounds:Ue,depth:Re+1}):V(Ye,Ue)}if(Qe.length){const Ue=[new Ee(Le===0?He:Ne.x,Le===1?He:Ne.y),Je];se.length>Re+1?ye.push({polygons:Qe,bounds:Ue,depth:Re+1}):V(Qe,Ue)}}return B}(r,t,Math.ceil((m-d)/11.25),Math.ceil((_-v)/11.25),1,(w,T,S)=>{if(w===0)return .5*(T+S);{const C=Vn((s.y+T/zt)/c);return(qs(.5*(Vn((s.y+S/zt)/c)+C))*c-s.y)*zt}})}ft(Gu,"FillExtrusionBucket",{omit:["layers","features"]}),ft(O0,"PartMetadata");const fE=new nt({"fill-extrusion-edge-radius":new Ie(Me["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var pE={paint:new nt({"fill-extrusion-opacity":new Ie(Me["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ve(Me["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ie(Me["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ie(Me["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new lt(Me["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new ve(Me["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ve(Me["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ie(Me["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Ie(Me["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Ie(Me["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"])}),layout:fE};function W0(r,t,s){var c=2*Math.PI*6378137/256/Math.pow(2,s);return[r*c-2*Math.PI*6378137/2,t*c-2*Math.PI*6378137/2]}class pf{constructor(t,s,c){this.z=t,this.x=s,this.y=c,this.key=Wu(0,t,t,s,c)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,s){const c=function(m,_,v){var w=W0(256*m,256*(_=Math.pow(2,v)-_-1),v),T=W0(256*(m+1),256*(_+1),v);return w[0]+","+w[1]+","+T[0]+","+T[1]}(this.x,this.y,this.z),d=function(m,_,v){let w,T="";for(let S=m;S>0;S--)w=1<<S-1,T+=(_&w?1:0)+(v&w?2:0);return T}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(s==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",d).replace("{bbox-epsg-3857}",c)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Z0{constructor(t,s){this.wrap=t,this.canonical=s,this.key=Wu(t,s.z,s.z,s.x,s.y)}}class or{constructor(t,s,c,d,m){this.overscaledZ=t,this.wrap=s,this.canonical=new pf(c,+d,+m),this.key=s===0&&t===c?this.canonical.key:Wu(s,t,c,d,m)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const s=this.canonical.z-t;return t>this.canonical.z?new or(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new or(t,this.wrap,t,this.canonical.x>>s,this.canonical.y>>s)}calculateScaledKey(t,s=!0){if(this.overscaledZ===t&&s)return this.key;if(t>this.canonical.z)return Wu(this.wrap*+s,t,this.canonical.z,this.canonical.x,this.canonical.y);{const c=this.canonical.z-t;return Wu(this.wrap*+s,t,t,this.canonical.x>>c,this.canonical.y>>c)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const s=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>s&&t.canonical.y===this.canonical.y>>s}children(t){if(this.overscaledZ>=t)return[new or(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const s=this.canonical.z+1,c=2*this.canonical.x,d=2*this.canonical.y;return[new or(s,this.wrap,s,c,d),new or(s,this.wrap,s,c+1,d),new or(s,this.wrap,s,c,d+1),new or(s,this.wrap,s,c+1,d+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new or(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new or(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Z0(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Wu(r,t,s,c,d){const m=1<<Math.min(s,22);let _=m*(d%m)+c%m;return r&&s<22&&(_+=m*m*((r<0?-2*r-1:2*r)%(1<<2*(22-s)))),16*(32*_+s)+(t-s)}ft(pf,"CanonicalTileID"),ft(or,"OverscaledTileID",{omit:["projMatrix"]});class jl extends Ee{constructor(t,s,c){super(t,s),this.z=c}}function Zu(r,t){return r.x*t.x+r.y*t.y}function $0(r,t){if(r.length===1){let s=0;const c=t[s++];let d;for(;!d||c.equals(d);)if(d=t[s++],!d)return 1/0;for(;s<t.length;s++){const m=t[s],_=r[0],v=d.sub(c),w=m.sub(c),T=_.sub(c),S=Zu(v,v),C=Zu(v,w),L=Zu(w,w),z=Zu(T,v),B=Zu(T,w),V=S*L-C*C,Z=(L*z-C*B)/V,oe=(S*B-C*z)/V,de=c.z*(1-Z-oe)+d.z*Z+m.z*oe;if(isFinite(de))return de}return 1/0}{let s=1/0;for(const c of t)s=Math.min(s,c.z);return s}}function q0(r,t,s,c,d,m,_,v){const w=_*d.getElevationAt(r,t,!0,!0),T=m[0]!==0,S=T?m[1]===0?_*(m[0]/7-450):_*function(C,L,z){const B=Math.floor(L[0]/8),V=Math.floor(L[1]/8),Z=10*(L[0]-8*B),oe=10*(L[1]-8*V),de=C.getElevationAt(B,V,!0,!0),se=C.getMeterToDEM(z),ue=Math.floor(.5*(Z*se-1)),ye=Math.floor(.5*(oe*se-1)),pe=C.tileCoordToPixel(B,V),Re=2*ue+1,Le=2*ye+1,Ne=function(Qe,Ue,mt,Ot,bt){return[Qe.getElevationAtPixel(Ue,mt,!0),Qe.getElevationAtPixel(Ue+bt,mt,!0),Qe.getElevationAtPixel(Ue,mt+bt,!0),Qe.getElevationAtPixel(Ue+Ot,mt+bt,!0)]}(C,pe.x-ue,pe.y-ye,Re,Le),Je=Math.abs(Ne[0]-Ne[1]),Be=Math.abs(Ne[2]-Ne[3]),qe=Math.abs(Ne[0]-Ne[2])+Math.abs(Ne[1]-Ne[3]),He=Math.min(.25,.5*se*(Je+Be)/Re),Ye=Math.min(.25,.5*se*qe/Le);return de+Math.max(He*Z,Ye*oe)}(d,m,v):w;return{base:w+(s===0)?-1:s,top:T?Math.max(S+c,w+s+2):w+c}}const mE=rt([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:gE}=mE,_E=rt([{name:"a_packed",components:4,type:"Float32"}]),{members:yE}=_E,xE=df.types,vE=Math.cos(Math.PI/180*37.5);class mf{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(s=>s.id),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(s=>{this.gradients[s.id]={}}),this.layoutVertexArray=new _i,this.layoutVertexArray2=new xn,this.indexArray=new Hn,this.programConfigurations=new Ia(t.layers,t.zoom),this.segments=new cn,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(s=>s.isStateDependent()).map(s=>s.id)}populate(t,s,c,d){this.hasPattern=Cm("line",this.layers,s);const m=this.layers[0].layout.get("line-sort-key"),_=[];for(const{feature:S,id:C,index:L,sourceLayerIndex:z}of t){const B=this.layers[0]._featureFilter.needGeometry,V=Ca(S,B);if(!this.layers[0]._featureFilter.filter(new le(this.zoom),V,c))continue;const Z=m?m.evaluate(V,{},c):void 0,oe={id:C,properties:S.properties,type:S.type,sourceLayerIndex:z,index:L,geometry:B?V.geometry:vo(S,c,d),patterns:{},sortKey:Z};_.push(oe)}m&&_.sort((S,C)=>S.sortKey-C.sortKey);const{lineAtlas:v,featureIndex:w}=s,T=this.addConstantDashes(v);for(const S of _){const{geometry:C,index:L,sourceLayerIndex:z}=S;if(T&&this.addFeatureDashes(S,v),this.hasPattern){const B=Lm("line",this.layers,S,this.zoom,s);this.patternFeatures.push(B)}else this.addFeature(S,C,L,c,v.positions,s.availableImages);w.insert(t[L].feature,C,L,z,this.index)}}addConstantDashes(t){let s=!1;for(const c of this.layers){const d=c.paint.get("line-dasharray").value,m=c.layout.get("line-cap").value;if(d.kind!=="constant"||m.kind!=="constant")s=!0;else{const _=m.value,v=d.value;if(!v)continue;t.addDash(v.from,_),t.addDash(v.to,_),v.other&&t.addDash(v.other,_)}}return s}addFeatureDashes(t,s){const c=this.zoom;for(const d of this.layers){const m=d.paint.get("line-dasharray").value,_=d.layout.get("line-cap").value;if(m.kind==="constant"&&_.kind==="constant")continue;let v,w,T,S,C,L;if(m.kind==="constant"){const Z=m.value;if(!Z)continue;v=Z.other||Z.to,w=Z.to,T=Z.from}else v=m.evaluate({zoom:c-1},t),w=m.evaluate({zoom:c},t),T=m.evaluate({zoom:c+1},t);_.kind==="constant"?S=C=L=_.value:(S=_.evaluate({zoom:c-1},t),C=_.evaluate({zoom:c},t),L=_.evaluate({zoom:c+1},t)),s.addDash(v,S),s.addDash(w,C),s.addDash(T,L);const z=s.getKey(v,S),B=s.getKey(w,C),V=s.getKey(T,L);t.patterns[d.id]={min:z,mid:B,max:V}}}update(t,s,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,s,this.stateDependentLayers,c,d)}addFeatures(t,s,c,d,m){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,s,c,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,yE)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,gE),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,s,c,d,m,_){const v=this.layers[0].layout,w=v.get("line-join").evaluate(t,{}),T=v.get("line-cap").evaluate(t,{}),S=v.get("line-miter-limit"),C=v.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const L of s)this.addLine(L,t,w,T,S,C);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,c,m,_,d)}addLine(t,s,c,d,m,_){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let oe=0;oe<t.length-1;oe++)this.totalDistance+=t[oe].dist(t[oe+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const v=xE[s.type]==="Polygon";let w=t.length;for(;w>=2&&t[w-1].equals(t[w-2]);)w--;let T=0;for(;T<w-1&&t[T].equals(t[T+1]);)T++;if(w<(v?3:2))return;c==="bevel"&&(m=1.05);const S=this.overscaling<=16?122880/(512*this.overscaling):0,C=this.segments.prepareSegment(10*w,this.layoutVertexArray,this.indexArray);let L,z,B,V,Z;this.e1=this.e2=-1,v&&(L=t[w-2],Z=t[T].sub(L)._unit()._perp());for(let oe=T;oe<w;oe++){if(B=oe===w-1?v?t[T+1]:void 0:t[oe+1],B&&t[oe].equals(B))continue;Z&&(V=Z),L&&(z=L),L=t[oe],Z=B?B.sub(L)._unit()._perp():V,V=V||Z;let de=V.add(Z);de.x===0&&de.y===0||de._unit();const se=V.x*Z.x+V.y*Z.y,ue=de.x*Z.x+de.y*Z.y,ye=ue!==0?1/ue:1/0,pe=2*Math.sqrt(2-2*ue),Re=ue<vE&&z&&B,Le=V.x*Z.y-V.y*Z.x>0;if(Re&&oe>T){const Be=L.dist(z);if(Be>2*S){const qe=L.sub(L.sub(z)._mult(S/Be)._round());this.updateDistance(z,qe),this.addCurrentVertex(qe,V,0,0,C),z=qe}}const Ne=z&&B;let Je=Ne?c:v?"butt":d;if(Ne&&Je==="round"&&(ye<_?Je="miter":ye<=2&&(Je="fakeround")),Je==="miter"&&ye>m&&(Je="bevel"),Je==="bevel"&&(ye>2&&(Je="flipbevel"),ye<m&&(Je="miter")),z&&this.updateDistance(z,L),Je==="miter")de._mult(ye),this.addCurrentVertex(L,de,0,0,C);else if(Je==="flipbevel"){if(ye>100)de=Z.mult(-1);else{const Be=ye*V.add(Z).mag()/V.sub(Z).mag();de._perp()._mult(Be*(Le?-1:1))}this.addCurrentVertex(L,de,0,0,C),this.addCurrentVertex(L,de.mult(-1),0,0,C)}else if(Je==="bevel"||Je==="fakeround"){const Be=-Math.sqrt(ye*ye-1),qe=Le?Be:0,He=Le?0:Be;if(z&&this.addCurrentVertex(L,V,qe,He,C),Je==="fakeround"){const Ye=Math.round(180*pe/Math.PI/20);for(let Qe=1;Qe<Ye;Qe++){let Ue=Qe/Ye;if(Ue!==.5){const Ot=Ue-.5;Ue+=Ue*Ot*(Ue-1)*((1.0904+se*(se*(3.55645-1.43519*se)-3.2452))*Ot*Ot+(.848013+se*(.215638*se-1.06021)))}const mt=Z.sub(V)._mult(Ue)._add(V)._unit()._mult(Le?-1:1);this.addHalfVertex(L,mt.x,mt.y,!1,Le,0,C)}}B&&this.addCurrentVertex(L,Z,-qe,-He,C)}else if(Je==="butt")this.addCurrentVertex(L,de,0,0,C);else if(Je==="square"){const Be=z?1:-1;z||this.addCurrentVertex(L,de,Be,Be,C),this.addCurrentVertex(L,de,0,0,C),z&&this.addCurrentVertex(L,de,Be,Be,C)}else Je==="round"&&(z&&(this.addCurrentVertex(L,V,0,0,C),this.addCurrentVertex(L,V,1,1,C,!0)),B&&(this.addCurrentVertex(L,Z,-1,-1,C,!0),this.addCurrentVertex(L,Z,0,0,C)));if(Re&&oe<w-1){const Be=L.dist(B);if(Be>2*S){const qe=L.add(B.sub(L)._mult(S/Be)._round());this.updateDistance(L,qe),this.addCurrentVertex(qe,Z,0,0,C),L=qe}}}}addCurrentVertex(t,s,c,d,m,_=!1){const v=s.y*d-s.x,w=-s.y-s.x*d;this.addHalfVertex(t,s.x+s.y*c,s.y-s.x*c,_,!1,c,m),this.addHalfVertex(t,v,w,_,!0,-d,m)}addHalfVertex({x:t,y:s},c,d,m,_,v,w){this.layoutVertexArray.emplaceBack((t<<1)+(m?1:0),(s<<1)+(_?1:0),Math.round(63*c)+128,Math.round(63*d)+128,1+(v===0?0:v<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const T=w.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,T),w.primitiveLength++),_?this.e2=T:this.e1=T}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,s){this.distance+=t.dist(s),this.updateScaledDistance()}}ft(mf,"LineBucket",{omit:["layers","patternFeatures"]});const bE=new nt({"line-cap":new ve(Me.layout_line["line-cap"]),"line-join":new ve(Me.layout_line["line-join"]),"line-miter-limit":new Ie(Me.layout_line["line-miter-limit"]),"line-round-limit":new Ie(Me.layout_line["line-round-limit"]),"line-sort-key":new ve(Me.layout_line["line-sort-key"])});var H0={paint:new nt({"line-opacity":new ve(Me.paint_line["line-opacity"]),"line-color":new ve(Me.paint_line["line-color"]),"line-translate":new Ie(Me.paint_line["line-translate"]),"line-translate-anchor":new Ie(Me.paint_line["line-translate-anchor"]),"line-width":new ve(Me.paint_line["line-width"]),"line-gap-width":new ve(Me.paint_line["line-gap-width"]),"line-offset":new ve(Me.paint_line["line-offset"]),"line-blur":new ve(Me.paint_line["line-blur"]),"line-dasharray":new lt(Me.paint_line["line-dasharray"]),"line-pattern":new lt(Me.paint_line["line-pattern"]),"line-gradient":new at(Me.paint_line["line-gradient"]),"line-trim-offset":new Ie(Me.paint_line["line-trim-offset"])}),layout:bE};const X0=new class extends ve{possiblyEvaluate(r,t){return t=new le(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,zoomHistory:t.zoomHistory,transition:t.transition}),super.possiblyEvaluate(r,t)}evaluate(r,t,s,c){return t=ni({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(r,t,s,c)}}(H0.paint.properties["line-width"].specification);function Y0(r,t){return t>0?t+2*r:r}X0.useIntegerZoom=!0;const wE=rt([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),TE=rt([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),EE=rt([{name:"a_projected_pos",components:4,type:"Float32"}],4);rt([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const AE=rt([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),SE=rt([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);rt([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const K0=rt([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),ME=rt([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);rt([{name:"triangle",components:3,type:"Uint16"}]),rt([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),rt([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),rt([{type:"Float32",name:"offsetX"}]),rt([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var jn=24;const Ys=128;function Rm(r,t){const{expression:s}=t;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new le(r+1))};if(s.kind==="source")return{kind:"source"};{const{zoomStops:c,interpolationType:d}=s;let m=0;for(;m<c.length&&c[m]<=r;)m++;m=Math.max(0,m-1);let _=m;for(;_<c.length&&c[_]<r+1;)_++;_=Math.min(c.length-1,_);const v=c[m],w=c[_];return s.kind==="composite"?{kind:"composite",minZoom:v,maxZoom:w,interpolationType:d}:{kind:"camera",minZoom:v,maxZoom:w,minSize:s.evaluate(new le(v)),maxSize:s.evaluate(new le(w)),interpolationType:d}}}function gf(r,{uSize:t,uSizeT:s},{lowerSize:c,upperSize:d}){return r.kind==="source"?c/Ys:r.kind==="composite"?ai(c/Ys,d/Ys,s):t}function Gl(r,t){let s=0,c=0;if(r.kind==="constant")c=r.layoutSize;else if(r.kind!=="source"){const{interpolationType:d,minZoom:m,maxZoom:_}=r,v=d?Lt(as.interpolationFactor(d,t,m,_),0,1):0;r.kind==="camera"?c=ai(r.minSize,r.maxSize,v):s=v}return{uSizeT:s,uSize:c}}var PE=Object.freeze({__proto__:null,getSizeData:Rm,evaluateSizeForFeature:gf,evaluateSizeForZoom:Gl,SIZE_PACK_FACTOR:Ys});function IE(r,t,s){return r.sections.forEach(c=>{c.text=function(d,m,_){const v=m.layout.get("text-transform").evaluate(_,{});return v==="uppercase"?d=d.toLocaleUpperCase():v==="lowercase"&&(d=d.toLocaleLowerCase()),fe.applyArabicShaping&&(d=fe.applyArabicShaping(d)),d}(c.text,t,s)}),r}const $u={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};function CE(r){return r==="\uFE36"||r==="\uFE48"||r==="\uFE38"||r==="\uFE44"||r==="\uFE42"||r==="\uFE3E"||r==="\uFE3C"||r==="\uFE3A"||r==="\uFE18"||r==="\uFE40"||r==="\uFE10"||r==="\uFE13"||r==="\uFE14"||r==="\uFF40"||r==="\uFFE3"||r==="\uFE11"||r==="\uFE12"}function LE(r){return r==="\uFE35"||r==="\uFE47"||r==="\uFE37"||r==="\uFE43"||r==="\uFE41"||r==="\uFE3D"||r==="\uFE3B"||r==="\uFE39"||r==="\uFE17"||r==="\uFE3F"}var qu=Ci,J0=function(r,t,s,c,d){var m,_,v=8*d-c-1,w=(1<<v)-1,T=w>>1,S=-7,C=s?d-1:0,L=s?-1:1,z=r[t+C];for(C+=L,m=z&(1<<-S)-1,z>>=-S,S+=v;S>0;m=256*m+r[t+C],C+=L,S-=8);for(_=m&(1<<-S)-1,m>>=-S,S+=c;S>0;_=256*_+r[t+C],C+=L,S-=8);if(m===0)m=1-T;else{if(m===w)return _?NaN:1/0*(z?-1:1);_+=Math.pow(2,c),m-=T}return(z?-1:1)*_*Math.pow(2,m-c)},Q0=function(r,t,s,c,d,m){var _,v,w,T=8*m-d-1,S=(1<<T)-1,C=S>>1,L=d===23?Math.pow(2,-24)-Math.pow(2,-77):0,z=c?0:m-1,B=c?1:-1,V=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(v=isNaN(t)?1:0,_=S):(_=Math.floor(Math.log(t)/Math.LN2),t*(w=Math.pow(2,-_))<1&&(_--,w*=2),(t+=_+C>=1?L/w:L*Math.pow(2,1-C))*w>=2&&(_++,w/=2),_+C>=S?(v=0,_=S):_+C>=1?(v=(t*w-1)*Math.pow(2,d),_+=C):(v=t*Math.pow(2,C-1)*Math.pow(2,d),_=0));d>=8;r[s+z]=255&v,z+=B,v/=256,d-=8);for(_=_<<d|v,T+=d;T>0;r[s+z]=255&_,z+=B,_/=256,T-=8);r[s+z-B]|=128*V};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function Ci(r){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(r)?r:new Uint8Array(r||0),this.pos=0,this.type=0,this.length=this.buf.length}Ci.Varint=0,Ci.Fixed64=1,Ci.Bytes=2,Ci.Fixed32=5;var Dm=4294967296,ex=1/Dm,tx=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function To(r){return r.type===Ci.Bytes?r.readVarint()+r.pos:r.pos+1}function Wl(r,t,s){return s?4294967296*t+(r>>>0):4294967296*(t>>>0)+(r>>>0)}function ix(r,t,s){var c=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));s.realloc(c);for(var d=s.pos-1;d>=r;d--)s.buf[d+c]=s.buf[d]}function kE(r,t){for(var s=0;s<r.length;s++)t.writeVarint(r[s])}function RE(r,t){for(var s=0;s<r.length;s++)t.writeSVarint(r[s])}function DE(r,t){for(var s=0;s<r.length;s++)t.writeFloat(r[s])}function zE(r,t){for(var s=0;s<r.length;s++)t.writeDouble(r[s])}function OE(r,t){for(var s=0;s<r.length;s++)t.writeBoolean(r[s])}function BE(r,t){for(var s=0;s<r.length;s++)t.writeFixed32(r[s])}function FE(r,t){for(var s=0;s<r.length;s++)t.writeSFixed32(r[s])}function NE(r,t){for(var s=0;s<r.length;s++)t.writeFixed64(r[s])}function UE(r,t){for(var s=0;s<r.length;s++)t.writeSFixed64(r[s])}function _f(r,t){return(r[t]|r[t+1]<<8|r[t+2]<<16)+16777216*r[t+3]}function Zl(r,t,s){r[s]=t,r[s+1]=t>>>8,r[s+2]=t>>>16,r[s+3]=t>>>24}function nx(r,t){return(r[t]|r[t+1]<<8|r[t+2]<<16)+(r[t+3]<<24)}function VE(r,t,s){t.glyphs=[],r===1&&s.readMessage(jE,t)}function jE(r,t,s){if(r===3){const{id:c,bitmap:d,width:m,height:_,left:v,top:w,advance:T}=s.readMessage(GE,{});t.glyphs.push({id:c,bitmap:new wo({width:m+6,height:_+6},d),metrics:{width:m,height:_,left:v,top:w,advance:T}})}else r===4?t.ascender=s.readSVarint():r===5&&(t.descender=s.readSVarint())}function GE(r,t,s){r===1?t.id=s.readVarint():r===2?t.bitmap=s.readBytes():r===3?t.width=s.readVarint():r===4?t.height=s.readVarint():r===5?t.left=s.readSVarint():r===6?t.top=s.readSVarint():r===7&&(t.advance=s.readVarint())}function zm(r){let t=0,s=0;for(const _ of r)t+=_.w*_.h,s=Math.max(s,_.w);r.sort((_,v)=>v.h-_.h);const c=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),s),h:1/0}];let d=0,m=0;for(const _ of r)for(let v=c.length-1;v>=0;v--){const w=c[v];if(!(_.w>w.w||_.h>w.h)){if(_.x=w.x,_.y=w.y,m=Math.max(m,_.y+_.h),d=Math.max(d,_.x+_.w),_.w===w.w&&_.h===w.h){const T=c.pop();v<c.length&&(c[v]=T)}else _.h===w.h?(w.x+=_.w,w.w-=_.w):_.w===w.w?(w.y+=_.h,w.h-=_.h):(c.push({x:w.x+_.w,y:w.y,w:w.w-_.w,h:_.h}),w.y+=_.h,w.h-=_.h);break}}return{w:d,h:m,fill:t/(d*m)||0}}Ci.prototype={destroy:function(){this.buf=null},readFields:function(r,t,s){for(s=s||this.length;this.pos<s;){var c=this.readVarint(),d=c>>3,m=this.pos;this.type=7&c,r(d,t,this),this.pos===m&&this.skip(c)}return t},readMessage:function(r,t){return this.readFields(r,t,this.readVarint()+this.pos)},readFixed32:function(){var r=_f(this.buf,this.pos);return this.pos+=4,r},readSFixed32:function(){var r=nx(this.buf,this.pos);return this.pos+=4,r},readFixed64:function(){var r=_f(this.buf,this.pos)+_f(this.buf,this.pos+4)*Dm;return this.pos+=8,r},readSFixed64:function(){var r=_f(this.buf,this.pos)+nx(this.buf,this.pos+4)*Dm;return this.pos+=8,r},readFloat:function(){var r=J0(this.buf,this.pos,!0,23,4);return this.pos+=4,r},readDouble:function(){var r=J0(this.buf,this.pos,!0,52,8);return this.pos+=8,r},readVarint:function(r){var t,s,c=this.buf;return t=127&(s=c[this.pos++]),s<128?t:(t|=(127&(s=c[this.pos++]))<<7,s<128?t:(t|=(127&(s=c[this.pos++]))<<14,s<128?t:(t|=(127&(s=c[this.pos++]))<<21,s<128?t:function(d,m,_){var v,w,T=_.buf;if(v=(112&(w=T[_.pos++]))>>4,w<128||(v|=(127&(w=T[_.pos++]))<<3,w<128)||(v|=(127&(w=T[_.pos++]))<<10,w<128)||(v|=(127&(w=T[_.pos++]))<<17,w<128)||(v|=(127&(w=T[_.pos++]))<<24,w<128)||(v|=(1&(w=T[_.pos++]))<<31,w<128))return Wl(d,v,m);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(s=c[this.pos]))<<28,r,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var r=this.readVarint();return r%2==1?(r+1)/-2:r/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var r=this.readVarint()+this.pos,t=this.pos;return this.pos=r,r-t>=12&&tx?function(s,c,d){return tx.decode(s.subarray(c,d))}(this.buf,t,r):function(s,c,d){for(var m="",_=c;_<d;){var v,w,T,S=s[_],C=null,L=S>239?4:S>223?3:S>191?2:1;if(_+L>d)break;L===1?S<128&&(C=S):L===2?(192&(v=s[_+1]))==128&&(C=(31&S)<<6|63&v)<=127&&(C=null):L===3?(w=s[_+2],(192&(v=s[_+1]))==128&&(192&w)==128&&((C=(15&S)<<12|(63&v)<<6|63&w)<=2047||C>=55296&&C<=57343)&&(C=null)):L===4&&(w=s[_+2],T=s[_+3],(192&(v=s[_+1]))==128&&(192&w)==128&&(192&T)==128&&((C=(15&S)<<18|(63&v)<<12|(63&w)<<6|63&T)<=65535||C>=1114112)&&(C=null)),C===null?(C=65533,L=1):C>65535&&(C-=65536,m+=String.fromCharCode(C>>>10&1023|55296),C=56320|1023&C),m+=String.fromCharCode(C),_+=L}return m}(this.buf,t,r)},readBytes:function(){var r=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,r);return this.pos=r,t},readPackedVarint:function(r,t){if(this.type!==Ci.Bytes)return r.push(this.readVarint(t));var s=To(this);for(r=r||[];this.pos<s;)r.push(this.readVarint(t));return r},readPackedSVarint:function(r){if(this.type!==Ci.Bytes)return r.push(this.readSVarint());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readSVarint());return r},readPackedBoolean:function(r){if(this.type!==Ci.Bytes)return r.push(this.readBoolean());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readBoolean());return r},readPackedFloat:function(r){if(this.type!==Ci.Bytes)return r.push(this.readFloat());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readFloat());return r},readPackedDouble:function(r){if(this.type!==Ci.Bytes)return r.push(this.readDouble());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readDouble());return r},readPackedFixed32:function(r){if(this.type!==Ci.Bytes)return r.push(this.readFixed32());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readFixed32());return r},readPackedSFixed32:function(r){if(this.type!==Ci.Bytes)return r.push(this.readSFixed32());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readSFixed32());return r},readPackedFixed64:function(r){if(this.type!==Ci.Bytes)return r.push(this.readFixed64());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readFixed64());return r},readPackedSFixed64:function(r){if(this.type!==Ci.Bytes)return r.push(this.readSFixed64());var t=To(this);for(r=r||[];this.pos<t;)r.push(this.readSFixed64());return r},skip:function(r){var t=7&r;if(t===Ci.Varint)for(;this.buf[this.pos++]>127;);else if(t===Ci.Bytes)this.pos=this.readVarint()+this.pos;else if(t===Ci.Fixed32)this.pos+=4;else{if(t!==Ci.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(r,t){this.writeVarint(r<<3|t)},realloc:function(r){for(var t=this.length||16;t<this.pos+r;)t*=2;if(t!==this.length){var s=new Uint8Array(t);s.set(this.buf),this.buf=s,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(r){this.realloc(4),Zl(this.buf,r,this.pos),this.pos+=4},writeSFixed32:function(r){this.realloc(4),Zl(this.buf,r,this.pos),this.pos+=4},writeFixed64:function(r){this.realloc(8),Zl(this.buf,-1&r,this.pos),Zl(this.buf,Math.floor(r*ex),this.pos+4),this.pos+=8},writeSFixed64:function(r){this.realloc(8),Zl(this.buf,-1&r,this.pos),Zl(this.buf,Math.floor(r*ex),this.pos+4),this.pos+=8},writeVarint:function(r){(r=+r||0)>268435455||r<0?function(t,s){var c,d;if(t>=0?(c=t%4294967296|0,d=t/4294967296|0):(d=~(-t/4294967296),4294967295^(c=~(-t%4294967296))?c=c+1|0:(c=0,d=d+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");s.realloc(10),function(m,_,v){v.buf[v.pos++]=127&m|128,m>>>=7,v.buf[v.pos++]=127&m|128,m>>>=7,v.buf[v.pos++]=127&m|128,m>>>=7,v.buf[v.pos++]=127&m|128,v.buf[v.pos]=127&(m>>>=7)}(c,0,s),function(m,_){var v=(7&m)<<4;_.buf[_.pos++]|=v|((m>>>=3)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m)))))}(d,s)}(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))},writeSVarint:function(r){this.writeVarint(r<0?2*-r-1:2*r)},writeBoolean:function(r){this.writeVarint(Boolean(r))},writeString:function(r){r=String(r),this.realloc(4*r.length),this.pos++;var t=this.pos;this.pos=function(c,d,m){for(var _,v,w=0;w<d.length;w++){if((_=d.charCodeAt(w))>55295&&_<57344){if(!v){_>56319||w+1===d.length?(c[m++]=239,c[m++]=191,c[m++]=189):v=_;continue}if(_<56320){c[m++]=239,c[m++]=191,c[m++]=189,v=_;continue}_=v-55296<<10|_-56320|65536,v=null}else v&&(c[m++]=239,c[m++]=191,c[m++]=189,v=null);_<128?c[m++]=_:(_<2048?c[m++]=_>>6|192:(_<65536?c[m++]=_>>12|224:(c[m++]=_>>18|240,c[m++]=_>>12&63|128),c[m++]=_>>6&63|128),c[m++]=63&_|128)}return m}(this.buf,r,this.pos);var s=this.pos-t;s>=128&&ix(t,s,this),this.pos=t-1,this.writeVarint(s),this.pos+=s},writeFloat:function(r){this.realloc(4),Q0(this.buf,r,this.pos,!0,23,4),this.pos+=4},writeDouble:function(r){this.realloc(8),Q0(this.buf,r,this.pos,!0,52,8),this.pos+=8},writeBytes:function(r){var t=r.length;this.writeVarint(t),this.realloc(t);for(var s=0;s<t;s++)this.buf[this.pos++]=r[s]},writeRawMessage:function(r,t){this.pos++;var s=this.pos;r(t,this);var c=this.pos-s;c>=128&&ix(s,c,this),this.pos=s-1,this.writeVarint(c),this.pos+=c},writeMessage:function(r,t,s){this.writeTag(r,Ci.Bytes),this.writeRawMessage(t,s)},writePackedVarint:function(r,t){t.length&&this.writeMessage(r,kE,t)},writePackedSVarint:function(r,t){t.length&&this.writeMessage(r,RE,t)},writePackedBoolean:function(r,t){t.length&&this.writeMessage(r,OE,t)},writePackedFloat:function(r,t){t.length&&this.writeMessage(r,DE,t)},writePackedDouble:function(r,t){t.length&&this.writeMessage(r,zE,t)},writePackedFixed32:function(r,t){t.length&&this.writeMessage(r,BE,t)},writePackedSFixed32:function(r,t){t.length&&this.writeMessage(r,FE,t)},writePackedFixed64:function(r,t){t.length&&this.writeMessage(r,NE,t)},writePackedSFixed64:function(r,t){t.length&&this.writeMessage(r,UE,t)},writeBytesField:function(r,t){this.writeTag(r,Ci.Bytes),this.writeBytes(t)},writeFixed32Field:function(r,t){this.writeTag(r,Ci.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(r,t){this.writeTag(r,Ci.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(r,t){this.writeTag(r,Ci.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(r,t){this.writeTag(r,Ci.Fixed64),this.writeSFixed64(t)},writeVarintField:function(r,t){this.writeTag(r,Ci.Varint),this.writeVarint(t)},writeSVarintField:function(r,t){this.writeTag(r,Ci.Varint),this.writeSVarint(t)},writeStringField:function(r,t){this.writeTag(r,Ci.Bytes),this.writeString(t)},writeFloatField:function(r,t){this.writeTag(r,Ci.Fixed32),this.writeFloat(t)},writeDoubleField:function(r,t){this.writeTag(r,Ci.Fixed64),this.writeDouble(t)},writeBooleanField:function(r,t){this.writeVarintField(r,Boolean(t))}};class Om{constructor(t,{pixelRatio:s,version:c,stretchX:d,stretchY:m,content:_}){this.paddedRect=t,this.pixelRatio=s,this.stretchX=d,this.stretchY=m,this.content=_,this.version=c}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class rx{constructor(t,s){const c={},d={};this.haveRenderCallbacks=[];const m=[];this.addImages(t,c,m),this.addImages(s,d,m);const{w:_,h:v}=zm(m),w=new Er({width:_||1,height:v||1});for(const T in t){const S=t[T],C=c[T].paddedRect;Er.copy(S.data,w,{x:0,y:0},{x:C.x+1,y:C.y+1},S.data)}for(const T in s){const S=s[T],C=d[T].paddedRect,L=C.x+1,z=C.y+1,B=S.data.width,V=S.data.height;Er.copy(S.data,w,{x:0,y:0},{x:L,y:z},S.data),Er.copy(S.data,w,{x:0,y:V-1},{x:L,y:z-1},{width:B,height:1}),Er.copy(S.data,w,{x:0,y:0},{x:L,y:z+V},{width:B,height:1}),Er.copy(S.data,w,{x:B-1,y:0},{x:L-1,y:z},{width:1,height:V}),Er.copy(S.data,w,{x:0,y:0},{x:L+B,y:z},{width:1,height:V})}this.image=w,this.iconPositions=c,this.patternPositions=d}addImages(t,s,c){for(const d in t){const m=t[d],_={x:0,y:0,w:m.data.width+2,h:m.data.height+2};c.push(_),s[d]=new Om(_,m),m.hasRenderCallback&&this.haveRenderCallbacks.push(d)}}patchUpdatedImages(t,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(c=>t.hasImage(c)),t.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const c in t.updatedImages)this.patchUpdatedImage(this.iconPositions[c],t.getImage(c),s),this.patchUpdatedImage(this.patternPositions[c],t.getImage(c),s)}patchUpdatedImage(t,s,c){if(!t||!s||t.version===s.version)return;t.version=s.version;const[d,m]=t.tl;c.update(s.data,void 0,{x:d,y:m})}}ft(Om,"ImagePosition"),ft(rx,"ImageAtlas");const Nr={horizontal:1,vertical:2,horizontalOnly:3};class Hu{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,s){const c=new Hu;return c.scale=t||1,c.fontStack=s,c}static forImage(t){const s=new Hu;return s.imageName=t,s}}class $l{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,s){const c=new $l;for(let d=0;d<t.sections.length;d++){const m=t.sections[d];m.image?c.addImageSection(m):c.addTextSection(m,s)}return c}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCharCode(t){return this.text.charCodeAt(t)}verticalizePunctuation(t){this.text=function(s,c){let d="";for(let m=0;m<s.length;m++){const _=s.charCodeAt(m+1)||null,v=s.charCodeAt(m-1)||null;d+=!c&&(_&&A(_)&&!$u[s[m+1]]||v&&A(v)&&!$u[s[m-1]])||!$u[s[m]]?s[m]:$u[s[m]]}return d}(this.text,t)}trim(){let t=0;for(let c=0;c<this.text.length&&yf[this.text.charCodeAt(c)];c++)t++;let s=this.text.length;for(let c=this.text.length-1;c>=0&&c>=t&&yf[this.text.charCodeAt(c)];c--)s--;this.text=this.text.substring(t,s),this.sectionIndex=this.sectionIndex.slice(t,s)}substring(t,s){const c=new $l;return c.text=this.text.substring(t,s),c.sectionIndex=this.sectionIndex.slice(t,s),c.sections=this.sections,c}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,s)=>Math.max(t,this.sections[s].scale),0)}addTextSection(t,s){this.text+=t.text,this.sections.push(Hu.forText(t.scale,t.fontStack||s));const c=this.sections.length-1;for(let d=0;d<t.text.length;++d)this.sectionIndex.push(c)}addImageSection(t){const s=t.image?t.image.name:"";if(s.length===0)return void fi("Can't add FormattedSection with an empty image.");const c=this.getNextImageSectionCharCode();c?(this.text+=String.fromCharCode(c),this.sections.push(Hu.forImage(s)),this.sectionIndex.push(this.sections.length-1)):fi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Bm(r,t,s,c,d,m,_,v,w,T,S,C,L,z,B,V){const Z=$l.fromFeature(r,d);let oe;C===Nr.vertical&&Z.verticalizePunctuation(L);const{processBidirectionalText:de,processStyledBidirectionalText:se}=fe;if(de&&Z.sections.length===1){oe=[];const pe=de(Z.toString(),Fm(Z,T,m,t,c,z,B));for(const Re of pe){const Le=new $l;Le.text=Re,Le.sections=Z.sections;for(let Ne=0;Ne<Re.length;Ne++)Le.sectionIndex.push(0);oe.push(Le)}}else if(se){oe=[];const pe=se(Z.text,Z.sectionIndex,Fm(Z,T,m,t,c,z,B));for(const Re of pe){const Le=new $l;Le.text=Re[0],Le.sectionIndex=Re[1],Le.sections=Z.sections,oe.push(Le)}}else oe=function(pe,Re){const Le=[],Ne=pe.text;let Je=0;for(const Be of Re)Le.push(pe.substring(Je,Be)),Je=Be;return Je<Ne.length&&Le.push(pe.substring(Je,Ne.length)),Le}(Z,Fm(Z,T,m,t,c,z,B));const ue=[],ye={positionedLines:ue,text:Z.toString(),top:S[1],bottom:S[1],left:S[0],right:S[0],writingMode:C,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(pe,Re,Le,Ne,Je,Be,qe,He,Ye,Qe,Ue,mt){let Ot=0,bt=0,_t=0;const ct=He==="right"?1:He==="left"?0:.5;let Dt=!1;for(const Xt of Je){const ei=Xt.getSections();for(const Ti of ei){if(Ti.imageName)continue;const Ri=Re[Ti.fontStack];if(Ri&&(Dt=Ri.ascender!==void 0&&Ri.descender!==void 0,!Dt))break}if(!Dt)break}let Gt=0;for(const Xt of Je){Xt.trim();const ei=Xt.getMaxScale(),Ti=(ei-1)*jn,Ri={positionedGlyphs:[],lineOffset:0};pe.positionedLines[Gt]=Ri;const Li=Ri.positionedGlyphs;let Di=0;if(!Xt.length()){bt+=Be,++Gt;continue}let Oi=0,Hi=0;for(let xi=0;xi<Xt.length();xi++){const hn=Xt.getSection(xi),sn=Xt.getSectionIndex(xi),ci=Xt.getCharCode(xi);let ji=hn.scale,vn=null,Ei=null,en=null,Xn=jn,Rn=0;const Dn=!(Ye===Nr.horizontal||!Ue&&!b(ci)||Ue&&(yf[ci]||(Wt=ci,Bd(Wt)||Aa(Wt)||Fd(Wt)||Mu(Wt)||p(Wt))));if(hn.imageName){const ar=Ne[hn.imageName];if(!ar)continue;en=hn.imageName,pe.iconsInText=pe.iconsInText||!0,Ei=ar.paddedRect;const zn=ar.displaySize;ji=ji*jn/mt,vn={width:zn[0],height:zn[1],left:1,top:-3,advance:Dn?zn[1]:zn[0],localGlyph:!1},Rn=Dt?-vn.height*ji:ei*jn-17-zn[1]*ji,Xn=vn.advance;const So=(Dn?zn[0]:zn[1])*ji-jn*ei;So>0&&So>Di&&(Di=So)}else{const ar=Le[hn.fontStack];if(!ar)continue;ar[ci]&&(Ei=ar[ci]);const zn=Re[hn.fontStack];if(!zn)continue;const So=zn.glyphs[ci];if(!So)continue;if(vn=So.metrics,Xn=ci!==8203?jn:0,Dt){const tc=zn.ascender!==void 0?Math.abs(zn.ascender):0,oh=zn.descender!==void 0?Math.abs(zn.descender):0,ah=(tc+oh)*ji;Oi<ah&&(Oi=ah,Hi=(tc-oh)/2*ji),Rn=-tc*ji}else Rn=(ei-ji)*jn-17}Dn?(pe.verticalizable=!0,Li.push({glyph:ci,imageName:en,x:Ot,y:bt+Rn,vertical:Dn,scale:ji,localGlyph:vn.localGlyph,fontStack:hn.fontStack,sectionIndex:sn,metrics:vn,rect:Ei}),Ot+=Xn*ji+Qe):(Li.push({glyph:ci,imageName:en,x:Ot,y:bt+Rn,vertical:Dn,scale:ji,localGlyph:vn.localGlyph,fontStack:hn.fontStack,sectionIndex:sn,metrics:vn,rect:Ei}),Ot+=vn.advance*ji+Qe)}Li.length!==0&&(_t=Math.max(Ot-Qe,_t),Dt?cx(Li,ct,Di,Hi,Be*ei/2):cx(Li,ct,Di,0,Be/2)),Ot=0;const kn=Be*ei+Di;Ri.lineOffset=Math.max(Di,Ti),bt+=kn,++Gt}var Wt;const li=bt,{horizontalAlign:Nt,verticalAlign:zi}=Nm(qe);(function(Xt,ei,Ti,Ri,Li,Di){const Oi=(ei-Ti)*Li,Hi=-Di*Ri;for(const kn of Xt)for(const xi of kn.positionedGlyphs)xi.x+=Oi,xi.y+=Hi})(pe.positionedLines,ct,Nt,zi,_t,li),pe.top+=-zi*li,pe.bottom=pe.top+li,pe.left+=-Nt*_t,pe.right=pe.left+_t,pe.hasBaseline=Dt}(ye,t,s,c,oe,_,v,w,C,T,L,V),!function(pe){for(const Re of pe)if(Re.positionedGlyphs.length!==0)return!1;return!0}(ue)&&ye}const yf={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},WE={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function sx(r,t,s,c,d,m){if(t.imageName){const _=c[t.imageName];return _?_.displaySize[0]*t.scale*jn/m+d:0}{const _=s[t.fontStack],v=_&&_.glyphs[r];return v?v.metrics.advance*t.scale+d:0}}function ox(r,t,s,c){const d=Math.pow(r-t,2);return c?r<t?d/2:2*d:d+Math.abs(s)*s}function ZE(r,t,s){let c=0;return r===10&&(c-=1e4),s&&(c+=150),r!==40&&r!==65288||(c+=50),t!==41&&t!==65289||(c+=50),c}function ax(r,t,s,c,d,m){let _=null,v=ox(t,s,d,m);for(const w of c){const T=ox(t-w.x,s,d,m)+w.badness;T<=v&&(_=w,v=T)}return{index:r,x:t,priorBreak:_,badness:v}}function lx(r){return r?lx(r.priorBreak).concat(r.index):[]}function Fm(r,t,s,c,d,m,_){if(m!=="point")return[];if(!r)return[];const v=[],w=function(L,z,B,V,Z,oe){let de=0;for(let se=0;se<L.length();se++){const ue=L.getSection(se);de+=sx(L.getCharCode(se),ue,V,Z,z,oe)}return de/Math.max(1,Math.ceil(de/B))}(r,t,s,c,d,_),T=r.text.indexOf("\u200B")>=0;let S=0;for(let L=0;L<r.length();L++){const z=r.getSection(L),B=r.getCharCode(L);if(yf[B]||(S+=sx(B,z,c,d,t,_)),L<r.length()-1){const V=!((C=B)<11904||!(Ll(C)||Cl(C)||Rl(C)||$d(C)||jd(C)||Tu(C)||Ud(C)||Sa(C)||Gd(C)||Su(C)||Au(C)||o(C)||Il(C)||Eu(C)||Nd(C)||Vd(C)||Ma(C)||qd(C)||Wd(C)||kl(C)));(WE[B]||V||z.imageName)&&v.push(ax(L+1,S,w,v,ZE(B,r.getCharCode(L+1),V&&T),!1))}}var C;return lx(ax(r.length(),S,w,v,0,!0))}function Nm(r){let t=.5,s=.5;switch(r){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":s=1;break;case"top":case"top-right":case"top-left":s=0}return{horizontalAlign:t,verticalAlign:s}}function cx(r,t,s,c,d){if(!(t||s||c||d))return;const m=r.length-1,_=r[m],v=(_.x+_.metrics.advance*_.scale)*t;for(let w=0;w<=m;w++)r[w].x-=v,r[w].y+=s+c+d}function $E(r,t,s){const{horizontalAlign:c,verticalAlign:d}=Nm(s),m=t[0]-r.displaySize[0]*c,_=t[1]-r.displaySize[1]*d;return{image:r,top:_,bottom:_+r.displaySize[1],left:m,right:m+r.displaySize[0]}}function ux(r,t,s,c,d,m){const _=r.image;let v;if(_.content){const Z=_.content,oe=_.pixelRatio||1;v=[Z[0]/oe,Z[1]/oe,_.displaySize[0]-Z[2]/oe,_.displaySize[1]-Z[3]/oe]}const w=t.left*m,T=t.right*m;let S,C,L,z;s==="width"||s==="both"?(z=d[0]+w-c[3],C=d[0]+T+c[1]):(z=d[0]+(w+T-_.displaySize[0])/2,C=z+_.displaySize[0]);const B=t.top*m,V=t.bottom*m;return s==="height"||s==="both"?(S=d[1]+B-c[0],L=d[1]+V+c[2]):(S=d[1]+(B+V-_.displaySize[1])/2,L=S+_.displaySize[1]),{image:_,top:S,right:C,bottom:L,left:z,collisionPadding:v}}class Eo extends Ee{constructor(t,s,c,d,m){super(t,s),this.angle=d,this.z=c,m!==void 0&&(this.segment=m)}clone(){return new Eo(this.x,this.y,this.z,this.angle,this.segment)}}function hx(r,t,s,c,d){if(t.segment===void 0)return!0;let m=t,_=t.segment+1,v=0;for(;v>-s/2;){if(_--,_<0)return!1;v-=r[_].dist(m),m=r[_]}v+=r[_].dist(r[_+1]),_++;const w=[];let T=0;for(;v<s/2;){const S=r[_],C=r[_+1];if(!C)return!1;let L=r[_-1].angleTo(S)-S.angleTo(C);for(L=Math.abs((L+3*Math.PI)%(2*Math.PI)-Math.PI),w.push({distance:v,angleDelta:L}),T+=L;v-w[0].distance>c;)T-=w.shift().angleDelta;if(T>d)return!1;_++,v+=S.dist(C)}return!0}function dx(r){let t=0;for(let s=0;s<r.length-1;s++)t+=r[s].dist(r[s+1]);return t}function fx(r,t,s){return r?.6*t*s:0}function px(r,t){return Math.max(r?r.right-r.left:0,t?t.right-t.left:0)}function qE(r,t,s,c,d,m){const _=fx(s,d,m),v=px(s,c)*m;let w=0;const T=dx(r)/2;for(let S=0;S<r.length-1;S++){const C=r[S],L=r[S+1],z=C.dist(L);if(w+z>T){const B=(T-w)/z,V=ai(C.x,L.x,B),Z=ai(C.y,L.y,B),oe=new Eo(V,Z,0,L.angleTo(C),S);return!_||hx(r,oe,v,_,t)?oe:void 0}w+=z}}function HE(r,t,s,c,d,m,_,v,w){const T=fx(c,m,_),S=px(c,d),C=S*_,L=r[0].x===0||r[0].x===w||r[0].y===0||r[0].y===w;return t-C<t/4&&(t=C+t/4),mx(r,L?t/2*v%t:(S/2+2*m)*_*v%t,t,T,s,C,L,!1,w)}function mx(r,t,s,c,d,m,_,v,w){const T=m/2,S=dx(r);let C=0,L=t-s,z=[];for(let B=0;B<r.length-1;B++){const V=r[B],Z=r[B+1],oe=V.dist(Z),de=Z.angleTo(V);for(;L+s<C+oe;){L+=s;const se=(L-C)/oe,ue=ai(V.x,Z.x,se),ye=ai(V.y,Z.y,se);if(ue>=0&&ue<w&&ye>=0&&ye<w&&L-T>=0&&L+T<=S){const pe=new Eo(ue,ye,0,de,B);pe._round(),c&&!hx(r,pe,m,c,d)||z.push(pe)}}C+=oe}return v||z.length||_||(z=mx(r,C/2,s,c,d,m,_,!0,w)),z}function gx(r,t,s,c,d){const m=[];for(let _=0;_<r.length;_++){const v=r[_];let w;for(let T=0;T<v.length-1;T++){let S=v[T],C=v[T+1];S.x<t&&C.x<t||(S.x<t?S=new Ee(t,S.y+(t-S.x)/(C.x-S.x)*(C.y-S.y))._round():C.x<t&&(C=new Ee(t,S.y+(t-S.x)/(C.x-S.x)*(C.y-S.y))._round()),S.y<s&&C.y<s||(S.y<s?S=new Ee(S.x+(s-S.y)/(C.y-S.y)*(C.x-S.x),s)._round():C.y<s&&(C=new Ee(S.x+(s-S.y)/(C.y-S.y)*(C.x-S.x),s)._round()),S.x>=c&&C.x>=c||(S.x>=c?S=new Ee(c,S.y+(c-S.x)/(C.x-S.x)*(C.y-S.y))._round():C.x>=c&&(C=new Ee(c,S.y+(c-S.x)/(C.x-S.x)*(C.y-S.y))._round()),S.y>=d&&C.y>=d||(S.y>=d?S=new Ee(S.x+(d-S.y)/(C.y-S.y)*(C.x-S.x),d)._round():C.y>=d&&(C=new Ee(S.x+(d-S.y)/(C.y-S.y)*(C.x-S.x),d)._round()),w&&S.equals(w[w.length-1])||(w=[S],m.push(w)),w.push(C)))))}}return m}ft(Eo,"Anchor");const Xu=1e20;function _x(r,t,s,c,d,m,_,v,w){for(let T=t;T<t+c;T++)yx(r,s*m+T,m,d,_,v,w);for(let T=s;T<s+d;T++)yx(r,T*m+t,1,c,_,v,w)}function yx(r,t,s,c,d,m,_){m[0]=0,_[0]=-Xu,_[1]=Xu,d[0]=r[t];for(let v=1,w=0,T=0;v<c;v++){d[v]=r[t+v*s];const S=v*v;do{const C=m[w];T=(d[v]-d[C]+S-C*C)/(v-C)/2}while(T<=_[w]&&--w>-1);w++,m[w]=v,_[w]=T,_[w+1]=Xu}for(let v=0,w=0;v<c;v++){for(;_[w+1]<v;)w++;const T=m[w],S=v-T;r[t+v*s]=d[T]+S*S}}const Um={none:0,ideographs:1,all:2};class ql{constructor(t,s,c){this.requestManager=t,this.localGlyphMode=s,this.localFontFamily=c,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t){this.url=t}getGlyphs(t,s){const c=[];for(const d in t)for(const m of t[d])c.push({stack:d,id:m});pn(c,({stack:d,id:m},_)=>{let v=this.entries[d];v||(v=this.entries[d]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let w=v.glyphs[m];if(w!==void 0)return void _(null,{stack:d,id:m,glyph:w});if(w=this._tinySDF(v,d,m),w)return v.glyphs[m]=w,void _(null,{stack:d,id:m,glyph:w});const T=Math.floor(m/256);if(256*T>65535)return void _(new Error("glyphs > 65535 not supported"));if(v.ranges[T])return void _(null,{stack:d,id:m,glyph:w});let S=v.requests[T];S||(S=v.requests[T]=[],ql.loadGlyphRange(d,T,this.url,this.requestManager,(C,L)=>{if(L){v.ascender=L.ascender,v.descender=L.descender;for(const z in L.glyphs)this._doesCharSupportLocalGlyph(+z)||(v.glyphs[+z]=L.glyphs[+z]);v.ranges[T]=!0}for(const z of S)z(C,L);delete v.requests[T]})),S.push((C,L)=>{C?_(C):L&&_(null,{stack:d,id:m,glyph:L.glyphs[m]||null})})},(d,m)=>{if(d)s(d);else if(m){const _={};for(const{stack:v,id:w,glyph:T}of m)_[v]===void 0&&(_[v]={}),_[v].glyphs===void 0&&(_[v].glyphs={}),_[v].glyphs[w]=T&&{id:T.id,bitmap:T.bitmap.clone(),metrics:T.metrics},_[v].ascender=this.entries[v].ascender,_[v].descender=this.entries[v].descender;s(null,_)}})}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==Um.none&&(this.localGlyphMode===Um.all?!!this.localFontFamily:!!this.localFontFamily&&(Su(t)||Zd(t)||Il(t)||Ma(t)||Sa(t)))}_tinySDF(t,s,c){const d=this.localFontFamily;if(!d||!this._doesCharSupportLocalGlyph(c))return;let m=t.tinySDF;if(!m){let V="400";/bold/i.test(s)?V="900":/medium/i.test(s)?V="500":/light/i.test(s)&&(V="200"),m=t.tinySDF=new ql.TinySDF({fontFamily:d,fontWeight:V,fontSize:48,buffer:6,radius:16}),m.fontWeight=V}if(this.localGlyphs[m.fontWeight][c])return this.localGlyphs[m.fontWeight][c];const _=String.fromCharCode(c),{data:v,width:w,height:T,glyphWidth:S,glyphHeight:C,glyphLeft:L,glyphTop:z,glyphAdvance:B}=m.draw(_);return this.localGlyphs[m.fontWeight][c]={id:c,bitmap:new wo({width:w,height:T},v),metrics:{width:S/2,height:C/2,left:L/2,top:z/2-27,advance:B/2,localGlyph:!0}}}}function xx(r,t,s,c){const d=[],m=r.image,_=m.pixelRatio,v=m.paddedRect.w-2,w=m.paddedRect.h-2,T=r.right-r.left,S=r.bottom-r.top,C=m.stretchX||[[0,v]],L=m.stretchY||[[0,w]],z=(Be,qe)=>Be+qe[1]-qe[0],B=C.reduce(z,0),V=L.reduce(z,0),Z=v-B,oe=w-V;let de=0,se=B,ue=0,ye=V,pe=0,Re=Z,Le=0,Ne=oe;if(m.content&&c){const Be=m.content;de=xf(C,0,Be[0]),ue=xf(L,0,Be[1]),se=xf(C,Be[0],Be[2]),ye=xf(L,Be[1],Be[3]),pe=Be[0]-de,Le=Be[1]-ue,Re=Be[2]-Be[0]-se,Ne=Be[3]-Be[1]-ye}const Je=(Be,qe,He,Ye)=>{const Qe=vf(Be.stretch-de,se,T,r.left),Ue=bf(Be.fixed-pe,Re,Be.stretch,B),mt=vf(qe.stretch-ue,ye,S,r.top),Ot=bf(qe.fixed-Le,Ne,qe.stretch,V),bt=vf(He.stretch-de,se,T,r.left),_t=bf(He.fixed-pe,Re,He.stretch,B),ct=vf(Ye.stretch-ue,ye,S,r.top),Dt=bf(Ye.fixed-Le,Ne,Ye.stretch,V),Gt=new Ee(Qe,mt),Wt=new Ee(bt,mt),li=new Ee(bt,ct),Nt=new Ee(Qe,ct),zi=new Ee(Ue/_,Ot/_),Xt=new Ee(_t/_,Dt/_),ei=t*Math.PI/180;if(ei){const Li=Math.sin(ei),Di=Math.cos(ei),Oi=[Di,-Li,Li,Di];Gt._matMult(Oi),Wt._matMult(Oi),Nt._matMult(Oi),li._matMult(Oi)}const Ti=Be.stretch+Be.fixed,Ri=qe.stretch+qe.fixed;return{tl:Gt,tr:Wt,bl:Nt,br:li,tex:{x:m.paddedRect.x+1+Ti,y:m.paddedRect.y+1+Ri,w:He.stretch+He.fixed-Ti,h:Ye.stretch+Ye.fixed-Ri},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:zi,pixelOffsetBR:Xt,minFontScaleX:Re/_/T,minFontScaleY:Ne/_/S,isSDF:s}};if(c&&(m.stretchX||m.stretchY)){const Be=vx(C,Z,B),qe=vx(L,oe,V);for(let He=0;He<Be.length-1;He++){const Ye=Be[He],Qe=Be[He+1];for(let Ue=0;Ue<qe.length-1;Ue++)d.push(Je(Ye,qe[Ue],Qe,qe[Ue+1]))}}else d.push(Je({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:v+1},{fixed:0,stretch:w+1}));return d}function xf(r,t,s){let c=0;for(const d of r)c+=Math.max(t,Math.min(s,d[1]))-Math.max(t,Math.min(s,d[0]));return c}function vx(r,t,s){const c=[{fixed:-1,stretch:0}];for(const[d,m]of r){const _=c[c.length-1];c.push({fixed:d-_.stretch,stretch:_.stretch}),c.push({fixed:d-_.stretch,stretch:_.stretch+(m-d)})}return c.push({fixed:t+1,stretch:s}),c}function vf(r,t,s,c){return r/t*s+c}function bf(r,t,s,c){return r-t*s/c}function XE(r,t,s,c){const d=t+r.positionedLines[c].lineOffset;return c===0?s+d/2:s+(d+(t+r.positionedLines[c-1].lineOffset))/2}ql.loadGlyphRange=function(r,t,s,c,d){const m=256*t,_=m+255,v=c.transformRequest(c.normalizeGlyphsURL(s).replace("{fontstack}",r).replace("{range}",`${m}-${_}`),yn.Glyphs);an(v,(w,T)=>{if(w)d(w);else if(T){const S={},C=function(L){return new qu(L).readFields(VE,{})}(T);for(const L of C.glyphs)S[L.id]=L;d(null,{glyphs:S,ascender:C.ascender,descender:C.descender})}})},ql.TinySDF=class{constructor({fontSize:r=24,buffer:t=3,radius:s=8,cutoff:c=.25,fontFamily:d="sans-serif",fontWeight:m="normal",fontStyle:_="normal"}={}){this.buffer=t,this.cutoff=c,this.radius=s;const v=this.size=r+4*t,w=this._createCanvas(v),T=this.ctx=w.getContext("2d",{willReadFrequently:!0});T.font=`${_} ${m} ${r}px ${d}`,T.textBaseline="alphabetic",T.textAlign="left",T.fillStyle="black",this.gridOuter=new Float64Array(v*v),this.gridInner=new Float64Array(v*v),this.f=new Float64Array(v),this.z=new Float64Array(v+1),this.v=new Uint16Array(v)}_createCanvas(r){const t=document.createElement("canvas");return t.width=t.height=r,t}draw(r){const{width:t,actualBoundingBoxAscent:s,actualBoundingBoxDescent:c,actualBoundingBoxLeft:d,actualBoundingBoxRight:m}=this.ctx.measureText(r),_=Math.ceil(s),v=Math.min(this.size-this.buffer,Math.ceil(m-d)),w=Math.min(this.size-this.buffer,_+Math.ceil(c)),T=v+2*this.buffer,S=w+2*this.buffer,C=Math.max(T*S,0),L=new Uint8ClampedArray(C),z={data:L,width:T,height:S,glyphWidth:v,glyphHeight:w,glyphTop:_,glyphLeft:0,glyphAdvance:t};if(v===0||w===0)return z;const{ctx:B,buffer:V,gridInner:Z,gridOuter:oe}=this;B.clearRect(V,V,v,w),B.fillText(r,V,V+_);const de=B.getImageData(V,V,v,w);oe.fill(Xu,0,C),Z.fill(0,0,C);for(let se=0;se<w;se++)for(let ue=0;ue<v;ue++){const ye=de.data[4*(se*v+ue)+3]/255;if(ye===0)continue;const pe=(se+V)*T+ue+V;if(ye===1)oe[pe]=0,Z[pe]=Xu;else{const Re=.5-ye;oe[pe]=Re>0?Re*Re:0,Z[pe]=Re<0?Re*Re:0}}_x(oe,0,0,T,S,T,this.f,this.v,this.z),_x(Z,V,V,v,w,T,this.f,this.v,this.z);for(let se=0;se<C;se++){const ue=Math.sqrt(oe[se])-Math.sqrt(Z[se]);L[se]=Math.round(255-255*(ue/this.radius+this.cutoff))}return z}};class YE{constructor(t=[],s=KE){if(this.data=t,this.length=this.data.length,this.compare=s,this.length>0)for(let c=(this.length>>1)-1;c>=0;c--)this._down(c)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const t=this.data[0],s=this.data.pop();return this.length--,this.length>0&&(this.data[0]=s,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:s,compare:c}=this,d=s[t];for(;t>0;){const m=t-1>>1,_=s[m];if(c(d,_)>=0)break;s[t]=_,t=m}s[t]=d}_down(t){const{data:s,compare:c}=this,d=this.length>>1,m=s[t];for(;t<d;){let _=1+(t<<1),v=s[_];const w=_+1;if(w<this.length&&c(s[w],v)<0&&(_=w,v=s[w]),c(v,m)>=0)break;s[t]=v,t=_}s[t]=m}}function KE(r,t){return r<t?-1:r>t?1:0}function JE(r,t=1,s=!1){let c=1/0,d=1/0,m=-1/0,_=-1/0;const v=r[0];for(let z=0;z<v.length;z++){const B=v[z];(!z||B.x<c)&&(c=B.x),(!z||B.y<d)&&(d=B.y),(!z||B.x>m)&&(m=B.x),(!z||B.y>_)&&(_=B.y)}const w=Math.min(m-c,_-d);let T=w/2;const S=new YE([],QE);if(w===0)return new Ee(c,d);for(let z=c;z<m;z+=w)for(let B=d;B<_;B+=w)S.push(new Hl(z+T,B+T,T,r));let C=function(z){let B=0,V=0,Z=0;const oe=z[0];for(let de=0,se=oe.length,ue=se-1;de<se;ue=de++){const ye=oe[de],pe=oe[ue],Re=ye.x*pe.y-pe.x*ye.y;V+=(ye.x+pe.x)*Re,Z+=(ye.y+pe.y)*Re,B+=3*Re}return new Hl(V/B,Z/B,0,z)}(r),L=S.length;for(;S.length;){const z=S.pop();(z.d>C.d||!C.d)&&(C=z,s&&console.log("found best %d after %d probes",Math.round(1e4*z.d)/1e4,L)),z.max-C.d<=t||(T=z.h/2,S.push(new Hl(z.p.x-T,z.p.y-T,T,r)),S.push(new Hl(z.p.x+T,z.p.y-T,T,r)),S.push(new Hl(z.p.x-T,z.p.y+T,T,r)),S.push(new Hl(z.p.x+T,z.p.y+T,T,r)),L+=4)}return s&&(console.log(`num probes: ${L}`),console.log(`best distance: ${C.d}`)),C.p}function QE(r,t){return t.max-r.max}function Hl(r,t,s,c){this.p=new Ee(r,t),this.h=s,this.d=function(d,m){let _=!1,v=1/0;for(let w=0;w<m.length;w++){const T=m[w];for(let S=0,C=T.length,L=C-1;S<C;L=S++){const z=T[S],B=T[L];z.y>d.y!=B.y>d.y&&d.x<(B.x-z.x)*(d.y-z.y)/(B.y-z.y)+z.x&&(_=!_),v=Math.min(v,s0(d,z,B))}}return(_?1:-1)*Math.sqrt(v)}(this.p,c),this.max=this.d+this.h*Math.SQRT2}const Vm=Number.POSITIVE_INFINITY,eA=Math.sqrt(2);function bx(r,t){return t[1]!==Vm?function(s,c,d){let m=0,_=0;switch(c=Math.abs(c),d=Math.abs(d),s){case"top-right":case"top-left":case"top":_=d-7;break;case"bottom-right":case"bottom-left":case"bottom":_=7-d}switch(s){case"top-right":case"bottom-right":case"right":m=-c;break;case"top-left":case"bottom-left":case"left":m=c}return[m,_]}(r,t[0],t[1]):function(s,c){let d=0,m=0;c<0&&(c=0);const _=c/eA;switch(s){case"top-right":case"top-left":m=_-7;break;case"bottom-right":case"bottom-left":m=7-_;break;case"bottom":m=7-c;break;case"top":m=c-7}switch(s){case"top-right":case"bottom-right":d=-_;break;case"top-left":case"bottom-left":d=_;break;case"left":d=c;break;case"right":d=-c}return[d,m]}(r,t[0])}function tA(r,t,s,c,d,m,_,v,w,T){r.createArrays(),r.tilePixelRatio=zt/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;const S=r.layers[0].layout,C=r.layers[0]._unevaluatedLayout._values,L={};if(r.textSizeData.kind==="composite"){const{minZoom:V,maxZoom:Z}=r.textSizeData;L.compositeTextSizes=[C["text-size"].possiblyEvaluate(new le(V),v),C["text-size"].possiblyEvaluate(new le(Z),v)]}if(r.iconSizeData.kind==="composite"){const{minZoom:V,maxZoom:Z}=r.iconSizeData;L.compositeIconSizes=[C["icon-size"].possiblyEvaluate(new le(V),v),C["icon-size"].possiblyEvaluate(new le(Z),v)]}L.layoutTextSize=C["text-size"].possiblyEvaluate(new le(w+1),v),L.layoutIconSize=C["icon-size"].possiblyEvaluate(new le(w+1),v),L.textMaxSize=C["text-size"].possiblyEvaluate(new le(18),v);const z=S.get("text-rotation-alignment")==="map"&&S.get("symbol-placement")!=="point",B=S.get("text-size");for(const V of r.features){const Z=S.get("text-font").evaluate(V,{},v).join(","),oe=B.evaluate(V,{},v),de=L.layoutTextSize.evaluate(V,{},v),se=(L.layoutIconSize.evaluate(V,{},v),{horizontal:{},vertical:void 0}),ue=V.text;let ye,pe=[0,0];if(ue){const Ne=ue.toString(),Je=S.get("text-letter-spacing").evaluate(V,{},v)*jn,Be=S.get("text-line-height").evaluate(V,{},v)*jn,qe=g(Ne)?Je:0,He=S.get("text-anchor").evaluate(V,{},v),Ye=S.get("text-variable-anchor");if(!Ye){const _t=S.get("text-radial-offset").evaluate(V,{},v);pe=_t?bx(He,[_t*jn,Vm]):S.get("text-offset").evaluate(V,{},v).map(ct=>ct*jn)}let Qe=z?"center":S.get("text-justify").evaluate(V,{},v);const Ue=S.get("symbol-placement"),mt=Ue==="point",Ot=Ue==="point"?S.get("text-max-width").evaluate(V,{},v)*jn:0,bt=_t=>{r.allowVerticalPlacement&&h(Ne)&&(se.vertical=Bm(ue,t,s,d,Z,Ot,Be,He,_t,qe,pe,Nr.vertical,!0,Ue,de,oe))};if(!z&&Ye){const _t=Qe==="auto"?Ye.map(Dt=>jm(Dt)):[Qe];let ct=!1;for(let Dt=0;Dt<_t.length;Dt++){const Gt=_t[Dt];if(!se.horizontal[Gt])if(ct)se.horizontal[Gt]=se.horizontal[0];else{const Wt=Bm(ue,t,s,d,Z,Ot,Be,"center",Gt,qe,pe,Nr.horizontal,!1,Ue,de,oe);Wt&&(se.horizontal[Gt]=Wt,ct=Wt.positionedLines.length===1)}}bt("left")}else{if(Qe==="auto"&&(Qe=jm(He)),mt||S.get("text-writing-mode").indexOf("horizontal")>=0||!h(Ne)){const _t=Bm(ue,t,s,d,Z,Ot,Be,He,Qe,qe,pe,Nr.horizontal,!1,Ue,de,oe);_t&&(se.horizontal[Qe]=_t)}bt(Ue==="point"?"left":Qe)}}let Re=!1;if(V.icon&&V.icon.name){const Ne=c[V.icon.name];Ne&&(ye=$E(d[V.icon.name],S.get("icon-offset").evaluate(V,{},v),S.get("icon-anchor").evaluate(V,{},v)),Re=Ne.sdf,r.sdfIcons===void 0?r.sdfIcons=Ne.sdf:r.sdfIcons!==Ne.sdf&&fi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ne.pixelRatio!==r.pixelRatio||S.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0))}const Le=Tx(se.horizontal)||se.vertical;r.iconsInText||(r.iconsInText=!!Le&&Le.iconsInText),(Le||ye)&&iA(r,V,se,ye,c,L,de,0,pe,Re,_,v,T)}m&&r.generateCollisionDebugBuffers(w,r.collisionBoxArray)}function jm(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function iA(r,t,s,c,d,m,_,v,w,T,S,C,L){let z=m.textMaxSize.evaluate(t,{},C);z===void 0&&(z=_);const B=r.layers[0].layout,V=B.get("icon-offset").evaluate(t,{},C),Z=Tx(s.horizontal)||s.vertical,oe=L.name==="globe",de=_/24,se=r.tilePixelRatio*z/24,ue=(qe=r.overscaling,r.zoom>18&&qe>2&&(qe>>=1),Math.max(zt/(512*qe),1)*B.get("symbol-spacing")),ye=B.get("text-padding")*r.tilePixelRatio,pe=B.get("icon-padding")*r.tilePixelRatio,Re=et(B.get("text-max-angle")),Le=B.get("text-rotation-alignment")==="map"&&B.get("symbol-placement")!=="point",Ne=B.get("icon-rotation-alignment")==="map"&&B.get("symbol-placement")!=="point",Je=B.get("symbol-placement"),Be=ue/2;var qe;const He=B.get("icon-text-fit");let Ye;c&&He!=="none"&&(r.allowVerticalPlacement&&s.vertical&&(Ye=ux(c,s.vertical,He,B.get("icon-text-fit-padding"),V,de)),Z&&(c=ux(c,Z,He,B.get("icon-text-fit-padding"),V,de)));const Qe=(Ue,mt,Ot)=>{if(mt.x<0||mt.x>=zt||mt.y<0||mt.y>=zt)return;let bt=null;if(oe){const{x:_t,y:ct,z:Dt}=L.projectTilePoint(mt.x,mt.y,Ot);bt={anchor:new Eo(_t,ct,Dt,0,void 0),up:L.upVector(Ot,mt.x,mt.y)}}(function(_t,ct,Dt,Gt,Wt,li,Nt,zi,Xt,ei,Ti,Ri,Li,Di,Oi,Hi,kn,xi,hn,sn,ci,ji,vn,Ei,en){const Xn=_t.addToLineVertexArray(ct,Gt);let Rn,Dn,ar,zn,So,tc,oh,ah=0,av=0,lv=0,cv=0,rg=-1,sg=-1;const to={};let uv=Dl.exports("");const Fa=Dt?Dt.anchor:ct;let og=0,ag=0;if(Xt._unevaluatedLayout.getValue("text-radial-offset")===void 0?[og,ag]=Xt.layout.get("text-offset").evaluate(ci,{},en).map(Ar=>Ar*jn):(og=Xt.layout.get("text-radial-offset").evaluate(ci,{},en)*jn,ag=Vm),_t.allowVerticalPlacement&&Wt.vertical){const Ar=Wt.vertical;if(Oi)tc=Gm(Ar),zi&&(oh=Gm(zi));else{const Sr=Xt.layout.get("text-rotate").evaluate(ci,{},en)+90;ar=wf(ei,Fa,ct,Ti,Ri,Li,Ar,Di,Sr,Hi),zi&&(zn=wf(ei,Fa,ct,Ti,Ri,Li,zi,xi,Sr))}}if(li){const Ar=Xt.layout.get("icon-rotate").evaluate(ci,{},en),Sr=Xt.layout.get("icon-text-fit")!=="none",lh=xx(li,Ar,vn,Sr),cg=zi?xx(zi,Ar,vn,Sr):void 0;Dn=wf(ei,Fa,ct,Ti,Ri,Li,li,xi,Ar),ah=4*lh.length;const hv=_t.iconSizeData;let Na=null;hv.kind==="source"?(Na=[Ys*Xt.layout.get("icon-size").evaluate(ci,{},en)],Na[0]>Ho&&fi(`${_t.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):hv.kind==="composite"&&(Na=[Ys*ji.compositeIconSizes[0].evaluate(ci,{},en),Ys*ji.compositeIconSizes[1].evaluate(ci,{},en)],(Na[0]>Ho||Na[1]>Ho)&&fi(`${_t.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),_t.addSymbols(_t.icon,lh,Na,sn,hn,ci,!1,Dt,ct,Xn.lineStartIndex,Xn.lineLength,-1,Ei,en),rg=_t.icon.placedSymbolArray.length-1,cg&&(av=4*cg.length,_t.addSymbols(_t.icon,cg,Na,sn,hn,ci,Nr.vertical,Dt,ct,Xn.lineStartIndex,Xn.lineLength,-1,Ei,en),sg=_t.icon.placedSymbolArray.length-1)}for(const Ar in Wt.horizontal){const Sr=Wt.horizontal[Ar];Rn||(uv=Dl.exports(Sr.text),Oi?So=Gm(Sr):Rn=wf(ei,Fa,ct,Ti,Ri,Li,Sr,Di,Xt.layout.get("text-rotate").evaluate(ci,{},en),Hi));const lh=Sr.positionedLines.length===1;if(lv+=wx(_t,Dt,ct,Sr,Nt,Xt,Oi,ci,Hi,Xn,Wt.vertical?Nr.horizontal:Nr.horizontalOnly,lh?Object.keys(Wt.horizontal):[Ar],to,rg,ji,Ei,en),lh)break}Wt.vertical&&(cv+=wx(_t,Dt,ct,Wt.vertical,Nt,Xt,Oi,ci,Hi,Xn,Nr.vertical,["vertical"],to,sg,ji,Ei,en));let ea=-1;const lg=(Ar,Sr)=>Ar?Math.max(Ar,Sr):Sr;ea=lg(So,ea),ea=lg(tc,ea),ea=lg(oh,ea);const DA=ea>-1?1:0;_t.glyphOffsetArray.length>=Yo.MAX_GLYPHS&&fi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),ci.sortKey!==void 0&&_t.addToSortKeyRanges(_t.symbolInstances.length,ci.sortKey),_t.symbolInstances.emplaceBack(Fa.x,Fa.y,Fa.z,ct.x,ct.y,to.right>=0?to.right:-1,to.center>=0?to.center:-1,to.left>=0?to.left:-1,to.vertical>=0?to.vertical:-1,rg,sg,uv,Rn!==void 0?Rn:_t.collisionBoxArray.length,Rn!==void 0?Rn+1:_t.collisionBoxArray.length,ar!==void 0?ar:_t.collisionBoxArray.length,ar!==void 0?ar+1:_t.collisionBoxArray.length,Dn!==void 0?Dn:_t.collisionBoxArray.length,Dn!==void 0?Dn+1:_t.collisionBoxArray.length,zn||_t.collisionBoxArray.length,zn?zn+1:_t.collisionBoxArray.length,Ti,lv,cv,ah,av,DA,0,og,ag,ea)})(r,mt,bt,Ue,s,c,d,Ye,r.layers[0],r.collisionBoxArray,t.index,t.sourceLayerIndex,r.index,ye,Le,w,0,pe,Ne,V,t,m,T,S,C)};if(Je==="line")for(const Ue of gx(t.geometry,0,0,zt,zt)){const mt=HE(Ue,ue,Re,s.vertical||Z,c,24,se,r.overscaling,zt);for(const Ot of mt){const bt=Z;bt&&nA(r,bt.text,Be,Ot)||Qe(Ue,Ot,C)}}else if(Je==="line-center"){for(const Ue of t.geometry)if(Ue.length>1){const mt=qE(Ue,Re,s.vertical||Z,c,24,se);mt&&Qe(Ue,mt,C)}}else if(t.type==="Polygon")for(const Ue of Im(t.geometry,0)){const mt=JE(Ue,16);Qe(Ue[0],new Eo(mt.x,mt.y,0,0,void 0),C)}else if(t.type==="LineString")for(const Ue of t.geometry)Qe(Ue,new Eo(Ue[0].x,Ue[0].y,0,0,void 0),C);else if(t.type==="Point")for(const Ue of t.geometry)for(const mt of Ue)Qe([mt],new Eo(mt.x,mt.y,0,0,void 0),C)}const Ho=32640;function wx(r,t,s,c,d,m,_,v,w,T,S,C,L,z,B,V,Z){const oe=function(ue,ye,pe,Re,Le,Ne,Je,Be){const qe=[];if(ye.positionedLines.length===0)return qe;const He=Re.layout.get("text-rotate").evaluate(Ne,{})*Math.PI/180,Ye=function(bt){const _t=bt[0],ct=bt[1],Dt=_t*ct;return Dt>0?[_t,-ct]:Dt<0?[-_t,ct]:_t===0?[ct,_t]:[ct,-_t]}(pe);let Qe=Math.abs(ye.top-ye.bottom);for(const bt of ye.positionedLines)Qe-=bt.lineOffset;const Ue=ye.positionedLines.length,mt=Qe/Ue;let Ot=ye.top-pe[1];for(let bt=0;bt<Ue;++bt){const _t=ye.positionedLines[bt];Ot=XE(ye,mt,Ot,bt);for(const ct of _t.positionedGlyphs){if(!ct.rect)continue;const Dt=ct.rect||{};let Gt=4,Wt=!0,li=1,Nt=0;if(ct.imageName){const Ei=Je[ct.imageName];if(!Ei)continue;if(Ei.sdf){fi("SDF images are not supported in formatted text and will be ignored.");continue}Wt=!1,li=Ei.pixelRatio,Gt=1/li}const zi=(Le||Be)&&ct.vertical,Xt=ct.metrics.advance*ct.scale/2,ei=ct.metrics,Ti=ct.rect;if(Ti===null)continue;Be&&ye.verticalizable&&(Nt=ct.imageName?Xt-ct.metrics.width*ct.scale/2:0);const Ri=Le?[ct.x+Xt,ct.y]:[0,0];let Li=[0,0],Di=[0,0],Oi=!1;Le||(zi?(Di=[ct.x+Xt+Ye[0],ct.y+Ye[1]-Nt],Oi=!0):Li=[ct.x+Xt+pe[0],ct.y+pe[1]-Nt]);const Hi=Ti.w*ct.scale/(li*(ct.localGlyph?2:1)),kn=Ti.h*ct.scale/(li*(ct.localGlyph?2:1));let xi,hn,sn,ci;if(zi){const Ei=ct.y-Ot,en=new Ee(-Xt,Xt-Ei),Xn=-Math.PI/2,Rn=new Ee(...Di);xi=new Ee(-Xt+Li[0],Li[1]),xi._rotateAround(Xn,en)._add(Rn),xi.x+=-Ei+Xt,xi.y-=(ei.left-Gt)*ct.scale;const Dn=ct.imageName?ei.advance*ct.scale:jn*ct.scale,ar=String.fromCharCode(ct.glyph);CE(ar)?xi.x+=(1-Gt)*ct.scale:LE(ar)?xi.x+=Dn-ei.height*ct.scale+(-Gt-1)*ct.scale:xi.x+=ct.imageName||ei.width+2*Gt===Ti.w&&ei.height+2*Gt===Ti.h?(Dn-kn)/2:(Dn-(ei.height+2*Gt)*ct.scale)/2,hn=new Ee(xi.x,xi.y-Hi),sn=new Ee(xi.x+kn,xi.y),ci=new Ee(xi.x+kn,xi.y-Hi)}else{const Ei=(ei.left-Gt)*ct.scale-Xt+Li[0],en=(-ei.top-Gt)*ct.scale+Li[1],Xn=Ei+Hi,Rn=en+kn;xi=new Ee(Ei,en),hn=new Ee(Xn,en),sn=new Ee(Ei,Rn),ci=new Ee(Xn,Rn)}if(He){let Ei;Ei=Le?new Ee(0,0):Oi?new Ee(Ye[0],Ye[1]):new Ee(pe[0],pe[1]),xi._rotateAround(He,Ei),hn._rotateAround(He,Ei),sn._rotateAround(He,Ei),ci._rotateAround(He,Ei)}const ji=new Ee(0,0),vn=new Ee(0,0);qe.push({tl:xi,tr:hn,bl:sn,br:ci,tex:Dt,writingMode:ye.writingMode,glyphOffset:Ri,sectionIndex:ct.sectionIndex,isSDF:Wt,pixelOffsetTL:ji,pixelOffsetBR:vn,minFontScaleX:0,minFontScaleY:0})}}return qe}(0,c,w,m,_,v,d,r.allowVerticalPlacement),de=r.textSizeData;let se=null;de.kind==="source"?(se=[Ys*m.layout.get("text-size").evaluate(v,{},Z)],se[0]>Ho&&fi(`${r.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):de.kind==="composite"&&(se=[Ys*B.compositeTextSizes[0].evaluate(v,{},Z),Ys*B.compositeTextSizes[1].evaluate(v,{},Z)],(se[0]>Ho||se[1]>Ho)&&fi(`${r.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),r.addSymbols(r.text,oe,se,w,_,v,S,t,s,T.lineStartIndex,T.lineLength,z,V,Z);for(const ue of C)L[ue]=r.text.placedSymbolArray.length-1;return 4*oe.length}function Tx(r){for(const t in r)return r[t];return null}function wf(r,t,s,c,d,m,_,v,w,T){let S=_.top,C=_.bottom,L=_.left,z=_.right;const B=_.collisionPadding;if(B&&(L-=B[0],S-=B[1],z+=B[2],C+=B[3]),w){const V=new Ee(L,S),Z=new Ee(z,S),oe=new Ee(L,C),de=new Ee(z,C),se=et(w);let ue=new Ee(0,0);T&&(ue=new Ee(T[0],T[1])),V._rotateAround(se,ue),Z._rotateAround(se,ue),oe._rotateAround(se,ue),de._rotateAround(se,ue),L=Math.min(V.x,Z.x,oe.x,de.x),z=Math.max(V.x,Z.x,oe.x,de.x),S=Math.min(V.y,Z.y,oe.y,de.y),C=Math.max(V.y,Z.y,oe.y,de.y)}return r.emplaceBack(t.x,t.y,t.z,s.x,s.y,L,S,z,C,v,c,d,m),r.length-1}function Gm(r){r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);const t=r.bottom-r.top;return t>0?Math.max(10,t):null}function nA(r,t,s,c){const d=r.compareText;if(t in d){const m=d[t];for(let _=m.length-1;_>=0;_--)if(c.dist(m[_])<s)return!0}else d[t]=[];return d[t].push(c),!1}const rA=rt([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Ex}=rA,Ax=rt([{name:"a_pos_3",components:3,type:"Int16"}]);var Yu=rt([{name:"a_pos",type:"Int16",components:2}]);const Ao=zt/Math.PI/2,Wm=2*ds(1,0)*Ao*Math.PI,Xl=64,Yl=[Xl,32,16],Ls=-Ao,ks=Ao,sA=[new sr([Ls,Ls,Ls],[ks,ks,ks]),new sr([Ls,Ls,Ls],[0,0,ks]),new sr([0,Ls,Ls],[ks,0,ks]),new sr([Ls,0,Ls],[0,ks,ks]),new sr([0,0,Ls],[ks,ks,ks])];function Sx(r,t,s,c=!0){const d=Fr([],r._camera.position,r.worldSize),m=[t,s,1,1];Ra(m,m,r.pixelMatrixInverse),_0(m,m,1/m[3]);const _=rr([],Cs([],m,d)),v=r.globeMatrix,w=[v[12],v[13],v[14]],T=Cs([],w,d),S=Lu(T),C=rr([],T),L=r.worldSize/(2*Math.PI),z=fs(C,_),B=Math.asin(L/S);if(B<Math.acos(z)){if(!c)return null;const Je=[],Be=[];Fr(Je,_,S/z),rr(Be,Cs(Be,Je,T)),rr(_,bo(_,T,Fr(_,Be,Math.tan(B)*S)))}const V=[];new bm(d,_).closestPointOnSphere(w,L,V);const Z=rr([],Gn(v,0)),oe=rr([],Gn(v,1)),de=rr([],Gn(v,2)),se=fs(Z,V),ue=fs(oe,V),ye=fs(de,V),pe=Tt(Math.asin(-ue/L));let Re=Tt(Math.atan2(se,ye));Re=r.center.lng+function(Je,Be){const qe=(Be-Je+180)%360-180;return qe<-180?qe+360:qe}(r.center.lng,Re);const Le=$s(Re),Ne=Lt(qs(pe),0,1);return new Ol(Le,Ne)}class oA{constructor(t,s,c){this.a=Cs([],t,c),this.b=Cs([],s,c),this.center=c;const d=rr([],this.a),m=rr([],this.b);this.angle=Math.acos(fs(d,m))}}function Zm(r,t){if(r.angle===0)return null;let s;return s=r.a[t]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[t]/r.a[t]/Math.sin(r.angle)-1/Math.tan(r.angle)),s<0||s>1?null:function(c,d,m,_){const v=Math.sin(m);return c*(Math.sin((1-_)*m)/v)+d*(Math.sin(_*m)/v)}(r.a[t],r.b[t],r.angle,Lt(s,0,1))+r.center[t]}function Ks(r){if(r.z<=1)return sA[r.z+2*r.y+r.x];const t=$m(Tf(r));return sr.fromPoints(t)}function za(r,t,s){return Fr(r,r,1-s),Du(r,r,t,s)}function Mx(r,t){const s=Jl(t.zoom);if(s===0)return Ks(r);const c=Tf(r),d=$m(c),m=$s(c.getWest())*t.worldSize,_=$s(c.getEast())*t.worldSize,v=qs(c.getNorth())*t.worldSize,w=qs(c.getSouth())*t.worldSize,T=[m,v,0],S=[_,v,0],C=[m,w,0],L=[_,w,0],z=gm([],t.globeMatrix);return un(T,T,z),un(S,S,z),un(C,C,z),un(L,L,z),d[0]=za(d[0],C,s),d[1]=za(d[1],L,s),d[2]=za(d[2],S,s),d[3]=za(d[3],T,s),sr.fromPoints(d)}function Px(r,t,s){for(const c of r)un(c,c,t),Fr(c,c,s)}function aA(r,t,s){const c=t/r.worldSize,d=r.globeMatrix;if(s.z<=1){const Le=Ks(s).getCorners();return Px(Le,d,c),sr.fromPoints(Le)}const m=Tf(s),_=$m(m);Px(_,d,c);const v=Number.MAX_VALUE,w=[-v,-v,-v],T=[v,v,v];if(m.contains(r.center)){for(const Je of _)ku(T,T,Je),Ru(w,w,Je);w[2]=0;const Le=r.point,Ne=[Le.x*c,Le.y*c,0];return ku(T,T,Ne),Ru(w,w,Ne),new sr(T,w)}const S=[d[12]*c,d[13]*c,d[14]*c],C=m.getCenter(),L=Lt(r.center.lat,-85.051129,Hs),z=Lt(C.lat,-85.051129,Hs),B=$s(r.center.lng),V=qs(L);let Z=B-$s(C.lng);const oe=V-qs(z);Z>.5?Z-=1:Z<-.5&&(Z+=1);let de=0;Math.abs(Z)>Math.abs(oe)?de=Z>=0?1:3:(de=oe>=0?0:2,Du(S,S,[d[4]*c,d[5]*c,d[6]*c],-Math.sin(et(oe>=0?m.getSouth():m.getNorth()))*Ao));const se=_[de],ue=_[(de+1)%4],ye=new oA(se,ue,S),pe=[Zm(ye,0)||se[0],Zm(ye,1)||se[1],Zm(ye,2)||se[2]],Re=Jl(r.zoom);if(Re>0){const Le=function({x:Je,y:Be,z:qe},He,Ye,Qe,Ue){const mt=1/(1<<qe);let Ot=Je*mt,bt=Ot+mt,_t=Be*mt,ct=_t+mt,Dt=0;const Gt=(Ot+bt)/2-Qe;return Gt>.5?Dt=-1:Gt<-.5&&(Dt=1),Ot=((Ot+Dt)*He-(Qe*=He))*Ye+Qe,bt=((bt+Dt)*He-Qe)*Ye+Qe,_t=(_t*He-(Ue*=He))*Ye+Ue,ct=(ct*He-Ue)*Ye+Ue,[[Ot,ct,0],[bt,ct,0],[bt,_t,0],[Ot,_t,0]]}(s,t,r._pixelsPerMercatorPixel,B,V);for(let Je=0;Je<_.length;Je++)za(_[Je],Le[Je],Re);const Ne=bo([],Le[de],Le[(de+1)%4]);Fr(Ne,Ne,.5),za(pe,Ne,Re)}for(const Le of _)ku(T,T,Le),Ru(w,w,Le);return T[2]=Math.min(se[2],ue[2]),ku(T,T,pe),Ru(w,w,pe),new sr(T,w)}function Tf({x:r,y:t,z:s}){const c=1/(1<<s),d=new di(Br(r*c),Vn((t+1)*c)),m=new di(Br((r+1)*c),Vn(t*c));return new qo(d,m)}function $m(r){const t=et(r.getNorth()),s=et(r.getSouth()),c=Math.cos(t),d=Math.cos(s),m=Math.sin(t),_=Math.sin(s),v=r.getWest(),w=r.getEast();return[Kl(d,_,v),Kl(d,_,w),Kl(c,m,w),Kl(c,m,v)]}function Kl(r,t,s,c=Ao){return s=et(s),[r*Math.sin(s)*c,-t*c,r*Math.cos(s)*c]}function Ku(r,t,s){return Kl(Math.cos(et(r)),Math.sin(et(r)),t,s)}function Ju(r,t,s,c){const d=1<<s.z,m=(r/zt+s.x)/d;return Ku(Vn((t/zt+s.y)/d),Br(m),c)}function Ef({min:r,max:t}){return 16383/Math.max(t[0]-r[0],t[1]-r[1],t[2]-r[2])}const Ix=new Float64Array(16);function Qu(r){const t=Ef(r),s=d0(Ix,[t,t,t]);return Cu(s,s,((c=[])[0]=-(d=r.min)[0],c[1]=-d[1],c[2]=-d[2],c));var c,d}function qm(r){const t=(c=r.min,(s=Ix)[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=c[0],s[13]=c[1],s[14]=c[2],s[15]=1,s);var s,c;const d=1/Ef(r);return ka(t,t,[d,d,d])}function Cx(r,t,s,c,d){const m=function(w){const T=zt/(2*Math.PI);return w/(2*Math.PI)/T}(s),_=[r,t,-s/(2*Math.PI)],v=Xs(new Float64Array(16));return Cu(v,v,_),ka(v,v,[m,m,m]),_m(v,v,et(-d)),sf(v,v,et(-c)),v}function Jl(r){return An(5,6,r)}function Lx(r,t){const s=Ku(t.lat,t.lng),c=function(B){const V=Ku(B._center.lat,B._center.lng);let Z=vm([],Nl(0,1,0),V);const oe=f0([],-B.angle,V);Z=un(Z,Z,oe),f0(oe,-B._pitch,Z);const de=rr([],V);return Fr(de,de,B.cameraToCenterDistance/B.pixelsPerMeter*Wm),un(de,de,oe),bo([],V,de)}(r);return _=(d=xm([],c,s))[0],v=d[1],w=d[2],T=(m=s)[0],S=m[1],C=m[2],z=(L=Math.sqrt(_*_+v*v+w*w)*Math.sqrt(T*T+S*S+C*C))&&fs(d,m)/L,Math.acos(Math.min(Math.max(z,-1),1));var d,m,_,v,w,T,S,C,L,z}const kx=et(85),lA=Math.cos(kx),cA=Math.sin(kx);function Rx(r,t){const s=r.fovAboveCenter,c=r.elevation?r.elevation.getMinElevationBelowMSL()*t:0,d=(r._camera.position[2]*r.worldSize-c)/Math.cos(r._pitch),m=Math.sin(s)*d/Math.sin(Math.max(Math.PI/2-r._pitch-s,.01)),_=Math.sin(r._pitch)*m+d;return Math.min(1.01*_,d*(1/r._horizonShift))}function Oa(r,t){if(!t.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:t};const s=Math.pow(2,-r.z),c=r.x*s,d=(r.x+1)*s,m=r.y*s,_=(r.y+1)*s,v=Br(c),w=Br(d),T=Vn(m),S=Vn(_),C=t.project(v,T),L=t.project(w,T),z=t.project(w,S),B=t.project(v,S);let V=Math.min(C.x,L.x,z.x,B.x),Z=Math.min(C.y,L.y,z.y,B.y),oe=Math.max(C.x,L.x,z.x,B.x),de=Math.max(C.y,L.y,z.y,B.y);const se=s/16;function ue(pe,Re,Le,Ne,Je,Be){const qe=(Le+Je)/2,He=(Ne+Be)/2,Ye=t.project(Br(qe),Vn(He)),Qe=Math.max(0,V-Ye.x,Z-Ye.y,Ye.x-oe,Ye.y-de);V=Math.min(V,Ye.x),oe=Math.max(oe,Ye.x),Z=Math.min(Z,Ye.y),de=Math.max(de,Ye.y),Qe>se&&(ue(pe,Ye,Le,Ne,qe,He),ue(Ye,Re,qe,He,Je,Be))}ue(C,L,c,m,d,m),ue(L,z,d,m,d,_),ue(z,B,d,_,c,_),ue(B,C,c,_,c,m),V-=se,Z-=se,oe+=se,de+=se;const ye=1/Math.max(oe-V,de-Z);return{scale:ye,x:V*ye,y:Z*ye,x2:oe*ye,y2:de*ye,projection:t}}const uA=Xs(new Float32Array(16));class Xo{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,s){return{x:0,y:0,z:0}}unproject(t,s){return new di(0,0)}projectTilePoint(t,s,c){return{x:t,y:s,z:0}}locationPoint(t,s,c=!0){return t._coordinatePoint(t.locationCoordinate(s),c)}pixelsPerMeter(t,s){return ds(1,t)*s}pixelSpaceConversion(t,s,c){return 1}farthestPixelDistance(t){return Rx(t,t.pixelsPerMeter)}pointCoordinate(t,s,c,d){const m=t.horizonLineFromTop(!1),_=new Ee(s,Math.max(m,c));return t.rayIntersectionCoordinate(t.pointRayIntersection(_,d))}pointCoordinate3D(t,s,c){const d=new Ee(s,c);if(t.elevation)return t.elevation.pointCoordinate(d);{const m=this.pointCoordinate(t,d.x,d.y,0);return[m.x,m.y,m.z]}}isPointAboveHorizon(t,s){if(t.elevation)return!this.pointCoordinate3D(t,s.x,s.y);const c=t.horizonLineFromTop();return s.y<c}createInversionMatrix(t,s){return uA}createTileMatrix(t,s,c){let d,m,_;const v=c.canonical,w=Xs(new Float64Array(16));if(this.isReprojectedInTileSpace){const T=Oa(v,this);d=1,m=T.x+c.wrap*T.scale,_=T.y,ka(w,w,[d/T.scale,d/T.scale,t.pixelsPerMeter/s])}else d=s/t.zoomScale(v.z),m=(v.x+Math.pow(2,v.z)*c.wrap)*d,_=v.y*d;return Cu(w,w,[m,_,0]),ka(w,w,[d/zt,d/zt,1]),w}upVector(t,s,c){return[0,0,1]}upVectorScale(t,s,c){return{metersToTile:1}}}class hA extends Xo{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[s,c]=this.parallels=t.parallels||[29.5,45.5],d=Math.sin(et(s));this.n=(d+Math.sin(et(c)))/2,this.c=1+d*(2*this.n-d),this.r0=Math.sqrt(this.c)/this.n}project(t,s){const{n:c,c:d,r0:m}=this,_=et(t-this.center[0]),v=et(s),w=Math.sqrt(d-2*c*Math.sin(v))/c;return{x:w*Math.sin(_*c),y:w*Math.cos(_*c)-m,z:0}}unproject(t,s){const{n:c,c:d,r0:m}=this,_=m+s;let v=Math.atan2(t,Math.abs(_))*Math.sign(_);_*c<0&&(v-=Math.PI*Math.sign(t)*Math.sign(_));const w=et(this.center[0])*c;v=fn(v,-Math.PI-w,Math.PI-w);const T=Lt(Tt(v/c)+this.center[0],-180,180),S=Math.asin(Lt((d-(t*t+_*_)*c*c)/(2*c),-1,1)),C=Lt(Tt(S),-85.051129,Hs);return new di(T,C)}}const eh=1.340264,th=-.081106,ih=893e-6,nh=.003796,Af=Math.sqrt(3)/2;class dA extends Xo{project(t,s){s=s/180*Math.PI,t=t/180*Math.PI;const c=Math.asin(Af*Math.sin(s)),d=c*c,m=d*d*d;return{x:.5*(t*Math.cos(c)/(Af*(eh+3*th*d+m*(7*ih+9*nh*d)))/Math.PI+.5),y:1-.5*(c*(eh+th*d+m*(ih+nh*d))/Math.PI+1),z:0}}unproject(t,s){t=(2*t-.5)*Math.PI;let c=s=(2*(1-s)-1)*Math.PI,d=c*c,m=d*d*d;for(let S,C,L,z=0;z<12&&(C=c*(eh+th*d+m*(ih+nh*d))-s,L=eh+3*th*d+m*(7*ih+9*nh*d),S=C/L,c=Lt(c-S,-Math.PI/3,Math.PI/3),d=c*c,m=d*d*d,!(Math.abs(S)<1e-12));++z);const _=Af*t*(eh+3*th*d+m*(7*ih+9*nh*d))/Math.cos(c),v=Math.asin(Math.sin(c)/Af),w=Lt(180*_/Math.PI,-180,180),T=Lt(180*v/Math.PI,-85.051129,Hs);return new di(w,T)}}class fA extends Xo{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,s){return{x:.5+t/360,y:.5-s/360,z:0}}unproject(t,s){const c=360*(t-.5),d=Lt(360*(.5-s),-85.051129,Hs);return new di(c,d)}}const Ql=Math.PI/2;function Sf(r){return Math.tan((Ql+r)/2)}class pA extends Xo{constructor(t){super(t),this.center=t.center||[0,30];const[s,c]=this.parallels=t.parallels||[30,30];let d=et(s),m=et(c);this.southernCenter=d+m<0,this.southernCenter&&(d=-d,m=-m);const _=Math.cos(d),v=Sf(d);this.n=d===m?Math.sin(d):Math.log(_/Math.cos(m))/Math.log(Sf(m)/v),this.f=_*Math.pow(Sf(d),this.n)/this.n}project(t,s){s=et(s),this.southernCenter&&(s=-s),t=et(t-this.center[0]);const c=1e-6,{n:d,f:m}=this;m>0?s<-Ql+c&&(s=-Ql+c):s>Ql-c&&(s=Ql-c);const _=m/Math.pow(Sf(s),d);let v=_*Math.sin(d*t),w=m-_*Math.cos(d*t);return v=.5*(v/Math.PI+.5),w=.5*(w/Math.PI+.5),{x:v,y:this.southernCenter?w:1-w,z:0}}unproject(t,s){t=(2*t-.5)*Math.PI,this.southernCenter&&(s=1-s),s=(2*(1-s)-.5)*Math.PI;const{n:c,f:d}=this,m=d-s,_=Math.sign(m),v=Math.sign(c)*Math.sqrt(t*t+m*m);let w=Math.atan2(t,Math.abs(m))*_;m*c<0&&(w-=Math.PI*Math.sign(t)*_);const T=Lt(Tt(w/c)+this.center[0],-180,180),S=Lt(Tt(2*Math.atan(Math.pow(d/v,1/c))-Ql),-85.051129,Hs);return new di(T,this.southernCenter?-S:S)}}class Dx extends Xo{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,s){return{x:$s(t),y:qs(s),z:0}}unproject(t,s){const c=Br(t),d=Vn(s);return new di(c,d)}}const zx=et(Hs);class mA extends Xo{project(t,s){const c=(s=et(s))*s,d=c*c;return{x:.5*((t=et(t))*(.8707-.131979*c+d*(d*(.003971*c-.001529*d)-.013791))/Math.PI+.5),y:1-.5*(s*(1.007226+c*(.015085+d*(.028874*c-.044475-.005916*d)))/Math.PI+1),z:0}}unproject(t,s){t=(2*t-.5)*Math.PI;let c=s=(2*(1-s)-1)*Math.PI,d=25,m=0,_=c*c;do{_=c*c;const T=_*_;m=(c*(1.007226+_*(.015085+T*(.028874*_-.044475-.005916*T)))-s)/(1.007226+_*(.045255+T*(.259866*_-.311325-.005916*11*T))),c=Lt(c-m,-zx,zx)}while(Math.abs(m)>1e-6&&--d>0);_=c*c;const v=Lt(Tt(t/(.8707+_*(_*(_*_*_*(.003971-.001529*_)-.013791)-.131979))),-180,180),w=Tt(c);return new di(v,w)}}const Ox=et(Hs);class gA extends Xo{project(t,s){s=et(s),t=et(t);const c=Math.cos(s),d=2/Math.PI,m=Math.acos(c*Math.cos(t/2)),_=Math.sin(m)/m,v=.5*(t*d+2*c*Math.sin(t/2)/_)||0,w=.5*(s+Math.sin(s)/_)||0;return{x:.5*(v/Math.PI+.5),y:1-.5*(w/Math.PI+1),z:0}}unproject(t,s){let c=t=(2*t-.5)*Math.PI,d=s=(2*(1-s)-1)*Math.PI,m=25;const _=1e-6;let v=0,w=0;do{const T=Math.cos(d),S=Math.sin(d),C=2*S*T,L=S*S,z=T*T,B=Math.cos(c/2),V=Math.sin(c/2),Z=2*B*V,oe=V*V,de=1-z*B*B,se=de?1/de:0,ue=de?Math.acos(T*B)*Math.sqrt(1/de):0,ye=.5*(2*ue*T*V+2*c/Math.PI)-t,pe=.5*(ue*S+d)-s,Re=.5*se*(z*oe+ue*T*B*L)+1/Math.PI,Le=se*(Z*C/4-ue*S*V),Ne=.125*se*(C*V-ue*S*z*Z),Je=.5*se*(L*B+ue*oe*T)+.5,Be=Le*Ne-Je*Re;v=(pe*Le-ye*Je)/Be,w=(ye*Ne-pe*Re)/Be,c=Lt(c-v,-Math.PI,Math.PI),d=Lt(d-w,-Ox,Ox)}while((Math.abs(v)>_||Math.abs(w)>_)&&--m>0);return new di(Tt(c),Tt(d))}}class Bx extends Xo{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(et(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,s){const{scale:c,cosPhi:d}=this;return{x:et(t)*d*c+.5,y:-Math.sin(et(s))/d*c+.5,z:0}}unproject(t,s){const{scale:c,cosPhi:d}=this,m=-(s-.5)/c,_=Lt(Tt((t-.5)/c)/d,-180,180),v=Math.asin(Lt(m*d,-1,1)),w=Lt(Tt(v),-85.051129,Hs);return new di(_,w)}}class _A extends Dx{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug","custom"],this.range=[3,5]}projectTilePoint(t,s,c){const d=Ju(t,s,c);return un(d,d,Qu(Ks(c))),{x:d[0],y:d[1],z:d[2]}}locationPoint(t,s){const c=Ku(s.lat,s.lng),d=rr([],c),m=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(s),t._centerAltitude):t._centerAltitude;Du(c,c,d,ds(1,0)*zt*m);const _=Xs(new Float64Array(16));return Fl(_,t.pixelMatrix,t.globeMatrix),un(c,c,_),new Ee(c[0],c[1])}pixelsPerMeter(t,s){return ds(1,0)*s}pixelSpaceConversion(t,s,c){const d=ds(1,t)*s,m=ai(ds(1,45)*s,d,c);return this.pixelsPerMeter(t,s)/m}createTileMatrix(t,s,c){const d=qm(Ks(c.canonical));return Fl(new Float64Array(16),t.globeMatrix,d)}createInversionMatrix(t,s){const{center:c}=t,d=Qu(Ks(s));return sf(d,d,et(c.lng)),_m(d,d,et(c.lat)),ka(d,d,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(d)}pointCoordinate(t,s,c,d){return Sx(t,s,c,!0)||new Ol(0,0)}pointCoordinate3D(t,s,c){const d=this.pointCoordinate(t,s,c,0);return[d.x,d.y,d.z]}isPointAboveHorizon(t,s){return!Sx(t,s.x,s.y,!1)}farthestPixelDistance(t){const s=function(d,m){const _=d.cameraToCenterDistance,v=d._centerAltitude*m,w=d._camera,T=d._camera.forward(),S=bo([],Fr([],T,-_),[0,0,v]),C=d.worldSize/(2*Math.PI),L=[0,0,-C],z=d.width/d.height,B=Math.tan(d.fovAboveCenter),V=Fr([],w.up(),B),Z=Fr([],w.right(),B*z),oe=rr([],bo([],bo([],T,V),Z)),de=[];let se;if(new bm(S,oe).closestPointOnSphere(L,C,de)){const ue=bo([],de,L),ye=Cs([],ue,S);se=Math.cos(d.fovAboveCenter)*Lu(ye)}else{const ue=Cs([],S,L),ye=Cs([],L,S);rr(ye,ye);const pe=Lu(ue)-C;se=Math.sqrt(pe*(pe+2*C));const Re=Math.acos(se/(C+pe))-Math.acos(fs(T,ye));se*=Math.cos(Re)}return 1.01*se}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),c=Jl(t.zoom);if(c>0){const d=Rx(t,ds(1,t.center.lat)*t.worldSize),m=t.worldSize/(2*Math.PI),_=Math.max(t.width,t.height)/t.worldSize*Math.PI;return ai(s,d+m*(1-Math.cos(_)),Math.pow(c,10))}return s}upVector(t,s,c){return Ju(s,c,t,1)}upVectorScale(t){return{metersToTile:Wm*Ef(Ks(t))}}}function Fx(r){const t=r.parallels,s=!!t&&Math.abs(t[0]+t[1])<.01;switch(r.name){case"mercator":return new Dx(r);case"equirectangular":return new fA(r);case"naturalEarth":return new mA(r);case"equalEarth":return new dA(r);case"winkelTripel":return new gA(r);case"albers":return s?new Bx(r):new hA(r);case"lambertConformalConic":return s?new Bx(r):new pA(r);case"globe":return new _A(r)}throw new Error(`Invalid projection name: ${r.name}`)}const yA=df.types,xA=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Mf(r,t,s,c,d,m,_,v,w,T,S,C,L){const z=v?Math.min(Ho,Math.round(v[0])):0,B=v?Math.min(Ho,Math.round(v[1])):0;r.emplaceBack(t,s,Math.round(32*c),Math.round(32*d),m,_,(z<<1)+(w?1:0),B,16*T,16*S,256*C,256*L)}function Pf(r,t,s,c,d,m,_){r.emplaceBack(t,s,c,d,m,_)}function If(r,t,s,c,d){r.emplaceBack(t,s,c,d),r.emplaceBack(t,s,c,d),r.emplaceBack(t,s,c,d),r.emplaceBack(t,s,c,d)}function vA(r){for(const t of r.sections)if(k(t.text))return!0;return!1}class Hm{constructor(t){this.layoutVertexArray=new Vi,this.indexArray=new Hn,this.programConfigurations=t,this.segments=new cn,this.dynamicLayoutVertexArray=new xn,this.opacityVertexArray=new nn,this.placedSymbolArray=new Dy,this.globeExtVertexArray=new mi}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(t,s,c,d){this.isEmpty()||(c&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,wE.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,s),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,EE.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,xA,!0),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,TE.members,!0)),this.opacityVertexBuffer.itemSize=1),(c||d)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}}ft(Hm,"SymbolBuffers");class Xm{constructor(t,s,c){this.layoutVertexArray=new t,this.layoutAttributes=s,this.indexArray=new c,this.segments=new cn,this.collisionVertexArray=new _o,this.collisionVertexArrayExt=new zr}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,AE.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,SE.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}ft(Xm,"CollisionBuffers");class Yo{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(_=>_.id),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Xs([]),this.placementViewportMatrix=Xs([]);const s=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Rm(this.zoom,s["text-size"]),this.iconSizeData=Rm(this.zoom,s["icon-size"]);const c=this.layers[0].layout,d=c.get("symbol-sort-key"),m=c.get("symbol-z-order");this.canOverlap=c.get("text-allow-overlap")||c.get("icon-allow-overlap")||c.get("text-ignore-placement")||c.get("icon-ignore-placement"),this.sortFeaturesByKey=m!=="viewport-y"&&d.constantOr(1)!==void 0,this.sortFeaturesByY=(m==="viewport-y"||m==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=c.get("text-writing-mode").map(_=>Nr[_]),this.stateDependentLayerIds=this.layers.filter(_=>_.isStateDependent()).map(_=>_.id),this.sourceID=t.sourceID,this.projection=t.projection}createArrays(){this.text=new Hm(new Ia(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new Hm(new Ia(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new By,this.lineVertexArray=new Fy,this.symbolInstances=new Oy}calculateGlyphDependencies(t,s,c,d,m){for(let _=0;_<t.length;_++)if(s[t.charCodeAt(_)]=!0,d&&m){const v=$u[t.charAt(_)];v&&(s[v.charCodeAt(0)]=!0)}}populate(t,s,c,d){const m=this.layers[0],_=m.layout,v=this.projection.name==="globe",w=_.get("text-font"),T=_.get("text-field"),S=_.get("icon-image"),C=(T.value.kind!=="constant"||T.value.value instanceof $n&&!T.value.value.isEmpty()||T.value.value.toString().length>0)&&(w.value.kind!=="constant"||w.value.value.length>0),L=S.value.kind!=="constant"||!!S.value.value||Object.keys(S.parameters).length>0,z=_.get("symbol-sort-key");if(this.features=[],!C&&!L)return;const B=s.iconDependencies,V=s.glyphDependencies,Z=s.availableImages,oe=new le(this.zoom);for(const{feature:de,id:se,index:ue,sourceLayerIndex:ye}of t){const pe=m._featureFilter.needGeometry,Re=Ca(de,pe);if(!m._featureFilter.filter(oe,Re,c))continue;if(pe||(Re.geometry=vo(de,c,d)),v&&de.type!==1&&c.z<=5){const Be=Re.geometry,qe=.98078528056,He=(Ye,Qe)=>fs(Ju(Ye.x,Ye.y,c,1),Ju(Qe.x,Qe.y,c,1))<qe;for(let Ye=0;Ye<Be.length;Ye++)Be[Ye]=v2(Be[Ye],He)}let Le,Ne;if(C){const Be=m.getValueAndResolveTokens("text-field",Re,c,Z),qe=$n.factory(Be);vA(qe)&&(this.hasRTLText=!0),(!this.hasRTLText||K()==="unavailable"||this.hasRTLText&&fe.isParsed())&&(Le=IE(qe,m,Re))}if(L){const Be=m.getValueAndResolveTokens("icon-image",Re,c,Z);Ne=Be instanceof ir?Be:ir.fromString(Be)}if(!Le&&!Ne)continue;const Je=this.sortFeaturesByKey?z.evaluate(Re,{},c):void 0;if(this.features.push({id:se,text:Le,icon:Ne,index:ue,sourceLayerIndex:ye,geometry:Re.geometry,properties:de.properties,type:yA[de.type],sortKey:Je}),Ne&&(B[Ne.name]=!0),Le){const Be=w.evaluate(Re,{},c).join(","),qe=_.get("text-rotation-alignment")==="map"&&_.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Nr.vertical)>=0;for(const He of Le.sections)if(He.image)B[He.image.name]=!0;else{const Ye=h(Le.toString()),Qe=He.fontStack||Be,Ue=V[Qe]=V[Qe]||{};this.calculateGlyphDependencies(He.text,Ue,qe,this.allowVerticalPlacement,Ye)}}}_.get("symbol-placement")==="line"&&(this.features=function(de){const se={},ue={},ye=[];let pe=0;function Re(Be){ye.push(de[Be]),pe++}function Le(Be,qe,He){const Ye=ue[Be];return delete ue[Be],ue[qe]=Ye,ye[Ye].geometry[0].pop(),ye[Ye].geometry[0]=ye[Ye].geometry[0].concat(He[0]),Ye}function Ne(Be,qe,He){const Ye=se[qe];return delete se[qe],se[Be]=Ye,ye[Ye].geometry[0].shift(),ye[Ye].geometry[0]=He[0].concat(ye[Ye].geometry[0]),Ye}function Je(Be,qe,He){const Ye=He?qe[0][qe[0].length-1]:qe[0][0];return`${Be}:${Ye.x}:${Ye.y}`}for(let Be=0;Be<de.length;Be++){const qe=de[Be],He=qe.geometry,Ye=qe.text?qe.text.toString():null;if(!Ye){Re(Be);continue}const Qe=Je(Ye,He),Ue=Je(Ye,He,!0);if(Qe in ue&&Ue in se&&ue[Qe]!==se[Ue]){const mt=Ne(Qe,Ue,He),Ot=Le(Qe,Ue,ye[mt].geometry);delete se[Qe],delete ue[Ue],ue[Je(Ye,ye[Ot].geometry,!0)]=Ot,ye[mt].geometry=null}else Qe in ue?Le(Qe,Ue,He):Ue in se?Ne(Qe,Ue,He):(Re(Be),se[Qe]=pe-1,ue[Ue]=pe-1)}return ye.filter(Be=>Be.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((de,se)=>de.sortKey-se.sortKey)}update(t,s,c,d){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,s,this.layers,c,d),this.icon.programConfigurations.updatePaintArrays(t,s,this.layers,c,d))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Fx(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,s){const c=this.lineVertexArray.length,d=t.segment;if(d!==void 0){let m=t.dist(s[d+1]),_=t.dist(s[d]);const v={};for(let w=d+1;w<s.length;w++)v[w]={x:s[w].x,y:s[w].y,tileUnitDistanceFromAnchor:m},w<s.length-1&&(m+=s[w+1].dist(s[w]));for(let w=d||0;w>=0;w--)v[w]={x:s[w].x,y:s[w].y,tileUnitDistanceFromAnchor:_},w>0&&(_+=s[w-1].dist(s[w]));for(let w=0;w<s.length;w++){const T=v[w];this.lineVertexArray.emplaceBack(T.x,T.y,T.tileUnitDistanceFromAnchor)}}return{lineStartIndex:c,lineLength:this.lineVertexArray.length-c}}addSymbols(t,s,c,d,m,_,v,w,T,S,C,L,z,B){const V=t.indexArray,Z=t.layoutVertexArray,oe=t.globeExtVertexArray,de=t.segments.prepareSegment(4*s.length,Z,V,this.canOverlap?_.sortKey:void 0),se=this.glyphOffsetArray.length,ue=de.vertexLength,ye=this.allowVerticalPlacement&&v===Nr.vertical?Math.PI/2:0,pe=_.text&&_.text.sections;for(let Le=0;Le<s.length;Le++){const{tl:Ne,tr:Je,bl:Be,br:qe,tex:He,pixelOffsetTL:Ye,pixelOffsetBR:Qe,minFontScaleX:Ue,minFontScaleY:mt,glyphOffset:Ot,isSDF:bt,sectionIndex:_t}=s[Le],ct=de.vertexLength,Dt=Ot[1];if(Mf(Z,T.x,T.y,Ne.x,Dt+Ne.y,He.x,He.y,c,bt,Ye.x,Ye.y,Ue,mt),Mf(Z,T.x,T.y,Je.x,Dt+Je.y,He.x+He.w,He.y,c,bt,Qe.x,Ye.y,Ue,mt),Mf(Z,T.x,T.y,Be.x,Dt+Be.y,He.x,He.y+He.h,c,bt,Ye.x,Qe.y,Ue,mt),Mf(Z,T.x,T.y,qe.x,Dt+qe.y,He.x+He.w,He.y+He.h,c,bt,Qe.x,Qe.y,Ue,mt),w){const Gt=w.anchor,Wt=w.up;Pf(oe,Gt.x,Gt.y,Gt.z,Wt[0],Wt[1],Wt[2]),Pf(oe,Gt.x,Gt.y,Gt.z,Wt[0],Wt[1],Wt[2]),Pf(oe,Gt.x,Gt.y,Gt.z,Wt[0],Wt[1],Wt[2]),Pf(oe,Gt.x,Gt.y,Gt.z,Wt[0],Wt[1],Wt[2]),If(t.dynamicLayoutVertexArray,Gt.x,Gt.y,Gt.z,ye)}else If(t.dynamicLayoutVertexArray,T.x,T.y,T.z,ye);V.emplaceBack(ct,ct+1,ct+2),V.emplaceBack(ct+1,ct+2,ct+3),de.vertexLength+=4,de.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Ot[0]),Le!==s.length-1&&_t===s[Le+1].sectionIndex||t.programConfigurations.populatePaintArrays(Z.length,_,_.index,{},z,B,pe&&pe[_t])}const Re=w?w.anchor:T;t.placedSymbolArray.emplaceBack(Re.x,Re.y,Re.z,T.x,T.y,se,this.glyphOffsetArray.length-se,ue,S,C,T.segment,c?c[0]:0,c?c[1]:0,d[0],d[1],v,0,!1,0,L,0)}_commitLayoutVertex(t,s,c,d,m,_,v){t.emplaceBack(s,c,d,m,_,Math.round(v.x),Math.round(v.y))}_addCollisionDebugVertices(t,s,c,d,m,_,v){const w=c.segments.prepareSegment(4,c.layoutVertexArray,c.indexArray),T=w.vertexLength,S=v.tileAnchorX,C=v.tileAnchorY;for(let z=0;z<4;z++)c.collisionVertexArray.emplaceBack(0,0,0,0);c.collisionVertexArrayExt.emplaceBack(s,-t.padding,-t.padding),c.collisionVertexArrayExt.emplaceBack(s,t.padding,-t.padding),c.collisionVertexArrayExt.emplaceBack(s,t.padding,t.padding),c.collisionVertexArrayExt.emplaceBack(s,-t.padding,t.padding),this._commitLayoutVertex(c.layoutVertexArray,d,m,_,S,C,new Ee(t.x1,t.y1)),this._commitLayoutVertex(c.layoutVertexArray,d,m,_,S,C,new Ee(t.x2,t.y1)),this._commitLayoutVertex(c.layoutVertexArray,d,m,_,S,C,new Ee(t.x2,t.y2)),this._commitLayoutVertex(c.layoutVertexArray,d,m,_,S,C,new Ee(t.x1,t.y2)),w.vertexLength+=4;const L=c.indexArray;L.emplaceBack(T,T+1),L.emplaceBack(T+1,T+2),L.emplaceBack(T+2,T+3),L.emplaceBack(T+3,T),w.primitiveLength+=4}_addTextDebugCollisionBoxes(t,s,c,d,m,_){for(let v=d;v<m;v++){const w=c.get(v),T=this.getSymbolInstanceTextSize(t,_,s,v);this._addCollisionDebugVertices(w,T,this.textCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,_)}}_addIconDebugCollisionBoxes(t,s,c,d,m,_){for(let v=d;v<m;v++){const w=c.get(v),T=this.getSymbolInstanceIconSize(t,s,_.placedIconSymbolIndex);this._addCollisionDebugVertices(w,T,this.iconCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,_)}}generateCollisionDebugBuffers(t,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Xm(Ii,K0.members,Or),this.iconCollisionBox=new Xm(Ii,K0.members,Or);const c=Gl(this.iconSizeData,t),d=Gl(this.textSizeData,t);for(let m=0;m<this.symbolInstances.length;m++){const _=this.symbolInstances.get(m);this._addTextDebugCollisionBoxes(d,t,s,_.textBoxStartIndex,_.textBoxEndIndex,_),this._addTextDebugCollisionBoxes(d,t,s,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_),this._addIconDebugCollisionBoxes(c,t,s,_.iconBoxStartIndex,_.iconBoxEndIndex,_),this._addIconDebugCollisionBoxes(c,t,s,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_)}}getSymbolInstanceTextSize(t,s,c,d){const m=this.text.placedSymbolArray.get(s.rightJustifiedTextSymbolIndex>=0?s.rightJustifiedTextSymbolIndex:s.centerJustifiedTextSymbolIndex>=0?s.centerJustifiedTextSymbolIndex:s.leftJustifiedTextSymbolIndex>=0?s.leftJustifiedTextSymbolIndex:s.verticalPlacedTextSymbolIndex>=0?s.verticalPlacedTextSymbolIndex:d),_=gf(this.textSizeData,t,m)/jn;return this.tilePixelRatio*_}getSymbolInstanceIconSize(t,s,c){const d=this.icon.placedSymbolArray.get(c),m=gf(this.iconSizeData,t,d);return this.tilePixelRatio*m}_commitDebugCollisionVertexUpdate(t,s,c){t.emplaceBack(s,-c,-c),t.emplaceBack(s,c,-c),t.emplaceBack(s,c,c),t.emplaceBack(s,-c,c)}_updateTextDebugCollisionBoxes(t,s,c,d,m,_){for(let v=d;v<m;v++){const w=c.get(v),T=this.getSymbolInstanceTextSize(t,_,s,v);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,T,w.padding)}}_updateIconDebugCollisionBoxes(t,s,c,d,m,_){for(let v=d;v<m;v++){const w=c.get(v),T=this.getSymbolInstanceIconSize(t,s,_);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,T,w.padding)}}updateCollisionDebugBuffers(t,s){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const c=Gl(this.iconSizeData,t),d=Gl(this.textSizeData,t);for(let m=0;m<this.symbolInstances.length;m++){const _=this.symbolInstances.get(m);this._updateTextDebugCollisionBoxes(d,t,s,_.textBoxStartIndex,_.textBoxEndIndex,_),this._updateTextDebugCollisionBoxes(d,t,s,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_),this._updateIconDebugCollisionBoxes(c,t,s,_.iconBoxStartIndex,_.iconBoxEndIndex,_.placedIconSymbolIndex),this._updateIconDebugCollisionBoxes(c,t,s,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_.placedIconSymbolIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,s,c,d,m,_,v,w,T){const S={};for(let C=s;C<c;C++){const L=t.get(C);S.textBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,padding:L.padding,projectedAnchorX:L.projectedAnchorX,projectedAnchorY:L.projectedAnchorY,projectedAnchorZ:L.projectedAnchorZ,tileAnchorX:L.tileAnchorX,tileAnchorY:L.tileAnchorY},S.textFeatureIndex=L.featureIndex;break}for(let C=d;C<m;C++){const L=t.get(C);S.verticalTextBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,padding:L.padding,projectedAnchorX:L.projectedAnchorX,projectedAnchorY:L.projectedAnchorY,projectedAnchorZ:L.projectedAnchorZ,tileAnchorX:L.tileAnchorX,tileAnchorY:L.tileAnchorY},S.verticalTextFeatureIndex=L.featureIndex;break}for(let C=_;C<v;C++){const L=t.get(C);S.iconBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,padding:L.padding,projectedAnchorX:L.projectedAnchorX,projectedAnchorY:L.projectedAnchorY,projectedAnchorZ:L.projectedAnchorZ,tileAnchorX:L.tileAnchorX,tileAnchorY:L.tileAnchorY},S.iconFeatureIndex=L.featureIndex;break}for(let C=w;C<T;C++){const L=t.get(C);S.verticalIconBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,padding:L.padding,projectedAnchorX:L.projectedAnchorX,projectedAnchorY:L.projectedAnchorY,projectedAnchorZ:L.projectedAnchorZ,tileAnchorX:L.tileAnchorX,tileAnchorY:L.tileAnchorY},S.verticalIconFeatureIndex=L.featureIndex;break}return S}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let s=0;s<this.symbolInstances.length;s++){const c=this.symbolInstances.get(s);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,c.textBoxStartIndex,c.textBoxEndIndex,c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c.iconBoxStartIndex,c.iconBoxEndIndex,c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(t,s){const c=t.placedSymbolArray.get(s),d=c.vertexStartIndex+4*c.numGlyphs;for(let m=c.vertexStartIndex;m<d;m+=4)t.indexArray.emplaceBack(m,m+1,m+2),t.indexArray.emplaceBack(m+1,m+2,m+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const s=Math.sin(t),c=Math.cos(t),d=[],m=[],_=[];for(let v=0;v<this.symbolInstances.length;++v){_.push(v);const w=this.symbolInstances.get(v);d.push(0|Math.round(s*w.tileAnchorX+c*w.tileAnchorY)),m.push(w.featureIndex)}return _.sort((v,w)=>d[v]-d[w]||m[w]-m[v]),_}addToSortKeyRanges(t,s){const c=this.sortKeyRanges[this.sortKeyRanges.length-1];c&&c.sortKey===s?c.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:s,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const s of this.symbolInstanceIndexes){const c=this.symbolInstances.get(s);this.featureSortOrder.push(c.featureIndex),[c.rightJustifiedTextSymbolIndex,c.centerJustifiedTextSymbolIndex,c.leftJustifiedTextSymbolIndex].forEach((d,m,_)=>{d>=0&&_.indexOf(d)===m&&this.addIndicesForPlacedSymbol(this.text,d)}),c.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,c.verticalPlacedTextSymbolIndex),c.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,c.placedIconSymbolIndex),c.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,c.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}ft(Yo,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Yo.MAX_GLYPHS=65535,Yo.addDynamicAttributes=If;const bA=new nt({"symbol-placement":new Ie(Me.layout_symbol["symbol-placement"]),"symbol-spacing":new Ie(Me.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ie(Me.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ve(Me.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ie(Me.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Ie(Me.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ie(Me.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ie(Me.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ie(Me.layout_symbol["icon-rotation-alignment"]),"icon-size":new ve(Me.layout_symbol["icon-size"]),"icon-text-fit":new Ie(Me.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ie(Me.layout_symbol["icon-text-fit-padding"]),"icon-image":new ve(Me.layout_symbol["icon-image"]),"icon-rotate":new ve(Me.layout_symbol["icon-rotate"]),"icon-padding":new Ie(Me.layout_symbol["icon-padding"]),"icon-keep-upright":new Ie(Me.layout_symbol["icon-keep-upright"]),"icon-offset":new ve(Me.layout_symbol["icon-offset"]),"icon-anchor":new ve(Me.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ie(Me.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ie(Me.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ie(Me.layout_symbol["text-rotation-alignment"]),"text-field":new ve(Me.layout_symbol["text-field"]),"text-font":new ve(Me.layout_symbol["text-font"]),"text-size":new ve(Me.layout_symbol["text-size"]),"text-max-width":new ve(Me.layout_symbol["text-max-width"]),"text-line-height":new ve(Me.layout_symbol["text-line-height"]),"text-letter-spacing":new ve(Me.layout_symbol["text-letter-spacing"]),"text-justify":new ve(Me.layout_symbol["text-justify"]),"text-radial-offset":new ve(Me.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ie(Me.layout_symbol["text-variable-anchor"]),"text-anchor":new ve(Me.layout_symbol["text-anchor"]),"text-max-angle":new Ie(Me.layout_symbol["text-max-angle"]),"text-writing-mode":new Ie(Me.layout_symbol["text-writing-mode"]),"text-rotate":new ve(Me.layout_symbol["text-rotate"]),"text-padding":new Ie(Me.layout_symbol["text-padding"]),"text-keep-upright":new Ie(Me.layout_symbol["text-keep-upright"]),"text-transform":new ve(Me.layout_symbol["text-transform"]),"text-offset":new ve(Me.layout_symbol["text-offset"]),"text-allow-overlap":new Ie(Me.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ie(Me.layout_symbol["text-ignore-placement"]),"text-optional":new Ie(Me.layout_symbol["text-optional"])});var Ym={paint:new nt({"icon-opacity":new ve(Me.paint_symbol["icon-opacity"]),"icon-color":new ve(Me.paint_symbol["icon-color"]),"icon-halo-color":new ve(Me.paint_symbol["icon-halo-color"]),"icon-halo-width":new ve(Me.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ve(Me.paint_symbol["icon-halo-blur"]),"icon-translate":new Ie(Me.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ie(Me.paint_symbol["icon-translate-anchor"]),"text-opacity":new ve(Me.paint_symbol["text-opacity"]),"text-color":new ve(Me.paint_symbol["text-color"],{runtimeType:Fn,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new ve(Me.paint_symbol["text-halo-color"]),"text-halo-width":new ve(Me.paint_symbol["text-halo-width"]),"text-halo-blur":new ve(Me.paint_symbol["text-halo-blur"]),"text-translate":new Ie(Me.paint_symbol["text-translate"]),"text-translate-anchor":new Ie(Me.paint_symbol["text-translate-anchor"])}),layout:bA};class Nx{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:vi,this.defaultValue=t}evaluate(t){if(t.formattedSection){const s=this.defaultValue.property.overrides;if(s&&s.hasOverride(t.formattedSection))return s.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}ft(Nx,"FormatSectionOverride",{omit:["defaultValue"]});class Cf extends Is{constructor(t){super(t,Ym)}recalculate(t,s){super.recalculate(t,s),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const c=this.layout.get("text-writing-mode");if(c){const d=[];for(const m of c)d.indexOf(m)<0&&d.push(m);this.layout._values["text-writing-mode"]=d}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,s,c,d){const m=this.layout.get(t).evaluate(s,{},c,d),_=this._unevaluatedLayout._values[t];return _.isDataDriven()||ya(_.value)||!m?m:function(v,w){return w.replace(/{([^{}]+)}/g,(T,S)=>S in v?String(v[S]):"")}(s.properties,m)}createBucket(t){return new Yo(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of Ym.paint.overridableProperties){if(!Cf.hasPaintOverride(this.layout,t))continue;const s=this.paint.get(t),c=new Nx(s),d=new _a(c,s.property.specification);let m=null;m=s.value.kind==="constant"||s.value.kind==="source"?new yl("source",d):new xl("composite",d,s.value.zoomStops,s.value._interpolationType),this.paint._values[t]=new $e(s.property,m,s.parameters)}}_handleOverridablePaintPropertyUpdate(t,s,c){return!(!this.layout||s.isDataDriven()||c.isDataDriven())&&Cf.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,s){const c=t.get("text-field"),d=Ym.paint.properties[s];let m=!1;const _=v=>{for(const w of v)if(d.overrides&&d.overrides.hasOverride(w))return void(m=!0)};if(c.value.kind==="constant"&&c.value.value instanceof $n)_(c.value.value.sections);else if(c.value.kind==="source"){const v=T=>{m||(T instanceof ha&&ln(T.value)===Ns?_(T.value.sections):T instanceof Us?_(T.sections):T.eachChild(v))},w=c.value;w._styleExpression&&v(w._styleExpression.expression)}return m}getProgramConfiguration(t){return new $o(this,t)}}var wA={paint:new nt({"background-color":new Ie(Me.paint_background["background-color"]),"background-pattern":new tt(Me.paint_background["background-pattern"]),"background-opacity":new Ie(Me.paint_background["background-opacity"])})},TA={paint:new nt({"raster-opacity":new Ie(Me.paint_raster["raster-opacity"]),"raster-hue-rotate":new Ie(Me.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ie(Me.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ie(Me.paint_raster["raster-brightness-max"]),"raster-saturation":new Ie(Me.paint_raster["raster-saturation"]),"raster-contrast":new Ie(Me.paint_raster["raster-contrast"]),"raster-resampling":new Ie(Me.paint_raster["raster-resampling"]),"raster-fade-duration":new Ie(Me.paint_raster["raster-fade-duration"])})};class EA extends Is{constructor(t){super(t,{}),this.implementation=t}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}var AA={paint:new nt({"sky-type":new Ie(Me.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ie(Me.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ie(Me.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ie(Me.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ie(Me.paint_sky["sky-gradient-radius"]),"sky-gradient":new at(Me.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ie(Me.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ie(Me.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ie(Me.paint_sky["sky-opacity"])})};function Km(r,t,s){const c=[0,0,1],d=v0([]);return w0(d,d,s?-et(r)+Math.PI:et(r)),b0(d,d,-et(t)),g0(c,c,d),rr(c,c)}const SA={circle:class extends Is{constructor(r){super(r,M2)}createBucket(r){return new fm(r)}queryRadius(r){const t=r;return Bl("circle-radius",this,t)+Bl("circle-stroke-width",this,t)+nf(this.paint.get("circle-translate"))}queryIntersectsFeature(r,t,s,c,d,m,_,v){const w=c0(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,r.pixelToTileUnitsFactor),T=this.paint.get("circle-radius").evaluate(t,s)+this.paint.get("circle-stroke-width").evaluate(t,s);return T0(r,c,m,_,v,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",w,T)}getProgramIds(){return["circle"]}getProgramConfiguration(r){return new $o(this,r)}},heatmap:class extends Is{createBucket(r){return new A0(r)}constructor(r){super(r,z2),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Am({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(r){return Bl("heatmap-radius",this,r)}queryIntersectsFeature(r,t,s,c,d,m,_,v){const w=this.paint.get("heatmap-radius").evaluate(t,s);return T0(r,c,m,_,v,!0,!0,new Ee(0,0),w)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(r){return new $o(this,r)}},hillshade:class extends Is{constructor(r){super(r,O2)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}},fill:class extends Is{constructor(r){super(r,J2)}getProgramIds(){const r=this.paint.get("fill-pattern"),t=r&&r.constantOr(1),s=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&s.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),s}getProgramConfiguration(r){return new $o(this,r)}recalculate(r,t){super.recalculate(r,t);const s=this.paint._values["fill-outline-color"];s.value.kind==="constant"&&s.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new uf(r)}queryRadius(){return nf(this.paint.get("fill-translate"))}queryIntersectsFeature(r,t,s,c,d,m){return!r.queryGeometry.isAboveHorizon&&r0(l0(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,r.pixelToTileUnitsFactor),c)}isTileClipped(){return!0}},"fill-extrusion":class extends Is{constructor(r){super(r,pE)}createBucket(r){return new Gu(r)}queryRadius(){return nf(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(r){return new $o(this,r)}queryIntersectsFeature(r,t,s,c,d,m,_,v,w){const T=c0(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,r.pixelToTileUnitsFactor),S=this.paint.get("fill-extrusion-height").evaluate(t,s),C=this.paint.get("fill-extrusion-base").evaluate(t,s),L=[0,0],z=v&&m.elevation,B=m.elevation?m.elevation.exaggeration():1,V=r.tile.getBucket(this);if(z&&V instanceof Gu){const ue=V.centroidVertexArray,ye=w+1;if(ye<ue.length){const pe=ue.get(ye);L[0]=pe.a_centroid_pos0,L[1]=pe.a_centroid_pos1}}if(L[0]===0&&L[1]===1)return!1;m.projection.name==="globe"&&(c=G0([c],[new Ee(0,0),new Ee(zt,zt)],r.tileID.canonical).map(ue=>ue.polygon).flat());const Z=z?v:null,[oe,de]=function(ue,ye,pe,Re,Le,Ne,Je,Be,qe,He,Ye){return ue.projection.name==="globe"?function(Qe,Ue,mt,Ot,bt,_t,ct,Dt,Gt,Wt,li){const Nt=[],zi=[],Xt=Qe.projection.upVectorScale(li,Qe.center.lat,Qe.worldSize).metersToTile,ei=[0,0,0,1],Ti=[0,0,0,1],Ri=(Di,Oi,Hi,kn)=>{Di[0]=Oi,Di[1]=Hi,Di[2]=kn,Di[3]=1},Li=j0();mt>0&&(mt+=Li),Ot+=Li;for(const Di of Ue){const Oi=[],Hi=[];for(const kn of Di){const xi=kn.x+bt.x,hn=kn.y+bt.y,sn=Qe.projection.projectTilePoint(xi,hn,li),ci=Qe.projection.upVector(li,kn.x,kn.y);let ji=mt,vn=Ot;if(ct){const Ei=q0(xi,hn,mt,Ot,ct,Dt,Gt,Wt);ji+=Ei.base,vn+=Ei.top}mt!==0?Ri(ei,sn.x+ci[0]*Xt*ji,sn.y+ci[1]*Xt*ji,sn.z+ci[2]*Xt*ji):Ri(ei,sn.x,sn.y,sn.z),Ri(Ti,sn.x+ci[0]*Xt*vn,sn.y+ci[1]*Xt*vn,sn.z+ci[2]*Xt*vn),un(ei,ei,_t),un(Ti,Ti,_t),Oi.push(new jl(ei[0],ei[1],ei[2])),Hi.push(new jl(Ti[0],Ti[1],Ti[2]))}Nt.push(Oi),zi.push(Hi)}return[Nt,zi]}(ue,ye,pe,Re,Le,Ne,Je,Be,qe,He,Ye):Je?function(Qe,Ue,mt,Ot,bt,_t,ct,Dt,Gt){const Wt=[],li=[],Nt=[0,0,0,1];for(const zi of Qe){const Xt=[],ei=[];for(const Ti of zi){const Ri=Ti.x+Ot.x,Li=Ti.y+Ot.y,Di=q0(Ri,Li,Ue,mt,_t,ct,Dt,Gt);Nt[0]=Ri,Nt[1]=Li,Nt[2]=Di.base,Nt[3]=1,Ra(Nt,Nt,bt),Nt[3]=Math.max(Nt[3],1e-5);const Oi=new jl(Nt[0]/Nt[3],Nt[1]/Nt[3],Nt[2]/Nt[3]);Nt[0]=Ri,Nt[1]=Li,Nt[2]=Di.top,Nt[3]=1,Ra(Nt,Nt,bt),Nt[3]=Math.max(Nt[3],1e-5);const Hi=new jl(Nt[0]/Nt[3],Nt[1]/Nt[3],Nt[2]/Nt[3]);Xt.push(Oi),ei.push(Hi)}Wt.push(Xt),li.push(ei)}return[Wt,li]}(ye,pe,Re,Le,Ne,Je,Be,qe,He):function(Qe,Ue,mt,Ot,bt){const _t=[],ct=[],Dt=bt[8]*Ue,Gt=bt[9]*Ue,Wt=bt[10]*Ue,li=bt[11]*Ue,Nt=bt[8]*mt,zi=bt[9]*mt,Xt=bt[10]*mt,ei=bt[11]*mt;for(const Ti of Qe){const Ri=[],Li=[];for(const Di of Ti){const Oi=Di.x+Ot.x,Hi=Di.y+Ot.y,kn=bt[0]*Oi+bt[4]*Hi+bt[12],xi=bt[1]*Oi+bt[5]*Hi+bt[13],hn=bt[2]*Oi+bt[6]*Hi+bt[14],sn=bt[3]*Oi+bt[7]*Hi+bt[15],ci=kn+Dt,ji=xi+Gt,vn=hn+Wt,Ei=Math.max(sn+li,1e-5),en=kn+Nt,Xn=xi+zi,Rn=hn+Xt,Dn=Math.max(sn+ei,1e-5);Ri.push(new jl(ci/Ei,ji/Ei,vn/Ei)),Li.push(new jl(en/Dn,Xn/Dn,Rn/Dn))}_t.push(Ri),ct.push(Li)}return[_t,ct]}(ye,pe,Re,Le,Ne)}(m,c,C,S,T,_,Z,L,B,m.center.lat,r.tileID.canonical),se=r.queryGeometry;return function(ue,ye,pe){let Re=1/0;r0(pe,ye)&&(Re=$0(pe,ye[0]));for(let Le=0;Le<ye.length;Le++){const Ne=ye[Le],Je=ue[Le];for(let Be=0;Be<Ne.length-1;Be++){const qe=Ne[Be],He=[qe,Ne[Be+1],Je[Be+1],Je[Be],qe];n0(pe,He)&&(Re=Math.min(Re,$0(pe,He)))}}return Re!==1/0&&Re}(oe,de,se.isPointQuery()?se.screenBounds:se.screenGeometry)}},line:class extends Is{constructor(r){super(r,H0),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof Bo,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(r,t){super.recalculate(r,t),this.paint._values["line-floorwidth"]=X0.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new mf(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(r){return new $o(this,r)}queryRadius(r){const t=r,s=Y0(Bl("line-width",this,t),Bl("line-gap-width",this,t)),c=Bl("line-offset",this,t);return s/2+Math.abs(c)+nf(this.paint.get("line-translate"))}queryIntersectsFeature(r,t,s,c,d,m){if(r.queryGeometry.isAboveHorizon)return!1;const _=l0(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,r.pixelToTileUnitsFactor),v=r.pixelToTileUnitsFactor/2*Y0(this.paint.get("line-width").evaluate(t,s),this.paint.get("line-gap-width").evaluate(t,s)),w=this.paint.get("line-offset").evaluate(t,s);return w&&(c=function(T,S){const C=[],L=new Ee(0,0);for(let z=0;z<T.length;z++){const B=T[z],V=[];for(let Z=0;Z<B.length;Z++){const oe=B[Z-1],de=B[Z],se=B[Z+1],ue=Z===0?L:de.sub(oe)._unit()._perp(),ye=Z===B.length-1?L:se.sub(de)._unit()._perp(),pe=ue._add(ye)._unit();pe._mult(1/(pe.x*ye.x+pe.y*ye.y)),V.push(pe._mult(S)._add(de))}C.push(V)}return C}(c,w*r.pixelToTileUnitsFactor)),function(T,S,C){for(let L=0;L<S.length;L++){const z=S[L];if(T.length>=3){for(let B=0;B<z.length;B++)if(La(T,z[B]))return!0}if(T2(T,z,C))return!0}return!1}(_,c,v)}isTileClipped(){return!0}},symbol:Cf,background:class extends Is{constructor(r){super(r,wA)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends Is{constructor(r){super(r,TA)}getProgramIds(){return["raster"]}},sky:class extends Is{constructor(r){super(r,AA),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Am({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(r,t){if(this.paint.get("sky-type")==="atmosphere"){const c=this.paint.get("sky-atmosphere-sun"),d=!c,m=r.style.light,_=m.properties.get("position");return d&&m.properties.get("anchor")==="viewport"&&fi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),d?Km(_.azimuthal,90-_.polar,t):Km(c[0],90-c[1],t)}const s=this.paint.get("sky-gradient-center");return Km(s[0],90-s[1],t)}is3D(){return!1}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}}};class rh{constructor(t,s,c,d){this.context=t,this.format=c,this.texture=t.gl.createTexture(),this.update(s,d)}update(t,s,c){const{width:d,height:m}=t,{context:_}=this,{gl:v}=_,{HTMLImageElement:w,HTMLCanvasElement:T,HTMLVideoElement:S,ImageData:C,ImageBitmap:L}=E;if(v.bindTexture(v.TEXTURE_2D,this.texture),_.pixelStoreUnpackFlipY.set(!1),_.pixelStoreUnpack.set(1),_.pixelStoreUnpackPremultiplyAlpha.set(this.format===v.RGBA&&(!s||s.premultiply!==!1)),c||this.size&&this.size[0]===d&&this.size[1]===m){const{x:z,y:B}=c||{x:0,y:0};t instanceof w||t instanceof T||t instanceof S||t instanceof C||L&&t instanceof L?v.texSubImage2D(v.TEXTURE_2D,0,z,B,v.RGBA,v.UNSIGNED_BYTE,t):v.texSubImage2D(v.TEXTURE_2D,0,z,B,d,m,v.RGBA,v.UNSIGNED_BYTE,t.data)}else this.size=[d,m],t instanceof w||t instanceof T||t instanceof S||t instanceof C||L&&t instanceof L?v.texImage2D(v.TEXTURE_2D,0,this.format,this.format,v.UNSIGNED_BYTE,t):v.texImage2D(v.TEXTURE_2D,0,this.format,d,m,0,this.format,v.UNSIGNED_BYTE,t.data);this.useMipmap=Boolean(s&&s.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&v.generateMipmap(v.TEXTURE_2D)}bind(t,s){const{context:c}=this,{gl:d}=c;d.bindTexture(d.TEXTURE_2D,this.texture),t!==this.filter&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,t),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this.useMipmap?t===d.NEAREST?d.NEAREST_MIPMAP_NEAREST:d.LINEAR_MIPMAP_NEAREST:t),this.filter=t),s!==this.wrap&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,s),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,s),this.wrap=s)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class MA{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class PA{constructor(){this.tasks={},this.taskQueue=[],Jn(["process"],this),this.invoker=new MA(this.process),this.nextId=0}add(t,s){const c=this.nextId++,d=function({type:m,isSymbolTile:_,zoom:v}){return v=v||0,m==="message"?0:m!=="maybePrepare"||_?m!=="parseTile"||_?m==="parseTile"&&_?300-v:m==="maybePrepare"&&_?400-v:500:200-v:100-v}(s);if(d===0){gn();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[c]={fn:t,metadata:s,priority:d,id:c},this.taskQueue.push(c),this.invoker.trigger(),{cancel:()=>{delete this.tasks[c]}}}process(){gn();try{if(this.taskQueue=this.taskQueue.filter(c=>!!this.tasks[c]),!this.taskQueue.length)return;const t=this.pick();if(t===null)return;const s=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!s)return;s.fn()}finally{}}pick(){let t=null,s=1/0;for(let d=0;d<this.taskQueue.length;d++){const m=this.tasks[this.taskQueue[d]];m.priority<s&&(s=m.priority,t=d)}if(t===null)return null;const c=this.taskQueue[t];return this.taskQueue.splice(t,1),c}remove(){this.invoker.remove()}}class Ux{constructor(t){this._stringToNumber={},this._numberToString=[];for(let s=0;s<t.length;s++){const c=t[s];this._stringToNumber[c]=s,this._numberToString[s]=c}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}const IA=["tile","layer","source","sourceLayer","state"];class Vx{constructor(t,s,c,d,m){this.type="Feature",this._vectorTileFeature=t,this._z=s,this._x=c,this._y=d,this.properties=t.properties,this.id=m}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",geometry:this.geometry,properties:this.properties};this.id!==void 0&&(t.id=this.id);for(const s of IA)this[s]!==void 0&&(t[s]=this[s]);return t}}const ps=32,Js=33,Ko=new Uint16Array(8184);for(let r=0;r<2046;r++){let t=r+2,s=0,c=0,d=0,m=0,_=0,v=0;for(1&t?d=m=_=ps:s=c=v=ps;(t>>=1)>1;){const T=s+d>>1,S=c+m>>1;1&t?(d=s,m=c,s=_,c=v):(s=d,c=m,d=_,m=v),_=T,v=S}const w=4*r;Ko[w+0]=s,Ko[w+1]=c,Ko[w+2]=d,Ko[w+3]=m}const Qs=new Uint16Array(2178),Jo=new Uint8Array(1089),Lf=new Uint16Array(1089);function jx(r){return r===0?-.03125:r===32?.03125:0}var Gx=rt([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const Wx={type:2,extent:zt,loadGeometry:()=>[[new Ee(0,0),new Ee(8193,0),new Ee(8193,8193),new Ee(0,8193),new Ee(0,0)]]};class Jm{constructor(t,s,c,d,m){this.tileID=t,this.uid=ur(),this.uses=0,this.tileSize=s,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=m,this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection)}registerFadeDuration(t){const s=t+this.timeAdded;s<ii.now()||this.fadeEndTime&&s<this.fadeEndTime||(this.fadeEndTime=s)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=Oa(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,s,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(d,m){const _={};if(!m)return _;for(const v of d){const w=v.layerIds.map(T=>m.getLayer(T)).filter(Boolean);if(w.length!==0){v.layers=w,v.stateDependentLayerIds&&(v.stateDependentLayers=v.stateDependentLayerIds.map(T=>w.filter(S=>S.id===T)[0]));for(const T of w)_[T.id]=v}}return _}(t.buckets,s.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const m=this.buckets[d];if(m instanceof Yo){if(this.hasSymbolBuckets=!0,!c)break;m.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const m=this.buckets[d];if(m instanceof Yo&&m.hasRTLText){this.hasRTLText=!0,fe.isLoading()||fe.isLoaded()||K()!=="deferred"||he();break}}this.queryPadding=0;for(const d in this.buckets){const m=this.buckets[d];this.queryPadding=Math.max(this.queryPadding,s.style.getLayer(d).queryRadius(m))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas)}else this.collisionBoxArray=new om}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.id]}upload(t){for(const c in this.buckets){const d=this.buckets[c];d.uploadPending()&&d.upload(t)}const s=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new rh(t,this.imageAtlas.image,s.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new rh(t,this.glyphAtlasImage,s.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new rh(t,this.lineAtlas.image,s.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,s,c,d,m,_,v,w){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:d,pixelPosMatrix:v,transform:_,params:m,tileTransform:this.tileTransform},t,s,c):{}}querySourceFeatures(t,s){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),m=s?s.sourceLayer:"",_=d._geojsonTileLayer||d[m];if(!_)return;const v=bl(s&&s.filter),{z:w,x:T,y:S}=this.tileID.canonical,C={z:w,x:T,y:S};for(let L=0;L<_.length;L++){const z=_.feature(L);if(v.needGeometry){const Z=Ca(z,!0);if(!v.filter(new le(this.tileID.overscaledZ),Z,this.tileID.canonical))continue}else if(!v.filter(new le(this.tileID.overscaledZ),z))continue;const B=c.getId(z,m),V=new Vx(z,w,T,S,B);V.tile=C,t.push(V)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const s=this.expirationTime;if(t.cacheControl){const c=_n(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(s)if(this.expirationTime<s)d=!0;else{const m=this.expirationTime-s;m?this.expirationTime=c+Math.max(m,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,s){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(t).length===0||!s)return;const c=this.latestFeatureIndex.loadVTLayers(),d=s.style.listImages();for(const m in this.buckets){if(!s.style.hasLayer(m))continue;const _=this.buckets[m],v=_.layers[0].sourceLayer||"_geojsonTileLayer",w=c[v],T=t[v];if(!w||!T||Object.keys(T).length===0)continue;if(_.update(T,w,d,this.imageAtlas&&this.imageAtlas.patternPositions||{}),_ instanceof mf||_ instanceof uf){const C=s.style._getSourceCache(_.layers[0].source);s._terrain&&s._terrain.enabled&&C&&_.programConfigurations.needsUpload&&s._terrain._clearRenderCacheForTile(C.id,this.tileID)}const S=s&&s.style&&s.style.getLayer(m);S&&(this.queryPadding=Math.max(this.queryPadding,S.queryRadius(_)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ii.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=ii.now()+t}setTexture(t,s){const c=s.context,d=c.gl;this.texture=this.texture||s.getTileTexture(t.width),this.texture?this.texture.update(t,{useMipmap:!0}):(this.texture=new rh(c,t,d.RGBA,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE),c.extTextureFilterAnisotropic&&d.texParameterf(d.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax))}setDependencies(t,s){const c={};for(const d of s)c[d]=!0;this.dependencies[t]=c}hasDependency(t,s){for(const c of t){const d=this.dependencies[c];if(d){for(const m of s)if(d[m])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,s){if(!s||s.name==="mercator"||this._tileDebugBuffer)return;const c=vo(Wx,this.tileID.canonical,this.tileTransform)[0],d=new Ht,m=new Pu;for(let _=0;_<c.length;_++){const{x:v,y:w}=c[_];d.emplaceBack(v,w),m.emplaceBack(_)}m.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(m),this._tileDebugBuffer=t.createVertexBuffer(d,Yu.members),this._tileDebugSegments=cn.simpleSegment(0,0,d.length,m.length)}_makeTileBoundsBuffers(t,s){if(this._tileBoundsBuffer||!s||s.name==="mercator")return;const c=vo(Wx,this.tileID.canonical,this.tileTransform)[0];let d,m;if(this.isRaster){const _=function(v,w){const T=Oa(v,w),S=Math.pow(2,v.z);for(let Z=0;Z<Js;Z++)for(let oe=0;oe<Js;oe++){const de=Br((v.x+(oe+jx(oe))/ps)/S),se=Vn((v.y+(Z+jx(Z))/ps)/S),ue=w.project(de,se),ye=Z*Js+oe;Qs[2*ye+0]=Math.round((ue.x*T.scale-T.x)*zt),Qs[2*ye+1]=Math.round((ue.y*T.scale-T.y)*zt)}Jo.fill(0),Lf.fill(0);for(let Z=2045;Z>=0;Z--){const oe=4*Z,de=Ko[oe+0],se=Ko[oe+1],ue=Ko[oe+2],ye=Ko[oe+3],pe=de+ue>>1,Re=se+ye>>1,Le=pe+Re-se,Ne=Re+de-pe,Je=se*Js+de,Be=ye*Js+ue,qe=Re*Js+pe,He=Math.hypot((Qs[2*Je+0]+Qs[2*Be+0])/2-Qs[2*qe+0],(Qs[2*Je+1]+Qs[2*Be+1])/2-Qs[2*qe+1])>=16;if(Jo[qe]=Jo[qe]||(He?1:0),Z<1022){const Ye=(se+Ne>>1)*Js+(de+Le>>1),Qe=(ye+Ne>>1)*Js+(ue+Le>>1);Jo[qe]=Jo[qe]||Jo[Ye]||Jo[Qe]}}const C=new wi,L=new Hn;let z=0;function B(Z,oe){const de=oe*Js+Z;return Lf[de]===0&&(C.emplaceBack(Qs[2*de+0],Qs[2*de+1],Z*zt/ps,oe*zt/ps),Lf[de]=++z),Lf[de]-1}function V(Z,oe,de,se,ue,ye){const pe=Z+de>>1,Re=oe+se>>1;if(Math.abs(Z-ue)+Math.abs(oe-ye)>1&&Jo[Re*Js+pe])V(ue,ye,Z,oe,pe,Re),V(de,se,ue,ye,pe,Re);else{const Le=B(Z,oe),Ne=B(de,se),Je=B(ue,ye);L.emplaceBack(Le,Ne,Je)}}return V(0,0,ps,ps,ps,0),V(ps,ps,0,0,0,ps),{vertices:C,indices:L}}(this.tileID.canonical,s);d=_.vertices,m=_.indices}else{d=new wi,m=new Hn;for(const{x:v,y:w}of c)d.emplaceBack(v,w,0,0);const _=Ou.exports(d.int16,void 0,4);for(let v=0;v<_.length;v+=3)m.emplaceBack(_[v],_[v+1],_[v+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,Gx.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(m),this._tileBoundsSegments=cn.simpleSegment(0,0,d.length,m.length)}_makeGlobeTileDebugBuffers(t,s){const c=s.projection;if(!c||c.name!=="globe"||s.freezeTileCoverage)return;const d=this.tileID.canonical,m=Qu(Mx(d,s)),_=Jl(s.zoom);let v;_>0&&(v=gm(new Float64Array(16),s.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,s,m,v,_),this._makeGlobeTileDebugTextBuffer(t,d,s,m,v,_)}_globePoint(t,s,c,d,m,_,v){let w=Ju(t,s,c);if(_){const T=1<<c.z,S=$s(d.center.lng),C=qs(d.center.lat),L=(c.x+.5)/T-S;let z=0;L>.5?z=-1:L<-.5&&(z=1);let B=(t/zt+c.x)/T+z,V=(s/zt+c.y)/T;B=(B-S)*d._pixelsPerMercatorPixel+S,V=(V-C)*d._pixelsPerMercatorPixel+C;const Z=[B*d.worldSize,V*d.worldSize,0];un(Z,Z,_),w=za(w,Z,v)}return un(w,w,m)}_makeGlobeTileDebugBorderBuffer(t,s,c,d,m,_){const v=new Ht,w=new Pu,T=new bi,S=(L,z,B,V,Z)=>{const oe=(B-L)/(Z-1),de=(V-z)/(Z-1),se=v.length;for(let ue=0;ue<Z;ue++){const ye=L+ue*oe,pe=z+ue*de;v.emplaceBack(ye,pe);const Re=this._globePoint(ye,pe,s,c,d,m,_);T.emplaceBack(Re[0],Re[1],Re[2]),w.emplaceBack(se+ue)}},C=zt;S(0,0,C,0,16),S(C,0,C,C,16),S(C,C,0,C,16),S(0,C,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(w),this._tileDebugBuffer=t.createVertexBuffer(v,Yu.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(T,Ax.members),this._tileDebugSegments=cn.simpleSegment(0,0,v.length,w.length)}_makeGlobeTileDebugTextBuffer(t,s,c,d,m,_){const v=new Ht,w=new Hn,T=new bi,S=25;w.reserve(32),v.reserve(S),T.reserve(S);const C=(L,z)=>S*L+z;for(let L=0;L<S;L++){const z=2048*L;for(let B=0;B<S;B++){const V=2048*B;v.emplaceBack(V,z);const Z=this._globePoint(V,z,s,c,d,m,_);T.emplaceBack(Z[0],Z[1],Z[2])}}for(let L=0;L<4;L++)for(let z=0;z<4;z++){const B=C(L,z),V=C(L,z+1),Z=C(L+1,z),oe=C(L+1,z+1);w.emplaceBack(B,V,Z),w.emplaceBack(Z,V,oe)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(w),this._tileDebugTextBuffer=t.createVertexBuffer(v,Yu.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(T,Ax.members),this._tileDebugTextSegments=cn.simpleSegment(0,0,S,32)}}class CA{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,s,c){const d=String(s);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},ni(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const m in this.state[t])m!==d&&(this.deletedStates[t][m]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const m in this.state[t][d])c[m]||(this.deletedStates[t][d][m]=null)}else for(const m in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][m]===null&&delete this.deletedStates[t][d][m]}removeFeatureState(t,s,c){if(this.deletedStates[t]===null)return;const d=String(s);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&s!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(s!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,s){const c=String(s),d=ni({},(this.state[t]||{})[c],(this.stateChanges[t]||{})[c]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const m=this.deletedStates[t][s];if(m===null)return{};for(const _ in m)delete d[_]}return d}initializeTileState(t,s){t.setFeatureState(this.state,s)}coalesceChanges(t,s){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const m={};for(const _ in this.stateChanges[d])this.state[d][_]||(this.state[d][_]={}),ni(this.state[d][_],this.stateChanges[d][_]),m[_]=this.state[d][_];c[d]=m}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const m={};if(this.deletedStates[d]===null)for(const _ in this.state[d])m[_]={},this.state[d][_]={};else for(const _ in this.deletedStates[d]){if(this.deletedStates[d][_]===null)this.state[d][_]={};else for(const v of Object.keys(this.deletedStates[d][_]))delete this.state[d][_][v];m[_]=this.state[d][_]}c[d]=c[d]||{},ni(c[d],m)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].setFeatureState(c,s)}}class Zx{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,s){const c=this.toIdx(t,s);return{min:this.minimums[c],max:this.maximums[c]}}isLeaf(t,s){return this.leaves[this.toIdx(t,s)]}toIdx(t,s){return s*this.size+t}}function $x(r,t,s,c){let d=0,m=Number.MAX_VALUE;for(let _=0;_<3;_++)if(Math.abs(c[_])<1e-15){if(s[_]<r[_]||s[_]>t[_])return null}else{const v=1/c[_];let w=(r[_]-s[_])*v,T=(t[_]-s[_])*v;if(w>T){const S=w;w=T,T=S}if(w>d&&(d=w),T<m&&(m=T),d>m)return null}return d}function qx(r,t,s,c,d,m,_,v,w,T,S){const C=c-r,L=d-t,z=m-s,B=_-r,V=v-t,Z=w-s,oe=S[1]*Z-S[2]*V,de=S[2]*B-S[0]*Z,se=S[0]*V-S[1]*B,ue=C*oe+L*de+z*se;if(Math.abs(ue)<1e-15)return null;const ye=1/ue,pe=T[0]-r,Re=T[1]-t,Le=T[2]-s,Ne=(pe*oe+Re*de+Le*se)*ye;if(Ne<0||Ne>1)return null;const Je=Re*z-Le*L,Be=Le*C-pe*z,qe=pe*L-Re*C,He=(S[0]*Je+S[1]*Be+S[2]*qe)*ye;return He<0||Ne+He>1?null:(B*Je+V*Be+Z*qe)*ye}function Hx(r,t,s){return(r-t)/(s-t)}function Xx(r,t,s,c,d,m,_,v,w){const T=1<<s,S=m-c,C=_-d,L=(r+1)/T*S+c,z=(t+0)/T*C+d,B=(t+1)/T*C+d;v[0]=(r+0)/T*S+c,v[1]=z,w[0]=L,w[1]=B}class Yx{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const s=function(m){const _=Math.ceil(Math.log2(m.dim/8)),v=[];let w=Math.ceil(Math.pow(2,_));const T=1/w,S=(z,B,V,Z,oe)=>{const de=Z?1:0,se=(z+1)*V-de,ue=B*V,ye=(B+1)*V-de;oe[0]=z*V,oe[1]=ue,oe[2]=se,oe[3]=ye};let C=new Zx(w);const L=[];for(let z=0;z<w*w;z++){S(z%w,Math.floor(z/w),T,!1,L);const B=Qo(L[0],L[1],m),V=Qo(L[2],L[1],m),Z=Qo(L[2],L[3],m),oe=Qo(L[0],L[3],m);C.minimums.push(Math.min(B,V,Z,oe)),C.maximums.push(Math.max(B,V,Z,oe)),C.leaves.push(1)}for(v.push(C),w/=2;w>=1;w/=2){const z=v[v.length-1];C=new Zx(w);for(let B=0;B<w*w;B++){S(B%w,Math.floor(B/w),2,!0,L);const V=z.getElevation(L[0],L[1]),Z=z.getElevation(L[2],L[1]),oe=z.getElevation(L[2],L[3]),de=z.getElevation(L[0],L[3]),se=z.isLeaf(L[0],L[1]),ue=z.isLeaf(L[2],L[1]),ye=z.isLeaf(L[2],L[3]),pe=z.isLeaf(L[0],L[3]),Re=Math.min(V.min,Z.min,oe.min,de.min),Le=Math.max(V.max,Z.max,oe.max,de.max),Ne=se&&ue&&ye&&pe;C.maximums.push(Le),C.minimums.push(Re),C.leaves.push(Le-Re<=5&&Ne?1:0)}v.push(C)}return v}(this.dem),c=s.length-1,d=s[c];this._addNode(d.minimums[0],d.maximums[0],d.leaves[0]),this._construct(s,0,0,c,0)}raycastRoot(t,s,c,d,m,_,v=1){return $x([t,s,-100],[c,d,this.maximums[0]*v],m,_)}raycast(t,s,c,d,m,_,v=1){if(!this.nodeCount)return null;const w=this.raycastRoot(t,s,c,d,m,_,v);if(w==null)return null;const T=[],S=[],C=[],L=[],z=[{idx:0,t:w,nodex:0,nodey:0,depth:0}];for(;z.length>0;){const{idx:B,t:V,nodex:Z,nodey:oe,depth:de}=z.pop();if(this.leaves[B]){Xx(Z,oe,de,t,s,c,d,C,L);const ue=1<<de,ye=(Z+0)/ue,pe=(Z+1)/ue,Re=(oe+0)/ue,Le=(oe+1)/ue,Ne=Qo(ye,Re,this.dem)*v,Je=Qo(pe,Re,this.dem)*v,Be=Qo(pe,Le,this.dem)*v,qe=Qo(ye,Le,this.dem)*v,He=qx(C[0],C[1],Ne,L[0],C[1],Je,L[0],L[1],Be,m,_),Ye=qx(L[0],L[1],Be,C[0],L[1],qe,C[0],C[1],Ne,m,_),Qe=Math.min(He!==null?He:Number.MAX_VALUE,Ye!==null?Ye:Number.MAX_VALUE);if(Qe!==Number.MAX_VALUE)return Qe;{const Ue=Du([],m,_,V);if(Kx(Ne,Je,qe,Be,Hx(Ue[0],C[0],L[0]),Hx(Ue[1],C[1],L[1]))>=Ue[2])return V}continue}let se=0;for(let ue=0;ue<this._siblingOffset.length;ue++){Xx((Z<<1)+this._siblingOffset[ue][0],(oe<<1)+this._siblingOffset[ue][1],de+1,t,s,c,d,C,L),C[2]=-100,L[2]=this.maximums[this.childOffsets[B]+ue]*v;const ye=$x(C,L,m,_);if(ye!=null){const pe=ye;T[ue]=pe;let Re=!1;for(let Le=0;Le<se&&!Re;Le++)pe>=T[S[Le]]&&(S.splice(Le,0,ue),Re=!0);Re||(S[se]=ue),se++}}for(let ue=0;ue<se;ue++){const ye=S[ue];z.push({idx:this.childOffsets[B]+ye,t:T[ye],nodex:(Z<<1)+this._siblingOffset[ye][0],nodey:(oe<<1)+this._siblingOffset[ye][1],depth:de+1})}}return null}_addNode(t,s,c){return this.minimums.push(t),this.maximums.push(s),this.leaves.push(c),this.childOffsets.push(0),this.nodeCount++}_construct(t,s,c,d,m){if(t[d].isLeaf(s,c)===1)return;this.childOffsets[m]||(this.childOffsets[m]=this.nodeCount);const _=d-1,v=t[_];let w=0,T=0;for(let S=0;S<this._siblingOffset.length;S++){const C=2*s+this._siblingOffset[S][0],L=2*c+this._siblingOffset[S][1],z=v.getElevation(C,L),B=v.isLeaf(C,L),V=this._addNode(z.min,z.max,B);B&&(w|=1<<S),T||(T=V)}for(let S=0;S<this._siblingOffset.length;S++)w&1<<S||this._construct(t,2*s+this._siblingOffset[S][0],2*c+this._siblingOffset[S][1],_,T+S)}}function Kx(r,t,s,c,d,m){return ai(ai(r,s,m),ai(t,c,m),d)}function Qo(r,t,s){const c=s.dim,d=Lt(r*c-.5,0,c-1),m=Lt(t*c-.5,0,c-1),_=Math.floor(d),v=Math.floor(m),w=Math.min(_+1,c-1),T=Math.min(v+1,c-1);return Kx(s.get(_,v),s.get(w,v),s.get(_,T),s.get(w,T),d-_,m-v)}const Jx={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class kf{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,s,c,d=!1,m=!1){if(this.uid=t,s.height!==s.width)throw new RangeError("DEM tiles must be square");if(c&&c!=="mapbox"&&c!=="terrarium")return fi(`"${c}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=s.height;const _=this.dim=s.height-2,v=new Uint32Array(s.data.buffer);if(this.pixels=new Uint8Array(s.data.buffer),this.encoding=c||"mapbox",this.borderReady=d,!d){for(let w=0;w<_;w++)v[this._idx(-1,w)]=v[this._idx(0,w)],v[this._idx(_,w)]=v[this._idx(_-1,w)],v[this._idx(w,-1)]=v[this._idx(w,0)],v[this._idx(w,_)]=v[this._idx(w,_-1)];v[this._idx(-1,-1)]=v[this._idx(0,0)],v[this._idx(_,-1)]=v[this._idx(_-1,0)],v[this._idx(-1,_)]=v[this._idx(0,_-1)],v[this._idx(_,_)]=v[this._idx(_-1,_-1)],m&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new Yx(this)}get(t,s,c=!1){c&&(t=Lt(t,-1,this.dim),s=Lt(s,-1,this.dim));const d=4*this._idx(t,s);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(this.pixels[d],this.pixels[d+1],this.pixels[d+2])}static getUnpackVector(t){return Jx[t]}get unpackVector(){return Jx[this.encoding]}_idx(t,s){if(t<-1||t>=this.dim+1||s<-1||s>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(s+1)*this.stride+(t+1)}_unpackMapbox(t,s,c){return(256*t*256+256*s+c)/10-1e4}_unpackTerrarium(t,s,c){return 256*t+s+c/256-32768}static pack(t,s){const c=[0,0,0,0],d=kf.getUnpackVector(s);let m=Math.floor((t+d[3])/d[2]);return c[2]=m%256,m=Math.floor(m/256),c[1]=m%256,m=Math.floor(m/256),c[0]=m,c}getPixels(){return new Er({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,s,c){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let d=s*this.dim,m=s*this.dim+this.dim,_=c*this.dim,v=c*this.dim+this.dim;switch(s){case-1:d=m-1;break;case 1:m=d+1}switch(c){case-1:_=v-1;break;case 1:v=_+1}const w=-s*this.dim,T=-c*this.dim;for(let S=_;S<v;S++)for(let C=d;C<m;C++){const L=4*this._idx(C,S),z=4*this._idx(C+w,S+T);this.pixels[L+0]=t.pixels[z+0],this.pixels[L+1]=t.pixels[z+1],this.pixels[L+2]=t.pixels[z+2],this.pixels[L+3]=t.pixels[z+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}ft(kf,"DEMData"),ft(Yx,"DemMinMaxQuadTree",{omit:["dem"]});class LA{constructor(t,s){this.max=t,this.onRemove=s,this.reset()}reset(){for(const t in this.data)for(const s of this.data[t])s.timeout&&clearTimeout(s.timeout),this.onRemove(s.value);return this.data={},this.order=[],this}add(t,s,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const m={value:s,timeout:void 0};if(c!==void 0&&(m.timeout=setTimeout(()=>{this.remove(t,m)},c)),this.data[d].push(m),this.order.push(d),this.order.length>this.max){const _=this._getAndRemoveByKey(this.order[0]);_&&this.onRemove(_)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const s=this.data[t].shift();return s.timeout&&clearTimeout(s.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),s.value}getByKey(t){const s=this.data[t];return s?s[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,s){if(!this.has(t))return this;const c=t.wrapped().key,d=s===void 0?0:this.data[c].indexOf(s),m=this.data[c][d];return this.data[c].splice(d,1),m.timeout&&clearTimeout(m.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(m.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const s=this._getAndRemoveByKey(this.order[0]);s&&this.onRemove(s)}return this}filter(t){const s=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||s.push(d);for(const c of s)this.remove(c.value.tileID,c)}}class ec{constructor(t,s,c){this.func=t,this.mask=s,this.range=c}}ec.ReadOnly=!1,ec.ReadWrite=!0,ec.disabled=new ec(519,ec.ReadOnly,[0,1]);const Qm=7680;class eg{constructor(t,s,c,d,m,_){this.test=t,this.ref=s,this.mask=c,this.fail=d,this.depthFail=m,this.pass=_}}eg.disabled=new eg({func:519,mask:0},0,0,Qm,Qm,Qm);class eo{constructor(t,s,c){this.blendFunction=t,this.blendColor=s,this.mask=c}}eo.Replace=[1,0],eo.disabled=new eo(eo.Replace,ri.transparent,[!1,!1,!1,!1]),eo.unblended=new eo(eo.Replace,ri.transparent,[!0,!0,!0,!0]),eo.alphaBlended=new eo([1,771],ri.transparent,[!0,!0,!0,!0]);const tg=1029,ig=2305;class Rs{constructor(t,s,c){this.enable=t,this.mode=s,this.frontFace=c}}Rs.disabled=new Rs(!1,tg,ig),Rs.backCCW=new Rs(!0,tg,ig),Rs.backCW=new Rs(!0,tg,2304),Rs.frontCW=new Rs(!0,1028,2304),Rs.frontCCW=new Rs(!0,1028,ig);class Ba extends It{constructor(t,s,c){super(),this.id=t,this._onlySymbols=c,s.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),s.on("error",()=>{this._sourceErrored=!0}),this._source=s,this._tiles={},this._cache=new LA(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=s.minTileCacheSize,this._maxTileCacheSize=s.maxTileCacheSize,this._loadedParentTiles={},this._coveredTiles={},this._state=new CA,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const s=this._tiles[t];if(s.state!=="loaded"&&s.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,s){return t.isSymbolTile=this._onlySymbols,this._source.loadTile(t,s)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,()=>{})}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const s in this._tiles){const c=this._tiles[s];c.upload(t),c.prepare(this.map.style.imageManager)}}getIds(){return Gi(this._tiles).map(t=>t.tileID).sort(Qx).map(t=>t.key)}getRenderableIds(t){const s=[];for(const c in this._tiles)this._isIdRenderable(+c,t)&&s.push(this._tiles[c]);return t?s.sort((c,d)=>{const m=c.tileID,_=d.tileID,v=new Ee(m.canonical.x,m.canonical.y)._rotate(this.transform.angle),w=new Ee(_.canonical.x,_.canonical.y)._rotate(this.transform.angle);return m.overscaledZ-_.overscaledZ||w.y-v.y||w.x-v.x}).map(c=>c.tileID.key):s.map(c=>c.tileID).sort(Qx).map(c=>c.key)}hasRenderableParent(t){const s=this.findLoadedParent(t,0);return!!s&&this._isIdRenderable(s.tileID.key)}_isIdRenderable(t,s){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(s||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,s){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=s),this._loadTile(c,this._tileLoaded.bind(this,c,t,s)))}_tileLoaded(t,s,c,d){if(d)if(t.state="errored",d.status!==404)this._source.fire(new pt(d,{tile:t}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const m=this.map.painter.terrain;this.update(this.transform,m.getScaledDemTileSize(),!0),m.resetTileLookupCache(this.id)}else this.update(this.transform);else t.timeAdded=ii.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(s,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new Xe("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const s=this.getRenderableIds();for(let d=0;d<s.length;d++){const m=s[d];if(t.neighboringTiles&&t.neighboringTiles[m]){const _=this.getTileByID(m);c(t,_),c(_,t)}}function c(d,m){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let _=m.tileID.canonical.x-d.tileID.canonical.x;const v=m.tileID.canonical.y-d.tileID.canonical.y,w=Math.pow(2,d.tileID.canonical.z),T=m.tileID.key;_===0&&v===0||Math.abs(v)>1||(Math.abs(_)>1&&(Math.abs(_+w)===1?_+=w:Math.abs(_-w)===1&&(_-=w)),m.dem&&d.dem&&(d.dem.backfillBorder(m.dem,_,v),d.neighboringTiles&&d.neighboringTiles[T]&&(d.neighboringTiles[T].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,s,c,d){for(const m in this._tiles){let _=this._tiles[m];if(d[m]||!_.hasData()||_.tileID.overscaledZ<=s||_.tileID.overscaledZ>c)continue;let v=_.tileID;for(;_&&_.tileID.overscaledZ>s+1;){const T=_.tileID.scaledTo(_.tileID.overscaledZ-1);_=this._tiles[T.key],_&&_.hasData()&&(v=T)}let w=v;for(;w.overscaledZ>s;)if(w=w.scaledTo(w.overscaledZ-1),t[w.key]){d[v.key]=v;break}}}findLoadedParent(t,s){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=s?c:null}for(let c=t.overscaledZ-1;c>=s;c--){const d=t.scaledTo(c),m=this._getLoadedTile(d);if(m)return m}}_getLoadedTile(t){const s=this._tiles[t.key];return s&&s.hasData()?s:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,s){s=s||this._source.tileSize;const c=Math.ceil(t.width/s)+1,d=Math.ceil(t.height/s)+1,m=Math.floor(c*d*5),_=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,m):m,v=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,_):_;this._cache.setMaxSize(v)}handleWrapJump(t){const s=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,s){const c={};for(const d in this._tiles){const m=this._tiles[d];m.tileID=m.tileID.unwrapTo(m.tileID.wrap+s),c[m.tileID.key]=m}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,s,c){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;let d;this.updateCacheSize(t,s),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?d=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(v=>new or(v.canonical.z,v.wrap,v.canonical.z,v.canonical.x,v.canonical.y)):(d=t.coveringTiles({tileSize:s||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(d=d.filter(v=>this._source.hasTile(v)))):d=[];const m=this._updateRetainedTiles(d);if(ev(this._source.type)&&d.length!==0){const v={},w={},T=Object.keys(m);for(const C of T){const L=m[C],z=this._tiles[C];if(!z||z.fadeEndTime&&z.fadeEndTime<=ii.now())continue;const B=this.findLoadedParent(L,Math.max(L.overscaledZ-Ba.maxOverzooming,this._source.minzoom));B&&(this._addTile(B.tileID),v[B.tileID.key]=B.tileID),w[C]=L}const S=d[d.length-1].overscaledZ;for(const C in this._tiles){const L=this._tiles[C];if(m[C]||!L.hasData())continue;let z=L.tileID;for(;z.overscaledZ>S;){z=z.scaledTo(z.overscaledZ-1);const B=this._tiles[z.key];if(B&&B.hasData()&&w[z.key]){m[C]=L.tileID;break}}}for(const C in v)m[C]||(this._coveredTiles[C]=!0,m[C]=v[C])}for(const v in m)this._tiles[v].clearFadeHold();const _=function(v,w){const T=[];for(const S in v)S in w||T.push(S);return T}(this._tiles,m);for(const v of _){const w=this._tiles[v];w.hasSymbolBuckets&&!w.holdingForFade()?w.setHoldDuration(this.map._fadeDuration):w.hasSymbolBuckets&&!w.symbolFadeFinished()||this._removeTile(+v)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const s={};if(t.length===0)return s;const c={},d=t.reduce((T,S)=>Math.min(T,S.overscaledZ),1/0),m=t[0].overscaledZ,_=Math.max(m-Ba.maxOverzooming,this._source.minzoom),v=Math.max(m+Ba.maxUnderzooming,this._source.minzoom),w={};for(const T of t){const S=this._addTile(T);s[T.key]=T,S.hasData()||d<this._source.maxzoom&&(w[T.key]=T)}this._retainLoadedChildren(w,d,v,s);for(const T of t){let S=this._tiles[T.key];if(S.hasData())continue;if(T.canonical.z>=this._source.maxzoom){const L=T.children(this._source.maxzoom)[0],z=this.getTile(L);if(z&&z.hasData()){s[L.key]=L;continue}}else{const L=T.children(this._source.maxzoom);if(s[L[0].key]&&s[L[1].key]&&s[L[2].key]&&s[L[3].key])continue}let C=S.wasRequested();for(let L=T.overscaledZ-1;L>=_;--L){const z=T.scaledTo(L);if(c[z.key]||(c[z.key]=!0,S=this.getTile(z),!S&&C&&(S=this._addTile(z)),S&&(s[z.key]=z,C=S.wasRequested(),S.hasData())))break}}return s}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const s=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}s.push(d.key);const m=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(m),c)break;d=m}for(const m of s)this._loadedParentTiles[m]=c}}_addTile(t){let s=this._tiles[t.key];if(s)return s;s=this._cache.getAndRemove(t),s&&(this._setTileReloadTimer(t.key,s),s.tileID=t,this._state.initializeTileState(s,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,s)));const c=Boolean(s);if(!c){const d=this.map?this.map.painter:null;s=new Jm(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,d,this._isRaster),this._loadTile(s,this._tileLoaded.bind(this,s,t.key,s.state))}return s?(s.uses++,this._tiles[t.key]=s,c||this._source.fire(new Xe("dataloading",{tile:s,coord:s.tileID,dataType:"source"})),s):null}_setTileReloadTimer(t,s){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=s.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){const s=this._tiles[t];s&&(s.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),s.uses>0||(s.hasData()&&s.state!=="reloading"?this._cache.add(s.tileID,s,s.getExpiryTimeout()):(s.aborted=!0,this._abortTile(s),this._unloadTile(s))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,s,c){const d=[],m=this.transform;if(!m)return d;const _=m.projection.name==="globe",v=$s(m.center.lng);for(const w in this._tiles){const T=this._tiles[w];if(c&&T.clearQueryDebugViz(),T.holdingForFade())continue;let S;if(_){const C=T.tileID.canonical;if(C.z===0){const L=[Math.abs(Lt(v,...sh(C,-1))-v),Math.abs(Lt(v,...sh(C,1))-v)];S=[0,2*L.indexOf(Math.min(...L))-1]}else{const L=[Math.abs(Lt(v,...sh(C,-1))-v),Math.abs(Lt(v,...sh(C,0))-v),Math.abs(Lt(v,...sh(C,1))-v)];S=[L.indexOf(Math.min(...L))-1]}}else S=[0];for(const C of S){const L=t.containsTile(T,m,s,C);L&&d.push(L)}}return d}getVisibleCoordinates(t){const s=this.getRenderableIds(t).map(c=>this._tiles[c].tileID);for(const c of s)c.projMatrix=this.transform.calculateProjMatrix(c.toUnwrapped());return s}hasTransition(){if(this._source.hasTransition())return!0;if(ev(this._source.type))for(const t in this._tiles){const s=this._tiles[t];if(s.fadeEndTime!==void 0&&s.fadeEndTime>=ii.now())return!0}return!1}setFeatureState(t,s,c){this._state.updateState(t=t||"_geojsonTileLayer",s,c)}removeFeatureState(t,s,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",s,c)}getFeatureState(t,s){return this._state.getState(t=t||"_geojsonTileLayer",s)}setDependencies(t,s,c){const d=this._tiles[t];d&&d.setDependencies(s,c)}reloadTilesForDependencies(t,s){for(const c in this._tiles)this._tiles[c].hasDependency(t,s)&&this._reloadTile(+c,"reloading");this._cache.filter(c=>!c.hasDependency(t,s))}_preloadTiles(t,s){const c=new Map,d=Array.isArray(t)?t:[t],m=this.map.painter.terrain,_=this.usedForTerrain&&m?m.getScaledDemTileSize():this._source.tileSize;for(const v of d){const w=v.coveringTiles({tileSize:_,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const T of w)c.set(T.key,T);this.usedForTerrain&&v.updateElevation(!1)}pn(Array.from(c.values()),(v,w)=>{const T=new Jm(v,this._source.tileSize*v.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(T,S=>{this._source.type==="raster-dem"&&T.dem&&this._backfillDEM(T),w(S,T)})},s)}}function Qx(r,t){const s=Math.abs(2*r.wrap)-+(r.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return r.overscaledZ-t.overscaledZ||c-s||t.canonical.y-r.canonical.y||t.canonical.x-r.canonical.x}function ev(r){return r==="raster"||r==="image"||r==="video"||r==="custom"}function sh(r,t){const s=1<<r.z;return[r.x/s+t,(r.x+1)/s+t]}Ba.maxOverzooming=10,Ba.maxUnderzooming=3;class Rf{constructor(t,s,c){this._demTile=t,this._dem=this._demTile.dem,this._scale=s,this._offset=c}static create(t,s,c){const d=c||t.findDEMTileFor(s);if(!d||!d.dem)return;const m=d.dem,_=d.tileID,v=1<<s.canonical.z-_.canonical.z;return new Rf(d,d.tileSize/zt/v,[(s.canonical.x/v-_.canonical.x)*m.dim,(s.canonical.y/v-_.canonical.y)*m.dim])}tileCoordToPixel(t,s){const c=s*this._scale+this._offset[1],d=Math.floor(t*this._scale+this._offset[0]),m=Math.floor(c);return new Ee(d,m)}getElevationAt(t,s,c,d){const m=t*this._scale+this._offset[0],_=s*this._scale+this._offset[1],v=Math.floor(m),w=Math.floor(_),T=this._dem;return d=!!d,c?ai(ai(T.get(v,w,d),T.get(v,w+1,d),_-w),ai(T.get(v+1,w,d),T.get(v+1,w+1,d),_-w),m-v):T.get(v,w,d)}getElevationAtPixel(t,s,c){return this._dem.get(t,s,!!c)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*ds(1,t)*this._dem.stride}}class tv{constructor(t,s){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Go(zt,16,0),this.featureIndexArray=new Uy,this.promoteId=s}insert(t,s,c,d,m,_=0){const v=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(c,d,m,_);const w=this.grid;for(let T=0;T<s.length;T++){const S=s[T],C=[1/0,1/0,-1/0,-1/0];for(let L=0;L<S.length;L++){const z=S[L];C[0]=Math.min(C[0],z.x),C[1]=Math.min(C[1],z.y),C[2]=Math.max(C[2],z.x),C[3]=Math.max(C[3],z.y)}C[0]<zt&&C[1]<zt&&C[2]>=0&&C[3]>=0&&w.insert(v,C[0],C[1],C[2],C[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new km(new qu(this.rawTileData)).layers,this.sourceLayerCoder=new Ux(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,s,c,d){this.loadVTLayers();const m=t.params||{},_=bl(m.filter),v=t.tileResult,w=t.transform,T=v.bufferedTilespaceBounds,S=this.grid.query(T.min.x,T.min.y,T.max.x,T.max.y,(B,V,Z,oe)=>a0(v.bufferedTilespaceGeometry,B,V,Z,oe));S.sort(kA);let C=null;w.elevation&&S.length>0&&(C=Rf.create(w.elevation,this.tileID));const L={};let z;for(let B=0;B<S.length;B++){const V=S[B];if(V===z)continue;z=V;const Z=this.featureIndexArray.get(V);let oe=null;this.loadMatchingFeature(L,Z,_,m.layers,m.availableImages,s,c,d,(de,se,ue,ye=0)=>(oe||(oe=vo(de,this.tileID.canonical,t.tileTransform)),se.queryIntersectsFeature(v,de,ue,oe,this.z,t.transform,t.pixelPosMatrix,C,ye)))}return L}loadMatchingFeature(t,s,c,d,m,_,v,w,T){const{featureIndex:S,bucketIndex:C,sourceLayerIndex:L,layoutVertexArrayOffset:z}=s,B=this.bucketLayerIDs[C];if(d&&!function(de,se){for(let ue=0;ue<de.length;ue++)if(se.indexOf(de[ue])>=0)return!0;return!1}(d,B))return;const V=this.sourceLayerCoder.decode(L),Z=this.vtLayers[V].feature(S);if(c.needGeometry){const de=Ca(Z,!0);if(!c.filter(new le(this.tileID.overscaledZ),de,this.tileID.canonical))return}else if(!c.filter(new le(this.tileID.overscaledZ),Z))return;const oe=this.getId(Z,V);for(let de=0;de<B.length;de++){const se=B[de];if(d&&d.indexOf(se)<0)continue;const ue=_[se];if(!ue)continue;let ye={};oe!==void 0&&w&&(ye=w.getState(ue.sourceLayer||"_geojsonTileLayer",oe));const pe=ni({},v[se]);pe.paint=iv(pe.paint,ue.paint,Z,ye,m),pe.layout=iv(pe.layout,ue.layout,Z,ye,m);const Re=!T||T(Z,ue,ye,z);if(!Re)continue;const Le=new Vx(Z,this.z,this.x,this.y,oe);Le.layer=pe;let Ne=t[se];Ne===void 0&&(Ne=t[se]=[]),Ne.push({featureIndex:S,feature:Le,intersectionZ:Re})}}lookupSymbolFeatures(t,s,c,d,m,_,v,w){const T={};this.loadVTLayers();const S=bl(m);for(const C of t)this.loadMatchingFeature(T,{bucketIndex:c,sourceLayerIndex:d,featureIndex:C,layoutVertexArrayOffset:0},S,_,v,w,s);return T}loadFeature(t){const{featureIndex:s,sourceLayerIndex:c}=t;this.loadVTLayers();const d=this.sourceLayerCoder.decode(c),m=this.vtFeatures[d];if(m[s])return m[s];const _=this.vtLayers[d].feature(s);return m[s]=_,_}hasLayer(t){for(const s of this.bucketLayerIDs)for(const c of s)if(t===c)return!0;return!1}getId(t,s){let c=t.id;if(this.promoteId){const d=typeof this.promoteId=="string"?this.promoteId:this.promoteId[s];d!=null&&(c=t.properties[d]),typeof c=="boolean"&&(c=Number(c))}return c}}function iv(r,t,s,c,d){return Si(r,(m,_)=>{const v=t instanceof je?t.get(_):null;return v&&v.evaluate?v.evaluate(s,c,d):v})}function kA(r,t){return t-r}ft(tv,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});class nv{constructor(t,s){this.width=t,this.height=s,this.nextRow=0,this.image=new wo({width:t,height:s}),this.positions={},this.uploaded=!1}getDash(t,s){const c=this.getKey(t,s);return this.positions[c]}trim(){const t=this.width,s=this.height=$i(this.nextRow);this.image.resize({width:t,height:s})}getKey(t,s){return t.join(",")+s}getDashRanges(t,s,c){const d=[];let m=t.length%2==1?-t[t.length-1]*c:0,_=t[0]*c,v=!0;d.push({left:m,right:_,isDash:v,zeroLength:t[0]===0});let w=t[0];for(let T=1;T<t.length;T++){v=!v;const S=t[T];m=w*c,w+=S,_=w*c,d.push({left:m,right:_,isDash:v,zeroLength:S===0})}return d}addRoundDash(t,s,c){const d=s/2;for(let m=-c;m<=c;m++){const _=this.width*(this.nextRow+c+m);let v=0,w=t[v];for(let T=0;T<this.width;T++){T/w.right>1&&(w=t[++v]);const S=Math.abs(T-w.left),C=Math.abs(T-w.right),L=Math.min(S,C);let z;const B=m/c*(d+1);if(w.isDash){const V=d-Math.abs(B);z=Math.sqrt(L*L+V*V)}else z=d-Math.sqrt(L*L+B*B);this.image.data[_+T]=Math.max(0,Math.min(255,z+128))}}}addRegularDash(t,s){for(let w=t.length-1;w>=0;--w){const T=t[w],S=t[w+1];T.zeroLength?t.splice(w,1):S&&S.isDash===T.isDash&&(S.left=T.left,t.splice(w,1))}const c=t[0],d=t[t.length-1];c.isDash===d.isDash&&(c.left=d.left-this.width,d.right=c.right+this.width);const m=this.width*this.nextRow;let _=0,v=t[_];for(let w=0;w<this.width;w++){w/v.right>1&&(v=t[++_]);const T=Math.abs(w-v.left),S=Math.abs(w-v.right),C=Math.min(T,S);this.image.data[m+w]=Math.max(0,Math.min(255,(v.isDash?C:-C)+s+128))}}addDash(t,s){const c=this.getKey(t,s);if(this.positions[c])return this.positions[c];const d=s==="round",m=d?7:0,_=2*m+1;if(this.nextRow+_>this.height)return fi("LineAtlas out of space"),null;t.length===0&&t.push(1);let v=0;for(let S=0;S<t.length;S++)t[S]<0&&(fi("Negative value is found in line dasharray, replacing values with 0"),t[S]=0),v+=t[S];if(v!==0){const S=this.width/v,C=this.getDashRanges(t,this.width,S);d?this.addRoundDash(C,S,m):this.addRegularDash(C,s==="square"?.5*S:0)}const w=this.nextRow+m;this.nextRow+=_;const T={tl:[w,m],br:[v,0]};return this.positions[c]=T,T}}ft(nv,"LineAtlas");class rv{constructor(t){const s={},c=[];for(const v in t){const w=t[v],T=s[v]={};for(const S in w.glyphs){const C=w.glyphs[+S];if(!C||C.bitmap.width===0||C.bitmap.height===0)continue;const L=C.metrics.localGlyph?2:1,z={x:0,y:0,w:C.bitmap.width+2*L,h:C.bitmap.height+2*L};c.push(z),T[S]=z}}const{w:d,h:m}=zm(c),_=new wo({width:d||1,height:m||1});for(const v in t){const w=t[v];for(const T in w.glyphs){const S=w.glyphs[+T];if(!S||S.bitmap.width===0||S.bitmap.height===0)continue;const C=s[v][T],L=S.metrics.localGlyph?2:1;wo.copy(S.bitmap,_,{x:0,y:0},{x:C.x+L,y:C.y+L},S.bitmap)}}this.image=_,this.positions=s}}ft(rv,"GlyphAtlas");class RA{constructor(t){this.tileID=new or(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.returnDependencies=!!t.returnDependencies,this.promoteId=t.promoteId,this.enableTerrain=!!t.enableTerrain,this.isSymbolTile=t.isSymbolTile,this.tileTransform=Oa(t.tileID.canonical,t.projection),this.projection=t.projection}parse(t,s,c,d,m){this.status="parsing",this.data=t,this.collisionBoxArray=new om;const _=new Ux(Object.keys(t.layers).sort()),v=new tv(this.tileID,this.promoteId);v.bucketLayerIDs=[];const w={},T=new nv(256,256),S={featureIndex:v,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:T,availableImages:c},C=s.familiesBySource[this.source];for(const ye in C){const pe=t.layers[ye];if(!pe)continue;let Re=!1,Le=!1;for(const Be of C[ye])Be[0].type==="symbol"?Re=!0:Le=!0;if(this.isSymbolTile===!0&&!Re||this.isSymbolTile===!1&&!Le)continue;pe.version===1&&fi(`Vector tile source "${this.source}" layer "${ye}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Ne=_.encode(ye),Je=[];for(let Be=0;Be<pe.length;Be++){const qe=pe.feature(Be),He=v.getId(qe,ye);Je.push({feature:qe,id:He,index:Be,sourceLayerIndex:Ne})}for(const Be of C[ye]){const qe=Be[0];this.isSymbolTile!==void 0&&qe.type==="symbol"!==this.isSymbolTile||qe.minzoom&&this.zoom<Math.floor(qe.minzoom)||qe.maxzoom&&this.zoom>=qe.maxzoom||qe.visibility!=="none"&&(ng(Be,this.zoom,c),(w[qe.id]=qe.createBucket({index:v.bucketLayerIDs.length,layers:Be,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Ne,sourceID:this.source,enableTerrain:this.enableTerrain,projection:this.projection.spec,availableImages:c})).populate(Je,S,this.tileID.canonical,this.tileTransform),v.bucketLayerIDs.push(Be.map(He=>He.id)))}}let L,z,B,V;T.trim();const Z={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},oe=Si(S.glyphDependencies,ye=>Object.keys(ye).map(Number));Object.keys(oe).length?d.send("getGlyphs",{uid:this.uid,stacks:oe},(ye,pe)=>{L||(L=ye,z=pe,ue.call(this))},void 0,!1,Z):z={};const de=Object.keys(S.iconDependencies);de.length?d.send("getImages",{icons:de,source:this.source,tileID:this.tileID,type:"icons"},(ye,pe)=>{L||(L=ye,B=pe,ue.call(this))},void 0,!1,Z):B={};const se=Object.keys(S.patternDependencies);function ue(){if(L)return m(L);if(z&&B&&V){const ye=new rv(z),pe=new rx(B,V);for(const Re in w){const Le=w[Re];Le instanceof Yo?(ng(Le.layers,this.zoom,c),tA(Le,z,ye.positions,B,pe.iconPositions,this.showCollisionBoxes,c,this.tileID.canonical,this.tileZoom,this.projection)):Le.hasPattern&&(Le instanceof mf||Le instanceof uf||Le instanceof Gu)&&(ng(Le.layers,this.zoom,c),Le.addFeatures(S,this.tileID.canonical,pe.patternPositions,c,this.tileTransform))}this.status="done",m(null,{buckets:Gi(w).filter(Re=>!Re.isEmpty()),featureIndex:v,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:ye.image,lineAtlas:T,imageAtlas:pe,glyphMap:this.returnDependencies?z:null,iconMap:this.returnDependencies?B:null,glyphPositions:this.returnDependencies?ye.positions:null})}}se.length?d.send("getImages",{icons:se,source:this.source,tileID:this.tileID,type:"patterns"},(ye,pe)=>{L||(L=ye,V=pe,ue.call(this))},void 0,!1,Z):V={},ue.call(this)}}function ng(r,t,s){const c=new le(t);for(const d of r)d.recalculate(c,s)}class sv{constructor(t){this.entries={},this.scheduler=t}request(t,s,c,d){const m=this.entries[t]=this.entries[t]||{callbacks:[]};if(m.result){const[_,v]=m.result;return this.scheduler?this.scheduler.add(()=>{d(_,v)},s):d(_,v),()=>{}}return m.callbacks.push(d),m.cancel||(m.cancel=c((_,v)=>{m.result=[_,v];for(const w of m.callbacks)this.scheduler?this.scheduler.add(()=>{w(_,v)},s):w(_,v);setTimeout(()=>delete this.entries[t],3e3)})),()=>{m.result||(m.callbacks=m.callbacks.filter(_=>_!==d),m.callbacks.length||(m.cancel(),delete this.entries[t]))}}}function ov(r,t,s){const c=JSON.stringify(r.request);return r.data&&(this.deduped.entries[c]={result:[null,r.data]}),this.deduped.request(c,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},d=>{const m=an(r.request,(_,v,w,T)=>{_?d(_):v&&d(null,{vectorTile:s?void 0:new km(new qu(v)),rawData:v,cacheControl:w,expires:T})});return()=>{m.cancel(),d()}},t)}a.ARRAY_TYPE=Tr,a.AUTH_ERR_MSG=es,a.Aabb=sr,a.Actor=class{constructor(r,t,s){this.target=r,this.parent=t,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Jn(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=gn()?r:E,this.scheduler=new PA}send(r,t,s,c,d=!1,m){const _=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=m,this.callbacks[_]=s);const v=dr(this.globalScope)?void 0:[];return this.target.postMessage({id:_,type:r,hasCallback:!!s,targetMapId:c,mustQueue:d,sourceMapId:this.mapId,data:Ea(t,v)},v),{cancel:()=>{s&&delete this.callbacks[_],this.target.postMessage({id:_,type:"<cancel>",targetMapId:c,sourceMapId:this.mapId})}}}receive(r){const t=r.data,s=t.id;if(s&&(!t.targetMapId||this.mapId===t.targetMapId))if(t.type==="<cancel>"){const c=this.cancelCallbacks[s];delete this.cancelCallbacks[s],c&&c.cancel()}else if(t.mustQueue||gn()){const c=this.callbacks[s];this.cancelCallbacks[s]=this.scheduler.add(()=>this.processTask(s,t),c&&c.metadata||{type:"message"})}else this.processTask(s,t)}processTask(r,t){if(t.type==="<response>"){const s=this.callbacks[r];delete this.callbacks[r],s&&(t.error?s(Gs(t.error)):s(null,Gs(t.data)))}else{const s=dr(this.globalScope)?void 0:[],c=t.hasCallback?(m,_)=>{delete this.cancelCallbacks[r],this.target.postMessage({id:r,type:"<response>",sourceMapId:this.mapId,error:m?Ea(m):null,data:Ea(_,s)},s)}:m=>{},d=Gs(t.data);if(this.parent[t.type])this.parent[t.type](t.sourceMapId,d,c);else if(this.parent.getWorkerSource){const m=t.type.split(".");this.parent.getWorkerSource(t.sourceMapId,m[0],d.source)[m[1]](d,c)}else c(new Error(`Could not find function ${t.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},a.CanonicalTileID=pf,a.Color=ri,a.ColorMode=eo,a.CullFaceMode=Rs,a.DEMData=kf,a.DataConstantProperty=Ie,a.DedupedRequest=sv,a.DepthMode=ec,a.EXTENT=zt,a.Elevation=class{isDataAvailableAtPoint(r){const t=this._source();if(this.isUsingMockSource()||!t||r.y<0||r.y>1)return!1;const s=t.getSource().maxzoom,c=1<<s,d=Math.floor(r.x),m=Math.floor((r.x-d)*c),_=Math.floor(r.y*c),v=this.findDEMTileFor(new or(s,d,s,m,_));return!(!v||!v.dem)}getAtPointOrZero(r,t=0){return this.getAtPoint(r,t)||0}getAtPoint(r,t,s=!0){if(this.isUsingMockSource())return null;t==null&&(t=null);const c=this._source();if(!c||r.y<0||r.y>1)return t;const d=c.getSource().maxzoom,m=1<<d,_=Math.floor(r.x),v=r.x-_,w=new or(d,_,d,Math.floor(v*m),Math.floor(r.y*m)),T=this.findDEMTileFor(w);if(!T||!T.dem)return t;const S=T.dem,C=1<<T.tileID.canonical.z,L=(v*C-T.tileID.canonical.x)*S.dim,z=(r.y*C-T.tileID.canonical.y)*S.dim,B=Math.floor(L),V=Math.floor(z);return(s?this.exaggeration():1)*ai(ai(S.get(B,V),S.get(B,V+1),z-V),ai(S.get(B+1,V),S.get(B+1,V+1),z-V),L-B)}getAtTileOffset(r,t,s){const c=1<<r.canonical.z;return this.getAtPointOrZero(new Ol(r.wrap+(r.canonical.x+t/zt)/c,(r.canonical.y+s/zt)/c))}getAtTileOffsetFunc(r,t,s,c){return d=>{const m=this.getAtTileOffset(r,d.x,d.y),_=c.upVector(r.canonical,d.x,d.y);return Fr(_,_,m*c.upVectorScale(r.canonical,t,s).metersToTile),_}}getForTilePoints(r,t,s,c){if(this.isUsingMockSource())return!1;const d=Rf.create(this,r,c);return!!d&&(t.forEach(m=>{m[2]=this.exaggeration()*d.getElevationAt(m[0],m[1],s)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;const t=this.findDEMTileFor(r);if(!t||!t.dem)return null;const s=t.dem.tree,c=t.tileID,d=1<<r.canonical.z-c.canonical.z;let m=r.canonical.x/d-c.canonical.x,_=r.canonical.y/d-c.canonical.y,v=0;for(let w=0;w<r.canonical.z-c.canonical.z&&!s.leaves[v];w++){m*=2,_*=2;const T=2*Math.floor(_)+Math.floor(m);v=s.childOffsets[v]+T,m%=1,_%=1}return{min:this.exaggeration()*s.minimums[v],max:this.exaggeration()*s.maximums[v]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,t,s){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},a.ErrorEvent=pt,a.EvaluationParameters=le,a.Event=Xe,a.Evented=It,a.FillExtrusionBucket=Gu,a.Frustum=Tm,a.FrustumCorners=wm,a.GLOBE_METERS_TO_ECEF=Wm,a.GLOBE_RADIUS=Ao,a.GLOBE_SCALE_MATCH_LATITUDE=45,a.GLOBE_ZOOM_THRESHOLD_MAX=6,a.GLOBE_ZOOM_THRESHOLD_MIN=5,a.GlobeSharedBuffers=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const r of this._poleSegments)r.destroy();for(const r of this._gridSegments)r.destroy();if(this._wireframeIndexBuffer){this._wireframeIndexBuffer.destroy();for(const r of this._wireframeSegments)r.destroy()}}_createGrid(r){const t=new Ht,s=new Hn,c=65;for(let d=0;d<c;d++)for(let m=0;m<c;m++)t.emplaceBack(m,d);this._gridSegments=[];for(let d=0,m=0;d<Yl.length;d++){const _=Yl[d];for(let w=0;w<_;w++)for(let T=0;T<64;T++){const S=w*c+T;s.emplaceBack(S+1,S,S+c),s.emplaceBack(S+c,S+c+1,S+1)}const v=64*_*2;this._gridSegments.push(cn.simpleSegment(0,m,(_+1)*c,v)),m+=v}this._gridBuffer=r.createVertexBuffer(t,Yu.members),this._gridIndexBuffer=r.createIndexBuffer(s,!0)}_createPoles(r){const t=new Hn;for(let d=0;d<=Xl;d++)t.emplaceBack(0,d+1,d+2);this._poleIndexBuffer=r.createIndexBuffer(t,!0);const s=new hs,c=new hs;this._poleSegments=[];for(let d=0,m=0;d<5;d++){const _=360/(1<<d);s.emplaceBack(0,-Ao,0,.5,0),c.emplaceBack(0,-Ao,0,.5,1);for(let v=0;v<=Xl;v++){const w=v/Xl,T=ai(0,_,w),[S,C,L]=Kl(lA,cA,T,Ao);s.emplaceBack(S,C,L,w,0),c.emplaceBack(S,C,L,w,1)}this._poleSegments.push(cn.simpleSegment(m,0,66,64)),m+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(s,Ex,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(c,Ex,!1)}getGridBuffers(r){return[this._gridBuffer,this._gridIndexBuffer,this._gridSegments[r]]}getPoleBuffers(r){return[this._poleNorthVertexBuffer,this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}getWirefameBuffers(r,t){if(!this._wireframeSegments){const s=new Or,c=Xl,d=c+1;this._wireframeSegments=[];for(let m=0,_=0;m<Yl.length;m++){const v=Yl[m];for(let T=0;T<v;T++)for(let S=0;S<c;S++){const C=T*d+S;s.emplaceBack(C,C+1),s.emplaceBack(C,C+d),s.emplaceBack(C,C+d+1)}const w=v*c*3;this._wireframeSegments.push(cn.simpleSegment(0,_,(v+1)*d,w)),_+=w}this._wireframeIndexBuffer=r.createIndexBuffer(s)}return[this._gridBuffer,this._wireframeIndexBuffer,this._wireframeSegments[t]]}},a.GlyphManager=ql,a.ImagePosition=Om,a.LivePerformanceUtils=Ge,a.LngLat=di,a.LngLatBounds=qo,a.LocalGlyphMode=Um,a.MAX_MERCATOR_LATITUDE=Hs,a.MercatorCoordinate=Ol,a.ONE_EM=jn,a.OverscaledTileID=or,a.PerformanceMarkers=Se,a.Properties=nt,a.RGBAImage=Er,a.Ray=bm,a.RequestManager=class{constructor(r,t,s){this._transformRequestFn=r,this._customAccessToken=t,this._silenceAuthErrors=!!s,this._createSkuToken()}_createSkuToken(){const r=function(){let t="";for(let s=0;s<10;s++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Oe,t].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=r.token,this._skuTokenExpiresAt=r.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(r,t){return this._transformRequestFn&&this._transformRequestFn(r,t)||{url:r}}normalizeStyleURL(r,t){if(!Bn(r))return r;const s=Tn(r);return s.path=`/styles/v1${s.path}`,this._makeAPIURL(s,this._customAccessToken||t)}normalizeGlyphsURL(r,t){if(!Bn(r))return r;const s=Tn(r);return s.path=`/fonts/v1${s.path}`,this._makeAPIURL(s,this._customAccessToken||t)}normalizeSourceURL(r,t,s,c){if(!Bn(r))return r;const d=Tn(r);return d.path=`/v4/${d.authority}.json`,d.params.push("secure"),s&&d.params.push(`language=${s}`),c&&d.params.push(`worldview=${c}`),this._makeAPIURL(d,this._customAccessToken||t)}normalizeSpriteURL(r,t,s,c){const d=Tn(r);return Bn(r)?(d.path=`/styles/v1${d.path}/sprite${t}${s}`,this._makeAPIURL(d,this._customAccessToken||c)):(d.path+=`${t}${s}`,pr(d))}normalizeTileURL(r,t,s){if(this._isSkuTokenExpired()&&this._createSkuToken(),r&&!Bn(r))return r;const c=Tn(r);c.path=c.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${t||s&&c.authority!=="raster"&&s===512?"@2x":""}${N.supported?".webp":"$1"}`),c.authority==="raster"?c.path=`/${R.RASTER_URL_PREFIX}${c.path}`:(c.path=c.path.replace(/^.+\/v4\//,"/"),c.path=`/${R.TILE_URL_VERSION}${c.path}`);const d=this._customAccessToken||function(m){for(const _ of m){const v=_.match(/^access_token=(.*)$/);if(v)return v[1]}return null}(c.params)||R.ACCESS_TOKEN;return R.REQUIRE_ACCESS_TOKEN&&d&&this._skuToken&&c.params.push(`sku=${this._skuToken}`),this._makeAPIURL(c,d)}canonicalizeTileURL(r,t){const s=Tn(r);if(!s.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!s.path.match(/\.[\w]+$/))return r;let c="mapbox://";s.path.match(/^\/raster\/v1\//)?c+=`raster/${s.path.replace(`/${R.RASTER_URL_PREFIX}/`,"")}`:c+=`tiles/${s.path.replace(`/${R.TILE_URL_VERSION}/`,"")}`;let d=s.params;return t&&(d=d.filter(m=>!m.match(/^access_token=/))),d.length&&(c+=`?${d.join("&")}`),c}canonicalizeTileset(r,t){const s=!!t&&Bn(t),c=[];for(const d of r.tiles||[])Cr(d)?c.push(this.canonicalizeTileURL(d,s)):c.push(d);return c}_makeAPIURL(r,t){const s="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",c=Tn(R.API_URL);if(r.protocol=c.protocol,r.authority=c.authority,r.protocol==="http"){const d=r.params.indexOf("secure");d>=0&&r.params.splice(d,1)}if(c.path!=="/"&&(r.path=`${c.path}${r.path}`),!R.REQUIRE_ACCESS_TOKEN)return pr(r);if(t=t||R.ACCESS_TOKEN,!this._silenceAuthErrors){if(!t)throw new Error(`An API access token is required to use Mapbox GL. ${s}`);if(t[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${s}`)}return r.params=r.params.filter(d=>d.indexOf("access_token")===-1),r.params.push(`access_token=${t||""}`),pr(r)}},a.ResourceType=yn,a.SegmentVector=cn,a.SourceCache=Ba,a.StencilMode=eg,a.StructArrayLayout1ui2=Pu,a.StructArrayLayout2f1f2i16=nr,a.StructArrayLayout2i4=Ht,a.StructArrayLayout2ui4=Or,a.StructArrayLayout3f12=zr,a.StructArrayLayout3ui6=Hn,a.StructArrayLayout4i8=wi,a.StructArrayLayout5f20=hs,a.Texture=rh,a.Tile=Jm,a.Transitionable=ze,a.Uniform1f=Kd,a.Uniform1i=class extends yo{constructor(r){super(r),this.current=0}set(r,t,s){this.fetchUniformLocation(r,t)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}},a.Uniform2f=class extends yo{constructor(r){super(r),this.current=[0,0]}set(r,t,s){this.fetchUniformLocation(r,t)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}},a.Uniform3f=class extends yo{constructor(r){super(r),this.current=[0,0,0]}set(r,t,s){this.fetchUniformLocation(r,t)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}},a.Uniform4f=Xy,a.UniformColor=Yy,a.UniformMatrix2f=class extends yo{constructor(r){super(r),this.current=f2}set(r,t,s){if(this.fetchUniformLocation(r,t)){for(let c=0;c<4;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}},a.UniformMatrix3f=class extends yo{constructor(r){super(r),this.current=d2}set(r,t,s){if(this.fetchUniformLocation(r,t)){for(let c=0;c<9;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix3fv(this.location,!1,s);break}}}},a.UniformMatrix4f=class extends yo{constructor(r){super(r),this.current=h2}set(r,t,s){if(this.fetchUniformLocation(r,t)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let c=1;c<16;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}},a.UnwrappedTileID=Z0,a.ValidationError=ht,a.VectorTileFeature=df,a.VectorTileWorkerSource=class extends It{constructor(r,t,s,c,d){super(),this.actor=r,this.layerIndex=t,this.availableImages=s,this.loadVectorData=d||ov,this.loading={},this.loaded={},this.deduped=new sv(r.scheduler),this.isSpriteLoaded=c,this.scheduler=r.scheduler}loadTile(r,t){const s=r.uid,c=r&&r.request,d=c&&c.collectResourceTiming,m=this.loading[s]=new RA(r);m.abort=this.loadVectorData(r,(_,v)=>{const w=!this.loading[s];if(delete this.loading[s],w||_||!v)return m.status="done",w||(this.loaded[s]=m),t(_);const T=v.rawData,S={};v.expires&&(S.expires=v.expires),v.cacheControl&&(S.cacheControl=v.cacheControl),m.vectorTile=v.vectorTile||new km(new qu(T));const C=()=>{m.parse(m.vectorTile,this.layerIndex,this.availableImages,this.actor,(L,z)=>{if(L||!z)return t(L);const B={};if(d){const V=At(c);V.length>0&&(B.resourceTiming=JSON.parse(JSON.stringify(V)))}t(null,ni({rawTileData:T.slice(0)},z,S,B))})};this.isSpriteLoaded?C():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(C,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom}):C()}),this.loaded=this.loaded||{},this.loaded[s]=m})}reloadTile(r,t){const s=this.loaded,c=r.uid,d=this;if(s&&s[c]){const m=s[c];m.showCollisionBoxes=r.showCollisionBoxes,m.enableTerrain=!!r.enableTerrain,m.projection=r.projection,m.tileTransform=Oa(r.tileID.canonical,r.projection);const _=(v,w)=>{const T=m.reloadCallback;T&&(delete m.reloadCallback,m.parse(m.vectorTile,d.layerIndex,this.availableImages,d.actor,T)),t(v,w)};m.status==="parsing"?m.reloadCallback=_:m.status==="done"&&(m.vectorTile?m.parse(m.vectorTile,this.layerIndex,this.availableImages,this.actor,_):_())}}abortTile(r,t){const s=r.uid,c=this.loading[s];c&&(c.abort&&c.abort(),delete this.loading[s]),t()}removeTile(r,t){const s=this.loaded,c=r.uid;s&&s[c]&&delete s[c],t()}},a.WritingMode=Nr,a.ZoomHistory=Od,a.add=bo,a.addDynamicAttributes=If,a.adjoint=function(r,t){var s=t[0],c=t[1],d=t[2],m=t[3],_=t[4],v=t[5],w=t[6],T=t[7],S=t[8];return r[0]=_*S-v*T,r[1]=d*T-c*S,r[2]=c*v-d*_,r[3]=v*w-m*S,r[4]=s*S-d*w,r[5]=d*m-s*v,r[6]=m*T-_*w,r[7]=c*w-s*T,r[8]=s*_-c*m,r},a.asyncAll=pn,a.bezier=ti,a.bindAll=Jn,a.boundsAttributes=Gx,a.bufferConvexPolygon=function(r,t){const s=[];for(let c=0;c<r.length;c++){const d=fn(c-1,-1,r.length-1),m=fn(c+1,-1,r.length-1),_=r[c],v=r[m],w=r[d].sub(_).unit(),T=v.sub(_).unit(),S=T.angleWithSep(w.x,w.y),C=w.add(T).unit().mult(-1*t/Math.sin(S/2));s.push(_.add(C))}return s},a.cacheEntryPossiblyAdded=function(r){Ir++,Ir>Yr&&(r.getActor().send("enforceCacheSizeLimit",Sn),Ir=0)},a.calculateGlobeLabelMatrix=function(r,t){const{x:s,y:c}=r.point,d=Cx(s,c,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Fl(d,d,qm(Ks(t)))},a.calculateGlobeMatrix=function(r){const{x:t,y:s}=r.point,{lng:c,lat:d}=r._center;return Cx(t,s,r.worldSize,c,d)},a.calculateGlobeMercatorMatrix=function(r){const t=r.pixelsPerMeter,s=t/ds(1,r.center.lat),c=Xs(new Float64Array(16));return Cu(c,c,[r.point.x,r.point.y,0]),ka(c,c,[s,s,t]),Float32Array.from(c)},a.circumferenceAtLatitude=cm,a.clamp=Lt,a.clearTileCache=function(r){if(!Kr())return;const t=E.caches.delete(Ji);r&&t.catch(r).then(()=>r())},a.clipLine=gx,a.clone=function(r){var t=new Tr(16);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],t},a.clone$1=yi,a.collisionCircleLayout=ME,a.config=R,a.conjugate=function(r,t){return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=t[3],r},a.create=function(){var r=new Tr(16);return Tr!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r},a.create$1=u0,a.createExpression=mo,a.createLayout=rt,a.createStyleLayer=function(r){return r.type==="custom"?new EA(r):new SA[r.type](r)},a.cross=vm,a.degToRad=et,a.distance=function(r,t){return Math.hypot(t[0]-r[0],t[1]-r[1],t[2]-r[2])},a.div=function(r,t,s){return r[0]=t[0]/s[0],r[1]=t[1]/s[1],r[2]=t[2]/s[2],r},a.dot=fs,a.earthRadius=Qd,a.ease=Zt,a.easeCubicInOut=si,a.ecefToLatLng=function([r,t,s]){const c=Math.hypot(r,t,s),d=Math.atan2(r,s),m=.5*Math.PI-Math.acos(-t/c);return new di(Tt(d),Tt(m))},a.emitValidationErrors=wu,a.endsWith=Ai,a.enforceCacheSizeLimit=function(r){fr(),Qi&&Qi.then(t=>{t.keys().then(s=>{for(let c=0;c<s.length-r;c++)t.delete(s[c])})})},a.evaluateSizeForFeature=gf,a.evaluateSizeForZoom=Gl,a.evaluateVariableOffset=bx,a.evented=ie,a.exactEquals=function(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]&&r[3]===t[3]},a.exactEquals$1=function(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]},a.exported=ii,a.exported$1=N,a.extend=ni,a.extend$1=Qt,a.fillExtrusionHeightLift=j0,a.filterObject=oi,a.fromMat4=function(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[4],r[4]=t[5],r[5]=t[6],r[6]=t[8],r[7]=t[9],r[8]=t[10],r},a.fromQuat=function(r,t){var s=t[0],c=t[1],d=t[2],m=t[3],_=s+s,v=c+c,w=d+d,T=s*_,S=c*_,C=c*v,L=d*_,z=d*v,B=d*w,V=m*_,Z=m*v,oe=m*w;return r[0]=1-C-B,r[1]=S+oe,r[2]=L-Z,r[3]=0,r[4]=S-oe,r[5]=1-T-B,r[6]=z+V,r[7]=0,r[8]=L+Z,r[9]=z-V,r[10]=1-T-C,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},a.fromRotation=function(r,t){var s=Math.sin(t),c=Math.cos(t);return r[0]=c,r[1]=s,r[2]=0,r[3]=-s,r[4]=c,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},a.fromScaling=d0,a.furthestTileCorner=function(r){const t=Math.round((r+45+360)%360/90)%4;return ut[t]},a.getAABBPointSquareDist=function(r,t,s){let c=0;for(let d=0;d<2;++d){const m=s?s[d]:0;r[d]>m&&(c+=(r[d]-m)*(r[d]-m)),t[d]<m&&(c+=(m-t[d])*(m-t[d]))}return c},a.getAnchorAlignment=Nm,a.getAnchorJustification=jm,a.getBounds=function(r){let t=1/0,s=1/0,c=-1/0,d=-1/0;for(const m of r)t=Math.min(t,m.x),s=Math.min(s,m.y),c=Math.max(c,m.x),d=Math.max(d,m.y);return{min:new Ee(t,s),max:new Ee(c,d)}},a.getColumn=Gn,a.getGridMatrix=function(r,t,s,c){const d=t.getNorth(),m=t.getSouth(),_=t.getWest(),v=t.getEast(),w=1<<r.z,T=v-_,S=d-m,C=T/Xl,L=-S/Yl[s],z=[0,C,0,L,0,0,d,_,0];if(r.z>0){const B=180/c;h0(z,z,[B/T+1,0,0,0,B/S+1,0,-.5*B/C,.5*B/L,1])}return z[2]=w,z[5]=r.x,z[8]=r.y,z},a.getImage=Qr,a.getJSON=function(r,t){return er(ni(r,{type:"json"}),t)},a.getLatitudinalLod=function(r){const t=80.051129;r=Lt(r,-80.051129,t)/t*90;const s=Math.pow(Math.abs(Math.sin(et(r))),3);return Math.round(s*(Yl.length-1))},a.getMapSessionAPI=Te,a.getPerformanceMeasurement=At,a.getProjection=Fx,a.getRTLTextPluginStatus=K,a.getReferrer=Pn,a.getTilePoint=function(r,{x:t,y:s},c=0){return new Ee(((t-c)*r.scale-r.x)*zt,(s*r.scale-r.y)*zt)},a.getTileVec3=function(r,t,s=0){return Nl(((t.x-s)*r.scale-r.x)*zt,(t.y*r.scale-r.y)*zt,Qy(t.z,t.y))},a.getVideo=function(r,t){const s=E.document.createElement("video");s.muted=!0,s.onloadstart=function(){t(null,s)};for(let c=0;c<r.length;c++){const d=E.document.createElement("source");xs(r[c])||(s.crossOrigin="Anonymous"),d.src=r[c],s.appendChild(d)}return{cancel:()=>{}}},a.globeCenterToScreenPoint=function(r){const t=[0,0,0],s=Xs(new Float64Array(16));return Fl(s,r.pixelMatrix,r.globeMatrix),un(t,t,s),new Ee(t[0],t[1])},a.globeDenormalizeECEF=qm,a.globeECEFOrigin=function(r,t){const s=[0,0,0];return un(s,s,Qu(Ks(t.canonical))),un(s,s,r),s},a.globeNormalizeECEF=Qu,a.globePixelsToTileUnits=function(r,t){return zt/(512*Math.pow(2,r))*Ef(Ks(t))},a.globePoleMatrixForTile=function(r,t,s){const c=Xs(new Float64Array(16)),d=(t/(1<<r)-.5)*Math.PI*2;return sf(c,s.globeMatrix,d),Float32Array.from(c)},a.globeTileBounds=Ks,a.globeTiltAtLngLat=Lx,a.globeToMercatorTransition=Jl,a.globeUseCustomAntiAliasing=function(r,t,s){const c=Jl(s.zoom),d=r.style.map._antialias,m=!!t.extStandardDerivatives,_=t.extStandardDerivativesForceOff||r.terrain&&r.terrain.exaggeration()>0;return c===0&&!d&&!_&&m},a.identity=Xs,a.identity$1=v0,a.invert=gm,a.isFullscreen=function(){return!!E.document.fullscreenElement||!!E.document.webkitFullscreenElement},a.isLngLatBehindGlobe=function(r,t){return Lx(r,t)>Math.PI/2*1.01},a.isMapAuthenticated=function(r){return xe.has(r)},a.isMapboxURL=Bn,a.isSafariWithAntialiasingBug=function(r){const t=r.navigator?r.navigator.userAgent:null;return!!dr(r)&&t&&(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},a.latFromMercatorY=Vn,a.latLngToECEF=Ku,a.len=C2,a.length=Lu,a.length$1=function(r){return Math.hypot(r[0],r[1],r[2],r[3])},a.lngFromMercatorX=Br,a.loadVectorTile=ov,a.makeRequest=er,a.mapValue=function(r,t,s,c,d){return Lt((r-t)/(s-t)*(d-c)+c,c,d)},a.mercatorScale=e0,a.mercatorXfromLng=$s,a.mercatorYfromLat=qs,a.mercatorZfromAltitude=ds,a.mul=P2,a.mul$1=I2,a.multiply=Fl,a.multiply$1=h0,a.multiply$2=m0,a.nextPowerOfTwo=$i,a.normalize=rr,a.normalize$1=L2,a.normalize$2=y0,a.number=ai,a.ortho=function(r,t,s,c,d,m,_){var v=1/(t-s),w=1/(c-d),T=1/(m-_);return r[0]=-2*v,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*w,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*T,r[11]=0,r[12]=(t+s)*v,r[13]=(d+c)*w,r[14]=(_+m)*T,r[15]=1,r},a.pbf=qu,a.perspective=function(r,t,s,c,d){var m,_=1/Math.tan(t/2);return r[0]=_/s,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=_,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,d!=null&&d!==1/0?(r[10]=(d+c)*(m=1/(c-d)),r[14]=2*d*c*m):(r[10]=-1,r[14]=-2*c),r},a.pick=function(r,t){const s={};for(let c=0;c<t.length;c++){const d=t[c];d in r&&(s[d]=r[d])}return s},a.plugin=fe,a.pointGeometry=Ee,a.polygonContainsPoint=La,a.polygonIntersectsBox=a0,a.polygonIntersectsPolygon=n0,a.polygonizeBounds=function(r,t,s=0,c=!0){const d=new Ee(s,s),m=r.sub(d),_=t.add(d),v=[m,new Ee(_.x,m.y),_,new Ee(m.x,_.y)];return c&&v.push(m.clone()),v},a.posAttributes=Yu,a.postMapLoadEvent=te,a.postPerformanceEvent=ge,a.postTurnstileEvent=F,a.potpack=zm,a.prevPowerOfTwo=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log(r)/Math.LN2))},a.radToDeg=Tt,a.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],a.registerForPluginStateChange=function(r){return r({pluginStatus:X,pluginURL:ee}),ie.on("pluginStateChange",r),r},a.removeAuthState=function(r){xe.delete(r)},a.renderColorRamp=Am,a.resample=t0,a.rotateX=_m,a.rotateX$1=b0,a.rotateY=sf,a.rotateY$1=w0,a.rotateZ=function(r,t,s){var c=Math.sin(s),d=Math.cos(s),m=t[0],_=t[1],v=t[2],w=t[3],T=t[4],S=t[5],C=t[6],L=t[7];return t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=m*d+T*c,r[1]=_*d+S*c,r[2]=v*d+C*c,r[3]=w*d+L*c,r[4]=T*d-m*c,r[5]=S*d-_*c,r[6]=C*d-v*c,r[7]=L*d-w*c,r},a.rotateZ$1=function(r,t,s){s*=.5;var c=t[0],d=t[1],m=t[2],_=t[3],v=Math.sin(s),w=Math.cos(s);return r[0]=c*w+d*v,r[1]=d*w-c*v,r[2]=m*w+_*v,r[3]=_*w-m*v,r},a.scale=ka,a.scale$1=_0,a.scale$2=Fr,a.scaleAndAdd=Du,a.set=function(r,t,s,c){return r[0]=t,r[1]=s,r[2]=c,r},a.setCacheLimits=function(r,t){Sn=r,Yr=t},a.setColumn=function(r,t,s){r[4*t+0]=s[0],r[4*t+1]=s[1],r[4*t+2]=s[2],r[4*t+3]=s[3]},a.setRTLTextPlugin=function(r,t,s=!1){if(X===D||X===U||X===W)throw new Error("setRTLTextPlugin cannot be called multiple times.");ee=ii.resolveURL(r),X=D,J=t,q(),s||he()},a.smoothstep=An,a.spec=Me,a.squaredLength=function(r){var t=r[0],s=r[1],c=r[2];return t*t+s*s+c*c},a.storeAuthState=function(r,t){t?xe.add(r):xe.delete(r)},a.sub=Cs,a.subtract=xm,a.symbolSize=PE,a.tileAABB=function(r,t,s,c,d,m,_,v,w){if(w.name==="globe")return aA(r,t,new pf(s,c,d));const T=Oa({z:s,x:c,y:d},w);return new sr([(m+T.x/T.scale)*t,t*(T.y/T.scale),_],[(m+T.x2/T.scale)*t,t*(T.y2/T.scale),v])},a.tileCornersToBounds=Tf,a.tileTransform=Oa,a.transformMat3=function(r,t,s){var c=t[0],d=t[1],m=t[2];return r[0]=c*s[0]+d*s[3]+m*s[6],r[1]=c*s[1]+d*s[4]+m*s[7],r[2]=c*s[2]+d*s[5]+m*s[8],r},a.transformMat4=un,a.transformMat4$1=Ra,a.transformQuat=g0,a.transitionTileAABBinECEF=Mx,a.translate=Cu,a.transpose=function(r,t){if(r===t){var s=t[1],c=t[2],d=t[5];r[1]=t[3],r[2]=t[6],r[3]=s,r[5]=t[7],r[6]=c,r[7]=d}else r[0]=t[0],r[1]=t[3],r[2]=t[6],r[3]=t[1],r[4]=t[4],r[5]=t[7],r[6]=t[2],r[7]=t[5],r[8]=t[8];return r},a.triggerPluginCompletionEvent=Y,a.uniqueId=ur,a.updateGlobeVertexNormal=function(r,t,s,c,d){const m=5*t+2;r.float32[m+0]=s,r.float32[m+1]=c,r.float32[m+2]=d},a.validateCustomStyleLayer=function(r){const t=[],s=r.id;return s===void 0&&t.push({message:`layers.${s}: missing required property "id"`}),r.render===void 0&&t.push({message:`layers.${s}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&t.push({message:`layers.${s}: property "renderingMode" must be either "2d" or "3d"`}),t},a.validateFilter=r=>Ms(wa(r)),a.validateFog=r=>Ms(kd(r)),a.validateLayer=r=>Ms(yu(r)),a.validateLight=r=>Ms(Ta(r)),a.validateSource=r=>Ms(Ml(r)),a.validateStyle=Rd,a.validateTerrain=r=>Ms(xu(r)),a.values=Gi,a.vectorTile=hf,a.version=I,a.warnOnce=fi,a.window=E,a.wrap=fn}),f(["./shared"],function(a){function E(ne){if(typeof ne=="number"||typeof ne=="boolean"||typeof ne=="string"||ne==null)return JSON.stringify(ne);if(Array.isArray(ne)){let j="[";for(const te of ne)j+=`${E(te)},`;return`${j}]`}let F="{";for(const j of Object.keys(ne).sort())F+=`${j}:${E(ne[j])},`;return`${F}}`}function I(ne){let F="";for(const j of a.refProperties)F+=`/${E(ne[j])}`;return F}class O{constructor(F){this.keyCache={},F&&this.replace(F)}replace(F){this._layerConfigs={},this._layers={},this.update(F,[])}update(F,j){for(const ce of F)this._layerConfigs[ce.id]=ce,(this._layers[ce.id]=a.createStyleLayer(ce)).compileFilter(),this.keyCache[ce.id]&&delete this.keyCache[ce.id];for(const ce of j)delete this.keyCache[ce],delete this._layerConfigs[ce],delete this._layers[ce];this.familiesBySource={};const te=function(ce,ge){const Ae={};for(let xe=0;xe<ce.length;xe++){const Se=ge&&ge[ce[xe].id]||I(ce[xe]);ge&&(ge[ce[xe].id]=Se);let Ge=Ae[Se];Ge||(Ge=Ae[Se]=[]),Ge.push(ce[xe])}const Te=[];for(const xe in Ae)Te.push(Ae[xe]);return Te}(a.values(this._layerConfigs),this.keyCache);for(const ce of te){const ge=ce.map(st=>this._layers[st.id]),Ae=ge[0];if(Ae.visibility==="none")continue;const Te=Ae.source||"";let xe=this.familiesBySource[Te];xe||(xe=this.familiesBySource[Te]={});const Se=Ae.sourceLayer||"_geojsonTileLayer";let Ge=xe[Se];Ge||(Ge=xe[Se]=[]),Ge.push(ge)}}}class R{loadTile(F,j){const{uid:te,encoding:ce,rawImageData:ge,padding:Ae,buildQuadTree:Te}=F,xe=a.window.ImageBitmap&&ge instanceof a.window.ImageBitmap?this.getImageData(ge,Ae):ge;j(null,new a.DEMData(te,xe,ce,Ae<1,Te))}getImageData(F,j){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);const te=this.offscreenCanvasContext.getImageData(-j,-j,F.width+2*j,F.height+2*j);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),te}}var N=function ne(F,j){var te,ce=F&&F.type;if(ce==="FeatureCollection")for(te=0;te<F.features.length;te++)ne(F.features[te],j);else if(ce==="GeometryCollection")for(te=0;te<F.geometries.length;te++)ne(F.geometries[te],j);else if(ce==="Feature")ne(F.geometry,j);else if(ce==="Polygon")H(F.coordinates,j);else if(ce==="MultiPolygon")for(te=0;te<F.coordinates.length;te++)H(F.coordinates[te],j);return F};function H(ne,F){if(ne.length!==0){re(ne[0],F);for(var j=1;j<ne.length;j++)re(ne[j],!F)}}function re(ne,F){for(var j=0,te=0,ce=0,ge=ne.length,Ae=ge-1;ce<ge;Ae=ce++){var Te=(ne[ce][0]-ne[Ae][0])*(ne[Ae][1]+ne[ce][1]),xe=j+Te;te+=Math.abs(j)>=Math.abs(Te)?j-xe+Te:Te-xe+j,j=xe}j+te>=0!=!!F&&ne.reverse()}const ae=a.VectorTileFeature.prototype.toGeoJSON;class be{constructor(F){this._feature=F,this.extent=a.EXTENT,this.type=F.type,this.properties=F.tags,"id"in F&&!isNaN(F.id)&&(this.id=parseInt(F.id,10))}loadGeometry(){if(this._feature.type===1){const F=[];for(const j of this._feature.geometry)F.push([new a.pointGeometry(j[0],j[1])]);return F}{const F=[];for(const j of this._feature.geometry){const te=[];for(const ce of j)te.push(new a.pointGeometry(ce[0],ce[1]));F.push(te)}return F}}toGeoJSON(F,j,te){return ae.call(this,F,j,te)}}class De{constructor(F){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=a.EXTENT,this.length=F.length,this._features=F}feature(F){return new be(this._features[F])}}var Oe={exports:{}},Ce=a.pointGeometry,Ve=a.vectorTile.VectorTileFeature,Ee=dt;function dt(ne,F){this.options=F||{},this.features=ne,this.length=ne.length}function wt(ne,F){this.id=typeof ne.id=="number"?ne.id:void 0,this.type=ne.type,this.rawGeometry=ne.type===1?[ne.geometry]:ne.geometry,this.properties=ne.tags,this.extent=F||4096}dt.prototype.feature=function(ne){return new wt(this.features[ne],this.options.extent)},wt.prototype.loadGeometry=function(){var ne=this.rawGeometry;this.geometry=[];for(var F=0;F<ne.length;F++){for(var j=ne[F],te=[],ce=0;ce<j.length;ce++)te.push(new Ce(j[ce][0],j[ce][1]));this.geometry.push(te)}return this.geometry},wt.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var ne=this.geometry,F=1/0,j=-1/0,te=1/0,ce=-1/0,ge=0;ge<ne.length;ge++)for(var Ae=ne[ge],Te=0;Te<Ae.length;Te++){var xe=Ae[Te];F=Math.min(F,xe.x),j=Math.max(j,xe.x),te=Math.min(te,xe.y),ce=Math.max(ce,xe.y)}return[F,te,j,ce]},wt.prototype.toGeoJSON=Ve.prototype.toGeoJSON;var kt=a.pbf,et=Ee;function Tt(ne){var F=new kt;return function(j,te){for(var ce in j.layers)te.writeMessage(3,ut,j.layers[ce])}(ne,F),F.finish()}function ut(ne,F){var j;F.writeVarintField(15,ne.version||1),F.writeStringField(1,ne.name||""),F.writeVarintField(5,ne.extent||4096);var te={keys:[],values:[],keycache:{},valuecache:{}};for(j=0;j<ne.length;j++)te.feature=ne.feature(j),F.writeMessage(2,si,te);var ce=te.keys;for(j=0;j<ce.length;j++)F.writeStringField(3,ce[j]);var ge=te.values;for(j=0;j<ge.length;j++)F.writeMessage(4,fn,ge[j])}function si(ne,F){var j=ne.feature;j.id!==void 0&&F.writeVarintField(1,j.id),F.writeMessage(2,ti,ne),F.writeVarintField(3,j.type),F.writeMessage(4,An,j)}function ti(ne,F){var j=ne.feature,te=ne.keys,ce=ne.values,ge=ne.keycache,Ae=ne.valuecache;for(var Te in j.properties){var xe=j.properties[Te],Se=ge[Te];if(xe!==null){Se===void 0&&(te.push(Te),ge[Te]=Se=te.length-1),F.writeVarint(Se);var Ge=typeof xe;Ge!=="string"&&Ge!=="boolean"&&Ge!=="number"&&(xe=JSON.stringify(xe));var st=Ge+":"+xe,Ze=Ae[st];Ze===void 0&&(ce.push(xe),Ae[st]=Ze=ce.length-1),F.writeVarint(Ze)}}}function Zt(ne,F){return(F<<3)+(7&ne)}function Lt(ne){return ne<<1^ne>>31}function An(ne,F){for(var j=ne.loadGeometry(),te=ne.type,ce=0,ge=0,Ae=j.length,Te=0;Te<Ae;Te++){var xe=j[Te],Se=1;te===1&&(Se=xe.length),F.writeVarint(Zt(1,Se));for(var Ge=te===3?xe.length-1:xe.length,st=0;st<Ge;st++){st===1&&te!==1&&F.writeVarint(Zt(2,Ge-1));var Ze=xe[st].x-ce,At=xe[st].y-ge;F.writeVarint(Lt(Ze)),F.writeVarint(Lt(At)),ce+=Ze,ge+=At}te===3&&F.writeVarint(Zt(7,1))}}function fn(ne,F){var j=typeof ne;j==="string"?F.writeStringField(1,ne):j==="boolean"?F.writeBooleanField(7,ne):j==="number"&&(ne%1!=0?F.writeDoubleField(3,ne):ne<0?F.writeSVarintField(6,ne):F.writeVarintField(5,ne))}function pn(ne,F,j,te,ce,ge){if(ce-te<=j)return;const Ae=te+ce>>1;Gi(ne,F,Ae,te,ce,ge%2),pn(ne,F,j,te,Ae-1,ge+1),pn(ne,F,j,Ae+1,ce,ge+1)}function Gi(ne,F,j,te,ce,ge){for(;ce>te;){if(ce-te>600){const Se=ce-te+1,Ge=j-te+1,st=Math.log(Se),Ze=.5*Math.exp(2*st/3),At=.5*Math.sqrt(st*Ze*(Se-Ze)/Se)*(Ge-Se/2<0?-1:1);Gi(ne,F,j,Math.max(te,Math.floor(j-Ge*Ze/Se+At)),Math.min(ce,Math.floor(j+(Se-Ge)*Ze/Se+At)),ge)}const Ae=F[2*j+ge];let Te=te,xe=ce;for(ni(ne,F,te,j),F[2*ce+ge]>Ae&&ni(ne,F,te,ce);Te<xe;){for(ni(ne,F,Te,xe),Te++,xe--;F[2*Te+ge]<Ae;)Te++;for(;F[2*xe+ge]>Ae;)xe--}F[2*te+ge]===Ae?ni(ne,F,te,xe):(xe++,ni(ne,F,xe,ce)),xe<=j&&(te=xe+1),j<=xe&&(ce=xe-1)}}function ni(ne,F,j,te){Hr(ne,j,te),Hr(F,2*j,2*te),Hr(F,2*j+1,2*te+1)}function Hr(ne,F,j){const te=ne[F];ne[F]=ne[j],ne[j]=te}function ur(ne,F,j,te){const ce=ne-j,ge=F-te;return ce*ce+ge*ge}Oe.exports=Tt,Oe.exports.fromVectorTileJs=Tt,Oe.exports.fromGeojsonVt=function(ne,F){F=F||{};var j={};for(var te in ne)j[te]=new et(ne[te].features,F),j[te].name=te,j[te].version=F.version,j[te].extent=F.extent;return Tt({layers:j})},Oe.exports.GeoJSONWrapper=et;const Ki=ne=>ne[0],$i=ne=>ne[1];class Xr{constructor(F,j=Ki,te=$i,ce=64,ge=Float64Array){this.nodeSize=ce,this.points=F;const Ae=F.length<65536?Uint16Array:Uint32Array,Te=this.ids=new Ae(F.length),xe=this.coords=new ge(2*F.length);for(let Se=0;Se<F.length;Se++)Te[Se]=Se,xe[2*Se]=j(F[Se]),xe[2*Se+1]=te(F[Se]);pn(Te,xe,ce,0,Te.length-1,0)}range(F,j,te,ce){return function(ge,Ae,Te,xe,Se,Ge,st){const Ze=[0,ge.length-1,0],At=[];let gt,yt;for(;Ze.length;){const Mt=Ze.pop(),Ut=Ze.pop(),ii=Ze.pop();if(Ut-ii<=st){for(let Xe=ii;Xe<=Ut;Xe++)gt=Ae[2*Xe],yt=Ae[2*Xe+1],gt>=Te&&gt<=Se&&yt>=xe&&yt<=Ge&&At.push(ge[Xe]);continue}const Pt=Math.floor((ii+Ut)/2);gt=Ae[2*Pt],yt=Ae[2*Pt+1],gt>=Te&&gt<=Se&&yt>=xe&&yt<=Ge&&At.push(ge[Pt]);const We=(Mt+1)%2;(Mt===0?Te<=gt:xe<=yt)&&(Ze.push(ii),Ze.push(Pt-1),Ze.push(We)),(Mt===0?Se>=gt:Ge>=yt)&&(Ze.push(Pt+1),Ze.push(Ut),Ze.push(We))}return At}(this.ids,this.coords,F,j,te,ce,this.nodeSize)}within(F,j,te){return function(ce,ge,Ae,Te,xe,Se){const Ge=[0,ce.length-1,0],st=[],Ze=xe*xe;for(;Ge.length;){const At=Ge.pop(),gt=Ge.pop(),yt=Ge.pop();if(gt-yt<=Se){for(let We=yt;We<=gt;We++)ur(ge[2*We],ge[2*We+1],Ae,Te)<=Ze&&st.push(ce[We]);continue}const Mt=Math.floor((yt+gt)/2),Ut=ge[2*Mt],ii=ge[2*Mt+1];ur(Ut,ii,Ae,Te)<=Ze&&st.push(ce[Mt]);const Pt=(At+1)%2;(At===0?Ae-xe<=Ut:Te-xe<=ii)&&(Ge.push(yt),Ge.push(Mt-1),Ge.push(Pt)),(At===0?Ae+xe>=Ut:Te+xe>=ii)&&(Ge.push(Mt+1),Ge.push(gt),Ge.push(Pt))}return st}(this.ids,this.coords,F,j,te,this.nodeSize)}}const Jn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ne=>ne},Ai=Math.fround||(Si=new Float32Array(1),ne=>(Si[0]=+ne,Si[0]));var Si;class oi{constructor(F){this.options=tn(Object.create(Jn),F),this.trees=new Array(this.options.maxZoom+1)}load(F){const{log:j,minZoom:te,maxZoom:ce,nodeSize:ge}=this.options;j&&console.time("total time");const Ae=`prepare ${F.length} points`;j&&console.time(Ae),this.points=F;let Te=[];for(let xe=0;xe<F.length;xe++)F[xe].geometry&&Te.push(hr(F[xe],xe));this.trees[ce+1]=new Xr(Te,dr,wr,ge,Float32Array),j&&console.timeEnd(Ae);for(let xe=ce;xe>=te;xe--){const Se=+Date.now();Te=this._cluster(Te,xe),this.trees[xe]=new Xr(Te,dr,wr,ge,Float32Array),j&&console.log("z%d: %d clusters in %dms",xe,Te.length,+Date.now()-Se)}return j&&console.timeEnd("total time"),this}getClusters(F,j){let te=((F[0]+180)%360+360)%360-180;const ce=Math.max(-90,Math.min(90,F[1]));let ge=F[2]===180?180:((F[2]+180)%360+360)%360-180;const Ae=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)te=-180,ge=180;else if(te>ge){const Ge=this.getClusters([te,ce,180,Ae],j),st=this.getClusters([-180,ce,ge,Ae],j);return Ge.concat(st)}const Te=this.trees[this._limitZoom(j)],xe=Te.range(Kt(te),gn(Ae),Kt(ge),gn(ce)),Se=[];for(const Ge of xe){const st=Te.points[Ge];Se.push(st.numPoints?fi(st):this.points[st.index])}return Se}getChildren(F){const j=this._getOriginId(F),te=this._getOriginZoom(F),ce="No cluster with the specified id.",ge=this.trees[te];if(!ge)throw new Error(ce);const Ae=ge.points[j];if(!Ae)throw new Error(ce);const Te=this.options.radius/(this.options.extent*Math.pow(2,te-1)),xe=ge.within(Ae.x,Ae.y,Te),Se=[];for(const Ge of xe){const st=ge.points[Ge];st.parentId===F&&Se.push(st.numPoints?fi(st):this.points[st.index])}if(Se.length===0)throw new Error(ce);return Se}getLeaves(F,j,te){const ce=[];return this._appendLeaves(ce,F,j=j||10,te=te||0,0),ce}getTile(F,j,te){const ce=this.trees[this._limitZoom(F)],ge=Math.pow(2,F),{extent:Ae,radius:Te}=this.options,xe=Te/Ae,Se=(te-xe)/ge,Ge=(te+1+xe)/ge,st={features:[]};return this._addTileFeatures(ce.range((j-xe)/ge,Se,(j+1+xe)/ge,Ge),ce.points,j,te,ge,st),j===0&&this._addTileFeatures(ce.range(1-xe/ge,Se,1,Ge),ce.points,ge,te,ge,st),j===ge-1&&this._addTileFeatures(ce.range(0,Se,xe/ge,Ge),ce.points,-1,te,ge,st),st.features.length?st:null}getClusterExpansionZoom(F){let j=this._getOriginZoom(F)-1;for(;j<=this.options.maxZoom;){const te=this.getChildren(F);if(j++,te.length!==1)break;F=te[0].properties.cluster_id}return j}_appendLeaves(F,j,te,ce,ge){const Ae=this.getChildren(j);for(const Te of Ae){const xe=Te.properties;if(xe&&xe.cluster?ge+xe.point_count<=ce?ge+=xe.point_count:ge=this._appendLeaves(F,xe.cluster_id,te,ce,ge):ge<ce?ge++:F.push(Te),F.length===te)break}return ge}_addTileFeatures(F,j,te,ce,ge,Ae){for(const Te of F){const xe=j[Te],Se=xe.numPoints;let Ge,st,Ze;if(Se)Ge=mn(xe),st=xe.x,Ze=xe.y;else{const yt=this.points[xe.index];Ge=yt.properties,st=Kt(yt.geometry.coordinates[0]),Ze=gn(yt.geometry.coordinates[1])}const At={type:1,geometry:[[Math.round(this.options.extent*(st*ge-te)),Math.round(this.options.extent*(Ze*ge-ce))]],tags:Ge};let gt;Se?gt=xe.id:this.options.generateId?gt=xe.index:this.points[xe.index].id&&(gt=this.points[xe.index].id),gt!==void 0&&(At.id=gt),Ae.features.push(At)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,j){const te=[],{radius:ce,extent:ge,reduce:Ae,minPoints:Te}=this.options,xe=ce/(ge*Math.pow(2,j));for(let Se=0;Se<F.length;Se++){const Ge=F[Se];if(Ge.zoom<=j)continue;Ge.zoom=j;const st=this.trees[j+1],Ze=st.within(Ge.x,Ge.y,xe),At=Ge.numPoints||1;let gt=At;for(const yt of Ze){const Mt=st.points[yt];Mt.zoom>j&&(gt+=Mt.numPoints||1)}if(gt>At&&gt>=Te){let yt=Ge.x*At,Mt=Ge.y*At,Ut=Ae&&At>1?this._map(Ge,!0):null;const ii=(Se<<5)+(j+1)+this.points.length;for(const Pt of Ze){const We=st.points[Pt];if(We.zoom<=j)continue;We.zoom=j;const Xe=We.numPoints||1;yt+=We.x*Xe,Mt+=We.y*Xe,We.parentId=ii,Ae&&(Ut||(Ut=this._map(Ge,!0)),Ae(Ut,this._map(We)))}Ge.parentId=ii,te.push(yi(yt/gt,Mt/gt,ii,gt,Ut))}else if(te.push(Ge),gt>1)for(const yt of Ze){const Mt=st.points[yt];Mt.zoom<=j||(Mt.zoom=j,te.push(Mt))}}return te}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,j){if(F.numPoints)return j?tn({},F.properties):F.properties;const te=this.points[F.index].properties,ce=this.options.map(te);return j&&ce===te?tn({},ce):ce}}function yi(ne,F,j,te,ce){return{x:Ai(ne),y:Ai(F),zoom:1/0,id:j,parentId:-1,numPoints:te,properties:ce}}function hr(ne,F){const[j,te]=ne.geometry.coordinates;return{x:Ai(Kt(j)),y:Ai(gn(te)),zoom:1/0,index:F,parentId:-1}}function fi(ne){return{type:"Feature",id:ne.id,properties:mn(ne),geometry:{type:"Point",coordinates:[(F=ne.x,360*(F-.5)),_n(ne.y)]}};var F}function mn(ne){const F=ne.numPoints,j=F>=1e4?`${Math.round(F/1e3)}k`:F>=1e3?Math.round(F/100)/10+"k":F;return tn(tn({},ne.properties),{cluster:!0,cluster_id:ne.id,point_count:F,point_count_abbreviated:j})}function Kt(ne){return ne/360+.5}function gn(ne){const F=Math.sin(ne*Math.PI/180),j=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return j<0?0:j>1?1:j}function _n(ne){const F=(180-360*ne)*Math.PI/180;return 360*Math.atan(Math.exp(F))/Math.PI-90}function tn(ne,F){for(const j in F)ne[j]=F[j];return ne}function dr(ne){return ne.x}function wr(ne){return ne.y}function Gn(ne,F,j,te){for(var ce,ge=te,Ae=j-F>>1,Te=j-F,xe=ne[F],Se=ne[F+1],Ge=ne[j],st=ne[j+1],Ze=F+3;Ze<j;Ze+=3){var At=Ji(ne[Ze],ne[Ze+1],xe,Se,Ge,st);if(At>ge)ce=Ze,ge=At;else if(At===ge){var gt=Math.abs(Ze-Ae);gt<Te&&(ce=Ze,Te=gt)}}ge>te&&(ce-F>3&&Gn(ne,F,ce,te),ne[ce+2]=ge,j-ce>3&&Gn(ne,ce,j,te))}function Ji(ne,F,j,te,ce,ge){var Ae=ce-j,Te=ge-te;if(Ae!==0||Te!==0){var xe=((ne-j)*Ae+(F-te)*Te)/(Ae*Ae+Te*Te);xe>1?(j=ce,te=ge):xe>0&&(j+=Ae*xe,te+=Te*xe)}return(Ae=ne-j)*Ae+(Te=F-te)*Te}function Qi(ne,F,j,te){var ce={id:ne===void 0?null:ne,type:F,geometry:j,tags:te,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(ge){var Ae=ge.geometry,Te=ge.type;if(Te==="Point"||Te==="MultiPoint"||Te==="LineString")Qn(ge,Ae);else if(Te==="Polygon"||Te==="MultiLineString")for(var xe=0;xe<Ae.length;xe++)Qn(ge,Ae[xe]);else if(Te==="MultiPolygon")for(xe=0;xe<Ae.length;xe++)for(var Se=0;Se<Ae[xe].length;Se++)Qn(ge,Ae[xe][Se])}(ce),ce}function Qn(ne,F){for(var j=0;j<F.length;j+=3)ne.minX=Math.min(ne.minX,F[j]),ne.minY=Math.min(ne.minY,F[j+1]),ne.maxX=Math.max(ne.maxX,F[j]),ne.maxY=Math.max(ne.maxY,F[j+1])}function Sn(ne,F,j,te){if(F.geometry){var ce=F.geometry.coordinates,ge=F.geometry.type,Ae=Math.pow(j.tolerance/((1<<j.maxZoom)*j.extent),2),Te=[],xe=F.id;if(j.promoteId?xe=F.properties[j.promoteId]:j.generateId&&(xe=te||0),ge==="Point")Yr(ce,Te);else if(ge==="MultiPoint")for(var Se=0;Se<ce.length;Se++)Yr(ce[Se],Te);else if(ge==="LineString")Kr(ce,Te,Ae,!1);else if(ge==="MultiLineString"){if(j.lineMetrics){for(Se=0;Se<ce.length;Se++)Kr(ce[Se],Te=[],Ae,!1),ne.push(Qi(xe,"LineString",Te,F.properties));return}fr(ce,Te,Ae,!1)}else if(ge==="Polygon")fr(ce,Te,Ae,!0);else{if(ge!=="MultiPolygon"){if(ge==="GeometryCollection"){for(Se=0;Se<F.geometry.geometries.length;Se++)Sn(ne,{id:xe,geometry:F.geometry.geometries[Se],properties:F.properties},j,te);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Se=0;Se<ce.length;Se++){var Ge=[];fr(ce[Se],Ge,Ae,!0),Te.push(Ge)}}ne.push(Qi(xe,ge,Te,F.properties))}}function Yr(ne,F){F.push(Wi(ne[0])),F.push(Ir(ne[1])),F.push(0)}function Kr(ne,F,j,te){for(var ce,ge,Ae=0,Te=0;Te<ne.length;Te++){var xe=Wi(ne[Te][0]),Se=Ir(ne[Te][1]);F.push(xe),F.push(Se),F.push(0),Te>0&&(Ae+=te?(ce*Se-xe*ge)/2:Math.sqrt(Math.pow(xe-ce,2)+Math.pow(Se-ge,2))),ce=xe,ge=Se}var Ge=F.length-3;F[2]=1,Gn(F,0,Ge,j),F[Ge+2]=1,F.size=Math.abs(Ae),F.start=0,F.end=F.size}function fr(ne,F,j,te){for(var ce=0;ce<ne.length;ce++){var ge=[];Kr(ne[ce],ge,j,te),F.push(ge)}}function Wi(ne){return ne/360+.5}function Ir(ne){var F=Math.sin(ne*Math.PI/180),j=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return j<0?0:j>1?1:j}function yn(ne,F,j,te,ce,ge,Ae,Te){if(te/=F,ge>=(j/=F)&&Ae<te)return ne;if(Ae<j||ge>=te)return null;for(var xe=[],Se=0;Se<ne.length;Se++){var Ge=ne[Se],st=Ge.geometry,Ze=Ge.type,At=ce===0?Ge.minX:Ge.minY,gt=ce===0?Ge.maxX:Ge.maxY;if(At>=j&&gt<te)xe.push(Ge);else if(!(gt<j||At>=te)){var yt=[];if(Ze==="Point"||Ze==="MultiPoint")Mn(st,yt,j,te,ce);else if(Ze==="LineString")Pn(st,yt,j,te,ce,!1,Te.lineMetrics);else if(Ze==="MultiLineString")an(st,yt,j,te,ce,!1);else if(Ze==="Polygon")an(st,yt,j,te,ce,!0);else if(Ze==="MultiPolygon")for(var Mt=0;Mt<st.length;Mt++){var Ut=[];an(st[Mt],Ut,j,te,ce,!0),Ut.length&&yt.push(Ut)}if(yt.length){if(Te.lineMetrics&&Ze==="LineString"){for(Mt=0;Mt<yt.length;Mt++)xe.push(Qi(Ge.id,Ze,yt[Mt],Ge.tags));continue}Ze!=="LineString"&&Ze!=="MultiLineString"||(yt.length===1?(Ze="LineString",yt=yt[0]):Ze="MultiLineString"),Ze!=="Point"&&Ze!=="MultiPoint"||(Ze=yt.length===3?"Point":"MultiPoint"),xe.push(Qi(Ge.id,Ze,yt,Ge.tags))}}}return xe.length?xe:null}function Mn(ne,F,j,te,ce){for(var ge=0;ge<ne.length;ge+=3){var Ae=ne[ge+ce];Ae>=j&&Ae<=te&&(F.push(ne[ge]),F.push(ne[ge+1]),F.push(ne[ge+2]))}}function Pn(ne,F,j,te,ce,ge,Ae){for(var Te,xe,Se=er(ne),Ge=ce===0?Fs:Jr,st=ne.start,Ze=0;Ze<ne.length-3;Ze+=3){var At=ne[Ze],gt=ne[Ze+1],yt=ne[Ze+2],Mt=ne[Ze+3],Ut=ne[Ze+4],ii=ce===0?At:gt,Pt=ce===0?Mt:Ut,We=!1;Ae&&(Te=Math.sqrt(Math.pow(At-Mt,2)+Math.pow(gt-Ut,2))),ii<j?Pt>j&&(xe=Ge(Se,At,gt,Mt,Ut,j),Ae&&(Se.start=st+Te*xe)):ii>te?Pt<te&&(xe=Ge(Se,At,gt,Mt,Ut,te),Ae&&(Se.start=st+Te*xe)):xs(Se,At,gt,yt),Pt<j&&ii>=j&&(xe=Ge(Se,At,gt,Mt,Ut,j),We=!0),Pt>te&&ii<=te&&(xe=Ge(Se,At,gt,Mt,Ut,te),We=!0),!ge&&We&&(Ae&&(Se.end=st+Te*xe),F.push(Se),Se=er(ne)),Ae&&(st+=Te)}var Xe=ne.length-3;At=ne[Xe],gt=ne[Xe+1],yt=ne[Xe+2],(ii=ce===0?At:gt)>=j&&ii<=te&&xs(Se,At,gt,yt),Xe=Se.length-3,ge&&Xe>=3&&(Se[Xe]!==Se[0]||Se[Xe+1]!==Se[1])&&xs(Se,Se[0],Se[1],Se[2]),Se.length&&F.push(Se)}function er(ne){var F=[];return F.size=ne.size,F.start=ne.start,F.end=ne.end,F}function an(ne,F,j,te,ce,ge){for(var Ae=0;Ae<ne.length;Ae++)Pn(ne[Ae],F,j,te,ce,ge,!1)}function xs(ne,F,j,te){ne.push(F),ne.push(j),ne.push(te)}function Fs(ne,F,j,te,ce,ge){var Ae=(ge-F)/(te-F);return ne.push(ge),ne.push(j+(ce-j)*Ae),ne.push(1),Ae}function Jr(ne,F,j,te,ce,ge){var Ae=(ge-j)/(ce-j);return ne.push(F+(te-F)*Ae),ne.push(ge),ne.push(1),Ae}function Wn(ne,F){for(var j=[],te=0;te<ne.length;te++){var ce,ge=ne[te],Ae=ge.type;if(Ae==="Point"||Ae==="MultiPoint"||Ae==="LineString")ce=Qr(ge.geometry,F);else if(Ae==="MultiLineString"||Ae==="Polygon"){ce=[];for(var Te=0;Te<ge.geometry.length;Te++)ce.push(Qr(ge.geometry[Te],F))}else if(Ae==="MultiPolygon")for(ce=[],Te=0;Te<ge.geometry.length;Te++){for(var xe=[],Se=0;Se<ge.geometry[Te].length;Se++)xe.push(Qr(ge.geometry[Te][Se],F));ce.push(xe)}j.push(Qi(ge.id,Ae,ce,ge.tags))}return j}function Qr(ne,F){var j=[];j.size=ne.size,ne.start!==void 0&&(j.start=ne.start,j.end=ne.end);for(var te=0;te<ne.length;te+=3)j.push(ne[te]+F,ne[te+1],ne[te+2]);return j}function es(ne,F){if(ne.transformed)return ne;var j,te,ce,ge=1<<ne.z,Ae=ne.x,Te=ne.y;for(j=0;j<ne.features.length;j++){var xe=ne.features[j],Se=xe.geometry,Ge=xe.type;if(xe.geometry=[],Ge===1)for(te=0;te<Se.length;te+=2)xe.geometry.push(Bn(Se[te],Se[te+1],F,ge,Ae,Te));else for(te=0;te<Se.length;te++){var st=[];for(ce=0;ce<Se[te].length;ce+=2)st.push(Bn(Se[te][ce],Se[te][ce+1],F,ge,Ae,Te));xe.geometry.push(st)}}return ne.transformed=!0,ne}function Bn(ne,F,j,te,ce,ge){return[Math.round(j*(ne*te-ce)),Math.round(j*(F*te-ge))]}function Cr(ne,F,j,te,ce){for(var ge=F===ce.maxZoom?0:ce.tolerance/((1<<F)*ce.extent),Ae={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:j,y:te,z:F,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Te=0;Te<ne.length;Te++){Ae.numFeatures++,ts(Ae,ne[Te],ge,ce);var xe=ne[Te].minX,Se=ne[Te].minY,Ge=ne[Te].maxX,st=ne[Te].maxY;xe<Ae.minX&&(Ae.minX=xe),Se<Ae.minY&&(Ae.minY=Se),Ge>Ae.maxX&&(Ae.maxX=Ge),st>Ae.maxY&&(Ae.maxY=st)}return Ae}function ts(ne,F,j,te){var ce=F.geometry,ge=F.type,Ae=[];if(ge==="Point"||ge==="MultiPoint")for(var Te=0;Te<ce.length;Te+=3)Ae.push(ce[Te]),Ae.push(ce[Te+1]),ne.numPoints++,ne.numSimplified++;else if(ge==="LineString")Lr(Ae,ce,ne,j,!1,!1);else if(ge==="MultiLineString"||ge==="Polygon")for(Te=0;Te<ce.length;Te++)Lr(Ae,ce[Te],ne,j,ge==="Polygon",Te===0);else if(ge==="MultiPolygon")for(var xe=0;xe<ce.length;xe++){var Se=ce[xe];for(Te=0;Te<Se.length;Te++)Lr(Ae,Se[Te],ne,j,!0,Te===0)}if(Ae.length){var Ge=F.tags||null;if(ge==="LineString"&&te.lineMetrics){for(var st in Ge={},F.tags)Ge[st]=F.tags[st];Ge.mapbox_clip_start=ce.start/ce.size,Ge.mapbox_clip_end=ce.end/ce.size}var Ze={geometry:Ae,type:ge==="Polygon"||ge==="MultiPolygon"?3:ge==="LineString"||ge==="MultiLineString"?2:1,tags:Ge};F.id!==null&&(Ze.id=F.id),ne.features.push(Ze)}}function Lr(ne,F,j,te,ce,ge){var Ae=te*te;if(te>0&&F.size<(ce?Ae:te))j.numPoints+=F.length/3;else{for(var Te=[],xe=0;xe<F.length;xe+=3)(te===0||F[xe+2]>Ae)&&(j.numSimplified++,Te.push(F[xe]),Te.push(F[xe+1])),j.numPoints++;ce&&function(Se,Ge){for(var st=0,Ze=0,At=Se.length,gt=At-2;Ze<At;gt=Ze,Ze+=2)st+=(Se[Ze]-Se[gt])*(Se[Ze+1]+Se[gt+1]);if(st>0===Ge)for(Ze=0,At=Se.length;Ze<At/2;Ze+=2){var yt=Se[Ze],Mt=Se[Ze+1];Se[Ze]=Se[At-2-Ze],Se[Ze+1]=Se[At-1-Ze],Se[At-2-Ze]=yt,Se[At-1-Ze]=Mt}}(Te,ge),ne.push(Te)}}function kr(ne,F){var j=(F=this.options=function(ce,ge){for(var Ae in ge)ce[Ae]=ge[Ae];return ce}(Object.create(this.options),F)).debug;if(j&&console.time("preprocess data"),F.maxZoom<0||F.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(F.promoteId&&F.generateId)throw new Error("promoteId and generateId cannot be used together.");var te=function(ce,ge){var Ae=[];if(ce.type==="FeatureCollection")for(var Te=0;Te<ce.features.length;Te++)Sn(Ae,ce.features[Te],ge,Te);else Sn(Ae,ce.type==="Feature"?ce:{geometry:ce},ge);return Ae}(ne,F);this.tiles={},this.tileCoords=[],j&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",F.indexMaxZoom,F.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),te=function(ce,ge){var Ae=ge.buffer/ge.extent,Te=ce,xe=yn(ce,1,-1-Ae,Ae,0,-1,2,ge),Se=yn(ce,1,1-Ae,2+Ae,0,-1,2,ge);return(xe||Se)&&(Te=yn(ce,1,-Ae,1+Ae,0,-1,2,ge)||[],xe&&(Te=Wn(xe,1).concat(Te)),Se&&(Te=Te.concat(Wn(Se,-1)))),Te}(te,F),te.length&&this.splitTile(te,0,0,0),j&&(te.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Tn(ne,F,j){return 32*((1<<ne)*j+F)+ne}function pr(ne,F){const j=ne.tileID.canonical;if(!this._geoJSONIndex)return F(null,null);const te=this._geoJSONIndex.getTile(j.z,j.x,j.y);if(!te)return F(null,null);const ce=new De(te.features);let ge=Oe.exports(ce);ge.byteOffset===0&&ge.byteLength===ge.buffer.byteLength||(ge=new Uint8Array(ge)),F(null,{vectorTile:ce,rawData:ge.buffer})}kr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},kr.prototype.splitTile=function(ne,F,j,te,ce,ge,Ae){for(var Te=[ne,F,j,te],xe=this.options,Se=xe.debug;Te.length;){te=Te.pop(),j=Te.pop(),F=Te.pop(),ne=Te.pop();var Ge=1<<F,st=Tn(F,j,te),Ze=this.tiles[st];if(!Ze&&(Se>1&&console.time("creation"),Ze=this.tiles[st]=Cr(ne,F,j,te,xe),this.tileCoords.push({z:F,x:j,y:te}),Se)){Se>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",F,j,te,Ze.numFeatures,Ze.numPoints,Ze.numSimplified),console.timeEnd("creation"));var At="z"+F;this.stats[At]=(this.stats[At]||0)+1,this.total++}if(Ze.source=ne,ce){if(F===xe.maxZoom||F===ce)continue;var gt=1<<ce-F;if(j!==Math.floor(ge/gt)||te!==Math.floor(Ae/gt))continue}else if(F===xe.indexMaxZoom||Ze.numPoints<=xe.indexMaxPoints)continue;if(Ze.source=null,ne.length!==0){Se>1&&console.time("clipping");var yt,Mt,Ut,ii,Pt,We,Xe=.5*xe.buffer/xe.extent,pt=.5-Xe,It=.5+Xe,Me=1+Xe;yt=Mt=Ut=ii=null,Pt=yn(ne,Ge,j-Xe,j+It,0,Ze.minX,Ze.maxX,xe),We=yn(ne,Ge,j+pt,j+Me,0,Ze.minX,Ze.maxX,xe),ne=null,Pt&&(yt=yn(Pt,Ge,te-Xe,te+It,1,Ze.minY,Ze.maxY,xe),Mt=yn(Pt,Ge,te+pt,te+Me,1,Ze.minY,Ze.maxY,xe),Pt=null),We&&(Ut=yn(We,Ge,te-Xe,te+It,1,Ze.minY,Ze.maxY,xe),ii=yn(We,Ge,te+pt,te+Me,1,Ze.minY,Ze.maxY,xe),We=null),Se>1&&console.timeEnd("clipping"),Te.push(yt||[],F+1,2*j,2*te),Te.push(Mt||[],F+1,2*j,2*te+1),Te.push(Ut||[],F+1,2*j+1,2*te),Te.push(ii||[],F+1,2*j+1,2*te+1)}}},kr.prototype.getTile=function(ne,F,j){var te=this.options,ce=te.extent,ge=te.debug;if(ne<0||ne>24)return null;var Ae=1<<ne,Te=Tn(ne,F=(F%Ae+Ae)%Ae,j);if(this.tiles[Te])return es(this.tiles[Te],ce);ge>1&&console.log("drilling down to z%d-%d-%d",ne,F,j);for(var xe,Se=ne,Ge=F,st=j;!xe&&Se>0;)Se--,Ge=Math.floor(Ge/2),st=Math.floor(st/2),xe=this.tiles[Tn(Se,Ge,st)];return xe&&xe.source?(ge>1&&console.log("found parent tile z%d-%d-%d",Se,Ge,st),ge>1&&console.time("drilling down"),this.splitTile(xe.source,Se,Ge,st,ne,F,j),ge>1&&console.timeEnd("drilling down"),this.tiles[Te]?es(this.tiles[Te],ce):null):null};class vs extends a.VectorTileWorkerSource{constructor(F,j,te,ce,ge){super(F,j,te,ce,pr),ge&&(this.loadGeoJSON=ge)}loadData(F,j){const te=F&&F.request,ce=te&&te.collectResourceTiming;this.loadGeoJSON(F,(ge,Ae)=>{if(ge||!Ae)return j(ge);if(typeof Ae!="object")return j(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));{N(Ae,!0);try{if(F.filter){const xe=a.createExpression(F.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(xe.result==="error")throw new Error(xe.value.map(Ge=>`${Ge.key}: ${Ge.message}`).join(", "));Ae={type:"FeatureCollection",features:Ae.features.filter(Ge=>xe.value.evaluate({zoom:0},Ge))}}this._geoJSONIndex=F.cluster?new oi(function({superclusterOptions:xe,clusterProperties:Se}){if(!Se||!xe)return xe;const Ge={},st={},Ze={accumulated:null,zoom:0},At={properties:null},gt=Object.keys(Se);for(const yt of gt){const[Mt,Ut]=Se[yt],ii=a.createExpression(Ut),Pt=a.createExpression(typeof Mt=="string"?[Mt,["accumulated"],["get",yt]]:Mt);Ge[yt]=ii.value,st[yt]=Pt.value}return xe.map=yt=>{At.properties=yt;const Mt={};for(const Ut of gt)Mt[Ut]=Ge[Ut].evaluate(Ze,At);return Mt},xe.reduce=(yt,Mt)=>{At.properties=Mt;for(const Ut of gt)Ze.accumulated=yt[Ut],yt[Ut]=st[Ut].evaluate(Ze,At)},xe}(F)).load(Ae.features):function(xe,Se){return new kr(xe,Se)}(Ae,F.geojsonVtOptions)}catch(xe){return j(xe)}this.loaded={};const Te={};if(ce){const xe=a.getPerformanceMeasurement(te);xe&&(Te.resourceTiming={},Te.resourceTiming[F.source]=JSON.parse(JSON.stringify(xe)))}j(null,Te)}})}reloadTile(F,j){const te=this.loaded;return te&&te[F.uid]?super.reloadTile(F,j):this.loadTile(F,j)}loadGeoJSON(F,j){if(F.request)a.getJSON(F.request,j);else{if(typeof F.data!="string")return j(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));try{return j(null,JSON.parse(F.data))}catch{return j(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(F,j){try{j(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(te){j(te)}}getClusterChildren(F,j){try{j(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(te){j(te)}}getClusterLeaves(F,j){try{j(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(te){j(te)}}}class is{constructor(F){this.self=F,this.actor=new a.Actor(F,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=a.getProjection({name:"mercator"}),this.workerSourceTypes={vector:a.VectorTileWorkerSource,geojson:vs},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(j,te)=>{if(this.workerSourceTypes[j])throw new Error(`Worker source with name "${j}" already registered.`);this.workerSourceTypes[j]=te},this.self.registerRTLTextPlugin=j=>{if(a.plugin.isParsed())throw new Error("RTL text plugin already registered.");a.plugin.applyArabicShaping=j.applyArabicShaping,a.plugin.processBidirectionalText=j.processBidirectionalText,a.plugin.processStyledBidirectionalText=j.processStyledBidirectionalText}}clearCaches(F,j,te){delete this.layerIndexes[F],delete this.availableImages[F],delete this.workerSources[F],delete this.demWorkerSources[F],te()}checkIfReady(F,j,te){te()}setReferrer(F,j){this.referrer=j}spriteLoaded(F,j){this.isSpriteLoaded[F]=j;for(const te in this.workerSources[F]){const ce=this.workerSources[F][te];for(const ge in ce)ce[ge]instanceof a.VectorTileWorkerSource&&(ce[ge].isSpriteLoaded=j,ce[ge].fire(new a.Event("isSpriteLoaded")))}}setImages(F,j,te){this.availableImages[F]=j;for(const ce in this.workerSources[F]){const ge=this.workerSources[F][ce];for(const Ae in ge)ge[Ae].availableImages=j}te()}enableTerrain(F,j,te){this.terrain=j,te()}setProjection(F,j){this.projections[F]=a.getProjection(j)}setLayers(F,j,te){this.getLayerIndex(F).replace(j),te()}updateLayers(F,j,te){this.getLayerIndex(F).update(j.layers,j.removedIds),te()}loadTile(F,j,te){const ce=this.enableTerrain?a.extend({enableTerrain:this.terrain},j):j;ce.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,j.type,j.source).loadTile(ce,te)}loadDEMTile(F,j,te){const ce=this.enableTerrain?a.extend({buildQuadTree:this.terrain},j):j;this.getDEMWorkerSource(F,j.source).loadTile(ce,te)}reloadTile(F,j,te){const ce=this.enableTerrain?a.extend({enableTerrain:this.terrain},j):j;ce.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,j.type,j.source).reloadTile(ce,te)}abortTile(F,j,te){this.getWorkerSource(F,j.type,j.source).abortTile(j,te)}removeTile(F,j,te){this.getWorkerSource(F,j.type,j.source).removeTile(j,te)}removeSource(F,j,te){if(!this.workerSources[F]||!this.workerSources[F][j.type]||!this.workerSources[F][j.type][j.source])return;const ce=this.workerSources[F][j.type][j.source];delete this.workerSources[F][j.type][j.source],ce.removeSource!==void 0?ce.removeSource(j,te):te()}loadWorkerSource(F,j,te){try{this.self.importScripts(j.url),te()}catch(ce){te(ce.toString())}}syncRTLPluginState(F,j,te){try{a.plugin.setState(j);const ce=a.plugin.getPluginURL();if(a.plugin.isLoaded()&&!a.plugin.isParsed()&&ce!=null){this.self.importScripts(ce);const ge=a.plugin.isParsed();te(ge?void 0:new Error(`RTL Text Plugin failed to import scripts from ${ce}`),ge)}}catch(ce){te(ce.toString())}}getAvailableImages(F){let j=this.availableImages[F];return j||(j=[]),j}getLayerIndex(F){let j=this.layerIndexes[F];return j||(j=this.layerIndexes[F]=new O),j}getWorkerSource(F,j,te){if(this.workerSources[F]||(this.workerSources[F]={}),this.workerSources[F][j]||(this.workerSources[F][j]={}),!this.workerSources[F][j][te]){const ce={send:(ge,Ae,Te,xe,Se,Ge)=>{this.actor.send(ge,Ae,Te,F,Se,Ge)},scheduler:this.actor.scheduler};this.workerSources[F][j][te]=new this.workerSourceTypes[j](ce,this.getLayerIndex(F),this.getAvailableImages(F),this.isSpriteLoaded[F])}return this.workerSources[F][j][te]}getDEMWorkerSource(F,j){return this.demWorkerSources[F]||(this.demWorkerSources[F]={}),this.demWorkerSources[F][j]||(this.demWorkerSources[F][j]=new R),this.demWorkerSources[F][j]}enforceCacheSizeLimit(F,j){a.enforceCacheSizeLimit(j)}getWorkerPerformanceMetrics(F,j,te){te(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new is(self)),is}),f(["./shared"],function(a){function E(p,o){if(Array.isArray(p)){if(!Array.isArray(o)||p.length!==o.length)return!1;for(let h=0;h<p.length;h++)if(!E(p[h],o[h]))return!1;return!0}if(typeof p=="object"&&p!==null&&o!==null){if(typeof o!="object"||Object.keys(p).length!==Object.keys(o).length)return!1;for(const h in p)if(!E(p[h],o[h]))return!1;return!0}return p===o}var I=O;function O(p){return!function(o){return typeof window>"u"||typeof document>"u"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var g,x,b=new Blob([""],{type:"text/javascript"}),A=URL.createObjectURL(b);try{x=new Worker(A),g=!0}catch{g=!1}return x&&x.terminate(),URL.revokeObjectURL(A),g}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var g=document.createElement("canvas");g.width=g.height=1;var x=g.getContext("2d");if(!x)return!1;var b=x.getImageData(0,0,1,1);return b&&b.width===g.width}()?(R[h=o&&o.failIfMajorPerformanceCaveat]===void 0&&(R[h]=function(g){var x,b=function(A){var M=document.createElement("canvas"),P=Object.create(O.webGLContextAttributes);return P.failIfMajorPerformanceCaveat=A,M.getContext("webgl",P)||M.getContext("experimental-webgl",P)}(g);if(!b)return!1;try{x=b.createShader(b.VERTEX_SHADER)}catch{return!1}return!(!x||b.isContextLost())&&(b.shaderSource(x,"void main() {}"),b.compileShader(x),b.getShaderParameter(x,b.COMPILE_STATUS)===!0)}(h)),R[h]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var h}(p)}var R={};function N(p,o,h){const g=a.window.document.createElement(p);return o!==void 0&&(g.className=o),h&&h.appendChild(g),g}function H(p,o,h){const g=a.window.document.createElementNS("http://www.w3.org/2000/svg",p);for(const x of Object.keys(o))g.setAttributeNS(null,x,o[x]);return h&&h.appendChild(g),g}O.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const re=a.window.document&&a.window.document.documentElement.style,ae=re&&re.userSelect!==void 0?"userSelect":"WebkitUserSelect";let be;function De(){re&&ae&&(be=re[ae],re[ae]="none")}function Oe(){re&&ae&&(re[ae]=be)}function Ce(p){p.preventDefault(),p.stopPropagation(),a.window.removeEventListener("click",Ce,!0)}function Ve(){a.window.addEventListener("click",Ce,!0),a.window.setTimeout(()=>{a.window.removeEventListener("click",Ce,!0)},0)}function Ee(p,o){const h=p.getBoundingClientRect();return kt(p,h,o)}function dt(p,o){const h=p.getBoundingClientRect(),g=[];for(let x=0;x<o.length;x++)g.push(kt(p,h,o[x]));return g}function wt(p){return a.window.InstallTrigger!==void 0&&p.button===2&&p.ctrlKey&&a.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:p.button}function kt(p,o,h){const g=p.offsetWidth===o.width?1:p.offsetWidth/o.width;return new a.pointGeometry((h.clientX-o.left)*g,(h.clientY-o.top)*g)}function et(p,o){var h=o[0],g=o[1],x=o[2],b=o[3],A=h*b-x*g;return A?(p[0]=b*(A=1/A),p[1]=-g*A,p[2]=-x*A,p[3]=h*A,p):null}function Tt(p){const{userImage:o}=p;return!!(o&&o.render&&o.render())&&(p.data.replace(new Uint8Array(o.data.buffer)),!0)}class ut extends a.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new a.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(o){if(this.loaded!==o&&(this.loaded=o,o)){for(const{ids:h,callback:g}of this.requestors)this._notify(h,g);this.requestors=[]}}hasImage(o){return!!this.getImage(o)}getImage(o){return this.images[o]}addImage(o,h){this._validate(o,h)&&(this.images[o]=h)}_validate(o,h){let g=!0;return this._validateStretch(h.stretchX,h.data&&h.data.width)||(this.fire(new a.ErrorEvent(new Error(`Image "${o}" has invalid "stretchX" value`))),g=!1),this._validateStretch(h.stretchY,h.data&&h.data.height)||(this.fire(new a.ErrorEvent(new Error(`Image "${o}" has invalid "stretchY" value`))),g=!1),this._validateContent(h.content,h)||(this.fire(new a.ErrorEvent(new Error(`Image "${o}" has invalid "content" value`))),g=!1),g}_validateStretch(o,h){if(!o)return!0;let g=0;for(const x of o){if(x[0]<g||x[1]<x[0]||h<x[1])return!1;g=x[1]}return!0}_validateContent(o,h){return!(o&&(o.length!==4||o[0]<0||h.data.width<o[0]||o[1]<0||h.data.height<o[1]||o[2]<0||h.data.width<o[2]||o[3]<0||h.data.height<o[3]||o[2]<o[0]||o[3]<o[1]))}updateImage(o,h){h.version=this.images[o].version+1,this.images[o]=h,this.updatedImages[o]=!0}removeImage(o){const h=this.images[o];delete this.images[o],delete this.patterns[o],h.userImage&&h.userImage.onRemove&&h.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(o,h){let g=!0;if(!this.isLoaded())for(const x of o)this.images[x]||(g=!1);this.isLoaded()||g?this._notify(o,h):this.requestors.push({ids:o,callback:h})}_notify(o,h){const g={};for(const x of o){this.images[x]||this.fire(new a.Event("styleimagemissing",{id:x}));const b=this.images[x];b?g[x]={data:b.data.clone(),pixelRatio:b.pixelRatio,sdf:b.sdf,version:b.version,stretchX:b.stretchX,stretchY:b.stretchY,content:b.content,hasRenderCallback:Boolean(b.userImage&&b.userImage.render)}:a.warnOnce(`Image "${x}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}h(null,g)}getPixelSize(){const{width:o,height:h}=this.atlasImage;return{width:o,height:h}}getPattern(o){const h=this.patterns[o],g=this.getImage(o);if(!g)return null;if(h&&h.position.version===g.version)return h.position;if(h)h.position.version=g.version;else{const x={w:g.data.width+2,h:g.data.height+2,x:0,y:0},b=new a.ImagePosition(x,g);this.patterns[o]={bin:x,position:b}}return this._updatePatternAtlas(),this.patterns[o].position}bind(o){const h=o.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new a.Texture(o,this.atlasImage,h.RGBA),this.atlasTexture.bind(h.LINEAR,h.CLAMP_TO_EDGE)}_updatePatternAtlas(){const o=[];for(const b in this.patterns)o.push(this.patterns[b].bin);const{w:h,h:g}=a.potpack(o),x=this.atlasImage;x.resize({width:h||1,height:g||1});for(const b in this.patterns){const{bin:A}=this.patterns[b],M=A.x+1,P=A.y+1,k=this.images[b].data,D=k.width,U=k.height;a.RGBAImage.copy(k,x,{x:0,y:0},{x:M,y:P},{width:D,height:U}),a.RGBAImage.copy(k,x,{x:0,y:U-1},{x:M,y:P-1},{width:D,height:1}),a.RGBAImage.copy(k,x,{x:0,y:0},{x:M,y:P+U},{width:D,height:1}),a.RGBAImage.copy(k,x,{x:D-1,y:0},{x:M-1,y:P},{width:1,height:U}),a.RGBAImage.copy(k,x,{x:0,y:0},{x:M+D,y:P},{width:1,height:U})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(o){for(const h of o){if(this.callbackDispatchedThisFrame[h])continue;this.callbackDispatchedThisFrame[h]=!0;const g=this.images[h];Tt(g)&&this.updateImage(h,g)}}}const si=new a.Properties({anchor:new a.DataConstantProperty(a.spec.light.anchor),position:new class{constructor(){this.specification=a.spec.light.position}possiblyEvaluate(p,o){return function([h,g,x]){const b=a.degToRad(g+90),A=a.degToRad(x);return{x:h*Math.cos(b)*Math.sin(A),y:h*Math.sin(b)*Math.sin(A),z:h*Math.cos(A),azimuthal:g,polar:x}}(p.expression.evaluate(o))}interpolate(p,o,h){return{x:a.number(p.x,o.x,h),y:a.number(p.y,o.y,h),z:a.number(p.z,o.z,h),azimuthal:a.number(p.azimuthal,o.azimuthal,h),polar:a.number(p.polar,o.polar,h)}}},color:new a.DataConstantProperty(a.spec.light.color),intensity:new a.DataConstantProperty(a.spec.light.intensity)}),ti="-transition";class Zt extends a.Evented{constructor(o){super(),this._transitionable=new a.Transitionable(si),this.setLight(o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(o,h={}){if(!this._validate(a.validateLight,o,h))for(const g in o){const x=o[g];a.endsWith(g,ti)?this._transitionable.setTransition(g.slice(0,-ti.length),x):this._transitionable.setValue(g,x)}}updateTransitions(o){this._transitioning=this._transitionable.transitioned(o,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(o){this.properties=this._transitioning.possiblyEvaluate(o)}_validate(o,h,g){return(!g||g.validate!==!1)&&a.emitValidationErrors(this,o.call(a.validateStyle,a.extend({value:h,style:{glyphs:!0,sprite:!0},styleSpec:a.spec})))}}const Lt=new a.Properties({source:new a.DataConstantProperty(a.spec.terrain.source),exaggeration:new a.DataConstantProperty(a.spec.terrain.exaggeration)}),An="-transition";class fn extends a.Evented{constructor(o,h){super(),this._transitionable=new a.Transitionable(Lt),this.set(o),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=h}get(){return this._transitionable.serialize()}set(o){for(const h in o){const g=o[h];a.endsWith(h,An)?this._transitionable.setTransition(h.slice(0,-An.length),g):this._transitionable.setValue(h,g)}}updateTransitions(o){this._transitioning=this._transitionable.transitioned(o,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(o){this.properties=this._transitioning.possiblyEvaluate(o)}}function pn(p,o,h,g){const x=a.smoothstep(45,65,h),[b,A]=Gi(p,g),M=a.length(o);let P=1-Math.min(1,Math.exp((M-b)/(A-b)*-6));return P*=P*P,P=Math.min(1,1.00747*P),P*x*p.alpha}function Gi(p,o){const h=.5/Math.tan(.5*o);return[p.range[0]+h,p.range[1]+h]}const ni=new a.Properties({range:new a.DataConstantProperty(a.spec.fog.range),color:new a.DataConstantProperty(a.spec.fog.color),"high-color":new a.DataConstantProperty(a.spec.fog["high-color"]),"space-color":new a.DataConstantProperty(a.spec.fog["space-color"]),"horizon-blend":new a.DataConstantProperty(a.spec.fog["horizon-blend"]),"star-intensity":new a.DataConstantProperty(a.spec.fog["star-intensity"])}),Hr="-transition";class ur extends a.Evented{constructor(o,h){super(),this._transitionable=new a.Transitionable(ni),this.set(o),this._transitioning=this._transitionable.untransitioned(),this._transform=h}get state(){const o=this._transform,h=o.projection.name==="globe",g=a.globeToMercatorTransition(o.zoom),x=this.properties.get("range"),b=[.5,3];return{range:h?[a.number(b[0],x[0],g),a.number(b[1],x[1],g)]:x,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(o,h={}){if(!this._validate(a.validateFog,o,h)){for(const g of Object.keys(a.spec.fog))o&&o[g]===void 0&&(o[g]=a.spec.fog[g].default);for(const g in o){const x=o[g];a.endsWith(g,Hr)?this._transitionable.setTransition(g.slice(0,-Hr.length),x):this._transitionable.setValue(g,x)}}}getOpacity(o){if(!this._transform.projection.supportsFog)return 0;const h=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:a.smoothstep(45,65,o))*h.a}getOpacityAtLatLng(o,h){return this._transform.projection.supportsFog?function(g,x,b){const A=a.MercatorCoordinate.fromLngLat(x),M=b.elevation?b.elevation.getAtPointOrZero(A):0,P=[A.x,A.y,M];return a.transformMat4(P,P,b.mercatorFogMatrix),pn(g,P,b.pitch,b._fov)}(this.state,o,h):0}getFovAdjustedRange(o){return this._transform.projection.supportsFog?Gi(this.state,o):[0,1]}updateTransitions(o){this._transitioning=this._transitionable.transitioned(o,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(o){this.properties=this._transitioning.possiblyEvaluate(o)}_validate(o,h,g){return(!g||g.validate!==!1)&&a.emitValidationErrors(this,o.call(a.validateStyle,a.extend({value:h,style:{glyphs:!0,sprite:!0},styleSpec:a.spec})))}}class Ki{constructor(o,h){this.workerPool=o,this.actors=[],this.currentActor=0,this.id=a.uniqueId();const g=this.workerPool.acquire(this.id);for(let x=0;x<g.length;x++){const b=new Ki.Actor(g[x],h,this.id);b.name=`Worker ${x}`,this.actors.push(b)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(o,h,g){a.asyncAll(this.actors,(x,b)=>{x.send(o,h,b)},g=g||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(o=>{o.remove()}),this.actors=[],this.workerPool.release(this.id)}}function $i(p,o,h){return o*(a.EXTENT/(p.tileSize*Math.pow(2,h-p.tileID.overscaledZ)))}Ki.Actor=a.Actor;class Xr{constructor(o,h,g,x){this.screenBounds=o,this.cameraPoint=h,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=g,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,x)}static createFromScreenPoints(o,h){let g,x;if(o instanceof a.pointGeometry||typeof o[0]=="number"){const b=a.pointGeometry.convert(o);g=[b],x=h.isPointAboveHorizon(b)}else{const b=a.pointGeometry.convert(o[0]),A=a.pointGeometry.convert(o[1]);g=[b,A],x=a.polygonizeBounds(b,A).every(M=>h.isPointAboveHorizon(M))}return new Xr(g,h.getCameraPoint(),x,h)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(o){return a.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],o)}bufferedCameraGeometry(o){const h=this.screenBounds[0],g=this.screenBounds.length===1?this.screenBounds[0].add(new a.pointGeometry(1,1)):this.screenBounds[1],x=a.polygonizeBounds(h,g,0,!1);return this.cameraPoint.y>g.y&&(this.cameraPoint.x>h.x&&this.cameraPoint.x<g.x?x.splice(3,0,this.cameraPoint):this.cameraPoint.x>=g.x?x[2]=this.cameraPoint:this.cameraPoint.x<=h.x&&(x[3]=this.cameraPoint)),a.bufferConvexPolygon(x,o)}bufferedCameraGeometryGlobe(o){const h=this.screenBounds[0],g=this.screenBounds.length===1?this.screenBounds[0].add(new a.pointGeometry(1,1)):this.screenBounds[1],x=a.polygonizeBounds(h,g,o),b=this.cameraPoint.clone();switch(3*((b.y>h.y)+(b.y>g.y))+((b.x>h.x)+(b.x>g.x))){case 0:x[0]=b,x[4]=b.clone();break;case 1:x.splice(1,0,b);break;case 2:x[1]=b;break;case 3:x.splice(4,0,b);break;case 5:x.splice(2,0,b);break;case 6:x[3]=b;break;case 7:x.splice(3,0,b);break;case 8:x[2]=b}return x}containsTile(o,h,g,x=0){const b=o.queryPadding/h._pixelsPerMercatorPixel+1,A=g?this._bufferedCameraMercator(b,h):this._bufferedScreenMercator(b,h);let M=o.tileID.wrap+(A.unwrapped?x:0);const P=A.polygon.map(Y=>a.getTilePoint(o.tileTransform,Y,M));if(!a.polygonIntersectsBox(P,0,0,a.EXTENT,a.EXTENT))return;M=o.tileID.wrap+(this.screenGeometryMercator.unwrapped?x:0);const k=this.screenGeometryMercator.polygon.map(Y=>a.getTileVec3(o.tileTransform,Y,M)),D=k.map(Y=>new a.pointGeometry(Y[0],Y[1])),U=h.getFreeCameraOptions().position||new a.MercatorCoordinate(0,0,0),W=a.getTileVec3(o.tileTransform,U,M),J=k.map(Y=>{const q=a.sub(Y,Y,W);return a.normalize(q,q),new a.Ray(W,q)}),X=$i(o,1,h.zoom)*h._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:D,tilespaceRays:J,bufferedTilespaceGeometry:P,bufferedTilespaceBounds:(ee=a.getBounds(P),ee.min.x=a.clamp(ee.min.x,0,a.EXTENT),ee.min.y=a.clamp(ee.min.y,0,a.EXTENT),ee.max.x=a.clamp(ee.max.x,0,a.EXTENT),ee.max.y=a.clamp(ee.max.y,0,a.EXTENT),ee),tile:o,tileID:o.tileID,pixelToTileUnitsFactor:X};var ee}_bufferedScreenMercator(o,h){const g=Si(o);if(this._screenRaycastCache[g])return this._screenRaycastCache[g];{let x;return x=h.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(o),h):{polygon:this.bufferedScreenGeometry(o).map(b=>h.pointCoordinate3D(b)),unwrapped:!0},this._screenRaycastCache[g]=x,x}}_bufferedCameraMercator(o,h){const g=Si(o);if(this._cameraRaycastCache[g])return this._cameraRaycastCache[g];{let x;return x=h.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(o),h):{polygon:this.bufferedCameraGeometry(o).map(b=>h.pointCoordinate3D(b)),unwrapped:!0},this._cameraRaycastCache[g]=x,x}}_projectAndResample(o,h){const g=function(b,A){const M=a.multiply([],A.pixelMatrix,A.globeMatrix),P=[0,-a.GLOBE_RADIUS,0,1],k=[0,a.GLOBE_RADIUS,0,1],D=[0,0,0,1];a.transformMat4$1(P,P,M),a.transformMat4$1(k,k,M),a.transformMat4$1(D,D,M);const U=new a.pointGeometry(P[0]/P[3],P[1]/P[3]),W=new a.pointGeometry(k[0]/k[3],k[1]/k[3]),J=a.polygonContainsPoint(b,U)&&P[3]<D[3],X=a.polygonContainsPoint(b,W)&&k[3]<D[3];if(!J&&!X)return null;const ee=function(me,Pe,ze){for(let ke=1;ke<me.length;ke++){const Ke=Ai(Pe.pointCoordinate3D(me[ke-1]).x),we=Ai(Pe.pointCoordinate3D(me[ke]).x);if(ze<0){if(Ke<we)return{idx:ke,t:-Ke/(we-1-Ke)}}else if(we<Ke)return{idx:ke,t:(1-Ke)/(we+1-Ke)}}return null}(b,A,J?-1:1);if(!ee)return null;const{idx:Y,t:q}=ee;let ie=Y>1?Jn(b.slice(0,Y),A):[],K=Y<b.length?Jn(b.slice(Y),A):[];ie=ie.map(me=>new a.pointGeometry(Ai(me.x),me.y)),K=K.map(me=>new a.pointGeometry(Ai(me.x),me.y));const he=[...ie];he.length===0&&he.push(K[K.length-1]);const fe=a.number(he[he.length-1].y,(K.length===0?ie[0]:K[0]).y,q);let le;return le=J?[new a.pointGeometry(0,fe),new a.pointGeometry(0,0),new a.pointGeometry(1,0),new a.pointGeometry(1,fe)]:[new a.pointGeometry(1,fe),new a.pointGeometry(1,1),new a.pointGeometry(0,1),new a.pointGeometry(0,fe)],he.push(...le),K.length===0?he.push(ie[0]):he.push(...K),{polygon:he.map(me=>new a.MercatorCoordinate(me.x,me.y)),unwrapped:!1}}(o,h);if(g)return g;const x=function(b,A){let M=!1,P=-1/0,k=0;for(let U=0;U<b.length-1;U++)b[U].x>P&&(P=b[U].x,k=U);for(let U=0;U<b.length-1;U++){const W=(k+U)%(b.length-1),J=b[W],X=b[W+1];Math.abs(J.x-X.x)>.5&&(J.x<X.x?(J.x+=1,W===0&&(b[b.length-1].x+=1)):(X.x+=1,W+1===b.length-1&&(b[0].x+=1)),M=!0)}const D=a.mercatorXfromLng(A.center.lng);return M&&D<Math.abs(D-1)&&b.forEach(U=>{U.x-=1}),{polygon:b,unwrapped:M}}(Jn(o,h).map(b=>new a.pointGeometry(Ai(b.x),b.y)),h);return{polygon:x.polygon.map(b=>new a.MercatorCoordinate(b.x,b.y)),unwrapped:x.unwrapped}}}function Jn(p,o){return a.resample(p,h=>{const g=o.pointCoordinate3D(h);h.x=g.x,h.y=g.y},1/256)}function Ai(p){return p<0?1+p%1:p%1}function Si(p){return 100*p|0}function oi(p,o,h,g,x){const b=function(A,M){if(A)return x(A);if(M){p.url&&M.tiles&&p.tiles&&delete p.tiles;const P=a.pick(a.extend(M,p),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);M.vector_layers&&(P.vectorLayers=M.vector_layers,P.vectorLayerIds=P.vectorLayers.map(k=>k.id)),P.tiles=o.canonicalizeTileset(P,p.url),x(null,P)}};return p.url?a.getJSON(o.transformRequest(o.normalizeSourceURL(p.url,null,h,g),a.ResourceType.Source),b):a.exported.frame(()=>b(null,p))}class yi{constructor(o,h,g){this.bounds=a.LngLatBounds.convert(this.validateBounds(o)),this.minzoom=h||0,this.maxzoom=g||24}validateBounds(o){return Array.isArray(o)&&o.length===4?[Math.max(-180,o[0]),Math.max(-90,o[1]),Math.min(180,o[2]),Math.min(90,o[3])]:[-180,-90,180,90]}contains(o){const h=Math.pow(2,o.z),g=Math.floor(a.mercatorXfromLng(this.bounds.getWest())*h),x=Math.floor(a.mercatorYfromLat(this.bounds.getNorth())*h),b=Math.ceil(a.mercatorXfromLng(this.bounds.getEast())*h),A=Math.ceil(a.mercatorYfromLat(this.bounds.getSouth())*h);return o.x>=g&&o.x<b&&o.y>=x&&o.y<A}}class hr{constructor(o,h,g){this.context=o;const x=o.gl;this.buffer=x.createBuffer(),this.dynamicDraw=Boolean(g),this.context.unbindVAO(),o.bindElementBuffer.set(this.buffer),x.bufferData(x.ELEMENT_ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?x.DYNAMIC_DRAW:x.STATIC_DRAW),this.dynamicDraw||h.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(o){const h=this.context.gl;this.context.unbindVAO(),this.bind(),h.bufferSubData(h.ELEMENT_ARRAY_BUFFER,0,o.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const fi={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class mn{constructor(o,h,g,x){this.length=h.length,this.attributes=g,this.itemSize=h.bytesPerElement,this.dynamicDraw=x,this.context=o;const b=o.gl;this.buffer=b.createBuffer(),o.bindVertexBuffer.set(this.buffer),b.bufferData(b.ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||h.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(o){const h=this.context.gl;this.bind(),h.bufferSubData(h.ARRAY_BUFFER,0,o.arrayBuffer)}enableAttributes(o,h){for(let g=0;g<this.attributes.length;g++){const x=h.attributes[this.attributes[g].name];x!==void 0&&o.enableVertexAttribArray(x)}}setVertexAttribPointers(o,h,g){for(let x=0;x<this.attributes.length;x++){const b=this.attributes[x],A=h.attributes[b.name];A!==void 0&&o.vertexAttribPointer(A,b.components,o[fi[b.type]],!1,this.itemSize,b.offset+this.itemSize*(g||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Kt{constructor(o){this.gl=o.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(o){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class gn extends Kt{getDefault(){return a.Color.transparent}set(o){const h=this.current;(o.r!==h.r||o.g!==h.g||o.b!==h.b||o.a!==h.a||this.dirty)&&(this.gl.clearColor(o.r,o.g,o.b,o.a),this.current=o,this.dirty=!1)}}class _n extends Kt{getDefault(){return 1}set(o){(o!==this.current||this.dirty)&&(this.gl.clearDepth(o),this.current=o,this.dirty=!1)}}class tn extends Kt{getDefault(){return 0}set(o){(o!==this.current||this.dirty)&&(this.gl.clearStencil(o),this.current=o,this.dirty=!1)}}class dr extends Kt{getDefault(){return[!0,!0,!0,!0]}set(o){const h=this.current;(o[0]!==h[0]||o[1]!==h[1]||o[2]!==h[2]||o[3]!==h[3]||this.dirty)&&(this.gl.colorMask(o[0],o[1],o[2],o[3]),this.current=o,this.dirty=!1)}}class wr extends Kt{getDefault(){return!0}set(o){(o!==this.current||this.dirty)&&(this.gl.depthMask(o),this.current=o,this.dirty=!1)}}class Gn extends Kt{getDefault(){return 255}set(o){(o!==this.current||this.dirty)&&(this.gl.stencilMask(o),this.current=o,this.dirty=!1)}}class Ji extends Kt{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(o){const h=this.current;(o.func!==h.func||o.ref!==h.ref||o.mask!==h.mask||this.dirty)&&(this.gl.stencilFunc(o.func,o.ref,o.mask),this.current=o,this.dirty=!1)}}class Qi extends Kt{getDefault(){const o=this.gl;return[o.KEEP,o.KEEP,o.KEEP]}set(o){const h=this.current;(o[0]!==h[0]||o[1]!==h[1]||o[2]!==h[2]||this.dirty)&&(this.gl.stencilOp(o[0],o[1],o[2]),this.current=o,this.dirty=!1)}}class Qn extends Kt{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;o?h.enable(h.STENCIL_TEST):h.disable(h.STENCIL_TEST),this.current=o,this.dirty=!1}}class Sn extends Kt{getDefault(){return[0,1]}set(o){const h=this.current;(o[0]!==h[0]||o[1]!==h[1]||this.dirty)&&(this.gl.depthRange(o[0],o[1]),this.current=o,this.dirty=!1)}}class Yr extends Kt{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;o?h.enable(h.DEPTH_TEST):h.disable(h.DEPTH_TEST),this.current=o,this.dirty=!1}}class Kr extends Kt{getDefault(){return this.gl.LESS}set(o){(o!==this.current||this.dirty)&&(this.gl.depthFunc(o),this.current=o,this.dirty=!1)}}class fr extends Kt{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;o?h.enable(h.BLEND):h.disable(h.BLEND),this.current=o,this.dirty=!1}}class Wi extends Kt{getDefault(){const o=this.gl;return[o.ONE,o.ZERO]}set(o){const h=this.current;(o[0]!==h[0]||o[1]!==h[1]||this.dirty)&&(this.gl.blendFunc(o[0],o[1]),this.current=o,this.dirty=!1)}}class Ir extends Kt{getDefault(){return a.Color.transparent}set(o){const h=this.current;(o.r!==h.r||o.g!==h.g||o.b!==h.b||o.a!==h.a||this.dirty)&&(this.gl.blendColor(o.r,o.g,o.b,o.a),this.current=o,this.dirty=!1)}}class yn extends Kt{getDefault(){return this.gl.FUNC_ADD}set(o){(o!==this.current||this.dirty)&&(this.gl.blendEquation(o),this.current=o,this.dirty=!1)}}class Mn extends Kt{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;o?h.enable(h.CULL_FACE):h.disable(h.CULL_FACE),this.current=o,this.dirty=!1}}class Pn extends Kt{getDefault(){return this.gl.BACK}set(o){(o!==this.current||this.dirty)&&(this.gl.cullFace(o),this.current=o,this.dirty=!1)}}class er extends Kt{getDefault(){return this.gl.CCW}set(o){(o!==this.current||this.dirty)&&(this.gl.frontFace(o),this.current=o,this.dirty=!1)}}class an extends Kt{getDefault(){return null}set(o){(o!==this.current||this.dirty)&&(this.gl.useProgram(o),this.current=o,this.dirty=!1)}}class xs extends Kt{getDefault(){return this.gl.TEXTURE0}set(o){(o!==this.current||this.dirty)&&(this.gl.activeTexture(o),this.current=o,this.dirty=!1)}}class Fs extends Kt{getDefault(){const o=this.gl;return[0,0,o.drawingBufferWidth,o.drawingBufferHeight]}set(o){const h=this.current;(o[0]!==h[0]||o[1]!==h[1]||o[2]!==h[2]||o[3]!==h[3]||this.dirty)&&(this.gl.viewport(o[0],o[1],o[2],o[3]),this.current=o,this.dirty=!1)}}class Jr extends Kt{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;h.bindFramebuffer(h.FRAMEBUFFER,o),this.current=o,this.dirty=!1}}class Wn extends Kt{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;h.bindRenderbuffer(h.RENDERBUFFER,o),this.current=o,this.dirty=!1}}class Qr extends Kt{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;h.bindTexture(h.TEXTURE_2D,o),this.current=o,this.dirty=!1}}class es extends Kt{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;h.bindBuffer(h.ARRAY_BUFFER,o),this.current=o,this.dirty=!1}}class Bn extends Kt{getDefault(){return null}set(o){const h=this.gl;h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,o),this.current=o,this.dirty=!1}}class Cr extends Kt{constructor(o){super(o),this.vao=o.extVertexArrayObject}getDefault(){return null}set(o){this.vao&&(o!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(o),this.current=o,this.dirty=!1)}}class ts extends Kt{getDefault(){return 4}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;h.pixelStorei(h.UNPACK_ALIGNMENT,o),this.current=o,this.dirty=!1}}class Lr extends Kt{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o),this.current=o,this.dirty=!1}}class kr extends Kt{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const h=this.gl;h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,o),this.current=o,this.dirty=!1}}class Tn extends Kt{constructor(o,h){super(o),this.context=o,this.parent=h}getDefault(){return null}}class pr extends Tn{setDirty(){this.dirty=!0}set(o){if(o===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const h=this.gl;h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,o,0),this.current=o,this.dirty=!1}}class vs extends Tn{attachment(){return this.gl.DEPTH_ATTACHMENT}set(o){if(o===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const h=this.gl;h.framebufferRenderbuffer(h.FRAMEBUFFER,this.attachment(),h.RENDERBUFFER,o),this.current=o,this.dirty=!1}}class is extends vs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class ne{constructor(o,h,g,x){this.context=o,this.width=h,this.height=g;const b=this.framebuffer=o.gl.createFramebuffer();this.colorAttachment=new pr(o,b),x&&(this.depthAttachment=new vs(o,b))}destroy(){const o=this.context.gl,h=this.colorAttachment.get();if(h&&o.deleteTexture(h),this.depthAttachment){const g=this.depthAttachment.get();g&&o.deleteRenderbuffer(g)}o.deleteFramebuffer(this.framebuffer)}}class F{constructor(o){this.gl=o,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new gn(this),this.clearDepth=new _n(this),this.clearStencil=new tn(this),this.colorMask=new dr(this),this.depthMask=new wr(this),this.stencilMask=new Gn(this),this.stencilFunc=new Ji(this),this.stencilOp=new Qi(this),this.stencilTest=new Qn(this),this.depthRange=new Sn(this),this.depthTest=new Yr(this),this.depthFunc=new Kr(this),this.blend=new fr(this),this.blendFunc=new Wi(this),this.blendColor=new Ir(this),this.blendEquation=new yn(this),this.cullFace=new Mn(this),this.cullFaceSide=new Pn(this),this.frontFace=new er(this),this.program=new an(this),this.activeTexture=new xs(this),this.viewport=new Fs(this),this.bindFramebuffer=new Jr(this),this.bindRenderbuffer=new Wn(this),this.bindTexture=new Qr(this),this.bindVertexBuffer=new es(this),this.bindElementBuffer=new Bn(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new Cr(this),this.pixelStoreUnpack=new ts(this),this.pixelStoreUnpackPremultiplyAlpha=new Lr(this),this.pixelStoreUnpackFlipY=new kr(this),this.extTextureFilterAnisotropic=o.getExtension("EXT_texture_filter_anisotropic")||o.getExtension("MOZ_EXT_texture_filter_anisotropic")||o.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=o.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extStandardDerivativesForceOff=!1,this.extDebugRendererInfo=o.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=o.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=o.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.extTextureHalfFloat=o.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(o.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=o.getExtension("EXT_color_buffer_half_float")),this.extStandardDerivatives=o.getExtension("OES_standard_derivatives"),this.extTimerQuery=o.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=o.getParameter(o.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(o,h){return new hr(this,o,h)}createVertexBuffer(o,h,g){return new mn(this,o,h,g)}createRenderbuffer(o,h,g){const x=this.gl,b=x.createRenderbuffer();return this.bindRenderbuffer.set(b),x.renderbufferStorage(x.RENDERBUFFER,o,h,g),this.bindRenderbuffer.set(null),b}createFramebuffer(o,h,g){return new ne(this,o,h,g)}clear({color:o,depth:h,stencil:g}){const x=this.gl;let b=0;o&&(b|=x.COLOR_BUFFER_BIT,this.clearColor.set(o),this.colorMask.set([!0,!0,!0,!0])),h!==void 0&&(b|=x.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(h),this.depthMask.set(!0)),g!==void 0&&(b|=x.STENCIL_BUFFER_BIT,this.clearStencil.set(g),this.stencilMask.set(255)),x.clear(b)}setCullFace(o){o.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(o.mode),this.frontFace.set(o.frontFace))}setDepthMode(o){o.func!==this.gl.ALWAYS||o.mask?(this.depthTest.set(!0),this.depthFunc.set(o.func),this.depthMask.set(o.mask),this.depthRange.set(o.range)):this.depthTest.set(!1)}setStencilMode(o){o.test.func!==this.gl.ALWAYS||o.mask?(this.stencilTest.set(!0),this.stencilMask.set(o.mask),this.stencilOp.set([o.fail,o.depthFail,o.pass]),this.stencilFunc.set({func:o.test.func,ref:o.ref,mask:o.test.mask})):this.stencilTest.set(!1)}setColorMode(o){E(o.blendFunction,a.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(o.blendFunction),this.blendColor.set(o.blendColor)),this.colorMask.set(o.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class j extends a.Evented{constructor(o,h,g,x){super(),this.id=o,this.dispatcher=g,this.setEventedParent(x),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=a.extend({type:"raster"},h),a.extend(this,a.pick(h,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=oi(this._options,this.map._requestManager,null,null,(o,h)=>{this._tileJSONRequest=null,this._loaded=!0,o?this.fire(new a.ErrorEvent(o)):h&&(a.extend(this,h),h.bounds&&(this.tileBounds=new yi(h.bounds,this.minzoom,this.maxzoom)),a.postTurnstileEvent(h.tiles),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(o){this.map=o,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return a.extend({},this._options)}hasTile(o){return!this.tileBounds||this.tileBounds.contains(o.canonical)}loadTile(o,h){const g=a.exported.devicePixelRatio>=2,x=this.map._requestManager.normalizeTileURL(o.tileID.canonical.url(this.tiles,this.scheme),g,this.tileSize);o.request=a.getImage(this.map._requestManager.transformRequest(x,a.ResourceType.Tile),(b,A,M,P)=>(delete o.request,o.aborted?(o.state="unloaded",h(null)):b?(o.state="errored",h(b)):A?(this.map._refreshExpiredTiles&&o.setExpiryData({cacheControl:M,expires:P}),o.setTexture(A,this.map.painter),o.state="loaded",a.cacheEntryPossiblyAdded(this.dispatcher),void h(null)):h(null)))}static loadTileData(o,h,g){o.setTexture(h,g)}static unloadTileData(o,h){o.texture&&h.saveTileTexture(o.texture)}abortTile(o,h){o.request&&(o.request.cancel(),delete o.request),h()}unloadTile(o,h){o.texture&&this.map.painter.saveTileTexture(o.texture),h()}hasTransition(){return!1}}let te;function ce(p,o,h,g,x,b,A,M){const P=[p,h,x,o,g,b,1,1,1],k=[A,M,1],D=a.adjoint([],P),[U,W,J]=a.transformMat3(k,k,a.transpose(D,D));return a.multiply$1(P,[U,0,0,0,W,0,0,0,J],P)}class ge extends a.Evented{constructor(o,h,g,x){super(),this.id=o,this.dispatcher=g,this.coordinates=h.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(x),this.options=h,this._dirty=!1}load(o,h){this._loaded=h||!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this.url=this.options.url,this._imageRequest=a.getImage(this.map._requestManager.transformRequest(this.url,a.ResourceType.Image),(g,x)=>{if(this._imageRequest=null,this._loaded=!0,g)this.fire(new a.ErrorEvent(g));else if(x){const{HTMLImageElement:b}=a.window;this.image=x instanceof b?a.exported.getImageData(x):x,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,o&&(this.coordinates=o),this._finishLoading()}})}loaded(){return this._loaded}updateImage(o){return this.image&&o.url?(this._imageRequest&&o.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=o.url,this.load(o.coordinates,this._loaded),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(o){this.map=o,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),this.texture&&this.texture.destroy()}setCoordinates(o){this.coordinates=o,this._boundsArray=void 0;const h=o.map(a.MercatorCoordinate.fromLngLat);return this.tileID=function(g){let x=1/0,b=1/0,A=-1/0,M=-1/0;for(const U of g)x=Math.min(x,U.x),b=Math.min(b,U.y),A=Math.max(A,U.x),M=Math.max(M,U.y);const P=Math.max(A-x,M-b),k=Math.max(0,Math.floor(-Math.log(P)/Math.LN2)),D=Math.pow(2,k);return new a.CanonicalTileID(k,Math.floor((x+A)/2*D),Math.floor((b+M)/2*D))}(h),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(o){for(const P in this.tiles){const k=this.tiles[P];k.state!=="loaded"&&(k.state="loaded",k.texture=this.texture)}if(this._boundsArray)return;const h=a.tileTransform(this.tileID,this.map.transform.projection),[g,x,b,A]=this.coordinates.map(P=>{const k=h.projection.project(P[0],P[1]);return a.getTilePoint(h,k)._round()});this.perspectiveTransform=function(P,k,D,U,W,J,X,ee,Y,q){const ie=ce(0,0,P,0,0,k,P,k),K=ce(D,U,W,J,X,ee,Y,q);return a.multiply$1(K,a.adjoint(ie,ie),K),[K[6]/K[8]*P/a.EXTENT,K[7]/K[8]*k/a.EXTENT]}(this.width,this.height,g.x,g.y,x.x,x.y,A.x,A.y,b.x,b.y);const M=this._boundsArray=new a.StructArrayLayout4i8;M.emplaceBack(g.x,g.y,0,0),M.emplaceBack(x.x,x.y,a.EXTENT,0),M.emplaceBack(A.x,A.y,0,a.EXTENT),M.emplaceBack(b.x,b.y,a.EXTENT,a.EXTENT),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=o.createVertexBuffer(M,a.boundsAttributes.members),this.boundsSegments=a.SegmentVector.simpleSegment(0,0,4,2)}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const o=this.map.painter.context,h=o.gl;this._dirty&&(this.texture?this.texture.update(this.image):(this.texture=new a.Texture(o,this.image,h.RGBA),this.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE)),this._dirty=!1),this._prepareData(o)}loadTile(o,h){this.tileID&&this.tileID.equals(o.tileID.canonical)?(this.tiles[String(o.tileID.wrap)]=o,o.buckets={},h(null)):(o.state="errored",h(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const Ae={vector:class extends a.Evented{constructor(p,o,h,g){if(super(),this.id=p,this.dispatcher=h,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,a.extend(this,a.pick(o,["url","scheme","tileSize","promoteId"])),this._options=a.extend({type:"vector"},o),this._collectResourceTiming=o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g),this._tileWorkers={},this._deduped=new a.DedupedRequest}load(p){this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"}));const o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,h=this.map._worldview;this._tileJSONRequest=oi(this._options,this.map._requestManager,o,h,(g,x)=>{this._tileJSONRequest=null,this._loaded=!0,g?(o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),h&&h.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${h}`),this.fire(new a.ErrorEvent(g))):x&&(a.extend(this,x),x.bounds&&(this.tileBounds=new yi(x.bounds,this.minzoom,this.maxzoom)),a.postTurnstileEvent(x.tiles,this.map._requestManager._customAccessToken),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"}))),p&&p(g)})}loaded(){return this._loaded}hasTile(p){return!this.tileBounds||this.tileBounds.contains(p.canonical)}onAdd(p){this.map=p,this.load()}reload(){this.cancelTileJSONRequest(),this.load(()=>{const p=this.map.style._getSourceCaches(this.id);for(const o of p)o.clearTiles()})}setSourceProperty(p){p(),this.reload()}setTiles(p){return this._options.tiles=p,this.reload(),this}setUrl(p){return this.url=p,this._options.url=p,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return a.extend({},this._options)}loadTile(p,o){const h=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme)),g={request:this.map._requestManager.transformRequest(h,a.ResourceType.Tile),data:void 0,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,tileSize:this.tileSize*p.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:a.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:p.isSymbolTile};if(g.request.collectResourceTiming=this._collectResourceTiming,p.actor&&p.state!=="expired")p.state==="loading"?p.reloadCallback=o:p.request=p.actor.send("reloadTile",g,x.bind(this));else if(p.actor=this._tileWorkers[h]=this._tileWorkers[h]||this.dispatcher.getActor(),this.dispatcher.ready)p.request=p.actor.send("loadTile",g,x.bind(this),void 0,!0);else{const b=a.loadVectorTile.call({deduped:this._deduped},g,(A,M)=>{A||!M?x.call(this,A):(g.data={cacheControl:M.cacheControl,expires:M.expires,rawData:M.rawData.slice(0)},p.actor&&p.actor.send("loadTile",g,x.bind(this),void 0,!0))},!0);p.request={cancel:b}}function x(b,A){return delete p.request,p.aborted?o(null):b&&b.status!==404?o(b):(A&&A.resourceTiming&&(p.resourceTiming=A.resourceTiming),this.map._refreshExpiredTiles&&A&&p.setExpiryData(A),p.loadVectorData(A,this.map.painter),a.cacheEntryPossiblyAdded(this.dispatcher),o(null),void(p.reloadCallback&&(this.loadTile(p,p.reloadCallback),p.reloadCallback=null)))}}abortTile(p){p.request&&(p.request.cancel(),delete p.request),p.actor&&p.actor.send("abortTile",{uid:p.uid,type:this.type,source:this.id})}unloadTile(p){p.unloadVectorData(),p.actor&&p.actor.send("removeTile",{uid:p.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}},raster:j,"raster-dem":class extends j{constructor(p,o,h,g){super(p,o,h,g),this.type="raster-dem",this.maxzoom=22,this._options=a.extend({type:"raster-dem"},o),this.encoding=o.encoding||"mapbox"}loadTile(p,o){const h=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function g(x,b){x&&(p.state="errored",o(x)),b&&(p.dem=b,p.dem.onDeserialize(),p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0,p.state="loaded",o(null))}p.request=a.getImage(this.map._requestManager.transformRequest(h,a.ResourceType.Tile),function(x,b,A,M){if(delete p.request,p.aborted)p.state="unloaded",o(null);else if(x)p.state="errored",o(x);else if(b){this.map._refreshExpiredTiles&&p.setExpiryData({cacheControl:A,expires:M});const P=a.window.ImageBitmap&&b instanceof a.window.ImageBitmap&&(te==null&&(te=a.window.OffscreenCanvas&&new a.window.OffscreenCanvas(1,1).getContext("2d")&&typeof a.window.createImageBitmap=="function"),te),k=1-(b.width-a.prevPowerOfTwo(b.width))/2;k<1||p.neighboringTiles||(p.neighboringTiles=this._getNeighboringTiles(p.tileID));const D=P?b:a.exported.getImageData(b,k),U={uid:p.uid,coord:p.tileID,source:this.id,rawImageData:D,encoding:this.encoding,padding:k};p.actor&&p.state!=="expired"||(p.actor=this.dispatcher.getActor(),p.actor.send("loadDEMTile",U,g.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(p){const o=p.canonical,h=Math.pow(2,o.z),g=(o.x-1+h)%h,x=o.x===0?p.wrap-1:p.wrap,b=(o.x+1+h)%h,A=o.x+1===h?p.wrap+1:p.wrap,M={};return M[new a.OverscaledTileID(p.overscaledZ,x,o.z,g,o.y).key]={backfilled:!1},M[new a.OverscaledTileID(p.overscaledZ,A,o.z,b,o.y).key]={backfilled:!1},o.y>0&&(M[new a.OverscaledTileID(p.overscaledZ,x,o.z,g,o.y-1).key]={backfilled:!1},M[new a.OverscaledTileID(p.overscaledZ,p.wrap,o.z,o.x,o.y-1).key]={backfilled:!1},M[new a.OverscaledTileID(p.overscaledZ,A,o.z,b,o.y-1).key]={backfilled:!1}),o.y+1<h&&(M[new a.OverscaledTileID(p.overscaledZ,x,o.z,g,o.y+1).key]={backfilled:!1},M[new a.OverscaledTileID(p.overscaledZ,p.wrap,o.z,o.x,o.y+1).key]={backfilled:!1},M[new a.OverscaledTileID(p.overscaledZ,A,o.z,b,o.y+1).key]={backfilled:!1}),M}unloadTile(p){p.demTexture&&this.map.painter.saveTileTexture(p.demTexture),p.fbo&&(p.fbo.destroy(),delete p.fbo),p.dem&&delete p.dem,delete p.neighboringTiles,p.state="unloaded"}},geojson:class extends a.Evented{constructor(p,o,h,g){super(),this.id=p,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=h.getActor(),this.setEventedParent(g),this._data=o.data,this._options=a.extend({},o),this._collectResourceTiming=o.collectResourceTiming,o.maxzoom!==void 0&&(this.maxzoom=o.maxzoom),o.type&&(this.type=o.type),o.attribution&&(this.attribution=o.attribution),this.promoteId=o.promoteId;const x=a.EXTENT/this.tileSize;this.workerOptions=a.extend({source:this.id,cluster:o.cluster||!1,geojsonVtOptions:{buffer:(o.buffer!==void 0?o.buffer:128)*x,tolerance:(o.tolerance!==void 0?o.tolerance:.375)*x,extent:a.EXTENT,maxZoom:this.maxzoom,lineMetrics:o.lineMetrics||!1,generateId:o.generateId||!1},superclusterOptions:{maxZoom:o.clusterMaxZoom!==void 0?o.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,o.clusterMinPoints||2),extent:a.EXTENT,radius:(o.clusterRadius!==void 0?o.clusterRadius:50)*x,log:!1,generateId:o.generateId||!1},clusterProperties:o.clusterProperties,filter:o.filter},o.workerOptions)}onAdd(p){this.map=p,this.setData(this._data)}setData(p){return this._data=p,this._updateWorkerData(),this}getClusterExpansionZoom(p,o){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:p,source:this.id},o),this}getClusterChildren(p,o){return this.actor.send("geojson.getClusterChildren",{clusterId:p,source:this.id},o),this}getClusterLeaves(p,o,h,g){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:p,limit:o,offset:h},g),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new a.Event("dataloading",{dataType:"source"})),this._loaded=!1;const p=a.extend({},this.workerOptions),o=this._data;typeof o=="string"?(p.request=this.map._requestManager.transformRequest(a.exported.resolveURL(o),a.ResourceType.Source),p.request.collectResourceTiming=this._collectResourceTiming):p.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,p,(h,g)=>{if(this._loaded=!0,this._pendingLoad=null,h)this.fire(new a.ErrorEvent(h));else{const x={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&g&&g.resourceTiming&&g.resourceTiming[this.id]&&(x.resourceTiming=g.resourceTiming[this.id]),this.fire(new a.Event("data",x)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(p,o){const h=p.actor?"reloadTile":"loadTile";p.actor=this.actor,p.request=this.actor.send(h,{type:this.type,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:a.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(g,x)=>(delete p.request,p.unloadVectorData(),p.aborted?o(null):g?o(g):(p.loadVectorData(x,this.map.painter,h==="reloadTile"),o(null))),void 0,h==="loadTile")}abortTile(p){p.request&&(p.request.cancel(),delete p.request),p.aborted=!0}unloadTile(p){p.unloadVectorData(),this.actor.send("removeTile",{uid:p.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return a.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends ge{constructor(p,o,h,g){super(p,o,h,g),this.roundZoom=!0,this.type="video",this.options=o}load(){this._loaded=!1;const p=this.options;this.urls=[];for(const o of p.urls)this.urls.push(this.map._requestManager.transformRequest(o,a.ResourceType.Source).url);a.getVideo(this.urls,(o,h)=>{this._loaded=!0,o?this.fire(new a.ErrorEvent(o)):h&&(this.video=h,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(p){if(this.video){const o=this.video.seekable;p<o.start(0)||p>o.end(0)?this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${o.start(0)} and ${o.end(0)}-second mark.`))):this.video.currentTime=p}}getVideo(){return this.video}onAdd(p){this.map||(this.map=p,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const p=this.map.painter.context,o=p.gl;this.texture?this.video.paused||(this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE),o.texSubImage2D(o.TEXTURE_2D,0,0,0,o.RGBA,o.UNSIGNED_BYTE,this.video)):(this.texture=new a.Texture(p,this.video,o.RGBA),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(p)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:ge,canvas:class extends ge{constructor(p,o,h,g){super(p,o,h,g),o.coordinates?Array.isArray(o.coordinates)&&o.coordinates.length===4&&!o.coordinates.some(x=>!Array.isArray(x)||x.length!==2||x.some(b=>typeof b!="number"))||this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${p}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${p}`,null,'missing required property "coordinates"'))),o.animate&&typeof o.animate!="boolean"&&this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${p}`,null,'optional "animate" property must be a boolean value'))),o.canvas?typeof o.canvas=="string"||o.canvas instanceof a.window.HTMLCanvasElement||this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${p}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${p}`,null,'missing required property "canvas"'))),this.options=o,this.animate=o.animate===void 0||o.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof a.window.HTMLCanvasElement?this.options.canvas:a.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new a.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(p){this.map=p,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let p=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,p=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,p=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const o=this.map.painter.context;this.texture?(p||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new a.Texture(o,this.canvas,o.gl.RGBA,{premultiply:!0}),this._prepareData(o)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const p of[this.canvas.width,this.canvas.height])if(isNaN(p)||p<=0)return!0;return!1}},custom:class extends a.Evented{constructor(p,o,h,g){super(),this.id=p,this.type="custom",this._dataType="raster",this._dispatcher=h,this._implementation=o,this.setEventedParent(g),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new a.ErrorEvent(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new a.ErrorEvent(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new yi(this._implementation.bounds,this.minzoom,this.maxzoom)),o.update=this._update.bind(this),o.clearTiles=this._clearTiles.bind(this),o.coveringTiles=this._coveringTiles.bind(this),a.extend(this,a.pick(o,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return a.pick(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(p){this._map=p,this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(p),this.load()}onRemove(p){this._implementation.onRemove&&this._implementation.onRemove(p)}hasTile(p){if(this._implementation.hasTile){const{x:o,y:h,z:g}=p.canonical;return this._implementation.hasTile({x:o,y:h,z:g})}return!this.tileBounds||this.tileBounds.contains(p.canonical)}loadTile(p,o){const{x:h,y:g,z:x}=p.tileID.canonical,b=new a.window.AbortController;p.request=Promise.resolve(this._implementation.loadTile({x:h,y:g,z:x},{signal:b.signal})).then(function(A){return delete p.request,p.aborted?(p.state="unloaded",o(null)):A===void 0?(p.state="errored",o(null)):A===null?(this.loadTileData(p,{width:this.tileSize,height:this.tileSize,data:null}),p.state="loaded",o(null)):function(M){return M instanceof a.window.ImageData||M instanceof a.window.HTMLCanvasElement||M instanceof a.window.ImageBitmap||M instanceof a.window.HTMLImageElement}(A)?(this.loadTileData(p,A),p.state="loaded",void o(null)):(p.state="errored",o(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch(A=>{A.code!==20&&(p.state="errored",o(A))}),p.request.cancel=()=>b.abort()}loadTileData(p,o){j.loadTileData(p,o,this._map.painter)}unloadTileData(p){j.unloadTileData(p,this._map.painter)}unloadTile(p,o){if(this.unloadTileData(p),this._implementation.unloadTile){const{x:h,y:g,z:x}=p.tileID.canonical;this._implementation.unloadTile({x:h,y:g,z:x})}o()}abortTile(p,o){p.request&&p.request.cancel&&(p.request.cancel(),delete p.request),o()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(p=>({x:p.canonical.x,y:p.canonical.y,z:p.canonical.z}))}_clearTiles(){this._map.style._clearSource(this.id)}_update(){this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"}))}}},Te=function(p,o,h,g){const x=new Ae[o.type](p,o,h,g);if(x.id!==p)throw new Error(`Expected Source id to be ${p} instead of ${x.id}`);return a.bindAll(["load","abort","unload","serialize","prepare"],x),x};function xe(p,o){const h=a.identity([]);return a.scale(h,h,[.5*p.width,.5*-p.height,1]),a.translate(h,h,[1,-1,0]),a.multiply(h,h,p.calculateProjMatrix(o.toUnwrapped())),Float32Array.from(h)}function Se(p,o,h,g,x,b,A,M=!1){const P=p.tilesIn(g,A,M);P.sort(st);const k=[];for(const U of P)k.push({wrappedTileID:U.tile.tileID.wrapped().key,queryResults:U.tile.queryRenderedFeatures(o,h,p._state,U,x,b,xe(p.transform,U.tile.tileID),M)});const D=function(U){const W={},J={};for(const X of U){const ee=X.queryResults,Y=X.wrappedTileID,q=J[Y]=J[Y]||{};for(const ie in ee){const K=ee[ie],he=q[ie]=q[ie]||{},fe=W[ie]=W[ie]||[];for(const le of K)he[le.featureIndex]||(he[le.featureIndex]=!0,fe.push(le))}}return W}(k);for(const U in D)D[U].forEach(W=>{const J=W.feature,X=J.layer;X&&X.type!=="background"&&X.type!=="sky"&&(J.source=X.source,X["source-layer"]&&(J.sourceLayer=X["source-layer"]),J.state=J.id!==void 0?p.getFeatureState(X["source-layer"],J.id):{})});return D}function Ge(p,o){const h=p.getRenderableIds().map(b=>p.getTileByID(b)),g=[],x={};for(let b=0;b<h.length;b++){const A=h[b],M=A.tileID.canonical.key;x[M]||(x[M]=!0,A.querySourceFeatures(g,o))}return g}function st(p,o){const h=p.tileID,g=o.tileID;return h.overscaledZ-g.overscaledZ||h.canonical.y-g.canonical.y||h.wrap-g.wrap||h.canonical.x-g.canonical.x}function Ze(){return Pa.workerClass!=null?new Pa.workerClass:new a.window.Worker(Pa.workerUrl)}const At="mapboxgl_preloaded_worker_pool";class gt{constructor(){this.active={}}acquire(o){if(!this.workers)for(this.workers=[];this.workers.length<gt.workerCount;)this.workers.push(new Ze);return this.active[o]=!0,this.workers.slice()}release(o){delete this.active[o],this.numActive()===0&&(this.workers.forEach(h=>{h.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[At]}numActive(){return Object.keys(this.active).length}}let yt;function Mt(){return yt||(yt=new gt),yt}function Ut(p,o){const h={};for(const g in p)g!=="ref"&&(h[g]=p[g]);return a.refProperties.forEach(g=>{g in o&&(h[g]=o[g])}),h}function ii(p){p=p.slice();const o=Object.create(null);for(let h=0;h<p.length;h++)o[p[h].id]=p[h];for(let h=0;h<p.length;h++)"ref"in p[h]&&(p[h]=Ut(p[h],o[p[h].ref]));return p}gt.workerCount=2;const Pt={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function We(p,o,h){h.push({command:Pt.addSource,args:[p,o[p]]})}function Xe(p,o,h){o.push({command:Pt.removeSource,args:[p]}),h[p]=!0}function pt(p,o,h,g){Xe(p,h,g),We(p,o,h)}function It(p,o,h){let g;for(g in p[h])if(p[h].hasOwnProperty(g)&&g!=="data"&&!E(p[h][g],o[h][g]))return!1;for(g in o[h])if(o[h].hasOwnProperty(g)&&g!=="data"&&!E(p[h][g],o[h][g]))return!1;return!0}function Me(p,o,h,g,x,b){let A;for(A in o=o||{},p=p||{})p.hasOwnProperty(A)&&(E(p[A],o[A])||h.push({command:b,args:[g,A,o[A],x]}));for(A in o)o.hasOwnProperty(A)&&!p.hasOwnProperty(A)&&(E(p[A],o[A])||h.push({command:b,args:[g,A,o[A],x]}))}function Qt(p){return p.id}function $t(p,o){return p[o.id]=o,p}class Yt{constructor(o,h){this.reset(o,h)}reset(o,h){this.points=o||[],this._distances=[0];for(let g=1;g<this.points.length;g++)this._distances[g]=this._distances[g-1]+this.points[g].dist(this.points[g-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(h||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(o){if(this.points.length===1)return this.points[0];o=a.clamp(o,0,1);let h=1,g=this._distances[h];const x=o*this.paddedLength+this.padding;for(;g<x&&h<this._distances.length;)g=this._distances[++h];const b=h-1,A=this._distances[b],M=g-A,P=M>0?(x-A)/M:0;return this.points[b].mult(1-P).add(this.points[h].mult(P))}}class Fi{constructor(o,h,g){const x=this.boxCells=[],b=this.circleCells=[];this.xCellCount=Math.ceil(o/g),this.yCellCount=Math.ceil(h/g);for(let A=0;A<this.xCellCount*this.yCellCount;A++)x.push([]),b.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=o,this.height=h,this.xScale=this.xCellCount/o,this.yScale=this.yCellCount/h,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(o,h,g,x,b){this._forEachCell(h,g,x,b,this._insertBoxCell,this.boxUid++),this.boxKeys.push(o),this.bboxes.push(h),this.bboxes.push(g),this.bboxes.push(x),this.bboxes.push(b)}insertCircle(o,h,g,x){this._forEachCell(h-x,g-x,h+x,g+x,this._insertCircleCell,this.circleUid++),this.circleKeys.push(o),this.circles.push(h),this.circles.push(g),this.circles.push(x)}_insertBoxCell(o,h,g,x,b,A){this.boxCells[b].push(A)}_insertCircleCell(o,h,g,x,b,A){this.circleCells[b].push(A)}_query(o,h,g,x,b,A){if(g<0||o>this.width||x<0||h>this.height)return!b&&[];const M=[];if(o<=0&&h<=0&&this.width<=g&&this.height<=x){if(b)return!0;for(let P=0;P<this.boxKeys.length;P++)M.push({key:this.boxKeys[P],x1:this.bboxes[4*P],y1:this.bboxes[4*P+1],x2:this.bboxes[4*P+2],y2:this.bboxes[4*P+3]});for(let P=0;P<this.circleKeys.length;P++){const k=this.circles[3*P],D=this.circles[3*P+1],U=this.circles[3*P+2];M.push({key:this.circleKeys[P],x1:k-U,y1:D-U,x2:k+U,y2:D+U})}return A?M.filter(A):M}return this._forEachCell(o,h,g,x,this._queryCell,M,{hitTest:b,seenUids:{box:{},circle:{}}},A),b?M.length>0:M}_queryCircle(o,h,g,x,b){const A=o-g,M=o+g,P=h-g,k=h+g;if(M<0||A>this.width||k<0||P>this.height)return!x&&[];const D=[];return this._forEachCell(A,P,M,k,this._queryCellCircle,D,{hitTest:x,circle:{x:o,y:h,radius:g},seenUids:{box:{},circle:{}}},b),x?D.length>0:D}query(o,h,g,x,b){return this._query(o,h,g,x,!1,b)}hitTest(o,h,g,x,b){return this._query(o,h,g,x,!0,b)}hitTestCircle(o,h,g,x){return this._queryCircle(o,h,g,!0,x)}_queryCell(o,h,g,x,b,A,M,P){const k=M.seenUids,D=this.boxCells[b];if(D!==null){const W=this.bboxes;for(const J of D)if(!k.box[J]){k.box[J]=!0;const X=4*J;if(o<=W[X+2]&&h<=W[X+3]&&g>=W[X+0]&&x>=W[X+1]&&(!P||P(this.boxKeys[J]))){if(M.hitTest)return A.push(!0),!0;A.push({key:this.boxKeys[J],x1:W[X],y1:W[X+1],x2:W[X+2],y2:W[X+3]})}}}const U=this.circleCells[b];if(U!==null){const W=this.circles;for(const J of U)if(!k.circle[J]){k.circle[J]=!0;const X=3*J;if(this._circleAndRectCollide(W[X],W[X+1],W[X+2],o,h,g,x)&&(!P||P(this.circleKeys[J]))){if(M.hitTest)return A.push(!0),!0;{const ee=W[X],Y=W[X+1],q=W[X+2];A.push({key:this.circleKeys[J],x1:ee-q,y1:Y-q,x2:ee+q,y2:Y+q})}}}}}_queryCellCircle(o,h,g,x,b,A,M,P){const k=M.circle,D=M.seenUids,U=this.boxCells[b];if(U!==null){const J=this.bboxes;for(const X of U)if(!D.box[X]){D.box[X]=!0;const ee=4*X;if(this._circleAndRectCollide(k.x,k.y,k.radius,J[ee+0],J[ee+1],J[ee+2],J[ee+3])&&(!P||P(this.boxKeys[X])))return A.push(!0),!0}}const W=this.circleCells[b];if(W!==null){const J=this.circles;for(const X of W)if(!D.circle[X]){D.circle[X]=!0;const ee=3*X;if(this._circlesCollide(J[ee],J[ee+1],J[ee+2],k.x,k.y,k.radius)&&(!P||P(this.circleKeys[X])))return A.push(!0),!0}}}_forEachCell(o,h,g,x,b,A,M,P){const k=this._convertToXCellCoord(o),D=this._convertToYCellCoord(h),U=this._convertToXCellCoord(g),W=this._convertToYCellCoord(x);for(let J=k;J<=U;J++)for(let X=D;X<=W;X++)if(b.call(this,o,h,g,x,this.xCellCount*X+J,A,M,P))return}_convertToXCellCoord(o){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(o*this.xScale)))}_convertToYCellCoord(o){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(o*this.yScale)))}_circlesCollide(o,h,g,x,b,A){const M=x-o,P=b-h,k=g+A;return k*k>M*M+P*P}_circleAndRectCollide(o,h,g,x,b,A,M){const P=(A-x)/2,k=Math.abs(o-(x+P));if(k>P+g)return!1;const D=(M-b)/2,U=Math.abs(h-(b+D));if(U>D+g)return!1;if(k<=P||U<=D)return!0;const W=k-P,J=U-D;return W*W+J*J<=g*g}}const qi=Math.tan(85*Math.PI/180);function mr(p,o,h,g,x,b,A){const M=a.create();if(h)if(b.name==="globe"){const P=a.calculateGlobeLabelMatrix(x,o);a.multiply(M,M,P)}else{const P=et([],A);M[0]=P[0],M[1]=P[1],M[4]=P[2],M[5]=P[3],g||a.rotateZ(M,M,x.angle)}else a.multiply(M,x.labelPlaneMatrix,p);return M}function Rr(p,o,h,g,x,b,A){const M=mr(p,o,h,g,x,b,A);return b.name==="globe"&&h||(M[2]=M[6]=M[10]=M[14]=0),M}function vi(p,o,h,g,x,b,A){if(h){if(b.name==="globe"){const M=mr(p,o,h,g,x,b,A);return a.invert(M,M),a.multiply(M,p,M),M}{const M=a.clone(p),P=a.identity([]);return P[0]=A[0],P[1]=A[1],P[4]=A[2],P[5]=A[3],a.multiply(M,M,P),g||a.rotateZ(M,M,-x.angle),M}}return x.glCoordMatrix}function ot(p,o,h=0){const g=[p.x,p.y,h,1];h?a.transformMat4$1(g,g,o):$(g,g,o);const x=g[3];return{point:[g[0]/x,g[1]/x,g[2]/x],signedDistanceFromCamera:x}}function Vt(p,o){const h=[p[0],p[1],p[2],1];a.transformMat4$1(h,h,o);const g=h[3];return{point:[h[0]/g,h[1]/g,h[2]/g],signedDistanceFromCamera:g}}function jt(p,o){return Math.min(.5+p/o*.5,1.5)}function Fn(p,o){const h=p[0]/p[3],g=p[1]/p[3];return h>=-o[0]&&h<=o[0]&&g>=-o[1]&&g<=o[1]}function ns(p,o,h,g,x,b,A,M,P,k){const D=h.transform,U=g?p.textSizeData:p.iconSizeData,W=a.evaluateSizeForZoom(U,h.transform.zoom),J=D.projection.name==="globe",X=[256/h.width*2+1,256/h.height*2+1],ee=g?p.text.dynamicLayoutVertexArray:p.icon.dynamicLayoutVertexArray;ee.clear();let Y=null;J&&(Y=g?p.text.globeExtVertexArray:p.icon.globeExtVertexArray);const q=p.lineVertexArray,ie=g?p.text.placedSymbolArray:p.icon.placedSymbolArray,K=h.transform.width/h.transform.height;let he=!1;for(let fe=0;fe<ie.length;fe++){const le=ie.get(fe);if(le.writingMode!==a.WritingMode.vertical||he||fe!==0&&ie.get(fe-1).writingMode===a.WritingMode.horizontal||(he=!0),(le.hidden||le.writingMode===a.WritingMode.vertical)&&!he){gr(le.numGlyphs,ee);continue}he=!1;const me=new a.pointGeometry(le.tileAnchorX,le.tileAnchorY),Pe=P?P(me):[0,0,0],ze=D.projection.projectTilePoint(me.x,me.y,k.canonical),ke=[ze.x+Pe[0],ze.y+Pe[1],ze.z+Pe[2]],Ke=[...ke,1];if(a.transformMat4$1(Ke,Ke,o),!Fn(Ke,X)){gr(le.numGlyphs,ee);continue}const we=jt(h.transform.cameraToCenterDistance,Ke[3]),$e=a.evaluateSizeForFeature(U,W,le),je=A?$e/we:$e*we,Ie=ot(new a.pointGeometry(ke[0],ke[1]),x,ke[2]);if(Ie.signedDistanceFromCamera<=0){gr(le.numGlyphs,ee);continue}let ve={};const lt=A?null:P,tt=Ns(le,je,!1,M,o,x,b,p.glyphOffsetArray,q,ee,Y,Ie.point,me,ve,K,lt,D.projection,k,A);he=tt.useVertical,lt&&tt.needsFlipping&&(ve={}),(tt.notEnoughRoom||he||tt.needsFlipping&&Ns(le,je,!0,M,o,x,b,p.glyphOffsetArray,q,ee,Y,Ie.point,me,ve,K,lt,D.projection,k,A).notEnoughRoom)&&gr(le.numGlyphs,ee)}g?(p.text.dynamicLayoutVertexBuffer.updateData(ee),Y&&p.text.globeExtVertexBuffer.updateData(Y)):(p.icon.dynamicLayoutVertexBuffer.updateData(ee),Y&&p.icon.globeExtVertexBuffer.updateData(Y))}function qt(p,o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee){const Y=M.glyphStartIndex+M.numGlyphs,q=M.lineStartIndex,ie=M.lineStartIndex+M.lineLength,K=o.getoffsetX(M.glyphStartIndex),he=o.getoffsetX(Y-1),fe=Mi(p*K,h,g,x,b,A,M.segment,q,ie,P,k,D,U,W,!0,J,X,ee);if(!fe)return null;const le=Mi(p*he,h,g,x,b,A,M.segment,q,ie,P,k,D,U,W,!0,J,X,ee);return le?{first:fe,last:le}:null}function Zn(p,o,h,g){return p.writingMode===a.WritingMode.horizontal&&Math.abs(h.y-o.y)>Math.abs(h.x-o.x)*g?{useVertical:!0}:p.writingMode===a.WritingMode.vertical?o.y<h.y?{needsFlipping:!0}:null:p.flipState!==0&&function(x,b,A){const M=(b.x-x.x)*A;return M===0||Math.abs((b.y-x.y)/M)>qi}(o,h,g)?p.flipState===1?{needsFlipping:!0}:null:o.x>h.x?{needsFlipping:!0}:null}function Ns(p,o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee,Y,q,ie){const K=o/24,he=p.lineOffsetX*K,fe=p.lineOffsetY*K;let le=[];if(p.numGlyphs>1){const me=p.glyphStartIndex+p.numGlyphs,Pe=p.lineStartIndex,ze=p.lineStartIndex+p.lineLength,ke=qt(K,M,he,fe,h,U,W,p,P,b,J,ee,!1,Y,q,ie);if(!ke)return{notEnoughRoom:!0};const Ke=Vt(ke.first.point,A).point,we=Vt(ke.last.point,A).point,$e=new a.pointGeometry(Ke[0],Ke[1]),je=new a.pointGeometry(we[0],we[1]);if(g&&!h){const Ie=Zn(p,$e,je,X);if(p.flipState=Ie&&Ie.needsFlipping?1:2,Ie)return Ie}le=[ke.first];for(let Ie=p.glyphStartIndex+1;Ie<me-1;Ie++){const ve=Mi(K*M.getoffsetX(Ie),he,fe,h,U,W,p.segment,Pe,ze,P,b,J,ee,!1,!1,Y,q,ie);if(!ve)return{notEnoughRoom:!0};le.push(ve)}le.push(ke.last)}else{if(g&&!h){const Pe=ot(W,x).point,ze=p.lineStartIndex+p.segment+1,ke=new a.pointGeometry(P.getx(ze),P.gety(ze)),Ke=ot(ke,x),we=Ke.signedDistanceFromCamera>0?Ke.point:In(W,ke,Pe,1,x,void 0,Y,q.canonical),$e=Zn(p,new a.pointGeometry(Pe[0],Pe[1]),new a.pointGeometry(we[0],we[1]),X);if(p.flipState=$e&&$e.needsFlipping?1:2,$e)return $e}const me=Mi(K*M.getoffsetX(p.glyphStartIndex),he,fe,h,U,W,p.segment,p.lineStartIndex,p.lineStartIndex+p.lineLength,P,b,J,ee,!1,!1,Y,q,ie);if(!me)return{notEnoughRoom:!0};le=[me]}if(D)for(const me of le)a.updateGlobeVertexNormal(D,k.length+0,me.up[0],me.up[1],me.up[2]),a.updateGlobeVertexNormal(D,k.length+1,me.up[0],me.up[1],me.up[2]),a.updateGlobeVertexNormal(D,k.length+2,me.up[0],me.up[1],me.up[2]),a.updateGlobeVertexNormal(D,k.length+3,me.up[0],me.up[1],me.up[2]),a.addDynamicAttributes(k,me.point[0],me.point[1],me.point[2],me.angle);else for(const me of le)a.addDynamicAttributes(k,me.point[0],me.point[1],me.point[2],me.angle);return{}}function bs(p,o,h,g,x){const b=g.projectTilePoint(p.x,p.y,o);if(!x)return ot(b,h,b.z);const A=x(p);return ot(new a.pointGeometry(b.x+A[0],b.y+A[1]),h,b.z+A[2])}function In(p,o,h,g,x,b,A,M){const P=bs(p.add(p.sub(o)._unit()),M,x,A,b).point,k=a.sub([],h,P);return a.scaleAndAdd([],h,k,g/a.length(k))}function Mi(p,o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee,Y,q){const ie=g?p-o:p+o;let K=ie>0?1:-1,he=0;g&&(K*=-1,he=Math.PI),K<0&&(he+=Math.PI);let fe=K>0?M+A:M+A+1,le=x,me=x,Pe=0,ze=0;const ke=Math.abs(ie),Ke=[],we=[];let $e=b;const je=()=>{const rt=fe-K;return Pe===0?b:new a.pointGeometry(k.getx(rt),k.gety(rt))},Ie=()=>{const rt=je();return In(rt,$e||rt,me,ke-Pe+1,D,W,ee,Y.canonical)};for(;Pe+ze<=ke;){if(fe+=K,fe<M||fe>=P)return null;if(me=le,Ke.push(le),J&&we.push($e||je()),le=U[fe],le===void 0){$e=new a.pointGeometry(k.getx(fe),k.gety(fe));const rt=bs($e,Y.canonical,D,ee,W);le=rt.signedDistanceFromCamera>0?U[fe]=rt.point:Ie()}else $e=null;Pe+=ze,ze=a.distance(me,le)}$e=$e||new a.pointGeometry(k.getx(fe),k.gety(fe));const ve=je();X&&W&&(U[fe]=le=U[fe]===void 0?le:Ie(),ze=a.distance(me,le));const lt=(ke-Pe)/ze,tt=$e.sub(ve).mult(lt)._add(ve),at=a.sub([],le,me),nt=a.scaleAndAdd([],me,at,lt);let vt=[0,0,1],Rt=at[0],Ct=at[1];if(q&&(vt=ee.upVector(Y.canonical,tt.x,tt.y),vt[0]!==0||vt[1]!==0||vt[2]!==1)){const rt=[1,0,0],Ft=[0,1,0];rt[0]=vt[2],rt[1]=0,rt[2]=-vt[0],a.cross(Ft,vt,rt),a.normalize(rt,rt),a.normalize(Ft,Ft),Rt=a.dot(at,rt),Ct=a.dot(at,Ft)}if(h){const rt=a.cross([],vt,at);a.normalize(rt,rt),a.scaleAndAdd(nt,nt,rt,h*K)}const Et=he+Math.atan2(Ct,Rt);return Ke.push(nt),J&&we.push(tt),{point:nt,angle:Et,path:Ke,tilePath:we,up:vt}}const zc=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function gr(p,o){for(let h=0;h<p;h++){const g=o.length;o.resize(g+4),o.float32.set(zc,4*g)}}function $(p,o,h){const g=o[0],x=o[1];return p[0]=h[0]*g+h[4]*x+h[12],p[1]=h[1]*g+h[5]*x+h[13],p[3]=h[3]*g+h[7]*x+h[15],p}const Q=100;class _e{constructor(o,h,g=new Fi(o.width+200,o.height+200,25),x=new Fi(o.width+200,o.height+200,25)){this.transform=o,this.grid=g,this.ignoredGrid=x,this.pitchfactor=Math.cos(o._pitch)*o.cameraToCenterDistance,this.screenRightBoundary=o.width+Q,this.screenBottomBoundary=o.height+Q,this.gridRightBoundary=o.width+200,this.gridBottomBoundary=o.height+200,this.fogState=h}placeCollisionBox(o,h,g,x,b,A,M,P){let k=g.projectedAnchorX,D=g.projectedAnchorY,U=g.projectedAnchorZ;const W=g.elevation,J=g.tileID;if(W&&J){const fe=o.getProjection().upVector(J.canonical,g.tileAnchorX,g.tileAnchorY),le=o.getProjection().upVectorScale(J.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;k+=fe[0]*W*le,D+=fe[1]*W*le,U+=fe[2]*W*le}const X=this.projectAndGetPerspectiveRatio(M,[k,D,U],g.tileID,o.projection.name==="globe"||!!W||this.transform.pitch>0,o.getProjection()),ee=A*X.perspectiveRatio,Y=(g.x1*h+x.x-g.padding)*ee+X.point.x,q=(g.y1*h+x.y-g.padding)*ee+X.point.y,ie=(g.x2*h+x.x+g.padding)*ee+X.point.x,K=(g.y2*h+x.y+g.padding)*ee+X.point.y,he=X.perspectiveRatio<=.55||X.occluded;return!this.isInsideGrid(Y,q,ie,K)||!b&&this.grid.hitTest(Y,q,ie,K,P)||he?{box:[],offscreen:!1,occluded:X.occluded}:{box:[Y,q,ie,K],offscreen:this.isOffscreen(Y,q,ie,K),occluded:!1}}placeCollisionCircles(o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee){const Y=[],q=this.transform.elevation,ie=q?q.getAtTileOffsetFunc(ee,this.transform.center.lat,this.transform.worldSize,o.getProjection()):ve=>[0,0,0],K=new a.pointGeometry(g.tileAnchorX,g.tileAnchorY),he=o.getProjection().projectTilePoint(g.tileAnchorX,g.tileAnchorY,ee.canonical),fe=ie(K),le=[he.x+fe[0],he.y+fe[1],he.z+fe[2]],me=o.projection.name==="globe",Pe=this.projectAndGetPerspectiveRatio(M,[le[0],le[1],le[2]],ee,me||!!q||this.transform.pitch>0,o.getProjection()),{perspectiveRatio:ze}=Pe,ke=(U?A/ze:A*ze)/a.ONE_EM,Ke=ot(new a.pointGeometry(le[0],le[1]),P,le[2]).point,we=Pe.signedDistanceFromCamera>0?qt(ke,b,g.lineOffsetX*ke,g.lineOffsetY*ke,!1,Ke,K,g,x,P,{},q&&!U?ie:null,U&&!!q,o.getProjection(),ee,U):null;let $e=!1,je=!1,Ie=!0;if(we&&!Pe.occluded){const ve=.5*J*ze+X,lt=new a.pointGeometry(-100,-100),tt=new a.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),at=new Yt,nt=we.first,vt=we.last;let Rt=[];for(let rt=nt.path.length-1;rt>=1;rt--)Rt.push(nt.path[rt]);for(let rt=1;rt<vt.path.length;rt++)Rt.push(vt.path[rt]);const Ct=2.5*ve;if(k){const rt=Rt.map(q&&!me?(Ft,Ht)=>{const bi=ie(Ht<nt.path.length-1?nt.tilePath[nt.path.length-1-Ht]:vt.tilePath[Ht-nt.path.length+2]);return Ft[2]=bi[2],Vt(Ft,k)}:Ft=>Vt(Ft,k));Rt=rt.some(Ft=>Ft.signedDistanceFromCamera<=0)?[]:rt.map(Ft=>Ft.point)}let Et=[];if(Rt.length>0){const rt=Rt.map(_i=>new a.pointGeometry(_i[0],_i[1]));let Ft=1/0,Ht=-1/0,bi=1/0,wi=-1/0;for(let _i=0;_i<rt.length;_i++)Ft=Math.min(Ft,rt[_i].x),bi=Math.min(bi,rt[_i].y),Ht=Math.max(Ht,rt[_i].x),wi=Math.max(wi,rt[_i].y);Et=Ft>=lt.x&&Ht<=tt.x&&bi>=lt.y&&wi<=tt.y?[rt]:Ht<lt.x||Ft>tt.x||wi<lt.y||bi>tt.y?[]:a.clipLine([rt],lt.x,lt.y,tt.x,tt.y)}for(const rt of Et){at.reset(rt,.25*ve);let Ft=0;Ft=at.length<=.5*ve?1:Math.ceil(at.paddedLength/Ct)+1;for(let Ht=0;Ht<Ft;Ht++){const bi=Ht/Math.max(Ft-1,1),wi=at.lerp(bi),_i=wi.x+Q,xn=wi.y+Q;Y.push(_i,xn,ve,0);const qn=_i-ve,us=xn-ve,ki=_i+ve,Vi=xn+ve;if(Ie=Ie&&this.isOffscreen(qn,us,ki,Vi),je=je||this.isInsideGrid(qn,us,ki,Vi),!h&&this.grid.hitTestCircle(_i,xn,ve,W)&&($e=!0,!D))return{circles:[],offscreen:!1,collisionDetected:$e,occluded:!1}}}}return{circles:!D&&$e||!je?[]:Y,offscreen:Ie,collisionDetected:$e,occluded:Pe.occluded}}queryRenderedSymbols(o){if(o.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const h=[];let g=1/0,x=1/0,b=-1/0,A=-1/0;for(const D of o){const U=new a.pointGeometry(D.x+Q,D.y+Q);g=Math.min(g,U.x),x=Math.min(x,U.y),b=Math.max(b,U.x),A=Math.max(A,U.y),h.push(U)}const M=this.grid.query(g,x,b,A).concat(this.ignoredGrid.query(g,x,b,A)),P={},k={};for(const D of M){const U=D.key;if(P[U.bucketInstanceId]===void 0&&(P[U.bucketInstanceId]={}),P[U.bucketInstanceId][U.featureIndex])continue;const W=[new a.pointGeometry(D.x1,D.y1),new a.pointGeometry(D.x2,D.y1),new a.pointGeometry(D.x2,D.y2),new a.pointGeometry(D.x1,D.y2)];a.polygonIntersectsPolygon(h,W)&&(P[U.bucketInstanceId][U.featureIndex]=!0,k[U.bucketInstanceId]===void 0&&(k[U.bucketInstanceId]=[]),k[U.bucketInstanceId].push(U.featureIndex))}return k}insertCollisionBox(o,h,g,x,b){(h?this.ignoredGrid:this.grid).insert({bucketInstanceId:g,featureIndex:x,collisionGroupID:b},o[0],o[1],o[2],o[3])}insertCollisionCircles(o,h,g,x,b){const A=h?this.ignoredGrid:this.grid,M={bucketInstanceId:g,featureIndex:x,collisionGroupID:b};for(let P=0;P<o.length;P+=4)A.insertCircle(M,o[P],o[P+1],o[P+2])}projectAndGetPerspectiveRatio(o,h,g,x,b){const A=[h[0],h[1],h[2],1];let M=!1;if(h[2]||this.transform.pitch>0){a.transformMat4$1(A,A,o);const P=b.name==="globe";this.fogState&&g&&!P&&(M=function(k,D,U,W,J,X){const ee=X.calculateFogTileMatrix(J),Y=[D,U,W];return a.transformMat4(Y,Y,ee),pn(k,Y,X.pitch,X._fov)}(this.fogState,h[0],h[1],h[2],g.toUnwrapped(),this.transform)>.9)}else $(A,A,o);return{point:new a.pointGeometry((A[0]/A[3]+1)/2*this.transform.width+Q,(-A[1]/A[3]+1)/2*this.transform.height+Q),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(b)/A[3]*.5,1.5),signedDistanceFromCamera:A[3],occluded:x&&A[2]>A[3]||M}}isOffscreen(o,h,g,x){return g<Q||o>=this.screenRightBoundary||x<Q||h>this.screenBottomBoundary}isInsideGrid(o,h,g,x){return g>=0&&o<this.gridRightBoundary&&x>=0&&h<this.gridBottomBoundary}getViewportMatrix(){const o=a.identity([]);return a.translate(o,o,[-100,-100,0]),o}}function Fe(p,o,h){const g=o.createTileMatrix(p,p.worldSize,h.toUnwrapped());return a.multiply(new Float32Array(16),p.projMatrix,g)}function it(p,o,h){if(o.projection.name===h.projection.name)return p.projMatrix;const g=h.clone();return g.setProjection(o.projection),Fe(g,o.getProjection(),p)}function xt(p,o,h){return o.name===h.projection.name?p.projMatrix:Fe(h,o,p)}class Jt{constructor(o,h,g,x){this.opacity=o?Math.max(0,Math.min(1,o.opacity+(o.placed?h:-h))):x&&g?1:0,this.placed=g}isHidden(){return this.opacity===0&&!this.placed}}class Ni{constructor(o,h,g,x,b,A=!1){this.text=new Jt(o?o.text:null,h,g,b),this.icon=new Jt(o?o.icon:null,h,x,b),this.clipped=A}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class pi{constructor(o,h,g,x=!1){this.text=o,this.icon=h,this.skipFade=g,this.clipped=x}}class ri{constructor(){this.invProjMatrix=a.create(),this.viewportMatrix=a.create(),this.circles=[]}}class tr{constructor(o,h,g,x,b){this.bucketInstanceId=o,this.featureIndex=h,this.sourceLayerIndex=g,this.bucketIndex=x,this.tileID=b}}class Oc{constructor(o){this.crossSourceCollisions=o,this.maxGroupID=0,this.collisionGroups={}}get(o){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[o]){const h=++this.maxGroupID;this.collisionGroups[o]={ID:h,predicate:g=>g.collisionGroupID===h}}return this.collisionGroups[o]}}function $n(p,o,h,g,x){const{horizontalAlign:b,verticalAlign:A}=a.getAnchorAlignment(p),M=-(b-.5)*o,P=-(A-.5)*h,k=a.evaluateVariableOffset(p,g);return new a.pointGeometry(M+k[0]*x,P+k[1]*x)}function ir(p,o,h,g,x){const b=new a.pointGeometry(p,o);return h&&b._rotate(g?x:-x),b}class Qh{constructor(o,h,g,x,b){this.transform=o.clone(),this.projection=o.projection.name,this.collisionIndex=new _e(this.transform,b),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=h,this.retainedQueryData={},this.collisionGroups=new Oc(g),this.collisionCircleArrays={},this.prevPlacement=x,x&&(x.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(o,h,g,x){const b=g.getBucket(h),A=g.latestFeatureIndex;if(!b||!A||h.id!==b.layerIds[0])return;const M=b.layers[0].layout,P=g.collisionBoxArray,k=Math.pow(2,this.transform.zoom-g.tileID.overscaledZ),D=g.tileSize/a.EXTENT,U=g.tileID.toUnwrapped();this.transform.setProjection(b.projection);const W=(J=g.tileID,X=b.getProjection(),ee=this.transform,X.name===this.projection?ee.calculateProjMatrix(J.toUnwrapped()):Fe(ee,X,J));var J,X,ee;const Y=M.get("text-pitch-alignment")==="map",q=M.get("text-rotation-alignment")==="map";h.compileFilter();const ie=h.dynamicFilter(),K=h.dynamicFilterNeedsFeature(),he=this.transform.calculatePixelsToTileUnitsMatrix(g),fe=Rr(W,g.tileID.canonical,Y,q,this.transform,b.getProjection(),he);let le=null;if(Y){const ze=vi(W,g.tileID.canonical,Y,q,this.transform,b.getProjection(),he);le=a.multiply([],this.transform.labelPlaneMatrix,ze)}let me=null;ie&&g.latestFeatureIndex&&(me={unwrappedTileID:U,dynamicFilter:ie,dynamicFilterNeedsFeature:K,featureIndex:g.latestFeatureIndex}),this.retainedQueryData[b.bucketInstanceId]=new tr(b.bucketInstanceId,A,b.sourceLayerIndex,b.index,g.tileID);const Pe={bucket:b,layout:M,posMatrix:W,textLabelPlaneMatrix:fe,labelToScreenMatrix:le,clippingData:me,scale:k,textPixelRatio:D,holdingForFade:g.holdingForFade(),collisionBoxArray:P,partiallyEvaluatedTextSize:a.evaluateSizeForZoom(b.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:a.evaluateSizeForZoom(b.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(b.sourceID)};if(x)for(const ze of b.sortKeyRanges){const{sortKey:ke,symbolInstanceStart:Ke,symbolInstanceEnd:we}=ze;o.push({sortKey:ke,symbolInstanceStart:Ke,symbolInstanceEnd:we,parameters:Pe})}else o.push({symbolInstanceStart:0,symbolInstanceEnd:b.symbolInstances.length,parameters:Pe})}attemptAnchorPlacement(o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee,Y,q,ie){const K=[W.textOffset0,W.textOffset1],he=$n(o,g,x,K,b),fe=this.collisionIndex.placeCollisionBox(X,b,h,ir(he.x,he.y,A,M,this.transform.angle),U,P,k,D.predicate);if(Y){const le=X.getSymbolInstanceIconSize(ie,this.transform.zoom,W.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(X,le,Y,ir(he.x,he.y,A,M,this.transform.angle),U,P,k,D.predicate).box.length===0)return}if(fe.box.length>0){let le;return this.prevPlacement&&this.prevPlacement.variableOffsets[W.crossTileID]&&this.prevPlacement.placements[W.crossTileID]&&this.prevPlacement.placements[W.crossTileID].text&&(le=this.prevPlacement.variableOffsets[W.crossTileID].anchor),this.variableOffsets[W.crossTileID]={textOffset:K,width:g,height:x,anchor:o,textScale:b,prevAnchor:le},this.markUsedJustification(X,o,W,ee),X.allowVerticalPlacement&&(this.markUsedOrientation(X,ee,W),this.placedOrientations[W.crossTileID]=ee),{shift:he,placedGlyphBoxes:fe}}}placeLayerBucketPart(o,h,g,x){const{bucket:b,layout:A,posMatrix:M,textLabelPlaneMatrix:P,labelToScreenMatrix:k,clippingData:D,textPixelRatio:U,holdingForFade:W,collisionBoxArray:J,partiallyEvaluatedTextSize:X,partiallyEvaluatedIconSize:ee,collisionGroup:Y}=o.parameters,q=A.get("text-optional"),ie=A.get("icon-optional"),K=A.get("text-allow-overlap"),he=A.get("icon-allow-overlap"),fe=A.get("text-rotation-alignment")==="map",le=A.get("text-pitch-alignment")==="map",me=A.get("icon-text-fit")!=="none",Pe=A.get("symbol-z-order")==="viewport-y";this.transform.setProjection(b.projection);let ze=K&&(he||!b.hasIconData()||ie),ke=he&&(K||!b.hasTextData()||q);!b.collisionArrays&&J&&b.deserializeCollisionBoxes(J),g&&x&&b.updateCollisionDebugBuffers(this.transform.zoom,J);const Ke=(we,$e,je)=>{if(D){const ki={zoom:this.transform.zoom,pitch:this.transform.pitch};let Vi=null;if(D.dynamicFilterNeedsFeature){const mi=this.retainedQueryData[b.bucketInstanceId];Vi=D.featureIndex.loadFeature({featureIndex:we.featureIndex,bucketIndex:mi.bucketIndex,sourceLayerIndex:mi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,D.dynamicFilter)(ki,Vi,this.retainedQueryData[b.bucketInstanceId].tileID.canonical,new a.pointGeometry(we.tileAnchorX,we.tileAnchorY),this.transform.calculateDistanceTileData(D.unwrappedTileID)))return this.placements[we.crossTileID]=new pi(!1,!1,!1,!0),void(h[we.crossTileID]=!0)}if(h[we.crossTileID])return;if(W)return void(this.placements[we.crossTileID]=new pi(!1,!1,!1));let Ie=!1,ve=!1,lt=!0,tt=!1,at=!1,nt=null,vt={box:null,offscreen:null,occluded:null},Rt={box:null,offscreen:null,occluded:null},Ct=null,Et=null,rt=null,Ft=0,Ht=0,bi=0;je.textFeatureIndex?Ft=je.textFeatureIndex:we.useRuntimeCollisionCircles&&(Ft=we.featureIndex),je.verticalTextFeatureIndex&&(Ht=je.verticalTextFeatureIndex);const wi=ki=>{ki.tileID=this.retainedQueryData[b.bucketInstanceId].tileID,(this.transform.elevation||ki.elevation)&&(ki.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[b.bucketInstanceId].tileID,ki.tileAnchorX,ki.tileAnchorY):0)},_i=je.textBox;if(_i){wi(_i);const ki=mi=>{let nn=a.WritingMode.horizontal;if(b.allowVerticalPlacement&&!mi&&this.prevPlacement){const Un=this.prevPlacement.placedOrientations[we.crossTileID];Un&&(this.placedOrientations[we.crossTileID]=Un,nn=Un,this.markUsedOrientation(b,nn,we))}return nn},Vi=(mi,nn)=>{if(b.allowVerticalPlacement&&we.numVerticalGlyphVertices>0&&je.verticalTextBox){for(const Un of b.writingModes)if(Un===a.WritingMode.vertical?(vt=nn(),Rt=vt):vt=mi(),vt&&vt.box&&vt.box.length)break}else vt=mi()};if(A.get("text-variable-anchor")){let mi=A.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[we.crossTileID]){const Ii=this.prevPlacement.variableOffsets[we.crossTileID];mi.indexOf(Ii.anchor)>0&&(mi=mi.filter(nr=>nr!==Ii.anchor),mi.unshift(Ii.anchor))}const nn=(Ii,nr,_o)=>{const zr=b.getSymbolInstanceTextSize(X,we,this.transform.zoom,$e),Hn=(Ii.x2-Ii.x1)*zr+2*Ii.padding,Wo=(Ii.y2-Ii.y1)*zr+2*Ii.padding,Ws=me&&!he?nr:null;Ws&&wi(Ws);let Ln={box:[],offscreen:!1,occluded:!1};const hs=K?2*mi.length:mi.length;for(let Zs=0;Zs<hs;++Zs){const Or=this.attemptAnchorPlacement(mi[Zs%mi.length],Ii,Hn,Wo,zr,fe,le,U,M,Y,Zs>=mi.length,we,$e,b,_o,Ws,X,ee);if(Or&&(Ln=Or.placedGlyphBoxes,Ln&&Ln.box&&Ln.box.length)){Ie=!0,nt=Or.shift;break}}return Ln};Vi(()=>nn(_i,je.iconBox,a.WritingMode.horizontal),()=>{const Ii=je.verticalTextBox;return Ii&&wi(Ii),b.allowVerticalPlacement&&!(vt&&vt.box&&vt.box.length)&&we.numVerticalGlyphVertices>0&&Ii?nn(Ii,je.verticalIconBox,a.WritingMode.vertical):{box:null,offscreen:null,occluded:null}}),vt&&(Ie=vt.box,lt=vt.offscreen,tt=vt.occluded);const Un=ki(vt&&vt.box);if(!Ie&&this.prevPlacement){const Ii=this.prevPlacement.variableOffsets[we.crossTileID];Ii&&(this.variableOffsets[we.crossTileID]=Ii,this.markUsedJustification(b,Ii.anchor,we,Un))}}else{const mi=(nn,Un)=>{const Ii=b.getSymbolInstanceTextSize(X,we,this.transform.zoom,$e),nr=this.collisionIndex.placeCollisionBox(b,Ii,nn,new a.pointGeometry(0,0),K,U,M,Y.predicate);return nr&&nr.box&&nr.box.length&&(this.markUsedOrientation(b,Un,we),this.placedOrientations[we.crossTileID]=Un),nr};Vi(()=>mi(_i,a.WritingMode.horizontal),()=>{const nn=je.verticalTextBox;return b.allowVerticalPlacement&&we.numVerticalGlyphVertices>0&&nn?(wi(nn),mi(nn,a.WritingMode.vertical)):{box:null,offscreen:null,occluded:null}}),ki(vt&&vt.box&&vt.box.length)}}if(Ct=vt,Ie=Ct&&Ct.box&&Ct.box.length>0,lt=Ct&&Ct.offscreen,tt=Ct&&Ct.occluded,we.useRuntimeCollisionCircles){const ki=b.text.placedSymbolArray.get(we.centerJustifiedTextSymbolIndex>=0?we.centerJustifiedTextSymbolIndex:we.verticalPlacedTextSymbolIndex),Vi=a.evaluateSizeForFeature(b.textSizeData,X,ki),mi=A.get("text-padding");Et=this.collisionIndex.placeCollisionCircles(b,K,ki,b.lineVertexArray,b.glyphOffsetArray,Vi,M,P,k,g,le,Y.predicate,we.collisionCircleDiameter*Vi/a.ONE_EM,mi,this.retainedQueryData[b.bucketInstanceId].tileID),Ie=K||Et.circles.length>0&&!Et.collisionDetected,lt=lt&&Et.offscreen,tt=Et.occluded}if(je.iconFeatureIndex&&(bi=je.iconFeatureIndex),je.iconBox){const ki=Vi=>{wi(Vi);const mi=me&&nt?ir(nt.x,nt.y,fe,le,this.transform.angle):new a.pointGeometry(0,0),nn=b.getSymbolInstanceIconSize(ee,this.transform.zoom,we.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(b,nn,Vi,mi,he,U,M,Y.predicate)};Rt&&Rt.box&&Rt.box.length&&je.verticalIconBox?(rt=ki(je.verticalIconBox),ve=rt.box.length>0):(rt=ki(je.iconBox),ve=rt.box.length>0),lt=lt&&rt.offscreen,at=rt.occluded}const xn=q||we.numHorizontalGlyphVertices===0&&we.numVerticalGlyphVertices===0,qn=ie||we.numIconVertices===0;if(xn||qn?qn?xn||(ve=ve&&Ie):Ie=ve&&Ie:ve=Ie=ve&&Ie,Ie&&Ct&&Ct.box&&this.collisionIndex.insertCollisionBox(Ct.box,A.get("text-ignore-placement"),b.bucketInstanceId,Rt&&Rt.box&&Ht?Ht:Ft,Y.ID),ve&&rt&&this.collisionIndex.insertCollisionBox(rt.box,A.get("icon-ignore-placement"),b.bucketInstanceId,bi,Y.ID),Et&&(Ie&&this.collisionIndex.insertCollisionCircles(Et.circles,A.get("text-ignore-placement"),b.bucketInstanceId,Ft,Y.ID),g)){const ki=b.bucketInstanceId;let Vi=this.collisionCircleArrays[ki];Vi===void 0&&(Vi=this.collisionCircleArrays[ki]=new ri);for(let mi=0;mi<Et.circles.length;mi+=4)Vi.circles.push(Et.circles[mi+0]),Vi.circles.push(Et.circles[mi+1]),Vi.circles.push(Et.circles[mi+2]),Vi.circles.push(Et.collisionDetected?1:0)}const us=b.projection.name!=="globe";ze=ze&&(us||!tt),ke=ke&&(us||!at),this.placements[we.crossTileID]=new pi(Ie||ze,ve||ke,lt||b.justReloaded),h[we.crossTileID]=!0};if(Pe){const we=b.getSortedSymbolIndexes(this.transform.angle);for(let $e=we.length-1;$e>=0;--$e){const je=we[$e];Ke(b.symbolInstances.get(je),je,b.collisionArrays[je])}}else for(let we=o.symbolInstanceStart;we<o.symbolInstanceEnd;we++)Ke(b.symbolInstances.get(we),we,b.collisionArrays[we]);if(g&&b.bucketInstanceId in this.collisionCircleArrays){const we=this.collisionCircleArrays[b.bucketInstanceId];a.invert(we.invProjMatrix,M),we.viewportMatrix=this.collisionIndex.getViewportMatrix()}b.justReloaded=!1}markUsedJustification(o,h,g,x){let b;b=x===a.WritingMode.vertical?g.verticalPlacedTextSymbolIndex:{left:g.leftJustifiedTextSymbolIndex,center:g.centerJustifiedTextSymbolIndex,right:g.rightJustifiedTextSymbolIndex}[a.getAnchorJustification(h)];const A=[g.leftJustifiedTextSymbolIndex,g.centerJustifiedTextSymbolIndex,g.rightJustifiedTextSymbolIndex,g.verticalPlacedTextSymbolIndex];for(const M of A)M>=0&&(o.text.placedSymbolArray.get(M).crossTileID=b>=0&&M!==b?0:g.crossTileID)}markUsedOrientation(o,h,g){const x=h===a.WritingMode.horizontal||h===a.WritingMode.horizontalOnly?h:0,b=h===a.WritingMode.vertical?h:0,A=[g.leftJustifiedTextSymbolIndex,g.centerJustifiedTextSymbolIndex,g.rightJustifiedTextSymbolIndex].filter(M=>M!==-1);for(const M of A)o.text.placedSymbolArray.get(M).placedOrientation=x;g.verticalPlacedTextSymbolIndex!==-1&&(o.text.placedSymbolArray.get(g.verticalPlacedTextSymbolIndex).placedOrientation=b)}commit(o){this.commitTime=o,this.zoomAtLastRecencyCheck=this.transform.zoom;const h=this.prevPlacement;let g=!1;this.prevZoomAdjustment=h?h.zoomAdjustment(this.transform.zoom):0;const x=h?h.symbolFadeChange(o):1,b=h?h.opacities:{},A=h?h.variableOffsets:{},M=h?h.placedOrientations:{};for(const P in this.placements){const k=this.placements[P],D=b[P];D?(this.opacities[P]=new Ni(D,x,k.text,k.icon,null,k.clipped),g=g||k.text!==D.text.placed||k.icon!==D.icon.placed):(this.opacities[P]=new Ni(null,x,k.text,k.icon,k.skipFade,k.clipped),g=g||k.text||k.icon)}for(const P in b){const k=b[P];if(!this.opacities[P]){const D=new Ni(k,x,!1,!1);D.isHidden()||(this.opacities[P]=D,g=g||k.text.placed||k.icon.placed)}}for(const P in A)this.variableOffsets[P]||!this.opacities[P]||this.opacities[P].isHidden()||(this.variableOffsets[P]=A[P]);for(const P in M)this.placedOrientations[P]||!this.opacities[P]||this.opacities[P].isHidden()||(this.placedOrientations[P]=M[P]);g?this.lastPlacementChangeTime=o:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=h?h.lastPlacementChangeTime:o)}updateLayerOpacities(o,h){const g={};for(const x of h){const b=x.getBucket(o);b&&x.latestFeatureIndex&&o.id===b.layerIds[0]&&this.updateBucketOpacities(b,g,x.collisionBoxArray)}}updateBucketOpacities(o,h,g){o.hasTextData()&&o.text.opacityVertexArray.clear(),o.hasIconData()&&o.icon.opacityVertexArray.clear(),o.hasIconCollisionBoxData()&&o.iconCollisionBox.collisionVertexArray.clear(),o.hasTextCollisionBoxData()&&o.textCollisionBox.collisionVertexArray.clear();const x=o.layers[0].layout,b=!!o.layers[0].dynamicFilter(),A=new Ni(null,0,!1,!1,!0),M=x.get("text-allow-overlap"),P=x.get("icon-allow-overlap"),k=x.get("text-variable-anchor"),D=x.get("text-rotation-alignment")==="map",U=x.get("text-pitch-alignment")==="map",W=x.get("icon-text-fit")!=="none",J=new Ni(null,0,M&&(P||!o.hasIconData()||x.get("icon-optional")),P&&(M||!o.hasTextData()||x.get("text-optional")),!0);!o.collisionArrays&&g&&(o.hasIconCollisionBoxData()||o.hasTextCollisionBoxData())&&o.deserializeCollisionBoxes(g);const X=(Y,q,ie)=>{for(let K=0;K<q/4;K++)Y.opacityVertexArray.emplaceBack(ie)};let ee=0;for(let Y=0;Y<o.symbolInstances.length;Y++){const q=o.symbolInstances.get(Y),{numHorizontalGlyphVertices:ie,numVerticalGlyphVertices:K,crossTileID:he}=q;let fe=this.opacities[he];h[he]?fe=A:fe||(fe=J,this.opacities[he]=fe),h[he]=!0;const le=ie>0||K>0,me=q.numIconVertices>0,Pe=this.placedOrientations[q.crossTileID],ze=Pe===a.WritingMode.vertical,ke=Pe===a.WritingMode.horizontal||Pe===a.WritingMode.horizontalOnly;if(!le&&!me||fe.isHidden()||ee++,le){const Ke=rs(fe.text);X(o.text,ie,ze?Us:Ke),X(o.text,K,ke?Us:Ke);const we=fe.text.isHidden();[q.rightJustifiedTextSymbolIndex,q.centerJustifiedTextSymbolIndex,q.leftJustifiedTextSymbolIndex].forEach(Ie=>{Ie>=0&&(o.text.placedSymbolArray.get(Ie).hidden=we||ze?1:0)}),q.verticalPlacedTextSymbolIndex>=0&&(o.text.placedSymbolArray.get(q.verticalPlacedTextSymbolIndex).hidden=we||ke?1:0);const $e=this.variableOffsets[q.crossTileID];$e&&this.markUsedJustification(o,$e.anchor,q,Pe);const je=this.placedOrientations[q.crossTileID];je&&(this.markUsedJustification(o,"left",q,je),this.markUsedOrientation(o,je,q))}if(me){const Ke=rs(fe.icon);q.placedIconSymbolIndex>=0&&(X(o.icon,q.numIconVertices,ze?Us:Ke),o.icon.placedSymbolArray.get(q.placedIconSymbolIndex).hidden=fe.icon.isHidden()),q.verticalPlacedIconSymbolIndex>=0&&(X(o.icon,q.numVerticalIconVertices,ke?Us:Ke),o.icon.placedSymbolArray.get(q.verticalPlacedIconSymbolIndex).hidden=fe.icon.isHidden())}if(o.hasIconCollisionBoxData()||o.hasTextCollisionBoxData()){const Ke=o.collisionArrays[Y];if(Ke){let we=new a.pointGeometry(0,0),$e=!0;if(Ke.textBox||Ke.verticalTextBox){if(k){const Ie=this.variableOffsets[he];Ie?(we=$n(Ie.anchor,Ie.width,Ie.height,Ie.textOffset,Ie.textScale),D&&we._rotate(U?this.transform.angle:-this.transform.angle)):$e=!1}b&&($e=!fe.clipped),Ke.textBox&&uo(o.textCollisionBox.collisionVertexArray,fe.text.placed,!$e||ze,we.x,we.y),Ke.verticalTextBox&&uo(o.textCollisionBox.collisionVertexArray,fe.text.placed,!$e||ke,we.x,we.y)}const je=$e&&Boolean(!ke&&Ke.verticalIconBox);Ke.iconBox&&uo(o.iconCollisionBox.collisionVertexArray,fe.icon.placed,je,W?we.x:0,W?we.y:0),Ke.verticalIconBox&&uo(o.iconCollisionBox.collisionVertexArray,fe.icon.placed,!je,W?we.x:0,W?we.y:0)}}}if(o.fullyClipped=ee===0,o.sortFeatures(this.transform.angle),this.retainedQueryData[o.bucketInstanceId]&&(this.retainedQueryData[o.bucketInstanceId].featureSortOrder=o.featureSortOrder),o.hasTextData()&&o.text.opacityVertexBuffer&&o.text.opacityVertexBuffer.updateData(o.text.opacityVertexArray),o.hasIconData()&&o.icon.opacityVertexBuffer&&o.icon.opacityVertexBuffer.updateData(o.icon.opacityVertexArray),o.hasIconCollisionBoxData()&&o.iconCollisionBox.collisionVertexBuffer&&o.iconCollisionBox.collisionVertexBuffer.updateData(o.iconCollisionBox.collisionVertexArray),o.hasTextCollisionBoxData()&&o.textCollisionBox.collisionVertexBuffer&&o.textCollisionBox.collisionVertexBuffer.updateData(o.textCollisionBox.collisionVertexArray),o.bucketInstanceId in this.collisionCircleArrays){const Y=this.collisionCircleArrays[o.bucketInstanceId];o.placementInvProjMatrix=Y.invProjMatrix,o.placementViewportMatrix=Y.viewportMatrix,o.collisionCircleArray=Y.circles,delete this.collisionCircleArrays[o.bucketInstanceId]}}symbolFadeChange(o){return this.fadeDuration===0?1:(o-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(o){return Math.max(0,(this.transform.zoom-o)/1.5)}hasTransitions(o){return this.stale||o-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(o,h){const g=this.zoomAtLastRecencyCheck===h?1-this.zoomAdjustment(h):1;return this.zoomAtLastRecencyCheck=h,this.commitTime+this.fadeDuration*g>o}setStale(){this.stale=!0}}function uo(p,o,h,g,x){p.emplaceBack(o?1:0,h?1:0,g||0,x||0),p.emplaceBack(o?1:0,h?1:0,g||0,x||0),p.emplaceBack(o?1:0,h?1:0,g||0,x||0),p.emplaceBack(o?1:0,h?1:0,g||0,x||0)}const ln=Math.pow(2,25),ua=Math.pow(2,24),Bc=Math.pow(2,17),ha=Math.pow(2,16),Cn=Math.pow(2,9),Fc=Math.pow(2,8),Nc=Math.pow(2,1);function rs(p){if(p.opacity===0&&!p.placed)return 0;if(p.opacity===1&&p.placed)return 4294967295;const o=p.placed?1:0,h=Math.floor(127*p.opacity);return h*ln+o*ua+h*Bc+o*ha+h*Cn+o*Fc+h*Nc+o}const Us=0;class Qa{constructor(o){this._sortAcrossTiles=o.layout.get("symbol-z-order")!=="viewport-y"&&o.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(o,h,g,x,b){const A=this._bucketParts;for(;this._currentTileIndex<o.length;)if(h.getBucketParts(A,x,o[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,b())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,A.sort((M,P)=>M.sortKey-P.sortKey));this._currentPartIndex<A.length;){const M=A[this._currentPartIndex];if(h.placeLayerBucketPart(M,this._seenCrossTileIDs,g,M.symbolInstanceStart===0),this._currentPartIndex++,b())return!0}return!1}}class Hp{constructor(o,h,g,x,b,A,M,P){this.placement=new Qh(o,b,A,M,P),this._currentPlacementIndex=h.length-1,this._forceFullPlacement=g,this._showCollisionBoxes=x,this._done=!1}isDone(){return this._done}continuePlacement(o,h,g){const x=a.exported.now(),b=()=>{const A=a.exported.now()-x;return!this._forceFullPlacement&&A>2};for(;this._currentPlacementIndex>=0;){const A=h[o[this._currentPlacementIndex]],M=this.placement.collisionIndex.transform.zoom;if(A.type==="symbol"&&(!A.minzoom||A.minzoom<=M)&&(!A.maxzoom||A.maxzoom>M)){if(this._inProgressLayer||(this._inProgressLayer=new Qa(A)),this._inProgressLayer.continuePlacement(g[A.source],this.placement,this._showCollisionBoxes,A,b))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(o){return this.placement.commit(o),this.placement}}const Uc=512/a.EXTENT/2;class Oo{constructor(o,h,g){this.tileID=o,this.indexedSymbolInstances={},this.bucketInstanceId=g;for(let x=0;x<h.length;x++){const b=h.get(x),A=b.key;this.indexedSymbolInstances[A]||(this.indexedSymbolInstances[A]=[]),this.indexedSymbolInstances[A].push({crossTileID:b.crossTileID,coord:this.getScaledCoordinates(b,o)})}}getScaledCoordinates(o,h){const g=Uc/Math.pow(2,h.canonical.z-this.tileID.canonical.z);return{x:Math.floor((h.canonical.x*a.EXTENT+o.tileAnchorX)*g),y:Math.floor((h.canonical.y*a.EXTENT+o.tileAnchorY)*g)}}findMatches(o,h,g){const x=this.tileID.canonical.z<h.canonical.z?1:Math.pow(2,this.tileID.canonical.z-h.canonical.z);for(let b=0;b<o.length;b++){const A=o.get(b);if(A.crossTileID)continue;const M=this.indexedSymbolInstances[A.key];if(!M)continue;const P=this.getScaledCoordinates(A,h);for(const k of M)if(Math.abs(k.coord.x-P.x)<=x&&Math.abs(k.coord.y-P.y)<=x&&!g[k.crossTileID]){g[k.crossTileID]=!0,A.crossTileID=k.crossTileID;break}}}}class Xp{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ed{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(o){const h=Math.round((o-this.lng)/360);if(h!==0)for(const g in this.indexes){const x=this.indexes[g],b={};for(const A in x){const M=x[A];M.tileID=M.tileID.unwrapTo(M.tileID.wrap+h),b[M.tileID.key]=M}this.indexes[g]=b}this.lng=o}addBucket(o,h,g){if(this.indexes[o.overscaledZ]&&this.indexes[o.overscaledZ][o.key]){if(this.indexes[o.overscaledZ][o.key].bucketInstanceId===h.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(o.overscaledZ,this.indexes[o.overscaledZ][o.key])}for(let b=0;b<h.symbolInstances.length;b++)h.symbolInstances.get(b).crossTileID=0;this.usedCrossTileIDs[o.overscaledZ]||(this.usedCrossTileIDs[o.overscaledZ]={});const x=this.usedCrossTileIDs[o.overscaledZ];for(const b in this.indexes){const A=this.indexes[b];if(Number(b)>o.overscaledZ)for(const M in A){const P=A[M];P.tileID.isChildOf(o)&&P.findMatches(h.symbolInstances,o,x)}else{const M=A[o.scaledTo(Number(b)).key];M&&M.findMatches(h.symbolInstances,o,x)}}for(let b=0;b<h.symbolInstances.length;b++){const A=h.symbolInstances.get(b);A.crossTileID||(A.crossTileID=g.generate(),x[A.crossTileID]=!0)}return this.indexes[o.overscaledZ]===void 0&&(this.indexes[o.overscaledZ]={}),this.indexes[o.overscaledZ][o.key]=new Oo(o,h.symbolInstances,h.bucketInstanceId),!0}removeBucketCrossTileIDs(o,h){for(const g in h.indexedSymbolInstances)for(const x of h.indexedSymbolInstances[g])delete this.usedCrossTileIDs[o][x.crossTileID]}removeStaleBuckets(o){let h=!1;for(const g in this.indexes){const x=this.indexes[g];for(const b in x)o[x[b].bucketInstanceId]||(this.removeBucketCrossTileIDs(g,x[b]),delete x[b],h=!0)}return h}}class ho{constructor(){this.layerIndexes={},this.crossTileIDs=new Xp,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(o,h,g,x){let b=this.layerIndexes[o.id];b===void 0&&(b=this.layerIndexes[o.id]=new ed);let A=!1;const M={};x.name!=="globe"&&b.handleWrapJump(g);for(const P of h){const k=P.getBucket(o);k&&o.id===k.layerIds[0]&&(k.bucketInstanceId||(k.bucketInstanceId=++this.maxBucketInstanceId),b.addBucket(P.tileID,k,this.crossTileIDs)&&(A=!0),M[k.bucketInstanceId]=!0)}return b.removeStaleBuckets(M)&&(A=!0),A}pruneUnusedLayers(o){const h={};o.forEach(g=>{h[g]=!0});for(const g in this.layerIndexes)h[g]||delete this.layerIndexes[g]}}const Dr=(p,o)=>a.emitValidationErrors(p,o&&o.filter(h=>h.identifier!=="source.canvas")),el=a.pick(Pt,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Vs=a.pick(Pt,["setCenter","setZoom","setBearing","setPitch"]),Vc={version:8,layers:[],sources:{}},tl={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class ss extends a.Evented{constructor(o,h={}){super(),this.map=o,this.dispatcher=new Ki(Mt(),this),this.imageManager=new ut,this.imageManager.setEventedParent(this),this.glyphManager=new a.GlyphManager(o._requestManager,h.localFontFamily?a.LocalGlyphMode.all:h.localIdeographFontFamily?a.LocalGlyphMode.ideographs:a.LocalGlyphMode.none,h.localFontFamily||h.localIdeographFontFamily),this.crossTileSymbolIndex=new ho,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new a.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",a.getReferrer());const g=this;this._rtlTextPluginCallback=ss.registerForPluginStateChange(x=>{g.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:x.pluginStatus,pluginURL:x.pluginURL},(b,A)=>{if(a.triggerPluginCompletionEvent(b),A&&A.every(M=>M))for(const M in g._sourceCaches){const P=g._sourceCaches[M],k=P.getSource().type;k!=="vector"&&k!=="geojson"||P.reload()}})}),this.on("data",x=>{if(x.dataType!=="source"||x.sourceDataType!=="metadata")return;const b=this.getSource(x.sourceId);if(b&&b.vectorLayerIds)for(const A in this._layers){const M=this._layers[A];M.source===b.id&&this._validateLayer(M)}})}loadURL(o,h={}){this.fire(new a.Event("dataloading",{dataType:"style"}));const g=typeof h.validate=="boolean"?h.validate:!a.isMapboxURL(o);o=this.map._requestManager.normalizeStyleURL(o,h.accessToken);const x=this.map._requestManager.transformRequest(o,a.ResourceType.Style);this._request=a.getJSON(x,(b,A)=>{this._request=null,b?this.fire(new a.ErrorEvent(b)):A&&this._load(A,g)})}loadJSON(o,h={}){this.fire(new a.Event("dataloading",{dataType:"style"})),this._request=a.exported.frame(()=>{this._request=null,this._load(o,h.validate!==!1)})}loadEmpty(){this.fire(new a.Event("dataloading",{dataType:"style"})),this._load(Vc,!1)}_updateLayerCount(o,h){const g=h?1:-1;o.is3D()&&(this._num3DLayers+=g),o.type==="circle"&&(this._numCircleLayers+=g),o.type==="symbol"&&(this._numSymbolLayers+=g)}_load(o,h){if(h&&Dr(this,a.validateStyle(o)))return;this._loaded=!0,this.stylesheet=a.clone$1(o),this._updateMapProjection();for(const x in o.sources)this.addSource(x,o.sources[x],{validate:!1});this._changed=!1,o.sprite?this._loadSprite(o.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(o.glyphs);const g=ii(this.stylesheet.layers);this._order=g.map(x=>x.id),this._layers={},this._serializedLayers={};for(let x of g)x=a.createStyleLayer(x),x.setEventedParent(this,{layer:{id:x.id}}),this._layers[x.id]=x,this._serializedLayers[x.id]=x.serialize(),this._updateLayerCount(x,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new Zt(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new a.Event("data",{dataType:"style"})),this.fire(new a.Event("style.load"))}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}setProjection(o){o?this.stylesheet.projection=o:delete this.stylesheet.projection,this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.stylesheet.projection)}_loadSprite(o){this._spriteRequest=function(h,g,x){let b,A,M;const P=a.exported.devicePixelRatio>1?"@2x":"";let k=a.getJSON(g.transformRequest(g.normalizeSpriteURL(h,P,".json"),a.ResourceType.SpriteJSON),(W,J)=>{k=null,M||(M=W,b=J,U())}),D=a.getImage(g.transformRequest(g.normalizeSpriteURL(h,P,".png"),a.ResourceType.SpriteImage),(W,J)=>{D=null,M||(M=W,A=J,U())});function U(){if(M)x(M);else if(b&&A){const W=a.exported.getImageData(A),J={};for(const X in b){const{width:ee,height:Y,x:q,y:ie,sdf:K,pixelRatio:he,stretchX:fe,stretchY:le,content:me}=b[X],Pe=new a.RGBAImage({width:ee,height:Y});a.RGBAImage.copy(W,Pe,{x:q,y:ie},{x:0,y:0},{width:ee,height:Y}),J[X]={data:Pe,pixelRatio:he,sdf:K,stretchX:fe,stretchY:le,content:me}}x(null,J)}}return{cancel(){k&&(k.cancel(),k=null),D&&(D.cancel(),D=null)}}}(o,this.map._requestManager,(h,g)=>{if(this._spriteRequest=null,h)this.fire(new a.ErrorEvent(h));else if(g)for(const x in g)this.imageManager.addImage(x,g[x]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new a.Event("data",{dataType:"style"}))})}_validateLayer(o){const h=this.getSource(o.source);if(!h)return;const g=o.sourceLayer;g&&(h.type==="geojson"||h.vectorLayerIds&&h.vectorLayerIds.indexOf(g)===-1)&&this.fire(new a.ErrorEvent(new Error(`Source layer "${g}" does not exist on source "${h.id}" as specified by style layer "${o.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const o in this._sourceCaches)if(!this._sourceCaches[o].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(o){const h=[];for(const g of o){const x=this._layers[g];x.type!=="custom"&&h.push(x.serialize())}return h}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const o in this._sourceCaches)if(this._sourceCaches[o].hasTransition())return!0;for(const o in this._layers)if(this._layers[o].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(o){return!!this.terrain&&tl[o.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(o){if(!this._loaded)return;const h=this._changed;if(this._changed){const x=Object.keys(this._updatedLayers),b=Object.keys(this._removedLayers);(x.length||b.length)&&this._updateWorkerLayers(x,b);for(const A in this._updatedSources){const M=this._updatedSources[A];M==="reload"?this._reloadSource(A):M==="clear"&&this._clearSource(A)}this._updateTilesForChangedImages();for(const A in this._updatedPaintProps)this._layers[A].updateTransitions(o);this.light.updateTransitions(o),this.fog&&this.fog.updateTransitions(o),this._resetUpdates()}const g={};for(const x in this._sourceCaches){const b=this._sourceCaches[x];g[x]=b.used,b.used=!1}for(const x of this._order){const b=this._layers[x];if(b.recalculate(o,this._availableImages),!b.isHidden(o.zoom)){const M=this._getLayerSourceCache(b);M&&(M.used=!0)}const A=this.map.painter;if(A){const M=b.getProgramIds();if(!M)continue;const P=b.getProgramConfiguration(o.zoom);for(const k of M)A.useProgram(k,P)}}for(const x in g){const b=this._sourceCaches[x];g[x]!==b.used&&b.getSource().fire(new a.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:b.getSource().id}))}this.light.recalculate(o),this.terrain&&this.terrain.recalculate(o),this.fog&&this.fog.recalculate(o),this.z=o.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),h&&this.fire(new a.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const o=Object.keys(this._changedImages);if(o.length){for(const h in this._sourceCaches)this._sourceCaches[h].reloadTilesForDependencies(["icons","patterns"],o);this._changedImages={}}}_updateWorkerLayers(o,h){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(o),removedIds:h})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(o){if(this._checkLoaded(),Dr(this,a.validateStyle(o)))return!1;(o=a.clone$1(o)).layers=ii(o.layers);const h=function(x,b){if(!x)return[{command:Pt.setStyle,args:[b]}];let A=[];try{if(!E(x.version,b.version))return[{command:Pt.setStyle,args:[b]}];E(x.center,b.center)||A.push({command:Pt.setCenter,args:[b.center]}),E(x.zoom,b.zoom)||A.push({command:Pt.setZoom,args:[b.zoom]}),E(x.bearing,b.bearing)||A.push({command:Pt.setBearing,args:[b.bearing]}),E(x.pitch,b.pitch)||A.push({command:Pt.setPitch,args:[b.pitch]}),E(x.sprite,b.sprite)||A.push({command:Pt.setSprite,args:[b.sprite]}),E(x.glyphs,b.glyphs)||A.push({command:Pt.setGlyphs,args:[b.glyphs]}),E(x.transition,b.transition)||A.push({command:Pt.setTransition,args:[b.transition]}),E(x.light,b.light)||A.push({command:Pt.setLight,args:[b.light]}),E(x.fog,b.fog)||A.push({command:Pt.setFog,args:[b.fog]}),E(x.projection,b.projection)||A.push({command:Pt.setProjection,args:[b.projection]});const M={},P=[];(function(U,W,J,X){let ee;for(ee in W=W||{},U=U||{})U.hasOwnProperty(ee)&&(W.hasOwnProperty(ee)||Xe(ee,J,X));for(ee in W)W.hasOwnProperty(ee)&&(U.hasOwnProperty(ee)?E(U[ee],W[ee])||(U[ee].type==="geojson"&&W[ee].type==="geojson"&&It(U,W,ee)?J.push({command:Pt.setGeoJSONSourceData,args:[ee,W[ee].data]}):pt(ee,W,J,X)):We(ee,W,J))})(x.sources,b.sources,P,M);const k=[];x.layers&&x.layers.forEach(U=>{U.source&&M[U.source]?A.push({command:Pt.removeLayer,args:[U.id]}):k.push(U)});let D=x.terrain;D&&M[D.source]&&(A.push({command:Pt.setTerrain,args:[void 0]}),D=void 0),A=A.concat(P),E(D,b.terrain)||A.push({command:Pt.setTerrain,args:[b.terrain]}),function(U,W,J){W=W||[];const X=(U=U||[]).map(Qt),ee=W.map(Qt),Y=U.reduce($t,{}),q=W.reduce($t,{}),ie=X.slice(),K=Object.create(null);let he,fe,le,me,Pe,ze,ke;for(he=0,fe=0;he<X.length;he++)le=X[he],q.hasOwnProperty(le)?fe++:(J.push({command:Pt.removeLayer,args:[le]}),ie.splice(ie.indexOf(le,fe),1));for(he=0,fe=0;he<ee.length;he++)le=ee[ee.length-1-he],ie[ie.length-1-he]!==le&&(Y.hasOwnProperty(le)?(J.push({command:Pt.removeLayer,args:[le]}),ie.splice(ie.lastIndexOf(le,ie.length-fe),1)):fe++,ze=ie[ie.length-he],J.push({command:Pt.addLayer,args:[q[le],ze]}),ie.splice(ie.length-he,0,le),K[le]=!0);for(he=0;he<ee.length;he++)if(le=ee[he],me=Y[le],Pe=q[le],!K[le]&&!E(me,Pe))if(E(me.source,Pe.source)&&E(me["source-layer"],Pe["source-layer"])&&E(me.type,Pe.type)){for(ke in Me(me.layout,Pe.layout,J,le,null,Pt.setLayoutProperty),Me(me.paint,Pe.paint,J,le,null,Pt.setPaintProperty),E(me.filter,Pe.filter)||J.push({command:Pt.setFilter,args:[le,Pe.filter]}),E(me.minzoom,Pe.minzoom)&&E(me.maxzoom,Pe.maxzoom)||J.push({command:Pt.setLayerZoomRange,args:[le,Pe.minzoom,Pe.maxzoom]}),me)me.hasOwnProperty(ke)&&ke!=="layout"&&ke!=="paint"&&ke!=="filter"&&ke!=="metadata"&&ke!=="minzoom"&&ke!=="maxzoom"&&(ke.indexOf("paint.")===0?Me(me[ke],Pe[ke],J,le,ke.slice(6),Pt.setPaintProperty):E(me[ke],Pe[ke])||J.push({command:Pt.setLayerProperty,args:[le,ke,Pe[ke]]}));for(ke in Pe)Pe.hasOwnProperty(ke)&&!me.hasOwnProperty(ke)&&ke!=="layout"&&ke!=="paint"&&ke!=="filter"&&ke!=="metadata"&&ke!=="minzoom"&&ke!=="maxzoom"&&(ke.indexOf("paint.")===0?Me(me[ke],Pe[ke],J,le,ke.slice(6),Pt.setPaintProperty):E(me[ke],Pe[ke])||J.push({command:Pt.setLayerProperty,args:[le,ke,Pe[ke]]}))}else J.push({command:Pt.removeLayer,args:[le]}),ze=ie[ie.lastIndexOf(le)+1],J.push({command:Pt.addLayer,args:[Pe,ze]})}(k,b.layers,A)}catch(M){console.warn("Unable to compute style diff:",M),A=[{command:Pt.setStyle,args:[b]}]}return A}(this.serialize(),o).filter(x=>!(x.command in Vs));if(h.length===0)return!1;const g=h.filter(x=>!(x.command in el));if(g.length>0)throw new Error(`Unimplemented: ${g.map(x=>x.command).join(", ")}.`);return h.forEach(x=>{x.command!=="setTransition"&&x.command!=="setProjection"&&this[x.command].apply(this,x.args)}),this.stylesheet=o,this._updateMapProjection(),!0}addImage(o,h){return this.getImage(o)?this.fire(new a.ErrorEvent(new Error("An image with this name already exists."))):(this.imageManager.addImage(o,h),this._afterImageUpdated(o),this)}updateImage(o,h){this.imageManager.updateImage(o,h)}getImage(o){return this.imageManager.getImage(o)}removeImage(o){return this.getImage(o)?(this.imageManager.removeImage(o),this._afterImageUpdated(o),this):this.fire(new a.ErrorEvent(new Error("No image with this name exists.")))}_afterImageUpdated(o){this._availableImages=this.imageManager.listImages(),this._changedImages[o]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new a.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(o,h,g={}){if(this._checkLoaded(),this.getSource(o)!==void 0)throw new Error("There is already a source with this ID");if(!h.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(h).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(h.type)>=0&&this._validate(a.validateSource,`sources.${o}`,h,null,g))return;this.map&&this.map._collectResourceTiming&&(h.collectResourceTiming=!0);const x=Te(o,h,this.dispatcher,this);x.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(o),source:x.serialize(),sourceId:o}));const b=A=>{const M=(A?"symbol:":"other:")+o,P=this._sourceCaches[M]=new a.SourceCache(M,x,A);(A?this._symbolSourceCaches:this._otherSourceCaches)[o]=P,P.style=this,P.onAdd(this.map)};b(!1),h.type!=="vector"&&h.type!=="geojson"||b(!0),x.onAdd&&x.onAdd(this.map),this._changed=!0}removeSource(o){this._checkLoaded();const h=this.getSource(o);if(!h)throw new Error("There is no source with this ID");for(const x in this._layers)if(this._layers[x].source===o)return this.fire(new a.ErrorEvent(new Error(`Source "${o}" cannot be removed while layer "${x}" is using it.`)));if(this.terrain&&this.terrain.get().source===o)return this.fire(new a.ErrorEvent(new Error(`Source "${o}" cannot be removed while terrain is using it.`)));const g=this._getSourceCaches(o);for(const x of g)delete this._sourceCaches[x.id],delete this._updatedSources[x.id],x.fire(new a.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:x.getSource().id})),x.setEventedParent(null),x.clearTiles();return delete this._otherSourceCaches[o],delete this._symbolSourceCaches[o],h.setEventedParent(null),h.onRemove&&h.onRemove(this.map),this._changed=!0,this}setGeoJSONSourceData(o,h){this._checkLoaded(),this.getSource(o).setData(h),this._changed=!0}getSource(o){const h=this._getSourceCache(o);return h&&h.getSource()}_getSources(){const o=[];for(const h in this._otherSourceCaches){const g=this._getSourceCache(h);g&&o.push(g.getSource())}return o}addLayer(o,h,g={}){this._checkLoaded();const x=o.id;if(this.getLayer(x))return void this.fire(new a.ErrorEvent(new Error(`Layer with id "${x}" already exists on this map`)));let b;if(o.type==="custom"){if(Dr(this,a.validateCustomStyleLayer(o)))return;b=a.createStyleLayer(o)}else{if(typeof o.source=="object"&&(this.addSource(x,o.source),o=a.clone$1(o),o=a.extend(o,{source:x})),this._validate(a.validateLayer,`layers.${x}`,o,{arrayIndex:-1},g))return;b=a.createStyleLayer(o),this._validateLayer(b),b.setEventedParent(this,{layer:{id:x}}),this._serializedLayers[b.id]=b.serialize(),this._updateLayerCount(b,!0)}const A=h?this._order.indexOf(h):this._order.length;if(h&&A===-1)return void this.fire(new a.ErrorEvent(new Error(`Layer with id "${h}" does not exist on this map.`)));this._order.splice(A,0,x),this._layerOrderChanged=!0,this._layers[x]=b;const M=this._getLayerSourceCache(b);if(this._removedLayers[x]&&b.source&&M&&b.type!=="custom"){const P=this._removedLayers[x];delete this._removedLayers[x],P.type!==b.type?this._updatedSources[b.source]="clear":(this._updatedSources[b.source]="reload",M.pause())}this._updateLayer(b),b.onAdd&&b.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(o,h){if(this._checkLoaded(),this._changed=!0,!this._layers[o])return void this.fire(new a.ErrorEvent(new Error(`The layer '${o}' does not exist in the map's style and cannot be moved.`)));if(o===h)return;const g=this._order.indexOf(o);this._order.splice(g,1);const x=h?this._order.indexOf(h):this._order.length;h&&x===-1?this.fire(new a.ErrorEvent(new Error(`Layer with id "${h}" does not exist on this map.`))):(this._order.splice(x,0,o),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(o){this._checkLoaded();const h=this._layers[o];if(!h)return void this.fire(new a.ErrorEvent(new Error(`The layer '${o}' does not exist in the map's style and cannot be removed.`)));h.setEventedParent(null),this._updateLayerCount(h,!1);const g=this._order.indexOf(o);this._order.splice(g,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[o]=h,delete this._layers[o],delete this._serializedLayers[o],delete this._updatedLayers[o],delete this._updatedPaintProps[o],h.onRemove&&h.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(o){return this._layers[o]}hasLayer(o){return o in this._layers}hasLayerType(o){for(const h in this._layers)if(this._layers[h].type===o)return!0;return!1}setLayerZoomRange(o,h,g){this._checkLoaded();const x=this.getLayer(o);x?x.minzoom===h&&x.maxzoom===g||(h!=null&&(x.minzoom=h),g!=null&&(x.maxzoom=g),this._updateLayer(x)):this.fire(new a.ErrorEvent(new Error(`The layer '${o}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(o,h,g={}){this._checkLoaded();const x=this.getLayer(o);if(x){if(!E(x.filter,h))return h==null?(x.filter=void 0,void this._updateLayer(x)):void(this._validate(a.validateFilter,`layers.${x.id}.filter`,h,{layerType:x.type},g)||(x.filter=a.clone$1(h),this._updateLayer(x)))}else this.fire(new a.ErrorEvent(new Error(`The layer '${o}' does not exist in the map's style and cannot be filtered.`)))}getFilter(o){const h=this.getLayer(o);return h&&a.clone$1(h.filter)}setLayoutProperty(o,h,g,x={}){this._checkLoaded();const b=this.getLayer(o);b?E(b.getLayoutProperty(h),g)||(b.setLayoutProperty(h,g,x),this._updateLayer(b)):this.fire(new a.ErrorEvent(new Error(`The layer '${o}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(o,h){const g=this.getLayer(o);if(g)return g.getLayoutProperty(h);this.fire(new a.ErrorEvent(new Error(`The layer '${o}' does not exist in the map's style.`)))}setPaintProperty(o,h,g,x={}){this._checkLoaded();const b=this.getLayer(o);b?E(b.getPaintProperty(h),g)||(b.setPaintProperty(h,g,x)&&this._updateLayer(b),this._changed=!0,this._updatedPaintProps[o]=!0):this.fire(new a.ErrorEvent(new Error(`The layer '${o}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(o,h){const g=this.getLayer(o);return g&&g.getPaintProperty(h)}setFeatureState(o,h){this._checkLoaded();const g=o.source,x=o.sourceLayer,b=this.getSource(g);if(!b)return void this.fire(new a.ErrorEvent(new Error(`The source '${g}' does not exist in the map's style.`)));const A=b.type;if(A==="geojson"&&x)return void this.fire(new a.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(A==="vector"&&!x)return void this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));o.id===void 0&&this.fire(new a.ErrorEvent(new Error("The feature id parameter must be provided.")));const M=this._getSourceCaches(g);for(const P of M)P.setFeatureState(x,o.id,h)}removeFeatureState(o,h){this._checkLoaded();const g=o.source,x=this.getSource(g);if(!x)return void this.fire(new a.ErrorEvent(new Error(`The source '${g}' does not exist in the map's style.`)));const b=x.type,A=b==="vector"?o.sourceLayer:void 0;if(b==="vector"&&!A)return void this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(h&&typeof o.id!="string"&&typeof o.id!="number")return void this.fire(new a.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const M=this._getSourceCaches(g);for(const P of M)P.removeFeatureState(A,o.id,h)}getFeatureState(o){this._checkLoaded();const h=o.source,g=o.sourceLayer,x=this.getSource(h);if(x){if(x.type!=="vector"||g)return o.id===void 0&&this.fire(new a.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(h)[0].getFeatureState(g,o.id);this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new a.ErrorEvent(new Error(`The source '${h}' does not exist in the map's style.`)))}getTransition(){return a.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const o={};for(const h in this._sourceCaches){const g=this._sourceCaches[h].getSource();o[g.id]||(o[g.id]=g.serialize())}return a.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.getTerrain()||void 0,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:o,layers:this._serializeLayers(this._order)},h=>h!==void 0)}_updateLayer(o){this._updatedLayers[o.id]=!0;const h=this._getLayerSourceCache(o);o.source&&!this._updatedSources[o.source]&&h&&h.getSource().type!=="raster"&&(this._updatedSources[o.source]="reload",h.pause()),this._changed=!0,o.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(o){const h=A=>this._layers[A].type==="fill-extrusion",g={},x=[];for(let A=this._order.length-1;A>=0;A--){const M=this._order[A];if(h(M)){g[M]=A;for(const P of o){const k=P[M];if(k)for(const D of k)x.push(D)}}}x.sort((A,M)=>M.intersectionZ-A.intersectionZ);const b=[];for(let A=this._order.length-1;A>=0;A--){const M=this._order[A];if(h(M))for(let P=x.length-1;P>=0;P--){const k=x[P].feature;if(g[k.layer.id]<A)break;b.push(k),x.pop()}else for(const P of o){const k=P[M];if(k)for(const D of k)b.push(D.feature)}}return b}queryRenderedFeatures(o,h,g){h&&h.filter&&this._validate(a.validateFilter,"queryRenderedFeatures.filter",h.filter,null,h);const x={};if(h&&h.layers){if(!Array.isArray(h.layers))return this.fire(new a.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const P of h.layers){const k=this._layers[P];if(!k)return this.fire(new a.ErrorEvent(new Error(`The layer '${P}' does not exist in the map's style and cannot be queried for features.`))),[];x[k.source]=!0}}const b=[];h.availableImages=this._availableImages;const A=h&&h.layers?h.layers.some(P=>{const k=this.getLayer(P);return k&&k.is3D()}):this.has3DLayers(),M=Xr.createFromScreenPoints(o,g);for(const P in this._sourceCaches){const k=this._sourceCaches[P].getSource().id;h.layers&&!x[k]||b.push(Se(this._sourceCaches[P],this._layers,this._serializedLayers,M,h,g,A,!!this.map._showQueryGeometry))}return this.placement&&b.push(function(P,k,D,U,W,J,X){const ee={},Y=J.queryRenderedSymbols(U),q=[];for(const ie of Object.keys(Y).map(Number))q.push(X[ie]);q.sort(st);for(const ie of q){const K=ie.featureIndex.lookupSymbolFeatures(Y[ie.bucketInstanceId],k,ie.bucketIndex,ie.sourceLayerIndex,W.filter,W.layers,W.availableImages,P);for(const he in K){const fe=ee[he]=ee[he]||[],le=K[he];le.sort((me,Pe)=>{const ze=ie.featureSortOrder;if(ze){const ke=ze.indexOf(me.featureIndex);return ze.indexOf(Pe.featureIndex)-ke}return Pe.featureIndex-me.featureIndex});for(const me of le)fe.push(me)}}for(const ie in ee)ee[ie].forEach(K=>{const he=K.feature,fe=D(P[ie]).getFeatureState(he.layer["source-layer"],he.id);he.source=he.layer.source,he.layer["source-layer"]&&(he.sourceLayer=he.layer["source-layer"]),he.state=fe});return ee}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),M.screenGeometry,h,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(b)}querySourceFeatures(o,h){h&&h.filter&&this._validate(a.validateFilter,"querySourceFeatures.filter",h.filter,null,h);const g=this._getSourceCaches(o);let x=[];for(const b of g)x=x.concat(Ge(b,h));return x}addSourceType(o,h,g){return ss.getSourceType(o)?g(new Error(`A source type called "${o}" already exists.`)):(ss.setSourceType(o,h),h.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:o,url:h.workerSourceURL},g):g(null,null))}getLight(){return this.light.getLight()}setLight(o,h={}){this._checkLoaded();const g=this.light.getLight();let x=!1;for(const A in o)if(!E(o[A],g[A])){x=!0;break}if(!x)return;const b=this._setTransitionParameters({duration:300,delay:0});this.light.setLight(o,h),this.light.updateTransitions(b)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(o,h=1){if(this._checkLoaded(),!o)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(h===1){if(typeof o.source=="object"){const g="terrain-dem-src";this.addSource(g,o.source),o=a.clone$1(o),o=a.extend(o,{source:g})}if(this._validate(a.validateTerrain,"terrain",o))return}if(!this.terrain||this.terrain&&h!==this.terrain.drapeRenderMode)this._createTerrain(o,h);else{const g=this.terrain,x=g.get();for(const b of Object.keys(a.spec.terrain))!o.hasOwnProperty(b)&&a.spec.terrain[b].default&&(o[b]=a.spec.terrain[b].default);for(const b in o)if(!E(o[b],x[b])){g.set(o),this.stylesheet.terrain=o;const A=this._setTransitionParameters({duration:0});g.updateTransitions(A);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(o){const h=this.fog=new ur(o,this.map.transform);this.stylesheet.fog=o;const g=this._setTransitionParameters({duration:0});h.updateTransitions(g)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const o of this.map._markers)o._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(o){if(this._checkLoaded(),!o)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const h=this.fog,g=h.get();Object.keys(o).length===0&&h.set(o);for(const x in o)if(!E(o[x],g[x])){h.set(o),this.stylesheet.fog=o;const b=this._setTransitionParameters({duration:0});h.updateTransitions(b);break}}else this._createFog(o);this._markersNeedUpdate=!0}_setTransitionParameters(o){return{now:a.exported.now(),transition:a.extend(o,this.stylesheet.transition)}}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const o=this._order.filter(g=>this.isLayerDraped(this._layers[g])),h=this._order.filter(g=>!this.isLayerDraped(this._layers[g]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...o),this._drapedFirstOrder.push(...h)}_createTerrain(o,h){const g=this.terrain=new fn(o,h);this.stylesheet.terrain=o,this.dispatcher.broadcast("enableTerrain",!this.terrainSetForDrapingOnly()),this._force3DLayerUpdate();const x=this._setTransitionParameters({duration:0});g.updateTransitions(x)}_force3DLayerUpdate(){for(const o in this._layers){const h=this._layers[o];h.type==="fill-extrusion"&&this._updateLayer(h)}}_forceSymbolLayerUpdate(){for(const o in this._layers){const h=this._layers[o];h.type==="symbol"&&this._updateLayer(h)}}_validate(o,h,g,x,b={}){return(!b||b.validate!==!1)&&Dr(this,o.call(a.validateStyle,a.extend({key:h,style:this.serialize(),value:g,styleSpec:a.spec},x)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),a.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const o in this._layers)this._layers[o].setEventedParent(null);for(const o in this._sourceCaches)this._sourceCaches[o].clearTiles(),this._sourceCaches[o].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(o){const h=this._getSourceCaches(o);for(const g of h)g.clearTiles()}_reloadSource(o){const h=this._getSourceCaches(o);for(const g of h)g.resume(),g.reload()}_reloadSources(){for(const o of this._getSources())o.reload&&o.reload()}_updateSources(o){for(const h in this._sourceCaches)this._sourceCaches[h].update(o)}_generateCollisionBoxes(){for(const o in this._sourceCaches){const h=this._sourceCaches[o];h.resume(),h.reload()}}_updatePlacement(o,h,g,x,b=!1){let A=!1,M=!1;const P={};for(const k of this._order){const D=this._layers[k];if(D.type!=="symbol")continue;if(!P[D.source]){const W=this._getLayerSourceCache(D);if(!W)continue;P[D.source]=W.getRenderableIds(!0).map(J=>W.getTileByID(J)).sort((J,X)=>X.tileID.overscaledZ-J.tileID.overscaledZ||(J.tileID.isLessThan(X.tileID)?-1:1))}const U=this.crossTileSymbolIndex.addLayer(D,P[D.source],o.center.lng,o.projection);A=A||U}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),b=b||this._layerOrderChanged||g===0,this._layerOrderChanged&&this.fire(new a.Event("neworder")),(b||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(a.exported.now(),o.zoom))&&(this.pauseablePlacement=new Hp(o,this._order,b,h,g,x,this.placement,this.fog&&o.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,P),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(a.exported.now()),M=!0),A&&this.pauseablePlacement.placement.setStale()),M||A)for(const k of this._order){const D=this._layers[k];D.type==="symbol"&&this.placement.updateLayerOpacities(D,P[D.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(a.exported.now())}_releaseSymbolFadeTiles(){for(const o in this._sourceCaches)this._sourceCaches[o].releaseSymbolFadeTiles()}getImages(o,h,g){this.imageManager.getImages(h.icons,g),this._updateTilesForChangedImages();const x=b=>{b&&b.setDependencies(h.tileID.key,h.type,h.icons)};x(this._otherSourceCaches[h.source]),x(this._symbolSourceCaches[h.source])}getGlyphs(o,h,g){this.glyphManager.getGlyphs(h.stacks,g)}getResource(o,h,g){return a.makeRequest(h,g)}_getSourceCache(o){return this._otherSourceCaches[o]}_getLayerSourceCache(o){return o.type==="symbol"?this._symbolSourceCaches[o.source]:this._otherSourceCaches[o.source]}_getSourceCaches(o){const h=[];return this._otherSourceCaches[o]&&h.push(this._otherSourceCaches[o]),this._symbolSourceCaches[o]&&h.push(this._symbolSourceCaches[o]),h}_isSourceCacheLoaded(o){const h=this._getSourceCaches(o);return h.length===0?(this.fire(new a.ErrorEvent(new Error(`There is no source with ID '${o}'`))),!1):h.every(g=>g.loaded())}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}ss.getSourceType=function(p){return Ae[p]},ss.setSourceType=function(p,o){Ae[p]=o},ss.registerForPluginStateChange=a.registerForPluginStateChange;var td=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#define HALF_PI PI/2.0
#define QUARTER_PI PI/4.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0`,il="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",id=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,jc=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,nd=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump float u_fog_temporal_offset;varying vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`;let Gc={},Wc={};const fo=[];os(td,fo),os(id,fo),os(jc,fo),os(nd,fo),Gc=ui("",id),Wc=ui(nd,jc);const Zc=ui(`
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}`,`
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),$c=td,nl=`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`;var qc={background:ui(`uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:ui(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:ui(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:ui("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ui(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:ui(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:ui("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:ui("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:ui("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:ui(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:ui(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:ui(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:ui(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:ui(`varying vec4 v_color;
#ifdef RENDER_SHADOWS
varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#ifdef ZERO_ROOF_RADIUS
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
varying highp vec3 v_normal;
#endif
void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
vec3 normal=v_normal;
#endif
float z;vec4 color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);color=mix(v_color,v_roof_color,z);
#else
color=v_color;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);color.rgb=color.rgb*shade;
#endif
#ifdef RENDER_SHADOWS
#ifdef ZERO_ROOF_RADIUS
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#endif
color.xyz=shadowed_color_normal(color.xyz,normalize(normal),v_pos_light_view_0,v_pos_light_view_1,v_depth);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec4 v_color;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
#ifdef ZERO_ROOF_RADIUS
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
varying highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
v_normal=normal;
#endif
base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
v_pos_light_view_0=u_light_matrix_0*vec4(pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1);v_depth=gl_Position.w;
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);directional*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#ifdef ZERO_ROOF_RADIUS
v_roof_color=vec4(0.0,0.0,0.0,1.0);float roof_radiance=clamp(u_lightpos.z,0.0,1.0);roof_radiance=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roof_radiance);v_roof_color.rgb+=clamp(color.rgb*roof_radiance*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:ui(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);directional*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:ui(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ui(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:ui(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
uniform float u_border_width;uniform vec4 u_border_color;float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
#ifdef RENDER_LINE_GRADIENT
highp vec4 out_color=texture2D(u_gradient_image,v_uv.xy);
#else
vec4 out_color=color;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);}}
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
#ifdef RENDER_LINE_BORDER
float edgeBlur=(u_border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);
#ifdef RENDER_LINE_BORDER_AUTO
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}
#else
out_color.rgb=mix(u_border_color.rgb,out_color.rgb,smoothAlpha);
#endif
}
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
attribute highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:ui(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:ui(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:ui(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:ui(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:ui(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:ui(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef RENDER_SHADOWS
color.xyz=shadowed_color(color.xyz,v_pos_light_view_0,v_pos_light_view_1,v_depth);
#endif
#ifdef FOG
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
const float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=u_skirt_height*u_skirt_height*wireframeOffset;
#endif
vec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;
#endif
}`),terrainDepth:ui(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:ui(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,il),skyboxGradient:ui(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,il),skyboxCapture:ui(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:ui(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture2D(u_image0,v_pos0);color=vec4(raster.rgb*antialias,raster.a*antialias);
#else
color=texture2D(u_image0,v_pos0);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;
#ifdef GLOBE_POLES
attribute vec3 a_globe_pos;attribute vec2 a_uv;
#else
attribute vec2 a_pos;
#endif
varying vec2 v_pos0;const float wireframeOffset=1e3;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 latLng=u_grid_matrix*vec3(a_pos,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;
#ifdef GLOBE_POLES
vec3 up_vector=normalize(globe_pos)*u_tile_up_scale;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);
#ifdef TERRAIN_WIREFRAME
height+=wireframeOffset;
#endif
globe_pos+=up_vector*height;
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:ui(`uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec3 u_start_color;uniform vec4 u_color;uniform vec4 u_space_color;uniform vec4 u_high_color;uniform float u_star_intensity;uniform float u_star_size;uniform float u_star_density;uniform float u_horizon_angle;uniform mat4 u_rotation_matrix;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;highp float random(highp vec3 p) {p=fract(p*vec3(23.2342,97.1231,91.2342));p+=dot(p.zxy,p.yxz+123.1234);return fract(p.x*p.y);}float stars(vec3 p,float scale,vec2 offset) {vec2 uv_scale=(u_viewport/u_star_size)*scale;vec3 position=vec3(p.xy*uv_scale+offset*u_viewport,p.z);vec3 q=fract(position)-0.5;vec3 id=floor(position);float random_visibility=step(random(id),u_star_density);float circle=smoothstep(0.5+u_star_intensity,0.5,length(q));return circle*random_visibility;}void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {discard;return;}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(dot(dir,horizon_dir)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;float closest_point_to_center=length(closest_point-u_globe_pos);float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c =mix(color_stop_2,c2,t);float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);vec2 uv=gl_FragCoord.xy/u_viewport-0.5;float aspect_ratio=u_viewport.x/u_viewport.y;vec4 uv_dir=vec4(normalize(vec3(uv.x*aspect_ratio,uv.y,1.0)),1.0);uv_dir=u_rotation_matrix*uv_dir;vec3 n=abs(uv_dir.xyz);vec2 uv_remap=(n.x > n.y && n.x > n.z) ? uv_dir.yz/uv_dir.x:
(n.y > n.x && n.y > n.z) ? uv_dir.zx/uv_dir.y:
uv_dir.xy/uv_dir.z;uv_remap.x/=aspect_ratio;vec3 D=vec3(uv_remap,1.0);highp float star_field=0.0;if (u_star_intensity > 0.0) {star_field+=stars(D,1.2,vec2(0.0,0.0));star_field+=stars(D,1.0,vec2(1.0,0.0));star_field+=stars(D,0.8,vec2(0.0,1.0));star_field+=stars(D,0.6,vec2(1.0,1.0));star_field*=(1.0-pow(t,0.25+(1.0-u_high_color.a)*0.75));c+=star_field*alpha_2;}c=dither(c,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=vec4(c,a);}`,`attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`)};function os(p,o){const h=p.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let g of h)if(g=g.trim(),g[0]==="#"&&g.includes("if")&&!g.includes("endif")){g=g.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const x=g.split(" ");for(const b of x)o.includes(b)||o.push(b)}}function ui(p,o){const h=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,g=o.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),x={},b=[...fo];return os(p,b),os(o,b),{fragmentSource:p=p.replace(h,(A,M,P,k,D)=>(x[D]=!0,M==="define"?`
#ifndef HAS_UNIFORM_u_${D}
varying ${P} ${k} ${D};
#else
uniform ${P} ${k} u_${D};
#endif
`:`
#ifdef HAS_UNIFORM_u_${D}
    ${P} ${k} ${D} = u_${D};
#endif
`)),vertexSource:o=o.replace(h,(A,M,P,k,D)=>{const U=k==="float"?"vec2":"vec4",W=D.match(/color/)?"color":U;return x[D]?M==="define"?`
#ifndef HAS_UNIFORM_u_${D}
uniform lowp float u_${D}_t;
attribute ${P} ${U} a_${D};
varying ${P} ${k} ${D};
#else
uniform ${P} ${k} u_${D};
#endif
`:W==="vec4"?`
#ifndef HAS_UNIFORM_u_${D}
    ${D} = a_${D};
#else
    ${P} ${k} ${D} = u_${D};
#endif
`:`
#ifndef HAS_UNIFORM_u_${D}
    ${D} = unpack_mix_${W}(a_${D}, u_${D}_t);
#else
    ${P} ${k} ${D} = u_${D};
#endif
`:M==="define"?`
#ifndef HAS_UNIFORM_u_${D}
uniform lowp float u_${D}_t;
attribute ${P} ${U} a_${D};
#else
uniform ${P} ${k} u_${D};
#endif
`:W==="vec4"?`
#ifndef HAS_UNIFORM_u_${D}
    ${P} ${k} ${D} = a_${D};
#else
    ${P} ${k} ${D} = u_${D};
#endif
`:`
#ifndef HAS_UNIFORM_u_${D}
    ${P} ${k} ${D} = unpack_mix_${W}(a_${D}, u_${D}_t);
#else
    ${P} ${k} ${D} = u_${D};
#endif
`}),staticAttributes:g,usedDefines:b}}class da{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(o,h,g,x,b,A,M){this.context=o;let P=this.boundPaintVertexBuffers.length!==x.length;for(let D=0;!P&&D<x.length;D++)this.boundPaintVertexBuffers[D]!==x[D]&&(P=!0);let k=this.boundDynamicVertexBuffers.length!==M.length;for(let D=0;!k&&D<M.length;D++)this.boundDynamicVertexBuffers[D]!==M[D]&&(k=!0);if(!o.extVertexArrayObject||!this.vao||this.boundProgram!==h||this.boundLayoutVertexBuffer!==g||P||k||this.boundIndexBuffer!==b||this.boundVertexOffset!==A)this.freshBind(h,g,x,b,A,M);else{o.bindVertexArrayOES.set(this.vao);for(const D of M)D&&D.bind();b&&b.dynamicDraw&&b.bind()}}freshBind(o,h,g,x,b,A){let M;const P=o.numAttributes,k=this.context,D=k.gl;if(k.extVertexArrayObject)this.vao&&this.destroy(),this.vao=k.extVertexArrayObject.createVertexArrayOES(),k.bindVertexArrayOES.set(this.vao),M=0,this.boundProgram=o,this.boundLayoutVertexBuffer=h,this.boundPaintVertexBuffers=g,this.boundIndexBuffer=x,this.boundVertexOffset=b,this.boundDynamicVertexBuffers=A;else{M=k.currentNumAttributes||0;for(let U=P;U<M;U++)D.disableVertexAttribArray(U)}h.enableAttributes(D,o),h.bind(),h.setVertexAttribPointers(D,o,b);for(const U of g)U.enableAttributes(D,o),U.bind(),U.setVertexAttribPointers(D,o,b);for(const U of A)U&&(U.enableAttributes(D,o),U.bind(),U.setVertexAttribPointers(D,o,b));x&&x.bind(),k.currentNumAttributes=P}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function rl(p,o){const h=Math.pow(2,o.canonical.z),g=o.canonical.y;return[new a.MercatorCoordinate(0,g/h).toLngLat().lat,new a.MercatorCoordinate(0,(g+1)/h).toLngLat().lat]}function sl(p,o,h,g,x,b,A){const M=p.context,P=M.gl,k=h.fbo;if(!k)return;p.prepareDrawTile();const D=p.useProgram("hillshade");M.activeTexture.set(P.TEXTURE0),P.bindTexture(P.TEXTURE_2D,k.colorAttachment.get());const U=((ee,Y,q,ie)=>{const K=q.paint.get("hillshade-shadow-color"),he=q.paint.get("hillshade-highlight-color"),fe=q.paint.get("hillshade-accent-color");let le=q.paint.get("hillshade-illumination-direction")*(Math.PI/180);q.paint.get("hillshade-illumination-anchor")==="viewport"&&(le-=ee.transform.angle);const me=!ee.options.moving;return{u_matrix:ie||ee.transform.calculateProjMatrix(Y.tileID.toUnwrapped(),me),u_image:0,u_latrange:rl(0,Y.tileID),u_light:[q.paint.get("hillshade-exaggeration"),le],u_shadow:K,u_highlight:he,u_accent:fe}})(p,h,g,p.terrain?o.projMatrix:null);p.prepareDrawProgram(M,D,o.toUnwrapped());const{tileBoundsBuffer:W,tileBoundsIndexBuffer:J,tileBoundsSegments:X}=p.getTileBoundsBuffers(h);D.draw(M,P.TRIANGLES,x,b,A,a.CullFaceMode.disabled,U,g.id,W,J,X)}function ol(p,o,h){if(!o.needsDEMTextureUpload)return;const g=p.context,x=g.gl;g.pixelStoreUnpackPremultiplyAlpha.set(!1),o.demTexture=o.demTexture||p.getTileTexture(h.stride);const b=h.getPixels();o.demTexture?o.demTexture.update(b,{premultiply:!1}):o.demTexture=new a.Texture(g,b,x.RGBA,{premultiply:!1}),o.needsDEMTextureUpload=!1}function rd(p,o,h,g,x,b){const A=p.context,M=A.gl;if(!o.dem)return;const P=o.dem;if(A.activeTexture.set(M.TEXTURE1),ol(p,o,P),!o.demTexture)return;o.demTexture.bind(M.NEAREST,M.CLAMP_TO_EDGE);const k=P.dim;A.activeTexture.set(M.TEXTURE0);let D=o.fbo;if(!D){const X=new a.Texture(A,{width:k,height:k,data:null},M.RGBA);X.bind(M.LINEAR,M.CLAMP_TO_EDGE),D=o.fbo=A.createFramebuffer(k,k,!0),D.colorAttachment.set(X.texture)}A.bindFramebuffer.set(D.framebuffer),A.viewport.set([0,0,k,k]);const{tileBoundsBuffer:U,tileBoundsIndexBuffer:W,tileBoundsSegments:J}=p.getMercatorTileBoundsBuffers();p.useProgram("hillshadePrepare").draw(A,M.TRIANGLES,g,x,b,a.CullFaceMode.disabled,((X,ee)=>{const Y=ee.stride,q=a.create();return a.ortho(q,0,a.EXTENT,-a.EXTENT,0,0,1),a.translate(q,q,[0,-a.EXTENT,0]),{u_matrix:q,u_image:1,u_dimension:[Y,Y],u_zoom:X.overscaledZ,u_unpack:ee.unpackVector}})(o.tileID,P),h.id,U,W,J),o.needsHillshadePrepare=!1}const al=p=>({u_matrix:new a.UniformMatrix4f(p),u_image0:new a.Uniform1i(p),u_skirt_height:new a.Uniform1f(p)}),Hc=(p,o)=>({u_matrix:p,u_image0:0,u_skirt_height:o}),ll=(p,o,h,g,x,b,A,M,P,k,D,U,W,J)=>({u_proj_matrix:Float32Array.from(p),u_globe_matrix:o,u_normalize_matrix:Float32Array.from(g),u_merc_matrix:h,u_zoom_transition:x,u_merc_center:b,u_image0:0,u_frustum_tl:A,u_frustum_tr:M,u_frustum_br:P,u_frustum_bl:k,u_globe_pos:D,u_globe_radius:U,u_viewport:W,u_grid_matrix:J?Float32Array.from(J):new Float32Array(9)});function fa(p,o){return p!=null&&o!=null&&!(!p.hasData()||!o.hasData())&&p.demTexture!=null&&o.demTexture!=null&&p.tileID.key!==o.tileID.key}const js=new class{constructor(){this.operations={}}newMorphing(p,o,h,g,x){if(p in this.operations){const b=this.operations[p];b.to.tileID.key!==h.tileID.key&&(b.queued=h)}else this.operations[p]={startTime:g,phase:0,duration:x,from:o,to:h,queued:null}}getMorphValuesForProxy(p){if(!(p in this.operations))return null;const o=this.operations[p];return{from:o.from,to:o.to,phase:o.phase}}update(p){for(const o in this.operations){const h=this.operations[o];for(h.phase=(p-h.startTime)/h.duration;h.phase>=1||!this._validOp(h);)if(!this._nextOp(h,p)){delete this.operations[o];break}}}_nextOp(p,o){return!!p.queued&&(p.from=p.to,p.to=p.queued,p.queued=null,p.phase=0,p.startTime=o,!0)}_validOp(p){return p.from.hasData()&&p.to.hasData()}},Bo={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function ai(p,o){const h=1<<p.z;return!o&&(p.x===0||p.x===h-1)||p.y===0||p.y===h-1}const Fo=p=>({u_matrix:p});function Xc(p,o,h,g,x){if(x>0){const b=a.exported.now(),A=(b-p.timeAdded)/x,M=o?(b-o.timeAdded)/x:-1,P=h.getSource(),k=g.coveringZoomLevel({tileSize:P.tileSize,roundZoom:P.roundZoom}),D=!o||Math.abs(o.tileID.overscaledZ-k)>Math.abs(p.tileID.overscaledZ-k),U=D&&p.refreshedUponExpiration?1:a.clamp(D?A:1-M,0,1);return p.refreshedUponExpiration&&A>=1&&(p.refreshedUponExpiration=!1),o?{opacity:1,mix:1-U}:{opacity:U,mix:0}}return{opacity:1,mix:0}}class sd extends a.SourceCache{constructor(o){const h={type:"raster-dem",maxzoom:o.transform.maxZoom},g=new Ki(Mt(),null),x=Te("mock-dem",h,g,o.style);super("mock-dem",x,!1),x.setEventedParent(this),this._sourceLoaded=!0}_loadTile(o,h){o.state="loaded",h(null)}}class od extends a.SourceCache{constructor(o){const h=Te("proxy",{type:"geojson",maxzoom:o.transform.maxZoom},new Ki(Mt(),null),o.style);super("proxy",h,!1),h.setEventedParent(this),this.map=this.getSource().map=o,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(o,h,g){if(o.freezeTileCoverage)return;this.transform=o;const x=o.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((b,A)=>{if(b[A.key]="",!this._tiles[A.key]){const M=new a.Tile(A,this._source.tileSize*A.overscaleFactor(),o.tileZoom);M.state="loaded",this._tiles[A.key]=M}return b},{});for(const b in this._tiles)b in x||(this.freeFBO(b),this._tiles[b].unloadVectorData(),delete this._tiles[b])}freeFBO(o){const h=this.proxyCachedFBO[o];if(h!==void 0){const g=Object.values(h);this.renderCachePool.push(...g),delete this.proxyCachedFBO[o]}}deallocRenderCache(){this.renderCache.forEach(o=>o.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class cl extends a.OverscaledTileID{constructor(o,h,g){super(o.overscaledZ,o.wrap,o.canonical.z,o.canonical.x,o.canonical.y),this.proxyTileKey=h,this.projMatrix=g}}class ad extends a.Elevation{constructor(o,h){super(),this.painter=o,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[g,x,b]=function(P){const k=new a.StructArrayLayout4i8,D=new a.StructArrayLayout3ui6,U=131;k.reserve(17161),D.reserve(33800);const W=a.EXTENT/128,J=a.EXTENT+W/2,X=J+W;for(let Y=-W;Y<X;Y+=W)for(let q=-W;q<X;q+=W){const ie=q<0||q>J||Y<0||Y>J?24575:0,K=a.clamp(Math.round(q),0,a.EXTENT),he=a.clamp(Math.round(Y),0,a.EXTENT);k.emplaceBack(K+ie,he,K,he)}const ee=(Y,q)=>{const ie=q*U+Y;D.emplaceBack(ie+1,ie,ie+U),D.emplaceBack(ie+U,ie+U+1,ie+1)};for(let Y=1;Y<129;Y++)for(let q=1;q<129;q++)ee(q,Y);return[0,129].forEach(Y=>{for(let q=0;q<130;q++)ee(q,Y),ee(Y,q)}),[k,D,32768]}(),A=o.context;this.gridBuffer=A.createVertexBuffer(g,a.boundsAttributes.members),this.gridIndexBuffer=A.createIndexBuffer(x),this.gridSegments=a.SegmentVector.simpleSegment(0,0,g.length,x.length),this.gridNoSkirtSegments=a.SegmentVector.simpleSegment(0,0,g.length,b),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new od(h.map),this.orthoMatrix=a.create(),a.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,a.EXTENT,0,a.EXTENT,0,1);const M=A.gl;this._overlapStencilMode=new a.StencilMode({func:M.GEQUAL,mask:255},0,255,M.KEEP,M.KEEP,M.REPLACE),this._previousZoom=o.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=h,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new sd(h.map)}set style(o){o.on("data",this._onStyleDataEvent.bind(this)),o.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=o,this._checkRenderCacheEfficiency()}update(o,h,g){if(o&&o.terrain){this._style!==o&&(this.style=o),this.enabled=!0;const x=o.terrain.properties;this.sourceCache=o.terrain.drapeRenderMode===0?this._mockSourceCache:o._getSourceCache(x.get("source")),this._exaggeration=x.get("exaggeration");const b=()=>{this.sourceCache.used&&a.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const A=this.getScaledDemTileSize();this.sourceCache.update(h,A,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,b(),this._initializing=!0),b(),h.updateElevation(!g),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(h),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(o){this._findCoveringTileCache[o]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const o=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||o.efficiency!==100&&a.warnOnce(`Terrain render cache efficiency is not optimal (${o.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${o.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(o){o.coord&&o.dataType==="source"?this._clearRenderCacheForTile(o.sourceCacheId,o.coord):o.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const o in this._style._sourceCaches)this._style._sourceCaches[o].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(o=>o.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0)}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const o=2*this.proxySourceCache.getSource().tileSize;return[o,o]}set useVertexMorphing(o){this._useVertexMorphing=o}updateTileBinding(o){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const h=this.proxySourceCache,g=this.painter.transform;this._initializing&&(this._initializing=g._centerAltitude===0&&this.getAtPointOrZero(a.MercatorCoordinate.fromLngLat(g.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const x=this.proxyCoords=h.getIds().map(P=>{const k=h.getTileByID(P).tileID;return k.projMatrix=g.calculateProjMatrix(k.toUnwrapped()),k});(function(P,k){const D=k.transform.pointCoordinate(k.transform.getCameraPoint()),U=new a.pointGeometry(D.x,D.y);P.sort((W,J)=>{if(J.overscaledZ-W.overscaledZ)return J.overscaledZ-W.overscaledZ;const X=new a.pointGeometry(W.canonical.x+(1<<W.canonical.z)*W.wrap,W.canonical.y),ee=new a.pointGeometry(J.canonical.x+(1<<J.canonical.z)*J.wrap,J.canonical.y),Y=U.mult(1<<W.canonical.z);return Y.x-=.5,Y.y-=.5,Y.distSqr(X)-Y.distSqr(ee)})})(x,this.painter),this._previousZoom=g.zoom;const b=this.proxyToSource||{};this.proxyToSource={},x.forEach(P=>{this.proxyToSource[P.key]={}}),this.terrainTileForTile={};const A=this._style._sourceCaches;for(const P in A){const k=A[P];if(!k.used||(k!==this.sourceCache&&this.resetTileLookupCache(k.id),this._setupProxiedCoordsForOrtho(k,o[P],b),k.usedForTerrain))continue;const D=o[P];k.getSource().reparseOverscaled&&this._assignTerrainTiles(D)}this.proxiedCoords[h.id]=x.map(P=>new cl(P,P.key,this.orthoMatrix)),this._assignTerrainTiles(x),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(b),this.renderingToTexture=!1,this._updateTimestamp=a.exported.now();const M={};this._visibleDemTiles=[];for(const P of this.proxyCoords){const k=this.terrainTileForTile[P.key];if(!k)continue;const D=k.tileID.key;D in M||(this._visibleDemTiles.push(k),M[D]=D)}}_assignTerrainTiles(o){this._initializing||o.forEach(h=>{if(this.terrainTileForTile[h.key])return;const g=this._findTileCoveringTileID(h,this.sourceCache);g&&(this.terrainTileForTile[h.key]=g)})}_prepareDEMTextures(){const o=this.painter.context,h=o.gl;for(const g in this.terrainTileForTile){const x=this.terrainTileForTile[g],b=x.dem;!b||x.demTexture&&!x.needsDEMTextureUpload||(o.activeTexture.set(h.TEXTURE1),ol(this.painter,x,b))}}_prepareDemTileUniforms(o,h,g,x){if(!h||h.demTexture==null)return!1;const b=o.tileID.canonical,A=Math.pow(2,h.tileID.canonical.z-b.z),M=x||"";return g[`u_dem_tl${M}`]=[b.x*A%1,b.y*A%1],g[`u_dem_scale${M}`]=A,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const o=this.painter.context,h=o.gl;if(!this._emptyDepthBufferTexture){const g=new a.RGBAImage({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new a.Texture(o,g,h.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let o=0;const h=this._visibleDemTiles.reduce((g,x)=>{if(!x.dem)return g;const b=x.dem.tree.minimums[0];return b>0&&o++,g+b},0);return o?h/o:0}_updateEmptyDEMTexture(){const o=this.painter.context,h=o.gl;o.activeTexture.set(h.TEXTURE2);const g=this._getLoadedAreaMinimum(),x=new a.RGBAImage({width:1,height:1},new Uint8Array(a.DEMData.pack(g,this.sourceCache.getSource().encoding)));this._emptyDEMTextureDirty=!1;let b=this._emptyDEMTexture;return b?b.update(x,{premultiply:!1}):b=this._emptyDEMTexture=new a.Texture(o,x,h.RGBA,{premultiply:!1}),b}setupElevationDraw(o,h,g){const x=this.painter.context,b=x.gl,A=(M=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:a.DEMData.getUnpackVector(M),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0});var M;A.u_dem_size=this.sourceCache.getSource().tileSize,A.u_exaggeration=this.exaggeration();let P=null,k=null,D=1;if(g&&g.morphing&&this._useVertexMorphing){const U=g.morphing.srcDemTile,W=g.morphing.dstDemTile;D=g.morphing.phase,U&&W&&(this._prepareDemTileUniforms(o,U,A,"_prev")&&(k=U),this._prepareDemTileUniforms(o,W,A)&&(P=W))}if(k&&P?(x.activeTexture.set(b.TEXTURE2),P.demTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE,b.NEAREST),x.activeTexture.set(b.TEXTURE4),k.demTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE,b.NEAREST),A.u_dem_lerp=D):(P=this.terrainTileForTile[o.tileID.key],x.activeTexture.set(b.TEXTURE2),(this._prepareDemTileUniforms(o,P,A)?P.demTexture:this.emptyDEMTexture).bind(b.NEAREST,b.CLAMP_TO_EDGE)),x.activeTexture.set(b.TEXTURE3),g&&g.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE),this._depthFBO&&(A.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE),A.u_depth_size_inv=[1,1]),g&&g.useMeterToDem&&P){const U=(1<<P.tileID.canonical.z)*a.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;A.u_meter_to_dem=U}if(g&&g.labelPlaneMatrixInv&&(A.u_label_plane_matrix_inv=g.labelPlaneMatrixInv),h.setTerrainUniformValues(x,A),this.painter.transform.projection.name==="globe"){const U=this.globeUniformValues(this.painter.transform,o.tileID.canonical,g&&g.useDenormalizedUpVectorScale);h.setGlobeUniformValues(x,U)}}globeUniformValues(o,h,g){const x=o.projection;return{u_tile_tl_up:x.upVector(h,0,0),u_tile_tr_up:x.upVector(h,a.EXTENT,0),u_tile_br_up:x.upVector(h,a.EXTENT,a.EXTENT),u_tile_bl_up:x.upVector(h,0,a.EXTENT),u_tile_up_scale:g?a.GLOBE_METERS_TO_ECEF:x.upVectorScale(h,o.center.lat,o.worldSize).metersToTile}}renderToBackBuffer(o){const h=this.painter,g=this.painter.context;o.length!==0&&(g.bindFramebuffer.set(null),g.viewport.set([0,0,h.width,h.height]),h.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(x,b,A,M,P){if(x.transform.projection.name==="globe")(function(k,D,U,W,J){const X=k.context,ee=X.gl;let Y,q;const ie=k.options.showTerrainWireframe?2:0,K=k.transform,he=a.globeUseCustomAntiAliasing(k,X,K),fe=(Ie,ve)=>{if(q===Ie)return;const lt=[Bo[Ie],"PROJECTION_GLOBE_VIEW"];he&&lt.push("CUSTOM_ANTIALIASING"),ve&&lt.push(Bo[ie]),Y=k.useProgram("globeRaster",null,lt),q=Ie},le=k.colorModeForRenderPass(),me=new a.DepthMode(ee.LEQUAL,a.DepthMode.ReadWrite,k.depthRangeFor3D);js.update(J);const Pe=a.calculateGlobeMercatorMatrix(K),ze=[a.mercatorXfromLng(K.center.lng),a.mercatorYfromLat(K.center.lat)],ke=ie?[!1,!0]:[!1],Ke=k.globeSharedBuffers,we=[K.width*a.exported.devicePixelRatio,K.height*a.exported.devicePixelRatio],$e=Float32Array.from(K.globeMatrix),je={useDenormalizedUpVectorScale:!0};if(ke.forEach(Ie=>{q=-1;const ve=Ie?ee.LINES:ee.TRIANGLES;for(const lt of W){const tt=U.getTile(lt),at=a.StencilMode.disabled,nt=D.prevTerrainTileForTile[lt.key],vt=D.terrainTileForTile[lt.key];fa(nt,vt)&&js.newMorphing(lt.key,nt,vt,J,250),X.activeTexture.set(ee.TEXTURE0),tt.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE);const Rt=js.getMorphValuesForProxy(lt.key),Ct=Rt?1:0;Rt&&a.extend$1(je,{morphing:{srcDemTile:Rt.from,dstDemTile:Rt.to,phase:a.easeCubicInOut(Rt.phase)}});const Et=a.tileCornersToBounds(lt.canonical),rt=a.getLatitudinalLod(Et.getCenter().lat),Ft=a.getGridMatrix(lt.canonical,Et,rt,K.worldSize/K._pixelsPerMercatorPixel),Ht=a.globeNormalizeECEF(a.globeTileBounds(lt.canonical)),bi=ll(K.projMatrix,$e,Pe,Ht,a.globeToMercatorTransition(K.zoom),ze,K.frustumCorners.TL,K.frustumCorners.TR,K.frustumCorners.BR,K.frustumCorners.BL,K.globeCenterInViewSpace,K.globeRadius,we,Ft);if(fe(Ct,Ie),D.setupElevationDraw(tt,Y,je),k.prepareDrawProgram(X,Y,lt.toUnwrapped()),Ke){const[wi,_i,xn]=Ie?Ke.getWirefameBuffers(k.context,rt):Ke.getGridBuffers(rt);Y.draw(X,ve,me,at,le,a.CullFaceMode.backCCW,bi,"globe_raster",wi,_i,xn)}}}),Ke){const Ie=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];he&&Ie.push("CUSTOM_ANTIALIASING"),Y=k.useProgram("globeRaster",null,Ie);for(const ve of W){const{x:lt,y:tt,z:at}=ve.canonical,nt=tt===0,vt=tt===(1<<at)-1,[Rt,Ct,Et,rt]=Ke.getPoleBuffers(at);if(rt&&(nt||vt)){const Ft=U.getTile(ve);X.activeTexture.set(ee.TEXTURE0),Ft.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE);let Ht=a.globePoleMatrixForTile(at,lt,K);const bi=a.globeNormalizeECEF(a.globeTileBounds(ve.canonical)),wi=(_i,xn)=>_i.draw(X,ee.TRIANGLES,me,a.StencilMode.disabled,le,a.CullFaceMode.disabled,ll(K.projMatrix,Ht,Ht,bi,0,ze,K.frustumCorners.TL,K.frustumCorners.TR,K.frustumCorners.BR,K.frustumCorners.BL,K.globeCenterInViewSpace,K.globeRadius,we),"globe_pole_raster",xn,Et,rt);D.setupElevationDraw(Ft,Y,je),k.prepareDrawProgram(X,Y,ve.toUnwrapped()),nt&&wi(Y,Rt),vt&&(Ht=a.scale(a.create(),Ht,[1,-1,1]),wi(Y,Ct))}}}})(x,b,A,M,P);else{const k=x.context,D=k.gl;let U,W;const J=x.options.showTerrainWireframe?2:0,X=(K,he)=>{if(W===K)return;const fe=[Bo[K]];he&&fe.push(Bo[J]),U=x.useProgram("terrainRaster",null,fe),W=K},ee=x.colorModeForRenderPass(),Y=new a.DepthMode(D.LEQUAL,a.DepthMode.ReadWrite,x.depthRangeFor3D);js.update(P);const q=x.transform,ie=6*Math.pow(1.5,22-q.zoom)*b.exaggeration();(J?[!1,!0]:[!1]).forEach(K=>{W=-1;const he=K?D.LINES:D.TRIANGLES,[fe,le]=K?b.getWirefameBuffer():[b.gridIndexBuffer,b.gridSegments];for(const me of M){const Pe=A.getTile(me),ze=a.StencilMode.disabled,ke=b.prevTerrainTileForTile[me.key],Ke=b.terrainTileForTile[me.key];fa(ke,Ke)&&js.newMorphing(me.key,ke,Ke,P,250),k.activeTexture.set(D.TEXTURE0),Pe.texture.bind(D.LINEAR,D.CLAMP_TO_EDGE,D.LINEAR_MIPMAP_NEAREST);const we=js.getMorphValuesForProxy(me.key),$e=we?1:0;let je;we&&(je={morphing:{srcDemTile:we.from,dstDemTile:we.to,phase:a.easeCubicInOut(we.phase)}});const Ie=Hc(me.projMatrix,ai(me.canonical,q.renderWorldCopies)?ie/10:ie);X($e,K),b.setupElevationDraw(Pe,U,je),x.prepareDrawProgram(k,U,me.toUnwrapped()),U.draw(k,he,Y,ze,ee,a.CullFaceMode.backCCW,Ie,"terrain_raster",b.gridBuffer,fe,le)}})}}(h,this,this.proxySourceCache,o,this._updateTimestamp),this.renderingToTexture=!0,h.gpuTimingDeferredRenderEnd(),o.splice(0,o.length))}renderBatch(o){if(this._drapedRenderBatches.length===0)return o+1;this.renderingToTexture=!0;const h=this.painter,g=this.painter.context,x=this.proxySourceCache,b=this.proxiedCoords[x.id],A=this._drapedRenderBatches.shift(),M=[],P=h.style.order;let k=0;for(const D of b){const U=x.getTileByID(D.proxyTileKey),W=x.proxyCachedFBO[D.key]?x.proxyCachedFBO[D.key][o]:void 0,J=W!==void 0?x.renderCache[W]:this.pool[k++],X=W!==void 0;if(U.texture=J.tex,X&&!J.dirty){M.push(U.tileID);continue}let ee;g.bindFramebuffer.set(J.fb.framebuffer),this.renderedToTile=!1,J.dirty&&(g.clear({color:a.Color.transparent,stencil:0}),J.dirty=!1);for(let Y=A.start;Y<=A.end;++Y){const q=h.style._layers[P[Y]];if(q.isHidden(h.transform.zoom))continue;const ie=h.style._getLayerSourceCache(q),K=ie?this.proxyToSource[D.key][ie.id]:[D];if(!K)continue;const he=K;g.viewport.set([0,0,J.fb.width,J.fb.height]),ee!==(ie?ie.id:null)&&(this._setupStencil(J,K,q,ie),ee=ie?ie.id:null),h.renderLayer(h,ie,q,he)}this.renderedToTile?(J.dirty=!0,M.push(U.tileID)):X||--k,k===5&&(k=0,this.renderToBackBuffer(M))}return this.renderToBackBuffer(M),this.renderingToTexture=!1,g.bindFramebuffer.set(null),g.viewport.set([0,0,h.width,h.height]),A.end+1}postRender(){}renderCacheEfficiency(o){const h=o.order.length;if(h===0)return{efficiency:100};let g,x=0,b=0,A=!1;for(let M=0;M<h;++M){const P=o._layers[o.order[M]];this._style.isLayerDraped(P)?(A&&++x,++b):A||(A=!0,g=P.id)}return b===0?{efficiency:100}:{efficiency:100*(1-x/b),firstUndrapedLayer:g}}getMinElevationBelowMSL(){let o=0;return this._visibleDemTiles.filter(h=>h.dem).forEach(h=>{o=Math.min(o,h.dem.tree.minimums[0])}),o===0?o:(o-30)*this._exaggeration}raycast(o,h,g){if(!this._visibleDemTiles)return null;const x=this._visibleDemTiles.filter(b=>b.dem).map(b=>{const A=b.tileID,M=1<<A.overscaledZ,{x:P,y:k}=A.canonical,D=P/M,U=(P+1)/M,W=k/M,J=(k+1)/M;return{minx:D,miny:W,maxx:U,maxy:J,t:b.dem.tree.raycastRoot(D,W,U,J,o,h,g),tile:b}});x.sort((b,A)=>(b.t!==null?b.t:Number.MAX_VALUE)-(A.t!==null?A.t:Number.MAX_VALUE));for(const b of x){if(b.t==null)return null;const A=b.tile.dem.tree.raycast(b.minx,b.miny,b.maxx,b.maxy,o,h,g);if(A!=null)return A}return null}_createFBO(){const o=this.painter.context,h=o.gl,g=this.drapeBufferSize;o.activeTexture.set(h.TEXTURE0);const x=new a.Texture(o,{width:g[0],height:g[1],data:null},h.RGBA);x.bind(h.LINEAR,h.CLAMP_TO_EDGE);const b=o.createFramebuffer(g[0],g[1],!1);return b.colorAttachment.set(x.texture),b.depthAttachment=new is(o,b.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=o.createRenderbuffer(o.gl.DEPTH_STENCIL,g[0],g[1]),this._stencilRef=0,b.depthAttachment.set(this._sharedDepthStencil),o.clear({stencil:0})):b.depthAttachment.set(this._sharedDepthStencil),o.extTextureFilterAnisotropic&&!o.extTextureFilterAnisotropicForceOff&&h.texParameterf(h.TEXTURE_2D,o.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,o.extTextureFilterAnisotropicMax),{fb:b,tex:x,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const o in this._style._sourceCaches)if(this._style._sourceCaches[o].hasTransition())return!0;return this._style.order.some(o=>{const h=this._style._layers[o],g=h.isHidden(this.painter.transform.zoom),x=h.getCrossfadeParameters(),b=!!x&&x.t!==1,A=h.hasTransition();return h.type!=="custom"&&!g&&(b||A)})}_clearRasterFadeFromRenderCache(){let o=!1;for(const h in this._style._sourceCaches)if(this._style._sourceCaches[h]._source instanceof j){o=!0;break}if(o)for(let h=0;h<this._style.order.length;++h){const g=this._style._layers[this._style.order[h]],x=g.isHidden(this.painter.transform.zoom),b=this._style._getLayerSourceCache(g);if(g.type!=="raster"||x||!b)continue;const A=g.paint.get("raster-fade-duration");for(const M of this.proxyCoords){const P=this.proxyToSource[M.key][b.id];if(P)for(const k of P){const D=Xc(b.getTile(k),b.findLoadedParent(k,0),b,this.painter.transform,A);(D.opacity!==1||D.mix!==0)&&this._clearRenderCacheForTile(b.id,k)}}}}_setupDrapedRenderBatches(){const o=this._style.order,h=o.length;if(h===0)return;const g=[];let x,b=0,A=this._style._layers[o[b]];for(;!this._style.isLayerDraped(A)&&A.isHidden(this.painter.transform.zoom)&&++b<h;)A=this._style._layers[o[b]];for(;b<h;++b){const M=this._style._layers[o[b]];M.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(M)?x===void 0&&(x=b):x!==void 0&&(g.push({start:x,end:b-1}),x=void 0))}x!==void 0&&g.push({start:x,end:b-1}),this._drapedRenderBatches=g}_setupRenderCache(o){const h=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,h.renderCache.length>h.renderCachePool.length){const A=Object.values(h.proxyCachedFBO);h.proxyCachedFBO={};for(let M=0;M<A.length;++M){const P=Object.values(A[M]);h.renderCachePool.push(...P)}}return}this._clearRasterFadeFromRenderCache();const g=this.proxyCoords,x=this._tilesDirty;for(let A=g.length-1;A>=0;A--){const M=g[A];if(h.getTileByID(M.key),h.proxyCachedFBO[M.key]!==void 0){const P=o[M.key],k=this.proxyToSource[M.key];let D=0;for(const U in k){const W=k[U],J=P[U];if(!J||J.length!==W.length||W.some((X,ee)=>X!==J[ee]||x[U]&&x[U].hasOwnProperty(X.key))){D=-1;break}++D}for(const U in h.proxyCachedFBO[M.key])h.renderCache[h.proxyCachedFBO[M.key][U]].dirty=D<0||D!==Object.values(P).length}}const b=[...this._drapedRenderBatches];b.sort((A,M)=>M.end-M.start-(A.end-A.start));for(const A of b)for(const M of g){if(h.proxyCachedFBO[M.key])continue;let P=h.renderCachePool.pop();P===void 0&&h.renderCache.length<50&&(P=h.renderCache.length,h.renderCache.push(this._createFBO())),P!==void 0&&(h.proxyCachedFBO[M.key]={},h.proxyCachedFBO[M.key][A.start]=P,h.renderCache[P].dirty=!0)}this._tilesDirty={}}_setupStencil(o,h,g,x){if(!x||!this._sourceTilesOverlap[x.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const b=this.painter.context,A=b.gl;if(h.length<=1)return void(this._overlapStencilType=!1);let M;if(g.isTileClipped())M=h.length,this._overlapStencilMode.test={func:A.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(h[0].overscaledZ>h[h.length-1].overscaledZ))return void(this._overlapStencilType=!1);M=1,this._overlapStencilMode.test={func:A.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+M>255&&(b.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=M,this._overlapStencilMode.ref=this._stencilRef,g.isTileClipped()&&this._renderTileClippingMasks(h,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(o){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[o.key]),this._overlapStencilMode):a.StencilMode.disabled}_renderTileClippingMasks(o,h){const g=this.painter,x=this.painter.context,b=x.gl;g._tileClippingMaskIDs={},x.setColorMode(a.ColorMode.disabled),x.setDepthMode(a.DepthMode.disabled);const A=g.useProgram("clippingMask");for(const M of o){const P=g._tileClippingMaskIDs[M.key]=--h;A.draw(x,b.TRIANGLES,a.DepthMode.disabled,new a.StencilMode({func:b.ALWAYS,mask:0},P,255,b.KEEP,b.KEEP,b.REPLACE),a.ColorMode.disabled,a.CullFaceMode.disabled,Fo(M.projMatrix),"$clipping",g.tileExtentBuffer,g.quadTriangleIndexBuffer,g.tileExtentSegments)}}pointCoordinate(o){const h=this.painter.transform;if(o.x<0||o.x>h.width||o.y<0||o.y>h.height)return null;const g=[o.x,o.y,1,1];a.transformMat4$1(g,g,h.pixelMatrixInverse),a.scale$1(g,g,1/g[3]),g[0]/=h.worldSize,g[1]/=h.worldSize;const x=h._camera.position,b=a.mercatorZfromAltitude(1,h.center.lat),A=[x[0],x[1],x[2]/b,0],M=a.subtract([],g.slice(0,3),A);a.normalize(M,M);const P=this.raycast(A,M,this._exaggeration);return P!==null&&P?(a.scaleAndAdd(A,A,M,P),A[3]=A[2],A[2]*=b,A):null}drawDepth(){const o=this.painter,h=o.context,g=this.proxySourceCache,x=Math.ceil(o.width),b=Math.ceil(o.height);if(!this._depthFBO||this._depthFBO.width===x&&this._depthFBO.height===b||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const A=h.gl,M=h.createFramebuffer(x,b,!0);h.activeTexture.set(A.TEXTURE0);const P=new a.Texture(h,{width:x,height:b,data:null},A.RGBA);P.bind(A.NEAREST,A.CLAMP_TO_EDGE),M.colorAttachment.set(P.texture);const k=h.createRenderbuffer(h.gl.DEPTH_COMPONENT16,x,b);M.depthAttachment.set(k),this._depthFBO=M,this._depthTexture=P}h.bindFramebuffer.set(this._depthFBO.framebuffer),h.viewport.set([0,0,x,b]),function(A,M,P,k){if(A.transform.projection.name==="globe")return;const D=A.context,U=D.gl;D.clear({depth:1});const W=A.useProgram("terrainDepth"),J=new a.DepthMode(U.LESS,a.DepthMode.ReadWrite,A.depthRangeFor3D);for(const X of k){const ee=P.getTile(X),Y=Hc(X.projMatrix,0);M.setupElevationDraw(ee,W),W.draw(D,U.TRIANGLES,J,a.StencilMode.disabled,a.ColorMode.unblended,a.CullFaceMode.backCCW,Y,"terrain_depth",M.gridBuffer,M.gridIndexBuffer,M.gridNoSkirtSegments)}}(o,this,g,this.proxyCoords)}_setupProxiedCoordsForOrtho(o,h,g){if(o.getSource()instanceof ge)return this._setupProxiedCoordsForImageSource(o,h,g);this._findCoveringTileCache[o.id]=this._findCoveringTileCache[o.id]||{};const x=this.proxiedCoords[o.id]=[],b=this.proxyCoords;for(let M=0;M<b.length;M++){const P=b[M],k=this._findTileCoveringTileID(P,o);if(k){const D=this._createProxiedId(P,k,g[P.key]&&g[P.key][o.id]);x.push(D),this.proxyToSource[P.key][o.id]=[D]}}let A=!1;for(let M=0;M<h.length;M++){const P=o.getTile(h[M]);if(!P||!P.hasData())continue;const k=this._findTileCoveringTileID(P.tileID,this.proxySourceCache);if(k&&k.tileID.canonical.z!==P.tileID.canonical.z){const D=this.proxyToSource[k.tileID.key][o.id],U=this._createProxiedId(k.tileID,P,g[k.tileID.key]&&g[k.tileID.key][o.id]);D?D.splice(D.length-1,0,U):this.proxyToSource[k.tileID.key][o.id]=[U],x.push(U),A=!0}}this._sourceTilesOverlap[o.id]=A}_setupProxiedCoordsForImageSource(o,h,g){if(!o.getSource().loaded())return;const x=this.proxiedCoords[o.id]=[],b=this.proxyCoords,A=o.getSource(),M=new a.pointGeometry(A.tileID.x,A.tileID.y)._div(1<<A.tileID.z),P=A.coordinates.map(a.MercatorCoordinate.fromLngLat).reduce((D,U)=>(D.min.x=Math.min(D.min.x,U.x-M.x),D.min.y=Math.min(D.min.y,U.y-M.y),D.max.x=Math.max(D.max.x,U.x-M.x),D.max.y=Math.max(D.max.y,U.y-M.y),D),{min:new a.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new a.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),k=(D,U)=>{const W=D.wrap+D.canonical.x/(1<<D.canonical.z),J=D.canonical.y/(1<<D.canonical.z),X=a.EXTENT/(1<<D.canonical.z),ee=U.wrap+U.canonical.x/(1<<U.canonical.z),Y=U.canonical.y/(1<<U.canonical.z);return W+X<ee+P.min.x||W>ee+P.max.x||J+X<Y+P.min.y||J>Y+P.max.y};for(let D=0;D<b.length;D++){const U=b[D];for(let W=0;W<h.length;W++){const J=o.getTile(h[W]);if(!J||!J.hasData()||k(U,J.tileID))continue;const X=this._createProxiedId(U,J,g[U.key]&&g[U.key][o.id]),ee=this.proxyToSource[U.key][o.id];ee?ee.push(X):this.proxyToSource[U.key][o.id]=[X],x.push(X)}}}_createProxiedId(o,h,g){let x=this.orthoMatrix;if(g){const b=g.find(A=>A.key===h.tileID.key);if(b)return b}if(h.tileID.key!==o.key){const b=o.canonical.z-h.tileID.canonical.z;let A,M,P;x=a.create();const k=h.tileID.wrap-o.wrap<<o.overscaledZ;b>0?(A=a.EXTENT>>b,M=A*((h.tileID.canonical.x<<b)-o.canonical.x+k),P=A*((h.tileID.canonical.y<<b)-o.canonical.y)):(A=a.EXTENT<<-b,M=a.EXTENT*(h.tileID.canonical.x-(o.canonical.x+k<<-b)),P=a.EXTENT*(h.tileID.canonical.y-(o.canonical.y<<-b))),a.ortho(x,0,A,0,A,0,1),a.translate(x,x,[M,P,0])}return new cl(h.tileID,o.key,x)}_findTileCoveringTileID(o,h){let g=h.getTile(o);if(g&&g.hasData())return g;const x=this._findCoveringTileCache[h.id],b=x[o.key];if(g=b?h.getTileByID(b):null,g&&g.hasData()||b===null)return g;let A=g?g.tileID:o,M=A.overscaledZ;const P=h.getSource().minzoom,k=[];if(!b){const U=h.getSource().maxzoom;if(o.canonical.z>=U){const W=o.canonical.z-U;h.getSource().reparseOverscaled?(M=Math.max(o.canonical.z+2,h.transform.tileZoom),A=new a.OverscaledTileID(M,o.wrap,U,o.canonical.x>>W,o.canonical.y>>W)):W!==0&&(M=U,A=new a.OverscaledTileID(M,o.wrap,U,o.canonical.x>>W,o.canonical.y>>W))}A.key!==o.key&&(k.push(A.key),g=h.getTile(A))}const D=U=>{k.forEach(W=>{x[W]=U}),k.length=0};for(M-=1;M>=P&&(!g||!g.hasData());M--){g&&D(g.tileID.key);const U=A.calculateScaledKey(M);if(g=h.getTileByID(U),g&&g.hasData())break;const W=x[U];if(W===null)break;W===void 0?k.push(U):g=h.getTileByID(W)}return D(g?g.tileID.key:null),g&&g.hasData()?g:null}findDEMTileFor(o){return this.enabled?this._findTileCoveringTileID(o,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(o,h){let g=this._tilesDirty[o];g||(g=this._tilesDirty[o]={}),g[h.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const o=function(h){let g=0;const x=new a.StructArrayLayout2ui4,b=131;for(let A=1;A<129;A++){for(let M=1;M<129;M++)g=A*b+M,x.emplaceBack(g,g+1),x.emplaceBack(g,g+b),x.emplaceBack(g+1,g+b),A===128&&x.emplaceBack(g+b,g+b+1);x.emplaceBack(g+1,g+1+b)}return x}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(o),this.wireframeSegments=a.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,o.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}class ld{static cacheKey(o,h,g,x){let b=`${h}${x?x.cacheKey:""}`;for(const A of g)o.usedDefines.includes(A)&&(b+=`/${A}`);return b}constructor(o,h,g,x,b,A){const M=o.gl;this.program=M.createProgram();const P=function(Y){const q=[];for(let ie=0;ie<Y.length;ie++){if(Y[ie]===null)continue;const K=Y[ie].split(" ");q.push(K.pop())}return q}(g.staticAttributes),k=x?x.getBinderAttributes():[],D=P.concat(k);let U=x?x.defines():[];U=U.concat(A.map(Y=>`#define ${Y}`));const W=U.concat(o.extStandardDerivatives?`#extension GL_OES_standard_derivatives : enable
`.concat(nl):nl,nl,$c,Zc.fragmentSource,Wc.fragmentSource,g.fragmentSource).join(`
`),J=U.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,$c,Zc.vertexSource,Wc.vertexSource,Gc.vertexSource,g.vertexSource).join(`
`),X=M.createShader(M.FRAGMENT_SHADER);if(M.isContextLost())return void(this.failedToCreate=!0);M.shaderSource(X,W),M.compileShader(X),M.attachShader(this.program,X);const ee=M.createShader(M.VERTEX_SHADER);if(M.isContextLost())this.failedToCreate=!0;else{M.shaderSource(ee,J),M.compileShader(ee),M.attachShader(this.program,ee),this.attributes={},this.numAttributes=D.length;for(let Y=0;Y<this.numAttributes;Y++)D[Y]&&(M.bindAttribLocation(this.program,Y,D[Y]),this.attributes[D[Y]]=Y);M.linkProgram(this.program),M.deleteShader(ee),M.deleteShader(X),this.fixedUniforms=b(o),this.binderUniforms=x?x.getUniforms(o):[],A.includes("TERRAIN")&&(this.terrainUniforms=(Y=>({u_dem:new a.Uniform1i(Y),u_dem_prev:new a.Uniform1i(Y),u_dem_unpack:new a.Uniform4f(Y),u_dem_tl:new a.Uniform2f(Y),u_dem_scale:new a.Uniform1f(Y),u_dem_tl_prev:new a.Uniform2f(Y),u_dem_scale_prev:new a.Uniform1f(Y),u_dem_size:new a.Uniform1f(Y),u_dem_lerp:new a.Uniform1f(Y),u_exaggeration:new a.Uniform1f(Y),u_depth:new a.Uniform1i(Y),u_depth_size_inv:new a.Uniform2f(Y),u_meter_to_dem:new a.Uniform1f(Y),u_label_plane_matrix_inv:new a.UniformMatrix4f(Y)}))(o)),A.includes("GLOBE")&&(this.globeUniforms=(Y=>({u_tile_tl_up:new a.Uniform3f(Y),u_tile_tr_up:new a.Uniform3f(Y),u_tile_br_up:new a.Uniform3f(Y),u_tile_bl_up:new a.Uniform3f(Y),u_tile_up_scale:new a.Uniform1f(Y)}))(o)),A.includes("FOG")&&(this.fogUniforms=(Y=>({u_fog_matrix:new a.UniformMatrix4f(Y),u_fog_range:new a.Uniform2f(Y),u_fog_color:new a.Uniform4f(Y),u_fog_horizon_blend:new a.Uniform1f(Y),u_fog_temporal_offset:new a.Uniform1f(Y),u_frustum_tl:new a.Uniform3f(Y),u_frustum_tr:new a.Uniform3f(Y),u_frustum_br:new a.Uniform3f(Y),u_frustum_bl:new a.Uniform3f(Y),u_globe_pos:new a.Uniform3f(Y),u_globe_radius:new a.Uniform1f(Y),u_globe_transition:new a.Uniform1f(Y),u_is_globe:new a.Uniform1i(Y),u_viewport:new a.Uniform2f(Y)}))(o))}}setTerrainUniformValues(o,h){if(!this.terrainUniforms)return;const g=this.terrainUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const x in h)g[x]&&g[x].set(this.program,x,h[x])}}setGlobeUniformValues(o,h){if(!this.globeUniforms)return;const g=this.globeUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const x in h)g[x]&&g[x].set(this.program,x,h[x])}}setFogUniformValues(o,h){if(!this.fogUniforms)return;const g=this.fogUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const x in h)g[x].set(this.program,x,h[x])}}draw(o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee){const Y=o.gl;if(this.failedToCreate)return;o.program.set(this.program),o.setDepthMode(g),o.setStencilMode(x),o.setColorMode(b),o.setCullFace(A);for(const ie of Object.keys(this.fixedUniforms))this.fixedUniforms[ie].set(this.program,ie,M[ie]);X&&X.setUniforms(this.program,o,this.binderUniforms,W,{zoom:J});const q={[Y.LINES]:2,[Y.TRIANGLES]:3,[Y.LINE_STRIP]:1}[h];for(const ie of U.get()){const K=ie.vaos||(ie.vaos={});(K[P]||(K[P]=new da)).bind(o,this,k,X?X.getPaintVertexBuffers():[],D,ie.vertexOffset,ee||[]),Y.drawElements(h,ie.primitiveLength*q,Y.UNSIGNED_SHORT,ie.primitiveOffset*q*2)}}}function cd(p,o,h){const g=1/$i(h,1,o.transform.tileZoom),x=Math.pow(2,h.tileID.overscaledZ),b=h.tileSize*Math.pow(2,o.transform.tileZoom)/x,A=b*(h.tileID.canonical.x+h.tileID.wrap*x),M=b*h.tileID.canonical.y;return{u_image:0,u_texsize:h.imageAtlasTexture.size,u_scale:[g,p.fromScale,p.toScale],u_fade:p.t,u_pixel_coord_upper:[A>>16,M>>16],u_pixel_coord_lower:[65535&A,65535&M]}}const Yc=a.create(),ul=(p,o,h,g,x,b,A,M,P,k,D)=>{const U=o.style.light,W=U.properties.get("position"),J=[W.x,W.y,W.z],X=a.create$1();U.properties.get("anchor")==="viewport"&&(a.fromRotation(X,-o.transform.angle),a.transformMat3(J,J,X));const ee=U.properties.get("color"),Y=o.transform,q={u_matrix:p,u_lightpos:J,u_lightintensity:U.properties.get("intensity"),u_lightcolor:[ee.r,ee.g,ee.b],u_vertical_gradient:+h,u_opacity:g,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Yc,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:x,u_edge_radius:b};return Y.projection.name==="globe"&&(q.u_tile_id=[A.canonical.x,A.canonical.y,1<<A.canonical.z],q.u_zoom_transition=P,q.u_inv_rot_matrix=D,q.u_merc_center=k,q.u_up_dir=Y.projection.upVector(new a.CanonicalTileID(0,0,0),k[0]*a.EXTENT,k[1]*a.EXTENT),q.u_height_lift=M),q},Kc=(p,o,h,g,x,b,A,M,P,k,D,U,W)=>{const J=ul(p,o,h,g,x,b,A,k,D,U,W),X={u_height_factor:-Math.pow(2,A.overscaledZ)/P.tileSize/8};return a.extend(J,cd(M,o,P),X)},hl=p=>({u_matrix:p}),Jc=(p,o,h,g)=>a.extend(hl(p),cd(h,o,g)),ud=(p,o)=>({u_matrix:p,u_world:o}),Yp=(p,o,h,g,x)=>a.extend(Jc(p,o,h,g),{u_world:x}),pa=a.create(),ma=(p,o,h,g,x,b)=>{const A=p.transform,M=A.projection.name==="globe";let P;if(b.paint.get("circle-pitch-alignment")==="map")if(M){const D=a.globePixelsToTileUnits(A.zoom,o.canonical)*A._pixelsPerMercatorPixel;P=Float32Array.from([D,0,0,D])}else P=A.calculatePixelsToTileUnitsMatrix(h);else P=new Float32Array([A.pixelsToGLUnits[0],0,0,A.pixelsToGLUnits[1]]);const k={u_camera_to_center_distance:A.cameraToCenterDistance,u_matrix:p.translatePosMatrix(o.projMatrix,h,b.paint.get("circle-translate"),b.paint.get("circle-translate-anchor")),u_device_pixel_ratio:a.exported.devicePixelRatio,u_extrude_scale:P,u_inv_rot_matrix:pa,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(M){k.u_inv_rot_matrix=g,k.u_merc_center=x,k.u_tile_id=[o.canonical.x,o.canonical.y,1<<o.canonical.z],k.u_zoom_transition=a.globeToMercatorTransition(A.zoom);const D=x[0]*a.EXTENT,U=x[1]*a.EXTENT;k.u_up_dir=A.projection.upVector(new a.CanonicalTileID(0,0,0),D,U)}return k},hd=p=>{const o=[];return p.paint.get("circle-pitch-alignment")==="map"&&o.push("PITCH_WITH_MAP"),p.paint.get("circle-pitch-scale")==="map"&&o.push("SCALE_WITH_MAP"),o},dl=(p,o,h,g)=>{const x=a.EXTENT/h.tileSize;return{u_matrix:p,u_camera_to_center_distance:o.getCameraToCenterDistance(g),u_extrude_scale:[o.pixelsToGLUnits[0]/x,o.pixelsToGLUnits[1]/x]}},fl=(p,o,h=1)=>({u_matrix:p,u_color:o,u_overlay:0,u_overlay_scale:h}),as=a.create(),Qc=(p,o,h,g,x,b,A)=>{const M=p.transform,P=M.projection.name==="globe",k=P?a.globePixelsToTileUnits(M.zoom,o.canonical)*M._pixelsPerMercatorPixel:$i(h,1,b),D={u_matrix:o.projMatrix,u_extrude_scale:k,u_intensity:A,u_inv_rot_matrix:as,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(P){D.u_inv_rot_matrix=g,D.u_merc_center=x,D.u_tile_id=[o.canonical.x,o.canonical.y,1<<o.canonical.z],D.u_zoom_transition=a.globeToMercatorTransition(M.zoom);const U=x[0]*a.EXTENT,W=x[1]*a.EXTENT;D.u_up_dir=M.projection.upVector(new a.CanonicalTileID(0,0,0),U,W)}return D},dd=(p,o,h,g,x,b,A,M)=>{const P=p.transform,k=P.calculatePixelsToTileUnitsMatrix(o),D={u_matrix:pl(p,o,h,x),u_pixels_to_tile_units:k,u_device_pixel_ratio:A,u_units_to_pixels:[1/P.pixelsToGLUnits[0],1/P.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:b,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0,u_trim_offset:M};if(fd(h)){const U=tu(o,p.transform);D.u_texsize=o.lineAtlasTexture.size,D.u_scale=[U,g.fromScale,g.toScale],D.u_mix=g.t}return D},eu=(p,o,h,g,x,b)=>{const A=p.transform,M=tu(o,A);return{u_matrix:pl(p,o,h,x),u_texsize:o.imageAtlasTexture.size,u_pixels_to_tile_units:A.calculatePixelsToTileUnitsMatrix(o),u_device_pixel_ratio:b,u_image:0,u_scale:[M,g.fromScale,g.toScale],u_fade:g.t,u_units_to_pixels:[1/A.pixelsToGLUnits[0],1/A.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function tu(p,o){return 1/$i(p,1,o.tileZoom)}function pl(p,o,h,g){return p.translatePosMatrix(g||o.tileID.projMatrix,o,h.paint.get("line-translate"),h.paint.get("line-translate-anchor"))}function fd(p){const o=p.paint.get("line-dasharray").value;return o.value||o.kind!=="constant"}const iu=(p,o,h,g,x,b)=>{return{u_matrix:p,u_tl_parent:o,u_scale_parent:h,u_fade_t:g.mix,u_opacity:g.opacity*x.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:x.paint.get("raster-brightness-min"),u_brightness_high:x.paint.get("raster-brightness-max"),u_saturation_factor:(M=x.paint.get("raster-saturation"),M>0?1-1/(1.001-M):-M),u_contrast_factor:(A=x.paint.get("raster-contrast"),A>0?1/(1-A):1+A),u_spin_weights:Kp(x.paint.get("raster-hue-rotate")),u_perspective_transform:b};var A,M};function Kp(p){p*=Math.PI/180;const o=Math.sin(p),h=Math.cos(p);return[(2*h+1)/3,(-Math.sqrt(3)*o-h+1)/3,(Math.sqrt(3)*o-h+1)/3]}const ga=a.create(),pd=(p,o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee)=>{const Y=x.transform,q={u_is_size_zoom_constant:+(p==="constant"||p==="source"),u_is_size_feature_constant:+(p==="constant"||p==="camera"),u_size_t:o?o.uSizeT:0,u_size:o?o.uSize:0,u_camera_to_center_distance:Y.cameraToCenterDistance,u_rotate_symbol:+h,u_aspect_ratio:Y.width/Y.height,u_fade_change:x.options.fadeDuration?x.symbolFadeChange:1,u_matrix:b,u_label_plane_matrix:A,u_coord_matrix:M,u_is_text:+P,u_pitch_with_map:+g,u_texsize:k,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ga,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:ga,u_up_vector:[0,-1,0]};return ee.name==="globe"&&(q.u_tile_id=[D.canonical.x,D.canonical.y,1<<D.canonical.z],q.u_zoom_transition=U,q.u_inv_rot_matrix=J,q.u_merc_center=W,q.u_camera_forward=Y._camera.forward(),q.u_ecef_origin=a.globeECEFOrigin(Y.globeMatrix,D.toUnwrapped()),q.u_tile_matrix=Float32Array.from(Y.globeMatrix),q.u_up_vector=X),q},ml=(p,o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee,Y)=>a.extend(pd(p,o,h,g,x,b,A,M,P,k,U,W,J,X,ee,Y),{u_gamma_scale:g?x.transform.cameraToCenterDistance*Math.cos(x.terrain?0:x.transform._pitch):1,u_device_pixel_ratio:a.exported.devicePixelRatio,u_is_halo:+D}),Jp=(p,o,h,g,x,b,A,M,P,k,D,U,W,J,X,ee)=>a.extend(ml(p,o,h,g,x,b,A,M,!0,P,!0,D,U,W,J,X,ee),{u_texsize_icon:k,u_texture_icon:1}),nu=(p,o,h)=>({u_matrix:p,u_opacity:o,u_color:h}),Qp=(p,o,h,g,x,b)=>a.extend(function(A,M,P,k){const D=P.imageManager.getPattern(A.from.toString()),U=P.imageManager.getPattern(A.to.toString()),{width:W,height:J}=P.imageManager.getPixelSize(),X=Math.pow(2,k.tileID.overscaledZ),ee=k.tileSize*Math.pow(2,P.transform.tileZoom)/X,Y=ee*(k.tileID.canonical.x+k.tileID.wrap*X),q=ee*k.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:D.tl,u_pattern_br_a:D.br,u_pattern_tl_b:U.tl,u_pattern_br_b:U.br,u_texsize:[W,J],u_mix:M.t,u_pattern_size_a:D.displaySize,u_pattern_size_b:U.displaySize,u_scale_a:M.fromScale,u_scale_b:M.toScale,u_tile_units_to_pixels:1/$i(k,1,P.transform.tileZoom),u_pixel_coord_upper:[Y>>16,q>>16],u_pixel_coord_lower:[65535&Y,65535&q]}}(g,b,h,x),{u_matrix:p,u_opacity:o}),gl={fillExtrusion:p=>({u_matrix:new a.UniformMatrix4f(p),u_lightpos:new a.Uniform3f(p),u_lightintensity:new a.Uniform1f(p),u_lightcolor:new a.Uniform3f(p),u_vertical_gradient:new a.Uniform1f(p),u_opacity:new a.Uniform1f(p),u_edge_radius:new a.Uniform1f(p),u_ao:new a.Uniform2f(p),u_tile_id:new a.Uniform3f(p),u_zoom_transition:new a.Uniform1f(p),u_inv_rot_matrix:new a.UniformMatrix4f(p),u_merc_center:new a.Uniform2f(p),u_up_dir:new a.Uniform3f(p),u_height_lift:new a.Uniform1f(p)}),fillExtrusionPattern:p=>({u_matrix:new a.UniformMatrix4f(p),u_lightpos:new a.Uniform3f(p),u_lightintensity:new a.Uniform1f(p),u_lightcolor:new a.Uniform3f(p),u_vertical_gradient:new a.Uniform1f(p),u_height_factor:new a.Uniform1f(p),u_edge_radius:new a.Uniform1f(p),u_ao:new a.Uniform2f(p),u_tile_id:new a.Uniform3f(p),u_zoom_transition:new a.Uniform1f(p),u_inv_rot_matrix:new a.UniformMatrix4f(p),u_merc_center:new a.Uniform2f(p),u_up_dir:new a.Uniform3f(p),u_height_lift:new a.Uniform1f(p),u_image:new a.Uniform1i(p),u_texsize:new a.Uniform2f(p),u_pixel_coord_upper:new a.Uniform2f(p),u_pixel_coord_lower:new a.Uniform2f(p),u_scale:new a.Uniform3f(p),u_fade:new a.Uniform1f(p),u_opacity:new a.Uniform1f(p)}),fill:p=>({u_matrix:new a.UniformMatrix4f(p)}),fillPattern:p=>({u_matrix:new a.UniformMatrix4f(p),u_image:new a.Uniform1i(p),u_texsize:new a.Uniform2f(p),u_pixel_coord_upper:new a.Uniform2f(p),u_pixel_coord_lower:new a.Uniform2f(p),u_scale:new a.Uniform3f(p),u_fade:new a.Uniform1f(p)}),fillOutline:p=>({u_matrix:new a.UniformMatrix4f(p),u_world:new a.Uniform2f(p)}),fillOutlinePattern:p=>({u_matrix:new a.UniformMatrix4f(p),u_world:new a.Uniform2f(p),u_image:new a.Uniform1i(p),u_texsize:new a.Uniform2f(p),u_pixel_coord_upper:new a.Uniform2f(p),u_pixel_coord_lower:new a.Uniform2f(p),u_scale:new a.Uniform3f(p),u_fade:new a.Uniform1f(p)}),circle:p=>({u_camera_to_center_distance:new a.Uniform1f(p),u_extrude_scale:new a.UniformMatrix2f(p),u_device_pixel_ratio:new a.Uniform1f(p),u_matrix:new a.UniformMatrix4f(p),u_inv_rot_matrix:new a.UniformMatrix4f(p),u_merc_center:new a.Uniform2f(p),u_tile_id:new a.Uniform3f(p),u_zoom_transition:new a.Uniform1f(p),u_up_dir:new a.Uniform3f(p)}),collisionBox:p=>({u_matrix:new a.UniformMatrix4f(p),u_camera_to_center_distance:new a.Uniform1f(p),u_extrude_scale:new a.Uniform2f(p)}),collisionCircle:p=>({u_matrix:new a.UniformMatrix4f(p),u_inv_matrix:new a.UniformMatrix4f(p),u_camera_to_center_distance:new a.Uniform1f(p),u_viewport_size:new a.Uniform2f(p)}),debug:p=>({u_color:new a.UniformColor(p),u_matrix:new a.UniformMatrix4f(p),u_overlay:new a.Uniform1i(p),u_overlay_scale:new a.Uniform1f(p)}),clippingMask:p=>({u_matrix:new a.UniformMatrix4f(p)}),heatmap:p=>({u_extrude_scale:new a.Uniform1f(p),u_intensity:new a.Uniform1f(p),u_matrix:new a.UniformMatrix4f(p),u_inv_rot_matrix:new a.UniformMatrix4f(p),u_merc_center:new a.Uniform2f(p),u_tile_id:new a.Uniform3f(p),u_zoom_transition:new a.Uniform1f(p),u_up_dir:new a.Uniform3f(p)}),heatmapTexture:p=>({u_image:new a.Uniform1i(p),u_color_ramp:new a.Uniform1i(p),u_opacity:new a.Uniform1f(p)}),hillshade:p=>({u_matrix:new a.UniformMatrix4f(p),u_image:new a.Uniform1i(p),u_latrange:new a.Uniform2f(p),u_light:new a.Uniform2f(p),u_shadow:new a.UniformColor(p),u_highlight:new a.UniformColor(p),u_accent:new a.UniformColor(p)}),hillshadePrepare:p=>({u_matrix:new a.UniformMatrix4f(p),u_image:new a.Uniform1i(p),u_dimension:new a.Uniform2f(p),u_zoom:new a.Uniform1f(p),u_unpack:new a.Uniform4f(p)}),line:p=>({u_matrix:new a.UniformMatrix4f(p),u_pixels_to_tile_units:new a.UniformMatrix2f(p),u_device_pixel_ratio:new a.Uniform1f(p),u_units_to_pixels:new a.Uniform2f(p),u_dash_image:new a.Uniform1i(p),u_gradient_image:new a.Uniform1i(p),u_image_height:new a.Uniform1f(p),u_texsize:new a.Uniform2f(p),u_scale:new a.Uniform3f(p),u_mix:new a.Uniform1f(p),u_alpha_discard_threshold:new a.Uniform1f(p),u_trim_offset:new a.Uniform2f(p)}),linePattern:p=>({u_matrix:new a.UniformMatrix4f(p),u_texsize:new a.Uniform2f(p),u_pixels_to_tile_units:new a.UniformMatrix2f(p),u_device_pixel_ratio:new a.Uniform1f(p),u_image:new a.Uniform1i(p),u_units_to_pixels:new a.Uniform2f(p),u_scale:new a.Uniform3f(p),u_fade:new a.Uniform1f(p),u_alpha_discard_threshold:new a.Uniform1f(p)}),raster:p=>({u_matrix:new a.UniformMatrix4f(p),u_tl_parent:new a.Uniform2f(p),u_scale_parent:new a.Uniform1f(p),u_fade_t:new a.Uniform1f(p),u_opacity:new a.Uniform1f(p),u_image0:new a.Uniform1i(p),u_image1:new a.Uniform1i(p),u_brightness_low:new a.Uniform1f(p),u_brightness_high:new a.Uniform1f(p),u_saturation_factor:new a.Uniform1f(p),u_contrast_factor:new a.Uniform1f(p),u_spin_weights:new a.Uniform3f(p),u_perspective_transform:new a.Uniform2f(p)}),symbolIcon:p=>({u_is_size_zoom_constant:new a.Uniform1i(p),u_is_size_feature_constant:new a.Uniform1i(p),u_size_t:new a.Uniform1f(p),u_size:new a.Uniform1f(p),u_camera_to_center_distance:new a.Uniform1f(p),u_rotate_symbol:new a.Uniform1i(p),u_aspect_ratio:new a.Uniform1f(p),u_fade_change:new a.Uniform1f(p),u_matrix:new a.UniformMatrix4f(p),u_label_plane_matrix:new a.UniformMatrix4f(p),u_coord_matrix:new a.UniformMatrix4f(p),u_is_text:new a.Uniform1i(p),u_pitch_with_map:new a.Uniform1i(p),u_texsize:new a.Uniform2f(p),u_tile_id:new a.Uniform3f(p),u_zoom_transition:new a.Uniform1f(p),u_inv_rot_matrix:new a.UniformMatrix4f(p),u_merc_center:new a.Uniform2f(p),u_camera_forward:new a.Uniform3f(p),u_tile_matrix:new a.UniformMatrix4f(p),u_up_vector:new a.Uniform3f(p),u_ecef_origin:new a.Uniform3f(p),u_texture:new a.Uniform1i(p)}),symbolSDF:p=>({u_is_size_zoom_constant:new a.Uniform1i(p),u_is_size_feature_constant:new a.Uniform1i(p),u_size_t:new a.Uniform1f(p),u_size:new a.Uniform1f(p),u_camera_to_center_distance:new a.Uniform1f(p),u_rotate_symbol:new a.Uniform1i(p),u_aspect_ratio:new a.Uniform1f(p),u_fade_change:new a.Uniform1f(p),u_matrix:new a.UniformMatrix4f(p),u_label_plane_matrix:new a.UniformMatrix4f(p),u_coord_matrix:new a.UniformMatrix4f(p),u_is_text:new a.Uniform1i(p),u_pitch_with_map:new a.Uniform1i(p),u_texsize:new a.Uniform2f(p),u_texture:new a.Uniform1i(p),u_gamma_scale:new a.Uniform1f(p),u_device_pixel_ratio:new a.Uniform1f(p),u_tile_id:new a.Uniform3f(p),u_zoom_transition:new a.Uniform1f(p),u_inv_rot_matrix:new a.UniformMatrix4f(p),u_merc_center:new a.Uniform2f(p),u_camera_forward:new a.Uniform3f(p),u_tile_matrix:new a.UniformMatrix4f(p),u_up_vector:new a.Uniform3f(p),u_ecef_origin:new a.Uniform3f(p),u_is_halo:new a.Uniform1i(p)}),symbolTextAndIcon:p=>({u_is_size_zoom_constant:new a.Uniform1i(p),u_is_size_feature_constant:new a.Uniform1i(p),u_size_t:new a.Uniform1f(p),u_size:new a.Uniform1f(p),u_camera_to_center_distance:new a.Uniform1f(p),u_rotate_symbol:new a.Uniform1i(p),u_aspect_ratio:new a.Uniform1f(p),u_fade_change:new a.Uniform1f(p),u_matrix:new a.UniformMatrix4f(p),u_label_plane_matrix:new a.UniformMatrix4f(p),u_coord_matrix:new a.UniformMatrix4f(p),u_is_text:new a.Uniform1i(p),u_pitch_with_map:new a.Uniform1i(p),u_texsize:new a.Uniform2f(p),u_texsize_icon:new a.Uniform2f(p),u_texture:new a.Uniform1i(p),u_texture_icon:new a.Uniform1i(p),u_gamma_scale:new a.Uniform1f(p),u_device_pixel_ratio:new a.Uniform1f(p),u_is_halo:new a.Uniform1i(p)}),background:p=>({u_matrix:new a.UniformMatrix4f(p),u_opacity:new a.Uniform1f(p),u_color:new a.UniformColor(p)}),backgroundPattern:p=>({u_matrix:new a.UniformMatrix4f(p),u_opacity:new a.Uniform1f(p),u_image:new a.Uniform1i(p),u_pattern_tl_a:new a.Uniform2f(p),u_pattern_br_a:new a.Uniform2f(p),u_pattern_tl_b:new a.Uniform2f(p),u_pattern_br_b:new a.Uniform2f(p),u_texsize:new a.Uniform2f(p),u_mix:new a.Uniform1f(p),u_pattern_size_a:new a.Uniform2f(p),u_pattern_size_b:new a.Uniform2f(p),u_scale_a:new a.Uniform1f(p),u_scale_b:new a.Uniform1f(p),u_pixel_coord_upper:new a.Uniform2f(p),u_pixel_coord_lower:new a.Uniform2f(p),u_tile_units_to_pixels:new a.Uniform1f(p)}),terrainRaster:al,terrainDepth:al,skybox:p=>({u_matrix:new a.UniformMatrix4f(p),u_sun_direction:new a.Uniform3f(p),u_cubemap:new a.Uniform1i(p),u_opacity:new a.Uniform1f(p),u_temporal_offset:new a.Uniform1f(p)}),skyboxGradient:p=>({u_matrix:new a.UniformMatrix4f(p),u_color_ramp:new a.Uniform1i(p),u_center_direction:new a.Uniform3f(p),u_radius:new a.Uniform1f(p),u_opacity:new a.Uniform1f(p),u_temporal_offset:new a.Uniform1f(p)}),skyboxCapture:p=>({u_matrix_3f:new a.UniformMatrix3f(p),u_sun_direction:new a.Uniform3f(p),u_sun_intensity:new a.Uniform1f(p),u_color_tint_r:new a.Uniform4f(p),u_color_tint_m:new a.Uniform4f(p),u_luminance:new a.Uniform1f(p)}),globeRaster:p=>({u_proj_matrix:new a.UniformMatrix4f(p),u_globe_matrix:new a.UniformMatrix4f(p),u_normalize_matrix:new a.UniformMatrix4f(p),u_merc_matrix:new a.UniformMatrix4f(p),u_zoom_transition:new a.Uniform1f(p),u_merc_center:new a.Uniform2f(p),u_image0:new a.Uniform1i(p),u_grid_matrix:new a.UniformMatrix3f(p),u_frustum_tl:new a.Uniform3f(p),u_frustum_tr:new a.Uniform3f(p),u_frustum_br:new a.Uniform3f(p),u_frustum_bl:new a.Uniform3f(p),u_globe_pos:new a.Uniform3f(p),u_globe_radius:new a.Uniform1f(p),u_viewport:new a.Uniform2f(p)}),globeAtmosphere:p=>({u_frustum_tl:new a.Uniform3f(p),u_frustum_tr:new a.Uniform3f(p),u_frustum_br:new a.Uniform3f(p),u_frustum_bl:new a.Uniform3f(p),u_horizon:new a.Uniform1f(p),u_transition:new a.Uniform1f(p),u_fadeout_range:new a.Uniform1f(p),u_color:new a.Uniform4f(p),u_high_color:new a.Uniform4f(p),u_space_color:new a.Uniform4f(p),u_star_intensity:new a.Uniform1f(p),u_star_density:new a.Uniform1f(p),u_star_size:new a.Uniform1f(p),u_temporal_offset:new a.Uniform1f(p),u_horizon_angle:new a.Uniform1f(p),u_rotation_matrix:new a.UniformMatrix4f(p)})};let _l;function ru(p,o,h,g,x,b,A){const M=p.context,P=M.gl,k=p.transform,D=p.useProgram("collisionBox"),U=[];let W=0,J=0;for(let he=0;he<g.length;he++){const fe=g[he],le=o.getTile(fe),me=le.getBucket(h);if(!me)continue;const Pe=it(fe,me,k);let ze=Pe;x[0]===0&&x[1]===0||(ze=p.translatePosMatrix(Pe,le,x,b));const ke=A?me.textCollisionBox:me.iconCollisionBox,Ke=me.collisionCircleArray;if(Ke.length>0){const we=a.create(),$e=ze;a.mul(we,me.placementInvProjMatrix,k.glCoordMatrix),a.mul(we,we,me.placementViewportMatrix),U.push({circleArray:Ke,circleOffset:J,transform:$e,invTransform:we,projection:me.getProjection()}),W+=Ke.length/4,J=W}ke&&(p.terrain&&p.terrain.setupElevationDraw(le,D),D.draw(M,P.LINES,a.DepthMode.disabled,a.StencilMode.disabled,p.colorModeForRenderPass(),a.CullFaceMode.disabled,dl(ze,k,le,me.getProjection()),h.id,ke.layoutVertexBuffer,ke.indexBuffer,ke.segments,null,k.zoom,null,[ke.collisionVertexBuffer,ke.collisionVertexBufferExt]))}if(!A||!U.length)return;const X=p.useProgram("collisionCircle"),ee=new a.StructArrayLayout2f1f2i16;ee.resize(4*W),ee._trim();let Y=0;for(const he of U)for(let fe=0;fe<he.circleArray.length/4;fe++){const le=4*fe,me=he.circleArray[le+0],Pe=he.circleArray[le+1],ze=he.circleArray[le+2],ke=he.circleArray[le+3];ee.emplace(Y++,me,Pe,ze,ke,0),ee.emplace(Y++,me,Pe,ze,ke,1),ee.emplace(Y++,me,Pe,ze,ke,2),ee.emplace(Y++,me,Pe,ze,ke,3)}(!_l||_l.length<2*W)&&(_l=function(he){const fe=2*he,le=new a.StructArrayLayout3ui6;le.resize(fe),le._trim();for(let me=0;me<fe;me++){const Pe=6*me;le.uint16[Pe+0]=4*me+0,le.uint16[Pe+1]=4*me+1,le.uint16[Pe+2]=4*me+2,le.uint16[Pe+3]=4*me+2,le.uint16[Pe+4]=4*me+3,le.uint16[Pe+5]=4*me+0}return le}(W));const q=M.createIndexBuffer(_l,!0),ie=M.createVertexBuffer(ee,a.collisionCircleLayout.members,!0);for(const he of U){const fe={u_matrix:he.transform,u_inv_matrix:he.invTransform,u_camera_to_center_distance:(K=k).getCameraToCenterDistance(he.projection),u_viewport_size:[K.width,K.height]};X.draw(M,P.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,p.colorModeForRenderPass(),a.CullFaceMode.disabled,fe,h.id,ie,q,a.SegmentVector.simpleSegment(0,2*he.circleOffset,he.circleArray.length,he.circleArray.length/2),null,k.zoom)}var K;ie.destroy(),q.destroy()}const su=a.create();function No(p,o,h,g,x,b){const{horizontalAlign:A,verticalAlign:M}=a.getAnchorAlignment(p),P=-(A-.5)*o,k=-(M-.5)*h,D=a.evaluateVariableOffset(p,g);return new a.pointGeometry((P/x+D[0])*b,(k/x+D[1])*b)}function em(p,o,h,g,x,b,A,M,P,k,D){const U=p.text.placedSymbolArray,W=p.text.dynamicLayoutVertexArray,J=p.icon.dynamicLayoutVertexArray,X={},ee=xt(M,p.getProjection(),b),Y=b.elevation,q=p.getProjection().upVectorScale(M.canonical,b.center.lat,b.worldSize);W.clear();for(let ie=0;ie<U.length;ie++){const K=U.get(ie),he=p.allowVerticalPlacement&&!K.placedOrientation,fe=K.hidden||!K.crossTileID||he?null:g[K.crossTileID];if(fe){const le=new a.pointGeometry(K.tileAnchorX,K.tileAnchorY),me=p.getProjection().upVector(M.canonical,le.x,le.y),Pe=Y?Y.getAtTileOffset(M,le.x,le.y):0,ze=Vt([K.projectedAnchorX+Pe*me[0]*q.metersToTile,K.projectedAnchorY+Pe*me[1]*q.metersToTile,K.projectedAnchorZ+Pe*me[2]*q.metersToTile],h?ee:A),ke=jt(b.getCameraToCenterDistance(p.getProjection()),ze.signedDistanceFromCamera);let Ke=x.evaluateSizeForFeature(p.textSizeData,k,K)*ke/a.ONE_EM;h&&(Ke*=p.tilePixelRatio/P);const{width:we,height:$e,anchor:je,textOffset:Ie,textScale:ve}=fe,lt=No(je,we,$e,Ie,ve,Ke);let tt;if(h){const nt=le.add(lt),{x:vt,y:Rt,z:Ct}=p.getProjection().projectTilePoint(nt.x,nt.y,M.canonical);tt=Vt([vt+Pe*me[0]*q.metersToTile,Rt+Pe*me[1]*q.metersToTile,Ct+Pe*me[2]*q.metersToTile],A).point}else{const nt=o?lt.rotate(-b.angle):lt;tt=[ze.point[0]+nt.x,ze.point[1]+nt.y,0]}const at=p.allowVerticalPlacement&&K.placedOrientation===a.WritingMode.vertical?Math.PI/2:0;for(let nt=0;nt<K.numGlyphs;nt++)a.addDynamicAttributes(W,tt[0],tt[1],tt[2],at);D&&K.associatedIconIndex>=0&&(X[K.associatedIconIndex]={shiftedAnchor:tt,angle:at})}else gr(K.numGlyphs,W)}if(D){J.clear();const ie=p.icon.placedSymbolArray;for(let K=0;K<ie.length;K++){const he=ie.get(K);if(he.hidden)gr(he.numGlyphs,J);else{const fe=X[K];if(fe)for(let le=0;le<he.numGlyphs;le++)a.addDynamicAttributes(J,fe.shiftedAnchor[0],fe.shiftedAnchor[1],fe.shiftedAnchor[2],fe.angle);else gr(he.numGlyphs,J)}}p.icon.dynamicLayoutVertexBuffer.updateData(J)}p.text.dynamicLayoutVertexBuffer.updateData(W)}function tm(p,o,h){return h.iconsInText&&o?"symbolTextAndIcon":p?"symbolSDF":"symbolIcon"}function md(p,o,h,g,x,b,A,M,P,k,D,U){const W=p.context,J=W.gl,X=p.transform,ee=M==="map",Y=P==="map",q=ee&&h.layout.get("symbol-placement")!=="point",ie=ee&&!Y&&!q,K=h.layout.get("symbol-sort-key").constantOr(1)!==void 0;let he=!1;const fe=p.depthModeForSublayer(0,a.DepthMode.ReadOnly),le=[a.mercatorXfromLng(X.center.lng),a.mercatorYfromLat(X.center.lat)],me=h.layout.get("text-variable-anchor"),Pe=X.projection.name==="globe",ze=[],ke=[0,-1,0];let Ke=ke;!Pe&&!X.mercatorFromTransition||ee||(Ke=function(we){const $e=we._camera.getWorldToCamera(we.worldSize,1),je=a.multiply([],$e,we.globeMatrix);a.invert(je,je);const Ie=[0,0,0],ve=[0,1,0,0];return a.transformMat4$1(ve,ve,je),Ie[0]=ve[0],Ie[1]=ve[1],Ie[2]=ve[2],a.normalize(Ie,Ie),Ie}(X));for(const we of g){const $e=o.getTile(we),je=$e.getBucket(h);if(!je||je.projection.name==="mercator"&&Pe)continue;const Ie=x?je.text:je.icon;if(!Ie||je.fullyClipped||!Ie.segments.get().length)continue;const ve=Ie.programConfigurations.get(h.id),lt=x||je.sdfIcons,tt=x?je.textSizeData:je.iconSizeData,at=Y||X.pitch!==0,nt=a.evaluateSizeForZoom(tt,X.zoom);let vt,Rt,Ct,Et,rt=[0,0],Ft=null;if(x){if(Rt=$e.glyphAtlasTexture,Ct=J.LINEAR,vt=$e.glyphAtlasTexture.size,je.iconsInText){rt=$e.imageAtlasTexture.size,Ft=$e.imageAtlasTexture;const Ln=tt.kind==="composite"||tt.kind==="camera";Et=at||p.options.rotating||p.options.zooming||Ln?J.LINEAR:J.NEAREST}}else{const Ln=h.layout.get("icon-size").constantOr(0)!==1||je.iconsNeedLinear;Rt=$e.imageAtlasTexture,Ct=lt||p.options.rotating||p.options.zooming||Ln||at?J.LINEAR:J.NEAREST,vt=$e.imageAtlasTexture.size}const Ht=je.projection.name==="globe",bi=Ht?Ke:ke,wi=Ht?a.globeToMercatorTransition(X.zoom):0,_i=xt(we,je.getProjection(),X),xn=X.calculatePixelsToTileUnitsMatrix($e),qn=mr(_i,$e.tileID.canonical,Y,ee,X,je.getProjection(),xn),us=p.terrain&&Y&&q?a.invert(a.create(),qn):su,ki=vi(_i,$e.tileID.canonical,Y,ee,X,je.getProjection(),xn),Vi=me&&je.hasTextData(),mi=h.layout.get("icon-text-fit")!=="none"&&Vi&&je.hasIconData();if(q){const Ln=X.elevation,hs=Ln?Ln.getAtTileOffsetFunc(we,X.center.lat,X.worldSize,je.getProjection()):Or=>[0,0,0],Zs=Rr(_i,$e.tileID.canonical,Y,ee,X,je.getProjection(),xn);ns(je,_i,p,x,Zs,ki,Y,k,hs,we)}const nn=q||x&&me||mi,Un=p.translatePosMatrix(_i,$e,b,A),Ii=nn?su:qn,nr=p.translatePosMatrix(ki,$e,b,A,!0),_o=je.getProjection().createInversionMatrix(X,we.canonical),zr=[];p.terrainRenderModeElevated()&&Y&&zr.push("PITCH_WITH_MAP_TERRAIN"),Ht&&zr.push("PROJECTION_GLOBE_VIEW"),nn&&zr.push("PROJECTED_POS_ON_VIEWPORT");const Hn=lt&&h.paint.get(x?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Wo;Wo=lt?je.iconsInText?Jp(tt.kind,nt,ie,Y,p,Un,Ii,nr,vt,rt,we,wi,le,_o,bi,je.getProjection()):ml(tt.kind,nt,ie,Y,p,Un,Ii,nr,x,vt,!0,we,wi,le,_o,bi,je.getProjection()):pd(tt.kind,nt,ie,Y,p,Un,Ii,nr,x,vt,we,wi,le,_o,bi,je.getProjection());const Ws={program:p.useProgram(tm(lt,x,je),ve,zr),buffers:Ie,uniformValues:Wo,atlasTexture:Rt,atlasTextureIcon:Ft,atlasInterpolation:Ct,atlasInterpolationIcon:Et,isSDF:lt,hasHalo:Hn,tile:$e,labelPlaneMatrixInv:us};if(K&&je.canOverlap){he=!0;const Ln=Ie.segments.get();for(const hs of Ln)ze.push({segments:new a.SegmentVector([hs]),sortKey:hs.sortKey,state:Ws})}else ze.push({segments:Ie.segments,sortKey:0,state:Ws})}he&&ze.sort((we,$e)=>we.sortKey-$e.sortKey);for(const we of ze){const $e=we.state;if(p.terrain&&p.terrain.setupElevationDraw($e.tile,$e.program,{useDepthForOcclusion:!Pe,labelPlaneMatrixInv:$e.labelPlaneMatrixInv}),W.activeTexture.set(J.TEXTURE0),$e.atlasTexture.bind($e.atlasInterpolation,J.CLAMP_TO_EDGE),$e.atlasTextureIcon&&(W.activeTexture.set(J.TEXTURE1),$e.atlasTextureIcon&&$e.atlasTextureIcon.bind($e.atlasInterpolationIcon,J.CLAMP_TO_EDGE)),$e.isSDF){const je=$e.uniformValues;$e.hasHalo&&(je.u_is_halo=1,gd($e.buffers,we.segments,h,p,$e.program,fe,D,U,je)),je.u_is_halo=0}gd($e.buffers,we.segments,h,p,$e.program,fe,D,U,$e.uniformValues)}}function gd(p,o,h,g,x,b,A,M,P){const k=g.context,D=[p.dynamicLayoutVertexBuffer,p.opacityVertexBuffer,p.globeExtVertexBuffer];x.draw(k,k.gl.TRIANGLES,b,A,M,a.CullFaceMode.disabled,P,h.id,p.layoutVertexBuffer,p.indexBuffer,o,h.paint,g.transform.zoom,p.programConfigurations.get(h.id),D)}function _d(p,o,h,g,x,b,A){const M=p.context.gl,P=h.paint.get("fill-pattern"),k=P&&P.constantOr(1),D=h.getCrossfadeParameters();let U,W,J,X,ee;A?(W=k&&!h.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",U=M.LINES):(W=k?"fillPattern":"fill",U=M.TRIANGLES);for(const Y of g){const q=o.getTile(Y);if(k&&!q.patternsLoaded())continue;const ie=q.getBucket(h);if(!ie)continue;p.prepareDrawTile();const K=ie.programConfigurations.get(h.id),he=p.useProgram(W,K);k&&(p.context.activeTexture.set(M.TEXTURE0),q.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),K.updatePaintBuffers(D));const fe=P.constantOr(null);if(fe&&q.imageAtlas){const me=q.imageAtlas,Pe=me.patternPositions[fe.to.toString()],ze=me.patternPositions[fe.from.toString()];Pe&&ze&&K.setConstantPatternPositions(Pe,ze)}const le=p.translatePosMatrix(Y.projMatrix,q,h.paint.get("fill-translate"),h.paint.get("fill-translate-anchor"));if(A){X=ie.indexBuffer2,ee=ie.segments2;const me=p.terrain&&p.terrain.renderingToTexture?p.terrain.drapeBufferSize:[M.drawingBufferWidth,M.drawingBufferHeight];J=W==="fillOutlinePattern"&&k?Yp(le,p,D,q,me):ud(le,me)}else X=ie.indexBuffer,ee=ie.segments,J=k?Jc(le,p,D,q):hl(le);p.prepareDrawProgram(p.context,he,Y.toUnwrapped()),he.draw(p.context,U,x,p.stencilModeForClipping(Y),b,a.CullFaceMode.disabled,J,h.id,ie.layoutVertexBuffer,X,ee,h.paint,p.transform.zoom,K)}}function ou(p,o,h,g,x,b,A){const M=p.context,P=M.gl,k=p.transform,D=h.paint.get("fill-extrusion-pattern"),U=D.constantOr(1),W=h.getCrossfadeParameters(),J=h.paint.get("fill-extrusion-opacity"),X=[h.paint.get("fill-extrusion-ambient-occlusion-intensity"),h.paint.get("fill-extrusion-ambient-occlusion-radius")],ee=h.layout.get("fill-extrusion-edge-radius"),Y=k.projection.name==="globe"?a.fillExtrusionHeightLift():0,q=k.projection.name==="globe",ie=q?a.globeToMercatorTransition(k.zoom):0,K=[a.mercatorXfromLng(k.center.lng),a.mercatorYfromLat(k.center.lat)],he=[];q&&(he.push("PROJECTION_GLOBE_VIEW"),p.style.terrainSetForDrapingOnly()&&he.push("TERRAIN")),X[0]>0&&he.push("FAUX_AO");for(const fe of g){const le=o.getTile(fe),me=le.getBucket(h);if(!me||me.projection.name!==k.projection.name)continue;const Pe=me.programConfigurations.get(h.id),ze=p.useProgram(U?"fillExtrusionPattern":"fillExtrusion",Pe,he);if(p.terrain){const ve=p.terrain;if(p.style.terrainSetForDrapingOnly())ve.setupElevationDraw(le,ze,{useMeterToDem:!0});else{if(!me.enableTerrain)continue;if(ve.setupElevationDraw(le,ze,{useMeterToDem:!0}),au(M,o,fe,me,h,ve),!me.centroidVertexBuffer){const lt=ze.attributes.a_centroid_pos;lt!==void 0&&P.vertexAttrib2f(lt,0,0)}}}U&&(p.context.activeTexture.set(P.TEXTURE0),le.imageAtlasTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),Pe.updatePaintBuffers(W));const ke=D.constantOr(null);if(ke&&le.imageAtlas){const ve=le.imageAtlas,lt=ve.patternPositions[ke.to.toString()],tt=ve.patternPositions[ke.from.toString()];lt&&tt&&Pe.setConstantPatternPositions(lt,tt)}const Ke=p.translatePosMatrix(fe.projMatrix,le,h.paint.get("fill-extrusion-translate"),h.paint.get("fill-extrusion-translate-anchor")),we=k.projection.createInversionMatrix(k,fe.canonical),$e=h.paint.get("fill-extrusion-vertical-gradient"),je=U?Kc(Ke,p,$e,J,X,ee,fe,W,le,Y,ie,K,we):ul(Ke,p,$e,J,X,ee,fe,Y,ie,K,we);p.prepareDrawProgram(M,ze,fe.toUnwrapped());const Ie=[];p.terrain&&Ie.push(me.centroidVertexBuffer),q&&Ie.push(me.layoutVertexExtBuffer),ze.draw(M,M.gl.TRIANGLES,x,b,A,a.CullFaceMode.backCCW,je,h.id,me.layoutVertexBuffer,me.indexBuffer,me.segments,h.paint,p.transform.zoom,Pe,Ie)}}function au(p,o,h,g,x,b){const A=[q=>{let ie=q.canonical.x-1,K=q.wrap;return ie<0&&(ie=(1<<q.canonical.z)-1,K--),new a.OverscaledTileID(q.overscaledZ,K,q.canonical.z,ie,q.canonical.y)},q=>{let ie=q.canonical.x+1,K=q.wrap;return ie===1<<q.canonical.z&&(ie=0,K++),new a.OverscaledTileID(q.overscaledZ,K,q.canonical.z,ie,q.canonical.y)},q=>new a.OverscaledTileID(q.overscaledZ,q.wrap,q.canonical.z,q.canonical.x,(q.canonical.y===0?1<<q.canonical.z:q.canonical.y)-1),q=>new a.OverscaledTileID(q.overscaledZ,q.wrap,q.canonical.z,q.canonical.x,q.canonical.y===(1<<q.canonical.z)-1?0:q.canonical.y+1)],M=q=>{const ie=o.getSource().minzoom,K=fe=>{const le=o.getTileByID(fe);if(le&&le.hasData())return le.getBucket(x)},he=[0,-1,1];for(const fe of he){if(q.overscaledZ+fe<ie)continue;const le=K(q.calculateScaledKey(q.overscaledZ+fe));if(le)return le}},P=[0,0,0],k=(q,ie)=>(P[0]=Math.min(q.min.y,ie.min.y),P[1]=Math.max(q.max.y,ie.max.y),P[2]=a.EXTENT-ie.min.x>q.max.x?ie.min.x-a.EXTENT:q.max.x,P),D=(q,ie)=>(P[0]=Math.min(q.min.x,ie.min.x),P[1]=Math.max(q.max.x,ie.max.x),P[2]=a.EXTENT-ie.min.y>q.max.y?ie.min.y-a.EXTENT:q.max.y,P),U=[(q,ie)=>k(q,ie),(q,ie)=>k(ie,q),(q,ie)=>D(q,ie),(q,ie)=>D(ie,q)],W=new a.pointGeometry(0,0);let J,X,ee;const Y=(q,ie,K,he,fe)=>{const le=[[he?K:q,he?q:K,0],[he?K:ie,he?ie:K,0]],me=fe<0?a.EXTENT+fe:fe,Pe=[he?me:(q+ie)/2,he?(q+ie)/2:me,0];return K===0&&fe<0||K!==0&&fe>0?b.getForTilePoints(ee,[Pe],!0,X):le.push(Pe),b.getForTilePoints(h,le,!0,J),Math.max(le[0][2],le[1][2],Pe[2])/b.exaggeration()};for(let q=0;q<4;q++){const ie=(q<2?1:5)-q,K=g.borders[q];if(K.length===0)continue;const he=ee=A[q](h),fe=M(he);if(!(fe&&fe instanceof a.FillExtrusionBucket&&fe.enableTerrain)||g.borderDoneWithNeighborZ[q]===fe.canonical.z&&fe.borderDoneWithNeighborZ[ie]===g.canonical.z||(X=b.findDEMTileFor(he),!X||!X.dem))continue;if(!J){const ze=b.findDEMTileFor(h);if(!ze||!ze.dem)return;J=ze}const le=fe.borders[ie];let me=0;const Pe=fe.borderDoneWithNeighborZ[ie]!==g.canonical.z;if(g.canonical.z===fe.canonical.z){for(let ze=0;ze<K.length;ze++){const ke=g.featuresOnBorder[K[ze]],Ke=ke.borders[q];let we;for(;me<le.length&&(we=fe.featuresOnBorder[le[me]],!(we.borders[ie][1]>Ke[0]+3));)Pe&&fe.encodeCentroid(void 0,we,!1),me++;if(we&&me<le.length){const $e=me;let je=0;for(;!(we.borders[ie][0]>Ke[1]-3)&&(je++,++me!==le.length);)we=fe.featuresOnBorder[le[me]];if(we=fe.featuresOnBorder[le[$e]],ke.intersectsCount()>1||we.intersectsCount()>1||je!==1){je!==1&&(me=$e),g.encodeCentroid(void 0,ke,!1),Pe&&fe.encodeCentroid(void 0,we,!1);continue}const Ie=U[q](ke,we),ve=q%2?a.EXTENT-1:0;W.x=Y(Ie[0],Math.min(a.EXTENT-1,Ie[1]),ve,q<2,Ie[2]),W.y=0,g.encodeCentroid(W,ke,!1),Pe&&fe.encodeCentroid(W,we,!1)}else g.encodeCentroid(void 0,ke,!1)}g.borderDoneWithNeighborZ[q]=fe.canonical.z,g.needsCentroidUpdate=!0,Pe&&(fe.borderDoneWithNeighborZ[ie]=g.canonical.z,fe.needsCentroidUpdate=!0)}else{for(const ze of K)g.encodeCentroid(void 0,g.featuresOnBorder[ze],!1);if(Pe){for(const ze of le)fe.encodeCentroid(void 0,fe.featuresOnBorder[ze],!1);fe.borderDoneWithNeighborZ[ie]=g.canonical.z,fe.needsCentroidUpdate=!0}g.borderDoneWithNeighborZ[q]=fe.canonical.z,g.needsCentroidUpdate=!0}}(g.needsCentroidUpdate||!g.centroidVertexBuffer&&g.centroidVertexArray.length!==0)&&g.uploadCentroid(p)}const lu=new a.Color(1,0,0,1),yd=new a.Color(0,1,0,1),xd=new a.Color(0,0,1,1),vd=new a.Color(1,0,1,1),cu=new a.Color(0,1,1,1);function po(p,o,h){const g=p.context,x=p.transform,b=g.gl,A=x.projection.name==="globe",M=A?["PROJECTION_GLOBE_VIEW"]:null;let P=h.projMatrix;if(A&&a.globeToMercatorTransition(x.zoom)>0){const ke=a.transitionTileAABBinECEF(h.canonical,x),Ke=a.globeDenormalizeECEF(ke);P=a.multiply(new Float32Array(16),x.globeMatrix,Ke),a.multiply(P,x.projMatrix,P)}const k=p.useProgram("debug",null,M),D=o.getTileByID(h.key);p.terrain&&p.terrain.setupElevationDraw(D,k);const U=a.DepthMode.disabled,W=a.StencilMode.disabled,J=p.colorModeForRenderPass(),X="$debug";g.activeTexture.set(b.TEXTURE0),p.emptyTexture.bind(b.LINEAR,b.CLAMP_TO_EDGE),A?D._makeGlobeTileDebugBuffers(p.context,x):D._makeDebugTileBoundsBuffers(p.context,x.projection);const ee=D._tileDebugBuffer||p.debugBuffer,Y=D._tileDebugIndexBuffer||p.debugIndexBuffer,q=D._tileDebugSegments||p.debugSegments;k.draw(g,b.LINE_STRIP,U,W,J,a.CullFaceMode.disabled,fl(P,a.Color.red),X,ee,Y,q,null,null,null,[D._globeTileDebugBorderBuffer]);const ie=D.latestRawTileData,K=Math.floor((ie&&ie.byteLength||0)/1024),he=o.getTile(h).tileSize,fe=512/Math.min(he,512)*(h.overscaledZ/x.zoom)*.5;let le=h.canonical.toString();h.overscaledZ!==h.canonical.z&&(le+=` => ${h.overscaledZ}`),le+=` ${K}kb`,function(ke,Ke){ke.initDebugOverlayCanvas();const we=ke.debugOverlayCanvas,$e=ke.context.gl,je=ke.debugOverlayCanvas.getContext("2d");je.clearRect(0,0,we.width,we.height),je.shadowColor="white",je.shadowBlur=2,je.lineWidth=1.5,je.strokeStyle="white",je.textBaseline="top",je.font="bold 36px Open Sans, sans-serif",je.fillText(Ke,5,5),je.strokeText(Ke,5,5),ke.debugOverlayTexture.update(we),ke.debugOverlayTexture.bind($e.LINEAR,$e.CLAMP_TO_EDGE)}(p,le);const me=D._tileDebugTextBuffer||p.debugBuffer,Pe=D._tileDebugTextIndexBuffer||p.quadTriangleIndexBuffer,ze=D._tileDebugTextSegments||p.debugSegments;k.draw(g,b.TRIANGLES,U,W,a.ColorMode.alphaBlended,a.CullFaceMode.disabled,fl(P,a.Color.transparent,fe),X,me,Pe,ze,null,null,null,[D._globeTileDebugTextBuffer])}function Uo(p,o,h,g){ws(p,0,o+h/2,p.transform.width,h,g)}function uu(p,o,h,g){ws(p,o-h/2,0,h,p.transform.height,g)}function ws(p,o,h,g,x,b){const A=p.context,M=A.gl;M.enable(M.SCISSOR_TEST),M.scissor(o*a.exported.devicePixelRatio,h*a.exported.devicePixelRatio,g*a.exported.devicePixelRatio,x*a.exported.devicePixelRatio),A.clear({color:b}),M.disable(M.SCISSOR_TEST)}const Vo=a.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:bd}=Vo;function ls(p,o,h,g){p.emplaceBack(o,h,g)}class hi{constructor(o){this.vertexArray=new a.StructArrayLayout3f12,this.indices=new a.StructArrayLayout3ui6,ls(this.vertexArray,-1,-1,1),ls(this.vertexArray,1,-1,1),ls(this.vertexArray,-1,1,1),ls(this.vertexArray,1,1,1),ls(this.vertexArray,-1,-1,-1),ls(this.vertexArray,1,-1,-1),ls(this.vertexArray,-1,1,-1),ls(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=o.createVertexBuffer(this.vertexArray,bd),this.indexBuffer=o.createIndexBuffer(this.indices),this.segment=a.SegmentVector.simpleSegment(0,0,36,12)}}function Ts(p,o,h,g,x,b){const A=p.gl,M=o.paint.get("sky-atmosphere-color"),P=o.paint.get("sky-atmosphere-halo-color"),k=o.paint.get("sky-atmosphere-sun-intensity"),D=((U,W,J,X,ee)=>({u_matrix_3f:U,u_sun_direction:W,u_sun_intensity:J,u_color_tint_r:[X.r,X.g,X.b,X.a],u_color_tint_m:[ee.r,ee.g,ee.b,ee.a],u_luminance:5e-5}))(a.fromMat4(a.create$1(),g),x,k,M,P);A.framebufferTexture2D(A.FRAMEBUFFER,A.COLOR_ATTACHMENT0,A.TEXTURE_CUBE_MAP_POSITIVE_X+b,o.skyboxTexture,0),h.draw(p,A.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,a.ColorMode.unblended,a.CullFaceMode.frontCW,D,"skyboxCapture",o.skyboxGeometry.vertexBuffer,o.skyboxGeometry.indexBuffer,o.skyboxGeometry.segment)}const im=a.createLayout([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class wd{constructor(o){const h=new a.StructArrayLayout5f20;h.emplaceBack(-1,1,1,0,0),h.emplaceBack(1,1,1,1,0),h.emplaceBack(1,-1,1,1,1),h.emplaceBack(-1,-1,1,0,1);const g=new a.StructArrayLayout3ui6;g.emplaceBack(0,1,2),g.emplaceBack(2,3,0),this.vertexBuffer=o.createVertexBuffer(h,im.members),this.indexBuffer=o.createIndexBuffer(g),this.segments=a.SegmentVector.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const jo={symbol:function(p,o,h,g,x){if(p.renderPass!=="translucent")return;const b=a.StencilMode.disabled,A=p.colorModeForRenderPass();h.layout.get("text-variable-anchor")&&function(M,P,k,D,U,W,J){const X=P.transform,ee=U==="map",Y=W==="map";for(const q of M){const ie=D.getTile(q),K=ie.getBucket(k);if(!K||!K.text||!K.text.segments.get().length)continue;const he=a.evaluateSizeForZoom(K.textSizeData,X.zoom),fe=xt(q,K.getProjection(),X),le=X.calculatePixelsToTileUnitsMatrix(ie),me=mr(fe,ie.tileID.canonical,Y,ee,X,K.getProjection(),le),Pe=k.layout.get("icon-text-fit")!=="none"&&K.hasIconData();if(he){const ze=Math.pow(2,X.zoom-ie.tileID.overscaledZ);em(K,ee,Y,J,a.symbolSize,X,me,q,ze,he,Pe)}}}(g,p,h,o,h.layout.get("text-rotation-alignment"),h.layout.get("text-pitch-alignment"),x),h.paint.get("icon-opacity").constantOr(1)!==0&&md(p,o,h,g,!1,h.paint.get("icon-translate"),h.paint.get("icon-translate-anchor"),h.layout.get("icon-rotation-alignment"),h.layout.get("icon-pitch-alignment"),h.layout.get("icon-keep-upright"),b,A),h.paint.get("text-opacity").constantOr(1)!==0&&md(p,o,h,g,!0,h.paint.get("text-translate"),h.paint.get("text-translate-anchor"),h.layout.get("text-rotation-alignment"),h.layout.get("text-pitch-alignment"),h.layout.get("text-keep-upright"),b,A),o.map.showCollisionBoxes&&(ru(p,o,h,g,h.paint.get("text-translate"),h.paint.get("text-translate-anchor"),!0),ru(p,o,h,g,h.paint.get("icon-translate"),h.paint.get("icon-translate-anchor"),!1))},circle:function(p,o,h,g){if(p.renderPass!=="translucent")return;const x=h.paint.get("circle-opacity"),b=h.paint.get("circle-stroke-width"),A=h.paint.get("circle-stroke-opacity"),M=h.layout.get("circle-sort-key").constantOr(1)!==void 0;if(x.constantOr(1)===0&&(b.constantOr(1)===0||A.constantOr(1)===0))return;const P=p.context,k=P.gl,D=p.transform,U=p.depthModeForSublayer(0,a.DepthMode.ReadOnly),W=a.StencilMode.disabled,J=p.colorModeForRenderPass(),X=D.projection.name==="globe",ee=[a.mercatorXfromLng(D.center.lng),a.mercatorYfromLat(D.center.lat)],Y=[];for(let ie=0;ie<g.length;ie++){const K=g[ie],he=o.getTile(K),fe=he.getBucket(h);if(!fe||fe.projection.name!==D.projection.name)continue;const le=fe.programConfigurations.get(h.id),me=hd(h);X&&me.push("PROJECTION_GLOBE_VIEW");const Pe=p.useProgram("circle",le,me),ze=fe.layoutVertexBuffer,ke=fe.globeExtVertexBuffer,Ke=fe.indexBuffer,we=D.projection.createInversionMatrix(D,K.canonical),$e={programConfiguration:le,program:Pe,layoutVertexBuffer:ze,globeExtVertexBuffer:ke,indexBuffer:Ke,uniformValues:ma(p,K,he,we,ee,h),tile:he};if(M){const je=fe.segments.get();for(const Ie of je)Y.push({segments:new a.SegmentVector([Ie]),sortKey:Ie.sortKey,state:$e})}else Y.push({segments:fe.segments,sortKey:0,state:$e})}M&&Y.sort((ie,K)=>ie.sortKey-K.sortKey);const q={useDepthForOcclusion:!X};for(const ie of Y){const{programConfiguration:K,program:he,layoutVertexBuffer:fe,globeExtVertexBuffer:le,indexBuffer:me,uniformValues:Pe,tile:ze}=ie.state,ke=ie.segments;p.terrain&&p.terrain.setupElevationDraw(ze,he,q),p.prepareDrawProgram(P,he,ze.tileID.toUnwrapped()),he.draw(P,k.TRIANGLES,U,W,J,a.CullFaceMode.disabled,Pe,h.id,fe,me,ke,h.paint,D.zoom,K,[le])}},heatmap:function(p,o,h,g){if(h.paint.get("heatmap-opacity")!==0)if(p.renderPass==="offscreen"){const x=p.context,b=x.gl,A=a.StencilMode.disabled,M=new a.ColorMode([b.ONE,b.ONE],a.Color.transparent,[!0,!0,!0,!0]);(function(J,X,ee,Y){const q=J.gl,ie=X.width*Y,K=X.height*Y;J.activeTexture.set(q.TEXTURE1),J.viewport.set([0,0,ie,K]);let he=ee.heatmapFbo;if(!he||he&&(he.width!==ie||he.height!==K)){he&&he.destroy();const fe=q.createTexture();q.bindTexture(q.TEXTURE_2D,fe),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_S,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_T,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MIN_FILTER,q.LINEAR),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR),he=ee.heatmapFbo=J.createFramebuffer(ie,K,!1),function(le,me,Pe,ze,ke,Ke){const we=le.gl;we.texImage2D(we.TEXTURE_2D,0,we.RGBA,ke,Ke,0,we.RGBA,le.extRenderToTextureHalfFloat?le.extTextureHalfFloat.HALF_FLOAT_OES:we.UNSIGNED_BYTE,null),ze.colorAttachment.set(Pe)}(J,0,fe,he,ie,K)}else q.bindTexture(q.TEXTURE_2D,he.colorAttachment.get()),J.bindFramebuffer.set(he.framebuffer)})(x,p,h,p.transform.projection.name==="globe"?.5:.25),x.clear({color:a.Color.transparent});const P=p.transform,k=P.projection.name==="globe",D=k?["PROJECTION_GLOBE_VIEW"]:null,U=k?a.CullFaceMode.frontCCW:a.CullFaceMode.disabled,W=[a.mercatorXfromLng(P.center.lng),a.mercatorYfromLat(P.center.lat)];for(let J=0;J<g.length;J++){const X=g[J];if(o.hasRenderableParent(X))continue;const ee=o.getTile(X),Y=ee.getBucket(h);if(!Y||Y.projection.name!==P.projection.name)continue;const q=Y.programConfigurations.get(h.id),ie=p.useProgram("heatmap",q,D),{zoom:K}=p.transform;p.terrain&&p.terrain.setupElevationDraw(ee,ie),p.prepareDrawProgram(x,ie,X.toUnwrapped());const he=P.projection.createInversionMatrix(P,X.canonical);ie.draw(x,b.TRIANGLES,a.DepthMode.disabled,A,M,U,Qc(p,X,ee,he,W,K,h.paint.get("heatmap-intensity")),h.id,Y.layoutVertexBuffer,Y.indexBuffer,Y.segments,h.paint,p.transform.zoom,q,k?[Y.globeExtVertexBuffer]:null)}x.viewport.set([0,0,p.width,p.height])}else p.renderPass==="translucent"&&(p.context.setColorMode(p.colorModeForRenderPass()),function(x,b){const A=x.context,M=A.gl,P=b.heatmapFbo;if(!P)return;A.activeTexture.set(M.TEXTURE0),M.bindTexture(M.TEXTURE_2D,P.colorAttachment.get()),A.activeTexture.set(M.TEXTURE1);let k=b.colorRampTexture;k||(k=b.colorRampTexture=new a.Texture(A,b.colorRamp,M.RGBA)),k.bind(M.LINEAR,M.CLAMP_TO_EDGE),x.useProgram("heatmapTexture").draw(A,M.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,x.colorModeForRenderPass(),a.CullFaceMode.disabled,((D,U,W,J)=>({u_image:0,u_color_ramp:1,u_opacity:U.paint.get("heatmap-opacity")}))(0,b),b.id,x.viewportBuffer,x.quadTriangleIndexBuffer,x.viewportSegments,b.paint,x.transform.zoom)}(p,h))},line:function(p,o,h,g){if(p.renderPass!=="translucent")return;const x=h.paint.get("line-opacity"),b=h.paint.get("line-width");if(x.constantOr(1)===0||b.constantOr(1)===0)return;const A=p.depthModeForSublayer(0,a.DepthMode.ReadOnly),M=p.colorModeForRenderPass(),P=p.terrain&&p.terrain.renderingToTexture?1:a.exported.devicePixelRatio,k=h.paint.get("line-dasharray"),D=k.constantOr(1),U=h.layout.get("line-cap"),W=h.paint.get("line-pattern"),J=W.constantOr(1),X=h.paint.get("line-gradient"),ee=h.getCrossfadeParameters(),Y=J?"linePattern":"line",q=p.context,ie=q.gl,K=(fe=>{const le=[];fd(fe)&&le.push("RENDER_LINE_DASH"),fe.paint.get("line-gradient")&&le.push("RENDER_LINE_GRADIENT");const me=fe.paint.get("line-trim-offset");me[0]===0&&me[1]===0||le.push("RENDER_LINE_TRIM_OFFSET");const Pe=fe.paint.get("line-pattern").constantOr(1),ze=fe.paint.get("line-opacity").constantOr(1)!==1;return!Pe&&ze&&le.push("RENDER_LINE_ALPHA_DISCARD"),le})(h);let he=K.includes("RENDER_LINE_ALPHA_DISCARD");p.terrain&&p.terrain.clipOrMaskOverlapStencilType()&&(he=!1);for(const fe of g){const le=o.getTile(fe);if(J&&!le.patternsLoaded())continue;const me=le.getBucket(h);if(!me)continue;p.prepareDrawTile();const Pe=me.programConfigurations.get(h.id),ze=p.useProgram(Y,Pe,K),ke=W.constantOr(null);if(ke&&le.imageAtlas){const tt=le.imageAtlas,at=tt.patternPositions[ke.to.toString()],nt=tt.patternPositions[ke.from.toString()];at&&nt&&Pe.setConstantPatternPositions(at,nt)}const Ke=k.constantOr(null),we=U.constantOr(null);if(!J&&Ke&&we&&le.lineAtlas){const tt=le.lineAtlas,at=tt.getDash(Ke.to,we),nt=tt.getDash(Ke.from,we);at&&nt&&Pe.setConstantPatternPositions(at,nt)}let[$e,je]=h.paint.get("line-trim-offset");(we==="round"||we==="square")&&$e!==je&&($e===0&&($e-=1),je===1&&(je+=1));const Ie=p.terrain?fe.projMatrix:null,ve=J?eu(p,le,h,ee,Ie,P):dd(p,le,h,ee,Ie,me.lineClipsArray.length,P,[$e,je]);if(X){const tt=me.gradients[h.id];let at=tt.texture;if(h.gradientVersion!==tt.version){let nt=256;if(h.stepInterpolant){const vt=o.getSource().maxzoom,Rt=fe.canonical.z===vt?Math.ceil(1<<p.transform.maxZoom-fe.canonical.z):1;nt=a.clamp(a.nextPowerOfTwo(me.maxLineLength/a.EXTENT*1024*Rt),256,q.maxTextureSize)}tt.gradient=a.renderColorRamp({expression:h.gradientExpression(),evaluationKey:"lineProgress",resolution:nt,image:tt.gradient||void 0,clips:me.lineClipsArray}),tt.texture?tt.texture.update(tt.gradient):tt.texture=new a.Texture(q,tt.gradient,ie.RGBA),tt.version=h.gradientVersion,at=tt.texture}q.activeTexture.set(ie.TEXTURE1),at.bind(h.stepInterpolant?ie.NEAREST:ie.LINEAR,ie.CLAMP_TO_EDGE)}D&&(q.activeTexture.set(ie.TEXTURE0),le.lineAtlasTexture.bind(ie.LINEAR,ie.REPEAT),Pe.updatePaintBuffers(ee)),J&&(q.activeTexture.set(ie.TEXTURE0),le.imageAtlasTexture.bind(ie.LINEAR,ie.CLAMP_TO_EDGE),Pe.updatePaintBuffers(ee)),p.prepareDrawProgram(q,ze,fe.toUnwrapped());const lt=tt=>{ze.draw(q,ie.TRIANGLES,A,tt,M,a.CullFaceMode.disabled,ve,h.id,me.layoutVertexBuffer,me.indexBuffer,me.segments,h.paint,p.transform.zoom,Pe,[me.layoutVertexBuffer2])};if(he){const tt=p.stencilModeForClipping(fe).ref;tt===0&&p.terrain&&q.clear({stencil:0});const at={func:ie.EQUAL,mask:255};ve.u_alpha_discard_threshold=.8,lt(new a.StencilMode(at,tt,255,ie.KEEP,ie.KEEP,ie.INVERT)),ve.u_alpha_discard_threshold=0,lt(new a.StencilMode(at,tt,255,ie.KEEP,ie.KEEP,ie.KEEP))}else lt(p.stencilModeForClipping(fe))}he&&(p.resetStencilClippingMasks(),p.terrain&&q.clear({stencil:0}))},fill:function(p,o,h,g){const x=h.paint.get("fill-color"),b=h.paint.get("fill-opacity");if(b.constantOr(1)===0)return;const A=p.colorModeForRenderPass(),M=h.paint.get("fill-pattern"),P=p.opaquePassEnabledForLayer()&&!M.constantOr(1)&&x.constantOr(a.Color.transparent).a===1&&b.constantOr(0)===1?"opaque":"translucent";if(p.renderPass===P){const k=p.depthModeForSublayer(1,p.renderPass==="opaque"?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly);_d(p,o,h,g,k,A,!1)}if(p.renderPass==="translucent"&&h.paint.get("fill-antialias")){const k=p.depthModeForSublayer(h.getPaintProperty("fill-outline-color")?2:0,a.DepthMode.ReadOnly);_d(p,o,h,g,k,A,!0)}},"fill-extrusion":function(p,o,h,g){const x=h.paint.get("fill-extrusion-opacity");if(x!==0&&p.renderPass==="translucent"){const b=new a.DepthMode(p.context.gl.LEQUAL,a.DepthMode.ReadWrite,p.depthRangeFor3D);if(x!==1||h.paint.get("fill-extrusion-pattern").constantOr(1))ou(p,o,h,g,b,a.StencilMode.disabled,a.ColorMode.disabled),ou(p,o,h,g,b,p.stencilModeFor3D(),p.colorModeForRenderPass()),p.resetStencilClippingMasks();else{const A=p.colorModeForRenderPass();ou(p,o,h,g,b,a.StencilMode.disabled,A)}}},hillshade:function(p,o,h,g){if(p.renderPass!=="offscreen"&&p.renderPass!=="translucent")return;const x=p.context,b=p.depthModeForSublayer(0,a.DepthMode.ReadOnly),A=p.colorModeForRenderPass(),M=p.terrain&&p.terrain.renderingToTexture,[P,k]=p.renderPass!=="translucent"||M?[{},g]:p.stencilConfigForOverlap(g);for(const D of k){const U=o.getTile(D);if(U.needsHillshadePrepare&&p.renderPass==="offscreen")rd(p,U,h,b,a.StencilMode.disabled,A);else if(p.renderPass==="translucent"){const W=M&&p.terrain?p.terrain.stencilModeForRTTOverlap(D):P[D.overscaledZ];sl(p,D,U,h,b,W,A)}}x.viewport.set([0,0,p.width,p.height]),p.resetStencilClippingMasks()},raster:function(p,o,h,g,x,b){if(p.renderPass!=="translucent"||h.paint.get("raster-opacity")===0||!g.length)return;const A=p.context,M=A.gl,P=o.getSource(),k=p.useProgram("raster"),D=p.colorModeForRenderPass(),U=p.terrain&&p.terrain.renderingToTexture,[W,J]=P instanceof ge||U?[{},g]:p.stencilConfigForOverlap(g),X=J[J.length-1].overscaledZ,ee=!p.options.moving;for(const Y of J){const q=U?a.DepthMode.disabled:p.depthModeForSublayer(Y.overscaledZ-X,h.paint.get("raster-opacity")===1?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly,M.LESS),ie=Y.toUnwrapped(),K=o.getTile(Y);if(U&&(!K||!K.hasData()))continue;const he=U?Y.projMatrix:p.transform.calculateProjMatrix(ie,ee),fe=p.terrain&&U?p.terrain.stencilModeForRTTOverlap(Y):W[Y.overscaledZ],le=b?0:h.paint.get("raster-fade-duration");K.registerFadeDuration(le);const me=o.findLoadedParent(Y,0),Pe=Xc(K,me,o,p.transform,le);let ze,ke;p.terrain&&p.terrain.prepareDrawTile();const Ke=h.paint.get("raster-resampling")==="nearest"?M.NEAREST:M.LINEAR;A.activeTexture.set(M.TEXTURE0),K.texture.bind(Ke,M.CLAMP_TO_EDGE),A.activeTexture.set(M.TEXTURE1),me?(me.texture.bind(Ke,M.CLAMP_TO_EDGE),ze=Math.pow(2,me.tileID.overscaledZ-K.tileID.overscaledZ),ke=[K.tileID.canonical.x*ze%1,K.tileID.canonical.y*ze%1]):K.texture.bind(Ke,M.CLAMP_TO_EDGE);const we=iu(he,ke||[0,0],ze||1,Pe,h,P instanceof ge?P.perspectiveTransform:[0,0]);if(p.prepareDrawProgram(A,k,ie),P instanceof ge)P.boundsBuffer&&P.boundsSegments&&k.draw(A,M.TRIANGLES,q,a.StencilMode.disabled,D,a.CullFaceMode.disabled,we,h.id,P.boundsBuffer,p.quadTriangleIndexBuffer,P.boundsSegments);else{const{tileBoundsBuffer:$e,tileBoundsIndexBuffer:je,tileBoundsSegments:Ie}=p.getTileBoundsBuffers(K);k.draw(A,M.TRIANGLES,q,fe,D,a.CullFaceMode.disabled,we,h.id,$e,je,Ie)}}p.resetStencilClippingMasks()},background:function(p,o,h,g){const x=h.paint.get("background-color"),b=h.paint.get("background-opacity");if(b===0)return;const A=p.context,M=A.gl,P=p.transform,k=P.tileSize,D=h.paint.get("background-pattern");if(p.isPatternMissing(D))return;const U=!D&&x.a===1&&b===1&&p.opaquePassEnabledForLayer()?"opaque":"translucent";if(p.renderPass!==U)return;const W=a.StencilMode.disabled,J=p.depthModeForSublayer(0,U==="opaque"?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly),X=p.colorModeForRenderPass(),ee=p.useProgram(D?"backgroundPattern":"background");let Y,q=g;q||(Y=p.getBackgroundTiles(),q=Object.values(Y).map(K=>K.tileID)),D&&(A.activeTexture.set(M.TEXTURE0),p.imageManager.bind(p.context));const ie=h.getCrossfadeParameters();for(const K of q){const he=K.toUnwrapped(),fe=g?K.projMatrix:p.transform.calculateProjMatrix(he);p.prepareDrawTile();const le=o?o.getTile(K):Y?Y[K.key]:new a.Tile(K,k,P.zoom,p),me=D?Qp(fe,b,p,D,{tileID:K,tileSize:k},ie):nu(fe,b,x);p.prepareDrawProgram(A,ee,he);const{tileBoundsBuffer:Pe,tileBoundsIndexBuffer:ze,tileBoundsSegments:ke}=p.getTileBoundsBuffers(le);ee.draw(A,M.TRIANGLES,J,W,X,a.CullFaceMode.disabled,me,h.id,Pe,ze,ke)}},sky:function(p,o,h){const g=p.transform,x=g.projection.name==="mercator"||g.projection.name==="globe"?1:a.smoothstep(7,8,g.zoom),b=h.paint.get("sky-opacity")*x;if(b===0)return;const A=p.context,M=h.paint.get("sky-type"),P=new a.DepthMode(A.gl.LEQUAL,a.DepthMode.ReadOnly,[0,1]),k=p.frameCounter/1e3%1;M==="atmosphere"?p.renderPass==="offscreen"?h.needsSkyboxCapture(p)&&(function(D,U,W,J){const X=D.context,ee=X.gl;let Y=U.skyboxFbo;if(!Y){Y=U.skyboxFbo=X.createFramebuffer(32,32,!1),U.skyboxGeometry=new hi(X),U.skyboxTexture=X.gl.createTexture(),ee.bindTexture(ee.TEXTURE_CUBE_MAP,U.skyboxTexture),ee.texParameteri(ee.TEXTURE_CUBE_MAP,ee.TEXTURE_WRAP_S,ee.CLAMP_TO_EDGE),ee.texParameteri(ee.TEXTURE_CUBE_MAP,ee.TEXTURE_WRAP_T,ee.CLAMP_TO_EDGE),ee.texParameteri(ee.TEXTURE_CUBE_MAP,ee.TEXTURE_MIN_FILTER,ee.LINEAR),ee.texParameteri(ee.TEXTURE_CUBE_MAP,ee.TEXTURE_MAG_FILTER,ee.LINEAR);for(let he=0;he<6;++he)ee.texImage2D(ee.TEXTURE_CUBE_MAP_POSITIVE_X+he,0,ee.RGBA,32,32,0,ee.RGBA,ee.UNSIGNED_BYTE,null)}X.bindFramebuffer.set(Y.framebuffer),X.viewport.set([0,0,32,32]);const q=U.getCenter(D,!0),ie=D.useProgram("skyboxCapture"),K=new Float64Array(16);a.identity(K),a.rotateY(K,K,.5*-Math.PI),Ts(X,U,ie,K,q,0),a.identity(K),a.rotateY(K,K,.5*Math.PI),Ts(X,U,ie,K,q,1),a.identity(K),a.rotateX(K,K,.5*-Math.PI),Ts(X,U,ie,K,q,2),a.identity(K),a.rotateX(K,K,.5*Math.PI),Ts(X,U,ie,K,q,3),a.identity(K),Ts(X,U,ie,K,q,4),a.identity(K),a.rotateY(K,K,Math.PI),Ts(X,U,ie,K,q,5),X.viewport.set([0,0,D.width,D.height])}(p,h),h.markSkyboxValid(p)):p.renderPass==="sky"&&function(D,U,W,J,X){const ee=D.context,Y=ee.gl,q=D.transform,ie=D.useProgram("skybox");ee.activeTexture.set(Y.TEXTURE0),Y.bindTexture(Y.TEXTURE_CUBE_MAP,U.skyboxTexture);const K=((he,fe,le,me,Pe)=>({u_matrix:he,u_sun_direction:fe,u_cubemap:0,u_opacity:me,u_temporal_offset:Pe}))(q.skyboxMatrix,U.getCenter(D,!1),0,J,X);D.prepareDrawProgram(ee,ie),ie.draw(ee,Y.TRIANGLES,W,a.StencilMode.disabled,D.colorModeForRenderPass(),a.CullFaceMode.backCW,K,"skybox",U.skyboxGeometry.vertexBuffer,U.skyboxGeometry.indexBuffer,U.skyboxGeometry.segment)}(p,h,P,b,k):M==="gradient"&&p.renderPass==="sky"&&function(D,U,W,J,X){const ee=D.context,Y=ee.gl,q=D.transform,ie=D.useProgram("skyboxGradient");U.skyboxGeometry||(U.skyboxGeometry=new hi(ee)),ee.activeTexture.set(Y.TEXTURE0);let K=U.colorRampTexture;K||(K=U.colorRampTexture=new a.Texture(ee,U.colorRamp,Y.RGBA)),K.bind(Y.LINEAR,Y.CLAMP_TO_EDGE);const he=((fe,le,me,Pe,ze)=>({u_matrix:fe,u_color_ramp:0,u_center_direction:le,u_radius:a.degToRad(me),u_opacity:Pe,u_temporal_offset:ze}))(q.skyboxMatrix,U.getCenter(D,!1),U.paint.get("sky-gradient-radius"),J,X);D.prepareDrawProgram(ee,ie),ie.draw(ee,Y.TRIANGLES,W,a.StencilMode.disabled,D.colorModeForRenderPass(),a.CullFaceMode.backCW,he,"skyboxGradient",U.skyboxGeometry.vertexBuffer,U.skyboxGeometry.indexBuffer,U.skyboxGeometry.segment)}(p,h,P,b,k)},debug:function(p,o,h){for(let g=0;g<h.length;g++)po(p,o,h[g])},custom:function(p,o,h){const g=p.context,x=h.implementation;if(p.transform.projection.unsupportedLayers&&p.transform.projection.unsupportedLayers.includes("custom"))a.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if(p.renderPass==="offscreen"){const b=x.prerender;b&&(p.setCustomLayerDefaults(),g.setColorMode(p.colorModeForRenderPass()),b.call(x,g.gl,p.transform.customLayerMatrix()),g.setDirty(),p.setBaseState())}else if(p.renderPass==="translucent"){p.setCustomLayerDefaults(),g.setColorMode(p.colorModeForRenderPass()),g.setStencilMode(a.StencilMode.disabled);const b=x.renderingMode==="3d"?new a.DepthMode(p.context.gl.LEQUAL,a.DepthMode.ReadWrite,p.depthRangeFor3D):p.depthModeForSublayer(0,a.DepthMode.ReadOnly);g.setDepthMode(b),x.render(g.gl,p.transform.customLayerMatrix()),g.setDirty(),p.setBaseState(),g.bindFramebuffer.set(null)}}};class nm{constructor(o,h){this.context=new F(o),this.transform=h,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=a.SourceCache.maxUnderzooming+a.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new ho,this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(o,h){const g=!!o&&!!o.terrain&&this.transform.projection.supportsTerrain;if(!(g||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new ad(this,o));const x=this._terrain;this.transform.elevation=g?x:null,x.update(o,this.transform,h)}_updateFog(o){const h=o.fog;if(!h||this.transform.projection.name==="globe"||h.getOpacity(this.transform.pitch)<1||h.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[g,x]=h.getFovAdjustedRange(this.transform._fov);if(g>x)return void(this.transform.fogCullDistSq=null);const b=g+.78*(x-g);this.transform.fogCullDistSq=b*b}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(o,h){if(this.width=o*a.exported.devicePixelRatio,this.height=h*a.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const g of this.style.order)this.style._layers[g].resize()}setup(){const o=this.context,h=new a.StructArrayLayout2i4;h.emplaceBack(0,0),h.emplaceBack(a.EXTENT,0),h.emplaceBack(0,a.EXTENT),h.emplaceBack(a.EXTENT,a.EXTENT),this.tileExtentBuffer=o.createVertexBuffer(h,a.posAttributes.members),this.tileExtentSegments=a.SegmentVector.simpleSegment(0,0,4,2);const g=new a.StructArrayLayout2i4;g.emplaceBack(0,0),g.emplaceBack(a.EXTENT,0),g.emplaceBack(0,a.EXTENT),g.emplaceBack(a.EXTENT,a.EXTENT),this.debugBuffer=o.createVertexBuffer(g,a.posAttributes.members),this.debugSegments=a.SegmentVector.simpleSegment(0,0,4,5);const x=new a.StructArrayLayout2i4;x.emplaceBack(-1,-1),x.emplaceBack(1,-1),x.emplaceBack(-1,1),x.emplaceBack(1,1),this.viewportBuffer=o.createVertexBuffer(x,a.posAttributes.members),this.viewportSegments=a.SegmentVector.simpleSegment(0,0,4,2);const b=new a.StructArrayLayout4i8;b.emplaceBack(0,0,0,0),b.emplaceBack(a.EXTENT,0,a.EXTENT,0),b.emplaceBack(0,a.EXTENT,0,a.EXTENT),b.emplaceBack(a.EXTENT,a.EXTENT,a.EXTENT,a.EXTENT),this.mercatorBoundsBuffer=o.createVertexBuffer(b,a.boundsAttributes.members),this.mercatorBoundsSegments=a.SegmentVector.simpleSegment(0,0,4,2);const A=new a.StructArrayLayout3ui6;A.emplaceBack(0,1,2),A.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=o.createIndexBuffer(A);const M=new a.StructArrayLayout1ui2;for(const k of[0,1,3,2,0])M.emplaceBack(k);this.debugIndexBuffer=o.createIndexBuffer(M),this.emptyTexture=new a.Texture(o,new a.RGBAImage({width:1,height:1},Uint8Array.of(0,0,0,0)),o.gl.RGBA),this.identityMat=a.create();const P=this.context.gl;this.stencilClearMode=new a.StencilMode({func:P.ALWAYS,mask:0},0,255,P.ZERO,P.ZERO,P.ZERO),this.loadTimeStamps.push(a.window.performance.now()),this.atmosphereBuffer=new wd(this.context)}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(o){return o._makeTileBoundsBuffers(this.context,this.transform.projection),o._tileBoundsBuffer?{tileBoundsBuffer:o._tileBoundsBuffer,tileBoundsIndexBuffer:o._tileBoundsIndexBuffer,tileBoundsSegments:o._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const o=this.context,h=o.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(o,h.TRIANGLES,a.DepthMode.disabled,this.stencilClearMode,a.ColorMode.disabled,a.CullFaceMode.disabled,Fo(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(o,h,g){if(!h||this.currentStencilSource===h.id||!o.isTileClipped()||!g||g.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let M=!1;for(const P of g)if(this._tileClippingMaskIDs[P.key]===void 0){M=!0;break}if(!M)return}this.currentStencilSource=h.id;const x=this.context,b=x.gl;this.nextStencilID+g.length>256&&this.clearStencil(),x.setColorMode(a.ColorMode.disabled),x.setDepthMode(a.DepthMode.disabled);const A=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const M of g){const P=h.getTile(M),k=this._tileClippingMaskIDs[M.key]=this.nextStencilID++,{tileBoundsBuffer:D,tileBoundsIndexBuffer:U,tileBoundsSegments:W}=this.getTileBoundsBuffers(P);A.draw(x,b.TRIANGLES,a.DepthMode.disabled,new a.StencilMode({func:b.ALWAYS,mask:0},k,255,b.KEEP,b.KEEP,b.REPLACE),a.ColorMode.disabled,a.CullFaceMode.disabled,Fo(M.projMatrix),"$clipping",D,U,W)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const o=this.nextStencilID++,h=this.context.gl;return new a.StencilMode({func:h.NOTEQUAL,mask:255},o,255,h.KEEP,h.KEEP,h.REPLACE)}stencilModeForClipping(o){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(o);const h=this.context.gl;return new a.StencilMode({func:h.EQUAL,mask:255},this._tileClippingMaskIDs[o.key],0,h.KEEP,h.KEEP,h.REPLACE)}stencilConfigForOverlap(o){const h=this.context.gl,g=o.sort((A,M)=>M.overscaledZ-A.overscaledZ),x=g[g.length-1].overscaledZ,b=g[0].overscaledZ-x+1;if(b>1){this.currentStencilSource=void 0,this.nextStencilID+b>256&&this.clearStencil();const A={};for(let M=0;M<b;M++)A[M+x]=new a.StencilMode({func:h.GEQUAL,mask:255},M+this.nextStencilID,255,h.KEEP,h.KEEP,h.REPLACE);return this.nextStencilID+=b,[A,g]}return[{[x]:a.StencilMode.disabled},g]}colorModeForRenderPass(){const o=this.context.gl;return this._showOverdrawInspector?new a.ColorMode([o.CONSTANT_COLOR,o.ONE],new a.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?a.ColorMode.unblended:a.ColorMode.alphaBlended}depthModeForSublayer(o,h,g){if(!this.opaquePassEnabledForLayer())return a.DepthMode.disabled;const x=1-((1+this.currentLayer)*this.numSublayers+o)*this.depthEpsilon;return new a.DepthMode(g||this.context.gl.LEQUAL,h,[x,x])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(o,h){this.style=o,this.options=h,this.imageManager=o.imageManager,this.glyphManager=o.glyphManager,this.symbolFadeChange=o.placement.symbolFadeChange(a.exported.now()),this.imageManager.beginFrame();const g=this.style.order,x=this.style._sourceCaches;for(const P in x){const k=x[P];k.used&&k.prepare(this.context)}const b={},A={},M={};for(const P in x){const k=x[P];b[P]=k.getVisibleCoordinates(),A[P]=b[P].slice().reverse(),M[P]=k.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let P=0;P<g.length;P++)if(this.style._layers[g[P]].is3D()){this.opaquePassCutoff=P;break}if(this.terrain&&(this.terrain.updateTileBinding(M),this.opaquePassCutoff=0),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new a.GlobeSharedBuffers(this.context)),a.isMapAuthenticated(this.context.gl)){this.renderPass="offscreen";for(const P of g){const k=this.style._layers[P],D=o._getLayerSourceCache(k);if(!k.hasOffscreenPass()||k.isHidden(this.transform.zoom))continue;const U=D?A[D.id]:void 0;(k.type==="custom"||k.isSky()||U&&U.length)&&this.renderLayer(this,D,k,U)}if(this.depthRangeFor3D=[0,1-(o.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]),this.context.clear({color:h.showOverdrawInspector?a.Color.black:a.Color.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=h.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=g.length-1;this.currentLayer>=0;this.currentLayer--){const P=this.style._layers[g[this.currentLayer]],k=o._getLayerSourceCache(P);if(P.isSky())continue;const D=k?A[k.id]:void 0;this._renderTileClippingMasks(P,k,D),this.renderLayer(this,k,P,D)}if(this.style.fog&&this.transform.projection.supportsFog&&function(P,k){const D=P.context,U=D.gl,W=P.transform,J=new a.DepthMode(U.LEQUAL,a.DepthMode.ReadOnly,[0,1]),X=P.useProgram("globeAtmosphere",null,W.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"]),ee=a.globeToMercatorTransition(W.zoom),Y=k.properties.get("color").toArray01(),q=k.properties.get("high-color").toArray01(),ie=k.properties.get("space-color").toArray01PremultipliedAlpha(),K=a.identity$1([]);a.rotateY$1(K,K,-a.degToRad(W._center.lng)),a.rotateX$1(K,K,a.degToRad(W._center.lat)),a.rotateZ$1(K,K,W.angle),a.rotateX$1(K,K,-W._pitch);const he=a.fromQuat(new Float32Array(16),K),fe=a.mapValue(k.properties.get("star-intensity"),0,1,0,.25),le=5e-4,me=a.mapValue(k.properties.get("horizon-blend"),0,1,le,.25),Pe=a.globeUseCustomAntiAliasing(P,D,W)&&me===le?W.worldSize/(2*Math.PI*1.025)-1:W.globeRadius,ze=P.frameCounter/1e3%1,ke=a.length(W.globeCenterInViewSpace),Ke=Math.sqrt(Math.pow(ke,2)-Math.pow(Pe,2)),we=Math.acos(Ke/ke),$e=((Ie,ve,lt,tt,at,nt,vt,Rt,Ct,Et,rt,Ft,Ht,bi)=>({u_frustum_tl:Ie,u_frustum_tr:ve,u_frustum_br:lt,u_frustum_bl:tt,u_horizon:at,u_transition:nt,u_fadeout_range:vt,u_color:Rt,u_high_color:Ct,u_space_color:Et,u_star_intensity:rt,u_star_size:5*a.exported.devicePixelRatio,u_star_density:0,u_temporal_offset:Ft,u_horizon_angle:Ht,u_rotation_matrix:bi}))(W.frustumCorners.TL,W.frustumCorners.TR,W.frustumCorners.BR,W.frustumCorners.BL,W.frustumCorners.horizon,ee,me,Y,q,ie,fe,ze,we,he);P.prepareDrawProgram(D,X);const je=P.atmosphereBuffer;je&&X.draw(D,U.TRIANGLES,J,a.StencilMode.disabled,a.ColorMode.alphaBlended,a.CullFaceMode.backCW,$e,"skybox",je.vertexBuffer,je.indexBuffer,je.segments)}(this,this.style.fog),this.renderPass="sky",(a.globeToMercatorTransition(this.transform.zoom)>0||this.transform.projection.name!=="globe")&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<g.length;this.currentLayer++){const P=this.style._layers[g[this.currentLayer]],k=o._getLayerSourceCache(P);P.isSky()&&this.renderLayer(this,k,P,k?A[k.id]:void 0)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<g.length;){const P=this.style._layers[g[this.currentLayer]],k=o._getLayerSourceCache(P);if(P.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(P)){if(P.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const D=k?(P.type==="symbol"?M:A)[k.id]:void 0;this._renderTileClippingMasks(P,k,k?b[k.id]:void 0),this.renderLayer(this,k,P,D),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let P=null;a.values(this.style._layers).forEach(k=>{const D=o._getLayerSourceCache(k);D&&!k.isHidden(this.transform.zoom)&&(!P||P.getSource().maxzoom<D.getSource().maxzoom)&&(P=D)}),P&&this.options.showTileBoundaries&&jo.debug(this,P,P.getVisibleCoordinates())}this.options.showPadding&&function(P){const k=P.transform.padding;Uo(P,P.transform.height-(k.top||0),3,lu),Uo(P,k.bottom||0,3,yd),uu(P,k.left||0,3,xd),uu(P,P.transform.width-(k.right||0),3,vd);const D=P.transform.centerPoint;(function(U,W,J,X){ws(U,W-1,J-10,2,20,X),ws(U,W-10,J-1,20,2,X)})(P,D.x,P.transform.height-D.y,cu)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(a.window.performance.now()),this.saveCanvasCopy())}}renderLayer(o,h,g,x){g.isHidden(this.transform.zoom)||(g.type==="background"||g.type==="sky"||g.type==="custom"||x&&x.length)&&(this.id=g.id,this.gpuTimingStart(g),o.transform.projection.unsupportedLayers&&o.transform.projection.unsupportedLayers.includes(g.type)||jo[g.type](o,h,g,x,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(o){if(!this.options.gpuTiming)return;const h=this.context.extTimerQuery;let g=this.gpuTimers[o.id];g||(g=this.gpuTimers[o.id]={calls:0,cpuTime:0,query:h.createQueryEXT()}),g.calls++,h.beginQueryEXT(h.TIME_ELAPSED_EXT,g.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const o=this.context.extTimerQuery,h=o.createQueryEXT();this.deferredRenderGpuTimeQueries.push(h),o.beginQueryEXT(o.TIME_ELAPSED_EXT,h)}}gpuTimingDeferredRenderEnd(){if(!this.options.gpuTimingDeferredRender)return;const o=this.context.extTimerQuery;o.endQueryEXT(o.TIME_ELAPSED_EXT)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const o=this.context.extTimerQuery;o.endQueryEXT(o.TIME_ELAPSED_EXT)}collectGpuTimers(){const o=this.gpuTimers;return this.gpuTimers={},o}collectDeferredRenderGpuQueries(){const o=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],o}queryGpuTimers(o){const h={};for(const g in o){const x=o[g],b=this.context.extTimerQuery,A=b.getQueryObjectEXT(x.query,b.QUERY_RESULT_EXT)/1e6;b.deleteQueryEXT(x.query),h[g]=A}return h}queryGpuTimeDeferredRender(o){if(!this.options.gpuTimingDeferredRender)return 0;const h=this.context.extTimerQuery;let g=0;for(const x of o)g+=h.getQueryObjectEXT(x,h.QUERY_RESULT_EXT)/1e6,h.deleteQueryEXT(x);return g}translatePosMatrix(o,h,g,x,b){if(!g[0]&&!g[1])return o;const A=b?x==="map"?this.transform.angle:0:x==="viewport"?-this.transform.angle:0;if(A){const k=Math.sin(A),D=Math.cos(A);g=[g[0]*D-g[1]*k,g[0]*k+g[1]*D]}const M=[b?g[0]:$i(h,g[0],this.transform.zoom),b?g[1]:$i(h,g[1],this.transform.zoom),0],P=new Float32Array(16);return a.translate(P,o,M),P}saveTileTexture(o){const h=this._tileTextures[o.size[0]];h?h.push(o):this._tileTextures[o.size[0]]=[o]}getTileTexture(o){const h=this._tileTextures[o];return h&&h.length>0?h.pop():null}isPatternMissing(o){if(!o)return!1;if(!o.from||!o.to)return!0;const h=this.imageManager.getPattern(o.from.toString()),g=this.imageManager.getPattern(o.to.toString());return!h||!g}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}currentGlobalDefines(){const o=this.terrain&&this.terrain.renderingToTexture,h=this.style&&this.style.fog,g=[];return this.terrainRenderModeElevated()&&g.push("TERRAIN"),this.transform.projection.name==="globe"&&g.push("GLOBE"),h&&!o&&h.getOpacity(this.transform.pitch)!==0&&g.push("FOG"),o&&g.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&g.push("OVERDRAW_INSPECTOR"),g}useProgram(o,h,g){this.cache=this.cache||{};const x=g||[],b=this.currentGlobalDefines().concat(x),A=ld.cacheKey(qc[o],o,b,h);return this.cache[A]||(this.cache[A]=new ld(this.context,o,qc[o],h,gl[o],b)),this.cache[A]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const o=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(o.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=a.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new a.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.atmosphereBuffer&&this.atmosphereBuffer.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}prepareDrawProgram(o,h,g){if(this.terrain&&this.terrain.renderingToTexture)return;const x=this.style.fog;if(x){const b=x.getOpacity(this.transform.pitch),A=((M,P,k,D,U,W,J,X,ee,Y,q)=>{const ie=M.transform,K=P.properties.get("color").toArray01();K[3]=D;const he=M.frameCounter/1e3%1;return{u_fog_matrix:k?ie.calculateFogTileMatrix(k):M.identityMat,u_fog_range:P.getFovAdjustedRange(ie._fov),u_fog_color:K,u_fog_horizon_blend:P.properties.get("horizon-blend"),u_fog_temporal_offset:he,u_frustum_tl:U,u_frustum_tr:W,u_frustum_br:J,u_frustum_bl:X,u_globe_pos:ee,u_globe_radius:Y,u_viewport:q,u_globe_transition:a.globeToMercatorTransition(ie.zoom),u_is_globe:+(ie.projection.name==="globe")}})(this,x,g,b,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*a.exported.devicePixelRatio,this.transform.height*a.exported.devicePixelRatio]);h.setFogUniformValues(o,A)}}setTileLoadedFlag(o){this.tileLoaded=o}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const o=this.context.gl,h=o.createTexture();return o.bindTexture(o.TEXTURE_2D,h),o.copyTexImage2D(o.TEXTURE_2D,0,o.RGBA,0,0,o.drawingBufferWidth,o.drawingBufferHeight,0),h}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const o=this.style&&this.style.fog;return!!o&&o.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const o=this._backgroundTiles,h=this._backgroundTiles={},g=this.transform.coveringTiles({tileSize:512});for(const x of g)h[x.key]=o[x.key]||new a.Tile(x,512,this.transform.tileZoom,this);return h}clearBackgroundTiles(){this._backgroundTiles={}}}class hu{constructor(o=0,h=0,g=0,x=0){if(isNaN(o)||o<0||isNaN(h)||h<0||isNaN(g)||g<0||isNaN(x)||x<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=o,this.bottom=h,this.left=g,this.right=x}interpolate(o,h,g){return h.top!=null&&o.top!=null&&(this.top=a.number(o.top,h.top,g)),h.bottom!=null&&o.bottom!=null&&(this.bottom=a.number(o.bottom,h.bottom,g)),h.left!=null&&o.left!=null&&(this.left=a.number(o.left,h.left,g)),h.right!=null&&o.right!=null&&(this.right=a.number(o.right,h.right,g)),this}getCenter(o,h){const g=a.clamp((this.left+o-this.right)/2,0,o),x=a.clamp((this.top+h-this.bottom)/2,0,h);return new a.pointGeometry(g,x)}equals(o){return this.top===o.top&&this.bottom===o.bottom&&this.left===o.left&&this.right===o.right}clone(){return new hu(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function du(p,o){const h=a.getColumn(p,3);a.fromQuat(p,o),a.setColumn(p,3,h)}function fu(p,o){const h=a.identity$1([]);return a.rotateZ$1(h,h,-o),a.rotateX$1(h,h,-p),h}function _a(p,o){const h=[p[0],p[1],0],g=[o[0],o[1],0];if(a.length(h)>=1e-15){const A=a.normalize([],h);a.scale$2(g,A,a.dot(g,A)),o[0]=g[0],o[1]=g[1]}const x=a.cross([],o,p);if(a.len(x)<1e-15)return null;const b=Math.atan2(-x[1],x[0]);return fu(Math.atan2(Math.sqrt(p[0]*p[0]+p[1]*p[1]),-p[2]),b)}class ya{constructor(o,h){this.position=o,this.orientation=h}get position(){return this._position}set position(o){if(o){const h=o instanceof a.MercatorCoordinate?o:new a.MercatorCoordinate(o[0],o[1],o[2]);this._renderWorldCopies&&(h.x=a.wrap(h.x,0,1)),this._position=h}else this._position=null}lookAtPoint(o,h){if(this.orientation=null,!this.position)return;const g=this._elevation?this._elevation.getAtPointOrZero(a.MercatorCoordinate.fromLngLat(o)):0,x=this.position,b=a.MercatorCoordinate.fromLngLat(o,g),A=[b.x-x.x,b.y-x.y,b.z-x.z];h||(h=[0,0,1]),h[2]=Math.abs(h[2]),this.orientation=_a(A,h)}setPitchBearing(o,h){this.orientation=fu(a.degToRad(o),a.degToRad(-h))}}class mo{constructor(o,h){this._transform=a.identity([]),this.orientation=h,this.position=o}get mercatorPosition(){const o=this.position;return new a.MercatorCoordinate(o[0],o[1],o[2])}get position(){const o=a.getColumn(this._transform,3);return[o[0],o[1],o[2]]}set position(o){var h;o&&a.setColumn(this._transform,3,[(h=o)[0],h[1],h[2],1])}get orientation(){return this._orientation}set orientation(o){this._orientation=o||a.identity$1([]),o&&du(this._transform,this._orientation)}getPitchBearing(){const o=this.forward(),h=this.right();return{bearing:Math.atan2(-h[1],h[0]),pitch:Math.atan2(Math.sqrt(o[0]*o[0]+o[1]*o[1]),-o[2])}}setPitchBearing(o,h){this._orientation=fu(o,h),du(this._transform,this._orientation)}forward(){const o=a.getColumn(this._transform,2);return[-o[0],-o[1],-o[2]]}up(){const o=a.getColumn(this._transform,1);return[-o[0],-o[1],-o[2]]}right(){const o=a.getColumn(this._transform,0);return[o[0],o[1],o[2]]}getCameraToWorld(o,h){const g=new Float64Array(16);return a.invert(g,this.getWorldToCamera(o,h)),g}getWorldToCameraPosition(o,h,g){const x=this.position;a.scale$2(x,x,-o);const b=new Float64Array(16);return a.fromScaling(b,[g,g,g]),a.translate(b,b,x),b[10]*=h,b}getWorldToCamera(o,h){const g=new Float64Array(16),x=new Float64Array(4),b=this.position;return a.conjugate(x,this._orientation),a.scale$2(b,b,-o),a.fromQuat(g,x),a.translate(g,g,b),g[1]*=-1,g[5]*=-1,g[9]*=-1,g[13]*=-1,g[8]*=h,g[9]*=h,g[10]*=h,g[11]*=h,g}getCameraToClipPerspective(o,h,g,x){const b=new Float64Array(16);return a.perspective(b,o,h,g,x),b}getDistanceToElevation(o){const h=o===0?0:a.mercatorZfromAltitude(o,this.position[1]),g=this.forward();return(h-this.position[2])/g[2]}clone(){return new mo([...this.position],[...this.orientation])}}function yl(p,o){const h=xa(p.projection,p.zoom,p.width,p.height),g=function(b,A,M,P,k){const D=new a.LngLat(M.lng-180*Es,M.lat),U=new a.LngLat(M.lng+180*Es,M.lat),W=b.project(D.lng,D.lat),J=b.project(U.lng,U.lat),X=-Math.atan2(J.y-W.y,J.x-W.x),ee=a.MercatorCoordinate.fromLngLat(M);ee.y=a.clamp(ee.y,-.999975,.999975);const Y=ee.toLngLat(),q=b.project(Y.lng,Y.lat),ie=a.MercatorCoordinate.fromLngLat(Y);ie.x+=Es;const K=ie.toLngLat(),he=b.project(K.lng,K.lat),fe=ht(he.x-q.x,he.y-q.y,X),le=a.MercatorCoordinate.fromLngLat(Y);le.y+=Es;const me=le.toLngLat(),Pe=b.project(me.lng,me.lat),ze=ht(Pe.x-q.x,Pe.y-q.y,X),ke=Math.abs(fe.x)/Math.abs(ze.y),Ke=a.identity([]);a.rotateZ(Ke,Ke,-X*(1-(k?0:P)));const we=a.identity([]);return a.scale(we,we,[1,1-(1-ke)*P,1]),we[4]=-ze.x/ze.y*P,a.rotateZ(we,we,X),a.multiply(we,Ke,we),we}(p.projection,0,p.center,h,o),x=xl(p);return a.scale(g,g,[x,x,1]),g}function xl(p){const o=p.projection,h=xa(p.projection,p.zoom,p.width,p.height),g=va(o,p.center),x=va(o,a.LngLat.convert(o.center));return Math.pow(2,g*h+(1-h)*x)}function xa(p,o,h,g,x=1/0){const b=p.range;if(!b)return 0;const A=Math.min(x,Math.max(h,g)),M=Math.log(A/1024)/Math.LN2;return a.smoothstep(b[0]+M,b[1]+M,o)}const Es=1/4e4;function va(p,o){const h=a.clamp(o.lat,-a.MAX_MERCATOR_LATITUDE,a.MAX_MERCATOR_LATITUDE),g=new a.LngLat(o.lng-180*Es,h),x=new a.LngLat(o.lng+180*Es,h),b=p.project(g.lng,h),A=p.project(x.lng,h),M=a.MercatorCoordinate.fromLngLat(g),P=a.MercatorCoordinate.fromLngLat(x),k=A.x-b.x,D=A.y-b.y,U=P.x-M.x,W=P.y-M.y,J=Math.sqrt((U*U+W*W)/(k*k+D*D));return Math.log(J)/Math.LN2}function ht(p,o,h){const g=Math.cos(h),x=Math.sin(h);return{x:p*g-o*x,y:p*x+o*g}}class _r{constructor(o,h,g,x,b,A,M){this.tileSize=512,this._renderWorldCopies=b===void 0||b,this._minZoom=o||0,this._maxZoom=h||22,this._minPitch=g??0,this._maxPitch=x??60,this.setProjection(A),this.setMaxBounds(M),this.width=0,this.height=0,this._center=new a.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new hu,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new mo,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1}clone(){const o=new _r(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return o._elevation=this._elevation,o._centerAltitude=this._centerAltitude,o._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,o.tileSize=this.tileSize,o.mercatorFromTransition=this.mercatorFromTransition,o.width=this.width,o.height=this.height,o.cameraElevationReference=this.cameraElevationReference,o._center=this._center,o._setZoom(this.zoom),o._seaLevelZoom=this._seaLevelZoom,o.angle=this.angle,o._fov=this._fov,o._pitch=this._pitch,o._nearZ=this._nearZ,o._farZ=this._farZ,o._averageElevation=this._averageElevation,o._unmodified=this._unmodified,o._edgeInsets=this._edgeInsets.clone(),o._camera=this._camera.clone(),o._calcMatrices(),o.freezeTileCoverage=this.freezeTileCoverage,o.frustumCorners=this.frustumCorners,o}get elevation(){return this._elevation}set elevation(o){this._elevation!==o&&(this._elevation=o,this._updateCameraOnTerrain(),this._calcMatrices())}updateElevation(o){const h=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||h)&&this._updateCameraOnTerrain(),(o||h)&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return a.pick(this.projection,["name","center","parallels"])}setProjection(o){this.projectionOptions=o||{name:"mercator"};const h=this.projection?this.getProjection():void 0;this.projection=a.getProjection(this.projectionOptions);const g=!E(h,this.getProjection());return g&&this._calcMatrices(),this.mercatorFromTransition=!1,g}setMercatorFromTransition(){const o=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=a.getProjection({name:"mercator"});const h=o!==this.projection.name;return h&&this._calcMatrices(),h}get minZoom(){return this._minZoom}set minZoom(o){this._minZoom!==o&&(this._minZoom=o,this.zoom=Math.max(this.zoom,o))}get maxZoom(){return this._maxZoom}set maxZoom(o){this._maxZoom!==o&&(this._maxZoom=o,this.zoom=Math.min(this.zoom,o))}get minPitch(){return this._minPitch}set minPitch(o){this._minPitch!==o&&(this._minPitch=o,this.pitch=Math.max(this.pitch,o))}get maxPitch(){return this._maxPitch}set maxPitch(o){this._maxPitch!==o&&(this._maxPitch=o,this.pitch=Math.min(this.pitch,o))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(o){o===void 0?o=!0:o===null&&(o=!1),this._renderWorldCopies=o}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const o=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(o))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return a.mercatorZfromAltitude(this.center.lat,this.cameraWorldSize)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new a.pointGeometry(this.width,this.height)}get bearing(){return a.wrap(this.rotation,-180,180)}set bearing(o){this.rotation=o}get rotation(){return-this.angle/Math.PI*180}set rotation(o){const h=-o*Math.PI/180;var g;this.angle!==h&&(this._unmodified=!1,this.angle=h,this._calcMatrices(),this.rotationMatrix=(g=new a.ARRAY_TYPE(4),a.ARRAY_TYPE!=Float32Array&&(g[1]=0,g[2]=0),g[0]=1,g[3]=1,g),function(x,b,A){var M=b[0],P=b[1],k=b[2],D=b[3],U=Math.sin(A),W=Math.cos(A);x[0]=M*W+k*U,x[1]=P*W+D*U,x[2]=M*-U+k*W,x[3]=P*-U+D*W}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(o){const h=a.clamp(o,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==h&&(this._unmodified=!1,this._pitch=h,this._calcMatrices())}get aspect(){return this.width/this.height}get fovX(){return this._fov}get fovY(){const o=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/o)}set fov(o){o=Math.max(.01,Math.min(60,o)),this._fov!==o&&(this._unmodified=!1,this._fov=a.degToRad(o),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(o){this._averageElevation=o,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(o){const h=Math.min(Math.max(o,this.minZoom),this.maxZoom);this._zoom!==h&&(this._unmodified=!1,this._setZoom(h),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(o){this._zoom=o,this.scale=this.zoomScale(o),this.tileZoom=Math.floor(o),this.zoomFraction=o-this.tileZoom}_updateCameraOnTerrain(){if(!this._elevation||!this._elevation.isDataAvailableAtPoint(this.locationCoordinate(this.center)))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const o=this._elevation;this._centerAltitude=o.getAtPointOrZero(this.locationCoordinate(this.center)),this._centerAltitudeValidForExaggeration=o.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const o=this._elevation,h=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],g=this.horizonLineFromTop();let x=0,b=0;for(let A=0;A<h.length;A++){const M=new a.pointGeometry(h[A][0]*this.width,g+h[A][1]*(this.height-g)),P=o.pointCoordinate(M);if(!P)continue;const k=1/Math.hypot(P[0]-this._camera.position[0],P[1]-this._camera.position[1]);x+=P[3]*k,b+=k}return b===0?NaN:x/b}get center(){return this._center}set center(o){o.lat===this._center.lat&&o.lng===this._center.lng||(this._unmodified=!1,this._center=o,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const o=this._seaLevelZoom,h=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),g=this.pixelsPerMeter/this.worldSize*h,x=this._mercatorZfromZoom(o),b=this._mercatorZfromZoom(this._maxZoom),A=Math.max(x-g,b);this._setZoom(this._zoomFromMercatorZ(A))}get padding(){return this._edgeInsets.toJSON()}set padding(o){this._edgeInsets.equals(o)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,o,1),this._calcMatrices())}computeZoomRelativeTo(o){const h=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,o.toAltitude()));let g;g=o.z<this._camera.position[2]?[h.x,h.y,h.z]:[o.x,o.y,o.z];const x=a.length(a.sub([],this._camera.position,g));return a.clamp(this._zoomFromMercatorZ(x),this._minZoom,this._maxZoom)}setFreeCameraOptions(o){if(!this.height||!o.position&&!o.orientation)return;this._updateCameraState();let h=!1;if(o.orientation&&!a.exactEquals(o.orientation,this._camera.orientation)&&(h=this._setCameraOrientation(o.orientation)),o.position){const g=[o.position.x,o.position.y,o.position.z];a.exactEquals$1(g,this._camera.position)||(this._setCameraPosition(g),h=!0)}h&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const o=this._camera.position,h=new ya;return h.position=new a.MercatorCoordinate(o[0],o[1],o[2]),h.orientation=this._camera.orientation,h._elevation=this.elevation,h._renderWorldCopies=this.renderWorldCopies,h}_setCameraOrientation(o){if(!a.length$1(o))return!1;a.normalize$1(o,o);const h=a.transformQuat([],[0,0,-1],o),g=a.transformQuat([],[0,-1,0],o);if(g[2]<0)return!1;const x=_a(h,g);return!!x&&(this._camera.orientation=x,!0)}_setCameraPosition(o){const h=this.zoomScale(this.minZoom)*this.tileSize,g=this.zoomScale(this.maxZoom)*this.tileSize,x=this.cameraToCenterDistance;o[2]=a.clamp(o[2],x/g,x/h),this._camera.position=o}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(o){return this._edgeInsets.equals(o)}interpolatePadding(o,h,g){this._unmodified=!1,this._edgeInsets.interpolate(o,h,g),this._constrain(),this._calcMatrices()}coveringZoomLevel(o){const h=(o.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/o.tileSize));return Math.max(0,h)}getVisibleUnwrappedCoordinates(o){const h=[new a.UnwrappedTileID(0,o)];if(this.renderWorldCopies){const g=this.pointCoordinate(new a.pointGeometry(0,0)),x=this.pointCoordinate(new a.pointGeometry(this.width,0)),b=this.pointCoordinate(new a.pointGeometry(this.width,this.height)),A=this.pointCoordinate(new a.pointGeometry(0,this.height)),M=Math.floor(Math.min(g.x,x.x,b.x,A.x)),P=Math.floor(Math.max(g.x,x.x,b.x,A.x)),k=1;for(let D=M-k;D<=P+k;D++)D!==0&&h.push(new a.UnwrappedTileID(D,o))}return h}coveringTiles(o){let h=this.coveringZoomLevel(o);const g=h,x=this.elevation&&!o.isTerrainDEM,b=this.projection.name==="mercator";if(o.minzoom!==void 0&&h<o.minzoom)return[];o.maxzoom!==void 0&&h>o.maxzoom&&(h=o.maxzoom);const A=this.locationCoordinate(this.center),M=this.center.lat,P=1<<h,k=[P*A.x,P*A.y,0],D=this.projection.name==="globe",U=!D,W=a.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,h,U),J=D?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),X=P*a.mercatorZfromAltitude(1,this.center.lat),ee=this._camera.position[2]/a.mercatorZfromAltitude(1,this.center.lat),Y=[P*J.x,P*J.y,ee*(U?1:X)],q=this.cameraToCenterDistance/o.tileSize*(o.roundZoom?1:.502),ie=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?h:0,K=o.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,he=o.isTerrainDEM?-K:this._elevation?this._elevation.getMinElevationBelowMSL():0,fe=this.projection.isReprojectedInTileSpace?xl(this):1,le=ve=>{const tt=new a.MercatorCoordinate(ve.x+25e-6,ve.y,ve.z),at=new a.MercatorCoordinate(ve.x,ve.y+25e-6,ve.z),nt=ve.toLngLat(),vt=tt.toLngLat(),Rt=at.toLngLat(),Ct=this.locationCoordinate(nt),Et=this.locationCoordinate(vt),rt=this.locationCoordinate(Rt),Ft=Math.hypot(Et.x-Ct.x,Et.y-Ct.y),Ht=Math.hypot(rt.x-Ct.x,rt.y-Ct.y);return Math.sqrt(Ft*Ht)*fe/25e-6},me=ve=>{const lt=K,tt=he;return{aabb:a.tileAABB(this,P,0,0,0,ve,tt,lt,this.projection),zoom:0,x:0,y:0,minZ:tt,maxZ:lt,wrap:ve,fullyVisible:!1}},Pe=[];let ze=[];const ke=h,Ke=o.reparseOverscaled?g:h,we=ve=>ve*ve,$e=we((ee-this._centerAltitude)*X),je=ve=>{if(!this._elevation||!ve.tileID||!b)return;const lt=this._elevation.getMinMaxForTile(ve.tileID),tt=ve.aabb;lt?(tt.min[2]=lt.min,tt.max[2]=lt.max,tt.center[2]=(tt.min[2]+tt.max[2])/2):(ve.shouldSplit=Ie(ve),ve.shouldSplit||(tt.min[2]=tt.max[2]=tt.center[2]=this._centerAltitude))},Ie=ve=>{if(ve.zoom<ie)return!0;if(ve.zoom===ke)return!1;if(ve.shouldSplit!=null)return ve.shouldSplit;const lt=ve.aabb.distanceX(Y),tt=ve.aabb.distanceY(Y);let at=$e,nt=1;if(D){at=we(ve.aabb.distanceZ(Y));const Ct=Math.pow(2,ve.zoom),Et=a.latFromMercatorY((ve.y+1)/Ct),rt=a.latFromMercatorY(ve.y/Ct),Ft=Math.min(Math.max(M,Et),rt),Ht=a.circumferenceAtLatitude(Ft)/a.circumferenceAtLatitude(M);if(nt=Ft===M?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Ht/this._mercatorScaleRatio),this.zoom<=a.GLOBE_ZOOM_THRESHOLD_MIN&&ve.zoom===ke-1&&Ht>=.9)return!0}else if(x&&(at=we(ve.aabb.distanceZ(Y)*X)),this.projection.isReprojectedInTileSpace&&g<=5){const Ct=Math.pow(2,ve.zoom),Et=le(new a.MercatorCoordinate((ve.x+.5)/Ct,(ve.y+.5)/Ct));nt=Et>.85?1:Et}const vt=lt*lt+tt*tt+at,Rt=we((1<<ke-ve.zoom)*q*nt*((Ct,Et)=>{if(Et*we(.707)<Ct)return 1;const rt=Math.sqrt(Et/Ct);return rt/(1.4144271570014144+(Math.pow(1.1,rt-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(at,$e),vt));return vt<Rt};if(this.renderWorldCopies)for(let ve=1;ve<=3;ve++)Pe.push(me(-ve)),Pe.push(me(ve));for(Pe.push(me(0));Pe.length>0;){const ve=Pe.pop(),lt=ve.x,tt=ve.y;let at=ve.fullyVisible;if(!at){const nt=ve.aabb.intersects(W);if(nt===0)continue;at=nt===2}if(ve.zoom!==ke&&Ie(ve))for(let nt=0;nt<4;nt++){const vt=(lt<<1)+nt%2,Rt=(tt<<1)+(nt>>1),Ct={aabb:b?ve.aabb.quadrant(nt):a.tileAABB(this,P,ve.zoom+1,vt,Rt,ve.wrap,ve.minZ,ve.maxZ,this.projection),zoom:ve.zoom+1,x:vt,y:Rt,wrap:ve.wrap,fullyVisible:at,tileID:void 0,shouldSplit:void 0,minZ:ve.minZ,maxZ:ve.maxZ};x&&!D&&(Ct.tileID=new a.OverscaledTileID(ve.zoom+1===ke?Ke:ve.zoom+1,ve.wrap,ve.zoom+1,vt,Rt),je(Ct)),Pe.push(Ct)}else{const nt=ve.zoom===ke?Ke:ve.zoom;if(o.minzoom&&o.minzoom>nt)continue;const vt=k[0]-(.5+lt+(ve.wrap<<ve.zoom))*(1<<h-ve.zoom),Rt=k[1]-.5-tt,Ct=ve.tileID?ve.tileID:new a.OverscaledTileID(nt,ve.wrap,ve.zoom,lt,tt);ze.push({tileID:Ct,distanceSq:vt*vt+Rt*Rt})}}if(this.fogCullDistSq){const ve=this.fogCullDistSq,lt=this.horizonLineFromTop();ze=ze.filter(tt=>{const at=[0,0,0,1],nt=[a.EXTENT,a.EXTENT,0,1],vt=this.calculateFogTileMatrix(tt.tileID.toUnwrapped());a.transformMat4$1(at,at,vt),a.transformMat4$1(nt,nt,vt);const Rt=a.getAABBPointSquareDist(at,nt);if(Rt===0)return!0;let Ct=!1;const Et=this._elevation;if(Et&&Rt>ve&&lt!==0){const rt=this.calculateProjMatrix(tt.tileID.toUnwrapped());let Ft;o.isTerrainDEM||(Ft=Et.getMinMaxForTile(tt.tileID)),Ft||(Ft={min:he,max:K});const Ht=a.furthestTileCorner(this.rotation),bi=[Ht[0]*a.EXTENT,Ht[1]*a.EXTENT,Ft.max];a.transformMat4(bi,bi,rt),Ct=(1-bi[1])*this.height*.5<lt}return Rt<ve||Ct})}return ze.sort((ve,lt)=>ve.distanceSq-lt.distanceSq).map(ve=>ve.tileID)}resize(o,h){this.width=o,this.height=h,this.pixelsToGLUnits=[2/o,-2/h],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(o){return Math.pow(2,o)}scaleZoom(o){return Math.log(o)/Math.LN2}project(o){const h=a.clamp(o.lat,-a.MAX_MERCATOR_LATITUDE,a.MAX_MERCATOR_LATITUDE),g=this.projection.project(o.lng,h);return new a.pointGeometry(g.x*this.worldSize,g.y*this.worldSize)}unproject(o){return this.projection.unproject(o.x/this.worldSize,o.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(o,h){let g,x;const b=this.centerPoint;if(this.projection.name==="globe"){const M=this.worldSize;g=(h.x-b.x)/M,x=(h.y-b.y)/M}else{const M=this.pointCoordinate(h),P=this.pointCoordinate(b);g=M.x-P.x,x=M.y-P.y}const A=this.locationCoordinate(o);this.setLocation(new a.MercatorCoordinate(A.x-g,A.y-x))}setLocation(o){this.center=this.coordinateLocation(o),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(o){return this.projection.locationPoint(this,o)}locationPoint3D(o){return this.projection.locationPoint(this,o,!0)}pointLocation(o){return this.coordinateLocation(this.pointCoordinate(o))}pointLocation3D(o){return this.coordinateLocation(this.pointCoordinate3D(o))}locationCoordinate(o,h){const g=h?a.mercatorZfromAltitude(h,o.lat):void 0,x=this.projection.project(o.lng,o.lat);return new a.MercatorCoordinate(x.x,x.y,g)}coordinateLocation(o){return this.projection.unproject(o.x,o.y)}pointRayIntersection(o,h){const g=h??this._centerAltitude,x=[o.x,o.y,0,1],b=[o.x,o.y,1,1];a.transformMat4$1(x,x,this.pixelMatrixInverse),a.transformMat4$1(b,b,this.pixelMatrixInverse);const A=b[3];a.scale$1(x,x,1/x[3]),a.scale$1(b,b,1/A);const M=x[2],P=b[2];return{p0:x,p1:b,t:M===P?0:(g-M)/(P-M)}}screenPointToMercatorRay(o){const h=[o.x,o.y,0,1],g=[o.x,o.y,1,1];return a.transformMat4$1(h,h,this.pixelMatrixInverse),a.transformMat4$1(g,g,this.pixelMatrixInverse),a.scale$1(h,h,1/h[3]),a.scale$1(g,g,1/g[3]),h[2]=a.mercatorZfromAltitude(h[2],this._center.lat)*this.worldSize,g[2]=a.mercatorZfromAltitude(g[2],this._center.lat)*this.worldSize,a.scale$1(h,h,1/this.worldSize),a.scale$1(g,g,1/this.worldSize),new a.Ray([h[0],h[1],h[2]],a.normalize([],a.sub([],g,h)))}rayIntersectionCoordinate(o){const{p0:h,p1:g,t:x}=o,b=a.mercatorZfromAltitude(h[2],this._center.lat),A=a.mercatorZfromAltitude(g[2],this._center.lat);return new a.MercatorCoordinate(a.number(h[0],g[0],x)/this.worldSize,a.number(h[1],g[1],x)/this.worldSize,a.number(b,A,x))}pointCoordinate(o,h=this._centerAltitude){return this.projection.pointCoordinate(this,o.x,o.y,h)}pointCoordinate3D(o){if(!this.elevation)return this.pointCoordinate(o);let h=this.projection.pointCoordinate3D(this,o.x,o.y);if(h)return new a.MercatorCoordinate(h[0],h[1],h[2]);let g=0,x=this.horizonLineFromTop();if(o.y>x)return this.pointCoordinate(o);const b=.02*x,A=o.clone();for(let M=0;M<10&&x-g>b;M++){A.y=a.number(g,x,.66);const P=this.projection.pointCoordinate3D(this,A.x,A.y);P?(x=A.y,h=P):g=A.y}return h?new a.MercatorCoordinate(h[0],h[1],h[2]):this.pointCoordinate(o)}isPointAboveHorizon(o){return this.projection.isPointAboveHorizon(this,o)}_coordinatePoint(o,h){const g=h&&this.elevation?this.elevation.getAtPointOrZero(o,this._centerAltitude):this._centerAltitude,x=[o.x*this.worldSize,o.y*this.worldSize,g+o.toAltitude(),1];return a.transformMat4$1(x,x,this.pixelMatrix),x[3]>0?new a.pointGeometry(x[0]/x[3],x[1]/x[3]):new a.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getGlobeBounds(){const{top:o,left:h}=this._edgeInsets,g=this.height-this._edgeInsets.bottom,x=this.width-this._edgeInsets.right,b=this.pointCoordinate3D(new a.pointGeometry(h,o)),A=this.pointCoordinate3D(new a.pointGeometry(x,o)),M=this.pointCoordinate3D(new a.pointGeometry(x,g)),P=this.pointCoordinate3D(new a.pointGeometry(h,g));let k=Math.min(b.x,P.x),D=Math.max(A.x,M.x),U=Math.min(b.y,A.y),W=Math.max(P.y,M.y);const J=Math.pow(2,-this.zoom)/16,X=(q,ie,K,he)=>{const fe=(q+K)/2,le=(ie+he)/2,me=new a.pointGeometry(fe,le),Pe=this.pointCoordinate3D(me),ze=Math.max(0,k-Pe.x,U-Pe.y,Pe.x-D,Pe.y-W);k=Math.min(k,Pe.x),D=Math.max(D,Pe.x),U=Math.min(U,Pe.y),W=Math.max(W,Pe.y),ze>J&&(X(q,ie,fe,le),X(fe,le,K,he))};X(h,o,x,o),X(x,o,x,g),X(x,g,h,g),X(h,g,h,o);const ee=new a.LngLat(a.lngFromMercatorX(D),a.latFromMercatorY(U)),Y=new a.LngLat(a.lngFromMercatorX(k),a.latFromMercatorY(W));return new a.LngLatBounds(Y,ee)}_getBounds(o,h){if(this.projection.name==="globe")return this._getGlobeBounds();const g=new a.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),x=new a.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),b=new a.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),A=new a.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let M=this.pointCoordinate(g,o),P=this.pointCoordinate(x,o);const k=this.pointCoordinate(b,h),D=this.pointCoordinate(A,h),U=(W,J)=>(J.y-W.y)/(J.x-W.x);return M.y>1&&P.y>=0?M=new a.MercatorCoordinate((1-D.y)/U(D,M)+D.x,1):M.y<0&&P.y<=1&&(M=new a.MercatorCoordinate(-D.y/U(D,M)+D.x,0)),P.y>1&&M.y>=0?P=new a.MercatorCoordinate((1-k.y)/U(k,P)+k.x,1):P.y<0&&M.y<=1&&(P=new a.MercatorCoordinate(-k.y/U(k,P)+k.x,0)),new a.LngLatBounds().extend(this.coordinateLocation(M)).extend(this.coordinateLocation(P)).extend(this.coordinateLocation(D)).extend(this.coordinateLocation(k))}_getBounds3D(){const o=this.elevation;if(!o.visibleDemTiles.length||o.isUsingMockSource())return this._getBounds(0,0);const h=o.visibleDemTiles.reduce((g,x)=>{if(x.dem){const b=x.dem.tree;g.min=Math.min(g.min,b.minimums[0]),g.max=Math.max(g.max,b.maximums[0])}return g},{min:Number.MAX_VALUE,max:0});return this._getBounds(h.min*o.exaggeration(),h.max*o.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(o=!0){const h=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,g=this.height/2-h*(1-this._horizonShift);return o?Math.max(0,g):g}getMaxBounds(){return this.maxBounds}setMaxBounds(o){this.maxBounds=o,this.minLat=-a.MAX_MERCATOR_LATITUDE,this.maxLat=a.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,o&&(this.minLat=o.getSouth(),this.maxLat=o.getNorth(),this.minLng=o.getWest(),this.maxLng=o.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=a.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=a.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=a.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=a.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(o,h){return this.projection.createTileMatrix(this,h,o)}calculateDistanceTileData(o){const h=o.key,g=this._distanceTileDataCache;if(g[h])return g[h];const x=o.canonical,b=1/this.height,A=this.cameraWorldSize/this.zoomScale(x.z),M=(x.x+Math.pow(2,x.z)*o.wrap)*A,P=x.y*A,k=this.point,D=this.angle,U=Math.sin(-D),W=-Math.cos(-D);return g[h]={bearing:[U,W],center:[(k.x-M)*b,(k.y-P)*b],scale:A/a.EXTENT*b},g[h]}calculateFogTileMatrix(o){const h=o.key,g=this._fogTileMatrixCache;if(g[h])return g[h];const x=this.projection.createTileMatrix(this,this.cameraWorldSize,o);return a.multiply(x,this.worldToFogMatrix,x),g[h]=new Float32Array(x),g[h]}calculateProjMatrix(o,h=!1){const g=o.key,x=h?this._alignedProjMatrixCache:this._projMatrixCache;if(x[g])return x[g];const b=this.calculatePosMatrix(o,this.worldSize);return a.multiply(b,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:h?this.alignedProjMatrix:this.projMatrix,b),x[g]=new Float32Array(b),x[g]}calculatePixelsToTileUnitsMatrix(o){const h=o.tileID.key,g=this._pixelsToTileUnitsCache;if(g[h])return g[h];const x=function(b,A){const{scale:M}=b.tileTransform,P=M*a.EXTENT/(b.tileSize*Math.pow(2,A.zoom-b.tileID.overscaledZ+b.tileID.canonical.z));return k=new Float32Array(4),W=(D=A.inverseAdjustmentMatrix)[1],J=D[2],X=D[3],Y=(U=[P,P])[1],k[0]=D[0]*(ee=U[0]),k[1]=W*ee,k[2]=J*Y,k[3]=X*Y,k;var k,D,U,W,J,X,ee,Y}(o,this);return g[h]=x,g[h]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const o=this._elevation;this._updateCameraState();const h=a.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(h),x=this._camera.forward(),b=a.mercatorZfromAltitude(1,this._center.lat);g[2]/=b,x[2]/=b,a.normalize(x,x);const A=o.raycast(g,x,o.exaggeration());if(A){const M=a.scaleAndAdd([],g,x,A),P=new a.MercatorCoordinate(M[0],M[1],a.mercatorZfromAltitude(M[2],a.latFromMercatorY(M[1]))),k=(P.z+a.length([P.x-g[0],P.y-g[1],P.z-g[2]*b]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(k),this._centerAltitude=P.toAltitude(),this._center=this.coordinateLocation(P),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const o=this._elevation;this._updateCameraState();const h=a.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(h),x=o.getAtPointOrZero(new a.MercatorCoordinate(...g)),b=this._minimumHeightOverTerrain()*Math.cos(a.degToRad(this._maxPitch)),A=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*x;if(A<b){const M=this.locationCoordinate(this._center,this._centerAltitude),P=[M.x-g[0],M.y-g[1],M.z-g[2]],k=a.length(P);P[2]-=(b-A)/this._pixelsPerMercatorPixel;const D=a.length(P);if(D===0)return;a.scale$2(P,P,k/D*this._pixelsPerMercatorPixel),this._camera.position=[M.x-P[0],M.y-P[1],M.z*this._pixelsPerMercatorPixel-P[2]],this._camera.orientation=_a(P,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const o=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||o){const W=this.center;return W.lat=a.clamp(W.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!o)&&(W.lng=a.clamp(W.lng,this.minLng,this.maxLng)),this.center=W,void(this._constraining=!1)}const h=this._unmodified,{x:g,y:x}=this.point;let b=0,A=g,M=x;const P=this.width/2,k=this.height/2,D=this.worldMinY*this.scale,U=this.worldMaxY*this.scale;if(x-k<D&&(M=D+k),x+k>U&&(M=U-k),U-D<this.height&&(b=Math.max(b,this.height/(U-D)),M=(U+D)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const W=this.worldMinX*this.scale,J=this.worldMaxX*this.scale,X=this.worldSize/2-(W+J)/2;A=(g+X+this.worldSize)%this.worldSize-X,A-P<W&&(A=W+P),A+P>J&&(A=J-P),J-W<this.width&&(b=Math.max(b,this.width/(J-W)),A=(J+W)/2)}A===g&&M===x||(this.center=this.unproject(new a.pointGeometry(A,M))),b&&(this.zoom+=this.scaleZoom(b)),this._constrainCameraAltitude(),this._unmodified=h,this._constraining=!1}_minZoomForBounds(){let o=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(o=Math.max(o,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),o}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const o=this.centerOffset,h=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=a.mercatorZfromAltitude(1,this.center.lat)/a.mercatorZfromAltitude(1,a.GLOBE_SCALE_MATCH_LATITUDE));const g=xa(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,g),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const x=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?h:1),b=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);b[8]=2*-o.x/this.width,b[9]=2*o.y/this.height;let A=a.mul([],b,x);if(this.projection.isReprojectedInTileSpace){const fe=this.locationCoordinate(this.center),le=a.identity([]);a.translate(le,le,[fe.x*this.worldSize,fe.y*this.worldSize,0]),a.multiply(le,le,yl(this)),a.translate(le,le,[-fe.x*this.worldSize,-fe.y*this.worldSize,0]),a.multiply(A,A,le),this.inverseAdjustmentMatrix=function(me){const Pe=yl(me,!0);return et([],[Pe[0],Pe[1],Pe[4],Pe[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=a.scale([],A,[this.worldSize,this.worldSize,this.worldSize/h,1]),this.projMatrix=A,this.invProjMatrix=a.invert(new Float64Array(16),this.projMatrix);const M=a.invert([],b);this.frustumCorners=a.FrustumCorners.fromInvProjectionMatrix(M,this.horizonLineFromTop(),this.height);const P=new Float32Array(16);a.identity(P),a.scale(P,P,[1,-1,1]),a.rotateX(P,P,this._pitch),a.rotateZ(P,P,this.angle);const k=a.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),D=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;k[8]=2*-o.x/this.width,k[9]=2*(o.y+D)/this.height,this.skyboxMatrix=a.multiply(P,k,P);const U=this.point,W=U.x,J=U.y,X=this.width%2/2,ee=this.height%2/2,Y=Math.cos(this.angle),q=Math.sin(this.angle),ie=W-Math.round(W)+Y*X+q*ee,K=J-Math.round(J)+Y*ee+q*X,he=new Float64Array(A);if(a.translate(he,he,[ie>.5?ie-1:ie,K>.5?K-1:K,0]),this.alignedProjMatrix=he,A=a.create(),a.scale(A,A,[this.width/2,-this.height/2,1]),a.translate(A,A,[1,-1,0]),this.labelPlaneMatrix=A,A=a.create(),a.scale(A,A,[1,-1,1]),a.translate(A,A,[-1,-1,0]),a.scale(A,A,[2/this.width,2/this.height,1]),this.glCoordMatrix=A,this.pixelMatrix=a.multiply(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},A=a.invert(new Float64Array(16),this.pixelMatrix),!A)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=A,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=a.calculateGlobeMatrix(this);const fe=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=a.transformMat4(fe,fe,x),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=A;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const o=this.cameraWorldSize,h=this.cameraPixelsPerMeter,g=this._camera.position,x=1/this.height/this._pixelsPerMercatorPixel,b=[o,o,h];a.scale$2(b,b,x),a.scale$2(g,g,-1),a.multiply$2(g,g,b);const A=a.create();a.translate(A,A,g),a.scale(A,A,b),this.mercatorFogMatrix=A,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(o,h,x)}_computeCameraPosition(o){const h=(o=o||this.pixelsPerMeter)/this.pixelsPerMeter,g=this._camera.forward(),x=this.point,b=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*h-o/this.worldSize*this._centerAltitude;return[x.x/this.worldSize-g[0]*b,x.y/this.worldSize-g[1]*b,o/this.worldSize*this._centerAltitude-g[2]*b]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(o){const h=this._maxCameraBoundsDistance()*Math.cos(this._pitch),g=this._camera.position[2],x=o[2];let b=1;this.projection.wrap&&(this.center=this.center.wrap()),x>0&&(b=Math.min((h-g)/x,1)),this._camera.position=a.scaleAndAdd([],this._camera.position,o,b),this._updateStateFromCamera()}_updateStateFromCamera(){const o=this._camera.position,h=this._camera.forward(),{pitch:g,bearing:x}=this._camera.getPitchBearing(),b=a.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,A=this._mercatorZfromZoom(this._maxZoom)*Math.cos(a.degToRad(this._maxPitch)),M=Math.max((o[2]-b)/Math.cos(g),A),P=this._zoomFromMercatorZ(M);a.scaleAndAdd(o,o,h,M),this._pitch=a.clamp(g,a.degToRad(this.minPitch),a.degToRad(this.maxPitch)),this.angle=a.wrap(x,-Math.PI,Math.PI),this._setZoom(a.clamp(P,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new a.MercatorCoordinate(o[0],o[1],o[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(o){return Math.pow(2,o)*this.tileSize}_mercatorZfromZoom(o){return this.cameraToCenterDistance/this._worldSizeFromZoom(o)}_minimumHeightOverTerrain(){const o=Math.min((this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(o)}_zoomFromMercatorZ(o){return this.scaleZoom(this.cameraToCenterDistance/(o*this.tileSize))}zoomFromMercatorZAdjusted(o){const h=A=>{const M=this.getCameraToCenterDistance(this.projection,A);return this.scaleZoom(M/(o*this.tileSize))};let g,x=h(this.zoom),b=Math.abs(x-h(x));for(;g!==b;)x=h(x),g=b,b=Math.abs(x-h(x));return x}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(a.warnOnce("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(o,h){const g=Math.min(o.x,h.x),x=Math.max(o.x,h.x),b=Math.min(o.y,h.y),A=Math.max(o.y,h.y);if(b<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const M=[new a.pointGeometry(g,b),new a.pointGeometry(x,A),new a.pointGeometry(g,A),new a.pointGeometry(x,b)],P=this.renderWorldCopies?-3:0,k=this.renderWorldCopies?4:1;for(const D of M){const U=this.pointRayIntersection(D);if(U.t<0)return!0;const W=this.rayIntersectionCoordinate(U);if(W.x<P||W.y<0||W.x>k||W.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+a.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new a.pointGeometry(0,0),new a.pointGeometry(this.width,this.height))}zoomDeltaToMovement(o,h){const g=a.length(a.sub([],this._camera.position,o)),x=this._zoomFromMercatorZ(g)+h;return g-this._mercatorZfromZoom(x)}getCameraPoint(){if(this.projection.name==="globe"){const o=function(h,g){const x=[h[0],h[1],h[2],1];a.transformMat4$1(x,x,g);const b=Math.max(x[3],1e-6);return[x[0]/b,x[1]/b,x[2]/b,b]}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new a.pointGeometry(o[0],o[1])}{const o=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new a.pointGeometry(0,o))}}getCameraToCenterDistance(o,h=this.zoom){const g=xa(o,h,this.width,this.height,1024),x=o.pixelSpaceConversion(this.center.lat,this.worldSize,g);return .5/Math.tan(.5*this._fov)*this.height*x}getWorldToCameraMatrix(){const o=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&a.multiply(o,o,this.globeMatrix),o}}function pu(p,o){let h=!1,g=null;const x=()=>{g=null,h&&(p(),g=setTimeout(x,o),h=!1)};return()=>(h=!0,g||x(),g)}class Td{constructor(o){this._hashName=o&&encodeURIComponent(o),a.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=pu(this._updateHashUnthrottled.bind(this),300)}addTo(o){return this._map=o,a.window.addEventListener("hashchange",this._onHashChange,!1),o.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),a.window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const o=this._map;if(!o)return"";const h=mu(o);if(this._hashName){const g=this._hashName;let x=!1;const b=a.window.location.hash.slice(1).split("&").map(A=>{const M=A.split("=")[0];return M===g?(x=!0,`${M}=${h}`):A}).filter(A=>A);return x||b.push(`${g}=${h}`),`#${b.join("&")}`}return`#${h}`}_getCurrentHash(){const o=a.window.location.hash.replace("#","");if(this._hashName){let h;return o.split("&").map(g=>g.split("=")).forEach(g=>{g[0]===this._hashName&&(h=g)}),(h&&h[1]||"").split("/")}return o.split("/")}_onHashChange(){const o=this._map;if(!o)return!1;const h=this._getCurrentHash();if(h.length>=3&&!h.some(g=>isNaN(g))){const g=o.dragRotate.isEnabled()&&o.touchZoomRotate.isEnabled()?+(h[3]||0):o.getBearing();return o.jumpTo({center:[+h[2],+h[1]],zoom:+h[0],bearing:g,pitch:+(h[4]||0)}),!0}return!1}_updateHashUnthrottled(){const o=a.window.location.href.replace(/(#.+)?$/,this.getHashString());a.window.history.replaceState(a.window.history.state,null,o)}}function mu(p,o){const h=p.getCenter(),g=Math.round(100*p.getZoom())/100,x=Math.ceil((g*Math.LN2+Math.log(512/360/.5))/Math.LN10),b=Math.pow(10,x),A=Math.round(h.lng*b)/b,M=Math.round(h.lat*b)/b,P=p.getBearing(),k=p.getPitch();let D=o?`/${A}/${M}/${g}`:`${g}/${M}/${A}`;return(P||k)&&(D+="/"+Math.round(10*P)/10),k&&(D+=`/${Math.round(k)}`),D}const As={linearity:.3,easing:a.bezier(0,0,.3,1)},Ed=a.extend({deceleration:2500,maxSpeed:1400},As),vl=a.extend({deceleration:20,maxSpeed:1400},As),gu=a.extend({deceleration:1e3,maxSpeed:360},As),bl=a.extend({deceleration:1e3,maxSpeed:90},As);class Ad{constructor(o){this._map=o,this.clear()}clear(){this._inertiaBuffer=[]}record(o){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:a.exported.now(),settings:o})}_drainInertiaBuffer(){const o=this._inertiaBuffer,h=a.exported.now();for(;o.length>0&&h-o[0].time>160;)o.shift()}_onMoveEnd(o){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const h={zoom:0,bearing:0,pitch:0,pan:new a.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:b}of this._inertiaBuffer)h.zoom+=b.zoomDelta||0,h.bearing+=b.bearingDelta||0,h.pitch+=b.pitchDelta||0,b.panDelta&&h.pan._add(b.panDelta),b.around&&(h.around=b.around),b.pinchAround&&(h.pinchAround=b.pinchAround);const g=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,x={};if(h.pan.mag()){const b=Ss(h.pan.mag(),g,a.extend({},Ed,o||{}));x.offset=h.pan.mult(b.amount/h.pan.mag()),x.center=this._map.transform.center,ba(x,b)}if(h.zoom){const b=Ss(h.zoom,g,vl);x.zoom=this._map.transform.zoom+b.amount,ba(x,b)}if(h.bearing){const b=Ss(h.bearing,g,gu);x.bearing=this._map.transform.bearing+a.clamp(b.amount,-179,179),ba(x,b)}if(h.pitch){const b=Ss(h.pitch,g,bl);x.pitch=this._map.transform.pitch+b.amount,ba(x,b)}if(x.zoom||x.bearing){const b=h.pinchAround===void 0?h.around:h.pinchAround;x.around=b?this._map.unproject(b):this._map.getCenter()}return this.clear(),x.noMoveStart=!0,x}}function ba(p,o){(!p.duration||p.duration<o.duration)&&(p.duration=o.duration,p.easing=o.easing)}function Ss(p,o,h){const{maxSpeed:g,linearity:x,deceleration:b}=h,A=a.clamp(p*x/(o/1e3),-g,g),M=Math.abs(A)/(b*x);return{easing:h.easing,duration:1e3*M,amount:A*(M/2)}}class yr extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(o,h,g,x={}){const b=Ee(h.getCanvasContainer(),g),A=h.unproject(b);super(o,a.extend({point:b,lngLat:A,originalEvent:g},x)),this._defaultPrevented=!1,this.target=h}}class wl extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(o,h,g){const x=o==="touchend"?g.changedTouches:g.touches,b=dt(h.getCanvasContainer(),x),A=b.map(P=>h.unproject(P)),M=b.reduce((P,k,D,U)=>P.add(k.div(U.length)),new a.pointGeometry(0,0));super(o,{points:b,point:M,lngLats:A,lngLat:h.unproject(M),originalEvent:g}),this._defaultPrevented=!1}}class Sd extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(o,h,g){super(o,{originalEvent:g}),this._defaultPrevented=!1}}class Tl{constructor(o,h){this._map=o,this._clickTolerance=h.clickTolerance}reset(){this._mousedownPos=void 0}wheel(o){return this._firePreventable(new Sd(o.type,this._map,o))}mousedown(o,h){return this._mousedownPos=h,this._firePreventable(new yr(o.type,this._map,o))}mouseup(o){this._map.fire(new yr(o.type,this._map,o))}preclick(o){const h=a.extend({},o);h.type="preclick",this._map.fire(new yr(h.type,this._map,h))}click(o,h){this._mousedownPos&&this._mousedownPos.dist(h)>=this._clickTolerance||(this.preclick(o),this._map.fire(new yr(o.type,this._map,o)))}dblclick(o){return this._firePreventable(new yr(o.type,this._map,o))}mouseover(o){this._map.fire(new yr(o.type,this._map,o))}mouseout(o){this._map.fire(new yr(o.type,this._map,o))}touchstart(o){return this._firePreventable(new wl(o.type,this._map,o))}touchmove(o){this._map.fire(new wl(o.type,this._map,o))}touchend(o){this._map.fire(new wl(o.type,this._map,o))}touchcancel(o){this._map.fire(new wl(o.type,this._map,o))}_firePreventable(o){if(this._map.fire(o),o.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class _u{constructor(o){this._map=o}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(o){this._map.fire(new yr(o.type,this._map,o))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new yr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(o){this._delayContextMenu?this._contextMenuEvent=o:this._map.fire(new yr(o.type,this._map,o)),this._map.listens("contextmenu")&&o.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Md{constructor(o,h){this._map=o,this._el=o.getCanvasContainer(),this._container=o.getContainer(),this._clickTolerance=h.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(o,h){this.isEnabled()&&o.shiftKey&&o.button===0&&(De(),this._startPos=this._lastPos=h,this._active=!0)}mousemoveWindow(o,h){if(!this._active)return;const g=h,x=this._startPos,b=this._lastPos;if(!x||!b||b.equals(g)||!this._box&&g.dist(x)<this._clickTolerance)return;this._lastPos=g,this._box||(this._box=N("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",o));const A=Math.min(x.x,g.x),M=Math.max(x.x,g.x),P=Math.min(x.y,g.y),k=Math.max(x.y,g.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${A}px,${P}px)`,this._box.style.width=M-A+"px",this._box.style.height=k-P+"px")})}mouseupWindow(o,h){if(!this._active)return;const g=this._startPos,x=h;if(g&&o.button===0){if(this.reset(),Ve(),g.x!==x.x||g.y!==x.y)return this._map.fire(new a.Event("boxzoomend",{originalEvent:o})),{cameraAnimation:b=>b.fitScreenCoordinates(g,x,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",o)}}keydown(o){this._active&&o.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",o))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Oe(),delete this._startPos,delete this._lastPos}_fireEvent(o,h){return this._map.fire(new a.Event(o,{originalEvent:h}))}}function El(p,o){const h={};for(let g=0;g<p.length;g++)h[p[g].identifier]=o[g];return h}class Al{constructor(o){this.reset(),this.numTouches=o.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(o,h,g){(this.centroid||g.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=o.timeStamp),g.length===this.numTouches&&(this.centroid=function(x){const b=new a.pointGeometry(0,0);for(const A of x)b._add(A);return b.div(x.length)}(h),this.touches=El(g,h)))}touchmove(o,h,g){if(this.aborted||!this.centroid)return;const x=El(g,h);for(const b in this.touches){const A=this.touches[b],M=x[b];(!M||M.dist(A)>30)&&(this.aborted=!0)}}touchend(o,h,g){if((!this.centroid||o.timeStamp-this.startTime>500)&&(this.aborted=!0),g.length===0){const x=!this.aborted&&this.centroid;if(this.reset(),x)return x}}}class wa{constructor(o){this.singleTap=new Al(o),this.numTaps=o.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(o,h,g){this.singleTap.touchstart(o,h,g)}touchmove(o,h,g){this.singleTap.touchmove(o,h,g)}touchend(o,h,g){const x=this.singleTap.touchend(o,h,g);if(x){const b=o.timeStamp-this.lastTime<500,A=!this.lastTap||this.lastTap.dist(x)<30;if(b&&A||this.reset(),this.count++,this.lastTime=o.timeStamp,this.lastTap=x,this.count===this.numTaps)return this.reset(),x}}}class Pd{constructor(){this._zoomIn=new wa({numTouches:1,numTaps:2}),this._zoomOut=new wa({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(o,h,g){this._zoomIn.touchstart(o,h,g),this._zoomOut.touchstart(o,h,g)}touchmove(o,h,g){this._zoomIn.touchmove(o,h,g),this._zoomOut.touchmove(o,h,g)}touchend(o,h,g){const x=this._zoomIn.touchend(o,h,g),b=this._zoomOut.touchend(o,h,g);return x?(this._active=!0,o.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:A.getZoom()+1,around:A.unproject(x)},{originalEvent:o})}):b?(this._active=!0,o.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:A.getZoom()-1,around:A.unproject(b)},{originalEvent:o})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Id={0:1,2:2};class Sl{constructor(o){this.reset(),this._clickTolerance=o.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(o,h){return!1}_move(o,h){return{}}mousedown(o,h){if(this._lastPoint)return;const g=wt(o);this._correctButton(o,g)&&(this._lastPoint=h,this._eventButton=g)}mousemoveWindow(o,h){const g=this._lastPoint;if(g){if(o.preventDefault(),this._eventButton!=null&&function(x,b){const A=Id[b];return x.buttons===void 0||(x.buttons&A)!==A}(o,this._eventButton))this.reset();else if(this._moved||!(h.dist(g)<this._clickTolerance))return this._moved=!0,this._lastPoint=h,this._move(g,h)}}mouseupWindow(o){this._lastPoint&&wt(o)===this._eventButton&&(this._moved&&Ve(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Cd extends Sl{mousedown(o,h){super.mousedown(o,h),this._lastPoint&&(this._active=!0)}_correctButton(o,h){return h===0&&!o.ctrlKey}_move(o,h){return{around:h,panDelta:h.sub(o)}}}class yu extends Sl{_correctButton(o,h){return h===0&&o.ctrlKey||h===2}_move(o,h){const g=.8*(h.x-o.x);if(g)return this._active=!0,{bearingDelta:g}}contextmenu(o){o.preventDefault()}}class go extends Sl{_correctButton(o,h){return h===0&&o.ctrlKey||h===2}_move(o,h){const g=-.5*(h.y-o.y);if(g)return this._active=!0,{pitchDelta:g}}contextmenu(o){o.preventDefault()}}class Ld{constructor(o,h){this._map=o,this._el=o.getCanvasContainer(),this._minTouches=1,this._clickTolerance=h.clickTolerance||1,this.reset(),a.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new a.pointGeometry(0,0)}touchstart(o,h,g){return this._calculateTransform(o,h,g)}touchmove(o,h,g){if(this._active&&!(g.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(g.length===1&&!a.isFullscreen())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return o.cancelable&&o.preventDefault(),this._calculateTransform(o,h,g)}}touchend(o,h,g){this._calculateTransform(o,h,g),this._active&&g.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(o,h,g){g.length>0&&(this._active=!0);const x=El(g,h),b=new a.pointGeometry(0,0),A=new a.pointGeometry(0,0);let M=0;for(const k in x){const D=x[k],U=this._touches[k];U&&(b._add(D),A._add(D.sub(U)),M++,x[k]=D)}if(this._touches=x,M<this._minTouches||!A.mag())return;const P=A.div(M);return this._sum._add(P),this._sum.mag()<this._clickTolerance?void 0:{around:b.div(M),panDelta:P}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=N("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")},500)}}class Ml{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(o){}_move(o,h,g){return{}}touchstart(o,h,g){this._firstTwoTouches||g.length<2||(this._firstTwoTouches=[g[0].identifier,g[1].identifier],this._start([h[0],h[1]]))}touchmove(o,h,g){const x=this._firstTwoTouches;if(!x)return;o.preventDefault();const[b,A]=x,M=Ta(g,h,b),P=Ta(g,h,A);if(!M||!P)return;const k=this._aroundCenter?null:M.add(P).div(2);return this._move([M,P],k,o)}touchend(o,h,g){if(!this._firstTwoTouches)return;const[x,b]=this._firstTwoTouches,A=Ta(g,h,x),M=Ta(g,h,b);A&&M||(this._active&&Ve(),this.reset())}touchcancel(){this.reset()}enable(o){this._enabled=!0,this._aroundCenter=!!o&&o.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ta(p,o,h){for(let g=0;g<p.length;g++)if(p[g].identifier===h)return o[g]}function xu(p,o){return Math.log(p/o)/Math.LN2}class kd extends Ml{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(o){this._startDistance=this._distance=o[0].dist(o[1])}_move(o,h){const g=this._distance;if(this._distance=o[0].dist(o[1]),this._active||!(Math.abs(xu(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:xu(this._distance,g),pinchAround:h}}}function vu(p,o){return 180*p.angleWith(o)/Math.PI}class Nn extends Ml{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(o){this._startVector=this._vector=o[0].sub(o[1]),this._minDiameter=o[0].dist(o[1])}_move(o,h){const g=this._vector;if(this._vector=o[0].sub(o[1]),g&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:vu(this._vector,g),pinchAround:h}}_isBelowThreshold(o){this._minDiameter=Math.min(this._minDiameter,o.mag());const h=25/(Math.PI*this._minDiameter)*360,g=this._startVector;if(!g)return!1;const x=vu(o,g);return Math.abs(x)<h}}function bu(p){return Math.abs(p.y)>Math.abs(p.x)}class Rd extends Ml{constructor(o){super(),this._map=o}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(o){this._lastPoints=o,bu(o[0].sub(o[1]))&&(this._valid=!1)}_move(o,h,g){const x=this._lastPoints;if(!x)return;const b=o[0].sub(x[0]),A=o[1].sub(x[1]);return this._map._cooperativeGestures&&!a.isFullscreen()&&g.touches.length<3||(this._valid=this.gestureBeginsVertically(b,A,g.timeStamp),!this._valid)?void 0:(this._lastPoints=o,this._active=!0,{pitchDelta:(b.y+A.y)/2*-.5})}gestureBeginsVertically(o,h,g){if(this._valid!==void 0)return this._valid;const x=o.mag()>=2,b=h.mag()>=2;if(!x&&!b)return;if(!x||!b)return this._firstMove==null&&(this._firstMove=g),g-this._firstMove<100&&void 0;const A=o.y>0==h.y>0;return bu(o)&&bu(h)&&A}}const rm={panStep:100,bearingStep:15,pitchStep:10};class sm{constructor(){const o=rm;this._panStep=o.panStep,this._bearingStep=o.bearingStep,this._pitchStep=o.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(o){if(o.altKey||o.ctrlKey||o.metaKey)return;let h=0,g=0,x=0,b=0,A=0;switch(o.keyCode){case 61:case 107:case 171:case 187:h=1;break;case 189:case 109:case 173:h=-1;break;case 37:o.shiftKey?g=-1:(o.preventDefault(),b=-1);break;case 39:o.shiftKey?g=1:(o.preventDefault(),b=1);break;case 38:o.shiftKey?x=1:(o.preventDefault(),A=-1);break;case 40:o.shiftKey?x=-1:(o.preventDefault(),A=1);break;default:return}return this._rotationDisabled&&(g=0,x=0),{cameraAnimation:M=>{const P=M.getZoom();M.easeTo({duration:300,easeId:"keyboardHandler",easing:Ms,zoom:h?Math.round(P)+h*(o.shiftKey?2:1):P,bearing:M.getBearing()+g*this._bearingStep,pitch:M.getPitch()+x*this._pitchStep,offset:[-b*this._panStep,-A*this._panStep],center:M.getCenter()},{originalEvent:o})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Ms(p){return p*(2-p)}const wu=4.000244140625;class Go{constructor(o,h){this._map=o,this._el=o.getCanvasContainer(),this._handler=h,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,a.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(o){this._defaultZoomRate=o}setWheelZoomRate(o){this._wheelZoomRate=o}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(o){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!o&&o.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(o){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(o.ctrlKey||o.metaKey||this.isZooming()||a.isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let h=o.deltaMode===a.window.WheelEvent.DOM_DELTA_LINE?40*o.deltaY:o.deltaY;const g=a.exported.now(),x=g-(this._lastWheelEventTime||0);this._lastWheelEventTime=g,h!==0&&h%wu==0?this._type="wheel":h!==0&&Math.abs(h)<4?this._type="trackpad":x>400?(this._type=null,this._lastValue=h,this._timeout=setTimeout(this._onTimeout,40,o)):this._type||(this._type=Math.abs(x*h)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,h+=this._lastValue)),o.shiftKey&&h&&(h/=4),this._type&&(this._lastWheelEvent=o,this._delta-=h,this._active||this._start(o)),o.preventDefault()}_onTimeout(o){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(o)}_start(o){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const h=Ee(this._el,o);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:h,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const o=this._map.transform;this._type==="wheel"&&o.projection.wrap&&(o._center.lng>=180||o._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const h=()=>o._terrainEnabled()&&this._aroundCoord?o.computeZoomRelativeTo(this._aroundCoord):o.zoom;if(this._delta!==0){const P=this._type==="wheel"&&Math.abs(this._delta)>wu?this._wheelZoomRate:this._defaultZoomRate;let k=2/(1+Math.exp(-Math.abs(this._delta*P)));this._delta<0&&k!==0&&(k=1/k);const D=h(),U=Math.pow(2,D),W=typeof this._targetZoom=="number"?o.zoomScale(this._targetZoom):U;this._targetZoom=Math.min(o.maxZoom,Math.max(o.minZoom,o.scaleZoom(W*k))),this._type==="wheel"&&(this._startZoom=D,this._easing=this._smoothOutEasing(200)),this._delta=0}const g=typeof this._targetZoom=="number"?this._targetZoom:h(),x=this._startZoom,b=this._easing;let A,M=!1;if(this._type==="wheel"&&x&&b){const P=Math.min((a.exported.now()-this._lastWheelEventTime)/200,1),k=b(P);A=a.number(x,g,k),P<1?this._frameId||(this._frameId=!0):M=!0}else A=g,M=!0;return this._active=!0,M&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!M,zoomDelta:A-h(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(o){let h=a.ease;if(this._prevEase){const g=this._prevEase,x=(a.exported.now()-g.start)/g.duration,b=g.easing(x+.01)-g.easing(x),A=.27/Math.sqrt(b*b+1e-4)*.01,M=Math.sqrt(.0729-A*A);h=a.bezier(A,M,.25,1)}return this._prevEase={start:a.exported.now(),duration:o,easing:h},h}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=N("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(a.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")},200)}}class cs{constructor(o,h){this._clickZoom=o,this._tapZoom=h}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Pl{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(o,h){return o.preventDefault(),{cameraAnimation:g=>{g.easeTo({duration:300,zoom:g.getZoom()+(o.shiftKey?-1:1),around:g.unproject(h)},{originalEvent:o})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ft{constructor(){this._tap=new wa({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(o,h,g){this._swipePoint||(this._tapTime&&o.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?g.length>0&&(this._swipePoint=h[0],this._swipeTouch=g[0].identifier):this._tap.touchstart(o,h,g))}touchmove(o,h,g){if(this._tapTime){if(this._swipePoint){if(g[0].identifier!==this._swipeTouch)return;const x=h[0],b=x.y-this._swipePoint.y;return this._swipePoint=x,o.preventDefault(),this._active=!0,{zoomDelta:b/128}}}else this._tap.touchmove(o,h,g)}touchend(o,h,g){this._tapTime?this._swipePoint&&g.length===0&&this.reset():this._tap.touchend(o,h,g)&&(this._tapTime=o.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Dd{constructor(o,h,g){this._el=o,this._mousePan=h,this._touchPan=g}enable(o){this._inertiaOptions=o||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class zd{constructor(o,h,g){this._pitchWithRotate=o.pitchWithRotate,this._mouseRotate=h,this._mousePitch=g}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Ea{constructor(o,h,g,x){this._el=o,this._touchZoom=h,this._touchRotate=g,this._tapDragZoom=x,this._rotationDisabled=!1,this._enabled=!0}enable(o){this._touchZoom.enable(o),this._rotationDisabled||this._touchRotate.enable(o),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Gs=p=>p.zoom||p.drag||p.pitch||p.rotate;class Od extends a.Event{}class Bd{constructor(){this.constants=[1,1,.01],this.radius=0}setup(o,h){const g=a.sub([],h,o);this.radius=a.length(g[2]<0?a.div([],g,this.constants):[g[0],g[1],0])}projectRay(o){a.div(o,o,this.constants),a.normalize(o,o),a.mul$1(o,o,this.constants);const h=a.scale$2([],o,this.radius);if(h[2]>0){const g=a.scale$2([],[0,0,1],a.dot(h,[0,0,1])),x=a.scale$2([],a.normalize([],[h[0],h[1],0]),this.radius),b=a.add([],h,a.scale$2([],a.sub([],a.add([],x,g),h),2));h[0]=b[0],h[1]=b[1]}return h}}function Aa(p){return p.panDelta&&p.panDelta.mag()||p.zoomDelta||p.bearingDelta||p.pitchDelta}class Fd{constructor(o,h){this._map=o,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Ad(o),this._bearingSnap=h.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Bd,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(h),a.bindAll(["handleEvent","handleWindowEvent"],this);const g=this._el;this._listeners=[[g,"touchstart",{passive:!0}],[g,"touchmove",{passive:!1}],[g,"touchend",void 0],[g,"touchcancel",void 0],[g,"mousedown",void 0],[g,"mousemove",void 0],[g,"mouseup",void 0],[a.window.document,"mousemove",{capture:!0}],[a.window.document,"mouseup",void 0],[g,"mouseover",void 0],[g,"mouseout",void 0],[g,"dblclick",void 0],[g,"click",void 0],[g,"keydown",{capture:!1}],[g,"keyup",void 0],[g,"wheel",{passive:!1}],[g,"contextmenu",void 0],[a.window,"blur",void 0]];for(const[x,b,A]of this._listeners)x.addEventListener(b,x===a.window.document?this.handleWindowEvent:this.handleEvent,A)}destroy(){for(const[o,h,g]of this._listeners)o.removeEventListener(h,o===a.window.document?this.handleWindowEvent:this.handleEvent,g)}_addDefaultHandlers(o){const h=this._map,g=h.getCanvasContainer();this._add("mapEvent",new Tl(h,o));const x=h.boxZoom=new Md(h,o);this._add("boxZoom",x);const b=new Pd,A=new Pl;h.doubleClickZoom=new cs(A,b),this._add("tapZoom",b),this._add("clickZoom",A);const M=new ft;this._add("tapDragZoom",M);const P=h.touchPitch=new Rd(h);this._add("touchPitch",P);const k=new yu(o),D=new go(o);h.dragRotate=new zd(o,k,D),this._add("mouseRotate",k,["mousePitch"]),this._add("mousePitch",D,["mouseRotate"]);const U=new Cd(o),W=new Ld(h,o);h.dragPan=new Dd(g,U,W),this._add("mousePan",U),this._add("touchPan",W,["touchZoom","touchRotate"]);const J=new Nn,X=new kd;h.touchZoomRotate=new Ea(g,X,J,M),this._add("touchRotate",J,["touchPan","touchZoom"]),this._add("touchZoom",X,["touchPan","touchRotate"]),this._add("blockableMapEvent",new _u(h));const ee=h.scrollZoom=new Go(h,this);this._add("scrollZoom",ee,["mousePan"]);const Y=h.keyboard=new sm;this._add("keyboard",Y);for(const q of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])o.interactive&&o[q]&&h[q].enable(o[q])}_add(o,h,g){this._handlers.push({handlerName:o,handler:h,allowed:g}),this._handlersById[o]=h}stop(o){if(!this._updatingCamera){for(const{handler:h}of this._handlers)h.reset();this._inertia.clear(),this._fireEvents({},{},o),this._changes=[]}}isActive(){for(const{handler:o}of this._handlers)if(o.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Gs(this._eventsInProgress)||this.isZooming()}_blockedByActive(o,h,g){for(const x in o)if(x!==g&&(!h||h.indexOf(x)<0))return!0;return!1}handleWindowEvent(o){this.handleEvent(o,`${o.type}Window`)}_getMapTouches(o){const h=[];for(const g of o)this._el.contains(g.target)&&h.push(g);return h}handleEvent(o,h){this._updatingCamera=!0;const g=o.type==="renderFrame",x=g?void 0:o,b={needsRenderFrame:!1},A={},M={},P=o.touches?this._getMapTouches(o.touches):void 0,k=P?dt(this._el,P):g?void 0:Ee(this._el,o);for(const{handlerName:W,handler:J,allowed:X}of this._handlers){if(!J.isEnabled())continue;let ee;this._blockedByActive(M,X,W)?J.reset():J[h||o.type]&&(ee=J[h||o.type](o,k,P),this.mergeHandlerResult(b,A,ee,W,x),ee&&ee.needsRenderFrame&&this._triggerRenderFrame()),(ee||J.isActive())&&(M[W]=J)}const D={};for(const W in this._previousActiveHandlers)M[W]||(D[W]=x);this._previousActiveHandlers=M,(Object.keys(D).length||Aa(b))&&(this._changes.push([b,A,D]),this._triggerRenderFrame()),(Object.keys(M).length||Aa(b))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:U}=b;U&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],U(this._map))}mergeHandlerResult(o,h,g,x,b){if(!g)return;a.extend(o,g);const A={handlerName:x,originalEvent:g.originalEvent||b};g.zoomDelta!==void 0&&(h.zoom=A),g.panDelta!==void 0&&(h.drag=A),g.pitchDelta!==void 0&&(h.pitch=A),g.bearingDelta!==void 0&&(h.rotate=A)}_applyChanges(){const o={},h={},g={};for(const[x,b,A]of this._changes)x.panDelta&&(o.panDelta=(o.panDelta||new a.pointGeometry(0,0))._add(x.panDelta)),x.zoomDelta&&(o.zoomDelta=(o.zoomDelta||0)+x.zoomDelta),x.bearingDelta&&(o.bearingDelta=(o.bearingDelta||0)+x.bearingDelta),x.pitchDelta&&(o.pitchDelta=(o.pitchDelta||0)+x.pitchDelta),x.around!==void 0&&(o.around=x.around),x.aroundCoord!==void 0&&(o.aroundCoord=x.aroundCoord),x.pinchAround!==void 0&&(o.pinchAround=x.pinchAround),x.noInertia&&(o.noInertia=x.noInertia),a.extend(h,b),a.extend(g,A);this._updateMapTransform(o,h,g),this._changes=[]}_updateMapTransform(o,h,g){const x=this._map,b=x.transform,A=ie=>[ie.x,ie.y,ie.z];if((ie=>{const K=this._eventsInProgress.drag;return K&&!this._handlersById[K.handlerName].isActive()})()&&!Aa(o)){const ie=b.zoom;b.cameraElevationReference="sea",b.recenterOnTerrain(),b.cameraElevationReference="ground",ie!==b.zoom&&this._map._update(!0)}if(!Aa(o))return void this._fireEvents(h,g,!0);let{panDelta:M,zoomDelta:P,bearingDelta:k,pitchDelta:D,around:U,aroundCoord:W,pinchAround:J}=o;J!==void 0&&(U=J),(ie=>h.drag&&!this._eventsInProgress.drag)()&&U&&(this._dragOrigin=A(b.pointCoordinate3D(U)),this._trackingEllipsoid.setup(b._camera.position,this._dragOrigin)),b.cameraElevationReference="sea",x._stop(!0),U=U||x.transform.centerPoint,k&&(b.bearing+=k),D&&(b.pitch+=D),b._updateCameraState();const X=[0,0,0];if(M)if(b.projection.name==="mercator"){const ie=this._trackingEllipsoid.projectRay(b.screenPointToMercatorRay(U).dir),K=this._trackingEllipsoid.projectRay(b.screenPointToMercatorRay(U.sub(M)).dir);X[0]=K[0]-ie[0],X[1]=K[1]-ie[1]}else{const ie=b.pointCoordinate(U);if(b.projection.name==="globe"){M=M.rotate(-b.angle);const K=b._pixelsPerMercatorPixel/b.worldSize;X[0]=-M.x*a.mercatorScale(a.latFromMercatorY(ie.y))*K,X[1]=-M.y*a.mercatorScale(b.center.lat)*K}else{const K=b.pointCoordinate(U.sub(M));ie&&K&&(X[0]=K.x-ie.x,X[1]=K.y-ie.y)}}const ee=b.zoom,Y=[0,0,0];if(P){const ie=A(W||b.pointCoordinate3D(U)),K={dir:a.normalize([],a.sub([],ie,b._camera.position))};if(K.dir[2]<0){const he=b.zoomDeltaToMovement(ie,P);a.scale$2(Y,K.dir,he)}}const q=a.add(X,X,Y);b._translateCameraConstrained(q),P&&Math.abs(b.zoom-ee)>1e-4&&b.recenterOnTerrain(),b.cameraElevationReference="ground",this._map._update(),o.noInertia||this._inertia.record(o),this._fireEvents(h,g,!0)}_fireEvents(o,h,g){const x=Gs(this._eventsInProgress),b=Gs(o),A={};for(const D in o){const{originalEvent:U}=o[D];this._eventsInProgress[D]||(A[`${D}start`]=U),this._eventsInProgress[D]=o[D]}!x&&b&&this._fireEvent("movestart",b.originalEvent);for(const D in A)this._fireEvent(D,A[D]);b&&this._fireEvent("move",b.originalEvent);for(const D in o){const{originalEvent:U}=o[D];this._fireEvent(D,U)}const M={};let P;for(const D in this._eventsInProgress){const{handlerName:U,originalEvent:W}=this._eventsInProgress[D];this._handlersById[U].isActive()||(delete this._eventsInProgress[D],P=h[U]||W,M[`${D}end`]=P)}for(const D in M)this._fireEvent(D,M[D]);const k=Gs(this._eventsInProgress);if(g&&(x||b)&&!k){this._updatingCamera=!0;const D=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),U=W=>W!==0&&-this._bearingSnap<W&&W<this._bearingSnap;D?(U(D.bearing||this._map.getBearing())&&(D.bearing=0),this._map.easeTo(D,{originalEvent:P})):(this._map.fire(new a.Event("moveend",{originalEvent:P})),U(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(o,h){this._map.fire(new a.Event(o,h?{originalEvent:h}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(o=>{this._frameId=void 0,this.handleEvent(new Od("renderFrame",{timeStamp:o})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Tu="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Nd extends a.Evented{constructor(o,h){super(),this._moving=!1,this._zooming=!1,this.transform=o,this._bearingSnap=h.bearingSnap,a.bindAll(["_renderFrameCallback"],this)}getCenter(){return new a.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(o,h){return this.jumpTo({center:o},h)}panBy(o,h,g){return o=a.pointGeometry.convert(o).mult(-1),this.panTo(this.transform.center,a.extend({offset:o},h),g)}panTo(o,h,g){return this.easeTo(a.extend({center:o},h),g)}getZoom(){return this.transform.zoom}setZoom(o,h){return this.jumpTo({zoom:o},h),this}zoomTo(o,h,g){return this.easeTo(a.extend({zoom:o},h),g)}zoomIn(o,h){return this.zoomTo(this.getZoom()+1,o,h),this}zoomOut(o,h){return this.zoomTo(this.getZoom()-1,o,h),this}getBearing(){return this.transform.bearing}setBearing(o,h){return this.jumpTo({bearing:o},h),this}getPadding(){return this.transform.padding}setPadding(o,h){return this.jumpTo({padding:o},h),this}rotateTo(o,h,g){return this.easeTo(a.extend({bearing:o},h),g)}resetNorth(o,h){return this.rotateTo(0,a.extend({duration:1e3},o),h),this}resetNorthPitch(o,h){return this.easeTo(a.extend({bearing:0,pitch:0,duration:1e3},o),h),this}snapToNorth(o,h){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(o,h):this}getPitch(){return this.transform.pitch}setPitch(o,h){return this.jumpTo({pitch:o},h),this}cameraForBounds(o,h){o=a.LngLatBounds.convert(o);const g=h&&h.bearing||0,x=o.getNorthWest(),b=o.getSouthEast();return this._cameraForBounds(this.transform,x,b,g,h)}_extendCameraOptions(o){const h={top:0,bottom:0,right:0,left:0};if(typeof(o=a.extend({padding:h,offset:[0,0],maxZoom:this.transform.maxZoom},o)).padding=="number"){const g=o.padding;o.padding={top:g,bottom:g,right:g,left:g}}return o.padding=a.extend(h,o.padding),o}_minimumAABBFrustumDistance(o,h){const g=h.max[0]-h.min[0],x=h.max[1]-h.min[1];return g/x>o.aspect?g/(2*Math.tan(.5*o.fovX)*o.aspect):x/(2*Math.tan(.5*o.fovY)*o.aspect)}_cameraForBoundsOnGlobe(o,h,g,x,b){const A=o.clone(),M=this._extendCameraOptions(b);A.bearing=x;const P=a.LngLat.convert(h),k=a.LngLat.convert(g),D=.5*(P.lat+k.lat),U=.5*(P.lng+k.lng),W=a.latLngToECEF(D,U),J=a.normalize([],W),X=a.normalize([],a.cross([],J,[0,1,0])),ee=a.cross([],X,J),Y=[X[0],X[1],X[2],0,ee[0],ee[1],ee[2],0,J[0],J[1],J[2],0,0,0,0,1],q=[W,a.latLngToECEF(P.lat,P.lng),a.latLngToECEF(k.lat,P.lng),a.latLngToECEF(k.lat,k.lng),a.latLngToECEF(P.lat,k.lng),a.latLngToECEF(D,P.lng),a.latLngToECEF(D,k.lng),a.latLngToECEF(P.lat,U),a.latLngToECEF(k.lat,U)];let ie=a.Aabb.fromPoints(q.map(tt=>[a.dot(X,tt),a.dot(ee,tt),a.dot(J,tt)]));const K=a.transformMat4([],ie.center,Y);a.squaredLength(K)===0&&a.set(K,0,0,1),a.normalize(K,K),a.scale$2(K,K,a.GLOBE_RADIUS),A.center=a.ecefToLatLng(K);const he=A.getWorldToCameraMatrix(),fe=a.invert(new Float64Array(16),he);ie=a.Aabb.applyTransform(ie,a.multiply([],he,Y)),a.transformMat4(K,K,he);const le=.5*(ie.max[2]-ie.min[2]),me=this._minimumAABBFrustumDistance(A,ie),Pe=a.scale$2([],[0,0,1],le),ze=a.add(Pe,K,Pe),ke=me+(A.pitch===0?0:a.distance(K,ze)),Ke=A.globeCenterInViewSpace,we=a.sub([],K,[Ke[0],Ke[1],Ke[2]]);a.normalize(we,we),a.scale$2(we,we,ke);const $e=a.add([],K,we);a.transformMat4($e,$e,fe);const je=a.earthRadius/a.GLOBE_RADIUS,Ie=a.length($e),ve=a.mercatorZfromAltitude(Ie*je-a.earthRadius,0),lt=Math.min(A.zoomFromMercatorZAdjusted(ve),M.maxZoom);return lt>.5*(a.GLOBE_ZOOM_THRESHOLD_MIN+a.GLOBE_ZOOM_THRESHOLD_MAX)?(A.setProjection({name:"mercator"}),A.zoom=lt,this._cameraForBounds(A,h,g,x,b)):{center:A.center,zoom:lt,bearing:x}}queryTerrainElevation(o,h){const g=this.transform.elevation;return g?(h=a.extend({},{exaggerated:!0},h),g.getAtPoint(a.MercatorCoordinate.fromLngLat(o),null,h.exaggerated)):null}_cameraForBounds(o,h,g,x,b){if(o.projection.name==="globe")return this._cameraForBoundsOnGlobe(o,h,g,x,b);const A=o.clone(),M=this._extendCameraOptions(b),P=A.padding;A.bearing=x;const k=a.LngLat.convert(h),D=a.LngLat.convert(g),U=new a.LngLat(k.lng,D.lat),W=new a.LngLat(D.lng,k.lat),J=A.project(k),X=A.project(D),ee=this.queryTerrainElevation(k),Y=this.queryTerrainElevation(D),q=this.queryTerrainElevation(U),ie=this.queryTerrainElevation(W),K=[[J.x,J.y,Math.min(ee||0,Y||0,q||0,ie||0)],[X.x,X.y,Math.max(ee||0,Y||0,q||0,ie||0)]];let he=a.Aabb.fromPoints(K);const fe=A.getWorldToCameraMatrix(),le=a.invert(new Float64Array(16),fe);he=a.Aabb.applyTransform(he,fe);const me=a.sub([],he.max,he.min),Pe=P.left||0,ze=P.right||0,ke=P.bottom||0,Ke=P.top||0,{left:we,right:$e,top:je,bottom:Ie}=M.padding,ve=.5*(Pe+ze),lt=.5*(Ke+ke),tt=Math.min(A.scaleZoom(A.scale*Math.min((A.width-(Pe+ze+we+$e))/me[0],(A.height-(ke+Ke+Ie+je))/me[1])),M.maxZoom),at=A.scale/A.zoomScale(tt);he=new a.Aabb([he.min[0]-(we+ve)*at,he.min[1]-(Ie+lt)*at,he.min[2]],[he.max[0]+($e+ve)*at,he.max[1]+(je+lt)*at,he.max[2]]);const nt=.5*me[2],vt=this._minimumAABBFrustumDistance(A,he),Rt=[0,0,1,0];a.transformMat4$1(Rt,Rt,fe),a.normalize$2(Rt,Rt);const Ct=a.scale$2([],Rt,vt+nt),Et=a.add([],he.center,Ct),rt=(typeof M.offset.x=="number"&&typeof M.offset.y=="number"?new a.pointGeometry(M.offset.x,M.offset.y):a.pointGeometry.convert(M.offset)).rotate(-a.degToRad(x));he.center[0]-=rt.x*at,he.center[1]+=rt.y*at,a.transformMat4(he.center,he.center,le),a.transformMat4(Et,Et,le);const Ft=[he.center[0],he.center[1],Et[2]*A.pixelsPerMeter];a.scale$2(Ft,Ft,1/A.worldSize);const Ht=a.lngFromMercatorX(Ft[0]),bi=a.latFromMercatorY(Ft[1]),wi=Math.min(A._zoomFromMercatorZ(Ft[2]),M.maxZoom),_i=new a.LngLat(Ht,bi);return A.mercatorFromTransition&&wi<.5*(a.GLOBE_ZOOM_THRESHOLD_MIN+a.GLOBE_ZOOM_THRESHOLD_MAX)?(A.setProjection({name:"globe"}),A.zoom=wi,this._cameraForBounds(A,h,g,x,b)):{center:_i,zoom:wi,bearing:x}}fitBounds(o,h,g){const x=this.cameraForBounds(o,h);return this._fitInternal(x,h,g)}fitScreenCoordinates(o,h,g,x,b){const A=a.pointGeometry.convert(o),M=a.pointGeometry.convert(h),P=new a.pointGeometry(Math.min(A.x,M.x),Math.min(A.y,M.y)),k=new a.pointGeometry(Math.max(A.x,M.x),Math.max(A.y,M.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(A,M))return this;const D=this.transform.pointLocation3D(P),U=this.transform.pointLocation3D(k),W=this.transform.pointLocation3D(new a.pointGeometry(P.x,k.y)),J=this.transform.pointLocation3D(new a.pointGeometry(k.x,P.y)),X=[Math.min(D.lng,U.lng,W.lng,J.lng),Math.min(D.lat,U.lat,W.lat,J.lat)],ee=[Math.max(D.lng,U.lng,W.lng,J.lng),Math.max(D.lat,U.lat,W.lat,J.lat)],Y=this._cameraForBounds(this.transform,X,ee,g,x);return this._fitInternal(Y,x,b)}_fitInternal(o,h,g){return o?(delete(h=a.extend(o,h)).padding,h.linear?this.easeTo(h,g):this.flyTo(h,g)):this}jumpTo(o,h){this.stop();const g=o.preloadOnly?this.transform.clone():this.transform;let x=!1,b=!1,A=!1;return"zoom"in o&&g.zoom!==+o.zoom&&(x=!0,g.zoom=+o.zoom),o.center!==void 0&&(g.center=a.LngLat.convert(o.center)),"bearing"in o&&g.bearing!==+o.bearing&&(b=!0,g.bearing=+o.bearing),"pitch"in o&&g.pitch!==+o.pitch&&(A=!0,g.pitch=+o.pitch),o.padding==null||g.isPaddingEqual(o.padding)||(g.padding=o.padding),o.preloadOnly?(this._preloadTiles(g),this):(this.fire(new a.Event("movestart",h)).fire(new a.Event("move",h)),x&&this.fire(new a.Event("zoomstart",h)).fire(new a.Event("zoom",h)).fire(new a.Event("zoomend",h)),b&&this.fire(new a.Event("rotatestart",h)).fire(new a.Event("rotate",h)).fire(new a.Event("rotateend",h)),A&&this.fire(new a.Event("pitchstart",h)).fire(new a.Event("pitch",h)).fire(new a.Event("pitchend",h)),this.fire(new a.Event("moveend",h)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||a.warnOnce(Tu),this.transform.getFreeCameraOptions()}setFreeCameraOptions(o,h){const g=this.transform;if(!g.projection.supportsFreeCamera)return a.warnOnce(Tu),this;this.stop();const x=g.zoom,b=g.pitch,A=g.bearing;g.setFreeCameraOptions(o);const M=x!==g.zoom,P=b!==g.pitch,k=A!==g.bearing;return this.fire(new a.Event("movestart",h)).fire(new a.Event("move",h)),M&&this.fire(new a.Event("zoomstart",h)).fire(new a.Event("zoom",h)).fire(new a.Event("zoomend",h)),k&&this.fire(new a.Event("rotatestart",h)).fire(new a.Event("rotate",h)).fire(new a.Event("rotateend",h)),P&&this.fire(new a.Event("pitchstart",h)).fire(new a.Event("pitch",h)).fire(new a.Event("pitchend",h)),this.fire(new a.Event("moveend",h)),this}easeTo(o,h){this._stop(!1,o.easeId),((o=a.extend({offset:[0,0],duration:500,easing:a.ease},o)).animate===!1||!o.essential&&a.exported.prefersReducedMotion)&&(o.duration=0);const g=this.transform,x=this.getZoom(),b=this.getBearing(),A=this.getPitch(),M=this.getPadding(),P="zoom"in o?+o.zoom:x,k="bearing"in o?this._normalizeBearing(o.bearing,b):b,D="pitch"in o?+o.pitch:A,U="padding"in o?o.padding:g.padding,W=a.pointGeometry.convert(o.offset);let J,X,ee;if(g.projection.name==="globe"){const ze=a.MercatorCoordinate.fromLngLat(g.center),ke=W.rotate(-g.angle);ze.x+=ke.x/g.worldSize,ze.y+=ke.y/g.worldSize;const Ke=ze.toLngLat(),we=a.LngLat.convert(o.center||Ke);this._normalizeCenter(we),J=g.centerPoint.add(ke),X=new a.pointGeometry(ze.x,ze.y).mult(g.worldSize),ee=new a.pointGeometry(a.mercatorXfromLng(we.lng),a.mercatorYfromLat(we.lat)).mult(g.worldSize).sub(X)}else{J=g.centerPoint.add(W);const ze=g.pointLocation(J),ke=a.LngLat.convert(o.center||ze);this._normalizeCenter(ke),X=g.project(ze),ee=g.project(ke).sub(X)}const Y=g.zoomScale(P-x);let q,ie;o.around&&(q=a.LngLat.convert(o.around),ie=g.locationPoint(q));const K=this._zooming||P!==x,he=this._rotating||b!==k,fe=this._pitching||D!==A,le=!g.isPaddingEqual(U),me=ze=>ke=>{if(K&&(ze.zoom=a.number(x,P,ke)),he&&(ze.bearing=a.number(b,k,ke)),fe&&(ze.pitch=a.number(A,D,ke)),le&&(ze.interpolatePadding(M,U,ke),J=ze.centerPoint.add(W)),q)ze.setLocationAtPoint(q,ie);else{const Ke=ze.zoomScale(ze.zoom-x),we=P>x?Math.min(2,Y):Math.max(.5,Y),$e=Math.pow(we,1-ke),je=ze.unproject(X.add(ee.mult(ke*$e)).mult(Ke));ze.setLocationAtPoint(ze.renderWorldCopies?je.wrap():je,J)}return o.preloadOnly||this._fireMoveEvents(h),ze};if(o.preloadOnly){const ze=this._emulate(me,o.duration,g);return this._preloadTiles(ze),this}const Pe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=K,this._rotating=he,this._pitching=fe,this._padding=le,this._easeId=o.easeId,this._prepareEase(h,o.noMoveStart,Pe),this._ease(me(g),ze=>{g.recenterOnTerrain(),this._afterEase(h,ze)},o),this}_prepareEase(o,h,g={}){this._moving=!0,this.transform.cameraElevationReference="sea",h||g.moving||this.fire(new a.Event("movestart",o)),this._zooming&&!g.zooming&&this.fire(new a.Event("zoomstart",o)),this._rotating&&!g.rotating&&this.fire(new a.Event("rotatestart",o)),this._pitching&&!g.pitching&&this.fire(new a.Event("pitchstart",o))}_fireMoveEvents(o){this.fire(new a.Event("move",o)),this._zooming&&this.fire(new a.Event("zoom",o)),this._rotating&&this.fire(new a.Event("rotate",o)),this._pitching&&this.fire(new a.Event("pitch",o))}_afterEase(o,h){if(this._easeId&&h&&this._easeId===h)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const g=this._zooming,x=this._rotating,b=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,g&&this.fire(new a.Event("zoomend",o)),x&&this.fire(new a.Event("rotateend",o)),b&&this.fire(new a.Event("pitchend",o)),this.fire(new a.Event("moveend",o))}flyTo(o,h){if(!o.essential&&a.exported.prefersReducedMotion){const at=a.pick(o,["center","zoom","bearing","pitch","around"]);return this.jumpTo(at,h)}this.stop(),o=a.extend({offset:[0,0],speed:1.2,curve:1.42,easing:a.ease},o);const g=this.transform,x=this.getZoom(),b=this.getBearing(),A=this.getPitch(),M=this.getPadding(),P="zoom"in o?a.clamp(+o.zoom,g.minZoom,g.maxZoom):x,k="bearing"in o?this._normalizeBearing(o.bearing,b):b,D="pitch"in o?+o.pitch:A,U="padding"in o?o.padding:g.padding,W=g.zoomScale(P-x),J=a.pointGeometry.convert(o.offset);let X=g.centerPoint.add(J);const ee=g.pointLocation(X),Y=a.LngLat.convert(o.center||ee);this._normalizeCenter(Y);const q=g.project(ee),ie=g.project(Y).sub(q);let K=o.curve;const he=Math.max(g.width,g.height),fe=he/W,le=ie.mag();if("minZoom"in o){const at=a.clamp(Math.min(o.minZoom,x,P),g.minZoom,g.maxZoom),nt=he/g.zoomScale(at-x);K=Math.sqrt(nt/le*2)}const me=K*K;function Pe(at){const nt=(fe*fe-he*he+(at?-1:1)*me*me*le*le)/(2*(at?fe:he)*me*le);return Math.log(Math.sqrt(nt*nt+1)-nt)}function ze(at){return(Math.exp(at)-Math.exp(-at))/2}function ke(at){return(Math.exp(at)+Math.exp(-at))/2}const Ke=Pe(0);let we=function(at){return ke(Ke)/ke(Ke+K*at)},$e=function(at){return he*((ke(Ke)*(ze(nt=Ke+K*at)/ke(nt))-ze(Ke))/me)/le;var nt},je=(Pe(1)-Ke)/K;if(Math.abs(le)<1e-6||!isFinite(je)){if(Math.abs(he-fe)<1e-6)return this.easeTo(o,h);const at=fe<he?-1:1;je=Math.abs(Math.log(fe/he))/K,$e=function(){return 0},we=function(nt){return Math.exp(at*K*nt)}}o.duration="duration"in o?+o.duration:1e3*je/("screenSpeed"in o?+o.screenSpeed/K:+o.speed),o.maxDuration&&o.duration>o.maxDuration&&(o.duration=0);const Ie=b!==k,ve=D!==A,lt=!g.isPaddingEqual(U),tt=at=>nt=>{const vt=nt*je,Rt=1/we(vt);at.zoom=nt===1?P:x+at.scaleZoom(Rt),Ie&&(at.bearing=a.number(b,k,nt)),ve&&(at.pitch=a.number(A,D,nt)),lt&&(at.interpolatePadding(M,U,nt),X=at.centerPoint.add(J));const Ct=nt===1?Y:at.unproject(q.add(ie.mult($e(vt))).mult(Rt));return at.setLocationAtPoint(at.renderWorldCopies?Ct.wrap():Ct,X),at._updateCameraOnTerrain(),o.preloadOnly||this._fireMoveEvents(h),at};if(o.preloadOnly){const at=this._emulate(tt,o.duration,g);return this._preloadTiles(at),this}return this._zooming=!0,this._rotating=Ie,this._pitching=ve,this._padding=lt,this._prepareEase(h,!1),this._ease(tt(g),()=>this._afterEase(h),o),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(o,h){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const g=this._onEaseEnd;this._onEaseEnd=void 0,g.call(this,h)}if(!o){const g=this.handlers;g&&g.stop(!1)}return this}_ease(o,h,g){g.animate===!1||g.duration===0?(o(1),h()):(this._easeStart=a.exported.now(),this._easeOptions=g,this._onEaseFrame=o,this._onEaseEnd=h,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const o=Math.min((a.exported.now()-this._easeStart)/this._easeOptions.duration,1),h=this._onEaseFrame;h&&h(this._easeOptions.easing(o)),o<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(o,h){o=a.wrap(o,-180,180);const g=Math.abs(o-h);return Math.abs(o-360-h)<g&&(o-=360),Math.abs(o+360-h)<g&&(o+=360),o}_normalizeCenter(o){const h=this.transform;if(!h.renderWorldCopies||h.maxBounds)return;const g=o.lng-h.center.lng;o.lng+=g>180?-360:g<-180?360:0}_emulate(o,h,g){const x=Math.ceil(15*h/1e3),b=[],A=o(g.clone());for(let M=0;M<=x;M++){const P=A(M/x);b.push(P.clone())}return b}}class Eu{constructor(o={}){this.options=o,a.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(o){const h=this.options&&this.options.compact;return this._map=o,this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=N("button","mapboxgl-ctrl-attrib-button",this._container),N("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=N("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),h&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),h===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(o,h){const g=this._map._getUIString(`AttributionControl.${h}`);o.setAttribute("aria-label",g),o.removeAttribute("title"),o.firstElementChild&&o.firstElementChild.setAttribute("title",g)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let o=this._editLink;o||(o=this._editLink=this._container.querySelector(".mapbox-improve-map"));const h=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||a.config.ACCESS_TOKEN}];if(o){const g=h.reduce((x,b,A)=>(b.value&&(x+=`${b.key}=${b.value}${A<h.length-1?"&":""}`),x),"?");o.href=`${a.config.FEEDBACK_URL}/${g}#${mu(this._map,!0)}`,o.rel="noopener nofollow",this._setElementTitle(o,"MapFeedback")}}_updateData(o){!o||o.sourceDataType!=="metadata"&&o.sourceDataType!=="visibility"&&o.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let o=[];if(this._map.style.stylesheet){const x=this._map.style.stylesheet;this.styleOwner=x.owner,this.styleId=x.id}const h=this._map.style._sourceCaches;for(const x in h){const b=h[x];if(b.used){const A=b.getSource();A.attribution&&o.indexOf(A.attribution)<0&&o.push(A.attribution)}}o.sort((x,b)=>x.length-b.length),o=o.filter((x,b)=>{for(let A=b+1;A<o.length;A++)if(o[A].indexOf(x)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?o=[...this.options.customAttribution,...o]:o.unshift(this.options.customAttribution));const g=o.join(" | ");g!==this._attribHTML&&(this._attribHTML=g,o.length?(this._innerContainer.innerHTML=g,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Sa{constructor(){a.bindAll(["_updateLogo","_updateCompact"],this)}onAdd(o){this._map=o,this._container=N("div","mapboxgl-ctrl");const h=N("a","mapboxgl-ctrl-logo");return h.target="_blank",h.rel="noopener nofollow",h.href="https://www.mapbox.com/",h.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),h.setAttribute("rel","noopener nofollow"),this._container.appendChild(h),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(o){o&&o.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const o=this._map.style._sourceCaches;if(Object.entries(o).length===0)return!0;for(const h in o){const g=o[h].getSource();if(g.hasOwnProperty("mapbox_logo")&&!g.mapbox_logo)return!1}return!0}_updateCompact(){const o=this._container.children;if(o.length){const h=o[0];this._map.getCanvasContainer().offsetWidth<250?h.classList.add("mapboxgl-compact"):h.classList.remove("mapboxgl-compact")}}}class Il{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(o){const h=++this._id;return this._queue.push({callback:o,id:h,cancelled:!1}),h}remove(o){const h=this._currentlyRunning,g=h?this._queue.concat(h):this._queue;for(const x of g)if(x.id===o)return void(x.cancelled=!0)}run(o=0){const h=this._currentlyRunning=this._queue;this._queue=[];for(const g of h)if(!g.cancelled&&(g.callback(o),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Ma(p,o,h){if(p=new a.LngLat(p.lng,p.lat),o){const g=new a.LngLat(p.lng-360,p.lat),x=new a.LngLat(p.lng+360,p.lat),b=360*Math.ceil(Math.abs(p.lng-h.center.lng)/360),A=h.locationPoint(p).distSqr(o),M=o.x<0||o.y<0||o.x>h.width||o.y>h.height;h.locationPoint(g).distSqr(o)<A&&(M||Math.abs(g.lng-h.center.lng)<b)?p=g:h.locationPoint(x).distSqr(o)<A&&(M||Math.abs(x.lng-h.center.lng)<b)&&(p=x)}for(;Math.abs(p.lng-h.center.lng)>180;){const g=h.locationPoint(p);if(g.x>=0&&g.y>=0&&g.x<=h.width&&g.y<=h.height)break;p.lng>h.center.lng?p.lng-=360:p.lng+=360}return p}const Cl={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Ll extends a.Evented{constructor(o,h){if(super(),(o instanceof a.window.HTMLElement||h)&&(o=a.extend({element:o},h)),a.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=o&&o.anchor||"center",this._color=o&&o.color||"#3FB1CE",this._scale=o&&o.scale||1,this._draggable=o&&o.draggable||!1,this._clickTolerance=o&&o.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=o&&o.rotation||0,this._rotationAlignment=o&&o.rotationAlignment||"auto",this._pitchAlignment=o&&o.pitchAlignment&&o.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=o&&o.occludedOpacity||.2,o&&o.element)this._element=o.element,this._offset=a.pointGeometry.convert(o&&o.offset||[0,0]);else{this._defaultMarker=!0,this._element=N("div");const x=41,b=27,A=H("svg",{display:"block",height:x*this._scale+"px",width:b*this._scale+"px",viewBox:`0 0 ${b} ${x}`},this._element),M=H("radialGradient",{id:"shadowGradient"},H("defs",{},A));H("stop",{offset:"10%","stop-opacity":.4},M),H("stop",{offset:"100%","stop-opacity":.05},M),H("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},A),H("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},A),H("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},A),H("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},A),this._offset=a.pointGeometry.convert(o&&o.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",x=>{x.preventDefault()}),this._element.addEventListener("mousedown",x=>{x.preventDefault()});const g=this._element.classList;for(const x in Cl)g.remove(`mapboxgl-marker-anchor-${x}`);g.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(o){return o===this._map||(this.remove(),this._map=o,o.getCanvasContainer().appendChild(this._element),o.on("move",this._updateMoving),o.on("moveend",this._update),o.on("remove",this._clearFadeTimer),o._addMarker(this),this.setDraggable(this._draggable),this._update(),o.on("click",this._onMapClick)),this}remove(){const o=this._map;return o&&(o.off("click",this._onMapClick),o.off("move",this._updateMoving),o.off("moveend",this._update),o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler),o.off("mouseup",this._onUp),o.off("touchend",this._onUp),o.off("mousemove",this._onMove),o.off("touchmove",this._onMove),o.off("remove",this._clearFadeTimer),o._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(o){return this._lngLat=a.LngLat.convert(o),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(o){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),o){if(!("offset"in o.options)){const x=Math.sqrt(Math.pow(13.5,2)/2);o.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[x,-1*(38.1-13.5+x)],"bottom-right":[-x,-1*(38.1-13.5+x)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=o,o._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(o){const h=o.code,g=o.charCode||o.keyCode;h!=="Space"&&h!=="Enter"&&g!==32&&g!==13||this.togglePopup()}_onMapClick(o){const h=o.originalEvent.target,g=this._element;this._popup&&(h===g||g.contains(h))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const o=this._popup;return o?(o.isOpen()?(o.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(o.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const o=this._map,h=this._pos;if(!o||!h)return!1;const g=o.unproject(h),x=o.getFreeCameraOptions();if(!x.position)return!1;const b=x.position.toLngLat();return b.distanceTo(g)<.9*b.distanceTo(this._lngLat)}_evaluateOpacity(){const o=this._map;if(!o)return;const h=this._pos;if(!h||h.x<0||h.x>o.transform.width||h.y<0||h.y>o.transform.height)return void this._clearFadeTimer();const g=o.unproject(h);let x;o._showingGlobe()&&a.isLngLatBehindGlobe(o.transform,this._lngLat)?x=0:(x=1-o._queryFogOpacity(g),o.transform._terrainEnabled()&&o.getTerrain()&&this._behindTerrain()&&(x*=this._occludedOpacity)),this._element.style.opacity=`${x}`,this._element.style.pointerEvents=x>0?"auto":"none",this._popup&&this._popup._setOpacity(x),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const o=this._pos;if(!o||!this._map)return;const h=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${o.x}px,${o.y}px)
            ${Cl[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${h.x}px,${h.y}px)
        `}_calculateXYTransform(){const o=this._pos,h=this._map,g=this.getPitchAlignment();if(!h||!o||g!=="map")return"";if(!h._showingGlobe()){const P=h.getPitch();return P?`rotateX(${P}deg)`:""}const x=a.radToDeg(a.globeTiltAtLngLat(h.transform,this._lngLat)),b=o.sub(a.globeCenterToScreenPoint(h.transform)),A=Math.abs(b.x)+Math.abs(b.y);if(A===0)return"";const M=x/A;return`rotateX(${-b.y*M}deg) rotateY(${b.x*M}deg)`}_calculateZTransform(){const o=this._pos,h=this._map;if(!h||!o)return"";let g=0;const x=this.getRotationAlignment();if(x==="map")if(h._showingGlobe()){const b=h.project(new a.LngLat(this._lngLat.lng,this._lngLat.lat+.001)),A=h.project(new a.LngLat(this._lngLat.lng,this._lngLat.lat-.001)).sub(b);g=a.radToDeg(Math.atan2(A.y,A.x))-90}else g=-h.getBearing();else if(x==="horizon"){const b=a.smoothstep(4,6,h.getZoom()),A=a.globeCenterToScreenPoint(h.transform);A.y+=b*h.transform.height;const M=o.sub(A),P=a.radToDeg(Math.atan2(M.y,M.x));g=(P>90?P-270:P+90)*(1-b)}return g+=this._rotation,g?`rotateZ(${g}deg)`:""}_update(o){a.window.cancelAnimationFrame(this._updateFrameId);const h=this._map;h&&(h.transform.renderWorldCopies&&(this._lngLat=Ma(this._lngLat,this._pos,h.transform)),this._pos=h.project(this._lngLat),o===!0?this._updateFrameId=a.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),h._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(h._showingGlobe()||h.getTerrain()||h.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(o){return this._offset=a.pointGeometry.convert(o),this._update(),this}_onMove(o){const h=this._map;if(!h)return;const g=this._pointerdownPos,x=this._positionDelta;if(g&&x){if(!this._isDragging){const b=this._clickTolerance||h._clickTolerance;if(o.point.dist(g)<b)return;this._isDragging=!0}this._pos=o.point.sub(x),this._lngLat=h.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new a.Event("dragstart"))),this.fire(new a.Event("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const o=this._map;o&&(o.off("mousemove",this._onMove),o.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new a.Event("dragend")),this._state="inactive"}_addDragHandler(o){const h=this._map,g=this._pos;h&&g&&this._element.contains(o.originalEvent.target)&&(o.preventDefault(),this._positionDelta=o.point.sub(g),this._pointerdownPos=o.point,this._state="pending",h.on("mousemove",this._onMove),h.on("touchmove",this._onMove),h.once("mouseup",this._onUp),h.once("touchend",this._onUp))}setDraggable(o){this._draggable=!!o;const h=this._map;return h&&(o?(h.on("mousedown",this._addDragHandler),h.on("touchstart",this._addDragHandler)):(h.off("mousedown",this._addDragHandler),h.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(o){return this._rotation=o||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(o){return this._rotationAlignment=o||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(o){return this._pitchAlignment=o||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(o){return this._occludedOpacity=o||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Ud={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Vd=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Au(p=new a.pointGeometry(0,0),o="bottom"){if(typeof p=="number"){const h=Math.round(Math.sqrt(.5*Math.pow(p,2)));switch(o){case"top":return new a.pointGeometry(0,p);case"top-left":return new a.pointGeometry(h,h);case"top-right":return new a.pointGeometry(-h,h);case"bottom":return new a.pointGeometry(0,-p);case"bottom-left":return new a.pointGeometry(h,-h);case"bottom-right":return new a.pointGeometry(-h,-h);case"left":return new a.pointGeometry(p,0);case"right":return new a.pointGeometry(-p,0)}return new a.pointGeometry(0,0)}return p instanceof a.pointGeometry||Array.isArray(p)?a.pointGeometry.convert(p):a.pointGeometry.convert(p[o]||[0,0])}class jd{constructor(o){this.jumpTo(o)}getValue(o){if(o<=this._startTime)return this._start;if(o>=this._endTime)return this._end;const h=a.easeCubicInOut((o-this._startTime)/(this._endTime-this._startTime));return this._start*(1-h)+this._end*h}isEasing(o){return o>=this._startTime&&o<=this._endTime}jumpTo(o){this._startTime=-1/0,this._endTime=-1/0,this._start=o,this._end=o}easeTo(o,h,g){this._start=this.getValue(h),this._end=o,this._startTime=h,this._endTime=h+g}}const Gd={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},Su={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function kl(p){p.parentNode&&p.parentNode.removeChild(p)}const Wd={showCompass:!0,showZoom:!0,visualizePitch:!1};class Zd{constructor(o,h,g=!1){this._clickTolerance=10,this.element=h,this.mouseRotate=new yu({clickTolerance:o.dragRotate._mouseRotate._clickTolerance}),this.map=o,g&&(this.mousePitch=new go({clickTolerance:o.dragRotate._mousePitch._clickTolerance})),a.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),h.addEventListener("mousedown",this.mousedown),h.addEventListener("touchstart",this.touchstart,{passive:!1}),h.addEventListener("touchmove",this.touchmove),h.addEventListener("touchend",this.touchend),h.addEventListener("touchcancel",this.reset)}down(o,h){this.mouseRotate.mousedown(o,h),this.mousePitch&&this.mousePitch.mousedown(o,h),De()}move(o,h){const g=this.map,x=this.mouseRotate.mousemoveWindow(o,h),b=x&&x.bearingDelta;if(b&&g.setBearing(g.getBearing()+b),this.mousePitch){const A=this.mousePitch.mousemoveWindow(o,h),M=A&&A.pitchDelta;M&&g.setPitch(g.getPitch()+M)}}off(){const o=this.element;o.removeEventListener("mousedown",this.mousedown),o.removeEventListener("touchstart",this.touchstart,{passive:!1}),o.removeEventListener("touchmove",this.touchmove),o.removeEventListener("touchend",this.touchend),o.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Oe(),a.window.removeEventListener("mousemove",this.mousemove),a.window.removeEventListener("mouseup",this.mouseup)}mousedown(o){this.down(a.extend({},o,{ctrlKey:!0,preventDefault:()=>o.preventDefault()}),Ee(this.element,o)),a.window.addEventListener("mousemove",this.mousemove),a.window.addEventListener("mouseup",this.mouseup)}mousemove(o){this.move(o,Ee(this.element,o))}mouseup(o){this.mouseRotate.mouseupWindow(o),this.mousePitch&&this.mousePitch.mouseupWindow(o),this.offTemp()}touchstart(o){o.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=dt(this.element,o.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>o.preventDefault()},this._startPos))}touchmove(o){o.targetTouches.length!==1?this.reset():(this._lastPos=dt(this.element,o.targetTouches)[0],this.move({preventDefault:()=>o.preventDefault()},this._lastPos))}touchend(o){o.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const $d={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Mu={maxWidth:100,unit:"metric"};function qd(p,o,h){const g=Rl(o),x=g/o,b={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"}[h];this._map._requestDomTask(()=>{this._container.style.width=p*x+"px",this._container.innerHTML=`${g}&nbsp;${b}`})}function Rl(p){const o=Math.pow(10,`${Math.floor(p)}`.length-1);let h=p/o;return h=h>=10?10:h>=5?5:h>=3?3:h>=2?2:h>=1?1:function(g){const x=Math.pow(10,Math.ceil(-Math.log(g)/Math.LN10));return Math.round(g*x)/x}(h),o*h}const Pa={version:a.version,supported:I,setRTLTextPlugin:a.setRTLTextPlugin,getRTLTextPluginStatus:a.getRTLTextPluginStatus,Map:class extends Nd{constructor(p){if(a.LivePerformanceUtils.mark(a.PerformanceMarkers.create),(p=a.extend({},Su,p)).minZoom!=null&&p.maxZoom!=null&&p.minZoom>p.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(p.minPitch!=null&&p.maxPitch!=null&&p.minPitch>p.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(p.minPitch!=null&&p.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(p.maxPitch!=null&&p.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(p.antialias&&a.isSafariWithAntialiasingBug(a.window)&&(p.antialias=!1,a.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new _r(p.minZoom,p.maxZoom,p.minPitch,p.maxPitch,p.renderWorldCopies),p),this._interactive=p.interactive,this._minTileCacheSize=p.minTileCacheSize,this._maxTileCacheSize=p.maxTileCacheSize,this._failIfMajorPerformanceCaveat=p.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=p.preserveDrawingBuffer,this._antialias=p.antialias,this._trackResize=p.trackResize,this._bearingSnap=p.bearingSnap,this._refreshExpiredTiles=p.refreshExpiredTiles,this._fadeDuration=p.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=p.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=p.collectResourceTiming,this._optimizeForTerrain=p.optimizeForTerrain,this._language=this._parseLanguage(p.language),this._worldview=p.worldview,this._renderTaskQueue=new Il,this._domRenderTaskQueue=new Il,this._controls=[],this._markers=[],this._popups=[],this._mapId=a.uniqueId(),this._locale=a.extend({},Gd,p.locale),this._clickTolerance=p.clickTolerance,this._cooperativeGestures=p.cooperativeGestures,this._performanceMetricsCollection=p.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new jd(0),this._interactionRange=[1/0,-1/0],this._useExplicitProjection=!1,this._requestManager=new a.RequestManager(p.transformRequest,p.accessToken,p.testMode),this._silenceAuthErrors=!!p.testMode,typeof p.container=="string"){if(this._container=a.window.document.getElementById(p.container),!this._container)throw new Error(`Container '${p.container}' not found.`)}else{if(!(p.container instanceof a.window.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=p.container}if(this._container.childNodes.length>0&&a.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),p.maxBounds&&this.setMaxBounds(p.maxBounds),a.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),a.window!==void 0&&(a.window.addEventListener("online",this._onWindowOnline,!1),a.window.addEventListener("resize",this._onWindowResize,!1),a.window.addEventListener("orientationchange",this._onWindowResize,!1),a.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new Fd(this,p),this._localFontFamily=p.localFontFamily,this._localIdeographFontFamily=p.localIdeographFontFamily,p.style&&this.setStyle(p.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),p.projection&&this.setProjection(p.projection),this._hash=p.hash&&new Td(typeof p.hash=="string"&&p.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:p.center,zoom:p.zoom,bearing:p.bearing,pitch:p.pitch}),p.bounds&&(this.resize(),this.fitBounds(p.bounds,a.extend({},p.fitBoundsOptions,{duration:0})))),this.resize(),p.attributionControl&&this.addControl(new Eu({customAttribution:p.customAttribution})),this._logoControl=new Sa,this.addControl(this._logoControl,p.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new a.Event(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new a.Event(`${o.dataType}dataloading`,o))})}_getMapId(){return this._mapId}addControl(p,o){if(o===void 0&&(o=p.getDefaultPosition?p.getDefaultPosition():"top-right"),!p||!p.onAdd)return this.fire(new a.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const h=p.onAdd(this);this._controls.push(p);const g=this._controlPositions[o];return o.indexOf("bottom")!==-1?g.insertBefore(h,g.firstChild):g.appendChild(h),this}removeControl(p){if(!p||!p.onRemove)return this.fire(new a.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const o=this._controls.indexOf(p);return o>-1&&this._controls.splice(o,1),p.onRemove(this),this}hasControl(p){return this._controls.indexOf(p)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(p){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const o=!this._moving;return o&&this.fire(new a.Event("movestart",p)).fire(new a.Event("move",p)),this.fire(new a.Event("resize",p)),o&&this.fire(new a.Event("moveend",p)),this}getBounds(){return this.transform.projection.name==="globe"&&a.warnOnce('Globe projection does not support getBounds API, this API may behave unexpectedly when viewing the poles."'),this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(p){return this.transform.setMaxBounds(a.LngLatBounds.convert(p)),this._update()}setMinZoom(p){if((p=p??-2)>=-2&&p<=this.transform.maxZoom)return this.transform.minZoom=p,this._update(),this.getZoom()<p?this.setZoom(p):this.fire(new a.Event("zoomstart")).fire(new a.Event("zoom")).fire(new a.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(p){if((p=p??22)>=this.transform.minZoom)return this.transform.maxZoom=p,this._update(),this.getZoom()>p?this.setZoom(p):this.fire(new a.Event("zoomstart")).fire(new a.Event("zoom")).fire(new a.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(p){if((p=p??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(p>=0&&p<=this.transform.maxPitch)return this.transform.minPitch=p,this._update(),this.getPitch()<p?this.setPitch(p):this.fire(new a.Event("pitchstart")).fire(new a.Event("pitch")).fire(new a.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(p){if((p=p??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(p>=this.transform.minPitch)return this.transform.maxPitch=p,this._update(),this.getPitch()>p?this.setPitch(p):this.fire(new a.Event("pitchstart")).fire(new a.Event("pitch")).fire(new a.Event("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(p){return this.transform.renderWorldCopies=p,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(p){return p==="auto"?a.window.navigator.language:Array.isArray(p)?p.length===0?void 0:p.map(o=>o==="auto"?a.window.navigator.language:o):p}setLanguage(p){const o=this._parseLanguage(p);if(!this.style||o===this._language)return this;this._language=o,this.style._reloadSources();for(const h of this._controls)h._setLanguage&&h._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(p){return this.style&&p!==this._worldview?(this._worldview=p,this.style._reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(p){return this._lazyInitEmptyStyle(),p?typeof p=="string"&&(p={name:p}):p=null,this._useExplicitProjection=!!p,this._prioritizeAndUpdateProjection(p,this.style.stylesheet?this.style.stylesheet.projection:null)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const p=this.transform,o=p.projection.name;let h;o==="globe"&&p.zoom>=a.GLOBE_ZOOM_THRESHOLD_MAX?(p.setMercatorFromTransition(),h=!0):o==="mercator"&&p.zoom<a.GLOBE_ZOOM_THRESHOLD_MAX&&(p.setProjection({name:"globe"}),h=!0),h&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(p,o){return this._updateProjection(p||o||{name:"mercator"})}_updateProjection(p){let o;if(o=p.name==="globe"&&this.transform.zoom>=a.GLOBE_ZOOM_THRESHOLD_MAX?this.transform.setMercatorFromTransition():this.transform.setProjection(p),this.style.applyProjectionUpdate(),o){this.painter.clearBackgroundTiles();for(const h in this.style._sourceCaches)this.style._sourceCaches[h].clearTiles();this._update(!0),this._forceMarkerAndPopupUpdate(!0)}return this}project(p){return this.transform.locationPoint3D(a.LngLat.convert(p))}unproject(p){return this.transform.pointLocation3D(a.pointGeometry.convert(p))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_createDelegatedListener(p,o,h){if(p==="mouseenter"||p==="mouseover"){let g=!1;const x=A=>{const M=o.filter(k=>this.getLayer(k)),P=M.length?this.queryRenderedFeatures(A.point,{layers:M}):[];P.length?g||(g=!0,h.call(this,new yr(p,this,A.originalEvent,{features:P}))):g=!1},b=()=>{g=!1};return{layers:new Set(o),listener:h,delegates:{mousemove:x,mouseout:b}}}if(p==="mouseleave"||p==="mouseout"){let g=!1;const x=A=>{const M=o.filter(P=>this.getLayer(P));(M.length?this.queryRenderedFeatures(A.point,{layers:M}):[]).length?g=!0:g&&(g=!1,h.call(this,new yr(p,this,A.originalEvent)))},b=A=>{g&&(g=!1,h.call(this,new yr(p,this,A.originalEvent)))};return{layers:new Set(o),listener:h,delegates:{mousemove:x,mouseout:b}}}{const g=x=>{const b=o.filter(M=>this.getLayer(M)),A=b.length?this.queryRenderedFeatures(x.point,{layers:b}):[];A.length&&(x.features=A,h.call(this,x),delete x.features)};return{layers:new Set(o),listener:h,delegates:{[p]:g}}}}on(p,o,h){if(h===void 0)return super.on(p,o);Array.isArray(o)||(o=[o]);const g=this._createDelegatedListener(p,o,h);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[p]=this._delegatedListeners[p]||[],this._delegatedListeners[p].push(g);for(const x in g.delegates)this.on(x,g.delegates[x]);return this}once(p,o,h){if(h===void 0)return super.once(p,o);Array.isArray(o)||(o=[o]);const g=this._createDelegatedListener(p,o,h);for(const x in g.delegates)this.once(x,g.delegates[x]);return this}off(p,o,h){if(h===void 0)return super.off(p,o);o=new Set(Array.isArray(o)?o:[o]);const g=(b,A)=>{if(b.size!==A.size)return!1;for(const M of b)if(!A.has(M))return!1;return!0},x=this._delegatedListeners?this._delegatedListeners[p]:void 0;return x&&(b=>{for(let A=0;A<b.length;A++){const M=b[A];if(M.listener===h&&g(M.layers,o)){for(const P in M.delegates)this.off(P,M.delegates[P]);return b.splice(A,1),this}}})(x),this}queryRenderedFeatures(p,o){return this.style?(o!==void 0||p===void 0||p instanceof a.pointGeometry||Array.isArray(p)||(o=p,p=void 0),this.style.queryRenderedFeatures(p=p||[[0,0],[this.transform.width,this.transform.height]],o=o||{},this.transform)):[]}querySourceFeatures(p,o){return this.style.querySourceFeatures(p,o)}setStyle(p,o){return(o=a.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},o)).diff!==!1&&o.localIdeographFontFamily===this._localIdeographFontFamily&&o.localFontFamily===this._localFontFamily&&this.style&&p?(this._diffStyle(p,o),this):(this._localIdeographFontFamily=o.localIdeographFontFamily,this._localFontFamily=o.localFontFamily,this._updateStyle(p,o))}_getUIString(p){const o=this._locale[p];if(o==null)throw new Error(`Missing UI string '${p}'`);return o}_updateStyle(p,o){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),p&&(this.style=new ss(this,o||{}),this.style.setEventedParent(this,{style:this.style}),typeof p=="string"?this.style.loadURL(p):this.style.loadJSON(p)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new ss(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(p,o){if(typeof p=="string"){const h=this._requestManager.normalizeStyleURL(p),g=this._requestManager.transformRequest(h,a.ResourceType.Style);a.getJSON(g,(x,b)=>{x?this.fire(new a.ErrorEvent(x)):b&&this._updateDiff(b,o)})}else typeof p=="object"&&this._updateDiff(p,o)}_updateDiff(p,o){try{this.style.setState(p)&&this._update(!0)}catch(h){a.warnOnce(`Unable to perform style diff: ${h.message||h.error||h}.  Rebuilding the style from scratch.`),this._updateStyle(p,o)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(a.warnOnce("There is no style added to the map."),!1)}addSource(p,o){return this._lazyInitEmptyStyle(),this.style.addSource(p,o),this._update(!0)}isSourceLoaded(p){return!!this.style&&this.style._isSourceCacheLoaded(p)}areTilesLoaded(){const p=this.style&&this.style._sourceCaches;for(const o in p){const h=p[o]._tiles;for(const g in h){const x=h[g];if(x.state!=="loaded"&&x.state!=="errored")return!1}}return!0}addSourceType(p,o,h){this._lazyInitEmptyStyle(),this.style.addSourceType(p,o,h)}removeSource(p){return this.style.removeSource(p),this._updateTerrain(),this._update(!0)}getSource(p){return this.style.getSource(p)}addImage(p,o,{pixelRatio:h=1,sdf:g=!1,stretchX:x,stretchY:b,content:A}={}){if(this._lazyInitEmptyStyle(),o instanceof a.window.HTMLImageElement||a.window.ImageBitmap&&o instanceof a.window.ImageBitmap){const{width:M,height:P,data:k}=a.exported.getImageData(o);this.style.addImage(p,{data:new a.RGBAImage({width:M,height:P},k),pixelRatio:h,stretchX:x,stretchY:b,content:A,sdf:g,version:0})}else if(o.width===void 0||o.height===void 0)this.fire(new a.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:M,height:P}=o,k=o;this.style.addImage(p,{data:new a.RGBAImage({width:M,height:P},new Uint8Array(k.data)),pixelRatio:h,stretchX:x,stretchY:b,content:A,sdf:g,version:0,userImage:k}),k.onAdd&&k.onAdd(this,p)}}updateImage(p,o){const h=this.style.getImage(p);if(!h)return void this.fire(new a.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const g=o instanceof a.window.HTMLImageElement||a.window.ImageBitmap&&o instanceof a.window.ImageBitmap?a.exported.getImageData(o):o,{width:x,height:b}=g;x!==void 0&&b!==void 0?x===h.data.width&&b===h.data.height?(h.data.replace(g.data,!(o instanceof a.window.HTMLImageElement||a.window.ImageBitmap&&o instanceof a.window.ImageBitmap)),this.style.updateImage(p,h)):this.fire(new a.ErrorEvent(new Error(`The width and height of the updated image (${x}, ${b})
                must be that same as the previous version of the image
                (${h.data.width}, ${h.data.height})`))):this.fire(new a.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(p){return p?!!this.style.getImage(p):(this.fire(new a.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(p){this.style.removeImage(p)}loadImage(p,o){a.getImage(this._requestManager.transformRequest(p,a.ResourceType.Image),(h,g)=>{o(h,g instanceof a.window.HTMLImageElement?a.exported.getImageData(g):g)})}listImages(){return this.style.listImages()}addLayer(p,o){return this._lazyInitEmptyStyle(),this.style.addLayer(p,o),this._update(!0)}moveLayer(p,o){return this.style.moveLayer(p,o),this._update(!0)}removeLayer(p){return this.style.removeLayer(p),this._update(!0)}getLayer(p){return this.style.getLayer(p)}setLayerZoomRange(p,o,h){return this.style.setLayerZoomRange(p,o,h),this._update(!0)}setFilter(p,o,h={}){return this.style.setFilter(p,o,h),this._update(!0)}getFilter(p){return this.style.getFilter(p)}setPaintProperty(p,o,h,g={}){return this.style.setPaintProperty(p,o,h,g),this._update(!0)}getPaintProperty(p,o){return this.style.getPaintProperty(p,o)}setLayoutProperty(p,o,h,g={}){return this.style.setLayoutProperty(p,o,h,g),this._update(!0)}getLayoutProperty(p,o){return this.style.getLayoutProperty(p,o)}setLight(p,o={}){return this._lazyInitEmptyStyle(),this.style.setLight(p,o),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(p){return this._lazyInitEmptyStyle(),!p&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(p),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(p){return this._lazyInitEmptyStyle(),this.style.setFog(p),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(p){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(a.LngLat.convert(p),this.transform):0}setFeatureState(p,o){return this.style.setFeatureState(p,o),this._update()}removeFeatureState(p,o){return this.style.removeFeatureState(p,o),this._update()}getFeatureState(p){return this.style.getFeatureState(p)}_updateContainerDimensions(){if(!this._container)return;const p=this._container.getBoundingClientRect().width||400,o=this._container.getBoundingClientRect().height||300;let h,g,x,b=this._container;for(;b&&(!g||!x);){const A=a.window.getComputedStyle(b).transform;A&&A!=="none"&&(h=A.match(/matrix.*\((.+)\)/)[1].split(", "),h[0]&&h[0]!=="0"&&h[0]!=="1"&&(g=h[0]),h[3]&&h[3]!=="0"&&h[3]!=="1"&&(x=h[3])),b=b.parentElement}this._containerWidth=g?Math.abs(p/g):p,this._containerHeight=x?Math.abs(o/x):o}_detectMissingCSS(){a.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&a.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const p=this._container;p.classList.add("mapboxgl-map"),(this._missingCSSCanary=N("div","mapboxgl-canary",p)).style.visibility="hidden",this._detectMissingCSS();const o=this._canvasContainer=N("div","mapboxgl-canvas-container",p);this._interactive&&o.classList.add("mapboxgl-interactive"),this._canvas=N("canvas","mapboxgl-canvas",o),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const h=this._controlContainer=N("div","mapboxgl-control-container",p),g=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(x=>{g[x]=N("div",`mapboxgl-ctrl-${x}`,h)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(p,o){const h=a.exported.devicePixelRatio||1;this._canvas.width=h*Math.ceil(p),this._canvas.height=h*Math.ceil(o),this._canvas.style.width=`${p}px`,this._canvas.style.height=`${o}px`}_addMarker(p){this._markers.push(p)}_removeMarker(p){const o=this._markers.indexOf(p);o!==-1&&this._markers.splice(o,1)}_addPopup(p){this._popups.push(p)}_removePopup(p){const o=this._popups.indexOf(p);o!==-1&&this._popups.splice(o,1)}_setupPainter(){const p=a.extend({},I.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),o=this._canvas.getContext("webgl",p)||this._canvas.getContext("experimental-webgl",p);o?(a.storeAuthState(o,!0),this.painter=new nm(o,this.transform),this.on("data",h=>{h.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),a.exported$1.testSupport(o)):this.fire(new a.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(p){p.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new a.Event("webglcontextlost",{originalEvent:p}))}_contextRestored(p){this._setupPainter(),this.resize(),this._update(),this.fire(new a.Event("webglcontextrestored",{originalEvent:p}))}_onMapScroll(p){if(p.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(p){return this.style?(this._styleDirty=this._styleDirty||p,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(p){return this._update(),this._renderTaskQueue.add(p)}_cancelRenderFrame(p){this._renderTaskQueue.remove(p)}_requestDomTask(p){!this.loaded()||this.loaded()&&!this.isMoving()?p():this._domRenderTaskQueue.add(p)}_render(p){let o;const h=this.painter.context.extTimerQuery,g=a.exported.now();if(this.listens("gpu-timing-frame")&&(o=h.createQueryEXT(),h.beginQueryEXT(h.TIME_ELAPSED_EXT,o)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],a.window.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],a.window.performance.now())),this._renderTaskQueue.run(p),this._domRenderTaskQueue.run(p),this._removed)return;this._updateProjectionTransition();let x=!1;const b=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const P=this.transform.zoom,k=this.transform.pitch,D=a.exported.now();this.style.zoomHistory.update(P,D);const U=new a.EvaluationParameters(P,{now:D,fadeDuration:b,pitch:k,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),W=U.crossFadingFactor();W===1&&W===this._crossFadingFactor||(x=!0,this._crossFadingFactor=W),this.style.update(U)}this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let A=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),A=this._updateAverageElevation(g),this.style._updateSources(this.transform),this._forceMarkerAndPopupUpdate()):A=this._updateAverageElevation(g),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,b,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:b,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new a.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new a.Event("load"))),this.style&&(this.style.hasTransitions()||x)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),o){const P=a.exported.now()-g;h.endQueryEXT(h.TIME_ELAPSED_EXT,o),setTimeout(()=>{const k=h.getQueryObjectEXT(o,h.QUERY_RESULT_EXT)/1e6;h.deleteQueryEXT(o),this.fire(new a.Event("gpu-timing-frame",{cpuTime:P,gpuTime:k})),a.window.performance.mark("frame-gpu",{startTime:g,detail:{gpuTime:k}})},50)}if(this.listens("gpu-timing-layer")){const P=this.painter.collectGpuTimers();setTimeout(()=>{const k=this.painter.queryGpuTimers(P);this.fire(new a.Event("gpu-timing-layer",{layerTimes:k}))},50)}if(this.listens("gpu-timing-deferred-render")){const P=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const k=this.painter.queryGpuTimeDeferredRender(P);this.fire(new a.Event("gpu-timing-deferred-render",{gpuTime:k}))},50)}const M=this._sourcesDirty||this._styleDirty||this._placementDirty||A;if(M||this._repaint)this.triggerRepaint();else{const P=!this.isMoving()&&this.loaded();if(P&&(A=this._updateAverageElevation(g,!0)),A)this.triggerRepaint();else if(this._triggerFrame(!1),P&&(this.fire(new a.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const k=this._calculateSpeedIndex();this.fire(new a.Event("speedindexcompleted",{speedIndex:k})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||M||(this._fullyLoaded=!0,a.LivePerformanceUtils.mark(a.PerformanceMarkers.fullLoad),this._performanceMetricsCollection&&a.postPerformanceEvent(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.painter.transform.projection,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(p){for(const o of this._markers)p&&!this.getRenderWorldCopies()&&(o._lngLat=o._lngLat.wrap()),o._update();for(const o of this._popups)!p||this.getRenderWorldCopies()||o._trackPointer||(o._lngLat=o._lngLat.wrap()),o._update()}_updateAverageElevation(p,o=!1){const h=g=>(this.transform.averageElevation=g,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&h(0);if((o||p-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(p)){const g=this.transform.averageElevation;let x=this.transform.sampleAverageElevation(),b=!1;this.transform.elevation&&(b=this.transform.elevation.exaggeration()!==this._averageElevationExaggeration,this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(x)?x=0:this._averageElevationLastSampledAt=p;const A=Math.abs(g-x);if(A>1){if(this._isInitialLoad||b)return this._averageElevation.jumpTo(x),h(x);this._averageElevation.easeTo(x,p,300)}else if(A>1e-4)return this._averageElevation.jumpTo(x),h(x)}return!!this._averageElevation.isEasing(p)&&h(this._averageElevation.getValue(p))}_authenticate(){a.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,p=>{if(p&&(p.message===a.AUTH_ERR_MSG||p.status===401)){const o=this.painter.context.gl;a.storeAuthState(o,!1),this._logoControl instanceof Sa&&this._logoControl._updateLogo(),o&&o.clear(o.DEPTH_BUFFER_BIT|o.COLOR_BUFFER_BIT|o.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new a.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),a.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const p=this.painter.canvasCopy(),o=this.painter.getCanvasCopiesAndTimestamps();o.timeStamps.push(performance.now());const h=this.painter.context.gl,g=h.createFramebuffer();function x(b){h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,b,0);const A=new Uint8Array(h.drawingBufferWidth*h.drawingBufferHeight*4);return h.readPixels(0,0,h.drawingBufferWidth,h.drawingBufferHeight,h.RGBA,h.UNSIGNED_BYTE,A),A}return h.bindFramebuffer(h.FRAMEBUFFER,g),this._canvasPixelComparison(x(p),o.canvasCopies.map(x),o.timeStamps)}_canvasPixelComparison(p,o,h){let g=h[1]-h[0];const x=p.length/4;for(let b=0;b<o.length;b++){const A=o[b];let M=0;for(let P=0;P<A.length;P+=4)A[P]===p[P]&&A[P+1]===p[P+1]&&A[P+2]===p[P+2]&&A[P+3]===p[P+3]&&(M+=1);g+=(h[b+2]-h[b+1])*(1-M/x)}return g}remove(){this._hash&&this._hash.remove();for(const o of this._controls)o.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),a.window!==void 0&&(a.window.removeEventListener("resize",this._onWindowResize,!1),a.window.removeEventListener("orientationchange",this._onWindowResize,!1),a.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),a.window.removeEventListener("online",this._onWindowOnline,!1));const p=this.painter.context.gl.getExtension("WEBGL_lose_context");p&&p.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),kl(this._canvasContainer),kl(this._controlContainer),kl(this._missingCSSCanary),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),a.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new a.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(p){this._renderNextFrame=this._renderNextFrame||p,this.style&&!this._frame&&(this._frame=a.exported.frame(o=>{const h=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,h&&this._render(o)}))}_preloadTiles(p){const o=this.style?Object.values(this.style._sourceCaches):[];return a.asyncAll(o,(h,g)=>h._preloadTiles(p,g),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(p){this._trackResize&&this.resize({originalEvent:p})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(p){this._showTileBoundaries!==p&&(this._showTileBoundaries=p,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(p){this._showTerrainWireframe!==p&&(this._showTerrainWireframe=p,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(p){this._speedIndexTiming!==p&&(this._speedIndexTiming=p,this._update())}get showPadding(){return!!this._showPadding}set showPadding(p){this._showPadding!==p&&(this._showPadding=p,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(p){this._showCollisionBoxes!==p&&(this._showCollisionBoxes=p,p?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(p){this._showOverdrawInspector!==p&&(this._showOverdrawInspector=p,this._update())}get repaint(){return!!this._repaint}set repaint(p){this._repaint!==p&&(this._repaint=p,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(p){this._vertices=p,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(p){this._showTileAABBs!==p&&(this._showTileAABBs=p,p&&this._update())}_setCacheLimits(p,o){a.setCacheLimits(p,o)}get version(){return a.version}},NavigationControl:class{constructor(p){this.options=a.extend({},Wd,p),this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",o=>o.preventDefault()),this.options.showZoom&&(a.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",o=>{this._map&&this._map.zoomIn({},{originalEvent:o})}),N("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",o=>{this._map&&this._map.zoomOut({},{originalEvent:o})}),N("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(a.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",o=>{const h=this._map;h&&(this.options.visualizePitch?h.resetNorthPitch({},{originalEvent:o}):h.resetNorth({},{originalEvent:o}))}),this._compassIcon=N("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const p=this._map;if(!p)return;const o=p.getZoom(),h=o===p.getMaxZoom(),g=o===p.getMinZoom();this._zoomInButton.disabled=h,this._zoomOutButton.disabled=g,this._zoomInButton.setAttribute("aria-disabled",h.toString()),this._zoomOutButton.setAttribute("aria-disabled",g.toString())}_rotateCompassArrow(){const p=this._map;if(!p)return;const o=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(p.transform.pitch*(Math.PI/180)),.5)}) rotateX(${p.transform.pitch}deg) rotateZ(${p.transform.angle*(180/Math.PI)}deg)`:`rotate(${p.transform.angle*(180/Math.PI)}deg)`;p._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=o)})}onAdd(p){return this._map=p,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),p.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&p.on("pitch",this._rotateCompassArrow),p.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Zd(p,this._compass,this.options.visualizePitch)),this._container}onRemove(){const p=this._map;p&&(this._container.remove(),this.options.showZoom&&p.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&p.off("pitch",this._rotateCompassArrow),p.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(p,o){const h=N("button",p,this._container);return h.type="button",h.addEventListener("click",o),h}_setButtonTitle(p,o){if(!this._map)return;const h=this._map._getUIString(`NavigationControl.${o}`);p.setAttribute("aria-label",h),p.firstElementChild&&p.firstElementChild.setAttribute("title",h)}},GeolocateControl:class extends a.Evented{constructor(p){super(),this.options=a.extend({geolocation:a.window.navigator.geolocation},$d,p),a.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=pu(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(p){return this._map=p,this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(p){const o=(h=!!this.options.geolocation)=>{this._supportsGeolocation=h,p(h)};this._supportsGeolocation!==void 0?p(this._supportsGeolocation):a.window.navigator.permissions!==void 0?a.window.navigator.permissions.query({name:"geolocation"}).then(h=>o(h.state!=="denied")).catch(()=>o()):o()}_isOutOfMapMaxBounds(p){const o=this._map.getMaxBounds(),h=p.coords;return!!o&&(h.longitude<o.getWest()||h.longitude>o.getEast()||h.latitude<o.getSouth()||h.latitude>o.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(p){if(this._map){if(this._isOutOfMapMaxBounds(p))return this._setErrorState(),this.fire(new a.Event("outofmaxbounds",p)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=p,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(p),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(p),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new a.Event("geolocate",p)),this._finish()}}_updateCamera(p){const o=new a.LngLat(p.coords.longitude,p.coords.latitude),h=p.coords.accuracy,g=this._map.getBearing(),x=a.extend({bearing:g},this.options.fitBoundsOptions);this._map.fitBounds(o.toBounds(h),x,{geolocateSource:!0})}_updateMarker(p){if(p){const o=new a.LngLat(p.coords.longitude,p.coords.latitude);this._accuracyCircleMarker.setLngLat(o).addTo(this._map),this._userLocationDotMarker.setLngLat(o).addTo(this._map),this._accuracy=p.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const p=this._map.transform,o=a.mercatorZfromAltitude(1,p._center.lat)*p.worldSize,h=Math.ceil(2*this._accuracy*o);this._circleElement.style.width=`${h}px`,this._circleElement.style.height=`${h}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(p){if(this._map){if(this.options.trackUserLocation)if(p.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const o=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",o),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",o),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(p.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new a.Event("error",p)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(p){if(this._container.addEventListener("contextmenu",o=>o.preventDefault()),this._geolocateButton=N("button","mapboxgl-ctrl-geolocate",this._container),N("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",p===!1){a.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const o=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",o),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",o)}else{const o=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",o),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",o)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=N("div","mapboxgl-user-location"),this._dotElement.appendChild(N("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(N("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Ll({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=N("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ll({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",o=>{o.geolocateSource||this._watchState!=="ACTIVE_LOCK"||o.originalEvent&&o.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new a.Event("trackuserlocationend")))})}_onDeviceOrientation(p){this._userLocationDotMarker&&(p.webkitCompassHeading?this._heading=p.webkitCompassHeading:p.absolute===!0&&(this._heading=-1*p.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return a.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new a.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new a.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new a.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let p;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(p={maximumAge:6e5,timeout:0},this._noTimeout=!0):(p=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,p),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const p=()=>{a.window.addEventListener("ondeviceorientationabsolute"in a.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};a.window.DeviceMotionEvent!==void 0&&typeof a.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(o=>{o==="granted"&&p()}).catch(console.error):p()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),a.window.removeEventListener("deviceorientation",this._onDeviceOrientation),a.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Eu,ScaleControl:class{constructor(p){this.options=a.extend({},Mu,p),function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"narrow",unit:"meter"}),!0}catch{return!1}}()||(this._setScale=qd.bind(this)),a.bindAll(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const p=this.options.maxWidth||100,o=this._map,h=o._containerHeight/2,g=o._containerWidth/2-p/2,x=o.unproject([g,h]),b=o.unproject([g+p,h]),A=x.distanceTo(b);if(this.options.unit==="imperial"){const M=3.2808*A;M>5280?this._setScale(p,M/5280,"mile"):this._setScale(p,M,"foot")}else this.options.unit==="nautical"?this._setScale(p,A/1852,"nautical-mile"):A>=1e3?this._setScale(p,A/1e3,"kilometer"):this._setScale(p,A,"meter")}_setScale(p,o,h){const g=Rl(o),x=g/o;this._map._requestDomTask(()=>{this._container.style.width=p*x+"px",this._container.innerHTML=h!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"narrow",unit:h}).format(g):`${g}&nbsp;nm`})}onAdd(p){return this._map=p,this._language=p.getLanguage(),this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-scale",p.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(p){this._language=p,this._update()}setUnit(p){this.options.unit=p,this._update()}},FullscreenControl:class{constructor(p){this._fullscreen=!1,p&&p.container&&(p.container instanceof a.window.HTMLElement?this._container=p.container:a.warnOnce("Full screen control 'container' must be a DOM element.")),a.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in a.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in a.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(p){return this._map=p,this._container||(this._container=this._map.getContainer()),this._controlContainer=N("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",a.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,a.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!a.window.document.fullscreenEnabled&&!a.window.document.webkitFullscreenEnabled)}_setupUI(){const p=this._fullscreenButton=N("button","mapboxgl-ctrl-fullscreen",this._controlContainer);N("span","mapboxgl-ctrl-icon",p).setAttribute("aria-hidden","true"),p.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),a.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const p=this._getTitle();this._fullscreenButton.setAttribute("aria-label",p),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",p)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(a.window.document.fullscreenElement||a.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?a.window.document.exitFullscreen?a.window.document.exitFullscreen():a.window.document.webkitCancelFullScreen&&a.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends a.Evented{constructor(p){super(),this.options=a.extend(Object.create(Ud),p),a.bindAll(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(p&&p.className?p.className.trim().split(/\s+/):[])}addTo(p){return this._map&&this.remove(),this._map=p,this.options.closeOnClick&&p.on("preclick",this._onClose),this.options.closeOnMove&&p.on("move",this._onClose),p.on("remove",this.remove),this._update(),p._addPopup(this),this._focusFirstElement(),this._trackPointer?(p.on("mousemove",this._onMouseEvent),p.on("mouseup",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")):p.on("move",this._update),this.fire(new a.Event("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const p=this._map;return p&&(p.off("move",this._update),p.off("move",this._onClose),p.off("preclick",this._onClose),p.off("click",this._onClose),p.off("remove",this.remove),p.off("mousemove",this._onMouseEvent),p.off("mouseup",this._onMouseEvent),p.off("drag",this._onMouseEvent),p._canvasContainer&&p._canvasContainer.classList.remove("mapboxgl-track-pointer"),p._removePopup(this),this._map=void 0),this.fire(new a.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(p){this._lngLat=a.LngLat.convert(p),this._pos=null,this._trackPointer=!1,this._update();const o=this._map;return o&&(o.on("move",this._update),o.off("mousemove",this._onMouseEvent),o._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const p=this._map;return p&&(p.off("move",this._update),p.on("mousemove",this._onMouseEvent),p.on("drag",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(p){return this.setDOMContent(a.window.document.createTextNode(p))}setHTML(p){const o=a.window.document.createDocumentFragment(),h=a.window.document.createElement("body");let g;for(h.innerHTML=p;g=h.firstChild,g;)o.appendChild(g);return this.setDOMContent(o)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(p){return this.options.maxWidth=p,this._update(),this}setDOMContent(p){let o=this._content;if(o)for(;o.hasChildNodes();)o.firstChild&&o.removeChild(o.firstChild);else o=this._content=N("div","mapboxgl-popup-content",this._container||void 0);if(o.appendChild(p),this.options.closeButton){const h=this._closeButton=N("button","mapboxgl-popup-close-button",o);h.type="button",h.setAttribute("aria-label","Close popup"),h.setAttribute("aria-hidden","true"),h.innerHTML="&#215;",h.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(p){return this._classList.add(p),this._updateClassList(),this}removeClassName(p){return this._classList.delete(p),this._updateClassList(),this}setOffset(p){return this.options.offset=p,this._update(),this}toggleClassName(p){let o;return this._classList.delete(p)?o=!1:(this._classList.add(p),o=!0),this._updateClassList(),o}_onMouseEvent(p){this._update(p.point)}_getAnchor(p){if(this.options.anchor)return this.options.anchor;const o=this._map,h=this._container,g=this._pos;if(!o||!h||!g)return"bottom";const x=h.offsetWidth,b=h.offsetHeight,A=g.x<x/2,M=g.x>o.transform.width-x/2;if(g.y+p<b)return A?"top-left":M?"top-right":"top";if(g.y>o.transform.height-b){if(A)return"bottom-left";if(M)return"bottom-right"}return A?"left":M?"right":"bottom"}_updateClassList(){const p=this._container;if(!p)return;const o=[...this._classList];o.push("mapboxgl-popup"),this._anchor&&o.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&o.push("mapboxgl-popup-track-pointer"),p.className=o.join(" ")}_update(p){const o=this._map,h=this._content;if(!o||!this._lngLat&&!this._trackPointer||!h)return;let g=this._container;if(g||(g=this._container=N("div","mapboxgl-popup",o.getContainer()),this._tip=N("div","mapboxgl-popup-tip",g),g.appendChild(h)),this.options.maxWidth&&g.style.maxWidth!==this.options.maxWidth&&(g.style.maxWidth=this.options.maxWidth),o.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Ma(this._lngLat,this._pos,o.transform)),!this._trackPointer||p){const x=this._pos=this._trackPointer&&p?p:o.project(this._lngLat),b=Au(this.options.offset),A=this._anchor=this._getAnchor(b.y),M=Au(this.options.offset,A),P=x.add(M).round();o._requestDomTask(()=>{this._container&&A&&(this._container.style.transform=`${Cl[A]} translate(${P.x}px,${P.y}px)`)})}if(!this._marker&&o._showingGlobe()){const x=a.isLngLatBehindGlobe(o.transform,this._lngLat)?0:1;this._setOpacity(x)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const p=this._container.querySelector(Vd);p&&p.focus()}_onClose(){this.remove()}_setOpacity(p){this._container&&(this._container.style.opacity=`${p}`),this._content&&(this._content.style.pointerEvents=p?"auto":"none")}},Marker:Ll,Style:ss,LngLat:a.LngLat,LngLatBounds:a.LngLatBounds,Point:a.pointGeometry,MercatorCoordinate:a.MercatorCoordinate,FreeCameraOptions:ya,Evented:a.Evented,config:a.config,prewarm:function(){Mt().acquire(At)},clearPrewarmedResources:function(){const p=yt;p&&(p.isPreloaded()&&p.numActive()===1?(p.release(At),yt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return a.config.ACCESS_TOKEN},set accessToken(p){a.config.ACCESS_TOKEN=p},get baseApiUrl(){return a.config.API_URL},set baseApiUrl(p){a.config.API_URL=p},get workerCount(){return gt.workerCount},set workerCount(p){gt.workerCount=p},get maxParallelImageRequests(){return a.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(p){a.config.MAX_PARALLEL_IMAGE_REQUESTS=p},clearStorage(p){a.clearTileCache(p)},workerUrl:"",workerClass:null,setNow:a.exported.setNow,restoreNow:a.exported.restoreNow};return Pa});var y=u;return y})})(t2);const qg=t2.exports;var Nb={},Hg={},Xg=34,gh=10,Yg=13;function n2(n){return new Function("d","return {"+n.map(function(e,i){return JSON.stringify(e)+": d["+i+'] || ""'}).join(",")+"}")}function HB(n,e){var i=n2(n);return function(l,u){return e(i(l),u,n)}}function Ub(n){var e=Object.create(null),i=[];return n.forEach(function(l){for(var u in l)u in e||i.push(e[u]=u)}),i}function Mr(n,e){var i=n+"",l=i.length;return l<e?new Array(e-l+1).join(0)+i:i}function XB(n){return n<0?"-"+Mr(-n,6):n>9999?"+"+Mr(n,6):Mr(n,4)}function YB(n){var e=n.getUTCHours(),i=n.getUTCMinutes(),l=n.getUTCSeconds(),u=n.getUTCMilliseconds();return isNaN(n)?"Invalid Date":XB(n.getUTCFullYear())+"-"+Mr(n.getUTCMonth()+1,2)+"-"+Mr(n.getUTCDate(),2)+(u?"T"+Mr(e,2)+":"+Mr(i,2)+":"+Mr(l,2)+"."+Mr(u,3)+"Z":l?"T"+Mr(e,2)+":"+Mr(i,2)+":"+Mr(l,2)+"Z":i||e?"T"+Mr(e,2)+":"+Mr(i,2)+"Z":"")}function KB(n){var e=new RegExp('["'+n+`
\r]`),i=n.charCodeAt(0);function l(R,N){var H,re,ae=u(R,function(be,De){if(H)return H(be,De-1);re=be,H=N?HB(be,N):n2(be)});return ae.columns=re||[],ae}function u(R,N){var H=[],re=R.length,ae=0,be=0,De,Oe=re<=0,Ce=!1;R.charCodeAt(re-1)===gh&&--re,R.charCodeAt(re-1)===Yg&&--re;function Ve(){if(Oe)return Hg;if(Ce)return Ce=!1,Nb;var dt,wt=ae,kt;if(R.charCodeAt(wt)===Xg){for(;ae++<re&&R.charCodeAt(ae)!==Xg||R.charCodeAt(++ae)===Xg;);return(dt=ae)>=re?Oe=!0:(kt=R.charCodeAt(ae++))===gh?Ce=!0:kt===Yg&&(Ce=!0,R.charCodeAt(ae)===gh&&++ae),R.slice(wt+1,dt-1).replace(/""/g,'"')}for(;ae<re;){if((kt=R.charCodeAt(dt=ae++))===gh)Ce=!0;else if(kt===Yg)Ce=!0,R.charCodeAt(ae)===gh&&++ae;else if(kt!==i)continue;return R.slice(wt,dt)}return Oe=!0,R.slice(wt,re)}for(;(De=Ve())!==Hg;){for(var Ee=[];De!==Nb&&De!==Hg;)Ee.push(De),De=Ve();N&&(Ee=N(Ee,be++))==null||H.push(Ee)}return H}function f(R,N){return R.map(function(H){return N.map(function(re){return O(H[re])}).join(n)})}function y(R,N){return N==null&&(N=Ub(R)),[N.map(O).join(n)].concat(f(R,N)).join(`
`)}function a(R,N){return N==null&&(N=Ub(R)),f(R,N).join(`
`)}function E(R){return R.map(I).join(`
`)}function I(R){return R.map(O).join(n)}function O(R){return R==null?"":R instanceof Date?YB(R):e.test(R+="")?'"'+R.replace(/"/g,'""')+'"':R}return{parse:l,parseRows:u,format:y,formatBody:a,formatRows:E,formatRow:I,formatValue:O}}var JB=KB(","),QB=JB.parse;function eF(n){if(!n.ok)throw new Error(n.status+" "+n.statusText);return n.text()}function tF(n,e){return fetch(n,e).then(eF)}function iF(n){return function(e,i,l){return arguments.length===2&&typeof i=="function"&&(l=i,i=void 0),tF(e,i).then(function(u){return n(u,l)})}}var Py=iF(QB);function ys(n){for(var e=n.length/6|0,i=new Array(e),l=0;l<e;)i[l]="#"+n.slice(l*6,++l*6);return i}const nF=ys("1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf"),rF=ys("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928"),sF=ys("e41a1c377eb84daf4a984ea3ff7f00ffff33a65628f781bf999999"),Jh=n=>gB(n[n.length-1]);var r2=new Array(3).concat("ef8a62f7f7f767a9cf","ca0020f4a58292c5de0571b0","ca0020f4a582f7f7f792c5de0571b0","b2182bef8a62fddbc7d1e5f067a9cf2166ac","b2182bef8a62fddbc7f7f7f7d1e5f067a9cf2166ac","b2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac","b2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac","67001fb2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac053061","67001fb2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac053061").map(ys);Jh(r2);var oF=new Array(3).concat("fc8d59ffffbf91cf60","d7191cfdae61a6d96a1a9641","d7191cfdae61ffffbfa6d96a1a9641","d73027fc8d59fee08bd9ef8b91cf601a9850","d73027fc8d59fee08bffffbfd9ef8b91cf601a9850","d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850","d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850","a50026d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850006837","a50026d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850006837").map(ys);const aF=Jh(oF);var lF=new Array(3).concat("deebf79ecae13182bd","eff3ffbdd7e76baed62171b5","eff3ffbdd7e76baed63182bd08519c","eff3ffc6dbef9ecae16baed63182bd08519c","eff3ffc6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b508519c08306b").map(ys);const cF=Jh(lF);var uF=new Array(3).concat("e5f5e0a1d99b31a354","edf8e9bae4b374c476238b45","edf8e9bae4b374c47631a354006d2c","edf8e9c7e9c0a1d99b74c47631a354006d2c","edf8e9c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45006d2c00441b").map(ys);const hF=Jh(uF);var dF=new Array(3).concat("fee0d2fc9272de2d26","fee5d9fcae91fb6a4acb181d","fee5d9fcae91fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181da50f1567000d").map(ys);const fF=Jh(dF);function qp(n){var e=n.length;return function(i){return n[Math.max(0,Math.min(e-1,Math.floor(i*e)))]}}qp(ys("44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725"));var pF=qp(ys("00000401000501010601010802010902020b02020d03030f03031204041405041606051806051a07061c08071e0907200a08220b09240c09260d0a290e0b2b100b2d110c2f120d31130d34140e36150e38160f3b180f3d19103f1a10421c10441d11471e114920114b21114e22115024125325125527125829115a2a115c2c115f2d11612f116331116533106734106936106b38106c390f6e3b0f703d0f713f0f72400f74420f75440f764510774710784910784a10794c117a4e117b4f127b51127c52137c54137d56147d57157e59157e5a167e5c167f5d177f5f187f601880621980641a80651a80671b80681c816a1c816b1d816d1d816e1e81701f81721f817320817521817621817822817922827b23827c23827e24828025828125818326818426818627818827818928818b29818c29818e2a81902a81912b81932b80942c80962c80982d80992d809b2e7f9c2e7f9e2f7fa02f7fa1307ea3307ea5317ea6317da8327daa337dab337cad347cae347bb0357bb2357bb3367ab5367ab73779b83779ba3878bc3978bd3977bf3a77c03a76c23b75c43c75c53c74c73d73c83e73ca3e72cc3f71cd4071cf4070d0416fd2426fd3436ed5446dd6456cd8456cd9466bdb476adc4869de4968df4a68e04c67e24d66e34e65e44f64e55064e75263e85362e95462ea5661eb5760ec5860ed5a5fee5b5eef5d5ef05f5ef1605df2625df2645cf3655cf4675cf4695cf56b5cf66c5cf66e5cf7705cf7725cf8745cf8765cf9785df9795df97b5dfa7d5efa7f5efa815ffb835ffb8560fb8761fc8961fc8a62fc8c63fc8e64fc9065fd9266fd9467fd9668fd9869fd9a6afd9b6bfe9d6cfe9f6dfea16efea36ffea571fea772fea973feaa74feac76feae77feb078feb27afeb47bfeb67cfeb77efeb97ffebb81febd82febf84fec185fec287fec488fec68afec88cfeca8dfecc8ffecd90fecf92fed194fed395fed597fed799fed89afdda9cfddc9efddea0fde0a1fde2a3fde3a5fde5a7fde7a9fde9aafdebacfcecaefceeb0fcf0b2fcf2b4fcf4b6fcf6b8fcf7b9fcf9bbfcfbbdfcfdbf"));qp(ys("00000401000501010601010802010a02020c02020e03021004031204031405041706041907051b08051d09061f0a07220b07240c08260d08290e092b10092d110a30120a32140b34150b37160b39180c3c190c3e1b0c411c0c431e0c451f0c48210c4a230c4c240c4f260c51280b53290b552b0b572d0b592f0a5b310a5c320a5e340a5f3609613809623909633b09643d09653e0966400a67420a68440a68450a69470b6a490b6a4a0c6b4c0c6b4d0d6c4f0d6c510e6c520e6d540f6d550f6d57106e59106e5a116e5c126e5d126e5f136e61136e62146e64156e65156e67166e69166e6a176e6c186e6d186e6f196e71196e721a6e741a6e751b6e771c6d781c6d7a1d6d7c1d6d7d1e6d7f1e6c801f6c82206c84206b85216b87216b88226a8a226a8c23698d23698f24699025689225689326679526679727669827669a28659b29649d29649f2a63a02a63a22b62a32c61a52c60a62d60a82e5fa92e5eab2f5ead305dae305cb0315bb1325ab3325ab43359b63458b73557b93556ba3655bc3754bd3853bf3952c03a51c13a50c33b4fc43c4ec63d4dc73e4cc83f4bca404acb4149cc4248ce4347cf4446d04545d24644d34743d44842d54a41d74b3fd84c3ed94d3dda4e3cdb503bdd513ade5238df5337e05536e15635e25734e35933e45a31e55c30e65d2fe75e2ee8602de9612bea632aeb6429eb6628ec6726ed6925ee6a24ef6c23ef6e21f06f20f1711ff1731df2741cf3761bf37819f47918f57b17f57d15f67e14f68013f78212f78410f8850ff8870ef8890cf98b0bf98c0af98e09fa9008fa9207fa9407fb9606fb9706fb9906fb9b06fb9d07fc9f07fca108fca309fca50afca60cfca80dfcaa0ffcac11fcae12fcb014fcb216fcb418fbb61afbb81dfbba1ffbbc21fbbe23fac026fac228fac42afac62df9c72ff9c932f9cb35f8cd37f8cf3af7d13df7d340f6d543f6d746f5d949f5db4cf4dd4ff4df53f4e156f3e35af3e55df2e661f2e865f2ea69f1ec6df1ed71f1ef75f1f179f2f27df2f482f3f586f3f68af4f88ef5f992f6fa96f8fb9af9fc9dfafda1fcffa4"));qp(ys("0d088710078813078916078a19068c1b068d1d068e20068f2206902406912605912805922a05932c05942e05952f059631059733059735049837049938049a3a049a3c049b3e049c3f049c41049d43039e44039e46039f48039f4903a04b03a14c02a14e02a25002a25102a35302a35502a45601a45801a45901a55b01a55c01a65e01a66001a66100a76300a76400a76600a76700a86900a86a00a86c00a86e00a86f00a87100a87201a87401a87501a87701a87801a87a02a87b02a87d03a87e03a88004a88104a78305a78405a78606a68707a68808a68a09a58b0aa58d0ba58e0ca48f0da4910ea3920fa39410a29511a19613a19814a099159f9a169f9c179e9d189d9e199da01a9ca11b9ba21d9aa31e9aa51f99a62098a72197a82296aa2395ab2494ac2694ad2793ae2892b02991b12a90b22b8fb32c8eb42e8db52f8cb6308bb7318ab83289ba3388bb3488bc3587bd3786be3885bf3984c03a83c13b82c23c81c33d80c43e7fc5407ec6417dc7427cc8437bc9447aca457acb4679cc4778cc4977cd4a76ce4b75cf4c74d04d73d14e72d24f71d35171d45270d5536fd5546ed6556dd7566cd8576bd9586ada5a6ada5b69db5c68dc5d67dd5e66de5f65de6164df6263e06363e16462e26561e26660e3685fe4695ee56a5de56b5de66c5ce76e5be76f5ae87059e97158e97257ea7457eb7556eb7655ec7754ed7953ed7a52ee7b51ef7c51ef7e50f07f4ff0804ef1814df1834cf2844bf3854bf3874af48849f48948f58b47f58c46f68d45f68f44f79044f79143f79342f89441f89540f9973ff9983ef99a3efa9b3dfa9c3cfa9e3bfb9f3afba139fba238fca338fca537fca636fca835fca934fdab33fdac33fdae32fdaf31fdb130fdb22ffdb42ffdb52efeb72dfeb82cfeba2cfebb2bfebd2afebe2afec029fdc229fdc328fdc527fdc627fdc827fdca26fdcb26fccd25fcce25fcd025fcd225fbd324fbd524fbd724fad824fada24f9dc24f9dd25f8df25f8e125f7e225f7e425f6e626f6e826f5e926f5eb27f4ed27f3ee27f3f027f2f227f1f426f1f525f0f724f0f921"));function fc(n,e,i){this.k=n,this.x=e,this.y=i}fc.prototype={constructor:fc,scale:function(n){return n===1?this:new fc(this.k*n,this.x,this.y)},translate:function(n,e){return n===0&e===0?this:new fc(this.k,this.x+this.k*n,this.y+this.k*e)},apply:function(n){return[n[0]*this.k+this.x,n[1]*this.k+this.y]},applyX:function(n){return n*this.k+this.x},applyY:function(n){return n*this.k+this.y},invert:function(n){return[(n[0]-this.x)/this.k,(n[1]-this.y)/this.k]},invertX:function(n){return(n-this.x)/this.k},invertY:function(n){return(n-this.y)/this.k},rescaleX:function(n){return n.copy().domain(n.range().map(this.invertX,this).map(n.invert,n))},rescaleY:function(n){return n.copy().domain(n.range().map(this.invertY,this).map(n.invert,n))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};new fc(1,0,0);fc.prototype;const Po=n=>{const e=Mc(n);return[e.r,e.g,e.b]},mF=1e3,gF=1/mF,_F=60,yF=n=>e=>e.geometry.type==n,Iy=n=>async e=>(await(await fetch(e)).json()).features.filter(yF(n)),xF=Iy("Point"),vF=Iy("LineString"),bF=Iy("Polygon"),wF=async n=>{console.log("loadNetworkNodes",n);const e=await xF(n+"/nodes.geojson");return console.log("Number of Nodes:",e.length),e},TF=async n=>{console.log("loadNetworkEdges",n);const e=await vF(n+"/edges.geojson");return console.log("Number of Edges:",e.length),e},EF=async n=>{console.log("loadNetworkZones",n);const e=await bF(n+"/aggrid_polygon.geojson");return console.log("Number of Zones:",e.length),e},s2=async n=>{const e=await Py(n),i=e[0],l={CapA:parseFloat(i["Capacity Factor A"]),CapF:parseFloat(i["Capacity Factor F"]),FFTT:parseFloat(i["FFTT Factor"])},u=`CapA-${l.CapA.toFixed(2)}-CapF-${l.CapF.toFixed(2)}-FFTT-${l.FFTT.toFixed(2)}`;return{data:e,folder:u}},o2=async(n,e)=>{const i=await Py(n);return e.every((l,u)=>{const f=l.properties,y=i[u];if(!(f.from==y.From&&f.to==y.To))return console.error(`Mismatched link at ${u}.`,f,y),!1;const E=parseFloat(y.Distance),I=f.length,O=E/I;f.distance={expected:I,observed:E,ratio:O};const R=parseFloat(y.TT),N=I*gF/f.maxspeed*_F,H=R/N;let re;Object.hasOwn(y,"Estimated?")&&(re=y["Estimated?"].toLowerCase()=="yes"),f.traveltime={expected:N,observed:R,ratio:H,estimated:re};let ae;return Object.hasOwn(y,"Volume")&&(ae=parseFloat(y.Volume)),f.traveldemand={observed:ae},f.congestion=H,!0}),e},a2=async(n,e)=>{const i=await Py(n),l=e.length,u=new Float32Array(l*l);return i.every((f,y)=>{const a=parseInt(f.Origin),E=parseInt(f.Destination),I=parseFloat(f.Demand);return u[a*l+E]=I,!0}),e.every((f,y)=>{const a=f.properties,E=dv(Array.from({length:l},(R,N)=>u[N*l+y])),I=dv(Array.from({length:l},(R,N)=>u[y*l+N])),O=E-I;return a.traveldemand={incoming:E,outgoing:I,delta:O},!0}),e},AF=async(n,e)=>(console.log("loadNetworkEdgeTraveltimes",n),e=await o2(n+"/link_TT.csv",e),e),SF=async(n,e)=>(console.log("loadNetworkZoneTraveldemands",n),e=await a2(n+"/zone_TD.csv",e),e),MF=async(n,e)=>{console.log("loadNetworkEdgeModelTraveltimes",n);const l=`/${(await s2(n+"/Results.csv")).folder}/Elite1LinkResults.csv`;return e=await o2(n+l,e),e},PF=async(n,e)=>{console.log("loadNetworkZoneModelTraveldemands",n);const l=`/${(await s2(n+"/Results.csv")).folder}/Elite1ODResults.csv`;return e=await a2(n+l,e),e},Kg=[[void 0,void 0],[void 0,void 0]],Jg={node:{geometry:{extent:Kg},properties:{osmid:void 0,highway:void 0,street_count:void 0}},edge:{geometry:{extent:Kg},properties:{osmid:void 0,capacity:void 0,congestion:void 0,distance:{expected:void 0,observed:void 0,ratio:void 0},highway:void 0,lanes:void 0,length:void 0,maxspeed:void 0,oneway:void 0,traveldemand:{expected:void 0,observed:void 0},traveltime:{expected:void 0,observed:void 0,ratio:void 0,estimated:void 0}}},zone:{geometry:{extent:Kg},properties:{lane_capacity_total:void 0,lane_length:void 0,node_count:void 0,traveldemand:{incoming:void 0,outgoing:void 0,delta:void 0}}}},Qg={node:{position:void 0,color:void 0,size:void 0,label:void 0},edge:{position:void 0,color:void 0,size:void 0,label:void 0},zone:{position:void 0,color:void 0,size:void 0,label:void 0}};const IF={class:"tools"},CF=["id","onUpdate:modelValue","disabled"],LF=["for"],RF={__name:"NetworkView",props:{networkId:{type:String,required:!0},modelId:{type:String,required:!1},traveltimeId:{type:String,required:!1},traveldemandId:{type:String,required:!1}},setup(n){const e=n;qg.accessToken="pk.eyJ1Ijoic3VyZW5kcmEyOSIsImEiOiJja29sbjB6bW4wNjU4MnJucjltYjUwcTBrIn0.jgmtO1-zBt_js3RPdHq6dg";const i={latitude:47.1744,longitude:37.4411,zoom:12,bearing:0,pitch:0},l=UA(),u=hS(),f=V_(null),y=async We=>{const Xe=await wF(We.network);return Xe.every((pt,It)=>{const Me=pt.geometry,Qt=[Me.coordinates];Me.extent=[Ga(Qt,Yt=>Yt[0]),Ga(Qt,Yt=>Yt[1])];const $t=pt.properties;return $t.street_count=$t.street_cou,delete $t.street_cou,!0}),Xe},a=async We=>{const Xe=await TF(We.network);return Xe.every((pt,It)=>{const Me=pt.geometry,Qt=Me.coordinates;Me.extent=[Ga(Qt,Yt=>Yt[0]),Ga(Qt,Yt=>Yt[1])];const $t=pt.properties;return $t.oneway=!!$t.oneway,!0}),Xe&&We.model&&await MF(We.model,Xe),Xe&&We.traveltime&&await AF(We.traveltime,Xe),Xe},E=async We=>{const Xe=await EF(We.network);return Xe.every((pt,It)=>{const Me=pt.geometry,Qt=Me.coordinates.flat(1);return Me.extent=[Ga(Qt,$t=>$t[0]),Ga(Qt,$t=>$t[1])],!0}),Xe&&We.model&&await PF(We.model,Xe),Xe&&We.traveldemand&&await SF(We.traveldemand,Xe),Xe},I=We=>Xe=>ZA(We,Xe),O=We=>Xe=>Xe.map(We),R=O(Po)(nF),N=O(Po)(sF),H=O(Po)(rF),re=O(O(Po))(r2),ae=I(Po)(fF),be=I(Po)(hF),De=I(Po)(cF),Oe=I(Po)(aF),Ce=I(Po)(pF),Ve=[127,127,127],Ee={node:{size:[3,30]},edge:{size:[2,20]},zone:{size:[0,1]}},dt=Ee.node.size,wt=Ee.edge.size,kt=Ee.zone.size,et="motorway_link|motorway|trunk_link|trunk|primary_link|primary|secondary_link|secondary|tertiary_link|tertiary|road".split("|"),Tt=[20,100],ut=[0,5e3],si=[500,1500],ti=[2,.5],Zt=[4,.25],Lt=vh(R),An=vh([re[5][0],re[5][4]]).domain([!0,!1]),fn=bn(De).domain([0,1]),pn=()=>[[bh(),bh()],[bh(),bh()]],Gi=We=>({text:Array.isArray(We)?We.join(", "):We}),ni={node:{position:{geometry:{extent:pn()}},color:{properties:{highway:vh(N).unknown(Ve),street_count:bn(Ce)}},size:{properties:{street_count:xr().range(dt)}},label:{properties:{osmid:Gi}}},edge:{position:{geometry:{extent:pn()}},color:{properties:{capacity:bn(be).domain(si),congestion:bn(Oe).domain(Zt),distance:{expected:bn(De).domain(ut),observed:bn(De).domain(ut),ratio:bn(Oe).domain(ti)},highway:vh(H).domain(et).unknown(Ve),lanes:bn(De),length:bn(De).domain(ut),maxspeed:bn(ae).domain(Tt),oneway:An,traveldemand:{expected:bn(Oe),observed:bn(Oe)},traveltime:{expected:bn(Oe),observed:bn(Oe),ratio:bn(Oe).domain(Zt),estimated:An}}},size:{properties:{capacity:xr().range(wt),congestion:xr().range(wt),lanes:xr().range(wt),length:xr().range(wt),maxspeed:xr().range(wt),traveltime:{expected:xr().range(wt),observed:xr().range(wt),ratio:xr().range(wt)}}},label:{properties:{osmid:Gi,name:Gi}}},zone:{position:{geometry:{extent:pn()}},color:{properties:{lane_capacity_total:bn(be),lane_length:bn(De),node_count:bn(Ce),traveldemand:{incoming:bn(be),outgoing:bn(ae),delta:U_(Oe)}}},size:{properties:{lane_capacity_total:xr().range(kt),lane_length:xr().range(kt),node_count:xr().range(kt),traveldemand:{incoming:xr().range(kt),outgoing:xr().range(kt),delta:U_().range([1,0,1])}}},label:{properties:{}}}},Hr=We=>HA(We).filter(XA),ur=We=>Hr(We).sort(),Ki=Ga,$i=We=>Xe=>[We,Wg(Xe)],Jn=(We=>Xe=>{const[pt,It]=We(Xe);return[It,pt]})(Ki),Ai=We=>Xe=>{let pt=Math.max(Math.abs(wb(Xe)),Math.abs(Wg(Xe)));return[-pt,We,+pt]},Si=We=>Xe=>{const pt=We(Xe);return It=>It.domain(pt)},oi=We=>Xe=>{const pt=We(Xe);return It=>It.domain(pt).nice()},yi=[[Si(Ki),Si(Ki)],[Si(Ki),Si(Ki)]],hr={node:{geometry:{extent:yi},properties:{osmid:void 0,highway:Si(ur),street_count:Si($i(0))}},edge:{geometry:{extent:yi},properties:{osmid:void 0,capacity:Si(Ki),congestion:Si(Ki),distance:{expected:oi($i(0)),observed:oi($i(0)),ratio:void 0},highway:void 0,lanes:Si($i(0)),length:oi($i(0)),maxspeed:Si($i(0)),oneway:void 0,traveldemand:{expected:oi(Jn),observed:oi(Jn)},traveltime:{expected:oi(Jn),observed:oi(Jn),ratio:void 0,estimated:void 0}}},zone:{geometry:{extent:yi},properties:{lane_capacity_total:Si(Ki),lane_length:Si(Ki),node_count:Si(Ki),traveldemand:{incoming:oi($i(0)),outgoing:oi($i(0)),delta:oi(Ai(0))}}}},fi=(We,Xe)=>(pt,It)=>Me=>{for(let Qt of mv(We)){const $t=qA(Qt),Yt=Me.map($t),Fi=$t(It);if(Yt&&Fi){const qi=Fi(Yt);for(let mr of mv(Xe)){const Rr=ch(ch(pt,mr),Qt);Rr&&qi(Rr)}}}},mn=fi(Jg.node,Qg.node)(ni.node,hr.node),Kt=fi(Jg.edge,Qg.edge)(ni.edge,hr.edge),gn=fi(Jg.zone,Qg.zone)(ni.zone,hr.zone),_n=We=>(Xe,pt)=>zf(We),tn=(We,Xe)=>{const pt=Xe%10,It=Lt(pt);return zf(It)},dr=(We,Xe)=>(pt,It)=>{const Me=It%10;return Lt(Me)},wr=(We,Xe)=>{const It=We.geometry.coordinates.length;return(Me,Qt)=>fn(Qt/It)},Gn=(We,Xe)=>{let pt=We.properties;return pt=JSON.stringify(pt,null,2),zf({html:`<pre>${pt}</pre>`})},Ji=_n([255,255,255]),Qi=_n(1),Qn=Gn,Sn=We=>Xe=>{const pt=ch(We,Xe);return(It,Me)=>{const Qt=ch(It,Xe);return zf(pt(Qt))}},Yr=Sn(ni.node.color),Kr=Sn(ni.node.size),fr=Sn(ni.node.label),Wi=Sn(ni.edge.color),Ir=Sn(ni.edge.size),yn=Sn(ni.edge.label),Mn=Sn(ni.zone.color),Pn=Sn(ni.zone.size),er={node:{color:{coordinate:{index:dr,domain:wr},feature:{index:tn},highway:Yr("properties.highway"),street_count:Yr("properties.street_count")},size:{street_count:Kr("properties.street_count")},label:{osmid:fr("properties.osmid")}},edge:{color:{coordinate:{index:dr,domain:wr},feature:{index:tn},capacity:Wi("properties.capacity"),congestion:Wi("properties.congestion"),distance:{expected:Wi("properties.distance.expected"),observed:Wi("properties.distance.observed"),ratio:Wi("properties.distance.ratio")},highway:Wi("properties.highway"),length:Wi("properties.length"),maxspeed:Wi("properties.maxspeed"),oneway:Wi("properties.oneway"),traveldemand:{expected:Wi("properties.traveldemand.expected"),observed:Wi("properties.traveldemand.observed")},traveltime:{expected:Wi("properties.traveltime.expected"),observed:Wi("properties.traveltime.observed"),ratio:Wi("properties.traveltime.ratio"),estimated:Wi("properties.traveltime.estimated")}},size:{lanes:Ir("properties.lanes")},label:{osmid:yn("properties.osmid"),name:yn("properties.name")}},zone:{color:{coordinate:{index:dr,domain:wr},feature:{index:tn},lane_capacity_total:Mn("properties.lane_capacity_total"),lane_length:Mn("properties.lane_length"),node_count:Mn("properties.node_count"),traveldemand:{incoming:Mn("properties.traveldemand.incoming"),outgoing:Mn("properties.traveldemand.outgoing"),delta:Mn("properties.traveldemand.delta")}},size:{lane_capacity_total:Pn("properties.lane_capacity_total"),lane_length:Pn("properties.lane_length"),node_count:Pn("properties.node_count"),traveldemand:{incoming:Pn("properties.traveldemand.incoming"),outgoing:Pn("properties.traveldemand.outgoing"),delta:Pn("properties.traveldemand.delta")}},label:{}}},an=We=>{let Xe=l.query[We];return Xe=Xe||"default",ch(er,`${We}.${Xe}`)},xs=Ji,Fs=e.modelId||e.traveltimeId?er.edge.color.traveltime.ratio:Ji,Jr=e.modelId||e.traveldemandId?er.zone.color.traveldemand.delta:Ji,Wn=an("node.color")??xs,Qr=an("node.size")??Qi,es=an("node.label")??Qn,Bn=an("edge.color")??Fs,Cr=an("edge.size")??Qi,ts=an("edge.label")??Qn,Lr=an("zone.color")??Jr,kr=an("zone.size")??Qi,Tn=an("zone.label")??Qn,pr=kr!==Qi,vs=Lr!==Ji,ne=(We=>{const Xe=pr?255:vs?95:31;return(pt,It)=>(Me,Qt)=>[...We(pt,It)(Me,Qt),Xe]})(Lr),F=We=>We.map((pt,It)=>({position:pt.geometry.coordinates,color:Wn(pt,It)(void 0,0),size:Qr(pt,It)(void 0,0)})),j=We=>We.map((pt,It)=>({position:pt.geometry.coordinates,color:ne(pt,It)(void 0,0),size:kr(pt,It)(void 0,0)})),te=We=>{const Xe=We.map(vi=>vi.geometry.coordinates),pt=We.map((vi,ot)=>vi.geometry.coordinates.map(Bn(vi,ot))),It=We.map((vi,ot)=>vi.geometry.coordinates.map(Cr(vi,ot))),Me=Xe[0]?.[0]?.length??2,Qt=pt[0]?.[0]?.length??3,$t=1,Yt=new Float32Array(Xe.flat(2)),Fi=new Uint8Array(pt.flat(2)),qi=new Uint8Array(It.flat(1)),mr=new Uint32Array(We.reduce((vi,ot)=>{const Vt=ot.geometry.coordinates,jt=vi[vi.length-1],Fn=Vt.length;return vi.push(jt+Fn),vi},[0]));return{length:We.length,startIndices:mr,attributes:{getPath:{value:Yt,size:Me},getColor:{value:Fi,size:Qt},getWidth:{value:qi,size:$t}}}},ce=async We=>{const Xe=await y(We);return mn(Xe),{features:Xe}},ge=async We=>{const Xe=await a(We);return Kt(Xe),{features:Xe}},Ae=async We=>{const Xe=await E(We);return gn(Xe),{features:Xe}},Te=We=>{const Xe=F(We.features);return new vy({id:"nodes",data:Xe,pickable:!0,stroked:!0,filled:!0,radiusMinPixels:dt[0],radiusMaxPixels:dt[1],lineWidthMinPixels:1,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,getLineWidth:1,getPosition:It=>It.position,getFillColor:It=>It.color,getLineColor:[80,80,80],getRadius:It=>It.size})},xe=We=>{const Xe=j(We.features);return new Ty({id:"zones",data:Xe,pickable:!0,stroked:!0,filled:!0,extruded:pr,elevationScale:1e4,wireframe:!0,lineWidthMinPixels:1,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,getLineWidth:1,getPolygon:It=>It.position,getFillColor:It=>It.color,getLineColor:[80,80,80],getElevation:It=>It.size})},Se=We=>{const Xe=te(We.features);return new Gp({id:"edges",data:Xe,widthScale:1,widthMinPixels:wt[0],widthMaxPixels:wt[1],pickable:!0,_pathType:"open"})};let Ge;const st={nodes:null,edges:null,zones:null},Ze=VA({layers:{nodes:{title:"Nodes",count:0,enabled:!1,visible:!1},edges:{title:"Edges",count:0,enabled:!1,visible:!1},zones:{title:"Zones",count:0,enabled:!1,visible:!1}}}),At=["zones","edges","nodes"],gt=()=>{if(Ge&&st){const We=At.map(Xe=>st[Xe]).filter(Xe=>Xe&&Ze.layers[Xe.id].enabled).map(Xe=>Xe.clone({visible:Ze.layers[Xe.id].visible}));Ge.setProps({layers:We})}},yt=We=>wb(We.domain()),Mt=We=>Wg(We.domain()),Ut=We=>[yt(We[0]),Mt(We[1])],ii=We=>We.map(Ut),Pt=We=>ii(We).map($A);return j_(()=>Ze.layers,(We,Xe)=>{gt()},{deep:!0}),jb(async()=>{let We,Xe,pt;u.value=e.networkId;const It={network:`/data/networks/${e.networkId}`,model:e.modelId?`/data/networks/${e.networkId}/models/${e.modelId}`:void 0,traveltime:e.traveltimeId?`/data/networks/${e.networkId}/traveltimes/${e.traveltimeId}`:void 0,traveldemand:e.traveldemandId?`/data/networks/${e.networkId}/traveldemands/${e.traveldemandId}`:void 0};try{We=await ce(It),st.nodes=Te(We)}catch(Yt){console.error("Error loading nodes.",Yt)}try{Xe=await ge(It),st.edges=Se(Xe)}catch(Yt){console.error("Error loading edges.",Yt)}try{pt=await Ae(It),st.zones=xe(pt)}catch(Yt){console.error("Error loading zones.",Yt)}const Me=Yt=>{if(Yt.picked){if(st.nodes&&st.nodes.id==Yt.layer.id){const Fi=Yt.index,qi=We.features[Fi];return es(qi,Fi)(void 0,0)}if(st.edges&&st.edges.id==Yt.layer.id){const Fi=Yt.index,qi=Xe.features[Fi];return ts(qi,Fi)(void 0,0)}if(st.zones&&st.zones.id==Yt.layer.id){const Fi=Yt.index,qi=pt.features[Fi];return Tn(qi,Fi)(void 0,0)}}};let Qt=()=>We?Pt(ni.node.position.geometry.extent):Xe?Pt(ni.edge.position.geometry.extent):pt?Pt(ni.zone.position.geometry.extent):[i.longitude,i.latitude];Ge=new WO({layers:[],getTooltip:Me});const $t=new qg.Map({container:f.value,projection:{name:"mercator"},style:qB.DARK_MATTER_NOLABELS,center:Qt(),bearing:i.bearing,pitch:i.pitch,zoom:i.zoom});$t.addControl(Ge),$t.addControl(new qg.NavigationControl),Ze.layers.nodes.enabled=!!We,Ze.layers.nodes.visible=!!We,Ze.layers.nodes.count=We?.features?.length??0,Ze.layers.edges.enabled=!!Xe,Ze.layers.edges.visible=!!Xe,Ze.layers.edges.count=Xe?.features?.length??0,Ze.layers.zones.enabled=!!pt,Ze.layers.zones.visible=!!pt,Ze.layers.zones.count=pt?.features?.length??0}),(We,Xe)=>(ug(),hg(fv,null,[Df("div",IF,[(ug(!0),hg(fv,null,jA(Ze.layers,(pt,It)=>(ug(),hg("div",{key:It},[GA(Df("input",{type:"checkbox",id:It,"onUpdate:modelValue":Me=>pt.visible=Me,disabled:!pt.enabled},null,8,CF),[[WA,pt.visible]]),Df("label",{for:It},pv(pt.title)+" ("+pv(pt.count)+")",9,LF)]))),128))]),Df("div",{class:"map",ref_key:"containerRef",ref:f},null,512)],64))}};export{RF as default};
